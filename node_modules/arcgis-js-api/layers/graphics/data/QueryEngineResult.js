// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../core/MapUtils","../../../core/maybe","../../../core/promiseUtils","../../../core/SetUtils","../../../geometry/support/quantizationUtils","../../../geometry/support/spatialReferenceUtils","../featureConversionUtils","./AttributesBuilder","./attributeSupport","./projectionSupport","./timeSupport","./utils"],(function(e,t,r,i,s,n,a,o,u,l,h,f,c,p,d){function m(e){return e.substr(24,12)+e.substr(19,4)+e.substr(16,2)+e.substr(14,2)+e.substr(11,2)+e.substr(9,2)+e.substr(6,2)+e.substr(4,2)+e.substr(2,2)+e.substr(0,2)}function y(e,t,r){return(r?e>t:e<t)?-1:(r?e<t:e>t)?1:0}function g(e,t,r){return r?t-e:e-t}function v(e,t,r,i){if(r&&"esriFieldTypeDate"===r.type){var s=new Date(e).getTime(),n=new Date(t).getTime();if(!isNaN(s)&&!isNaN(n))return g(s,n,i)}if("number"==typeof e&&"number"==typeof t)return g(e,t,i);if("string"==typeof e&&"string"==typeof t){s=e.toUpperCase(),n=t.toUpperCase();return!r||"esriFieldTypeGUID"!==r.type&&"esriFieldTypeGlobalID"!==r.type?y(s,n,i):y(m(s),m(n),i)}return i?1:-1}Object.defineProperty(t,"__esModule",{value:!0});var I=function(){function e(e,t,r){this.items=e,this.queryGeometry=t,this.definitionExpression=r.definitionExpression,this.geometryType=r.geometryType,this.hasM=r.hasM,this.hasZ=r.hasZ,this.objectIdField=r.objectIdField,this.spatialReference=r.spatialReference,this.fieldsIndex=r.fieldsIndex,this.timeInfo=r.timeInfo,this.featureAdapter=r.featureAdapter}return Object.defineProperty(e.prototype,"size",{get:function(){return this.items.length},enumerable:!0,configurable:!0}),e.prototype.createQueryResponse=function(e){var t;e.outStatistics?t=e.outStatistics.some((function(e){return"exceedslimit"===e.statisticType}))?this._createExceedsLimitQueryResponse(e):this._createStatisticsQueryResponse(e):t=this._createFeatureQueryResponse(e);return e.returnQueryGeometry&&(u.isValid(e.outSR)&&!u.equals(this.queryGeometry.spatialReference,e.outSR)?t.queryGeometry=d.cleanFromGeometryEngine(r.__assign({spatialReference:e.outSR},c.project(this.queryGeometry,this.queryGeometry.spatialReference,e.outSR))):t.queryGeometry=d.cleanFromGeometryEngine(r.__assign({spatialReference:e.outSR},this.queryGeometry))),t},e.prototype.executeAttributesQuery=function(t){var r=f.getWhereClause(t.where,this.fieldsIndex);if(!r)return n.resolve(this);if(r.isStandardized){for(var i=0,s=[],a=0,o=this.items;a<o.length;a++){var u=o[a];r.testFeature(u,this.featureAdapter)&&(s[i++]=u)}var l=new e(s,this.queryGeometry,this);return l.definitionExpression=t.where,n.resolve(l)}return n.reject(new TypeError("Where clause is not standardized"))},e.prototype.executeObjectIdsQuery=function(t){if(!t.objectIds||!t.objectIds.length)return n.resolve(this);var r=a.SetFromValues(t.objectIds),i=this.featureAdapter.getObjectId;return n.resolve(new e(this.items.filter((function(e){return r.has(i(e))})),this.queryGeometry,this))},e.prototype.executeTimeQuery=function(t){var r=p.getTimeOperator(this.timeInfo,t.timeExtent,this.featureAdapter);if(!s.isSome(r))return n.resolve(this);var i=this.items.filter(r);return n.resolve(new e(i,this.queryGeometry,this))},e.prototype.filterLatest=function(){for(var t=this.timeInfo,r=t.trackIdField,s=t.startTimeField,a=t.endTimeField||s,o=new Map,u=this.featureAdapter.getAttribute,l=0,h=this.items;l<h.length;l++){var f=h[l],c=u(f,r),p=u(f,a),d=o.get(c);(!d||p>u(d,a))&&o.set(c,f)}var m=i.valuesOfMap(o);return n.resolve(new e(m,this.queryGeometry,this))},e.prototype.project=function(t){return r.__awaiter(this,void 0,void 0,(function(){var i,s,n=this;return r.__generator(this,(function(r){switch(r.label){case 0:return!t||u.equals(this.spatialReference,t)?[2,this]:(i=this.featureAdapter,[4,c.projectMany(this.items.map((function(e){return d.getGeometry(n.geometryType,n.hasZ,n.hasM,i.getGeometry(e))})),this.spatialReference,t)]);case 1:return s=r.sent(),[2,new e(s.map((function(e,t){return i.cloneWithGeometry(n.items[t],l.convertFromGeometry(e,n.hasZ,n.hasM))})),this.queryGeometry,{definitionExpression:this.definitionExpression,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:t,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,featureAdapter:this.featureAdapter})]}}))}))},e.prototype._sortFeatures=function(e,t,r){if(e.length>1&&t&&t.length)for(var i=function(t){var i=t.split(" "),n=i[0],a=s.fieldsIndex.get(n),o=i[1]&&"desc"===i[1].toLowerCase();e.sort((function(e,t){return v(r(e,n,a),r(t,n,a),a,o)}))},s=this,n=0,a=t.reverse();n<a.length;n++){i(a[n])}},e.prototype._createFeatureQueryResponse=function(e){var t=this,i=this.items,s=this,n=s.geometryType,a=s.hasM,u=s.hasZ,l=s.objectIdField,h=s.spatialReference,f=e.outFields,c=e.outSR,p=e.quantizationParameters,m=e.resultRecordCount,y=e.resultOffset,g=e.returnZ,v=e.returnM,I=!1;if(null!=m&&null!=y){var b=y+m;I=i.length>b,i=i.slice(y,Math.min(i.length,b))}var _=f&&(f.indexOf("*")>-1?r.__spreadArrays(this.fieldsIndex.fields):f.map((function(e){return t.fieldsIndex.get(e)})));return{exceededTransferLimit:I,features:this._createFeatures(e,i),fields:_,geometryType:n,hasM:a&&v,hasZ:u&&g,objectIdFieldName:l,spatialReference:d.cleanFromGeometryEngine(c||h),transform:p&&o.toQuantizationTransform(p)||null}},e.prototype._createFeatures=function(e,t){var r=new h.default(e,this.featureAdapter,this.fieldsIndex),i=this.hasM,s=this.hasZ,n=e.orderByFields,a=e.quantizationParameters,u=e.returnGeometry,l=e.returnCentroid,f=e.maxAllowableOffset,c=e.returnZ,p=void 0!==c&&c,m=e.returnM,y=s&&p,g=i&&(void 0!==m&&m),v=[],I=0;if(u||l){var b=o.toQuantizationTransform(a);if(u&&!l)for(var _=0,T=t;_<T.length;_++){G=T[_];v[I++]={attributes:r.getAttributes(G),geometry:d.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(G),f,b,y,g)}}else if(!u&&l)for(var F=0,x=t;F<x.length;F++){G=x[F];v[I++]={attributes:r.getAttributes(G),centroid:d.transformCentroid(this,this.featureAdapter.getCentroid(G,this),b)}}else for(var S=0,N=t;S<N.length;S++){G=N[S];v[I++]={attributes:r.getAttributes(G),centroid:d.transformCentroid(this,this.featureAdapter.getCentroid(G,this),b),geometry:d.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(G),f,b,y,g)}}}else for(var A=0,M=t;A<M.length;A++){var G=M[A],R=r.getAttributes(G);R&&(v[I++]={attributes:R})}return this._sortFeatures(v,n,(function(e,t,i){return r.getFieldValue(e,t,i)})),v},e.prototype._createExceedsLimitQueryResponse=function(e){for(var t=!1,r=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY,n=0,a=e.outStatistics;n<a.length;n++){var o=a[n];if("exceedslimit"===o.statisticType){r=null!=o.maxPointCount?o.maxPointCount:Number.POSITIVE_INFINITY,i=null!=o.maxRecordCount?o.maxRecordCount:Number.POSITIVE_INFINITY,s=null!=o.maxVertexCount?o.maxVertexCount:Number.POSITIVE_INFINITY;break}}if("esriGeometryPoint"===this.geometryType)t=this.items.length>r;else if(this.items.length>i)t=!0;else{var u=this.hasZ?this.hasM?4:3:this.hasM?3:2,l=this.featureAdapter;t=this.items.reduce((function(e,t){var r=l.getGeometry(t);return e+(r&&r.coords.length||0)}),0)/u>s}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(t)}}]}},e.prototype._createStatisticsQueryResponse=function(e){for(var t=this,r={attributes:{}},s=[],n=new Map,a=new Map,o=new Map,u=new Map,l=new h.default(e,this.featureAdapter,this.fieldsIndex),f=e.outStatistics,c=e.groupByFieldsForStatistics,p=e.having,d=e.orderByFields,m=c&&c.length,y=!!m,g=y&&c[0],v=y&&!this.fieldsIndex.get(g),I=0,b=f;I<b.length;I++){var _=b[I],T=_.outStatisticFieldName,F=_.statisticType,x=_,S="exceedslimit"!==F?_.onStatisticField:void 0,N="percentile_disc"===F||"percentile_cont"===F,A=y&&1===m&&(S===g||v)&&"count"===F;if(y){if(!o.has(S)){for(var M=[],G=0,R=c;G<R.length;G++){var V=R[G],P=this._getAttributeValues(l,V,n);M.push(P)}o.set(S,this._calculateUniqueValues(M))}var q=o.get(S),E=function(e){var r=q[e],i=r.count,s=r.data,a=r.items,o=r.itemPositions,h=s.join(",");if(!p||l.validateItems(a,p)){var f=u.get(h)||{attributes:{}},d=null;if(A)d=i;else{var m=w._getAttributeValues(l,S,n),y=o.map((function(e){return m[e]}));d=N&&"statisticParameters"in x?w._getPercentileValue(x,y):w._getStatisticValue(x,y)}f.attributes[T]=d,c.forEach((function(e,r){return f.attributes[t.fieldsIndex.get(e)?e:"EXPR_"+(r+1)]=s[r]})),u.set(h,f)}},w=this;for(var j in q)E(j)}else{P=this._getAttributeValues(l,S,n);r.attributes[T]=N&&"statisticParameters"in x?this._getPercentileValue(x,P):this._getStatisticValue(x,P,a)}s.push({name:T,alias:T,type:"esriFieldTypeDouble"})}var C=y?i.valuesOfMap(u):[r];return this._sortFeatures(C,d,(function(e,t){return e.attributes[t]})),{fields:s,features:C}},e.prototype._getStatisticValue=function(e,t,r){var i=e.onStatisticField,s=e.statisticType,n=r&&r.has(i)?r.get(i):this._calculateStatistics(t);return r&&r.set(i,n),n["var"===s?"variance":s]},e.prototype._getPercentileValue=function(e,t){var i=e.onStatisticField,s=e.statisticParameters,n=e.statisticType,a=s.value,o="desc"===s.orderBy,u=this.fieldsIndex.get(i),l=r.__spreadArrays(t).sort((function(e,t){return v(e,t,u,o)}));return this._calculatePercentile(l,a,"percentile_disc"===n)},e.prototype._getAttributeValues=function(e,t,r){if(r.has(t))return r.get(t);var i=this.fieldsIndex.get(t),s=this.items.map((function(r){return e.getFieldValue(r,t,i)}));return r.set(t,s),s},e.prototype._calculateStatistics=function(e){for(var t=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY,i=null,s=null,n=null,a=null,o=[],u=0,l=0,h=e;l<h.length;l++){"string"==typeof(d=h[l])?u++:null==d||isNaN(d)||(i+=d,t=Math.min(t,d),r=Math.max(r,d),o.push(d),u++)}if(u){s=i/u;for(var f=0,c=0,p=o;c<p.length;c++){var d=p[c];f+=Math.pow(d-s,2)}a=u>1?f/(u-1):0,n=Math.sqrt(a)}else t=null,r=null;return{avg:s,count:u,max:r,min:t,stddev:n,sum:i,variance:a}},e.prototype._calculateUniqueValues=function(e){for(var t={},r=this.items,i=r.length,s=0;s<i;s++){for(var n=r[s],a=[],o=0,u=e;o<u.length;o++){var l=u[o];a.push(l[s])}var h=a.join(",");null==t[h]?t[h]={count:1,data:a,items:[n],itemPositions:[s]}:(t[h].count++,t[h].items.push(n),t[h].itemPositions.push(s))}return t},e.prototype._calculatePercentile=function(e,t,r){if(0===e.length)return null;if(t<=0)return e[0];if(t>=1)return e[e.length-1];var i=(e.length-1)*t,s=Math.floor(i),n=s+1,a=i%1,o=e[s],u=e[n];return n>=e.length||r||"string"==typeof o||"string"==typeof u?o:o*(1-a)+u*a},e}();t.default=I}));