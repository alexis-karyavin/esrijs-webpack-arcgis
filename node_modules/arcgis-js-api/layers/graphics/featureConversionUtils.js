// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../core/Error","../../core/Logger","../../geometry/support/jsonUtils","./OptimizedFeature","./OptimizedFeatureSet","./OptimizedGeometry"],(function(e,r,t,n,o,s,a,u){function i(e,r){return e?r?4:3:r?3:2}Object.defineProperty(r,"__esModule",{value:!0});var l=n.getLogger("esri.tasks.support.optimizedFeatureSet"),c={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},h=function(e,r,t,n,o,s){e[t]=o,e[t+1]=s},d=function(e,r,t,n,o,s){e[t]=o,e[t+1]=s,e[t+2]=r[n+2]},g=function(e,r,t,n,o,s){e[t]=o,e[t+1]=s,e[t+2]=r[n+3]},f=function(e,r,t,n,o,s){e[t]=o,e[t+1]=s,e[t+2]=r[n+2],e[t+3]=r[n+3]};function v(e,r,t,n){if(e){if(t)return r&&n?f:d;if(r&&n)return g}else if(r&&n)return d;return h}function m(e,r){var t=e.scale,n=e.translate;return Math.round((r-n[0])/t[0])}function y(e,r){var t=e.scale,n=e.translate;return Math.round((n[1]-r)/t[1])}function p(e,r){var t=e.scale,n=e.translate;return r*t[0]+n[0]}function I(e,r){var t=e.scale;return e.translate[1]-r*t[1]}function F(e){var r=e.coords;return{x:r[0],y:r[1]}}function M(e,r){return e.coords[0]=r.x,e.coords[1]=r.y,e}function b(e){var r=e.coords;return{x:r[0],y:r[1],z:r[2]}}function N(e,r){return e.coords[0]=r.x,e.coords[1]=r.y,e.coords[2]=r.z,e}function T(e){var r=e.coords;return{x:r[0],y:r[1],m:r[2]}}function w(e,r){return e.coords[0]=r.x,e.coords[1]=r.y,e.coords[2]=r.m,e}function G(e){var r=e.coords;return{x:r[0],y:r[1],z:r[2],m:r[3]}}function P(e,r){return e.coords[0]=r.x,e.coords[1]=r.y,e.coords[2]=r.z,e.coords[3]=r.m,e}function z(e,r){return e&&r?P:e?N:r?w:M}function x(e,r,t){if(!e)return null;for(var n=i(r,t),o=[],s=0;s<e.coords.length;s+=n){for(var a=[],u=0;u<n;u++)a.push(e.coords[s+u]);o.push(a)}return r?t?{points:o,hasZ:r,hasM:t}:{points:o,hasZ:r}:t?{points:o,hasM:t}:{points:o}}function Z(e,r,t){void 0===t&&(t=i(r.hasZ,r.hasM)),e.lengths[0]=r.points.length;for(var n=e.coords,o=0,s=0,a=r.points;s<a.length;s++)for(var u=a[s],l=0;l<t;l++)n[o++]=u[l];return e}function O(e,r,t){if(!e)return null;for(var n=i(r,t),o=e.coords,s=[],a=0,u=0,l=e.lengths;u<l.length;u++){for(var c=l[u],h=[],d=0;d<c;d++){for(var g=[],f=0;f<n;f++)g.push(o[a++]);h.push(g)}s.push(h)}return r?t?{paths:s,hasZ:r,hasM:t}:{paths:s,hasZ:r}:t?{paths:s,hasM:t}:{paths:s}}function E(e,r,t){void 0===t&&(t=i(r.hasZ,r.hasM));for(var n=e.lengths,o=e.coords,s=0,a=0,u=r.paths;a<u.length;a++){for(var l=u[a],c=0,h=l;c<h.length;c++)for(var d=h[c],g=0;g<t;g++)o[s++]=d[g];n.push(l.length)}return e}function S(e,r,t){if(!e)return null;for(var n=i(r,t),o=e.coords,s=[],a=0,u=0,l=e.lengths;u<l.length;u++){for(var c=l[u],h=[],d=0;d<c;d++){for(var g=[],f=0;f<n;f++)g.push(o[a++]);h.push(g)}s.push(h)}return r?t?{rings:s,hasZ:r,hasM:t}:{rings:s,hasZ:r}:t?{rings:s,hasM:t}:{rings:s}}function j(e,r,t,n){return void 0===t&&(t=r.hasZ),void 0===n&&(n=r.hasM),V(e,r.rings,t,n),e}function V(e,r,t,n){var o=i(t,n),s=e.lengths,a=e.coords,u=0;s.length=a.length=0;for(var l=0,c=r;l<c.length;l++){for(var h=c[l],d=0,g=h;d<g.length;d++)for(var f=g[d],v=0;v<o;v++)a[u++]=f[v];s.push(h.length)}return e}r.quantizeX=m,r.quantizeY=y,r.hydrateX=p,r.hydrateY=I,r.convertToPoint=function(e,r,t){return e?r?t?G(e):b(e):t?T(e):F(e):null},r.convertFromPoint=function(e,r,t){return void 0===t&&(t=z(null!=r.z,null!=r.m)),t(e,r)},r.convertToMultipoint=x,r.convertFromMultipoint=Z,r.convertToPolyline=O,r.convertFromPolyline=E,r.convertToPolygon=S,r.convertFromPolygon=j,r.convertFromNestedArray=V;var Y=[],_=[];function k(e,r,n,o,a,c){if(e.length=0,!n){for(var h=0,d=r;h<d.length;h++){var g=d[h],f=g.attributes[c];e.push(new s.default(null,g.attributes,null,f))}return e}switch(n){case"esriGeometryPoint":return function(e,r,t,n,o){for(var a=z(t,n),i=0,l=r;i<l.length;i++){var c=l[i],h=c.geometry,d=c.attributes,g=void 0;h&&(g=a(new u.default,h)),e.push(new s.default(g,d,null,d[o]))}return e}(e,r,o,a,c);case"esriGeometryMultipoint":return function(e,r,t,n,o){for(var a=i(t,n),l=0,c=r;l<c.length;l++){var h=c[l],d=h.geometry,g=h.attributes,f=void 0;d&&(f=Z(new u.default,d,a)),e.push(new s.default(f,g,null,g[o]))}return e}(e,r,o,a,c);case"esriGeometryPolyline":return function(e,r,t,n,o){for(var a=i(t,n),l=0,c=r;l<c.length;l++){var h=c[l],d=h.geometry,g=h.attributes,f=void 0;d&&(f=E(new u.default,d,a)),e.push(new s.default(f,g,null,g[o]))}return e}(e,r,o,a,c);case"esriGeometryPolygon":return function(e,r,t,n,o){for(var a=0,i=r;a<i.length;a++){var l=i[a],c=l.geometry,h=l.centroid,d=l.attributes,g=void 0;c&&(g=j(new u.default,c,t,n)),h?e.push(new s.default(g,d,M(new u.default,h),d[o])):e.push(new s.default(g,d,null,d[o]))}return e}(e,r,o,a,c);default:l.error("convertToFeatureSet:unknown-geometry",new t("Unable to parse unknown geometry type '"+n+"'")),e.length=0}return e}function L(e,r,n,o,s){switch(e.length=0,n){case"esriGeometryPoint":return function(e,r,t,n){var o=F;t&&n?o=G:t?o=b:n&&(o=T);for(var s=0,a=r;s<a.length;s++){var u=a[s],i=u.geometry,l=u.attributes,c=i?o(i):null;e.push({attributes:l,geometry:c})}return e}(e,r,o,s);case"esriGeometryMultipoint":return function(e,r,t,n){for(var o=0,s=r;o<s.length;o++){var a=s[o],u=a.geometry,i=a.attributes,l=void 0;u&&(l=x(u,t,n)),e.push({attributes:i,geometry:l})}return e}(e,r,o,s);case"esriGeometryPolyline":return function(e,r,t,n){for(var o=0,s=r;o<s.length;o++){var a=s[o],u=a.geometry,i=a.attributes,l=void 0;u&&(l=O(u,t,n)),e.push({attributes:i,geometry:l})}return e}(e,r,o,s);case"esriGeometryPolygon":return function(e,r,t,n){for(var o=0,s=r;o<s.length;o++){var a=s[o],u=a.geometry,i=a.attributes,l=a.centroid,c=void 0;if(u&&(c=S(u,t,n)),l){var h=F(l);e.push({attributes:i,centroid:h,geometry:c})}else e.push({attributes:i,geometry:c})}return e}(e,r,o,s);default:l.error("convertToFeatureSet:unknown-geometry",new t("Unable to parse unknown geometry type '"+n+"'"))}return e}function q(e,r,t,n,o,s,a,u){if(void 0===a&&(a=t),void 0===u&&(u=n),e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!r||!r.coords.length)return null;var l,h,d,g,f=c[o],p=r.coords,I=r.lengths,F=i(t,n),M=i(t&&a,n&&u),b=v(t,n,a,u);if(!I.length)return b(e.coords,p,0,0,m(s,p[0]),y(s,p[1])),e.lengths.length&&(e.lengths.length=0),e.coords.length=F,e;for(var N=0,T=0,w=T,G=0,P=I;G<P.length;G++){var z=P[G];if(!(z<f)){var x=0;T=w,d=l=m(s,p[N]),g=h=y(s,p[N+1]),b(e.coords,p,T,N,d,g),x++,N+=F,T+=M;for(var Z=1;Z<z;Z++,N+=F)d=m(s,p[N]),g=y(s,p[N+1]),d===l&&g===h||(b(e.coords,p,T,N,d-l,g-h),T+=M,x++,l=d,h=g);x>=f&&(e.lengths.push(x),w=T)}}return e.coords.length=w,e.coords.length?e:null}function A(e,r,t,n){var o=e[r],s=e[r+1],a=e[t],u=e[t+1],i=e[n],l=e[n+1],c=a,h=u,d=i-c,g=l-h;if(0!==d||0!==g){var f=((o-c)*d+(s-h)*g)/(d*d+g*g);f>1?(c=i,h=l):f>0&&(c+=d*f,h+=g*f)}return(d=o-c)*d+(g=s-h)*g}function U(e,r,t,n,o,s,a){for(var u,i=n,l=0,c=s+t;c<a;c+=t)(u=A(r,c,s,a))>i&&(l=c,i=u);i>n&&(l-s>t&&U(e,r,t,n,o,s,l),o(e,r,e.length,l,r[l],r[l+1]),a-l>t&&U(e,r,t,n,o,l,a))}function R(e,r,t,n,o){var s=r.coords,a=r.lengths,u=t?n?f:d:n?d:h,l=i(t,n);if(!s.length)return e!==r&&(e.lengths.length=0,e.coords.length=0),e;if(!a.length)return u(e.coords,s,0,0,p(o,s[0]),I(o,s[1])),e!==r&&(e.lengths.length=0,e.coords.length=l),e;for(var c=o.scale,g=c[0],v=c[1],m=0,y=0;y<a.length;y++){var F=a[y];e.lengths[y]=F;var M=p(o,s[m]),b=I(o,s[m+1]);u(e.coords,s,m,m,M,b),m+=l;for(var N=1;N<F;N++,m+=l)M+=s[m]*g,b-=s[m+1]*v,u(e.coords,s,m,m,M,b)}return e!==r&&(e.lengths.length=a.length,e.coords.length=s.length),e}r.convertFromFeature=function(e,r,t,n,o){Y[0]=e;var s=k(_,Y,r,t,n,o)[0];return Y.length=_.length=0,s},r.convertFromFeatures=k,r.convertToFeature=function(e,r,t,n){_[0]=e,L(Y,_,r,t,n);var o=Y[0];return Y.length=_.length=0,o},r.convertFromGeometry=function(e,r,n){if(!e)return null;var s=new u.default;return"hasZ"in e&&null==r&&(r=e.hasZ),"hasM"in e&&null==n&&(n=e.hasM),o.isPoint(e)?z(null!=r?r:null!=e.z,null!=n?n:null!=e.m)(s,e):o.isPolygon(e)?j(s,e,r,n):o.isPolyline(e)?E(s,e,i(r,n)):o.isMultipoint(e)?Z(s,e,i(r,n)):void l.error("convertFromGeometry:unknown-geometry",new t("Unable to parse unknown geometry type '"+e+"'"))},r.convertToGeometry=function(e,r,n,o){var s=e&&("coords"in e?e:e.geometry);if(!s)return null;switch(r){case"esriGeometryPoint":var a=F;return n&&o?a=G:n?a=b:o&&(a=T),a(s);case"esriGeometryMultipoint":return x(s,n,o);case"esriGeometryPolyline":return O(s,n,o);case"esriGeometryPolygon":return S(s,n,o);default:return void l.error("convertToGeometry:unknown-geometry",new t("Unable to parse unknown geometry type '"+r+"'"))}},r.convertToFeatures=L,r.convertToFeatureSet=function(e){var r=e.objectIdFieldName,t=e.spatialReference,n=e.transform,o=e.fields,s=e.hasM,a=e.hasZ,u=e.features,i=e.geometryType,l=e.exceededTransferLimit,c={features:L([],u,i,a,s),fields:o,geometryType:i,objectIdFieldName:r,spatialReference:t};return n&&(c.transform=n),l&&(c.exceededTransferLimit=l),s&&(c.hasM=s),a&&(c.hasZ=a),c},r.convertFromFeatureSet=function(e,r){var n=new a.default,o=e.hasM,s=e.hasZ,u=e.features,i=e.objectIdFieldName,c=e.spatialReference,h=e.geometryType,d=e.exceededTransferLimit,g=e.transform;return n.fields=e.fields,n.geometryType=h,n.objectIdFieldName=i||r,n.spatialReference=c,n.objectIdFieldName?(u&&k(n.features,u,h,s,o,n.objectIdFieldName),d&&(n.exceededTransferLimit=d),o&&(n.hasM=o),s&&(n.hasZ=s),g&&(n.transform=g),n):(l.error(new t("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),n)},r.hydrateOptimizedFeatureSet=function(e){var r=e.transform,t=e.features,n=e.hasM,o=e.hasZ;if(!r)return e;for(var s=0,a=t;s<a.length;s++){var u=a[s];u.geometry&&R(u.geometry,u.geometry,n,o,r),u.centroid&&R(u.centroid,u.centroid,n,o,r)}return e.transform=null,e},r.quantizeOptimizedFeatureSet=function(e,r){var t=r.geometryType,n=r.features,o=r.hasM,a=r.hasZ;if(!e)return r;for(var i=0;i<n.length;i++){var l=n[i],c=new s.default(new u.default,l.attributes);q(c.geometry,l.geometry,o,a,t,e),l.centroid&&(c.centroid=new u.default,q(c.centroid,l.centroid,o,a,"esriGeometryPoint",e)),n[i]=c}return r.transform=e,r},r.quantizeOptimizedGeometry=q,r.generalizeOptimizedGeometry=function(e,r,t,n,o,s,a,u){if(void 0===a&&(a=t),void 0===u&&(u=n),e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!r||!r.coords.length)return null;var l=c[o],h=r.coords,d=r.lengths,g=i(t,n),f=i(t&&a,n&&u),m=v(t,n,a,u);if(!d.length)return m(e.coords,h,0,0,h[0],h[1]),e.lengths.length&&(e.lengths.length=0),e.coords.length=g,e;for(var y=0,p=s*s,I=0,F=d;I<F.length;I++){var M=F[I];if(M<l)y+=M*g;else{var b=e.coords.length/f,N=y,T=y+(M-1)*g;m(e.coords,h,e.coords.length,N,h[N],h[N+1]),U(e.coords,h,g,p,m,N,T),m(e.coords,h,e.coords.length,T,h[T],h[T+1]);var w=e.coords.length/f-b;w>=l?e.lengths.push(w):e.coords.length=b*f,y+=M*g}}return e.coords.length?e:null},r.getBoundsOptimizedGeometry=function(e,r,t,n){var o=i(t,n),s=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY;if(r&&r.coords)for(var c=r.coords,h=0;h<c.length;h+=o){var d=c[h],g=c[h+1];s=Math.min(s,d),u=Math.max(u,d),a=Math.min(a,g),l=Math.max(l,g)}return e[0]=s,e[1]=a,e[2]=u,e[3]=l,e},r.getQuantizedBoundsOptimizedGeometry=function(e,r,t,n){for(var o=i(t,n),s=r.lengths,a=r.coords,u=Number.POSITIVE_INFINITY,l=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY,h=Number.NEGATIVE_INFINITY,d=0,g=0,f=s;g<f.length;g++){var v=f[g],m=a[d],y=a[d+1];u=Math.min(m,u),l=Math.min(y,l),c=Math.max(m,c),h=Math.max(y,h),d+=o;for(var p=1;p<v;p++,d+=o){var I=a[d],F=a[d+1];m+=I,y+=F,I<0&&(u=Math.min(u,m)),I>0&&(c=Math.max(c,m)),F<0?l=Math.min(l,y):F>0&&(h=Math.max(h,y))}}return e[0]=u,e[1]=l,e[2]=c,e[3]=h,e},r.hydrateOptimizedGeometry=R,r.removeZMValues=function(e,r,t,n,o,s){var a,u=i(t,n),l=v(t,n,o,s),c=r.coords;e.coords.length=0,e.lengths.length=0,(a=e.lengths).push.apply(a,r.lengths);for(var h=0;h<c.length;h+=u)l(e.coords,c,e.coords.length,h,c[h],c[h+1]);return e},r.removeCollinearVectices=function(e,r,t,n,o){if(!r||!r.coords||!r.coords.length)return null;for(var s=c[t],a=r.coords,u=r.lengths,l=v(n,o,n,o),h=i(n,o),d=0,g=0,f=0,m=0,y=0,p=u;y<p.length;y++){var I=p[y];g=m,l(e.coords,a,g,d,a[d],a[d+1]);var F=a[d+=h],M=a[d+1],b=F,N=M,T=M/F;g+=h,l(e.coords,a,g,d,b,N),d+=h;for(var w=2;w<I;w++){F=a[d];var G=(M=a[d+1])/F,P=T===G||!isFinite(T)&&!isFinite(G),z=P&&isFinite(G)?T>=0&&G>=0||T<=0&&G<=0:N>=0&&M>=0||N<=0&&M<=0;P&&z?(b+=F,N+=M):(b=F,N=M,g+=h),l(e.coords,a,g,d,b,N),d+=h,T=G}var x=((g+=h)-m)/h;x>=s&&(e.lengths[f]=x,m=g,f++)}return e.coords.length>m&&(e.coords.length=m),e.lengths.length>f&&(e.lengths.length=f),e.coords.length&&e.lengths.length?e:null}}));