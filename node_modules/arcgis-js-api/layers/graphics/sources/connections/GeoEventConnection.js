// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../geometry","../../../../request","../../../../core/Error","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators","../../../FeatureLayer","./StreamConnection","../../../../tasks/operations/query","../../../../tasks/operations/zscale","../../../../tasks/support/Query"],(function(e,t,r,n,o,i,s,c,a,u,d,_,h,f,l){Object.defineProperty(t,"__esModule",{value:!0});var y,p=s.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection");!function(e){e[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED"}(y=t.ReadyState||(t.ReadyState={}));var v=function(e){function t(t,r,n,o,i,s,c,a){void 0===s&&(s=5),void 0===c&&(c=3);var u=e.call(this)||this;return u._destroyed=!1,u.errorString=null,u._source=t,u._sourceSpatialReference=r,u._spatialReference=n,u._filter=i,u._outFields=a,u._maxQueryDepth=s,u._maxRecordCountFactor=c,u._featureZScaler=f.getGeometryZScaler(o,r,n),u._open(),u}return r.__extends(t,e),t.prototype._open=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,n,o;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this._fetchServiceDefinition(this._source)];case 1:return(e=r.sent()).timeInfo.trackIdField||p.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect."),[4,this._fetchWebSocketUrl(e.streamUrls,this._spatialReference)];case 2:return t=r.sent(),this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),[4,this._buddyServicesQuery];case 3:return r.sent(),[4,this._tryCreateWebSocket(t)];case 4:return r.sent(),n=this._filter,o=this._outFields,this._destroyed||this._setFilter(n,o),[2]}}))}))},t.prototype.destroy=function(){this._destroyed=!0,c.isSome(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null},Object.defineProperty(t.prototype,"connectionStatus",{get:function(){if(c.isNone(this._websocket))return"disconnected";switch(this._websocket.readyState){case y.CONNECTING:case y.OPEN:return"connected";case y.CLOSING:case y.CLOSED:return"disconnected"}},enumerable:!0,configurable:!0}),t.prototype._tryCreateWebSocket=function(e,t){return void 0===t&&(t=1e3),r.__awaiter(this,void 0,void 0,(function(){var n,o,s;return r.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,4]),this._destroyed?[2]:(n=this,[4,this._createWebSocket(e)]);case 1:return n._websocket=r.sent(),this.notifyChange("connectionStatus"),[3,4];case 2:return o=r.sent(),s=t/1e3,p.error(new i("geoevent-connection","Failed to connect. Attempting to reconnect in "+s+"s",o)),[4,a.after(t)];case 3:return r.sent(),[2,this._tryCreateWebSocket(e,1.5*t)];case 4:return[2]}}))}))},t.prototype._createWebSocket=function(e){var t=this,r=new WebSocket(e),n=a.create((function(e,t){r.onopen=function(){return e(r)},r.onclose=function(e){return t(e)}}));return n.then((function(){if(t._destroyed)return r.onclose=function(){},void r.close();r.onclose=function(e){return t._onClose(e)},r.onerror=function(e){return t._onError(e)},r.onmessage=function(e){return t._onMessage(e)}})),n},t.prototype._onMessage=function(e){var t;try{t=this._enrich(JSON.parse(e.data)),this._featureZScaler&&this._featureZScaler(t.geometry)}catch(e){return void p.error(new i("geoevent-connection","Failed to parse message",e))}this.onFeature(t)},t.prototype._onError=function(e){var t="Encountered an error over WebSocket connection";this._set("errorString",t),p.error("geoevent-connection",t)},t.prototype._onClose=function(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&p.error("geoevent-connection","WebSocket closed unexpectedly with error code "+e.code),this._destroyed||this._open()},t.prototype._fetchServiceDefinition=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,o(e,{query:{f:"json"},responseType:"json"})];case 1:return t=r.sent(),n=t.data,this._serviceDefinition=n,[2,n]}}))}))},t.prototype._fetchWebSocketUrl=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,o,i;return r.__generator(this,(function(r){return n=e[0],o=n.urls,i=n.token,[2,this._inferWebSocketBaseUrl(o)+"/subscribe?outSR="+t.wkid+(i?"&token="+i:"")]}))}))},t.prototype._inferWebSocketBaseUrl=function(e){if(1===e.length)return e[0];for(var t=0,r=e;t<r.length;t++){var n=r[t];if(-1!==n.indexOf("wss"))return n}return p.error(new i("geoevent-connection","Unable to infer WebSocket url",e)),null},t.prototype._setFilter=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,o,s,u,d,_,h=this;return r.__generator(this,(function(r){return n=this._websocket,this._filter=e,this._outFields=t,c.isNone(n)||c.isNone(e)&&c.isNone(t)?[2]:(o=JSON.stringify({filter:this._serializeFilter(e,t)}),s=!1,u=a.createResolver(),d=function(){s||(h._destroyed||h._websocket!==n||p.error(new i("geoevent-connection","Server timed out when setting filter")),u.reject())},_=function(e){var t=JSON.parse(e.data);t.filter&&(t.error&&(p.error(new i("geoevent-connection","Failed to set service filter",t.error)),h._set("errorString","Could not set service filter - "+t.error),u.reject(t.error)),n.onmessage=h._onMessage.bind(h),s=!0,u.resolve())},n.onmessage=_,n.send(o),setTimeout(d,1e4),[2,u.promise])}))}))},t.prototype._serializeFilter=function(e,t){var r={};if(c.isNone(e)&&c.isNone(t))return r;if(c.isSome(e)&&e.geometry)try{var o=n.fromJSON(e.geometry);if("extent"!==o.type)throw new i("Expected extent but found type "+o.type);r.geometry=JSON.stringify(o.shiftCentralMeridian())}catch(e){p.error(new i("geoevent-connection","Encountered an error when setting connection geometryDefinition",e))}return c.isSome(e)&&e.where&&"1 = 1"!==e.where&&(r.where=e.where),c.isSome(t)&&(r.outFields=t.join(",")),r},t.prototype._enrich=function(e){if(!this._relatedFeatures)return e;var t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t];if(!this._relatedFeatures.has(r))return p.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;var n=this._relatedFeatures.get(r),o=n.attributes,s=n.geometry;for(var c in o)e.attributes[c]=o[c];return s&&(e.geometry=s),e.geometry||e.centroid||p.error(new i("geoevent-connection","Found malformed feature - no geometry found",e)),e},t.prototype._queryBuddyServices=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,n,o,s,c,a,u,d,_;return r.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),e=this._serviceDefinition,t=e.relatedFeatures,n=e.keepLatestArchive,o=this._queryRelatedFeatures(t),s=this._queryArchive(n),[4,o];case 1:return r.sent(),[4,s];case 2:if(!(c=r.sent()))return[2];for(a=0,u=c.features;a<u.length;a++)d=u[a],this.onFeature(this._enrich(d));return[3,4];case 3:return _=r.sent(),p.error(new i("geoevent-connection","Encountered an error when querying buddy services",{error:_})),[3,4];case 4:return[2]}}))}))},t.prototype._queryRelatedFeatures=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return e?[4,this._queryBuddy(e.featuresUrl)]:[2];case 1:return t=r.sent(),this._addRelatedFeatures(t),[2]}}))}))},t.prototype._queryArchive=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return e?[2,this._queryBuddy(e.featuresUrl)]:[2,void 0]}))}))},t.prototype._queryBuddy=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,o,i,s,a,u,_,f,y;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,(t=new d({url:e})).load()];case 1:return n=r.sent().capabilities,o=n.query.supportsMaxRecordCountFactor,i=n.query.supportsPagination,s=n.query.supportsCentroid,a=this._maxRecordCountFactor,u=t.capabilities.query.maxRecordCount,_=o?u*a:u,(f=new l).outFields=c.unwrapOr(this._outFields,["*"]),f.where=c.unwrapOr(c.get(this._filter,"where"),"1=1"),f.returnGeometry=!0,f.returnExceededLimitFeatures=!0,f.outSpatialReference=this._spatialReference,s&&(f.returnCentroid=!0),o&&(f.maxRecordCountFactor=a),i?(f.num=_,t.destroy(),[2,this._queryPages(e,f)]):[4,h.executeQuery(e,f,this._sourceSpatialReference)];case 2:return y=r.sent(),t.destroy(),[2,y.data]}}))}))},t.prototype._queryPages=function(e,t,n,o){return void 0===n&&(n=[]),void 0===o&&(o=0),r.__awaiter(this,void 0,void 0,(function(){var i;return r.__generator(this,(function(r){switch(r.label){case 0:return t.start=o*t.num,[4,h.executeQuery(e,t,this._sourceSpatialReference)];case 1:return(i=r.sent().data).exceededTransferLimit&&o<this._maxQueryDepth?(i.features.forEach((function(e){return n.push(e)})),[2,this._queryPages(e,t,n,o+1)]):(n.forEach((function(e){return i.features.push(e)})),[2,i])}}))}))},t.prototype._addRelatedFeatures=function(e){for(var t=new Map,r=e.features,n=this._serviceDefinition.relatedFeatures.joinField,o=0,i=r;o<i.length;o++){var s=i[o],c=s.attributes[n];t.set(c,s)}this._relatedFeatures=t},r.__decorate([u.property()],t.prototype,"connectionStatus",null),r.__decorate([u.property()],t.prototype,"errorString",void 0),t=r.__decorate([u.subclass("esri.layers.graphics.sources.connections.GeoEventConnection")],t)}(_.default);t.default=v}));