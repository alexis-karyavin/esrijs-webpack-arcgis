// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../geometry","../../Graphic","../../core/compilerUtils","../../core/has","../../core/lang","../../core/maybe","../../core/typedArrayUtil","../../geometry/SpatialReference","../../geometry/support/aaBoundingBox","../../geometry/support/aaBoundingRect","../../geometry/support/jsonUtils","../../geometry/support/quantizationUtils","../support/Field","./dehydratedFeatureComparison"],(function(e,t,r,a,n,i,s,o,l,u,h,c,p,m,y,f){Object.defineProperty(t,"__esModule",{value:!0}),t.equals=f.equals;var d=function(e,t,r){this.uid=e,this.geometry=t,this.attributes=r,this.visible=!0,this.objectId=null,this.centroid=null};t.DehydratedFeatureClass=d,t.hasGeometry=function(e){return o.isSome(e.geometry)},t.isFeatureGeometry=function(e){return r.isFeatureGeometryType(e.type)};var g=function(){this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null};function b(e,t,r){if(!e)return null;switch(t){case"point":var a=e;return{x:a.x,y:a.y,z:a.z,m:a.m,hasZ:null!=a.z,hasM:null!=a.m,type:"point",spatialReference:r};case"polyline":var n=e;return{paths:n.paths,hasZ:!!n.hasZ,hasM:!!n.hasM,type:"polyline",spatialReference:r};case"polygon":var i=e;return{rings:i.rings,hasZ:!!i.hasZ,hasM:!!i.hasM,type:"polygon",spatialReference:r};case"multipoint":var s=e;return{points:s.points,hasZ:!!s.hasZ,hasM:!!s.hasM,type:"multipoint",spatialReference:r}}}function x(e,t,r,a){return{x:e,y:t,z:r,hasZ:null!=r,hasM:!1,spatialReference:a,type:"point"}}function v(e){return"declaredClass"in e}function Z(e){return"declaredClass"in e}function M(e){return"declaredClass"in e}function A(e){return o.isNone(e)?null:v(e)?e:p.fromJSON(function(e){var t=e.spatialReference.toJSON();switch(e.type){case"point":var r=e.x,a=e.y,i=e.z,s=e.m;return{x:r,y:a,z:i,m:s,spatialReference:t};case"polygon":var o=e.rings,l=e.hasZ,u=e.hasM;return{rings:k(o),hasZ:l,hasM:u,spatialReference:t};case"polyline":var h=e.paths;l=e.hasZ,u=e.hasM;return{paths:k(h),hasZ:l,hasM:u,spatialReference:t};case"extent":var c=e.xmin,p=e.xmax,m=e.ymin,y=e.ymax,f=e.zmin,d=e.zmax,g=e.mmin,b=e.mmax;l=e.hasZ,u=e.hasM;return{xmin:c,xmax:p,ymin:m,ymax:y,zmin:f,zmax:d,mmin:g,mmax:b,hasZ:l,hasM:u,spatialReference:t};case"multipoint":var x=e.points;l=e.hasZ,u=e.hasM;return{points:S(x)?F(x):x,hasZ:l,hasM:u,spatialReference:t};default:return void n.neverReached(e)}}(e))}t.DehydratedFeatureSetClass=g,t.isPoint=function(e){return"point"===e.type},t.fromFeatureSetJSON=function(e){var t=r.featureGeometryTypeKebabDictionary.fromJSON(e.geometryType),i=u.fromJSON(e.spatialReference),s=e.transform,o=e.features.map((function(r){var o=function(e,t,r,n){return{uid:a.generateUID(),objectId:n&&e.attributes?e.attributes[n]:null,attributes:e.attributes,geometry:b(e.geometry,t,r),visible:!0}}(r,t,i,e.objectIdFieldName),l=o.geometry;if(l&&s)switch(l.type){case"point":o.geometry=m.hydratePoint(s,l,l,l.hasZ,l.hasM);break;case"multipoint":o.geometry=m.hydrateMultipoint(s,l,l,l.hasZ,l.hasM);break;case"polygon":o.geometry=m.hydratePolygon(s,l,l,l.hasZ,l.hasM);break;case"polyline":o.geometry=m.hydratePolyline(s,l,l,l.hasZ,l.hasM);break;default:n.neverReached(l)}return o}));return{geometryType:t,features:o,spatialReference:i,fields:e.fields?e.fields.map((function(e){return y.fromJSON(e)})):null,objectIdFieldName:e.objectIdFieldName,globalIdFieldName:e.globalIdFieldName,geohashFieldName:e.geohashFieldName,geometryProperties:e.geometryProperties,hasZ:e.hasZ,hasM:e.hasM,exceededTransferLimit:e.exceededTransferLimit,transform:null}},t.fromJSONGeometry=b,t.makeDehydratedPoint=x,t.isHydratedGeometry=v,t.isHydratedPoint=Z,t.isHydratedGraphic=M,t.hydrateGraphic=function(e,t){if(!e)return null;if(M(e))return e;var r=new a({layer:t,sourceLayer:t});return r.visible=e.visible,r.symbol=s.clone(e.symbol),r.attributes=s.clone(e.attributes),r.geometry=A(e.geometry),r},t.hydrateGeometry=A,t.clonePoint=function(e,t){if(!e)return null;var r;if(Z(e)){if(null==t)return e.clone();if(Z(t))return t.copy(e)}return null!=t?((r=t).x=e.x,r.y=e.y,r.spatialReference=e.spatialReference,e.hasZ?(r.z=e.z,r.hasZ=e.hasZ):(r.z=null,r.hasZ=!1),e.hasM?(r.m=e.m,r.hasM=!0):(r.m=null,r.hasM=!1)):(r=x(e.x,e.y,e.z,e.spatialReference),e.hasM&&(r.m=e.m,r.hasM=!0)),r};var R=i("esri-text-decoder")?function(e){return 32+e.length}:function(e){return 32*e.length};function z(e){if(!e)return 0;var t=32;for(var r in e)if(e.hasOwnProperty(r)){var a=e[r];switch(typeof a){case"string":t+=R(a);break;default:case"number":t+=16}}return t}function N(e){if(o.isNone(e))return 0;var t=32;switch(e.type){case"point":t+=42;break;case"polyline":case"polygon":for(var r=0,a=2+(e.hasZ?1:0)+(e.hasM?1:0),i="polyline"===e.type?e.paths:e.rings,s=0,u=i;s<u.length;s++){r+=u[s].length}t+=8*r*a+64,t+=128*r,t+=34,t+=32*(i.length+1);break;case"multipoint":var h=2+(e.hasZ?1:0)+(e.hasM?1:0),c=e.points.length;t+=8*c*h+64,t+=128*c,t+=34,t+=32;break;case"extent":t+=98,e.hasM&&(t+=32),e.hasZ&&(t+=32);break;case"mesh":t+=l.estimateSize(e.vertexAttributes.position),t+=l.estimateSize(e.vertexAttributes.normal),t+=l.estimateSize(e.vertexAttributes.uv),t+=l.estimateSize(e.vertexAttributes.tangent);break;default:n.neverReached(e)}return t}function k(e){return function(e){for(var t=0,r=e;t<r.length;t++){var a=r[t];if(0!==a.length)return S(a)}return!1}(e)?e.map((function(e){return F(e)})):e}function F(e){return e.map((function(e){return l.toArray(e)}))}function S(e){return e.length&&(l.isFloat32Array(e[0])||l.isFloat64Array(e[0]))}function j(e,t){switch(h.empty(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[3]=e.x,t[1]=t[4]=e.y,e.hasZ&&(t[2]=t[5]=e.z);break;case"polyline":for(var r=0;r<e.paths.length;r++)h.expandWithNestedArray(t,e.paths[r],e.hasZ);break;case"polygon":for(r=0;r<e.rings.length;r++)h.expandWithNestedArray(t,e.rings[r],e.hasZ);break;case"multipoint":h.expandWithNestedArray(t,e.points,e.hasZ);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[3]=e.xmax,t[4]=e.ymax,null!=e.zmin&&(t[2]=e.zmin),null!=e.zmax&&(t[5]=e.zmax);break;default:n.neverReached(e)}}function I(e,t){switch(c.empty(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[2]=e.x,t[1]=t[3]=e.y;break;case"polyline":for(var r=0;r<e.paths.length;r++)c.expandWithNestedArray(t,e.paths[r]);break;case"polygon":for(r=0;r<e.rings.length;r++)c.expandWithNestedArray(t,e.rings[r]);break;case"multipoint":c.expandWithNestedArray(t,e.points);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax;break;default:n.neverReached(e)}}t.estimateAttributesObjectSize=z,t.estimateGeometryObjectSize=N,t.estimateSize=function(e){var t=32;return t+=z(e.attributes),t+=3,t+=8+N(e.geometry)},t.numVertices=function(e){if(o.isNone(e))return 0;switch(e.type){case"point":return 1;case"polyline":for(var t=0,r=0,a=e.paths;r<a.length;r++){t+=a[r].length}return t;case"polygon":t=0;for(var i=0,s=e.rings;i<s.length;i++){t+=s[i].length}return t;case"multipoint":return e.points.length;case"extent":return 2;case"mesh":var l=e.vertexAttributes&&e.vertexAttributes.position;return l?l.length/3:0;default:return void n.neverReached(e)}},t.hasVertices=function(e){if(!e)return!1;switch(e.type){case"extent":case"point":return!0;case"polyline":for(var t=0,r=e.paths;t<r.length;t++){if(r[t].length>0)return!0}return!1;case"polygon":for(var a=0,i=e.rings;a<i.length;a++){if(i[a].length>0)return!0}return!1;case"multipoint":return e.points.length>0;case"mesh":return e.vertexAttributes&&e.vertexAttributes.position&&e.vertexAttributes.position.length>0;default:return void n.neverReached(e)}},t.computeAABB=j,t.expandAABB=function(e,t){j(e,O),h.expand(t,O)},t.computeAABR=I,t.expandAABR=function(e,t){I(e,P),c.expand(t,P)},t.getObjectId=function(e,t){return null!=e.objectId?e.objectId:e.attributes&&t?e.attributes[t]:null};var O=h.create(),P=c.create()}));