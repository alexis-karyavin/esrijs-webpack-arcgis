// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../geometry","../../../request","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../core/urlUtils","../../../core/accessorSupport/decorators","../RasterInfo","../RasterStorageInfo","../serviceTileInfoProperty","../TileInfo","../TilemapCache","./BaseRaster","../rasterFunctions/pixelUtils","../../../tasks/support/FeatureSet"],(function(e,t,i,n,r,a,l,s,o,u,c,h,f,m,p,x,d,y){return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._levelOffset=0,t._slices=null,t._tilemapCache=null,t}return i.__extends(t,e),t.prototype.open=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,n,s,u,c,x,d,y,v,g,w,_,b,S,M,I,T,R,C,z,O,L,N,P,j;return i.__generator(this,(function(i){switch(i.label){case 0:return[4,this.init()];case 1:return i.sent(),t=e&&e.signal,this.sourceJSON?(s={data:this.sourceJSON},[3,4]):[3,2];case 2:return[4,r(this.url,{responseType:"json",query:{f:"json"},signal:t})];case 3:s=i.sent(),i.label=4;case 4:if((n=s).ssl&&(this.url=this.url.replace(/^http:/i,"https:")),u=n.data,this.sourceJSON=u,c=["jpg","jpeg","png","png8","png24","png32","mixed"],this.tileType=u.cacheType,null===this.tileType&&(c.indexOf(u.tileInfo.format.toLowerCase())>-1?this.tileType="Map":"lerc"===u.tileInfo.format.toLowerCase()?this.tileType="Elevation":this.tileType="Raster"),!u)throw new a("imageserverraster:open","cannot initialize tiled image service, missing service info");if(!u.tileInfo)throw new a("imageserverraster:open","use ImageryLayer to open non-tiled image services");return this.datasetName=u.name,[4,this._fetchRasterInfo({signal:t})];case 5:if(x=i.sent(),!l.isSome(x))throw new a("image-server-raster:open","cannot initialize image service");if(d="Map"===this.tileType?f.readServiceTileInfo(u.tileInfo,u,null):m.fromJSON(u.tileInfo),y=x.extent,v=x.pixelSize,g=.5/x.width*v.x,w=void 0,_=void 0,b=d.lodAt(Math.max.apply(null,d.lods.map((function(e){return e.level})))),"Map"!==this.tileType&&0!==u.maxScale&&("Raster"===this.tileType?(w=d.lods.filter((function(e){return e.resolution===v.x}))[0])||(w=d.lods.filter((function(e){return e.resolution>v.x})).sort((function(e,t){return e.resolution>t.resolution?1:-1}))[0]):(w=d.lods.filter((function(e){return Math.abs(e.scale-u.maxScale)<g}))[0])||(w=d.lods.filter((function(e){return e.scale>u.maxScale})).sort((function(e,t){return e.scale>t.scale?1:-1}))[0]),v.x=v.y=w.resolution,x.width=Math.ceil((y.xmax-y.xmin)/v.x-.1),x.height=Math.ceil((y.ymax-y.ymin)/v.y-.1)),w||(w=b),S=d.lodAt(Math.min.apply(null,d.lods.map((function(e){return e.level})))),"Map"===this.tileType?this._levelOffset=d.lods[0].level:0!==u.minScale&&"Elevation"===this.tileType&&(_=d.lods.filter((function(e){return Math.abs(e.scale-u.minScale)<g}))[0],this._levelOffset=_.level-S.level),_||(_=S),M=Math.max(v.x,v.y),(Math.abs(v.x-v.y)>g||!d.lods.some((function(e){return Math.abs(e.resolution-M)<g})))&&(v.x=v.y=w.resolution,x.width=Math.ceil((y.xmax-y.xmin)/v.x-.1),x.height=Math.ceil((y.ymax-y.ymin)/v.y-.1)),I=w.level-_.level,T=d.size,R=T[0],C=T[1],z=d.origin,O=v.x,L=v.y,N=[{minCol:Math.floor((y.xmin-z.x+.1*O)/R/O),maxCol:Math.floor((y.xmax-z.x-.1*O)/R/O),minRow:Math.floor((z.y-y.ymax+.1*L)/C/L),maxRow:Math.floor((z.y-y.ymin-.1*L)/C/L)}],I>0)for(P=0;P<I;P++)O*=2,L*=2,N.push({minCol:Math.floor((y.xmin-z.x+.1*O)/R/O),maxCol:Math.floor((y.xmax-z.x-.1*O)/R/O),minRow:Math.floor((z.y-y.ymax+.1*L)/C/O),maxRow:Math.floor((z.y-y.ymin-.1*L)/C/O)});return x.storageInfo=new h({blockWidth:d.size[0],blockHeight:d.size[1],pyramidBlockWidth:d.size[0],pyramidBlockHeight:d.size[1],compression:d.format,origin:d.origin,firstPyramidLevel:1,maximumPyramidLevel:I,tileInfo:d,blockBoundary:N}),this._set("rasterInfo",x),u.capabilities.toLowerCase().indexOf("tilemap")>-1&&(j={tileInfo:x.storageInfo.tileInfo,parsedUrl:o.urlToObject(this.url),url:this.url,tileServers:[],type:"tile"},this._tilemapCache=new p.TilemapCache({layer:j})),[2]}}))}))},t.prototype.fetchRawTile=function(e,t,n,r){return void 0===r&&(r={}),i.__awaiter(this,void 0,void 0,(function(){var a,l,s,o,u,c,h,f,m,p,x,y,v,g,w,_,b,S,M,I,T,R;return i.__generator(this,(function(i){switch(i.label){case 0:return a=this.rasterInfo,l=a.storageInfo,s=a.extent,o=a.pixelSize,u=l.maximumPyramidLevel-e+this._levelOffset,c=this.url+"/tile/"+u+"/"+t+"/"+n,h=this._slices?{sliceId:r.sliceId||0}:null,[4,this.request({url:c,query:h,responseType:"array-buffer"},r.signal)];case 1:return(f=i.sent())?[4,this.decodePixelBlock(f,{width:l.tileInfo.size[0],height:l.tileInfo.size[1],planes:null,pixelType:null,isPoint:"Elevation"===this.tileType})]:[2,null];case 2:return m=i.sent(),p=l.blockBoundary[e],"jpg"!==l.compression||n>p.minCol&&n<p.maxCol&&t>p.minRow&&t<p.maxRow?[2,m]:(x=l.origin,y=l.blockWidth,v=l.blockHeight,g=Math.pow(2,e),w=Math.round((s.xmin-x.x)/(o.x*g))%y,_=Math.round((s.xmax-x.x)/(o.x*g))%y,b=Math.round((x.y-s.ymax)/(o.x*g))%v,S=Math.round((x.y-s.ymin)/(o.x*g))%v,M=n===p.minCol?w:0,I=t===p.minRow?b:0,T=n===p.maxCol?_:y,R=t===p.maxRow?S:v,d.setValidBoundary(m,{x:M,y:I},{width:T-M,height:R-I}),[2,m])}}))}))},t.prototype.getSliceIndex=function(e){for(var t=e,i=0;i<this._slices.length;i++){var n=this._slices[i].multidimensionalDefinition;if(n.length===t.length&&!n.some((function(e){var i=t.filter((function(t){return e.variableName===t.variableName&&t.dimensionName===e.dimensionName}))[0];return i?(Array.isArray(e.values[0])?e.values[0][0]:e.values[0])!==(Array.isArray(i.values[0])?i.values[0][0]:i.values[0]):null})))return i}return null},t.prototype.computeBestPyramidLevelForLocation=function(e,t){return void 0===t&&(t={}),i.__awaiter(this,void 0,void 0,(function(){var n,r,a,l,s;return i.__generator(this,(function(i){switch(i.label){case 0:if(!this._tilemapCache)return[2,0];if(null===(n=this.identifyPixelLocation(e,0,t.datumTransformation)))return[2,null];r=0,a=this.rasterInfo.storageInfo.maximumPyramidLevel,l=a-r+this._levelOffset,s=n.srcLocation,i.label=1;case 1:if(!(l>=0))return[3,6];i.label=2;case 2:return i.trys.push([2,4,,5]),[4,this._tilemapCache.fetchAvailability(l,n.row,n.col,t)];case 3:return"available"===i.sent()?[3,6]:[3,5];case 4:return i.sent(),[3,5];case 5:return l--,r++,null===(n=this.identifyPixelLocation(s,r,t.datumTransformation))?[2,null]:[3,1];case 6:return-1===l||null==n?[2,null]:[2,r]}}))}))},t.prototype._fetchRasterInfo=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,a,l,o,u,h,f,m,p,x,d,v,g=this;return i.__generator(this,(function(i){return t=this.sourceJSON,a=Math.ceil((t.extent.xmax-t.extent.xmin)/t.pixelSizeX-.1),l=Math.ceil((t.extent.ymax-t.extent.ymin)/t.pixelSizeY-.1),o=n.SpatialReference.fromJSON(t.spatialReference||t.extent.spatialReference),"Map"===this.tileType?[2,new c({width:a,height:l,bandCount:3,extent:n.Extent.fromJSON(t.extent),spatialReference:o,pixelSize:new n.Point({x:t.pixelSizeX,y:t.pixelSizeY,spatialReference:o}),pixelType:"u8",statistics:null})]:(u=e.slice,h=e.signal,f=!!t.hasRasterAttributeTable&&r(this.url+"/rasterAttributeTable",{query:{slice:u,f:"json"},signal:h}).then((function(e){return y.fromJSON(e.data)})).catch((function(){return null})),m=!!t.hasColormap&&r(this.url+"/colormap",{query:{slice:u,f:"json"},signal:h}).then((function(e){return e.data&&e.data.colormap})),p=!!t.hasHistograms&&r(this.url+"/histograms",{query:{slice:u,f:"json"},signal:h}).then((function(e){return e.data&&e.data.histograms})),x=r(this.url+"/keyProperties",{query:{f:"json"},signal:h}).then((function(e){return e.data})).catch((function(){})),d=!!t.hasMultidimensions&&r(this.url+"/multidimensionalInfo",{query:{f:"json"},signal:h}).then((function(e){return e.data&&e.data.multidimensionalInfo})),v=!!t.hasMultidimensions&&r(this.url+"/slices",{query:{f:"json"},signal:h}).then((function(e){return e.data&&e.data.slices})).catch((function(){})),[2,s.all([f,m,p,x,d,v]).then((function(e){var i=null;if(t.minValues&&t.minValues.length===t.bandCount){i=[];for(var r=0;r<t.minValues.length;r++)i.push({min:t.minValues[r],max:t.maxValues[r],avg:t.meanValues[r],stddev:t.stdvValues[r]})}return g._slices=e[5]||null,new c({width:a,height:l,bandCount:t.bandCount,extent:n.Extent.fromJSON(t.extent),spatialReference:o,pixelSize:new n.Point({x:t.pixelSizeX,y:t.pixelSizeY,spatialReference:o}),pixelType:t.pixelType.toLowerCase(),statistics:i,attributeTable:e[0]||null,colormap:e[1]||null,histograms:e[2]||null,keyProperties:e[3]||null,multidimensionalInfo:e[4]||null})}))])}))}))},i.__decorate([u.property({type:String,json:{write:!0}})],t.prototype,"datasetFormat",void 0),i.__decorate([u.property()],t.prototype,"tileType",void 0),t=i.__decorate([u.subclass("esri.layers.support.rasterDatasets.ImageServerRaster")],t)}(x)}));