// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../geometry","../../../core/Error","../../../core/maybe","../../../core/accessorSupport/decorators","../RasterInfo","../RasterStorageInfo","./BaseRaster","../rasterFormats/TiffDecoder","../rasterFormats/TiffTags"],(function(e,t,r,i,n,a,s,o,u,l,f,h){var d=function(e,t){var r=e.get(t);return r&&r.values},c=function(e,t){var r=e.get(t);return r&&r.values[0]};return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._files=null,t._headerInfo=null,t._bufferSize=1048576,t}return r.__extends(t,e),t.prototype.open=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,s,l,h,d,c,p,y,m,I,_,g,v,T,b,w,x,F,S,E,B,D,k,R,L,O,z;return r.__generator(this,(function(H){switch(H.label){case 0:return[4,this.init()];case 1:return H.sent(),t=e?a.unwrap(e.signal):null,[4,this.request({url:this.url,range:{from:0,to:this._bufferSize},responseType:"array-buffer"},t)];case 2:if(!(s=H.sent()))throw new n("tiffraster:open","failed to open url "+this.url);return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),l=f.parseSignature(s),h=l.littleEndian,d=l.firstIFD,c=[],[4,this.readIFDs(c,s,h,d,0,4,t)];case 3:if(H.sent(),p=f.getImageInfo(c),y=p.width,m=p.height,I=p.tileWidth,_=p.tileHeight,g=p.planes,v=p.pixelType,T=p.compression,b=p.firstPyramidLevel,w=p.maximumPyramidLevel,x=p.pyramidBlockWidth,F=p.pyramidBlockHeight,S=p.tileBoundary,E=p.metadata,B=i.Extent.fromJSON(p.extent),D=B.spatialReference,k=B?new i.Point({x:B.xmin,y:B.ymax,spatialReference:D}):new i.Point({x:0,y:0}),R=new u({blockWidth:I,blockHeight:_,pyramidBlockWidth:x,pyramidBlockHeight:F,compression:T,origin:k,firstPyramidLevel:b,maximumPyramidLevel:w,blockBoundary:S}),L=new i.Point({x:(B.xmax-B.xmin)/y,y:(B.ymax-B.ymin)/m,spatialReference:D}),O=E?{BandProperties:E.bandProperties,DataType:E.dataType}:null,z=new o({width:y,height:m,bandCount:g,pixelType:v,compression:T,pixelSize:L,storageInfo:R,spatialReference:D,keyProperties:O,extent:B,statistics:E?E.statistics:null}),this._set("rasterInfo",z),this._headerInfo=r.__assign({littleEndian:h,ifds:c},p),!this._headerInfo.isSupported)throw new n("tiffraster:open","this tiff is not supported: "+this._headerInfo.message);return[2]}}))}))},t.prototype.fetchRawTile=function(e,t,i,n){return void 0===n&&(n={}),r.__awaiter(this,void 0,void 0,(function(){var a,s,o,u,l,f,h,d,c,p,y,m,I,_,g;return r.__generator(this,(function(r){switch(r.label){case 0:return!this._headerInfo&&this._headerInfo.isSupported?[2,null]:(a=this.rasterInfo.storageInfo.blockBoundary,s=e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,o=e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight,!(u=a[e])||u.maxRow<t||u.maxCol<i||u.minRow>t||u.minCol>i?[2,null]:(l=this.getTileLocation(e,t,i))?(f=l.range,h=l.actualTileWidth,d=l.actualTileHeight,c=l.ifd,[4,this.request({url:this.url,range:f,responseType:"array-buffer"},n.signal)]):[2,null]);case 1:return p=r.sent(),[4,this.decodePixelBlock(p,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:c,offset:0,size:0},width:s,height:o,planes:null,pixelType:null})];case 2:if(y=r.sent(),h!==s||d!==o)if(g=y.mask)for(m=0;m<o;m++)if(_=m*s,m<d)for(I=h;I<s;I++)g[_+I]=0;else for(I=0;I<s;I++)g[_+I]=0;else for(g=new Uint8Array(s*o),y.mask=g,m=0;m<d;m++)for(_=m*s,I=0;I<h;I++)g[_+I]=1;return[2,y]}}))}))},t.prototype.readIFDs=function(e,t,i,n,a,s,o){return void 0===s&&(s=4),r.__awaiter(this,void 0,void 0,(function(){var u;return r.__generator(this,(function(r){switch(r.label){case 0:return n?n>=t.byteLength||n<0?[4,this.request({url:this.url,range:{from:n+a,to:n+a+this._bufferSize},responseType:"array-buffer"},o)]:[3,2]:[2,null];case 1:t=r.sent(),a=n+a,n=0,r.label=2;case 2:return[4,this.readIFD(t,i,n,a,h.TIFF_TAGS,s,o)];case 3:return u=r.sent(),e.push(u.ifd),u.nextIFD?[4,this.readIFDs(e,t,i,u.nextIFD-a,a,s,o)]:[2,null];case 4:return r.sent(),[2]}}))}))},t.prototype.readIFD=function(e,t,i,n,a,s,o){return void 0===a&&(a=h.TIFF_TAGS),void 0===s&&(s=4),r.__awaiter(this,void 0,void 0,(function(){var u,l,d,c,p,y,m,I;return r.__generator(this,(function(r){switch(r.label){case 0:return e?(u=f.parseIFD(e,t,i,n,a,s)).success?(l=[],u.ifd.forEach((function(e){e.values||l.push(e)})),l.length>0?(d=l.map((function(e){return e.offlineOffsetSize})),c=Math.min.apply(null,d.map((function(e){return e[0]}))),Math.min.apply(null,d.map((function(e){return e[0]+e[1]})))-c<=this._bufferSize?[4,this.request({url:this.url,range:{from:c,to:c+this._bufferSize},responseType:"array-buffer"},o)]:[3,2]):[3,2]):[3,5]:[2,null];case 1:e=r.sent(),n=c,l.forEach((function(r){return f.parseFieldValues(e,t,r,n)})),r.label=2;case 2:return u.ifd.has("GEOKEYDIRECTORY")?(p=u.ifd.get("GEOKEYDIRECTORY"),(y=p.values)&&y.length>4?(m=y[0]+"."+y[1]+"."+y[2],[4,this.readIFD(e,t,p.valueOffset+6-n,n,h.GEO_KEYS,2,o)]):[3,4]):[3,4];case 3:I=r.sent(),p.data=I.ifd,p.data&&p.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[m]}),r.label=4;case 4:return[2,u];case 5:return u.requiredBufferSize&&u.requiredBufferSize!==e.byteLength?[4,this.request({url:this.url,range:{from:n,to:n+u.requiredBufferSize+4},responseType:"array-buffer"},o)]:[3,7];case 6:return(e=r.sent()).byteLength<u.requiredBufferSize?[2,null]:[2,this.readIFD(e,t,0,n,h.TIFF_TAGS,4,o)];case 7:return[2]}}))}))},t.prototype.getTileLocation=function(e,t,r){var i=this.rasterInfo.storageInfo,n=i.firstPyramidLevel,a=i.blockBoundary,s=0===e?0:e-(n-1),o=this._headerInfo.ifds[s];if(!o)return null;var u=d(o,"TILEOFFSETS");if(void 0===u)return null;var l=d(o,"TILEBYTECOUNTS"),f=a[s],h=f.minRow,p=f.minCol,y=f.maxRow,m=f.maxCol;if(t>y||r>m||t<h||r<p)return null;var I=c(o,"IMAGEWIDTH"),_=c(o,"IMAGELENGTH"),g=c(o,"TILEWIDTH"),v=c(o,"TILELENGTH"),T=t*(m+1)+r,b=u[T],w=l[T];return null==b||null==w?null:{range:{from:b,to:b+w-1},ifd:o,actualTileWidth:r===m?I%g:g,actualTileHeight:t===y?_%v:v}},r.__decorate([s.property()],t.prototype,"_files",void 0),r.__decorate([s.property()],t.prototype,"_headerInfo",void 0),r.__decorate([s.property()],t.prototype,"_bufferSize",void 0),r.__decorate([s.property({type:String,json:{write:!0}})],t.prototype,"datasetFormat",void 0),t=r.__decorate([s.subclass("esri.layers.support.rasterDatasets.TIFFRaster")],t)}(l)}));