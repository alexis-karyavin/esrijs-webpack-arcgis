// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../geometry","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators","../RasterInfo","../RasterStorageInfo","../TileInfo","./BaseRaster","./DBFParser","../../../tasks/support/FeatureSet"],(function(e,t,r,i,n,o,a,s,l,u,f,c,p,d){var h=new Map;h.set("int16","esriFieldTypeSmallInteger"),h.set("int32","esriFieldTypeInteger"),h.set("int64","esriFieldTypeInteger"),h.set("float32","esriFieldTypeSingle"),h.set("float64","esriFieldTypeDouble"),h.set("text","esriFieldTypeString");return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.storageInfo=null,t}return r.__extends(t,e),t.prototype.open=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,a,s,l,u;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.init()];case 1:return r.sent(),t=e?o.unwrap(e.signal):null,[4,this.request({url:this.url+"/conf.json",responseType:"json"},t)];case 2:if(i=r.sent(),!this._validateHeader(i))throw new n("cloudraster:open","Invalid or unsupported conf.json.");return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),a=this._parseHeader(i),s=a.storageInfo,"thematic"!==(l=a.rasterInfo).dataType?[3,4]:[4,this._fetchAuxiliaryInformation()];case 3:u=r.sent(),l.attributeTable=u,r.label=4;case 4:return this._set("storageInfo",s),this._set("rasterInfo",l),this.ioConfig.retryCount=this.ioConfig.retryCount||0,[2]}}))}))},t.prototype.fetchRawTile=function(e,t,i,n){return void 0===n&&(n={}),r.__awaiter(this,void 0,void 0,(function(){var o,a,s,l,u,f,c;return r.__generator(this,(function(r){switch(r.label){case 0:return(o=this.rasterInfo.storageInfo.maximumPyramidLevel-e)<0?[2,null]:(a=this._buildCacheFilePath(o,t,i,n.multidimensionalDefinition),s=this._getIndexRecordFromBundle(t,i),[4,this.request({url:a,range:{from:0,to:this.storageInfo.headerSize-1},responseType:"array-buffer"},n.signal)]);case 1:return(l=r.sent())?(u=new Uint8Array(l),0===(f=this._getTileEndAndContentType(u,s)).recordSize?[2,null]:[4,this.request({url:a,range:{from:f.position,to:f.position+f.recordSize},responseType:"array-buffer"},n.signal)]):[2,null];case 2:return(c=r.sent())?[2,this.decodePixelBlock(c,{width:this.rasterInfo.storageInfo.tileInfo.size[0],height:this.rasterInfo.storageInfo.tileInfo.size[1],planes:null,pixelType:null})]:[2,null]}}))}))},t.prototype._validateHeader=function(e){return e&&"RasterInfo"===e.type&&!["origin","extent","geodataXform","LODInfos","blockWidth","blockHeight","bandCount","pixelType","pixelSizeX","pixelSizeY","format","packetSize"].some((function(t){return!e[t]}))},t.prototype._parseHeader=function(e){var t,r,n,o,a=["u1","u2","u4","u8","s8","u16","s16","u32","s32","f32","f64"][e.pixelType],s=e.bandCount,c=e.histograms,p=e.colormap,d=e.blockWidth,h=e.blockHeight,m=e.firstPyramidLevel,y=e.maximumPyramidLevel,g=e.statistics&&e.statistics.map((function(e){return{min:e.min,max:e.max,avg:e.mean,stddev:e.standardDeviation,median:e.median,mode:e.mode}})),x=new i.SpatialReference(e.extent.spatialReference||e.geodataXform.spatialReference),v=new i.Extent({xmin:e.extent.xmin,ymin:e.extent.ymin,xmax:e.extent.xmax,ymax:e.extent.ymax,spatialReference:x}),I=new i.Point({x:e.pixelSizeX,y:e.pixelSizeY,spatialReference:x}),_=e.properties,S=e.format.toLowerCase().replace("cache/",""),b=new i.Point(e.origin.x,e.origin.y,x);if(p&&p.colors)for(t=[],r=0;r<p.colors.length;r++)n=p.colors[r],o=p.values?p.values[r]:r,t.push([o,255&n,n<<16>>>24,n<<8>>>24,n>>>24]);var w=e.LODInfos,T=[];for(r=0;r<w.levels.length;r++)T.push({level:w.levels[r],resolution:w.resolutions[r],scale:96/.0254*w.resolutions[r]});var z=new f({dpi:96,lods:T,format:S,origin:b,size:[d,h],spatialReference:x}),R={recordSize:8,packetSize:e.packetSize,headerSize:e.packetSize*e.packetSize*8+64},k=Math.round((v.xmax-v.xmin)/I.x),C=Math.round((v.ymax-v.ymin)/I.y),F=[{maxCol:Math.ceil(k/d)-1,maxRow:Math.ceil(C/h)-1,minCol:0,minRow:0}],P=2;if(y>0)for(r=0;r<y;r++)F.push({maxCol:Math.ceil(k/P/d)-1,maxRow:Math.ceil(C/P/h)-1,minCol:0,minRow:0}),P*=2;var H=e.mdInfo;return{storageInfo:R,rasterInfo:new l({width:k,height:C,pixelType:a,bandCount:s,extent:v,spatialReference:x,pixelSize:I,keyProperties:_,statistics:g,histograms:c,multidimensionalInfo:H,colormap:t,storageInfo:new u({blockWidth:d,blockHeight:h,pyramidBlockWidth:d,pyramidBlockHeight:h,origin:b,tileInfo:z,firstPyramidLevel:m,maximumPyramidLevel:y,blockBoundary:F})})}},t.prototype._fetchAuxiliaryInformation=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,n,o,s,l,u,f;return r.__generator(this,(function(r){switch(r.label){case 0:return t=this.request({url:this.url+"/conf.vat.json",responseType:"json"},e).then((function(e){return e})).catch((function(){return null})),i=this.request({url:this.url+"/conf.vat.dbf",responseType:"array-buffer"},e).then((function(e){return e})).catch((function(){return null})),[4,a.all([t,i])];case 1:return(n=r.sent())[0]&&(s=n[0].fields,l=n[0].values,s&&l&&(s=s.map((function(e){return{type:"OID"===e.name?"esriFieldTypeOID":h.get(e.type),name:e.name,alias:e.alias||e.name}})),u=l.map((function(e){return{attributes:e}})),s&&l&&(o={fields:s,features:u}))),!o&&n[1]&&(f=p.parse(n[1]),o=f.recordSet),[2,d.fromJSON(o)]}}))}))},t.prototype._buildCacheFilePath=function(e,t,r,i){var n=this.storageInfo.packetSize,o=Math.floor(t/n)*n,a=Math.floor(r/n)*n,s="R"+this._toHexString4(o)+"C"+this._toHexString4(a),l="L";l+=e>=10?e.toString():"0"+e.toString();var u=i&&i[0];if(!u)return this.url+"/_alllayers/"+l+"/"+s+".bundle";for(var f=this.rasterInfo.multidimensionalInfo.variables.filter((function(e){return e.name===u.variableName}))[0].dimensions[0].values.indexOf(u.values[0]).toString(16),c=4-f.length,p=0;p<c;p++)f="0"+f;return f="S"+f,this.url+"/_alllayers/"+u.variableName+"/"+f+"/"+l+"/"+s+".bundle"},t.prototype._getIndexRecordFromBundle=function(e,t){var r=this.storageInfo.packetSize,i=r*(e%r)+t%r;if(i<0)throw"Invalid level / row / col";return 20+i*this.storageInfo.recordSize+44},t.prototype._getTileEndAndContentType=function(e,t){var r,i=e.subarray(t,t+8),n=0;for(r=0;r<5;r++)n|=(255&i[r])<<8*r;var o=0xffffffffff&n;for(n=0,r=5;r<8;r++)n|=(255&i[r])<<8*(r-5);return{position:o,recordSize:0xffffffffff&n}},t.prototype._toHexString4=function(e){var t=e.toString(16);if(4!==t.length)for(var r=4-t.length;r-- >0;)t="0"+t;return t},r.__decorate([s.property({readOnly:!0})],t.prototype,"storageInfo",void 0),r.__decorate([s.property({type:String,json:{write:!0}})],t.prototype,"datasetFormat",void 0),t=r.__decorate([s.subclass("esri.layers.support.rasterDatasets.CloudRaster")],t)}(c)}));