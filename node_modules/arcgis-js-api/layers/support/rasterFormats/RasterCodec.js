// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../core/Error","../PixelBlock","./ImageCanvasDecoder","./JpgPlus","./Lerc2Codec","./LercCodec","./Png","./Raw","./TiffDecoder"],(function(e,t,r,i,a,n,o,s,d,l,c,h){var u,f,p=(u=new ArrayBuffer(4),f=new Uint8Array(u),new Uint32Array(u)[0]=1,1===f[0]);function w(e,t){if(!p)throw new i("rasterCoded:decode","lerc decoder is not supported on big endian platform");for(var r,n,o=t.width,s=t.height,l=t.pixelType,c=D(l),h=c.pixelTypeCtor,u=null==t.noDataValue?c.noDataValue:t.noDataValue,f=0,w=0,g=e.byteLength-10;w<g;){var m=d.decode(e,{inputOffset:w,encodedMaskData:r,returnMask:0===f,returnEncodedMask:0===f,returnFileInfo:!0,pixelType:h,noDataValue:u});if(o&&s&&(m.width!==o||m.height!==s))throw new i("rasterCoded:decode","lerc decoded result has width or height different from specified in options");if(w=m.fileInfo.eofOffset,0===f&&(r=m.encodedMaskData,n=new a({width:m.width,height:m.height,pixels:[],pixelType:l,mask:m.maskData,statistics:[]})),f++,n.addData({pixels:m.pixelData,statistics:{minValue:m.minValue,maxValue:m.maxValue,noDataValue:m.noDataValue}}),g-w>10){var x=String.fromCharCode.apply(null,new Uint8Array(e,w,10));w=w+x.indexOf("CntZ")>-1?x.indexOf("CntZ"):0}}return n}function g(e,t){if(!p)throw new i("rasterCoded:decode","lerc decoder is not supported on big endian platform");for(var r,n,o,d=0,l=0,c=0,h=e.byteLength-10,u=[],f=t.width,w=t.height;l<h;){if(n=s.decode(e,{inputOffset:l,maskData:r,returnFileInfo:!0}),f&&w&&(n.width!==f||n.height!==w))throw new i("rasterCoded:decode","lerc2 decoded result has width or height different from what's specified in options");if(l=n.fileInfo.eofOffset,0===d&&(c=n.fileInfo.numValidPixel,r=n.maskData,o=new a({width:n.width,height:n.height,pixels:[],pixelType:n.fileInfo.pixelType,mask:n.maskData,statistics:[]})),n.fileInfo.mask&&n.fileInfo.mask.numBytes>0&&u.push(n.maskData),d++,o.addData({pixels:n.pixelData,statistics:{minValue:n.minValue,maxValue:n.maxValue}}),h-l>10){var g=String.fromCharCode.apply(null,new Uint8Array(e,l,10));l+=g.indexOf("Lerc")>-1?g.indexOf("Lerc"):0}}var m=0,x=0,y=0;if(u.length>1){for(y=o.width*o.height,(r=new Uint8Array(y)).set(u[0]),m=1;m<u.length;m++){var k=u[m];for(x=0;x<y;x++)r[x]=r[x]&k[x]}for(c=0,x=0;x<y;x++)c+=r[x];o.mask=r}return o.validPixelCount=c,o}function m(e){var t=h.decode(e),r=new a({width:t.width,height:t.height,pixels:t.pixels,pixelType:t.pixelType.toLowerCase(),mask:t.mask,statistics:null});return r.updateStatistics(),r}function x(e,t){var r=h.decodeTileOrStrip(e,t.customOptions),i=new a({width:r.width,height:r.height,pixels:r.pixels,pixelType:r.pixelType.toLowerCase(),mask:r.mask,statistics:null});return i.updateStatistics(),i}function y(e){var t=o.decode(e),r=new a({width:t.width,height:t.height,pixels:t.pixels,pixelType:"U8",mask:t.mask,statistics:null});return r.updateStatistics(),r}function k(e,t){var r,i=new Uint8Array(e),n=new l(i),o=t.width,s=t.height,d=o*s,c=n.decode(),h=0,u=0,f=new Uint8Array(d);for(h=0;h<d;h++)f[h]=c[4*h+3];var p=new a({width:o,height:s,pixels:[],pixelType:"U8",mask:f,statistics:[]});for(h=0;h<3;h++){for(r=new Uint8Array(d),u=0;u<d;u++)r[u]=c[4*u+h];p.addData({pixels:r})}return p.updateStatistics(),p}function C(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var o,s,d,l;return r.__generator(this,(function(c){switch(c.label){case 0:return o=new n,s=r.__assign({applyJpegMask:!1},t),[4,o.decode(e,s,i)];case 1:return d=c.sent(),(l=new a(d)).updateStatistics(),[2,l]}}))}))}function v(e){if(null==e)throw new i("rasterCodec:decode","parameter encodeddata is required.");var t=new Uint8Array(e,0,10),r="";return 255===t[0]&&216===t[1]?r="jpg":137===t[0]&&80===t[1]&&78===t[2]&&71===t[3]?r="png":67===t[0]&&110===t[1]&&116===t[2]&&90===t[3]&&73===t[4]&&109===t[5]&&97===t[6]&&103===t[7]&&101===t[8]&&32===t[9]?r="lerc":76===t[0]&&101===t[1]&&114===t[2]&&99===t[3]&&50===t[4]&&32===t[5]?r="lerc2":73===t[0]&&73===t[1]&&42===t[2]&&0===t[3]||77===t[0]&&77===t[1]&&0===t[2]&&42===t[3]?r="tiff":String.fromCharCode.apply(null,t).toLowerCase().indexOf("error")>-1&&(r="error"),r}function b(e){var t=null;switch(e){case"lerc":t=w;break;case"lerc2":t=g;break;case"jpg":t=y;break;case"png":t=k;break;case"bsq":case"bip":t=function(t,r){return function(e,t,r){var i=D(t.pixelType).pixelTypeCtor,n=(0,c.decode)(e,{width:t.width,height:t.height,pixelType:i,format:r}),o=new a({width:t.width,height:t.height,pixels:n.pixels,pixelType:t.pixelType,mask:n.mask,statistics:null});return o.updateStatistics(),o}(t,r,e)};break;case"tiff":t=m;break;case"error":t=function(){throw new i("rasterCodec:decode","input data contains error")};break;default:t=function(){throw new i("rasterCodec:decode","unsupported raster format")}}return t}function D(e){var t=null,r=null;switch(e?e.toLowerCase():"f32"){case"u1":case"u2":case"u4":case"u8":r=Math.pow(2,8)-1,t=Uint8Array;break;case"u16":r=r||Math.pow(2,16)-1,t=Uint16Array;break;case"u32":r=r||Math.pow(2,32)-1,t=Uint32Array;break;case"s8":r=r||0-Math.pow(2,7),t=Int8Array;break;case"s16":r=r||0-Math.pow(2,15),t=Int16Array;break;case"s32":r=r||0-Math.pow(2,31),t=Int32Array;break;default:t=Float32Array}return{pixelTypeCtor:t,noDataValue:r}}return function(){function e(){}return e.getFormat=function(e){var t=v(e);return"lerc2"===t?t="lerc":"error"===t&&(t=""),t},e.decode=function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var o,s,d;return r.__generator(this,(function(l){switch(l.label){case 0:if(null==e)throw new i("rasterCodec:decode","missing encodeddata parameter.");if(null==t||null==t.width||null==t.height)throw new i("rasterCodec:decode","requires width and height in options parameter.");return"tiff"===(o=t.format&&t.format.toLowerCase())&&t.customOptions?[2,x(e,t)]:((!o||"bsq"!==o&&"bip"!==o)&&(o=v(e)),!t.useCanvas||"jpg"!==o&&"png"!==o?[3,2]:[4,C(e,t,n)]);case 1:return d=l.sent(),[3,3];case 2:s=b(o),t.isPoint&&((t=r.__assign({},t)).width++,t.height++),d=s(e,t),t.isPoint&&function(e,t){if(void 0===t&&(t=1),e){var r=e.pixels,i=e.width,n=e.height,o=e.mask;if(r&&0!==r.length){var s,d,l,c,h,u,f,p=r.length,w=i-1,g=n-1,m=[],x=a.getPixelArrayConstructor(e.pixelType);if(0===t){for(s=0;s<p;s++){for(h=r[s],u=new x(w*g),d=0;d<g;d++)for(c=d*i,l=0;l<w;l++)u[d*w+l]=h[c+l];m.push(u)}if(o)for(f=new Uint8Array(w*g),d=0;d<g;d++)for(c=d*i,l=0;l<w;l++)f[d*w+l]=o[c+l]}else{for(s=0;s<p;s++){for(h=r[s],u=new x(w*g),d=0;d<g;d++)for(c=d*i,l=0;l<w;l++)u[d*w+l]=(h[c+l]+h[c+l+1]+h[c+i+l]+h[c+i+l+1])/4;m.push(u)}if(o)for(f=new Uint8Array(w*g),d=0;d<g;d++)for(c=d*i,l=0;l<w;l++)f[d*w+l]=Math.min.apply(null,[o[c+l],o[c+l+1],o[c+i+l],o[c+i+l+1]])}e.width=w,e.height=g,e.mask=f,e.pixels=m}}}(d),l.label=3;case 3:return[2,d]}}))}))},e}()}));