// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../rasterRenderers","../../core/arrayUtils","../../core/lang","./RasterFunction","../../renderers/support/colorRampUtils","../../renderers/support/stretchRendererUtils","../../tasks/support/MultipartColorRamp"],(function(e,r,t,a,n,o,i,u,l){Object.defineProperty(r,"__esModule",{value:!0});var s={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767]},m={type:"multipart",colorRamps:[{fromColor:[0,0,255],toColor:[0,255,255]},{fromColor:[0,255,255],toColor:[255,255,0]},{fromColor:[255,255,0],toColor:[255,0,0]}]},c=l.fromJSON(i.PREDEFINED_JSON_COLOR_RAMPS[0]);r.isSupportedRendererType=function(e){return["raster-stretch","unique-value","class-breaks","raster-shaded-relief"].indexOf(e.type)>-1},r.combineRenderingRules=function(e,r){if(!e||!r)return n.clone(e||r);var t=n.clone(e);return"none"!==r.functionName.toLowerCase()&&((function e(r){var t=r.Raster;if(t&&"esri.layers.support.RasterFunction"===t.declaredClass)return e(t.functionArguments);return r}(t.functionArguments)).Raster=r),t},r.convertRendererToRenderingRule=function(e,r){switch(r=r||{},e.type){case"raster-stretch":return function(e,r){var t=new o;t.functionName="Stretch";var a=f[u.stretchTypeJSONDict.toJSON(e.stretchType)],n=function(e){var r=[];return e.forEach((function(e){var t=e;if(Array.isArray(t))r.push(t);else{if(null==t.min||null==t.max)return;var a=[t.min,t.max,t.avg||0,t.stddev||0];r.push(a)}})),r}(e.statistics),l={StretchType:a,Statistics:n,DRA:e.dynamicRangeAdjustment,UseGamma:e.useGamma,Gamma:e.gamma,ComputeGamma:e.computeGamma};null!=e.outputMin&&(l.Min=e.outputMin);null!=e.outputMax&&(l.Max=e.outputMax);a===f.standardDeviation?(l.NumberOfStandardDeviations=e.numberOfStandardDeviations,t.outputPixelType="u8"):a===f.percentClip?(l.MinPercent=e.minPercent,l.MaxPercent=e.maxPercent,t.outputPixelType="u8"):a===f.minMax?t.outputPixelType="u8":a===f.sigmoid&&(l.SigmoidStrengthLevel=e.sigmoidStrengthLevel);if(t.functionArguments=l,t.variableName="Raster",e.colorRamp){var s=e.colorRamp,m=new o,c=i.getColorRampName(s);return c?m.functionArguments={colorRamp:c}:!r.convertColorRampToColormap||"algorithmic"!==s.type&&"multipart"!==s.type?m.functionArguments={colorRamp:e.colorRamp.toJSON()}:m.functionArguments={Colormap:i.convertColorRampToColormap(s,256)},m.variableName="Raster",m.functionName="Colormap",m.functionArguments.Raster=t,m}return t}(e,r);case"class-breaks":return function(e,r){var t=[],a=[],n=[],i=[],u=r.pixelType,l=r.rasterAttributeTable,s=l&&l.features,m=d(l);if(s&&Array.isArray(s)&&e.classBreakInfos){e.classBreakInfos.forEach((function(r,t){var a,n=r.symbol.color;n.a&&s.forEach((function(o){((a=o.attributes[e.field])>=r.minValue&&a<r.maxValue||t===e.classBreakInfos.length-1&&a>=r.minValue)&&i.push([o.attributes[m],n.r,n.g,n.b])}))}));var c=u?p(i,u):i,f=new o;return f.functionName="Colormap",f.functionArguments={},f.functionArguments.Colormap=c,f.variableName="Raster",f}e.classBreakInfos.forEach((function(e,r){var o=e.symbol&&e.symbol.color;o.a?(0===r?t.push(e.minValue,e.maxValue+1e-6):t.push(e.minValue+1e-6,e.maxValue+1e-6),a.push(r),i.push([r,o.r,o.g,o.b])):n.push(e.minValue,e.maxValue)}));var v=u?p(i,u):i,g=new o;g.functionName="Remap",g.functionArguments={InputRanges:t,OutputValues:a,NoDataRanges:n},g.variableName="Raster";var h=new o;return h.functionName="Colormap",h.functionArguments={Colormap:v,Raster:g},h}(e,r);case"unique-value":return function(e,r){var t=[],a=r.pixelType,n=r.rasterAttributeTable,i=n&&n.features,u=d(n),l=!1;e.uniqueValueInfos&&e.uniqueValueInfos.forEach((function(r){var a=r.symbol.color;a.a&&(e.field!==u&&i?i&&i.forEach((function(n){String(n.attributes[e.field])===String(r.value)&&t.push([n.attributes[u],a.r,a.g,a.b])})):isNaN(r.value)?l=!0:t.push([r.value,a.r,a.g,a.b]))}));if(l)return null;var s=a&&t.length>0?p(t,a):t,m=new o;return m.functionName="Colormap",m.functionArguments={},m.functionArguments.Colormap=s,m.variableName="Raster",m}(e,r);case"raster-colormap":return function(e,r){var t=e.extractColormap();if(!t||0===t.length)return;var a=r.pixelType,n=a?p(t,a):t,i=new o;return i.functionName="Colormap",i.functionArguments={},i.functionArguments.Colormap=n,i}(e,r);case"raster-shaded-relief":return function(e,r){if("elevation"!==r.dataType)return new o;var t=new o;t.functionName="Hillshade";var a="traditional"===e.hillshadeType?0:1,n="none"===e.scalingType?1:3,u={HillshadeType:a,SlopeType:n,ZFactor:e.zFactor};0===a&&(u.Azimuth=e.azimuth,u.Altitude=e.altitude);3===n&&(u.PSPower=e.pixelSizePower,u.PSZFactor=e.pixelSizeFactor);t.functionArguments=u,t.variableName="Raster",e.colorRamp&&(t.functionName="ShadedRelief",u.Colormap=i.convertColorRampToColormap(e.colorRamp,256));return t}(e,r)}},r.createDefaultRenderer=function(e,r){if(e){var a,n,o,u,l,s,f,p=e.attributeTable,d=e.dataType,v=e.bandCount,g=e.pixelType,h=e.colormap,C=e.statistics,R=e.histograms;if(r&&r.length>0&&(C=C?r.map((function(e){return C[e]})):null,R=R?r.map((function(e){return R[e]})):null),p&&(n=p.fields.filter((function(e){return"red"===e.name.toLowerCase()}))[0],o=p.fields.filter((function(e){return"green"===e.name.toLowerCase()}))[0],u=p.fields.filter((function(e){return"blue"===e.name.toLowerCase()}))[0],s=p.fields.filter((function(e){return"value"===e.name.toLowerCase()}))[0],(l=p.fields.filter((function(e){return"classname"===e.name.toLowerCase()||"class_name"===e.name.toLowerCase()}))[0])||(l=p.fields.filter((function(e){return"string"===e.type}))[0])||(l=s)),1===v&&(null==h?void 0:h.length)>0)p&&n&&o&&u&&(f={},p.features.forEach((function(e){var r=e.attributes;f[r[s.name]]=l?r[l.name]:r[s.name]}))),a=t.RasterColormapRenderer.createFromColormap(h,f);else if(1===v&&p){var b=void 0,y=p.features;if(n&&o&&u&&l)b=y.map((function(e){return{value:e.attributes[l.name],label:e.attributes[l.name],symbol:{type:"esriSFS",style:"esriSFSSolid",color:[e.attributes[n.name],e.attributes[o.name],e.attributes[u.name],255]}}}));else{var N=i.convertColorRampToColormap(c,y.length);b=y.map((function(e,r){return{value:e.attributes[s.name],label:e.attributes[s.name],symbol:{color:N[r].slice(1,4),type:"esriSFS",style:"esriSFSSolid"}}}))}b.sort((function(e,r){return e.value>r.value?1:-1})),a=t.UniqueValueRenderer.fromJSON({field1:l.name,uniqueValueInfos:b})}if(!a){var S=void 0,x=!1,A=void 0,T=void 0,w=void 0;"u8"===g&&"processed"===d?(S="none",C=1===v?[{min:0,max:255}]:[{min:0,max:255},{min:0,max:255},{min:0,max:255}]):"u8"===g||"elevation"===d?(S="min-max",x=!C):"scientific"===d?(S="min-max",x=!C,A=m):R&&R.length>0?(S="percent-clip",w=T=.25):C?S="min-max":(S="percent-clip",x=!0),a=t.RasterStretchRenderer.fromJSON({stretchType:S,dra:x,colorRamp:A,min:0,max:255,statistics:x?null:C,histograms:x?null:R,maxPercent:T,minPercent:w})}return a}},r.getDefaultBandCombination=function(e){var r=e.bandCount;if(1===r)return null;if(2===r)return[0];var t,a,n,o,i,u=e.keyProperties&&e.keyProperties.BandProperties;if(u&&u.length===r){for(var l=0;l<u.length;l++)u[l].BandName&&"red"===u[l].BandName.toLowerCase()&&(a=l),u[l].BandName&&"green"===u[l].BandName.toLowerCase()&&(n=l),u[l].BandName&&"blue"===u[l].BandName.toLowerCase()&&(o=l),u[l].BandName&&"nearinfrared"===u[l].BandName.toLowerCase()&&(i=l);void 0!==a&&void 0!==n&&void 0!==o?t=[a,n,o]:void 0!==a&&void 0!==n&&void 0!==i&&(t=[i,a,n])}return!t&&r>3&&(t=[0,1,2]),t};var f={none:0,standardDeviation:3,histogramEqualization:4,minMax:5,percentClip:6,sigmoid:9};function p(e,r){var t=s[String(r).toLowerCase()];return t&&e.push([Math.floor(t[0]-1),0,0,0],[Math.ceil(t[1]+1),0,0,0]),e}function d(e){if(e){var r=e.fields,t=r&&a.find(r,(function(e){return e&&e.name&&"value"===e.name.toLowerCase()}));return t&&t.name}}}));