// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../core/CircularArray","../core/maybe","./geohashUtils"],(function(t,e,i,a,o){Object.defineProperty(e,"__esModule",{value:!0});var s=function(){function t(t){this._pool=new i.default(8024),this._nodes=0,this._root=new n(0,0,0),this._fields=t}return t.prototype._acquire=function(t,e,i){var o=this._pool.dequeue();return this._nodes++,a.isSome(o)?o.realloc(t,e,i):new n(t,e,i)},t.prototype._release=function(t){this._nodes--,this._pool.enqueue(t)},Object.defineProperty(t.prototype,"count",{get:function(){return this._root.count},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._nodes},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"poolSize",{get:function(){return this._pool.size},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"depth",{get:function(){var t=0;return this._forEachNode((function(e){return t=Math.max(t,e.depth)})),t},enumerable:!0,configurable:!0}),t.prototype.dropLevels=function(t){var e=this;this._forEachNode((function(i){if(i.depth>=t)for(var a=0;a<i.children.length;a++){var o=i.children[a];i.children[a]=null,o&&e._release(o)}}))},t.prototype.insert=function(t,e,i){void 0===i&&(i=0);for(var a=this._root,o=0,s=0,n=0;null!==a;){if(a.depth>=i&&(a.count+=1,a.xTotal+=t.geometry.coords[0],a.yTotal+=t.geometry.coords[1],a.xGeohashTotal+=t.geohashX,a.yGeohashTotal+=t.geohashY,this._updateStatistics(t,a,1)),o>=e)return;var r=Math.ceil((o+1)/2),h=Math.floor((o+1)/2),l=1-o%2,c=30-(3*r+2*h),u=30-(2*r+3*h),d=7*l+3*(1-l)<<c,f=3*l+7*(1-l)<<u,p=8*l+4*(1-l),v=(t.geohashX&d)>>c,y=(t.geohashY&f)>>u,g=v+y*p;s=s<<3*l+2*(1-l)|v,n=n<<2*l+3*(1-l)|y,null==a.children[g]&&(a.children[g]=this._acquire(s,n,o+1)),o+=1,a=a.children[g]}},t.prototype.remove=function(t,e){for(var i=this._root,a=0;null!==i;){if(i.count-=1,i.xTotal-=t.geometry.coords[0],i.yTotal-=t.geometry.coords[1],i.xGeohashTotal-=t.geohashX,i.yGeohashTotal-=t.geohashY,this._updateStatistics(t,i,-1),a>=e)return;var o=Math.ceil((a+1)/2),s=Math.floor((a+1)/2),n=1-a%2,r=30-(3*o+2*s),h=30-(2*o+3*s),l=7*n+3*(1-n)<<r,c=3*n+7*(1-n)<<h,u=8*n+4*(1-n),d=((t.geohashX&l)>>r)+((t.geohashY&c)>>h)*u,f=i.children[d];1===f.count&&(this._release(f),i.children[d]=null),a+=1,i=f}},t.prototype.find=function(t,e,i){return this._root.find(t,e,i,0,0,0)},t.prototype.findSingleOccupancyNode=function(t,e,i,a,o){for(var s=this._root;null!==s;){var n=s.depth,r=s.xNode,h=s.yNode,l=1-n%2,c=s.xGeohashTotal/s.count,u=s.yGeohashTotal/s.count;if(1===s.count&&t<c&&c<=i&&e<u&&u<=a)return s;if(n>=o)s=s.next;else{for(var d=Math.ceil((n+1)/2),f=Math.floor((n+1)/2),p=30-(3*d+2*f),v=30-(2*d+3*f),y=~((1<<p)-1),g=~((1<<v)-1),x=(t&y)>>p,_=(e&g)>>v,m=(i&y)>>p,b=(a&g)>>v,T=r<<3*l+2*(1-l),N=h<<2*l+3*(1-l),S=T+8*l+4*(1-l),M=N+4*l+8*(1-l),k=Math.max(T,x),G=Math.max(N,_),C=Math.min(S,m),z=Math.min(M,b),F=null,w=null,P=G;P<=z;P++)for(var O=k;O<=C;O++){var X=O-T+(P-N)*(8*l+4*(1-l)),Y=s.children[X];Y&&(F||((F=Y).next=s.next),w&&(w.next=Y),w=Y,Y.next=s.next)}s=F||s.next}}return null},t.prototype.getRegionStatistics=function(t,e,i,a,o){for(var s=this._root,n=0,r=0,h=0,l={};null!==s;){var c=s.depth,u=s.xNode,d=s.yNode;if(c>=o){var f=s.xGeohashTotal/s.count,p=s.yGeohashTotal/s.count;t<f&&f<=i&&e<p&&p<=a&&(n+=s.count,r+=s.xTotal,h+=s.yTotal,this._aggregateStatistics(l,s.statistics)),s=s.next}else{for(var v=Math.ceil((c+1)/2),y=Math.floor((c+1)/2),g=1-c%2,x=30-(3*v+2*y),_=30-(2*v+3*y),m=~((1<<x)-1),b=~((1<<_)-1),T=(t&m)>>x,N=(e&b)>>_,S=(i&m)>>x,M=(a&b)>>_,k=u<<3*g+2*(1-g),G=d<<2*g+3*(1-g),C=k+8*g+4*(1-g),z=G+4*g+8*(1-g),F=Math.max(k,T),w=Math.max(G,N),P=Math.min(C,S),O=Math.min(z,M),X=null,Y=null,j=w;j<=O;j++)for(var q=F;q<=P;q++){var E=q-k+(j-G)*(8*g+4*(1-g)),L=s.children[E];if(L){if(j!==w&&j!==O&&q!==F&&q!==P){f=L.xGeohashTotal/L.count,p=L.yGeohashTotal/L.count;t<f&&f<=i&&e<p&&p<=a&&(n+=L.count,r+=L.xTotal,h+=L.yTotal,this._aggregateStatistics(l,L.statistics));continue}X||((X=L).next=s.next),Y&&(Y.next=L),Y=L,L.next=s.next}}s=X||s.next}}return{count:n,attributes:this._normalizeStatistics(l,n),xTotal:r,yTotal:h}},t.prototype._forEachNode=function(t){for(var e=this._root;null!==e;){var i=this._linkChildren(e)||e.next;t(e),e=i}},t.prototype._linkChildren=function(t){for(var e=null,i=null,a=0;a<=t.children.length;a++){var o=t.children[a];o&&(e||((e=o).next=t.next),i&&(i.next=o),i=o,o.next=t.next)}return e},t.prototype._updateStatistics=function(t,e,i){for(var a=0,o=this._fields;a<o.length;a++){var s=o[a],n=s.name,r=s.outStatistic.onStatisticField,h=t.attributes[r];switch(s.outStatistic.statisticType){case"norm":e.statistics[n]||(e.statistics[n]={});var l=s.outStatistic.onStatisticNormalizationField,c=t.attributes[l],u=e.statistics[n].onStatisticField||0,d=e.statistics[n].onStatisticNormalizationField||0;null==h||isNaN(h)||null==c||0===c||isNaN(c)||(e.statistics[n].onStatisticField=u+i*h,e.statistics[n].onStatisticNormalizationField=d+i*c);break;case"sum":case"avg":e.statistics[n]||(e.statistics[n]={value:0,nanCount:0});var f=e.statistics[n].value,p=e.statistics[n].nanCount;null==h||isNaN(h)?e.statistics[n].nanCount=p+i:e.statistics[n].value=f+i*h;break;case"avg_angle":e.statistics[n]||(e.statistics[n]={x:0,y:0,nanCount:0});var v=e.statistics[n].x,y=e.statistics[n].y,g=(p=e.statistics[n].nanCount,Math.PI/180);null==h||isNaN(h)?e.statistics[n].nanCount=p+i:(e.statistics[n].x=v+i*Math.cos(h*g),e.statistics[n].y=y+i*Math.sin(h*g));break;case"mode":e.statistics[n]||(e.statistics[n]={});f=e.statistics[n][h]||0;e.statistics[n][h]=f+i}}},t.prototype._aggregateStatistics=function(t,e){for(var i=0,a=this._fields;i<a.length;i++){var o=a[i],s=o.name;switch(o.outStatistic.statisticType){case"sum":case"avg":case"avg_angle":case"mode":case"norm":for(var n in t[s]||(t[s]={}),e[s]){var r=t[s][n]||0;t[s][n]=r+e[s][n]}}}},t.prototype._normalizeStatistics=function(t,e){for(var i={},a=0,o=this._fields;a<o.length;a++){var s=o[a],n=s.name;switch(s.outStatistic.statisticType){case"norm":var r=t[n];if(e&&null==r.onStatisticNormalizationField)break;if(e&&r.onStatisticNormalizationField){i[n]=r.onStatisticField/r.onStatisticNormalizationField;break}i[n]=0;break;case"sum":if(!e)break;var h=t[n],l=h.value;if(!(e-(u=h.nanCount)))break;i[n]=l;break;case"avg":if(!e)break;var c=t[n];l=c.value;if(!(e-(u=c.nanCount)))break;i[n]=l/(e-u);break;case"avg_angle":if(!e)break;var u,d=t[n],f=d.x,p=d.y;if(!(e-(u=d.nanCount)))break;var v=f/(e-u),y=p/(e-u),g=180/Math.PI,x=Math.atan2(y,v)*g;i[n]=x;break;case"mode":var _=t[n],m=0,b=null;for(var T in _){var N=_[T];N>m&&(m=N,b=T)}i[n]="null"===b?null:b}}return i},t}();e.GeohashTree=s;var n=function(){function t(t,e,i){this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this.children=new Array(32);for(var a=0;a<this.children.length;a++)this.children[a]=null;this.xNode=t,this.yNode=e,this.depth=i}return t.prototype.realloc=function(t,e,i){for(var a=0;a<this.children.length;a++)this.children[a]=null;return this.xNode=t,this.yNode=e,this.depth=i,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this},t.prototype.getLngLatBounds=function(){var t=this.depth,e=Math.ceil(t/2),i=Math.floor(t/2),a=30-(3*e+2*i),s=30-(2*e+3*i),n=this.xNode<<a,r=this.yNode<<s;return o.decodeGeohashXY({geohashX:n,geohashY:r},this.depth)},t.prototype.find=function(t,e,i,a,o,s){if(a>=i)return this;var n=1-a%2,r=3*n+2*(1-n),h=2*n+3*(1-n),l=30-o-r,c=30-s-h,u=((t&7*n+3*(1-n)<<l)>>l)+((e&3*n+7*(1-n)<<c)>>c)*(8*n+4*(1-n)),d=this.children[u];return null==d?null:d.find(t,e,i,a+1,o+r,s+h)},t}()}));