// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../Color","../request","../core/Error","../core/lang","../core/Logger","../core/LRUCache","../core/maybe","../core/promiseUtils","../core/SetUtils","../core/string","../core/accessorSupport/decorators","../layers/support/fieldUtils","./Renderer","./mixins/VisualVariablesMixin","../support/arcadeOnDemand","../symbols/CIMSymbol"],(function(e,t,r,i,s,n,o,a,l,u,c,p,h,f,y,d,m,_,b){var g=a.getLogger("esri.renderers.DictionaryRenderer");return function(e){function t(t){var r=e.call(this,t)||this;return r._ongoingRequests=new Map,r._symbolCache=new l(100),r.config=null,r.description=null,r.fieldMap=null,r.label=null,r.scaleExpression=null,r.url=null,r.type="dictionary",r}var a;return r.__extends(t,e),a=t,t.prototype.clone=function(){return new a({config:o.clone(this.config),scaleExpression:o.clone(this.scaleExpression),description:o.clone(this.description),fieldMap:o.clone(this.fieldMap),label:o.clone(this.label),url:o.clone(this.url),visualVariables:o.clone(this.visualVariables)})},t.prototype.getSymbolAsync=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var s,n,o,a,l,u,p,f,y,d,m,_,b,g,v,S,w,R,M,x,j,q,C,O,P,N,V=this;return r.__generator(this,(function(r){switch(r.label){case 0:this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(t)),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this._dictionaryPromise];case 2:return s=r.sent(),[3,4];case 3:return n=r.sent(),c.isAbortError(n)?(this._dictionaryPromise=null,[2,null]):[3,4];case 4:for(o={},a=0,l=this._symbolAttributes;a<l.length;a++)u=l[a],(p=this.fieldMap[u])&&null!==e.attributes[p]&&void 0!==e.attributes[p]?(f=""+e.attributes[p],o[u]=f):o[u]="";if(!(y=s(o,t))||"string"!=typeof y)return[2,null];if(d=h.numericHash(y).toString(),m=this._symbolCache.get(d))return m.catch((function(){V._symbolCache.pop(d)})),[2,m];for(_=y.split(";"),b=[],g=[],v=0,S=_;v<S.length;v++)if((w=S[v])&&0!==w.length)if(-1===w.indexOf("po:"))if(-1!==w.indexOf("|"))for(C=0,O=w.split("|");C<O.length;C++)P=O[C],this._itemNames.has(P)&&b.push(P);else this._itemNames.has(w)&&b.push(w);else 3===(R=w.substr(3).split("|")).length&&(M=R[0],x=R[1],j=R[2],"DashTemplate"===x?j=j.split(" ").map((function(e){return Number(e)})):"Color"===x?(q=new i(j).toRgba(),j=[q[0],q[1],q[2],255*q[3]]):j=Number(j),g.push({primitiveName:M,propertyName:x,value:j}));return N=this._cimPartsToCIMSymbol(b,g,t),this._symbolCache.put(d,N,1),[2,N]}}))}))},t.prototype.collectRequiredFields=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,s;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.collectVVRequiredFields(e,t)];case 1:return r.sent(),this.scaleExpression?[4,y.collectArcadeFieldNames(e,t,this.scaleExpression)]:[3,3];case 2:r.sent(),r.label=3;case 3:for(s in i=t.map((function(e){return e.name})),this.fieldMap)i.indexOf(this.fieldMap[s])<0||e.add(this.fieldMap[s]);return[2]}}))}))},Object.defineProperty(t.prototype,"arcadeRequired",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.fetchResources=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,o,a,l,h,f,y,d,m,b,v,S,w,R,M,x;return r.__generator(this,(function(j){switch(j.label){case 0:return this.url?(t=u.isSome(e)?e.abortOptions:null,i=s(this.url+"/resources/styles/dictionary-info.json",r.__assign({responseType:"json",query:{f:"json"}},t)),[4,c.all([i,_.loadArcade()])]):(g.error("no valid URL!"),[2,void 0]);case 1:if(!(o=j.sent()[0].data))throw new n("esri.renderers.DictionaryRenderer","Bad dictionary data!");if(a=o.expression,l=o.authoringInfo,this._refSymbolUrlTemplate=this.url+"/"+o.cimRefTemplateUrl,this._itemNames=p.SetFromValues(o.itemsNames),this._symbolAttributes=l.symbol,h={},this.config)for(R in f=this.config)h[R]=f[R];for(y=0,d=l.configuration;y<d.length;y++)R=d[y],h.hasOwnProperty(R.name)||(h[R.name]=R.value);if(m=[],u.isSome(e)&&e.fields)for(b=function(t){var i=v.fieldMap[t],s=e.fields.filter((function(e){return e.name===i}));s.length>0&&m.push(r.__assign(r.__assign({},s[0]),{name:t}))},v=this,S=0,w=this._symbolAttributes;S<w.length;S++)R=w[S],b(R);return[4,_.createDictionaryExpression(a,u.isSome(e)?e.spatialReference:null,m,h)];case 2:return M=j.sent(),x={scale:0},[2,function(e,t){var r=M.repurposeFeature({geometry:null,attributes:e});return x.scale=u.isSome(t)?t.scale:void 0,M.evaluate({$feature:r,$view:x})}]}}))}))},t.prototype.getSymbol=function(){return null},t.prototype.getSymbols=function(){return[]},t.prototype.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce((function(e,t){return e+t.getAttributeHash()}),"")},t.prototype.getMeshHash=function(){return this.url+"-"+JSON.stringify(this.fieldMap)},t.prototype._getSymbolPart=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n,o;return r.__generator(this,(function(a){switch(a.label){case 0:if(this._ongoingRequests.has(e))return[2,this._ongoingRequests.get(e).then((function(e){return e.data}))];i=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,e),n=s(i,r.__assign({responseType:"json",query:{f:"json"}},t)),this._ongoingRequests.set(e,n),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,n];case 2:return[2,a.sent().data];case 3:return o=a.sent(),this._ongoingRequests.delete(e),[2,c.reject(o)];case 4:return[2]}}))}))},t.prototype._combineSymbolParts=function(e,t){var i;if(!e||0===e.length)return null;if(1===e.length)return{type:"CIMSymbolReference",symbol:e[0],primitiveOverrides:t};var s=r.__assign({},e[0]);s.symbolLayers=[];for(var n=0,o=e;n<o.length;n++){var a=o[n];(i=s.symbolLayers).unshift.apply(i,a.symbolLayers)}return{type:"CIMSymbolReference",symbol:s,primitiveOverrides:t}},t.prototype._cimPartsToCIMSymbol=function(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var s,n,o;return r.__generator(this,(function(r){switch(r.label){case 0:for(s=new Array(e.length),n=0;n<e.length;n++)s[n]=this._getSymbolPart(e[n],i);return[4,c.all(s)];case 1:return o=r.sent(),[2,new b({data:this._combineSymbolParts(o,t)})]}}))}))},r.__decorate([f.property({type:Object,json:{write:!0}})],t.prototype,"config",void 0),r.__decorate([f.property({type:String,json:{write:!0}})],t.prototype,"description",void 0),r.__decorate([f.property({type:Object,json:{write:!0}})],t.prototype,"fieldMap",void 0),r.__decorate([f.property({type:String,json:{write:!0}})],t.prototype,"label",void 0),r.__decorate([f.property({type:String,json:{write:!0}})],t.prototype,"scaleExpression",void 0),r.__decorate([f.property({type:String,json:{write:!0}})],t.prototype,"url",void 0),t=a=r.__decorate([f.subclass("esri.renderers.DictionaryRenderer")],t)}(m.VisualVariablesMixin(d))}));