// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../rasterRenderers","../../core/colorUtils","../../core/JSONSupport","../../core/Logger","../../core/accessorSupport/decorators","../../layers/support/RasterInfo","../../layers/support/rasterFunctions/pixelUtils","../../layers/support/rasterFunctions/surfaceUtils","../support/colorRampUtils"],(function(e,r,t,o,s,a,n,i,l,u,p,c){var h=n.getLogger("esri.renderers.support.RasterSymbolizer");return function(e){function r(r){return e.call(this,r)||this}return t.__extends(r,e),r.prototype.readRenderer=function(e,r,t){return o.read(e,t)},r.prototype.bind=function(){if(!this.renderer)return!1;var e;switch(this.lookup={rendererJson:{}},this.renderer.type){case"unique-value":e=this._updateUVRenderer(this.renderer);break;case"raster-colormap":e=this._updateColormapRenderer(this.renderer);break;case"raster-stretch":e=this._updateStretchRenderer(this.renderer);break;case"class-breaks":e=this._updateClassBreaksRenderer(this.renderer);break;case"raster-shaded-relief":e=this._updateShadedReliefRenderer(this.renderer)}return e},r.prototype.symbolize=function(e){var r=e&&e.pixelBlock;if(!this.isValidPixelBlock(r))return r;if(e.simpleStretchParams&&"raster-stretch"===this.renderer.type)return this.simpleStretch(r,e.simpleStretchParams);try{r.pixels.length>3&&(r=u.extractBands(r,[0,1,2]));var t=void 0;switch(this.renderer.type){case"unique-value":case"raster-colormap":t=this._symbolize_colormap(r);break;case"class-breaks":t=this._symbolize_classBreaks(r);break;case"raster-stretch":t=this._symbolize_stretch(r,e.bandIds);break;case"raster-shaded-relief":var o=e.extent,s=o.spatialReference.isGeographic,a={x:(o.xmax-o.xmin)/r.width,y:(o.ymax-o.ymin)/r.height};t=this._symbolize_shadedRelief(r,{isGCS:s,resolution:a})}return t}catch(e){return h.error("symbolize",e.message),r}},r.prototype.simpleStretch=function(e,r){if(!this.isValidPixelBlock(e))return e;try{return e.pixels.length>3&&(e=u.extractBands(e,[0,1,2])),u.stretch(e,r)}catch(r){return h.error("symbolize",r.message),e}},r.prototype.generateWebGLParameters=function(e){if(["unique-value","raster-colormap","class-breaks"].indexOf(this.renderer.type)>-1){var r=this.lookup.colormapLut;return{colormap:r.indexedColormap,colormapOffset:r.offset,type:"lut"}}var t=e.pixelBlock,o=e.isGCS,s=e.resolution,a=e.bandIds;return"raster-stretch"===this.renderer.type?this.generateStretchWebGLParams(t,this.renderer,a):"raster-shaded-relief"===this.renderer.type?this.generateShadedReliefWebGLParams(this.renderer,o,s):null},r.prototype._isLUTChanged=function(e){if(!this.lookup||!this.lookup.rendererJson)return!0;if("colorRamp"in this.renderer){var r=this.renderer.colorRamp;if(e)return JSON.stringify(r.toJSON())!==JSON.stringify(this.lookup.rendererJson.colorRamp);var o=t.__assign({},this.renderer.toJSON()),s=t.__assign({},this.lookup.rendererJson);return o.colorRamp=null,s.colorRamp=null,JSON.stringify(this.renderer.toJSON())!==JSON.stringify(this.lookup.rendererJson)}return JSON.stringify(this.renderer.toJSON())!==JSON.stringify(this.lookup.rendererJson)},r.prototype._symbolize_colormap=function(e){if(this._isLUTChanged()&&!this.bind())return e;return u.colorize(e,this.lookup.colormapLut)},r.prototype._symbolize_classBreaks=function(e){var r=this.rasterInfo.pixelType,t=["u8","u16","s8","s16"].indexOf(r)>-1;if(this._isLUTChanged()&&!this.bind())return e;return t?u.colorize(e,this.lookup.colormapLut):u.remapColor(e,this.lookup.remapLut)},r.prototype._symbolize_stretch=function(e,r){var o,s,a=this.rasterInfo,n=a.pixelType,i=a.bandCount,l=this.renderer,p=["u8","u16","s8","s16"].indexOf(n)>-1,c=l.gamma,h=l.useGamma;if(p){if(l.dynamicRangeAdjustment){var m=this.getStretchCutoff(l,e,r);o=u.createStretchLUT(t.__assign(t.__assign({pixelType:n},m),{gamma:h?c:null}))}else if(this._isLUTChanged()){if(!this.bind())return e;o=this.lookup?this.lookup.stretchLut:null}else o=this.lookup?this.lookup.stretchLut:null;if(!o)return e;i>1&&(null==r?void 0:r.length)===e.pixels.length&&(null==o?void 0:o.lut.length)===i&&(o={lut:r.map((function(e){return o.lut[e]})),offset:o.offset}),s=u.lookupPixels(e,o)}else{m=this.getStretchCutoff(l,e,r);s=u.stretch(e,t.__assign(t.__assign({},m),{gamma:h?c:null}))}if(l.colorRamp){if(this._isLUTChanged(!0))if(!this.bind())return e;s=u.colorize(s,this.lookup.colormapLut)}return s},r.prototype._symbolize_shadedRelief=function(e,r){var o,s=this.renderer,a=t.__assign(t.__assign({},s.toJSON()),r),n=p.hillshade(e,a);if(!s.colorRamp)return n;if(this._isLUTChanged(!0)){if(!this.bind())return n;o=this.lookup?this.lookup.hsvMap:null}else o=this.lookup?this.lookup.hsvMap:null;return o?(p.tintHillshade(n,e,o,this.rasterInfo.statistics[0]),n):n},r.prototype._updateUVRenderer=function(e){var r=this.rasterInfo,t=r.bandCount,o=r.attributeTable,s=r.statistics,a=r.pixelType,n=["u8","s8"].indexOf(a)>-1&&s&&null!=s[0].min&&null!=s[0].max;if(1!==t||!o&&!n)return!1;var i=e.field;if(!i)return!1;var l=[];if(o){var p=o.fields.filter((function(e){return"value"===e.name.toLowerCase()}))[0];if(!p)return!1;o.features.forEach((function(r){var t=e.uniqueValueInfos.filter((function(e){return String(e.value)===String(r.attributes[i])}))[0],o=t&&t.symbol&&t.symbol.color;o&&l.push([r.attributes[p.name],o.r,o.g,o.b,o.a>1?o.a:Math.round(255*o.a)])}))}else{if("value"!==i.toLowerCase())return!1;e.uniqueValueInfos.forEach((function(e){var r=e&&e.symbol&&e.symbol.color;r&&l.push([parseInt(e.value,10),r.r,r.g,r.b,r.a>1?r.a:Math.round(255*r.a)])}))}if(0===l.length)return!1;var c=u.createColormapLUT({colormap:l});return this.lookup={rendererJson:e.toJSON(),colormapLut:c},this.canRenderInWebGL=!0,!0},r.prototype._updateColormapRenderer=function(e){var r=e.extractColormap();if(!r||0===r.length)return!1;var t=u.createColormapLUT({colormap:r});return this.lookup={rendererJson:e.toJSON(),colormapLut:t},this.canRenderInWebGL=!0,!0},r.prototype._updateShadedReliefRenderer=function(e){if("elevation"!==this.rasterInfo.dataType)return!1;if(e.colorRamp){for(var r=c.convertColorRampToColormap(e.colorRamp,256),t=u.createColormapLUT({colormap:r}),o=[],a=t.indexedColormap,n=0;n<a.length;n+=4){var i=s.toHSV({r:a[n],g:a[n+1],b:a[n+2]});o.push([i.h/60,i.s/100,255*i.v/100])}this.lookup={rendererJson:e.toJSON(),colormapLut:t,hsvMap:o}}else this.lookup=null;return this.canRenderInWebGL=!0,!0},r.prototype._updateClassBreaksRenderer=function(e){var r=this.rasterInfo.pixelType,t=["u8","u16","s8","s16"].indexOf(r)>-1,o=e.classBreakInfos;if(!o||0===o.length)return!1;var s=o.sort((function(e,r){return e.minValue-r.minValue})),a=s[s.length-1];if(!t){var n=s.map((function(e){return{value:e.minValue,mappedColor:[e.symbol.color.r,e.symbol.color.g,e.symbol.color.b,e.symbol.color.a>1?e.symbol.color.a:Math.round(255*e.symbol.color.a)]}}));return n.push({value:a.maxValue,mappedColor:[a.symbol.color.g,a.symbol.color.b,a.symbol.color.a>1?a.symbol.color.a:Math.round(255*a.symbol.color.a)]}),this.lookup={rendererJson:e.toJSON(),remapLut:n},this.canRenderInWebGL=!1,!0}var i,l=[],p=0;s.forEach((function(e){i=Math.ceil(e.minValue),p=Math.floor(e.maxValue);for(var r=i;r<p;r++)l.push([r,e.symbol.color.r,e.symbol.color.g,e.symbol.color.b,e.symbol.color.a>1?e.symbol.color.a:Math.round(255*e.symbol.color.a)])})),l.push([a.maxValue,a.symbol.color.r,a.symbol.color.g,a.symbol.color.b,a.symbol.color.a>1?a.symbol.color.a:Math.round(255*a.symbol.color.a)]);var c=u.createColormapLUT({colormap:l,fillUnspecified:!1});return this.lookup={rendererJson:e.toJSON(),colormapLut:c},this.canRenderInWebGL=!0,!0},r.prototype._updateStretchRenderer=function(e){if(!(e.statistics||this.rasterInfo.statistics||e.dynamicRangeAdjustment))return!1;var r=e.histograms||this.rasterInfo.histograms;if(!e.dynamicRangeAdjustment&&"percent-clip"===e.stretchType&&!r)return!1;var o=e.gamma,s=e.useGamma,a=e.colorRamp,n=this.rasterInfo.pixelType;if(!e.dynamicRangeAdjustment&&["u8","u16","s8","s16"].indexOf(n)>-1){var i=this.getStretchCutoff(e),l=u.createStretchLUT(t.__assign(t.__assign({pixelType:n},i),{gamma:s?o:null}));this.lookup={rendererJson:e.toJSON(),stretchLut:l}}if(a){var p=c.convertColorRampToColormap(a,256);this.lookup||(this.lookup={rendererJson:e.toJSON()}),this.lookup.colormapLut=u.createColormapLUT({colormap:p}),this.lookup.rendererJson=e.toJSON()}return this.canRenderInWebGL=!0,!0},r.prototype.getStretchCutoff=function(e,r,t){var o,s,a=e.stretchType;if(e.dynamicRangeAdjustment)if("min-max"===a&&r.statistics)o=r.statistics.map((function(e){return[e.minValue,e.maxValue,0,0]}));else{var n=u.estimateStatisticsHistograms(r);o=n.statistics,s=n.histograms}else o=e.statistics&&e.statistics.length>0?e.statistics:this.rasterInfo.statistics,s=e.histograms||this.rasterInfo.histograms;var i,l,p,c,h,m,f,d,y,g=o||s?(o||s).length:this.rasterInfo.bandCount,b=[],v=[];switch(o[0]instanceof Array||(o=o.map((function(e){return[e.min,e.max,e.avg,e.stddev]}))),a){case"none":for(d=0;d<g;d++)b[d]="u8"===this.rasterInfo.pixelType?0:o?o[d][0]:0,v[d]="u8"===this.rasterInfo.pixelType?255:o?o[d][1]:255;break;case"min-max":for(d=0;d<g;d++)b[d]=o[d][0],v[d]=o[d][1];break;case"standard-deviation":for(d=0;d<g;d++)b[d]=o[d][2]-e.numberOfStandardDeviations*o[d][3],v[d]=o[d][2]+e.numberOfStandardDeviations*o[d][3],b[d]<o[d][0]&&(b[d]=o[d][0]),v[d]>o[d][1]&&(v[d]=o[d][1]);break;case"percent-clip":for(d=0;d<s.length;d++){for(i=s[d],h=new Uint32Array(i.size),c=i.counts,p=0,l=(i.max-i.min)/i.size,f=-.5===i.min&&1===l?.5:0,y=0;y<i.size;y++)p+=c[y],h[y]=p;for(m=e.minPercent*p/100,y=0;y<i.size;y++)if(h[y]>m){b[d]=i.min+l*(y+f);break}for(m=(1-e.maxPercent/100)*p,y=i.size-2;y>=0;y--)if(h[y]<m){v[d]=i.min+l*(y+2-f);break}}break;default:for(d=0;d<g;d++)b[d]=o[d][0],v[d]=o[d][1]}var _={minCutOff:b,maxCutOff:v,outMax:e.outputMax||255,outMin:e.outputMin||0};return this.getSelectedBandCutoffs(_,t)},r.prototype.getSelectedBandCutoffs=function(e,r){if(null==r||0===r.length)return e;var t=Math.max.apply(null,r),o=e.minCutOff,s=e.maxCutOff,a=e.outMin,n=e.outMax;return o.length===r.length||o.length<=t?e:{minCutOff:r.map((function(e){return o[e]})),maxCutOff:r.map((function(e){return s[e]})),outMin:a,outMax:n}},r.prototype.generateStretchWebGLParams=function(e,r,t){var o=null,s=null,a=this.lookup&&this.lookup.colormapLut;r.colorRamp&&a&&(o=a.indexedColormap,s=a.offset);var n=r.gamma,i=!!(r.useGamma&&n&&n.some((function(e){return 1!==e}))),l=this.getStretchCutoff(r,e,t),u=l.minCutOff,p=l.maxCutOff,c=l.outMin,h=l.outMax;e&&e.pixels&&2===e.pixels.length&&((e=e.clone()).statistics=[e.statistics[0]],e.pixels=[e.pixels[0]]);var m,f=Math.min(3,t&&t.length||e&&e.getPlaneCount()||this.rasterInfo.bandCount),d=new Float32Array(f),y=o||i?1:255;for(m=0;m<f;m++)d[m]=(h-c)/(p[m]-u[m])/y;var g=new Float32Array(f);if(i)for(m=0;m<f;m++)n[m]>1?n[m]>2?g[m]=6.5+Math.pow(n[m]-2,2.5):g[m]=6.5+100*Math.pow(2-n[m],4):g[m]=1;return{bandCount:f,outMin:c/y,outMax:h/y,minCutOff:u,maxCutOff:p,factor:d,useGamma:i,gamma:i?n:[1,1,1],gammaCorrection:i?g:[1,1,1],colormap:o,colormapOffset:s,type:"stretch"}},r.prototype.generateShadedReliefWebGLParams=function(e,r,o){var s=null,a=null,n=this.lookup&&this.lookup.colormapLut;e.colorRamp&&n&&(s=n.indexedColormap,a=n.offset);var i=t.__assign(t.__assign({},e.toJSON()),{isGCS:r,resolution:o}),l=p.calculateHillshadeParams(i),u=this.rasterInfo.statistics[0];return t.__assign(t.__assign({},l),{minValue:u.min,maxValue:u.max,hillshadeType:"traditional"===e.hillshadeType?0:1,type:"hillshade",colormap:s,colormapOffset:a})},r.prototype.isValidPixelBlock=function(e){return!!(e&&e.pixels&&e.pixels.length>0&&0!==e.validPixelCount)},t.__decorate([i.property({types:o.rasterRendererTypes,json:{write:!0}})],r.prototype,"renderer",void 0),t.__decorate([i.reader("renderer")],r.prototype,"readRenderer",null),t.__decorate([i.property({type:l,json:{write:!0}})],r.prototype,"rasterInfo",void 0),t.__decorate([i.property({json:{write:!0}})],r.prototype,"lookup",void 0),t.__decorate([i.property({})],r.prototype,"canRenderInWebGL",void 0),r=t.__decorate([i.subclass("esri.renderers.support.RasterSymbolizer")],r)}(a.JSONSupport)}));