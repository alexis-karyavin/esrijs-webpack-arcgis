// COPYRIGHT © 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../core/arrayUtils","../../core/Logger","../../core/unitUtils","../../intl/date","./numberUtils","../visualVariables/support/ColorStop"],(function(e,t,a,n,i,r,l,o){Object.defineProperty(t,"__esModule",{value:!0});var s=n.getLogger("esri.renderers.support.utils"),u="<",m=">",d="%",f="–",c={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},p={millisecond:"long-month-day-year-long-time",second:"long-month-day-year-long-time",minute:"long-month-day-year-short-time",hour:"long-month-day-year-short-time",day:"long-month-day-year",month:"long-month-day-year",year:"year"};function v(e,t,a){var n="";return 0===t?n=u+" ":t===a&&(n=m+" "),n+e}function h(e){var t=e.minValue,a=e.maxValue,n=e.isFirstBreak?"":m+" ",i="percent-of-total"===e.normalizationType?d:"";return t=null==t?"":l.format(t),a=null==a?"":l.format(a),n+t+i+" "+f+" "+a+i}function y(e,t){return"normalizationField"in e&&e.normalizationField?(a=e.field,n=e.normalizationField,{type:"normalized-field",field:a,normalizationField:n}):"field"in e&&e.field?g(e.field):"valueExpression"in e&&e.valueExpression?(i=e.valueExpression,r=e.valueExpressionTitle,{type:"expression",expression:i,title:r,returnType:t}):null;var a,n,i,r}function g(e){return{type:"field",field:e}}t.meterIn={inches:i.convertUnit(1,"meters","inches"),feet:i.convertUnit(1,"meters","feet"),"us-feet":i.convertUnit(1,"meters","us-feet"),yards:i.convertUnit(1,"meters","yards"),miles:i.convertUnit(1,"meters","miles"),"nautical-miles":i.convertUnit(1,"meters","nautical-miles"),millimeters:i.convertUnit(1,"meters","millimeters"),centimeters:i.convertUnit(1,"meters","centimeters"),decimeters:i.convertUnit(1,"meters","decimeters"),meters:i.convertUnit(1,"meters","meters"),kilometers:i.convertUnit(1,"meters","kilometers"),"decimal-degrees":1/i.lengthToDegrees(1,"meters")},t.timelineDateFormatOptions=r.convertDateFormatToIntlOptions("short-date"),t.createColorStops=function(e){var t=e.values,a=e.colors,n=e.labelIndexes,i=e.isDate,s=e.dateFormatOptions;return t.map((function(e,u){var m=null;if(!n||n.indexOf(u)>-1){var d=void 0;(d=i?r.formatDate(e,s):l.format(e))&&(m=v(d,u,t.length-1))}return new o({value:e,color:a[u],label:m})}))},t.updateColorStops=function(e){for(var t=e.stops,a=e.changes,n=e.isDate,i=e.dateFormatOptions,o=t.map((function(e){return e.value})),s=[],u=0,m=a;u<m.length;u++){var d=m[u];s.push(d.index),o[d.index]=d.value}var f=l.round(o,{indexes:s});t.forEach((function(e,a){if(e.value=o[a],null!=e.label){var s=void 0,u=null;(s=n?r.formatDate(f[a],i):l.format(f[a]))&&(u=v(s,a,t.length-1)),e.label=u}}))},t.createClassBreakLabel=h,t.setLabelsForClassBreaks=function(e){var t=e.classBreakInfos,a=e.normalizationType,n=[];if(t&&t.length)if("standard-deviation"!==e.classificationMethod)if(e.round){n.push(t[0].minValue);for(var i=0,r=t;i<r.length;i++){var o=r[i];n.push(o.maxValue)}n=l.round(n),t.forEach((function(e,t){e.label=h({minValue:0===t?n[0]:n[t],maxValue:n[t+1],isFirstBreak:0===t,normalizationType:a})}))}else t.forEach((function(e,t){e.label=h({minValue:e.minValue,maxValue:e.maxValue,isFirstBreak:0===t,normalizationType:a})}));else s.warn("setLabelsForClassBreaks","cannot set labels for class breaks generated using 'standard-deviation' method.")},t.updateClassBreak=function(e){if("standard-deviation"!==e.classificationMethod){var t=e.classBreaks,a=e.change,n=a.index,i=a.value,r=t.length,l=-1,o=-1;0===n?l=n:n===r?o=n-1:(o=n-1,l=n);var u=e.normalizationType,m=null;l>-1&&l<r&&((m=t[l]).minValue=i,m.label=h({minValue:m.minValue,maxValue:m.maxValue,isFirstBreak:0===l,normalizationType:u})),o>-1&&o<r&&((m=t[o]).maxValue=i,m.label=h({minValue:m.minValue,maxValue:m.maxValue,isFirstBreak:0===o,normalizationType:u}))}else s.warn("updateClassBreak","cannot update labels for class breaks generated using 'standard-deviation' method.")},t.calculateDateFormatInterval=function(e){for(var t=e.map((function(e){return new Date(e)})),a=t.length,n=1/0,i=null,r=0;r<a-1;r++){for(var l=t[r],o=[],s=1/0,u=null,m=r+1;m<a;m++){var d=t[m],f=(l.getFullYear()!==d.getFullYear()?"year":l.getMonth()!==d.getMonth()&&"month")||l.getDate()!==d.getDate()&&"day"||l.getHours()!==d.getHours()&&"hour"||l.getMinutes()!==d.getMinutes()&&"minute"||l.getSeconds()!==d.getSeconds()&&"second"||"millisecond",p=c[f];p<s&&(s=p,u=f),o.push(f)}s<n&&(n=s,i=u)}return i},t.createUniqueValueLabel=function(e){var t=e.value,a=e.domain,n=e.fieldInfo,i=e.dateFormatInterval,o=String(t),s=a&&"codedValues"in a&&a.codedValues?a.getName(t):null;return s?o=s:"number"==typeof t&&(o=n&&"date"===n.type?r.formatDate(t,i&&r.convertDateFormatToIntlOptions(p[i])):l.format(t)),o},t.getAttribute=y,t.getAttributes=function(e,t){var n=[];if("class-breaks"===e.type||"heatmap"===e.type)n.push(y(e,"number"));else if("unique-value"===e.type){var i=e.authoringInfo;if(i&&"relationship"===i.type){if(i.field1&&i.field2){var r=i.field1.field,l=i.field2.field,o=i.field1.normalizationField,s=i.field2.normalizationField;n.push(y({field:r,normalizationField:o})),n.push(y({field:l,normalizationField:s}))}}else{var u=e.uniqueValueInfos[0],m=null;if(u&&u.value){var d=typeof e.uniqueValueInfos[0].value;"string"!==d&&"number"!==d||(m=d)}n.push(y(e,m)),[e.field2,e.field3].forEach((function(e){return e&&n.push(g(e))}))}}else"dot-density"===e.type&&e.attributes.forEach((function(e){return n.push(y(e,"number"))}));var f=t?t(e):"visualVariables"in e?e.visualVariables:null;return f&&f.forEach((function(e){return n.push(y(e,"number"))})),a.unique(n.filter(Boolean),(function(e,t){return"field"===e.type&&"field"===t.type?e.field===t.field:"normalized-field"===e.type&&"normalized-field"===t.type?e.field===t.field&&e.normalizationField===t.normalizationField:"expression"===e.type&&"expression"===t.type&&e.expression===t.expression}))}}));