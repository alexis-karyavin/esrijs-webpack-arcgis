// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../symbols","../symbols","../core/jsonMap","../core/lang","../core/Logger","../core/maybe","../core/promiseUtils","../core/accessorSupport/decorators","../core/accessorSupport/ensureType","../layers/support/fieldUtils","./Renderer","./mixins/VisualVariablesMixin","./support/ClassBreakInfo","./support/LegendOptions","../support/arcadeOnDemand","../symbols/support/jsonUtils"],(function(e,t,r,o,a,n,i,s,l,u,p,c,d,y,f,m,h,b,g){var _=s.getLogger("esri.renderers.ClassBreaksRenderer"),v=new n.default({esriNormalizeByLog:"log",esriNormalizeByPercentOfTotal:"percent-of-total",esriNormalizeByField:"field"}),k=c.ensureType(m);return function(e){function t(t){var r=e.call(this,t)||this;return r.backgroundFillSymbol=null,r.classBreakInfos=null,r.defaultLabel=null,r.defaultSymbol=null,r.field=null,r.isMaxInclusive=!0,r.legendOptions=null,r.normalizationField=null,r.normalizationTotal=null,r.type="class-breaks",r.valueExpression=null,r.valueExpressionTitle=null,r._set("classBreakInfos",[]),r}var n;return r.__extends(t,e),n=t,Object.defineProperty(t.prototype,"_cache",{get:function(){return{compiledFunc:null}},enumerable:!0,configurable:!0}),t.prototype.readClassBreakInfos=function(e,t,r){if(Array.isArray(e)){var o=t.minValue;return e.map((function(e){var t=new m;return t.read(e,r),null==t.minValue&&(t.minValue=o),null==t.maxValue&&(t.maxValue=t.minValue),o=t.maxValue,t}))}},t.prototype.writeClassBreakInfos=function(e,t,r,o){var a=e.map((function(e){return e.write({},o)}));this._areClassBreaksConsecutive()&&a.forEach((function(e){return delete e.classMinValue})),t[r]=a},t.prototype.readDefaultSymbol=function(e,t,r){return g.read(e,t,r)},t.prototype.writeDefaultSymbolWebScene=function(e,t,r,o){g.writeTarget(e,t,r,o)},t.prototype.writeDefaultSymbol=function(e,t,r,o){g.writeTarget(e,t,r,o)},t.prototype.castField=function(e){return null==e?e:"function"==typeof e?(_.error(".field: field must be a string value"),null):c.ensureString(e)},Object.defineProperty(t.prototype,"minValue",{get:function(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"normalizationType",{get:function(){var e=this._get("normalizationType"),t=!!this.normalizationField,r=null!=this.normalizationTotal;return t||r?(e=(t?"field":r&&"percent-of-total")||null,t&&r&&_.warn("warning: both normalizationField and normalizationTotal are set!")):"field"!==e&&"percent-of-total"!==e||(e=null),e},set:function(e){this._set("normalizationType",e)},enumerable:!0,configurable:!0}),t.prototype.addClassBreakInfo=function(e,t,r){var o=null;o="number"==typeof e?new m({minValue:e,maxValue:t,symbol:a.ensureType(r)}):k(i.clone(e)),this.classBreakInfos.push(o),1===this.classBreakInfos.length&&this.notifyChange("minValue")},t.prototype.removeClassBreakInfo=function(e,t){for(var r=this.classBreakInfos.length,o=0;o<r;o++){var a=[this.classBreakInfos[o].minValue,this.classBreakInfos[o].maxValue];if(a[0]===e&&a[1]===t){this.classBreakInfos.splice(o,1);break}}},t.prototype.getBreakIndex=function(e,t){return this.valueExpression&&(l.isNone(t)||l.isNone(t.arcade))&&_.warn(""),this.valueExpression?this._getBreakIndexForExpression(e,t):this._getBreakIndexForField(e)},t.prototype.getClassBreakInfo=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var o,a,n,i;return r.__generator(this,(function(s){switch(s.label){case 0:return o=t,this.valueExpression&&(l.isNone(t)||l.isNone(t.arcade))?(a=[r.__assign({},o)],n={},[4,b.loadArcade()]):[3,2];case 1:o=r.__assign.apply(void 0,a.concat([(n.arcade=s.sent(),n)])),s.label=2;case 2:return[2,-1!==(i=this.getBreakIndex(e,o))?this.classBreakInfos[i]:null]}}))}))},t.prototype.getSymbol=function(e,t){if(!this.valueExpression||!l.isNone(t)&&!l.isNone(t.arcade)){var r=this.getBreakIndex(e,t);return r>-1?this.classBreakInfos[r].symbol:this.defaultSymbol}_.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used")},t.prototype.getSymbolAsync=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var o,a,n,i;return r.__generator(this,(function(s){switch(s.label){case 0:return o=t,this.valueExpression&&(l.isNone(t)||l.isNone(t.arcade))?(a=[r.__assign({},o)],n={},[4,b.loadArcade()]):[3,2];case 1:o=r.__assign.apply(void 0,a.concat([(n.arcade=s.sent(),n)])),s.label=2;case 2:return[2,(i=this.getBreakIndex(e,o))>-1?this.classBreakInfos[i].symbol:this.defaultSymbol]}}))}))},t.prototype.getSymbols=function(){var e=[];return this.classBreakInfos.forEach((function(t){t.symbol&&e.push(t.symbol)})),this.defaultSymbol&&e.push(this.defaultSymbol),e},t.prototype.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce((function(e,t){return e+t.getAttributeHash()}),"")},t.prototype.getMeshHash=function(){var e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),r=this.normalizationField+"."+this.normalizationType+"."+this.normalizationTotal;return e+"."+t+"."+this.classBreakInfos.reduce((function(e,t){return e+t.getMeshHash()}),"")+"."+r+"."+this.field+"."+this.valueExpression},Object.defineProperty(t.prototype,"arcadeRequired",{get:function(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression},enumerable:!0,configurable:!0}),t.prototype.clone=function(){return new n({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:i.clone(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:i.clone(this.visualVariables),legendOptions:i.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})},t.prototype.collectRequiredFields=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var o;return r.__generator(this,(function(r){switch(r.label){case 0:return o=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)],[4,u.all(o)];case 1:return r.sent(),[2]}}))}))},t.prototype.collectSymbolFields=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var o;return r.__generator(this,(function(a){switch(a.label){case 0:return o=r.__spreadArrays(this.getSymbols().map((function(r){return r.collectRequiredFields(e,t)})),[d.collectArcadeFieldNames(e,t,this.valueExpression)]),d.collectField(e,t,this.field),d.collectField(e,t,this.normalizationField),[4,u.all(o)];case 1:return a.sent(),[2]}}))}))},t.prototype._getBreakIndexForExpression=function(e,t){var r=l.unwrapOr(t,{}),o=r.viewingMode,a=r.scale,n=r.spatialReference,i=r.arcade,s=this._cache.compiledFunc,u=l.unwrap(i).arcadeUtils;if(!s){var p=u.createSyntaxTree(this.valueExpression);s=u.createFunction(p),this._cache.compiledFunc=s}var c=u.executeFunction(s,u.createExecContext(e,u.getViewInfo({viewingMode:o,scale:a,spatialReference:n})));return this._getBreakIndexfromInfos(c)},t.prototype._getBreakIndexForField=function(e){var t=this.field,r=e.attributes,o=this.normalizationType,a=parseFloat(r[t]);if(o){var n=this.normalizationTotal,i=parseFloat(r[this.normalizationField]);if("log"===o)a=Math.log(a)*Math.LOG10E;else if("percent-of-total"!==o||isNaN(n)){if("field"===o&&!isNaN(i)){if(isNaN(a)||isNaN(i))return-1;a/=i}}else a=a/n*100}return this._getBreakIndexfromInfos(a)},t.prototype._getBreakIndexfromInfos=function(e){var t=this.isMaxInclusive;if(null!=e&&"number"==typeof e&&!isNaN(e))for(var r=0;r<this.classBreakInfos.length;r++){var o=[this.classBreakInfos[r].minValue,this.classBreakInfos[r].maxValue];if(o[0]<=e&&(t?e<=o[1]:e<o[1]))return r}return-1},t.prototype._areClassBreaksConsecutive=function(){for(var e=this.classBreakInfos,t=e.length,r=1;r<t;r++)if(e[r-1].maxValue!==e[r].minValue)return!1;return!0},r.__decorate([p.property({readOnly:!0,dependsOn:["valueExpression"]})],t.prototype,"_cache",null),r.__decorate([p.property({types:{base:o.BaseSymbol,key:"type",typeMap:{"simple-fill":a.symbolTypesRenderer.typeMap["simple-fill"],"picture-fill":a.symbolTypesRenderer.typeMap["picture-fill"],"polygon-3d":a.symbolTypesRenderer.typeMap["polygon-3d"]}},json:{origins:{"web-scene":{type:o.PolygonSymbol3D,read:g.read,write:g.writeTarget}},read:g.read,write:g.writeTarget}})],t.prototype,"backgroundFillSymbol",void 0),r.__decorate([p.property({type:[m]})],t.prototype,"classBreakInfos",void 0),r.__decorate([p.reader("classBreakInfos")],t.prototype,"readClassBreakInfos",null),r.__decorate([p.writer("classBreakInfos")],t.prototype,"writeClassBreakInfos",null),r.__decorate([p.property({type:String,json:{write:!0}})],t.prototype,"defaultLabel",void 0),r.__decorate([p.property({types:a.symbolTypesRenderer})],t.prototype,"defaultSymbol",void 0),r.__decorate([p.reader("defaultSymbol")],t.prototype,"readDefaultSymbol",null),r.__decorate([p.writer("web-scene","defaultSymbol",{defaultSymbol:{types:a.symbolTypesRenderer3D}})],t.prototype,"writeDefaultSymbolWebScene",null),r.__decorate([p.writer("defaultSymbol")],t.prototype,"writeDefaultSymbol",null),r.__decorate([p.property({type:String,json:{write:!0}})],t.prototype,"field",void 0),r.__decorate([p.cast("field")],t.prototype,"castField",null),r.__decorate([p.property({type:Boolean})],t.prototype,"isMaxInclusive",void 0),r.__decorate([p.property({type:h.default,json:{write:!0}})],t.prototype,"legendOptions",void 0),r.__decorate([p.property({type:Number,readOnly:!0,value:null,dependsOn:["classBreakInfos"],json:{read:!1,write:{overridePolicy:function(){return 0!==this.classBreakInfos.length&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}})],t.prototype,"minValue",null),r.__decorate([p.property({type:String,json:{write:!0}})],t.prototype,"normalizationField",void 0),r.__decorate([p.property({type:Number,cast:function(e){return c.ensureNumber(e)},json:{write:!0}})],t.prototype,"normalizationTotal",void 0),r.__decorate([p.property({type:v.apiValues,value:null,dependsOn:["normalizationField","normalizationTotal"],json:{type:v.jsonValues,read:v.read,write:v.write}})],t.prototype,"normalizationType",null),r.__decorate([p.enumeration({classBreaks:"class-breaks"})],t.prototype,"type",void 0),r.__decorate([p.property({type:String,json:{write:!0}})],t.prototype,"valueExpression",void 0),r.__decorate([p.property({type:String,json:{write:!0}})],t.prototype,"valueExpressionTitle",void 0),t=n=r.__decorate([p.subclass("esri.renderers.ClassBreaksRenderer")],t)}(f.VisualVariablesMixin(y))}));