// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../request","./featureSetCollection","./featureset/sources/FeatureLayerDynamic","./featureset/sources/FeatureLayerMemory","./featureset/sources/FeatureLayerRelated","./featureset/support/cache","./featureset/support/shared","../core/promiseUtils","../core/sql/WhereClause","../layers/FeatureLayer","../portal/Portal","../portal/PortalItem","./featureset/actions/OrderBy","./featureset/actions/Top","./featureset/actions/SpatialFilter","./featureset/actions/AttributeFilter","./featureset/actions/GroupBy"],(function(e,t,r,a,n,i,l,o,s,u,c,d,f,h,p){function y(e,t){if(s.applicationCache){var r=s.applicationCache.getLayerInfo(e);if(r)return r.then((function(r){return c.resolve(new f({url:e,outFields:t,sourceJSON:r}))}));var a=new f({url:e,outFields:t}),n=c.create((function(e,t){a.load().then((function(){e(a.sourceJSON)}),(function(e){t(e)}))}));return s.applicationCache&&(s.applicationCache.setLayerInfo(e,n),n=n.catch((function(t){throw s.applicationCache.clearLayerInfo(e),t}))),n.then((function(){return c.resolve(a)}))}return c.resolve(new f({url:e,outFields:t}))}function m(e,t,r,a,n){return y(e,["*"]).then((function(e){return c.resolve(v(e,t,r,a,n))}))}function v(e,t,r,a,n){return void 0===t&&(t=null),void 0===r&&(r=null),void 0===a&&(a=!0),void 0===n&&(n=null),!0===e._hasMemorySource()?new l({layer:e,spatialReference:t,outFields:r,includeGeometry:a,lrucache:n}):new i({layer:e,spatialReference:t,outFields:r,includeGeometry:a,lrucache:n})}function _(e){if(null!==s.applicationCache){var t=s.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=a(e,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),c.resolve(t)}return c.resolve({layers:[],tables:[]})}));return null!==s.applicationCache&&(s.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw s.applicationCache.clearLayerInfo(e),t}))),r}Object.defineProperty(t,"__esModule",{value:!0}),t.initialiseMetaDataCache=function(){null===s.applicationCache&&(s.applicationCache=new s)},t.constructFeatureSetFromUrl=m,t.constructFeatureSet=v,t.constructAssociationMetaDataFeatureSetFromUrl=function(e,t){var n={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return _(e).then((function(i){if(n.metadata=i,i.controllerDatasetLayers&&void 0!==i.controllerDatasetLayers.utilityNetworkLayerId&&null!==i.controllerDatasetLayers.utilityNetworkLayerId){if(i.layers)for(var l=0,o=i.layers;l<o.length;l++){var u=o[l];n.layerNameLkp[u.id]=u.name}if(i.tables)for(var f=0,h=i.tables;f<h.length;f++){u=h[f];n.layerNameLkp[u.id]=u.name}var p=i.controllerDatasetLayers.utilityNetworkLayerId;return n.networkId=p,function(e,t){var r="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==s.applicationCache){var n=s.applicationCache.getLayerInfo(r);if(null!==n)return n}var i=a(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([t.toString()]),f:"json"}}).then((function(e){if(e.data){var t=e.data;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")}));return null!==s.applicationCache&&(s.applicationCache.setLayerInfo(r,i),i=i.catch((function(e){throw s.applicationCache.clearLayerInfo(r),e}))),i}(e,p).then((function(i){if(i){n.queryelem=i,n.queryelem&&n.queryelem.dataElement&&void 0!==n.queryelem.dataElement.schemaGeneration&&(n.unVersion=n.queryelem.dataElement.schemaGeneration),n.lkp={},n.queryelem.dataElement.domainNetworks||(n.queryelem.dataElement.domainNetworks=[]);for(var l=0,o=n.queryelem.dataElement.domainNetworks;l<o.length;l++){for(var u=o[l],f=0,h=u.edgeSources?u.edgeSources:[];f<h.length;f++){(L={layerId:(_=h[f]).layerId,sourceId:_.sourceId,className:n.layerNameLkp[_.layerId]?n.layerNameLkp[_.layerId]:null}).className&&(n.lkp[L.className]=L)}for(var y=0,v=u.junctionSources?u.junctionSources:[];y<v.length;y++){var _,L;(L={layerId:(_=v[y]).layerId,sourceId:_.sourceId,className:n.layerNameLkp[_.layerId]?n.layerNameLkp[_.layerId]:null}).className&&(n.lkp[L.className]=L)}}if(n.queryelem.dataElement.terminalConfigurations)for(var I=0,S=n.queryelem.dataElement.terminalConfigurations;I<S.length;I++)for(var F=0,g=S[I].terminals;F<g.length;F++){var N=g[F];n.terminals.push({terminalId:N.terminalId,terminalName:N.terminalName})}return function(e){if(null!==s.applicationCache){var t=s.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=a(e,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return c.resolve(t)}return c.resolve(null)}));return null!==s.applicationCache&&(s.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw s.applicationCache.clearLayerInfo(e),t}))),r}(e+"/"+p).then((function(a){if(a.systemLayers&&void 0!==a.systemLayers.associationsTableId&&null!==a.systemLayers.associationsTableId){var i=[];return n.unVersion>=4&&(i.push("STATUS"),i.push("PERCENTALONG")),m(e+"/"+a.systemLayers.associationsTableId.toString(),t,r.__spreadArrays(["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID"],i),!1,null).then((function(e){return e.load()})).then((function(e){return n.unVersion>=4?(e=e.filter(d.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",e.getFieldsIndex()))).load():e})).then((function(e){return{lkp:n.lkp,associations:e,unVersion:n.unVersion,terminals:n.terminals}}))}return{associations:null,unVersion:n.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:n.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:n.unVersion,lkp:null,terminals:[]}}))},t.constructFeatureSetFromRelationship=function(e,t,r,a,n,i,l){void 0===a&&(a=null),void 0===n&&(n=null),void 0===i&&(i=!0),void 0===l&&(l=null);var s=e.serviceUrl();return s?m(s="/"===s.charAt(s.length-1)?s+t.relatedTableId.toString():s+"/"+t.relatedTableId.toString(),a,n,i,l).then((function(s){return new o({layer:e,relatedLayer:s,relationship:t,objectId:r,spatialReference:a,outFields:n,includeGeometry:i,lrucache:l})})):null};var L=function(e){function t(t,r,a){void 0===r&&(r=null),void 0===a&&(a=null);var n=e.call(this)||this;return n._map=t,n._overridespref=r,n.lrucache=a,n._instantLayers=[],n}return r.__extends(t,e),t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=v(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype.featureSetByName=function(e,t,a){var n=this;if(void 0===t&&(t=!0),void 0===a&&(a=null),void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((function(){try{return n.featureSetByName(e,t,a)}catch(e){return c.reject(e)}}));null===a&&(a=["*"]),a=(a=a.slice(0)).sort();for(var i=JSON.stringify(a),l=0;l<this._instantLayers.length;l++){var o=this._instantLayers[l];if(o.opitem.title===e&&o.includeGeometry===t&&o.outFields===i)return this.resolvePromise(this._instantLayers[l].featureset)}var s=this._map.layers.find((function(t){return t instanceof f&&t.title===e}));if(s)return this.resolvePromise(this.makeAndAddFeatureSet(s,t,a));if(this._map.tables){var u=this._map.tables.find((function(t){return!!(t.title&&t.title===e||t.title&&t.title===e)}));if(u){if(u._materializedTable);else{var d=u.outFields?u:r.__assign(r.__assign({},u),{outFields:["*"]});u._materializedTable=new f(d)}return u._materializedTable.load().then((function(){return n.resolvePromise(n.makeAndAddFeatureSet(u._materializedTable,t,a))}))}}return this.resolvePromise(null)},t.prototype.featureSetById=function(e,t,a){var n=this;if(void 0===t&&(t=!0),void 0===a&&(a=["*"]),void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((function(){try{return n.featureSetById(e,t,a)}catch(e){return c.reject(e)}}));null===a&&(a=["*"]),a=(a=a.slice(0)).sort();for(var i=JSON.stringify(a),l=0;l<this._instantLayers.length;l++){var o=this._instantLayers[l];if(o.opitem.id===e&&o.includeGeometry===t&&o.outFields===i)return this.resolvePromise(this._instantLayers[l].featureset)}var s=this._map.layers.find((function(t){return t instanceof f&&t.id===e}));if(s)return this.resolvePromise(this.makeAndAddFeatureSet(s,t,a));if(this._map.tables){var u=this._map.tables.find((function(t){return t.id===e}));if(u){if(u._materializedTable);else{var d=r.__assign(r.__assign({},u),{outFields:["*"]});u._materializedTable=new f(d)}return u._materializedTable.load().then((function(){return n.resolvePromise(n.makeAndAddFeatureSet(u._materializedTable,t,a))}))}}return this.resolvePromise(null)},t}(n),I=function(e){function t(t,r,a){void 0===r&&(r=null),void 0===a&&(a=null);var n=e.call(this)||this;return n._url=t,n._overridespref=r,n.lrucache=a,n.metadata=null,n._instantLayers=[],n}return r.__extends(t,e),Object.defineProperty(t.prototype,"url",{get:function(){return this._url},enumerable:!0,configurable:!0}),t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=v(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype._loadMetaData=function(){var e=this;return _(this._url).then((function(t){return e.metadata=t,t}))},t.prototype.load=function(){return this._loadMetaData()},t.prototype.clone=function(){return new t(this._url,this._overridespref,this.lrucache)},t.prototype.featureSetByName=function(e,t,r){var a=this;void 0===t&&(t=!0),void 0===r&&(r=null),null===r&&(r=["*"]),r=(r=r.slice(0)).sort();for(var n=JSON.stringify(r),i=0;i<this._instantLayers.length;i++){var l=this._instantLayers[i];if(l.opitem.title===e&&l.includeGeometry===t&&l.outFields===n)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then((function(n){for(var i=null,l=0,o=n.layers?n.layers:[];l<o.length;l++){(c=o[l]).name===e&&(i=c)}if(!i)for(var s=0,u=n.tables?n.tables:[];s<u.length;s++){var c;(c=u[s]).name===e&&(i=c)}return i?y(a._url+"/"+i.id,["*"]).then((function(e){return a.makeAndAddFeatureSet(e,t,r)})):a.resolvePromise(null)}))},t.prototype.featureSetById=function(e,t,r){var a=this;void 0===t&&(t=!0),void 0===r&&(r=["*"]),null===r&&(r=["*"]),r=(r=r.slice(0)).sort();var n=JSON.stringify(r);e=null!=e?e.toString():"";for(var i=0;i<this._instantLayers.length;i++){var l=this._instantLayers[i];if(l.opitem.id===e&&l.includeGeometry===t&&l.outFields===n)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then((function(n){for(var i=null,l=0,o=n.layers?n.layers:[];l<o.length;l++){null!==(c=o[l]).id&&void 0!==c.id&&c.id.toString()===e&&(i=c)}if(!i)for(var s=0,u=n.tables?n.tables:[];s<u.length;s++){var c;null!==(c=u[s]).id&&void 0!==c.id&&c.id.toString()===e&&(i=c)}return i?y(a._url+"/"+i.id,["*"]).then((function(e){return a.makeAndAddFeatureSet(e,t,r)})):a.resolvePromise(null)}))},t}(n);t.createFeatureSetCollectionFromMap=function(e,t,r){return void 0===r&&(r=null),new L(e,t,r)},t.createFeatureSetCollectionFromService=function(e,t,r){return void 0===r&&(r=null),new I(e,t,r)},t.getPortal=function(e,t){return null===e?t:new h({url:e.field("url")})},t.constructFeatureSetFromPortalItem=function(e,t,r,a,n,i,l){if(s.applicationCache){var o=s.applicationCache.getLayerInfo(e+":"+i.url);if(o)return o.then((function(e){try{var i=new f({url:u.extractServiceUrl(e.url)+"/"+t,outFields:["*"]});return c.resolve(v(i,r,a,n,l))}catch(e){return c.reject(e)}}),(function(e){return c.reject(e)}))}return c.create((function(o,c){var d=new p({id:e,portal:i}).load();s.applicationCache&&s.applicationCache.setLayerInfo(e+":"+i.url,d),d.then((function(e){try{var i=new f({url:u.extractServiceUrl(e.url)+"/"+t,outFields:["*"]});o(v(i,r,a,n,l))}catch(e){c(e)}}),(function(t){s.applicationCache&&s.applicationCache.clearLayerInfo(e+":"+i.url),c(t)}))}))}}));