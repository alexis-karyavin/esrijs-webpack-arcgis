// COPYRIGHT © 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","./FunctionWrapper","./ImmutableArray","./ImmutablePathArray","./ImmutablePointArray","../core/promiseUtils","../geometry/Extent","../geometry/Geometry","../geometry/Multipoint","../geometry/Point","../geometry/Polygon","../geometry/Polyline","../core/number","../geometry/support/coordsUtils","../core/maybe"],(function(e,n,t,r,i,a,o,u,l,f,s,c,m,g,d,h){Object.defineProperty(n,"__esModule",{value:!0});var y=function(e){this.value=e};n.ReturnResultE=y;var p=function(e){this.value=e};n.ImplicitResultE=p;var v=function(e){this.fn=e};n.NativeFunctionE=v;var x=function(e){this.fn=e};function S(e,n,t){return""===n?e:null===n?e:void 0===n?e:n===t?e:n===t?e:e=e.split(n).join(t)}function N(e){return e instanceof v||e instanceof t||e instanceof x}function T(e){return!!O(e)||(!!M(e)||(!!C(e)||(!!b(e)||(null===e||(e===n.voidOperation||"number"==typeof e)))))}function O(e){return"string"==typeof e||e instanceof String}function b(e){return"boolean"==typeof e}function M(e){return"number"==typeof e}function R(e){return e instanceof Array}function _(e){return e instanceof r}function C(e){return e instanceof Date}function w(e,n){return!1===isNaN(e)?null==n||""===n?e.toString():(n=S(n,"‰",""),n=S(n,"¤",""),g.format(e,{pattern:n})):e.toString()}function I(e,t){var r=n.MomentLibrary.Moment(e);return null==t||""===t?r.format():r.format(A(t))}function A(e){return e.replace(/(LTS)|L|l/g,(function(e){return"["+e+"]"}))}function F(e,n,t){switch(t){case">":return e>n;case"<":return e<n;case">=":return e>=n;case"<=":return e<=n}return!1}function j(e,t){if(e===t)return!0;if(null===e&&t===n.voidOperation||null===t&&e===n.voidOperation)return!0;if(C(e)&&C(t))return e.getTime()===t.getTime();if(e instanceof i)return e.equalityTest(t);if(e instanceof a)return e.equalityTest(t);if(e instanceof s&&t instanceof s){var r,o;if(r=e.cache._arcadeCacheId,o=t.cache._arcadeCacheId,null!=r)return r===o}if(void 0!==e&&void 0!==t&&null!==e&&null!==t&&"object"==typeof e&&"object"==typeof t){if(e._arcadeCacheId===t._arcadeCacheId&&void 0!==e._arcadeCacheId&&null!==e._arcadeCacheId)return!0;if(e._underlyingGraphic===t._underlyingGraphic&&void 0!==e._underlyingGraphic&&null!==e._underlyingGraphic)return!0}return!1}function k(e,t){if(O(e))return e;if(null===e)return"";if(M(e))return w(e,t);if(b(e))return e.toString();if(C(e))return I(e,t);if(e instanceof l)return JSON.stringify(e.toJSON());if(R(e)){for(var i=[],a=0;a<e.length;a++)i[a]=D(e[a]);return"["+i.join(",")+"]"}if(e instanceof r){for(i=[],a=0;a<e.length();a++)i[a]=D(e.get(a));return"["+i.join(",")+"]"}return null!==e&&"object"==typeof e&&void 0!==e.castToText?e.castToText():N(e)?"object, Function":(n.voidOperation,"")}function Z(e,t){if(O(e))return e;if(null===e)return"";if(M(e))return w(e,t);if(b(e))return e.toString();if(C(e))return I(e,t);if(e instanceof l)return e instanceof u?'{"xmin":'+e.xmin.toString()+',"ymin":'+e.ymin.toString()+","+(e.hasZ?'"zmin":'+e.zmin.toString()+",":"")+(e.hasM?'"mmin":'+e.mmin.toString()+",":"")+'"xmax":'+e.xmax.toString()+',"ymax":'+e.ymax.toString()+","+(e.hasZ?'"zmax":'+e.zmax.toString()+",":"")+(e.hasM?'"mmax":'+e.mmax.toString()+",":"")+'"spatialReference":'+L(e.spatialReference)+"}":L(e.toJSON(),(function(e,n){return e.key===n.key?0:"spatialReference"===e.key?1:"spatialReference"===n.key?-1:e.key<n.key?-1:e.key>n.key?1:0}));if(R(e)){for(var i=[],a=0;a<e.length;a++)i[a]=D(e[a]);return"["+i.join(",")+"]"}if(e instanceof r){for(i=[],a=0;a<e.length();a++)i[a]=D(e.get(a));return"["+i.join(",")+"]"}return null!==e&&"object"==typeof e&&void 0!==e.castToText?e.castToText():N(e)?"object, Function":(n.voidOperation,"")}function D(e){if(null===e)return"null";if(b(e)||M(e)||O(e))return JSON.stringify(e);if(e instanceof l)return Z(e);if(e instanceof r)return Z(e);if(e instanceof Array)return Z(e);if(e instanceof Date)return JSON.stringify(I(e,""));if(null!==e&&"object"==typeof e){if(void 0!==e.castToText)return e.castToText()}else if(e===n.voidOperation)return"null";return"null"}function P(e,t){return M(e)?e:null===e?0:""===e?0:C(e)?NaN:b(e)?e?1:0:R(e)?NaN:""===e?NaN:void 0===e?NaN:void 0!==t&&O(e)?(t=S(t,"‰",""),t=S(t,"¤",""),g.parse(e,{pattern:t})):e===n.voidOperation?0:Number(e)}function E(e,n){var t;return n.fields.some((function(n){return n.name===e&&(t=n.domain),!!t})),t}function L(e,n){n||(n={}),"function"==typeof n&&(n={cmp:n});var t,r="boolean"==typeof n.cycles&&n.cycles,i=n.cmp&&(t=n.cmp,function(e){return function(n,r){var i={key:n,value:e[n]},a={key:r,value:e[r]};return t(i,a)}}),a=[];return function e(n){if(n&&n.toJSON&&"function"==typeof n.toJSON&&(n=n.toJSON()),void 0!==n){if("number"==typeof n)return isFinite(n)?""+n:"null";if("object"!=typeof n)return JSON.stringify(n);var t,o;if(Array.isArray(n)){for(o="[",t=0;t<n.length;t++)t&&(o+=","),o+=e(n[t])||"null";return o+"]"}if(null===n)return"null";if(-1!==a.indexOf(n)){if(r)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}var u=a.push(n)-1,l=Object.keys(n).sort(i&&i(n));for(o="",t=0;t<l.length;t++){var f=l[t],s=e(n[f]);s&&(o&&(o+=","),o+=JSON.stringify(f)+":"+s)}return a.splice(u,1),"{"+o+"}"}}(e)}function J(e,n){if(!(n instanceof s))throw new Error("Invalid Argument");e.push(n.hasZ?n.hasM?[n.x,n.y,n.z,n.m]:[n.x,n.y,n.z]:[n.x,n.y])}n.SizzleFunctionE=x,n.NativeFunction=v,n.ImplicitResult=p,n.ReturnResult=y,n.SizzleFunction=x,n.voidOperation={type:"VOID"},n.breakResult={type:"BREAK"},n.continueResult={type:"CONTINUE"},n.multiReplace=S,n.isFunctionParameter=N,n.isSimpleType=T,n.defaultUndefined=function(e,n){return void 0===e?n:e},n.isString=O,n.isBoolean=b,n.isNumber=M,n.isArray=R,n.isFeatureSet=function(e){return!0===(e&&e.declaredRootClass&&"esri.arcade.featureset.support.FeatureSet"===e.declaredRootClass)},n.isFeatureSetCollection=function(e){return!0===(e&&e.declaredRootClass&&"esri.arcade.featureSetCollection"===e.declaredRootClass)},n.isImmutableArray=_,n.isDate=C,n.pcCheck=function(e,n,t){if(e.length<n||e.length>t)throw new Error("Function called with wrong number of Parameters")},n.generateUUID=function(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(n){var t=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===n?t:3&t|8).toString(16)}))},n.formatNumber=w,n.formatDate=I,n.standardiseDateFormat=A,n.greaterThanLessThan=function(e,t,r){if(null===e){if(null===t||t===n.voidOperation)return F(null,null,r);if(M(t))return F(0,t,r);if(O(t))return F(0,P(t),r);if(b(t))return F(0,P(t),r);if(C(t))return F(0,t.getTime(),r)}if(e===n.voidOperation){if(null===t||t===n.voidOperation)return F(null,null,r);if(M(t))return F(0,t,r);if(O(t))return F(0,P(t),r);if(b(t))return F(0,P(t),r);if(C(t))return F(0,t.getTime(),r)}else if(M(e)){if(M(t))return F(e,t,r);if(b(t))return F(e,P(t),r);if(null===t||t===n.voidOperation)return F(e,0,r);if(O(t))return F(e,P(t),r);if(C(t))return F(e,t.getTime(),r)}else if(O(e)){if(O(t))return F(k(e),k(t),r);if(C(t))return F(P(e),t.getTime(),r);if(M(t))return F(P(e),t,r);if(null===t||t===n.voidOperation)return F(P(e),0,r);if(b(t))return F(P(e),P(t),r)}else if(C(e)){if(C(t))return F(e,t,r);if(null===t||t===n.voidOperation)return F(e.getTime(),0,r);if(M(t))return F(e.getTime(),t,r);if(b(t))return F(e.getTime(),P(t),r);if(O(t))return F(e.getTime(),P(t),r)}else if(b(e)){if(b(t))return F(e,t,r);if(M(t))return F(P(e),P(t),r);if(C(t))return F(P(e),t.getTime(),r);if(null===t||t===n.voidOperation)return F(P(e),0,r);if(O(t))return F(P(e),P(t),r)}return!!j(e,t)&&("<="===r||">="===r)},n.equalityTest=j,n.toString=k,n.toNumberArray=function(e){var n=[];if(!1===R(e))return null;if(e instanceof r){for(var t=0;t<e.length();t++)n[t]=P(e.get(t));return n}for(t=0;t<e.length;t++)n[t]=P(e[t]);return n},n.toStringExplicit=Z,n.toNumber=P,n.toDate=function(e,t){if(C(e))return e;if(O(e)){var r=n.MomentLibrary.Moment(e,[null==t||""===t?n.MomentLibrary.Moment.ISO_8601:t]);if(r.isValid())return r.toDate()}return null},n.toDateM=function(e,t){if(C(e))return n.MomentLibrary.Moment(e);if(O(e)){var r=n.MomentLibrary.Moment(e,[null==t||""===t?n.MomentLibrary.Moment.ISO_8601:t]);if(r.isValid())return r}return null},n.toBoolean=function(e){return b(e)?e:O(e)?"true"===(e=e.toLowerCase()):!!M(e)&&(0!==e&&!isNaN(e))},n.fixSpatialReference=function(e,n){return h.isNone(e)?null:(null!==e.spatialReference&&void 0!==e.spatialReference||(e.spatialReference=n),e)},n.fixNullGeometry=function(e){return null===e?null:e instanceof s?"NaN"===e.x||null===e.x||isNaN(e.x)?null:e:e instanceof c?0===e.rings.length?null:e:e instanceof m?0===e.paths.length?null:e:e instanceof f?0===e.points.length?null:e:e instanceof u?"NaN"===e.xmin||null===e.xmin||isNaN(e.xmin)?null:e:null},n.getDomainValue=function(e,n){if(!e)return n;if(!e.domain)return n;var t=null;if("string"===e.field.type||"esriFieldTypeString"===e.field.type)n=k(n);else{if(null==n)return null;if(""===n)return n;n=P(n)}for(var r=0;r<e.domain.codedValues.length;r++){var i=e.domain.codedValues[r];i.code===n&&(t=i)}return null===t?n:t.name},n.getDomainCode=function(e,n){if(!e)return n;if(!e.domain)return n;var t=null;n=k(n);for(var r=0;r<e.domain.codedValues.length;r++){var i=e.domain.codedValues[r];i.name===n&&(t=i)}return null===t?n:t.code},n.getDomain=function(e,n,t,r){if(void 0===t&&(t=null),!n)return null;if(!n.fields)return null;for(var i,a,o=null,u=0;u<n.fields.length;u++){var l=n.fields[u];l.name.toLowerCase()===e.toString().toLowerCase()&&(o=l)}if(null===o)throw new Error("Field not found");return r||(r=t&&n.typeIdField&&t._field(n.typeIdField)),null!=r&&n.types.some((function(e){return e.id===r&&((i=e.domains&&e.domains[o.name])&&"inherited"===i.type&&(i=E(o.name,n),a=!0),!0)})),a||i||(i=E(e,n)),{field:o,domain:i}},n.stableStringify=L,n.autoCastFeatureToGeometry=function(e){if(null===e)return null;for(var n=[],t=0,r=e;t<r.length;t++){var i=r[t];i&&i.declaredClass&&"esri.arcade.Feature"===i.declaredClass?n.push(i.geometry()):n.push(i)}return n},n.autoCastArrayOfPointsToPolygon=function(e,n){if(R(e)||_(e)){var t=!1,r=!1,i=[],o=n;if(R(e)){for(var u=0,l=e;u<l.length;u++){J(i,l[u])}i.length>0&&(o=e[0].spatialReference,t=e[0].hasZ,r=e[0].hasM)}else if(e instanceof a)(i=e._elements).length>0&&(t=e._hasZ,r=e._hasM,o=e.get(0).spatialReference);else{if(!_(e))throw new Error("Invalid Argument");for(var f=0,s=e.toArray();f<s.length;f++){J(i,s[f])}i.length>0&&(o=e.get(0).spatialReference,t=!0===e.get(0).hasZ,r=!0===e.get(0).hasM)}return 0===i.length?null:(!1===d.isClockwise(i,r,t)&&(i=i.slice(0).reverse()),new c({rings:[i],spatialReference:o,hasZ:t,hasM:r}))}return e},n.autoCastArrayOfPointsToPolyline=function(e,n){if(R(e)||_(e)){var t=!1,r=!1,i=[],o=n;if(R(e)){for(var u=0,l=e;u<l.length;u++){J(i,l[u])}i.length>0&&(o=e[0].spatialReference,t=!0===e[0].hasZ,r=!0===e[0].hasM)}else if(e instanceof a)(i=e._elements).length>0&&(t=e._hasZ,r=e._hasM,o=e.get(0).spatialReference);else if(_(e)){for(var f=0,s=e.toArray();f<s.length;f++){J(i,s[f])}i.length>0&&(o=e.get(0).spatialReference,t=!0===e.get(0).hasZ,r=!0===e.get(0).hasM)}return 0===i.length?null:new m({paths:[i],spatialReference:o,hasZ:t,hasM:r})}return e},n.autoCastArrayOfPointsToMultiPoint=function(e,n){if(R(e)||_(e)){var t=!1,r=!1,i=[],o=n;if(R(e)){for(var u=0,l=e;u<l.length;u++){J(i,l[u])}i.length>0&&(o=e[0].spatialReference,t=!0===e[0].hasZ,r=!0===e[0].hasM)}else if(e instanceof a)(i=e._elements).length>0&&(t=e._hasZ,r=e._hasM,o=e.get(0).spatialReference);else if(_(e)){for(var s=0,c=e.toArray();s<c.length;s++){J(i,c[s])}i.length>0&&(o=e.get(0).spatialReference,t=!0===e.get(0).hasZ,r=!0===e.get(0).hasM)}return 0===i.length?null:new f({points:i,spatialReference:o,hasZ:t,hasM:r})}return e},n.toStringArray=function(e,n){void 0===n&&(n=!1);var t=[];if(null===e)return t;if(!0===R(e)){for(var i=0;i<e.length;i++){""===(a=k(e[i]))&&!0!==n||t.push(a)}return t}if(e instanceof r){for(i=0;i<e.length();i++){var a;""===(a=k(e.get(i)))&&!0!==n||t.push(a)}return t}return T(e)?(""===(a=k(e))&&!0!==n||t.push(a),t):[]};var z=0;n.tick=function(e){return++z%100==0?(z=0,o.create((function(n){setTimeout((function(){n(e)}),0)}))):e},n.MomentLibrary={Moment:null},n.binaryOperator=function(e,n,t){switch(t){case"&":return e&n;case"|":return e|n;case"^":return e^n;case"<<":return e<<n;case">>":return e>>n;case">>>":return e>>>n}}}));