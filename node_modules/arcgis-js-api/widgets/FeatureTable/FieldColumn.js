// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../core/accessorSupport/decorators","../../intl/date","../../layers/support/CodedValueDomain","../../layers/support/fieldUtils","../FeatureForm/InputField","./Grid/EditorColumn"],(function(e,t,n,r,o,i,l,a,d){var u="Escape",p=o.convertDateFormatToIntlOptions("short-date-short-time"),c="esri-field-column__header-content",s="esri-field-column__cell-input",f="esri-field-column__cell-input-container",y="esri-icon-locked";return function(e){function t(t){var n=e.call(this,t)||this;return n._inputField=null,n.alias=null,n.cellValueFormatFunction=function(e){var t,r=e.rowData,i=e.value,l=n,a=l.config,d=l.type,u=r.item.feature,c=n._getDomainForFeature(u);if(c)return n._getComputedDomain(i,c);if("date"===d){var s=(null===(t=null==a?void 0:a.format)||void 0===t?void 0:t.format)?o.convertDateFormatToIntlOptions(a.format.format):p;return i?o.formatDate(i,s):null}return i},n.cellValueValidatorFunction=function(e){return e.oldValue!==e.value},n.config=null,n.defaultValue=null,n.description=null,n.direction=null,n.editingEnabled=!1,n.field=null,n.headerRenderFunction=function(e){var t=e.root,r=n,o=r.editable,i=r.editingEnabled,l=r.headerMenuEnabled,a=r.sortable;if(n.removeCellContent(t),t.classList.add(c),i&&!o&&t.appendChild(n.createLockedElement()),a)n.headerSorterRenderFunction(e);else{var d=n,u=d.header,p=d.path,s=document.createElement("div");s.innerHTML=u||p,t.appendChild(s)}l&&n.headerMenuRenderFunction(e)},n.layer=null,n.menuConfig=null,n.name=null,n.nullable=!0,n.parseInputValueFunction=function(e){var t=e.input,r=n._inputField,o=t.value,i=r.required,l=r.type;return i||""!==o?"number"===l?parseFloat(o):"date"===l?parseFloat(o):o:null},n.path=null,n.type=null,n.updateRowItemFunction=function(e){var t=e.rowData,n=e.column,r=e.value;t.item.feature.attributes[n.path]=r},n}return n.__extends(t,e),Object.defineProperty(t.prototype,"editable",{get:function(){var e,t,n,r;return"date"!==(null===(e=this.field)||void 0===e?void 0:e.type)&&(this.editingEnabled?this.config?!1!==this.config.editable&&(null===(t=this.field)||void 0===t?void 0:t.editable):null===(n=this.field)||void 0===n?void 0:n.editable:!!this.config&&(!0===this.config.editable&&(null===(r=this.field)||void 0===r?void 0:r.editable)))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"header",{get:function(){var e;return(null===(e=this.config)||void 0===e?void 0:e.label)||this.alias||this.path||null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hidden",{get:function(){var e=this.config;return!1===(null==e?void 0:e.visible)||this._get("hidden")||!1},set:function(e){this._set("hidden",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"loadingMessage",{get:function(){var e;return(null===(e=this.messages)||void 0===e?void 0:e.loading)||"..."},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxLength",{get:function(){var e,t,n=null===(e=this.field)||void 0===e?void 0:e.length,r=null===(t=this.config)||void 0===t?void 0:t.maxLength;return!isNaN(r)&&r>=-1&&(-1===n||r<=n)?r:n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"required",{get:function(){var e=this.get("field.nullable"),t=this.get("config.required");return this.editable&&(!e||!0===t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sortable",{get:function(){var e;return!1!==(null===(e=this.config)||void 0===e?void 0:e.sortable)},enumerable:!0,configurable:!0}),t.prototype.createInputElement=function(e){var t=this,n=e.rowData,r=e.value,o=n.item;if(!o||!o.feature)return null;this._inputField=this._setUpInputField(o.feature,r);var i=this.field,a=this.maxLength,d=this.required,p=this._inputField.domain,c=null;"coded-value"===(null==p?void 0:p.type)?(c=this._createSelectElement(r,p.codedValues.map((function(e){return{value:e.code,name:e.name}})),this._inputField)).onchange=function(){c.onblur=null,y()}:((c=document.createElement("input")).type=l.isNumericField(i)?"number":"text",a>-1&&(c.maxLength=a)),c.classList.add(s),c.value=r,c.required=d;var f=!1;c.onkeydown=function(e){f=e.key===u},c.onblur=function(){c.onblur=null,y()};var y=function(){f?t.cancel():t.submit(),t._inputField=null};return c},t.prototype.createInputContainer=function(){var e=document.createElement("div");return e.classList.add(f),e},t.prototype.createLockedElement=function(){var e=document.createElement("div");return e.classList.add(y),e},t.prototype.getCellValue=function(e,t){var n,r,o=e.path,i=t.item;return(null===(r=null===(n=null==i?void 0:i.feature)||void 0===n?void 0:n.attributes)||void 0===r?void 0:r[o])||null},t.prototype._createSelectElement=function(e,t,n){var r,o=!1,i=t.map((function(t){t.value===e&&(o=!0);var n=document.createElement("option");return n.text=t.name,n.value=t.value,n}));null==e||""===e||o||((r=document.createElement("option")).text=e,r.value=e,i.unshift(r));n.required||null!=n.value||((r=document.createElement("option")).value="",i.unshift(r));var l=document.createElement("select");return i.forEach((function(e){return l.add(e)})),l.value=e,l},t.prototype._setUpInputField=function(e,t){var n=this.config,r=this.field,o=this.layer,i=new a({config:n,feature:e,field:r,layer:o,group:null,messages:null});return i.set("value",t),i},t.prototype._isDomainCompatible=function(e){var t=this.field;if(e&&"coded-value"===e.type){var n=typeof e.codedValues[0].code;if("string"===n&&l.isStringField(t)||"number"===n&&l.isNumericField(t))return!0}return!(!e||"range"!==e.type||!l.isNumericField(t))},t.prototype._getDomainForFeature=function(e){var t=this.layer,n=this.name,r=t.typeIdField,o=r===n,l=this.get("field.domain");if(o&&!l)return new i({name:"__internal-type-based-coded-value-domain__",codedValues:t.types.map((function(e){return{code:e.id,name:e.name}}))});var a=r&&t.getFieldDomain(n,{feature:e})||l,d=this.get("config.domain");return this._isDomainCompatible(d)?d:a},t.prototype._getComputedDomain=function(e,t){if(!t)return null;if("range"===t.type)return e;if("coded-value"===t.type){var n=t.codedValues.filter((function(t){return t.hasOwnProperty("code")&&t.code===e}));return n&&n.length?n[0].name:e}return null},n.__decorate([r.property({readOnly:!0,aliasOf:"field.alias"})],t.prototype,"alias",void 0),n.__decorate([r.property()],t.prototype,"cellValueFormatFunction",void 0),n.__decorate([r.property()],t.prototype,"cellValueValidatorFunction",void 0),n.__decorate([r.property()],t.prototype,"config",void 0),n.__decorate([r.property({readOnly:!0,aliasOf:"field.defaultValue"})],t.prototype,"defaultValue",void 0),n.__decorate([r.property({readOnly:!0,aliasOf:"field.description"})],t.prototype,"description",void 0),n.__decorate([r.property()],t.prototype,"direction",void 0),n.__decorate([r.property({readOnly:!0,dependsOn:["config","editingEnabled","field.editable"]})],t.prototype,"editable",null),n.__decorate([r.property()],t.prototype,"editingEnabled",void 0),n.__decorate([r.property()],t.prototype,"field",void 0),n.__decorate([r.property({readOnly:!0,dependsOn:["alias","config"]})],t.prototype,"header",null),n.__decorate([r.property({dependsOn:["config"]})],t.prototype,"hidden",null),n.__decorate([r.property()],t.prototype,"headerRenderFunction",void 0),n.__decorate([r.property()],t.prototype,"layer",void 0),n.__decorate([r.property({readOnly:!0,dependsOn:["messages"]})],t.prototype,"loadingMessage",null),n.__decorate([r.property({dependsOn:["field.length","config"]})],t.prototype,"maxLength",null),n.__decorate([r.property({readOnly:!0,aliasOf:"config.menuConfig"})],t.prototype,"menuConfig",void 0),n.__decorate([r.property({readOnly:!0,aliasOf:"field.name"})],t.prototype,"name",void 0),n.__decorate([r.property({readOnly:!0,aliasOf:"field.nullable"})],t.prototype,"nullable",void 0),n.__decorate([r.property()],t.prototype,"parseInputValueFunction",void 0),n.__decorate([r.property({readOnly:!0,aliasOf:"field.name"})],t.prototype,"path",void 0),n.__decorate([r.property({readOnly:!0,dependsOn:["field","config"]})],t.prototype,"required",null),n.__decorate([r.property({dependsOn:["config"]})],t.prototype,"sortable",null),n.__decorate([r.property({readOnly:!0,aliasOf:"field.type"})],t.prototype,"type",void 0),n.__decorate([r.property()],t.prototype,"updateRowItemFunction",void 0),t=n.__decorate([r.subclass("esri.widgets.FeatureTable.FieldColumn")],t)}(d)}));