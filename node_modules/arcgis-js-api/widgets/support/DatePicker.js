// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../intl","../../core/events","../../core/accessorSupport/decorators","../../intl/moment","../Widget","./DatePickerViewModel","./Popover","./widget"],(function(e,t,a,o,r,i,s,n,d,c,l){var h="esri-date-picker",_="esri-date-picker__calendar",u="esri-date-picker__month-picker",p="esri-date-picker__day-picker",y="esri-date-picker__week-item",v="esri-date-picker__day-item--nearby-month",f="esri-date-picker__day-item--active",m="esri-date-picker__day-item--today",k="esri-date-picker__day-item--selected",D="esri-date-picker__day-item",g="esri-date-picker__day-item--header",b="esri-date-picker__year-picker",w="esri-date-picker__year-picker-item--selected",P="esri-date-picker__year-picker-item",x="esri-date-picker__month-dropdown",O="esri-date-picker__date",M="esri-date-picker__calendar-toggle",N="esri-icon-down-arrow",B="esri-icon-up-arrow",A="esri-icon-left",C="esri-icon-right",S="esri-widget",Y="esri-widget--button",T="esri-select",F={year:"numeric",month:"2-digit",day:"2-digit"},U=[" ","ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Enter","Home","PageDown","PageUp"],I="onfocusout"in HTMLElement.prototype;return function(e){function t(t,a){var o=e.call(this,t,a)||this;return o._activeDate=null,o._calendarNode=null,o._calendarPopover=new c({owner:o,placement:"bottom-start",anchorElement:function(){return o._rootNode},renderContentFunction:o._renderCalendar}),o._closedByUserAction=!1,o._isOpen=!1,o._rootNode=null,o.label=void 0,o.messages=null,o.value=null,o.commitOnMonthChange=!1,o.viewModel=new d,o._handleDatePickerBlur=I?null:o._handleDatePickerBlurOrFocusOut,o._handleDatePickerFocusOut=I?o._handleDatePickerBlurOrFocusOut:null,o}return a.__extends(t,e),t.prototype.loadLocale=function(){return a.__awaiter(this,void 0,void 0,(function(){var e;return a.__generator(this,(function(t){switch(t.label){case 0:return e=this,[4,s.loadMoment()];case 1:return e._moment=t.sent(),this._isOpen&&(this._activeDate=this._moment(this._activeDate.toDate())),[2]}}))}))},t.prototype.destroy=function(){this._calendarPopover.destroy()},t.prototype.render=function(){var e,t=o.formatDate(this.viewModel.value,F),a=this._isOpen,r=((e={})[N]=!a,e[B]=a,e);return l.tsx("div",{afterCreate:l.storeNode,bind:this,class:this.classes(h,S),"data-node-ref":"_rootNode"},l.tsx("div",{afterUpdate:this._focusSelectedOrClosed,"aria-pressed":a.toString(),bind:this,class:this.classes(Y,M),onclick:this._toggle,onkeydown:this._toggle,role:"button",tabIndex:0},l.tsx("span",{class:O},t),l.tsx("span",{"aria-hidden":"true",class:this.classes(r)})))},t.prototype._focusSelectedOrClosed=function(e){this._closedByUserAction&&(this._closedByUserAction=!1,e.focus())},t.prototype._handleDatePickerKeydown=function(e){"Escape"===r.eventKey(e)&&(this._closedByUserAction=!0,this._close(),e.preventDefault(),e.stopPropagation())},t.prototype._renderCalendar=function(){var e=this._activeDate,t=this._moment(this.viewModel.value);return l.tsx("div",{afterCreate:l.storeNode,bind:this,class:this.classes(_,S),"data-node-ref":"_calendarNode",key:"esri-date-picker__calendar",onkeydown:this._handleDatePickerKeydown},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))},t.prototype._handleDatePickerBlurOrFocusOut=function(e){if(!(e.currentTarget!==e.target)){var t=e.relatedTarget;this._calendarNode.contains(t)||this._rootNode.contains(t)||this._close()}},t.prototype._renderMonthPicker=function(e){var t=l.isRTL(),a=t?C:A,o=t?A:C,r=this._moment.months().map((function(t,a){var o=e.month()===a;return l.tsx("option",{selected:o},t)})),i=this.messages;return l.tsx("div",{class:u},l.tsx("div",{"aria-label":i.goToPreviousMonth,bind:this,class:Y,onblur:this._handleDatePickerBlur,onclick:this._setPreviousMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setPreviousMonth,role:"button",tabIndex:0,title:i.goToPreviousMonth},l.tsx("span",{"aria-hidden":"true",class:a})),l.tsx("select",{"aria-live":"assertive",bind:this,class:this.classes(x,T),id:this.id+"__month-picker",onblur:this._handleDatePickerBlur,onchange:this._setMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setMonth},r),l.tsx("div",{"aria-label":i.goToNextMonth,bind:this,class:Y,onblur:this._handleDatePickerBlur,onclick:this._setNextMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setNextMonth,role:"button",tabIndex:0,title:i.goToNextMonth},l.tsx("span",{"aria-hidden":"true",class:o})))},t.prototype._renderDayPicker=function(e,t){var a=this,o=e.clone().day(this._moment.localeData().firstDayOfWeek()),r=this._getWeekLabels(o),i=this._getDayId(e),s=this._renderMonth(e,t);return l.tsx("div",{afterCreate:this._handleDayPickerCreate,"aria-activedescendant":i,"aria-labelledby":this.id+"__month-picker "+this.id+"__selected-year",bind:this,class:p,id:this.id+"__day-picker",onblur:this._handleDatePickerBlur,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:0},l.tsx("div",{class:y,role:"row"},r.map((function(e){return l.tsx("div",{"aria-label":e.name,class:a.classes(D,g),role:"columnheader",title:e.name},e.abbr)}))),s)},t.prototype._getDayId=function(e){return this.id+"__"+o.formatDate(e.valueOf(),F)},t.prototype._handleDayPickerCreate=function(e){e.focus()},t.prototype._getWeekLabels=function(e){for(var t=[],a={weekday:"long"},r={weekday:"narrow"},i=0;i<7;i++)t.push({name:o.formatDate(e.valueOf(),a),abbr:o.formatDate(e.valueOf(),r)}),e.add(1,"day");return t},t.prototype._handleDayPickerKeydown=function(e){var t=e.ctrlKey,a=e.shiftKey,o=r.eventKey(e),i=this._activeDate;if(-1!==U.indexOf(o)){if("ArrowLeft"===o)i.subtract(1,"day");else if("ArrowRight"===o)i.add(1,"day");else if("ArrowUp"===o)i.subtract(1,"week");else if("ArrowDown"===o)i.add(1,"week");else if("PageUp"===o){var s=a?"year":"month";i.subtract(1,s)}else if("PageDown"===o){s=a?"year":"month";i.add(1,s)}else if("Home"===o){s=t?"year":"month";i.startOf(s)}else if("End"===o){s=t?"year":"month";i.endOf(s)}else"Enter"!==o&&" "!==o||(this.viewModel.value=i.toDate(),this._closedByUserAction=!0,this._close());e.preventDefault(),e.stopPropagation()}},t.prototype._renderMonth=function(e,t){for(var a,o=this._moment(),r=e.clone().startOf("month"),i=e.clone().endOf("month"),s=r.clone().subtract(r.weekday(),"day"),n=[],d=0;d<6;d++){for(var c=[],h=0;h<7;h++){var _=s.date(),u=s.isSame(e,"day"),p=s.isSame(t,"day"),g=this._getDayId(s),b=((a={})[v]=!s.isBetween(r,i,null,"[]"),a[m]=s.isSame(o,"day"),a[f]=u,a[k]=p,a);c.push(l.tsx("div",{"aria-label":_.toString(),"aria-selected":u.toString(),bind:this,class:this.classes(D,b),"data-iso-date":s.toISOString(),id:g,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},_)),s.add(1,"day")}n.push(l.tsx("div",{class:y,role:"row"},c))}return n},t.prototype._renderYearPicker=function(e){var t={year:"numeric"},a=e.clone(),r=o.formatDate(a.valueOf(),t),i=o.formatDate(a.add(1,"year").valueOf(),t),s=o.formatDate(a.subtract(2,"year").valueOf(),t),n=this.messages;return l.tsx("div",{class:b},l.tsx("div",{"aria-label":n.goToPreviousYear,bind:this,class:P,onblur:this._handleDatePickerBlur,onclick:this._setPreviousYear,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setPreviousYear,tabIndex:0,title:n.goToPreviousYear},s),l.tsx("div",{class:this.classes(P,w),id:this.id+"__selected-year"},r),l.tsx("div",{"aria-label":n.goToNextYear,bind:this,class:P,onblur:this._handleDatePickerBlur,onclick:this._setNextYear,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setNextYear,tabIndex:0,title:n.goToNextYear},i))},t.prototype._toggle=function(){this._isOpen?this._close():this._open(this.viewModel.value)},t.prototype._setMonth=function(e){var t=e.target.value;this._activeDate.month(t),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())},t.prototype._close=function(){this._activeDate=null,this._isOpen=!1,this._calendarPopover.open=!1},t.prototype._open=function(e){this._activeDate=this._moment(e),this._isOpen=!0,this._calendarPopover.open=!0},t.prototype._setPreviousMonth=function(){this._activeDate.subtract(1,"month"),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())},t.prototype._setNextMonth=function(){this._activeDate.add(1,"month"),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())},t.prototype._setPreviousYear=function(){this._activeDate.subtract(1,"year")},t.prototype._setNextYear=function(){this._activeDate.add(1,"year")},t.prototype._handleSelectedDate=function(e){var t=e.target;this.viewModel.value=this._moment(t.getAttribute("data-iso-date")).toDate(),this._closedByUserAction=!0,this._close()},a.__decorate([i.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],t.prototype,"label",void 0),a.__decorate([i.property(),l.renderable(),l.messageBundle("esri/widgets/support/t9n/DatePicker")],t.prototype,"messages",void 0),a.__decorate([i.aliasOf("viewModel.value")],t.prototype,"value",void 0),a.__decorate([i.property()],t.prototype,"commitOnMonthChange",void 0),a.__decorate([i.property({type:d}),l.renderable("viewModel.value")],t.prototype,"viewModel",void 0),a.__decorate([l.accessibleHandler()],t.prototype,"_toggle",null),a.__decorate([l.accessibleHandler()],t.prototype,"_setPreviousMonth",null),a.__decorate([l.accessibleHandler()],t.prototype,"_setNextMonth",null),a.__decorate([l.accessibleHandler()],t.prototype,"_setPreviousYear",null),a.__decorate([l.accessibleHandler()],t.prototype,"_setNextYear",null),a.__decorate([l.accessibleHandler()],t.prototype,"_handleSelectedDate",null),t=a.__decorate([i.subclass("esri.widgets.support.DatePicker")],t)}(n)}));