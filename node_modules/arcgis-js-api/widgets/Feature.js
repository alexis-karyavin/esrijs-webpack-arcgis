// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../intl","../core/events","../core/throttle","../core/watchUtils","../core/accessorSupport/decorators","./Attachments","./Widget","./Feature/FeatureContent","./Feature/FeatureFields","./Feature/FeatureViewModel","./Feature/support/FeatureContentMixin","./Feature/support/featureUtils","./support/chartUtils","./support/widget","./support/widgetUtils"],(function(e,t,i,r,n,s,a,o,l,d,c,u,p,h,_,f,m,v){var y="esri-icon-font-fallback-text",g="esri-icon-loading-indicator esri-rotating",M="esri-icon-left-triangle-arrow",x="esri-icon-right-triangle-arrow",b="esri-widget",w="esri-feature",C="esri-feature__size-container",T="esri-feature__title",I="esri-feature__main-container",E="esri-feature__button",k="esri-feature__icon",F="esri-feature__content-element",R="esri-feature__text",A="esri-feature__last-edited-info",L="esri-feature--media-pagination-visible",U="esri-feature__attachments",W="esri-feature__media",P="esri-feature__media-container",K="esri-feature__media-item-container",S="esri-feature__media-item",z="esri-feature__media-item-title",B="esri-feature__media-item-caption",V="esri-feature__media-previous",O="esri-feature__media-previous-icon",X="esri-feature__media-previous-icon--rtl",Y="esri-feature__media-next",N="esri-feature__media-next-icon",D="esri-feature__media-next-icon--rtl",H="esri-feature__media-chart",j="esri-feature__loading-container",q="esri-feature__loading-spinner",G={title:!0,content:!0,lastEditedInfo:!0};return function(e){function t(t,r){var n=e.call(this,t,r)||this;return n._chartUIds=new Map,n._contentElementCharts=new Map,n._activeMediaMap=new Map,n._refreshTimers=new Map,n._mediaInfo=new Map,n._renderChartThrottled=s.throttle((function(e){return n._renderChart(e)}),100),n._contentWidgets=[],n.graphic=null,n.defaultPopupTemplateEnabled=!1,n.label=void 0,n.messages=null,n.messagesURIUtils=null,n.spatialReference=null,n.title=null,n.visibleElements=i.__assign({},G),n.map=null,n.view=null,n.viewModel=new p,n}return i.__extends(t,e),t.prototype.initialize=function(){var e=this;this.own(a.init(this,"viewModel.content",(function(){e._setupMediaRefreshTimers(),e._setupContentWidgets()})),a.init(this,"viewModel.graphic",(function(){return e._disposeCharts()})))},t.prototype.destroy=function(){this._clearMediaRefreshTimers(),this._activeMediaMap.clear(),this._activeMediaMap=null,this._destroyContentWidgets(),this._disposeCharts()},t.prototype.castVisibleElements=function(e){return i.__assign(i.__assign({},G),e)},t.prototype.render=function(){var e=this.viewModel.waitingForContent;return m.tsx("div",{class:this.classes(w,b)},m.tsx("div",{class:C},this.renderTitle(),e?this.renderLoading():this.renderContentContainer()))},t.prototype.goToMedia=function(e,t){this._setContentElementMedia(e,t)},t.prototype.nextMedia=function(e){this._pageContentElementMedia(e,"next")},t.prototype.previousMedia=function(e){this._pageContentElementMedia(e,"previous")},t.prototype.renderLoading=function(){return m.tsx("div",{key:"loading-container",class:j},m.tsx("span",{class:this.classes(g,q)}))},t.prototype.renderContentContainer=function(){return this.visibleElements.content?m.tsx("div",{class:I},[this.renderContent(),this.renderLastEditInfo()]):null},t.prototype.renderTitle=function(){var e=this.visibleElements,t=this.title;return e.title?m.tsx("h4",{class:T,innerHTML:t}):null},t.prototype.renderContent=function(){var e=this.viewModel.content;if(!e)return null;if(Array.isArray(e))return e.length?m.tsx("div",{key:"content-content-elements"},e.map(this.renderContentElement,this)):null;if("string"==typeof e){var t=this._contentWidgets[0];return!t||t.destroyed?null:m.tsx("div",{key:"content-content"},t.render())}return this.renderNodeContent(e)},t.prototype.renderContentElement=function(e,t){var i=this.visibleElements;if("boolean"!=typeof i.content&&!i.content[e.type])return null;switch(e.type){case"attachments":return this.renderAttachments(t);case"custom":return this.renderCustom(e,t);case"fields":return this.renderFields(t);case"media":return this.renderMedia(e,t);case"text":return this.renderText(e,t);default:return null}},t.prototype.renderAttachments=function(e){var t=this._contentWidgets[e];if(!t||t.destroyed)return null;var i=t.viewModel,r=i.state,n=i.attachmentInfos;return"loading"===r||n.length>0?m.tsx("div",{key:this._buildKey("attachments-element",e),class:this.classes(U,F)},m.tsx("h2",null,this.messages.attach),t.render()):null},t.prototype.renderCustom=function(e,t){var i=e.creator,r=this._contentWidgets[t];return!r||r.destroyed?null:i?m.tsx("div",{key:this._buildKey("custom-element",t),class:F},r.render()):null},t.prototype.renderFields=function(e){var t=this._contentWidgets[e];return!t||t.destroyed?null:m.tsx("div",{key:this._buildKey("fields-element",e),class:F},t.render())},t.prototype.renderMediaInfoType=function(e){var t=e.mediaInfo,i=e.total,r=e.contentElementIndex,n=e.activeMediaIndex;if(!t)return null;var s=t.title,a=void 0===s?"":s,o=t.altText,l=void 0===o?"":o;if("image"===t.type){var d=t,c=d.value,u=d.refreshInterval,p=c.sourceURL,h=c.linkURL,f=_.shouldOpenInNewTab(h)?"_blank":"_self",v="_blank"===f?"noreferrer":"",y=u?this._mediaInfo.get(r):null,g=y?y.timestamp:0,M=y?y.sourceURL:p,x=m.tsx("img",{alt:l||a,key:this._buildKey(t.type,i,r,n,g),src:M}),b=h?m.tsx("a",{title:a,href:h,rel:v,target:f},x):null;return b||x}return-1!==t.type.indexOf("chart")?m.tsx("div",{key:this._buildKey(t.type,i,r,n),bind:this,"data-media-info":t,"data-content-element-index":r,class:H,afterCreate:this._getChartDependencies,afterRemoved:this._disposeChartByNode}):void 0},t.prototype.renderMediaInfo=function(e){var t=e.total,i=e.mediaInfo,r=e.contentElementIndex,n=e.activeMediaIndex;if(!i)return null;var s=i.title?m.tsx("div",{key:this._buildKey("media-title",i.type,t,r),class:z,innerHTML:i.title}):null,a=i.caption?m.tsx("div",{key:this._buildKey("media-caption",i.type,t,r),class:B,innerHTML:i.caption}):null;return m.tsx("div",{key:this._buildKey("media-container",i.type,t,r),class:K},s,a,m.tsx("div",{key:this._buildKey("media-item-container",i.type,t,r),class:S},this.renderMediaInfoType({total:t,mediaInfo:i,contentElementIndex:r,activeMediaIndex:n})))},t.prototype.renderMediaPageButton=function(e,t){var i="previous"===e,r=i?this.messages.previous:this.messages.next,n=i?this.classes(E,V):this.classes(E,Y),s=i?this.classes(k,O,M):this.classes(k,N,x),a=i?this.classes(k,X,x):this.classes(k,D,M),o=i?"media-previous":"media-next",l=i?this._previousClick:this._nextClick;return m.tsx("div",{key:this._buildKey(o,t),title:r,tabIndex:0,role:"button",class:n,"data-content-element-index":t,bind:this,onkeydown:l,onclick:l},m.tsx("span",{"aria-hidden":"true",class:s}),m.tsx("span",{"aria-hidden":"true",class:a}),m.tsx("span",{class:y},r))},t.prototype.renderMedia=function(e,t){var i,r,n=null===(r=e.mediaInfos)||void 0===r?void 0:r.filter(Boolean),s=(null==n?void 0:n.length)||0,a=((i={})[L]=s>1,i),o=this.renderMediaPageButton("previous",t),l=this.renderMediaPageButton("next",t),d=this._activeMediaMap.get(t);return isNaN(d)&&(this._activeMediaMap.set(t,0),d=0),s?m.tsx("div",{key:this._buildKey("media-element",t),"data-content-element-index":t,bind:this,onkeyup:this._handleMediaKeyup,class:this.classes(W,F,a)},m.tsx("div",{key:this._buildKey("media-element-container",t),class:P},o,this.renderMediaInfo({total:s,mediaInfo:n[d],contentElementIndex:t,activeMediaIndex:d}),l)):null},t.prototype.renderLastEditInfo=function(){var e=this.visibleElements,t=this.messages,i=this.viewModel.lastEditInfo;if(!i||!e.lastEditedInfo)return null;var n=i.date,s=i.user,a="edit"===i.type?s?t.lastEditedByUser:t.lastEdited:s?t.lastCreatedByUser:t.lastCreated,o=r.substitute(a,{date:n,user:s});return m.tsx("div",{key:"edit-info-element",class:this.classes(A,F)},o)},t.prototype.renderText=function(e,t){var i=e.text,r=this._contentWidgets[t];return!r||r.destroyed?null:i?m.tsx("div",{key:this._buildKey("text-element",t),class:this.classes(F,R)},r.render()):null},t.prototype._buildKey=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var r=this.get("viewModel.graphic.uid")||"0",n=t.join("-");return e+"__"+r+"-"+n},t.prototype._disposeCharts=function(){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(e){return this._chartUIds.forEach((function(e){return e.dispose()})),this._chartUIds.clear(),this._contentElementCharts.forEach((function(e){return e.dispose()})),this._contentElementCharts.clear(),[2]}))}))},t.prototype._clearMediaRefreshTimers=function(){this._refreshTimers.forEach((function(e){return clearTimeout(e)})),this._refreshTimers.clear()},t.prototype._clearMediaRefreshTimer=function(e){var t=this._refreshTimers.get(e);t&&(clearTimeout(t),this._refreshTimers.delete(e))},t.prototype._getImageSource=function(e,t){var i=-1!==e.indexOf("?")?"&":"?",r=e.split("#"),n=r[0],s=r[1],a=void 0===s?"":s;return""+n+i+"timestamp="+t+(a?"#":"")+a},t.prototype._setupMediaRefreshTimer=function(e){var t=this.get("viewModel.content");if(Array.isArray(t)){var i=t[e];if(i&&"media"===i.type){var r=this._activeMediaMap.get(e);isNaN(r)&&(r=0);var n=i.mediaInfos[r];n&&"image"===n.type&&n.refreshInterval&&this._setRefreshTimeout(e,n)}}},t.prototype._destroyContentWidgets=function(){this._contentWidgets.forEach((function(e){return e&&!e.destroyed&&e.destroy()})),this._contentWidgets=[]},t.prototype._setupContentWidgets=function(){var e=this;this._destroyContentWidgets(),this._activeMediaMap.clear();var t=this.get("viewModel.content"),i=this.viewModel.contentVMs;if(Array.isArray(t))t.forEach((function(t,r){"attachments"===t.type&&(e._contentWidgets[r]=new l({displayType:t.displayType,viewModel:i[r]})),"fields"===t.type&&(e._contentWidgets[r]=new u({viewModel:i[r]})),"text"===t.type&&(e._contentWidgets[r]=new c({viewModel:i[r]})),"custom"===t.type&&(e._contentWidgets[r]=new c({viewModel:i[r]}))}),this);else{var r=i[0];r&&!r.destroyed&&(this._contentWidgets[0]=new c({viewModel:r}))}this.scheduleRender()},t.prototype._setupMediaRefreshTimers=function(){var e=this;this._clearMediaRefreshTimers();var t=this.get("viewModel.content");Array.isArray(t)&&t.forEach((function(t,i){return e._setupMediaRefreshTimer(i)}))},t.prototype._updateMediaInfoTimestamp=function(e,t){var i=Date.now();this._mediaInfo.set(t,{timestamp:i,sourceURL:this._getImageSource(e,i)}),this.scheduleRender()},t.prototype._setRefreshTimeout=function(e,t){var i=this,r=t.refreshInterval,n=t.value;if(r){var s=6e4*r;this._updateMediaInfoTimestamp(n.sourceURL,e);var a=setInterval((function(){i._updateMediaInfoTimestamp(n.sourceURL,e)}),s);this._refreshTimers.set(e,a)}},t.prototype._getChartDependencies=function(e){var t=this,i=e["data-media-info"],r=e["data-content-element-index"];this._disposeChartByNode(e),this._disposeChartByContgentElementIndex(r);var n=i.value,s=i.type;f.loadChartsModule().then((function(a){return t._renderChartThrottled({chartDiv:e,mediaInfo:i,contentElementIndex:r,type:s,value:n,chartsModule:a})}))},t.prototype._disposeChartByContgentElementIndex=function(e){var t=this._contentElementCharts.get(e);t&&t.dispose()},t.prototype._disposeChartByNode=function(e){var t=e.getAttribute("data-chart-uid"),i=this._chartUIds.get(t);i&&i.dispose()},t.prototype._customizeChartTooltip=function(e,t){e.label.wrap=!0,e.label.maxWidth=200,e.autoTextColor=!1,e.getFillFromObject=!1,e.label.fill=t.color("#ffffff"),e.background.fill=t.color({r:0,g:0,b:0,a:.7})},t.prototype._createPieChart=function(e){var t=e.chartDiv,i=e.chartsModule,r=i.am4core,n=i.am4charts,s=r.create(t,n.PieChart);s.rtl=v.isRTL();var a=s.series.push(new n.PieSeries);return a.labels.template.disabled=!0,a.ticks.template.disabled=!0,a.dataFields.value="y",a.dataFields.category="x",this._customizeChartTooltip(a.tooltip,r),s},t.prototype._getMinSeriesValue=function(e){var t=0;return e.forEach((function(e){return t=Math.min(e.x,t)})),t},t.prototype._createXYChart=function(e){var t=e.chartDiv,i=e.type,r=e.value,n=e.chartsModule,s=n.am4core,a=n.am4charts,o=s.create(t,a.XYChart);o.rtl=v.isRTL();var l=r.series.length>15;if("column-chart"===i){var d=o.xAxes.push(new a.CategoryAxis);d.dataFields.category="x",d.renderer.labels.template.disabled=!0,this._customizeChartTooltip(d.tooltip,s),d.tooltip.events.on("sizechanged",(function(){d.tooltip.dy=-d.tooltip.contentHeight}));var c=(h=o.yAxes.push(new a.ValueAxis)).renderer.labels.template;h.renderer.minLabelPosition=.05,h.renderer.maxLabelPosition=.95,h.min=this._getMinSeriesValue(r.series),this._customizeChartTooltip(h.tooltip,s),c.wrap=!0,(_=o.series.push(new a.ColumnSeries)).dataFields.valueY="y",_.dataFields.categoryX="x",o.cursor=new a.XYCursor,l&&(o.scrollbarX=new s.Scrollbar)}if("bar-chart"===i){var u=o.yAxes.push(new a.CategoryAxis);u.dataFields.category="x",u.renderer.inversed=!0,u.renderer.labels.template.disabled=!0,this._customizeChartTooltip(u.tooltip,s),u.tooltip.events.on("sizechanged",(function(){u.tooltip.dx=u.tooltip.contentWidth}));c=(h=o.xAxes.push(new a.ValueAxis)).renderer.labels.template;h.renderer.minLabelPosition=.05,h.renderer.maxLabelPosition=.95,h.min=this._getMinSeriesValue(r.series),this._customizeChartTooltip(h.tooltip,s),c.wrap=!0,(_=o.series.push(new a.ColumnSeries)).dataFields.valueX="y",_.dataFields.categoryY="x",o.cursor=new a.XYCursor,l&&(o.scrollbarY=new s.Scrollbar)}if("line-chart"===i){var p=o.xAxes.push(new a.CategoryAxis);p.dataFields.category="x",p.renderer.labels.template.disabled=!0,this._customizeChartTooltip(p.tooltip,s),p.tooltip.events.on("sizechanged",(function(){p.tooltip.dy=-p.tooltip.contentHeight}));var h,_;c=(h=o.yAxes.push(new a.ValueAxis)).renderer.labels.template;h.renderer.minLabelPosition=.05,h.renderer.maxLabelPosition=.95,h.min=this._getMinSeriesValue(r.series),this._customizeChartTooltip(h.tooltip,s),c.wrap=!0,(_=o.series.push(new a.LineSeries)).dataFields.categoryX="x",_.dataFields.valueY="y",o.cursor=new a.XYCursor,l&&(o.scrollbarX=new s.Scrollbar)}return o},t.prototype._renderChart=function(e){var t=e.type,i=e.mediaInfo,r=e.contentElementIndex,n=e.value,s=e.chartsModule,a=e.chartDiv;s.am4core.useTheme(s.am4themes_animated);var o="pie-chart"===t?this._createPieChart(e):this._createXYChart(e);this._chartUIds.set(o.uid,o),this._contentElementCharts.set(r,o),a.setAttribute("data-chart-uid",o.uid),a.setAttribute("aria-label",i.altText||i.title),o.data=n.series.map((function(e){return{x:e.tooltip,y:e.y}}))},t.prototype._handleMediaKeyup=function(e){var t=e.currentTarget["data-content-element-index"],i=n.eventKey(e);"ArrowLeft"===i&&(e.stopPropagation(),this.previousMedia(t)),"ArrowRight"===i&&(e.stopPropagation(),this.nextMedia(t))},t.prototype._setContentElementMedia=function(e,t){this._clearMediaRefreshTimer(e);var i=this.viewModel.content,r=i&&i[e],n=r&&r.mediaInfos;if(n&&n.length){var s=(t+n.length)%n.length;this._activeMediaMap.set(e,s),this._setupMediaRefreshTimer(e),this.scheduleRender()}},t.prototype._pageContentElementMedia=function(e,t){var i="previous"===t?-1:1,r=this._activeMediaMap.get(e)+i;this._setContentElementMedia(e,r)},t.prototype._previousClick=function(e){var t=e.currentTarget["data-content-element-index"];this.previousMedia(t)},t.prototype._nextClick=function(e){var t=e.currentTarget["data-content-element-index"];this.nextMedia(t)},i.__decorate([o.aliasOf("viewModel.graphic")],t.prototype,"graphic",void 0),i.__decorate([o.aliasOf("viewModel.defaultPopupTemplateEnabled")],t.prototype,"defaultPopupTemplateEnabled",void 0),i.__decorate([o.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],t.prototype,"label",void 0),i.__decorate([o.property(),m.renderable(),m.messageBundle("esri/widgets/Feature/t9n/Feature")],t.prototype,"messages",void 0),i.__decorate([o.property(),m.renderable(),m.messageBundle("esri/widgets/support/t9n/uriUtils")],t.prototype,"messagesURIUtils",void 0),i.__decorate([o.aliasOf("viewModel.spatialReference")],t.prototype,"spatialReference",void 0),i.__decorate([o.aliasOf("viewModel.title")],t.prototype,"title",void 0),i.__decorate([o.property(),m.renderable()],t.prototype,"visibleElements",void 0),i.__decorate([o.cast("visibleElements")],t.prototype,"castVisibleElements",null),i.__decorate([o.aliasOf("viewModel.map")],t.prototype,"map",void 0),i.__decorate([o.aliasOf("viewModel.view")],t.prototype,"view",void 0),i.__decorate([o.property({type:p}),m.renderable(["viewModel.waitingForContent","viewModel.content","viewModel.lastEditInfo","viewModel.contentVMs"])],t.prototype,"viewModel",void 0),i.__decorate([m.accessibleHandler()],t.prototype,"_previousClick",null),i.__decorate([m.accessibleHandler()],t.prototype,"_nextClick",null),t=i.__decorate([o.subclass("esri.widgets.Feature")],t)}(h.FeatureContentMixin(d))}));