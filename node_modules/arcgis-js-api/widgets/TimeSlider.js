// COPYRIGHT © 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../TimeInterval","../core/arrayUtils","../core/Collection","../core/compilerUtils","../core/Error","../core/events","../core/mathUtils","../core/maybe","../core/throttle","../core/watchUtils","../core/accessorSupport/decorators","../intl/date","../layers/support/timeUtils","./Slider","./Widget","./support/widget","./TimeSlider/TimeSliderViewModel"],(function(e,t,i,r,s,n,o,a,l,u,m,d,c,v,p,f,h,w,y,_){var b="esri-icon-time-clock",x="esri-widget",g="esri-widget--button",k="esri-button--disabled",T="esri-disabled",S="esri-time-slider",j="esri-time-slider__mode--",M="esri-time-slider__layout--",O="esri-time-slider__row",C="esri-time-slider__animation",E="esri-time-slider__animation-button",D="esri-icon-play",F="esri-icon-pause",V="esri-time-slider__time-extent",R="esri-time-slider__time-extent-group",L="esri-time-slider__time-extent-date",P="esri-time-slider__time-extent-time",U="esri-time-slider__time-extent-separator",I="esri-time-slider__min",q="esri-time-slider__min-date",H="esri-time-slider__slider",W="majorTick",z="minorTick",A="esri-time-slider__max",B="esri-time-slider__max-date",N="esri-time-slider__previous",G="esri-time-slider__previous-button",J="esri-icon-reverse",K="esri-time-slider__next",Q="esri-time-slider__next-button",X="esri-icon-forward",Y=new n([{minor:new r({value:100,unit:"milliseconds"}),major:new r({value:1,unit:"seconds"}),format:{second:"numeric"}},{minor:new r({value:500,unit:"milliseconds"}),major:new r({value:5,unit:"seconds"}),format:{second:"numeric"}},{minor:new r({value:1,unit:"seconds"}),major:new r({value:20,unit:"seconds"}),format:{minute:"numeric",second:"numeric"}},{minor:new r({value:2,unit:"seconds"}),major:new r({value:30,unit:"seconds"}),format:{minute:"numeric",second:"numeric"}},{minor:new r({value:10,unit:"seconds"}),major:new r({value:1,unit:"minutes"}),format:{minute:"numeric"}},{minor:new r({value:15,unit:"seconds"}),major:new r({value:5,unit:"minutes"}),format:{hour:"numeric",minute:"numeric"}},{minor:new r({value:1,unit:"minutes"}),major:new r({value:20,unit:"minutes"}),format:{hour:"numeric",minute:"numeric"}},{minor:new r({value:5,unit:"minutes"}),major:new r({value:2,unit:"hours"}),format:{hour:"numeric",minute:"numeric"}},{minor:new r({value:15,unit:"minutes"}),major:new r({value:6,unit:"hours"}),format:{hour:"numeric",minute:"numeric"}},{minor:new r({value:1,unit:"hours"}),major:new r({value:1,unit:"days"}),format:{day:"numeric",month:"short"}},{minor:new r({value:6,unit:"hours"}),major:new r({value:1,unit:"weeks"}),format:{day:"numeric",month:"short"}},{minor:new r({value:1,unit:"days"}),major:new r({value:1,unit:"months"}),format:{month:"long"}},{minor:new r({value:2,unit:"days"}),major:new r({value:1,unit:"months"}),format:{month:"short"}},{minor:new r({value:3,unit:"days"}),major:new r({value:1,unit:"months"}),format:{month:"short"}},{minor:new r({value:4,unit:"days"}),major:new r({value:3,unit:"months"}),format:{month:"short",year:"numeric"}},{minor:new r({value:1,unit:"weeks"}),major:new r({value:1,unit:"years"}),format:{year:"numeric"}},{minor:new r({value:1,unit:"months"}),major:new r({value:1,unit:"years"}),format:{year:"numeric"}},{minor:new r({value:2,unit:"months"}),major:new r({value:2,unit:"years"}),format:{year:"numeric"}},{minor:new r({value:1,unit:"years"}),major:new r({value:1,unit:"decades"}),format:{year:"numeric"}},{minor:new r({value:2,unit:"years"}),major:new r({value:5,unit:"decades"}),format:{year:"numeric"}},{minor:new r({value:5,unit:"decades"}),major:new r({value:10,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new r({value:1,unit:"centuries"}),major:new r({value:10,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new r({value:2,unit:"centuries"}),major:new r({value:20,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new r({value:5,unit:"centuries"}),major:new r({value:50,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new r({value:10,unit:"centuries"}),major:new r({value:100,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new r({value:20,unit:"centuries"}),major:new r({value:200,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new r({value:50,unit:"centuries"}),major:new r({value:500,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new r({value:100,unit:"centuries"}),major:new r({value:1e3,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new r({value:200,unit:"centuries"}),major:new r({value:1e3,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new r({value:500,unit:"centuries"}),major:new r({value:5e3,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new r({value:1e3,unit:"centuries"}),major:new r({value:1e4,unit:"centuries"}),format:{era:"short",year:"numeric"}}]);return function(e){function t(t,i){var r=e.call(this,t,i)||this;return r._slider=new h({precision:0,visibleElements:{rangeLabels:!1},rangeLabelInputsEnabled:!1}),r._tickFormat=null,r.disabled=!1,r.effectiveStops=null,r.fullTimeExtent=null,r.iconClass=b,r.label=void 0,r.loop=!0,r.messages=null,r.messagesCommon=null,r.playRate=1e3,r.mode="time-window",r.stops={count:10},r.tickConfigs=null,r.timeExtent=null,r.timeVisible=!1,r.values=null,r.view=null,r.viewModel=new _,r}return i.__extends(t,e),t.prototype.initialize=function(){var e=this;this.own([this._slider.watch("values",(function(t){var i,r=null===(i=e.values)||void 0===i?void 0:i.map((function(e){return e.getTime()}));s.equals(t,r)||e.set("values",t.map((function(e){return new Date(e)})))})),l.on(window,"resize",d.throttle((function(){return e.scheduleRender()}),100)),c.init(this,"effectiveStops",(function(){return e._updateSliderSteps()})),c.init(this,["stops","fullTimeExtent"],(function(){return e._createDefaultValues()}))]),this._validateTimeExtent()},t.prototype.destroy=function(){this.view=null,this._slider.destroy(),this._tickFormat=null},Object.defineProperty(t.prototype,"interactive",{get:function(){return!this.disabled&&this.viewModel&&"disabled"!==this.viewModel.state},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"layout",{set:function(e){-1===["auto","compact","wide"].indexOf(e)&&(e="auto"),this._set("layout",e)},enumerable:!0,configurable:!0}),t.prototype.next=function(){},t.prototype.play=function(){},t.prototype.previous=function(){},t.prototype.stop=function(){return null},t.prototype.render=function(){var e=this,t=e._slider,i=e.domNode,r=e.effectiveStops,n=e.fullTimeExtent,o=e.interactive,a=e.mode,l=e.tickConfigs,u=e.timeVisible,d=e.values,c=e.viewModel,v=e.messagesCommon;if(null!=n){var f=n.start,h=n.end;if(null!=f&&null!=h){var w=f.getTime(),_=h.getTime(),b=t.min!==w||t.max!==_;if(b&&(t.min=w,t.max=_),null!=l)t.tickConfigs!==l&&(t.tickConfigs=l);else{var Z=(_-w)/(t.trackElement?t.trackElement.offsetWidth:400),$=Y.find((function(e){return e.minor.toMilliseconds()>3*Z})),ee=this._tickFormat!==$&&null!=$;if(ee&&(this._tickFormat=$),b||ee){var te={mode:"position",values:this._getTickPositions($.minor),labelsVisible:!1,tickCreatedFunction:function(e,t){t.classList.add(z)}},ie={mode:"position",values:this._getTickPositions($.major),labelsVisible:!0,tickCreatedFunction:function(e,t){t.classList.add(W)},labelFormatFunction:function(e){return p.formatDate(e,$.format)}};t.tickConfigs=[te,ie]}}}}var re=d?d.map((function(e){return e.getTime()})):null;s.equals(t.values,re)||(t.values=re),t.disabled=!o;var se=n&&n.start,ne=m.isSome(se)?this._formateDate(se):null,oe=u&&m.isSome(se)?this._formateTime(se):null,ae=n&&n.end,le=m.isSome(ae)?this._formateDate(ae):null,ue=u&&m.isSome(ae)?this._formateTime(ae):null,me=null,de=null,ce=null,ve=null;if(d&&d.length>0){var pe=d[0];me=this._formateDate(pe),u&&(de=this._formateTime(pe))}if("time-window"===a&&d&&d.length>1){pe=d[1];ce=this._formateDate(pe),u&&(ve=this._formateTime(pe))}var fe=c.state,he="ready"===fe,we="playing"===fe,ye=!o||0===r.length,_e=y.tsx("div",{class:C},y.tsx("button",{"aria-disabled":ye?"true":"false","aria-label":we?v.control.stop:v.control.play,bind:this,class:this.classes(g,E,ye&&k),disabled:ye,title:we?v.control.stop:v.control.play,onclick:this._playOrStopClick},y.tsx("div",{class:this.classes((he||ye)&&D,we&&F)}))),be=y.tsx("div",{class:this.classes(V,!o&&k)},m.isSome(me)&&y.tsx("div",{key:"start-date-group",class:R},y.tsx("div",{key:"start-date",class:L},me),m.isSome(de)&&y.tsx("div",{key:"start-time",class:P},de)),m.isSome(ce)&&y.tsx("div",{key:"separator",class:U},"–"),m.isSome(me)&&y.tsx("div",{key:"end-date-group",class:R},y.tsx("div",{key:"end-date",class:L},ce),m.isSome(ve)&&y.tsx("div",{key:"end-time",class:P},ve))),xe=y.tsx("div",{class:this.classes(I,!o&&k)},m.isSome(ne)&&y.tsx("div",{key:"min-date",class:q},ne),m.isSome(oe)&&y.tsx("div",{key:"min-time"},oe)),ge=y.tsx("div",{class:H},t.render()),ke=y.tsx("div",{class:this.classes(A,!o&&k)},m.isSome(le)&&y.tsx("div",{key:"max-date",class:B},le),m.isSome(ue)&&y.tsx("div",{key:"max-time"},ue)),Te=y.tsx("div",{class:N},y.tsx("button",{"aria-disabled":ye?"true":"false","aria-label":v.pagination.previous,bind:this,class:this.classes(g,G,(we||ye)&&k),disabled:ye,title:v.pagination.previous,onclick:this._previousClick},y.tsx("div",{class:J}))),Se=y.tsx("div",{class:K},y.tsx("button",{"aria-disabled":ye?"true":"false","aria-label":v.pagination.next,bind:this,class:this.classes(g,Q,(we||ye)&&k),disabled:ye,title:v.pagination.next,onclick:this._nextClick},y.tsx("div",{class:X}))),je="auto"===this.layout?i.clientWidth<858?"compact":"wide":this.layout;return y.tsx("div",{class:this.classes(S,x,""+j+a,""+M+je,!o&&T)},"wide"===je&&y.tsx("div",{class:O},[_e,be,xe,ge,ke,Te,Se]),"compact"===je&&[y.tsx("div",{key:"time-slider-row-1",class:O},[be]),y.tsx("div",{key:"time-slider-row-2",class:O},[ge]),y.tsx("div",{key:"time-slider-row-3",class:O},[xe,Te,_e,Se,ke])])},t.prototype._createDefaultValues=function(){var e=this.fullTimeExtent,t=this.effectiveStops,i=this.mode,r=this.values;e&&t&&i&&!r&&(this.values="time-window"===i?t.length>1?[t[0],t[1]]:null:t.length>0?[t[0]]:null)},t.prototype._getTickPositions=function(e){for(var t=this.fullTimeExtent,i=t.start,r=t.end,s=[],n=e.value,o=e.unit,a=f.truncateDate(i,o);a.getTime()<=r.getTime();)a.getTime()>=i.getTime()&&s.push(a.getTime()),a=f.offsetDate(a,n,o);return s},t.prototype._formateDate=function(e){return p.formatDate(e,p.convertDateFormatToIntlOptions("short-date"))},t.prototype._formateTime=function(e){return p.formatDate(e,p.convertDateFormatToIntlOptions("long-time"))},t.prototype._updateSliderSteps=function(){this._slider.steps=this.effectiveStops&&this.effectiveStops.length>0?this.effectiveStops.map((function(e){return e.getTime()})):null},t.prototype._validateTimeExtent=function(){var e=this;if(this.fullTimeExtent&&this.mode&&this.values){if(!Array.isArray(this.values))throw new a("time-slider:invalid-values","Values must be an array of dates.");if(0===this.values.length||this.values.some((function(e){return!(e instanceof Date)})))throw new a("time-slider:invalid-values","Values must be an array of dates.");switch(this.values=this.values.map((function(t){var i=t.getTime(),r=u.clamp(i,e.fullTimeExtent.start.getTime(),e.fullTimeExtent.end.getTime());return new Date(r)})),this.mode){case"instant":case"cumulative-from-start":case"cumulative-from-end":this.values.length>1&&this.values.splice(1);break;case"time-window":1===this.values.length?this.values.push(this.fullTimeExtent.end):this.values.length>2&&this.values.splice(2),this.values.sort((function(e,t){return e.getTime()-t.getTime()}));break;default:o.neverReached(this.mode)}}},t.prototype._playOrStopClick=function(){switch(this.viewModel.state){case"ready":this.viewModel.play();break;case"playing":this.viewModel.stop();break;case"disabled":break;default:o.neverReached(this.viewModel.state)}},t.prototype._previousClick=function(){this.viewModel.previous()},t.prototype._nextClick=function(){this.viewModel.next()},i.__decorate([v.property()],t.prototype,"disabled",void 0),i.__decorate([v.aliasOf("viewModel.effectiveStops"),y.renderable()],t.prototype,"effectiveStops",void 0),i.__decorate([v.aliasOf("viewModel.fullTimeExtent"),y.renderable()],t.prototype,"fullTimeExtent",void 0),i.__decorate([v.property()],t.prototype,"iconClass",void 0),i.__decorate([v.property({dependsOn:["disabled","viewModel.state"],readOnly:!0}),y.renderable()],t.prototype,"interactive",null),i.__decorate([v.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],t.prototype,"label",void 0),i.__decorate([v.property({value:"auto"}),y.renderable()],t.prototype,"layout",null),i.__decorate([v.aliasOf("viewModel.loop")],t.prototype,"loop",void 0),i.__decorate([v.property(),y.renderable(),y.messageBundle("esri/widgets/TimeSlider/t9n/TimeSlider")],t.prototype,"messages",void 0),i.__decorate([v.property(),y.renderable(),y.messageBundle("esri/t9n/common")],t.prototype,"messagesCommon",void 0),i.__decorate([v.aliasOf("viewModel.playRate")],t.prototype,"playRate",void 0),i.__decorate([v.aliasOf("viewModel.mode"),y.renderable()],t.prototype,"mode",void 0),i.__decorate([v.aliasOf("viewModel.stops")],t.prototype,"stops",void 0),i.__decorate([v.property(),y.renderable()],t.prototype,"tickConfigs",void 0),i.__decorate([v.aliasOf("viewModel.timeExtent")],t.prototype,"timeExtent",void 0),i.__decorate([v.property({nonNullable:!0}),y.renderable()],t.prototype,"timeVisible",void 0),i.__decorate([v.aliasOf("viewModel.values"),y.renderable()],t.prototype,"values",void 0),i.__decorate([v.aliasOf("viewModel.view")],t.prototype,"view",void 0),i.__decorate([v.property({type:_}),y.renderable(["viewModel.state"])],t.prototype,"viewModel",void 0),i.__decorate([v.aliasOf("viewModel.next")],t.prototype,"next",null),i.__decorate([v.aliasOf("viewModel.play")],t.prototype,"play",null),i.__decorate([v.aliasOf("viewModel.previous")],t.prototype,"previous",null),i.__decorate([v.aliasOf("viewModel.stop")],t.prototype,"stop",null),i.__decorate([y.accessibleHandler()],t.prototype,"_playOrStopClick",null),i.__decorate([y.accessibleHandler()],t.prototype,"_previousClick",null),i.__decorate([y.accessibleHandler()],t.prototype,"_nextClick",null),t=i.__decorate([v.subclass("esri.widgets.TimeSlider")],t)}(w)}));