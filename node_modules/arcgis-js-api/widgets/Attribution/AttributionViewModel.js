// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../geometry","../../core/arrayUtils","../../core/asyncUtils","../../core/Collection","../../core/HandleOwner","../../core/watchUtils","../../core/accessorSupport/decorators","../../geometry/support/contains","../../geometry/support/webMercatorUtils"],(function(t,e,n,i,r,o,a,s,u,c,l,d){function p(t,e,n){n&&e&&(r.find(t,(function(t){return t.layerView===e&&t.text===n}))||t.push({text:n,layerView:e}))}var f=[];return function(t){function e(e){var n=t.call(this,e)||this;return n.clear=function(){n._fetchedAttributionData.clear(),n._pendingAttributions.clear(),n.handles.remove("suspension"),n.notifyChange("state")},n._pendingAttributions=new Set,n._fetchedAttributionData=new Map,n.items=new a,n.view=null,n._allLayerViewsChange=function(t){n.handles.remove("suspension");var e=n.get("view.allLayerViews");e&&n.handles.add(e.map((function(t){return t.watch(["suspended","attributionVisible"],n._updateAttributionItems)})),"suspension"),t&&t.removed&&t.removed.forEach((function(t){n._pendingAttributions.delete(t),n._fetchedAttributionData.delete(t)})),n._updateAttributionItems()},n._updateAttributionItems=function(){var t,e,i=n.get("view.allLayerViews");(f.length=0,i)?(i.forEach((function(t){if(!t.suspended&&t.get("layer.attributionVisible")){var e=t.layer;if(function(t){return t&&"copyright"in t&&"function"==typeof t.originOf&&"user"===t.originOf("copyright")}(e))p(f,t,e.copyright);else if(e.hasAttributionData){if(n._fetchedAttributionData.has(t)){var i=n._fetchedAttributionData.get(t);return void(i&&p(f,t,n._getDynamicAttribution(i,n.view,e)))}n._fetchAttributionData(t)}else{var r=e.get("portalItem.accessInformation");p(f,t,r||e.copyright)}}})),t=n.items,e=f,(t.length!==e.length||t.some((function(t,n){return t.text!==e[n].text})))&&(n.items.removeAll(),n.items.addMany(f)),n.notifyChange("state")):n.clear()},n.handles.add([u.on(n,"view.allLayerViews","change",n._allLayerViewsChange,n._allLayerViewsChange,n.clear),u.whenTrue(n,"view.stationary",(function(){return n._updateAttributionItems()}))]),n}return n.__extends(e,t),e.prototype.destroy=function(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear()},Object.defineProperty(e.prototype,"state",{get:function(){return this.get("view.ready")?this._pendingAttributions.size>0?"loading":"ready":"disabled"},enumerable:!0,configurable:!0}),e.prototype._fetchAttributionData=function(t){return n.__awaiter(this,void 0,void 0,(function(){var e,i;return n.__generator(this,(function(n){switch(n.label){case 0:return this._pendingAttributions.has(t)?[2]:(this._pendingAttributions.add(t),[4,o.result(t.layer.fetchAttributionData())]);case 1:return e=n.sent(),this._pendingAttributions.has(t)&&(i=e.ok?this._createContributionIndex(e.value,"bing-maps"===t.layer.type):null,this._pendingAttributions.delete(t),this._fetchedAttributionData.set(t,i)),this._updateAttributionItems(),[2]}}))}))},e.prototype._createContributionIndex=function(t,e){var n=t.contributors,r={};if(!n)return r;for(var o=0;o<n.length;o++){var a=n[o],s=a.coverageAreas;if(!s)return;for(var u=0,c=s;u<c.length;u++)for(var l=c[u],p=l.bbox,f=l.zoomMin-(e&&l.zoomMin?1:0),h=l.zoomMax-(e&&l.zoomMax?1:0),b={xmin:p[1],ymin:p[0],xmax:p[3],ymax:p[2],spatialReference:i.SpatialReference.WGS84},y={extent:d.geographicToWebMercator(b),attribution:a.attribution||"",score:null!=l.score?l.score:100,id:o},g=f;g<=h;g++)r[g]=r[g]||[],r[g].push(y)}return r.maxKey=Math.max.apply(null,Object.keys(r)),r},e.prototype._getDynamicAttribution=function(t,e,n){var i=e.extent,r=e.scale,o=n.tileInfo.scaleToZoom(r);if(o=Math.min(t.maxKey,Math.round(o)),!i||null==o||o<=-1)return"";var a=t[o],s=d.project(i.center.clone().normalize(),e.spatialReference),u={};return a?a.filter((function(t){var e=!u[t.id]&&s&&l.extentContainsPoint(t.extent,s);return e&&(u[t.id]=!0),e})).sort((function(t,e){return e.score-t.score||t.objectId-e.objectId})).map((function(t){return t.attribution})).join(", "):""},n.__decorate([c.property({readOnly:!0,type:a})],e.prototype,"items",void 0),n.__decorate([c.property({dependsOn:["view.ready"],readOnly:!0})],e.prototype,"state",null),n.__decorate([c.property()],e.prototype,"view",void 0),e=n.__decorate([c.subclass("esri.widgets.Attribution.AttributionViewModel")],e)}(s.HandleOwner)}));