// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../Graphic","../../intl","../../core/Error","../../core/Handles","../../core/lang","../../core/Logger","../../core/promiseUtils","../../core/string","../../core/throttle","../../core/watchUtils","../../core/accessorSupport/decorators","../../intl/date","../../intl/number","../../layers/support/fieldUtils","../../popup/FieldInfo","../../popup/content/TextContent","../../popup/content/support/ChartMediaInfoValueSeries","../../popup/support/FieldInfoFormat","../Attachments/AttachmentsViewModel","./FeatureContent/FeatureContentViewModel","./FeatureFields/FeatureFieldsViewModel","./support/featureUtils","./support/RelatedFeatures","@dojo/framework/shim/Promise"],(function(e,t,r,i,o,a,n,s,l,u,p,c,f,d,h,_,y,m,g,v,b,F,I,T,A,w){var C=["$datastore","$map","$layer"];function x(e){return"string"==typeof e?e.replace(/(\n)/gi,'<br class="esri-text-new-line" />'):e}function L(e,t){return e&&"function"==typeof e.getField?e.getField(t):null}function N(e){return(""+e).trim()}function R(e){return e.replace(/[\u00A0-\u9999<>\&]/gim,(function(e){return"&#"+e.charCodeAt(0)+";"}))}var E=l.getLogger("esri.widgets.FeatureViewModel"),V=h.convertDateFormatToIntlOptions("short-date-short-time");return function(t){function l(e){var r=t.call(this,e)||this;return r._handles=new n,r._featureAbortController=null,r._graphicChangedThrottled=c.throttle(r._graphicChanged,1,r),r._effectivePopupTemplate=null,r._graphic=null,r._fieldInfoMap=null,r.content=null,r.contentVMs=[],r.defaultPopupTemplateEnabled=!1,r.formattedAttributes=null,r.graphic=null,r.lastEditInfo=null,r.title="",r.view=null,r._handles.add(f.init(r,["graphic","graphic.sourceLayer.popupTemplate.title","graphic.sourceLayer.popupTemplate.content","graphic.sourceLayer.popupTemplate.expressionInfos","graphic.sourceLayer.popupTemplate.fieldInfos","graphic.sourceLayer.popupTemplate.lastEditInfoEnabled","graphic.sourceLayer.popupTemplate.outFields","graphic.sourceLayer.popupTemplate.relatedRecordsInfo","graphic.popupTemplate.title","graphic.popupTemplate.content","graphic.popupTemplate.expressionInfos","graphic.popupTemplate.fieldInfos","graphic.popupTemplate.lastEditInfoEnabled","graphic.popupTemplate.outFields","graphic.popupTemplate.relatedRecordsInfo"],(function(){return r._graphicChangedThrottled()}))),r}return r.__extends(l,t),l.prototype.destroy=function(){this._clear(),this._cancelFeatureQuery(),this._handles.destroy(),this._handles=null,this.graphic=null,this._graphic=null,this._destroyContentViewModels()},Object.defineProperty(l.prototype,"spatialReference",{get:function(){return this.get("view.spatialReference")||null},set:function(e){void 0!==e?this._override("spatialReference",e):this._clearOverride("spatialReference")},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"map",{get:function(){return this.get("view.map")||null},set:function(e){void 0!==e?this._override("map",e):this._clearOverride("map")},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"waitingForContent",{get:function(){return!!this._featureAbortController},enumerable:!0,configurable:!0}),l.prototype._clear=function(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)},l.prototype._graphicChanged=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,i,o;return r.__generator(this,(function(r){switch(r.label){case 0:if(this._cancelFeatureQuery(),this._clear(),e=this.graphic,t=e?e.clone():null,this._graphic=t,!t)return[2];i=u.createAbortController(),this._featureAbortController=i,r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this._queryFeature({signal:i.signal})];case 2:return r.sent(),[3,4];case 3:return o=r.sent(),E.error("error","error loading template",o),[3,4];case 4:return this._featureAbortController=null,[2]}}))}))},l.prototype._cancelFeatureQuery=function(){var e=this._featureAbortController;e&&e.abort(),this._featureAbortController=null},l.prototype._compileContent=function(e){var t=this;if(this._destroyContentViewModels(),this._graphic)return Array.isArray(e)?e.map((function(e,r){return"attachments"===e.type?t._compileAttachments(e,r):"custom"===e.type?t._compileCustom(e,r):"fields"===e.type?t._compileFields(e,r):"media"===e.type?t._compileMedia(e):"text"===e.type?t._compileText(e,r):void 0})):"string"==typeof e?this._compileText(new g({text:e}),0).text:e},l.prototype._destroyContentViewModels=function(){this.contentVMs.forEach((function(e){return e&&!e.destroyed&&e.destroy()})),this._set("contentVMs",[])},l.prototype._compileAttachments=function(e,t){var r=this.graphic;return this.contentVMs[t]=new F({graphic:r}),e},l.prototype._compileCustom=function(e,t){var r=this.graphic,i=e.creator,o=e.destroyer;return this.contentVMs[t]=new I({graphic:r,creator:i,destroyer:o}),e},l.prototype._compileFields=function(e,t){var i=this._effectivePopupTemplate,o=this.formattedAttributes,a=e.clone(),n=(null==e?void 0:e.fieldInfos)||(null==i?void 0:i.fieldInfos),l=null==i?void 0:i.expressionInfos,u=r.__assign(r.__assign({},o.global),o.content[t]),p=new T({attributes:u,expressionInfos:l,fieldInfos:n});return this.contentVMs[t]=p,a.fieldInfos=s.clone(p.formattedFieldInfos),a},l.prototype._setImageValue=function(e){var t=e.value,r=e.formattedAttributes,i=e.layer,o=t.linkURL,a=t.sourceURL;if(a){var n=this._fixTokens(a,i);t.sourceURL=this._substituteAttributes(r,n)}if(o){var s=this._fixTokens(o,i);t.linkURL=this._substituteAttributes(r,s)}},l.prototype._compileMedia=function(e){var t=this,i=this._graphic,o=s.clone(e),a=o.mediaInfos,n=i.attributes,l=A.getSourceLayer(i),u=this.formattedAttributes.global,p=r.__assign(r.__assign({},u),n);return o.mediaInfos=a&&a.map((function(e){var r=s.clone(e);if(r){var i=r.title?t._processFieldsInLinks(r.title,p):"";r.title=i?t._substituteAttributes(u,i):"";var o=r.caption?t._processFieldsInLinks(r.caption,p):"";r.caption=o?t._substituteAttributes(u,o):"";var a=r.altText?t._processFieldsInLinks(r.altText,p):"";if(r.altText=a?t._substituteAttributes(u,a):"","image"===r.type){var c=r.value;return t._setImageValue({value:c,formattedAttributes:u,layer:l}),r.value.sourceURL?r:void 0}if("pie-chart"===r.type||"line-chart"===r.type||"column-chart"===r.type||"bar-chart"===r.type){c=r.value;return t._setChartValue({value:c,chartType:r.type,attributes:n,formattedAttributes:u,layer:l}),r}}})).filter(Boolean),o},l.prototype._normalizeTemplateFields=function(e){var t=this._fieldInfoMap.get(e.toLowerCase());return"{"+(t&&t.fieldName||e)+"}"},l.prototype._substituteAttributes=function(e,t){var r=this;return N(this._removeEmptyHref(p.replace(p.replace(t,(function(e){return r._normalizeTemplateFields(e)})),e)))},l.prototype._compileText=function(e,t){var i=s.clone(e),o=this._graphic;if(i&&i.text){var a=o.attributes,n=this.formattedAttributes.global,l=this._processFieldsInLinks(i.text,r.__assign(r.__assign({},n),a));i.text=this._substituteAttributes(n,l)}return this.contentVMs[t]=new I({graphic:o,creator:i.text}),i},l.prototype._formatEditInfo=function(e,t){var r=e.creatorField,i=e.creationDateField,a=e.editorField,n=e.editDateField;if(t){var s=t[n];if("number"==typeof s){var l=t[a];return{type:"edit",date:o.formatDate(s,V),user:l}}var u=t[i];if("number"==typeof u){var p=t[r];return{type:"create",date:o.formatDate(u,V),user:p}}}},l.prototype._compileLastEditInfo=function(){var e=this._effectivePopupTemplate,t=this._graphic;if(e){var r=e.lastEditInfoEnabled,i=t.get("sourceLayer.editFieldsInfo");if(r&&i)return this._formatEditInfo(i,t.attributes)}},l.prototype._compileTitle=function(e){var t=this._graphic.attributes,i=this.formattedAttributes.global;if(e){var o=this._processFieldsInLinks(e,r.__assign(r.__assign({},i),t));return this._substituteAttributes(i,o)}return""},l.prototype._fixTokens=function(e,t){return e.replace(/(\{([^\{\r\n]+)\})/g,(function(e,r,i){var o=L(t,i);return o?"{"+o.name+"}":r}))},l.prototype._encodeAttributes=function(e){var t=e?s.clone(e):{};return Object.keys(t).forEach((function(e){return function(e,t){var r=t[e];if("string"==typeof r){var i=encodeURIComponent(r).replace(/\'/g,"&apos;");t[e]=i}}(e,t)})),t},l.prototype._createfieldInfoMap=function(e,t){var r=this,i=new Map;return e&&e.forEach((function(e){var o=r._getFixedFieldName(e.fieldName,t);e.fieldName=o,i.set(o.toLowerCase(),e)})),i},l.prototype._formatAttributeValue=function(e){var t=e.value,r=e.fieldName,i=e.fieldInfos,a=e.fieldInfoMap,n=e.layer;if(null==t)return"";var s=this._getDomainName(r,t);if(s)return s;var l=this._getTypeName(r);if(l)return l;if(a.get(r.toLowerCase()))return this._formatValueToFieldInfo(t,{fieldInfos:i,fieldName:r,layer:n});var u=n&&n.fieldsIndex;return u&&u.isDateField(r)?o.formatDate(t,V):x(t)},l.prototype._formatAttributes=function(e){var t=this,r=this._graphic,i=A.getSourceLayer(r),o=s.clone(r.attributes);this.addRelatedFeatureAttributes(o);var a=this._createfieldInfoMap(e,i);return this._fieldInfoMap=a,Object.keys(o).forEach((function(r){var n=o[r];o[r]=t._formatAttributeValue({fieldName:r,fieldInfos:e,fieldInfoMap:a,layer:i,value:n})})),o},l.prototype._parseNumberFromString=function(e,t){if("string"==typeof e&&t&&null==t.dateFormat&&(null!=t.places||null!=t.digitSeparator)){var r=Number(e);if(!isNaN(r))return r}return e},l.prototype._formatValueToFieldInfo=function(e,t){var i=t.fieldInfos,o=t.fieldName,a=this._getFieldInfo(i,o),n=s.clone(a),l=t.preventPlacesFormatting,u=L(t.layer,o);if(u&&"date"===u.type){var p=n.format||new b;p.dateFormat=p.dateFormat||"short-date-short-time",n.format=p}var c=n&&n.format;return"string"==typeof(e=this._parseNumberFromString(e,c))||null==e||null==c?e:l?_.formatNumber(e,r.__assign(r.__assign({},_.convertNumberFormatToIntlOptions(c)),{minimumFractionDigits:0,maximumFractionDigits:20})):c.format(e)},l.prototype._getDomainName=function(e,t){if(this.isRelatedField(e))return null;var r=this._graphic,i=A.getSourceLayer(r);if(!i||"function"!=typeof i.getFieldDomain)return null;var o=i.getFieldDomain(e,{feature:r});return o&&"coded-value"===o.type?o.getName(t):null},l.prototype._getFieldInfo=function(e,t){if(e&&e.length&&t){var r=t.toLowerCase(),i=void 0;return e.some((function(e){return!(!e.fieldName||e.fieldName.toLowerCase()!==r)&&(i=e,!0)})),i}},l.prototype._getTypeName=function(e){if(this.isRelatedField(e))return null;var t=this._graphic,r=A.getSourceLayer(t);if(!r||"function"!=typeof r.getFeatureType)return null;var i=r.typeIdField;if(!i||e!==i)return null;var o=r.getFeatureType(t);return o?o.name:null},l.prototype._removeEmptyHref=function(e){return e.replace(/href=(""|'')/gi,"")},l.prototype._processFieldsInLinks=function(e,t){var r=this.get("_graphic.layer"),i=this._fixTokens(e,r),o=this._encodeAttributes(t);return i?i.replace(/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,(function(e,r,i){return function(e,t,r,i){return t=N(t),p.replace(e,t&&"{"===t[0]?r:i)}(e,r||i,t,o)})):i},l.prototype._getTitle=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,i,o;return r.__generator(this,(function(r){return t=(e=this)._effectivePopupTemplate,i=e._graphic,o=t&&t.title,[2,A.graphicCallback(o,{graphic:i})]}))}))},l.prototype._getContent=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,i,o;return r.__generator(this,(function(r){return t=(e=this)._effectivePopupTemplate,i=e._graphic,o=t&&t.content,[2,A.graphicCallback(o,{graphic:i})]}))}))},l.prototype._querySourceLayer=function(e,t){var r=e.layer,i=e.graphic,o=e.outFields,n=e.objectIds,s=n[0];if("number"!=typeof s){var l=new a("layer-query-features-invalid-objectid",p="Could not query required fields for the specified feature. The feature's ID is invalid.",c={layer:r,graphic:i,objectId:s,requiredFields:o});return E.warn(p,c),u.reject(l)}if("function"!=typeof r.queryFeatures){var p,c;l=new a("layer-query-features-unsupported",p="The specified layer does not support the method 'queryFeatures'. The following fields will not be available.",c={layer:r,graphic:i,requiredFields:o});return E.warn(p,c),u.reject(l)}var f=r.createQuery();return f.objectIds=n,f.outFields=o,f.returnGeometry=!0,r.queryFeatures(f,t).then((function(e){return e.features[0]}))},l.prototype._queryRequiredFieldsFeature=function(e){var t=this,r=this._graphic,i=this._effectivePopupTemplate,o=r.sourceLayer;return o&&i?("function"==typeof o.load?o.load(e):u.resolve()).then((function(){var a=[r.attributes[o.objectIdField]];return i.getRequiredFields(o.fields).then((function(i){return y.featureHasFields(i,r)?null:t._querySourceLayer({layer:o,graphic:r,outFields:i,objectIds:a},e)}))})):u.resolve(null)},l.prototype._queryFeature=function(e){var t=this,i=this._featureAbortController,o=this._graphic;return this._effectivePopupTemplate=o&&o.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled),u.eachAlways({content:this._getContent(),title:this._getTitle()}).then((function(a){var n=a.content.value,s=a.title.value;if(i===t._featureAbortController&&o){var l=t._checkForRelatedFeatures(n,e),p=t._createFormattedExpressions().then((function(e){o.attributes=r.__assign(r.__assign({},o.attributes),e)})),c=t._queryRequiredFieldsFeature(e).then((function(e){e&&(o.geometry=e.geometry,o.attributes=r.__assign(r.__assign({},o.attributes),e.attributes))}));return u.eachAlways([l,p,c]).then((function(){if(i===t._featureAbortController&&o){t._set("formattedAttributes",t._createFormattedAttributes(n)),t._set("title",t._compileTitle(s));var e=t._compileLastEditInfo();t._set("lastEditInfo",e||null);var r=t._compileContent(n);return t._set("content",r||null),r}}))}}))},l.prototype._formatArcadeArray=function(e){return'<ul class="esri-widget__list">'+e.map((function(e){return"<li>"+("string"==typeof e?x(R(e)):e)+"</li>"})).join("")+"</ul>"},l.prototype._formatArcadeDictionary=function(e){return'<table class="esri-widget__table">'+e.keys().map((function(t){var r=e.field(t);return"<tr><th>"+t+"</th><td>"+("string"==typeof r?x(R(r)):r)+"</td></tr>"})).join("")+"</table>"},l.prototype._createFormattedExpressions=function(){return r.__awaiter(this,void 0,void 0,(function(){var t,i,o,a,n,s,l,p,c,f,d,h=this;return r.__generator(this,(function(_){switch(_.label){case 0:return i=(t=this)._effectivePopupTemplate,o=t._graphic,a=i&&i.expressionInfos,n=[],s={},a&&a.length?[4,new Promise((function(t,r){e(["../../support/arcadeUtils"],t,r)}))]:[2,s];case 1:for(l=_.sent(),p=function(e){var t="expression/"+e.name,i=l.createSyntaxTree(e.expression),a=C.filter((function(e){return l.hasVariable(i,e)})),u=l.loadScriptDependencies(i,!0,a).then((function(){return r.__awaiter(h,void 0,void 0,(function(){var e,n,u,p,c=this;return r.__generator(this,(function(r){return e=this.spatialReference,n=l.getViewInfo({spatialReference:e}),(u=l.createExecContext(o,n)).useAsync=!0,this._addVarsToContext(l,a,u,n),p=l.createFunction(i,u),[2,l.executeAsyncFunction(p,u).then((function(e){s[t]="string"==typeof e?x(R(e)):Array.isArray(e)?c._formatArcadeArray(e):e&&"esri.arcade.Dictionary"===e.declaredClass?c._formatArcadeDictionary(e):e}),(function(e){return E.error("arcade-execution-error",e)}))]}))}))}));n.push(u)},c=0,f=a;c<f.length;c++)d=f[c],p(d);return[2,u.eachAlways(n).then((function(){return s}))]}}))}))},l.prototype._addVarsToContext=function(e,t,r,i){var o=this.graphic,a=this.map;t.forEach((function(t){var n=t.toLowerCase(),s={map:a,spatialReference:i.sr};"$map"===n&&(r.vars[n]=e.convertMapToFeatureSetCollection(s)),"$layer"===n&&(r.vars[n]=e.convertFeatureLayerToFeatureSet(o.sourceLayer,i.sr)),"$datastore"===n&&(r.vars[n]=e.convertServiceUrlToWorkspace(o.sourceLayer.url,i.sr))}))},l.prototype._createFormattedAttributes=function(e){var t=this,r=this._effectivePopupTemplate,i=r&&r.fieldInfos,o={global:this._formatAttributes(i),content:[]};return Array.isArray(e)&&e.forEach((function(e,r){"fields"===e.type&&e.fieldInfos&&(o.content[r]=t._formatAttributes(e.fieldInfos))})),o},l.prototype._getAllFieldInfos=function(e){var t=this._effectivePopupTemplate,r=[],i=t&&t.fieldInfos;return i&&r.push.apply(r,i),e&&Array.isArray(e)?(e.forEach((function(e){if("fields"===e.type){var t=e&&e.fieldInfos;r.push.apply(r,t)}})),r):r},l.prototype._checkForRelatedFeatures=function(e,t){var r=this._graphic,i=this._getAllFieldInfos(e);return this.queryRelatedInfos(r,i,t)},l.prototype._getTooltip=function(e){var t=e.label,r=e.value;return"pie-chart"===e.chartType?t:t+": "+r},l.prototype._getChartOption=function(e){var t,r=e.value,i=e.attributes,o=e.formattedAttributes,a=e.fieldName,n=e.relatedFieldName,s=e.fieldInfos,l=e.index,u=e.chartType,p=this._graphic,c=A.getSourceLayer(p),f=r.normalizeField,d=r.tooltipField,h=f?this.isRelatedField(f)?i[this.getRelatedFieldInfo(f).fieldName]:i[f]:null,_=n&&void 0!==i[n]?i[n]:void 0!==i[a]?i[a]:o[a],y=void 0===_?null:_&&h?_/h:_,g=new v({x:l,y:y});if(this.isRelatedField(a)){var b=this.getRelatedFieldInfo(a),F=this.getRelatedFieldInfo(d),I=F?F.fieldName:null,T=this._formatValueToFieldInfo(y,{fieldInfos:s,fieldName:n,layer:c,preventPlacesFormatting:!!h}),w=b?b.label||b.fieldName:n,C=I&&void 0!==i[I]?i[I]:w;return g.tooltip=this._getTooltip({label:C,value:T,chartType:u}),g}var x=this._getFieldInfo(s,a),L=this._getFixedFieldName(a,c),N=d&&void 0!==o[d]?o[d]:A.getFieldInfoLabel(x||new m({fieldName:L}),null===(t=this._effectivePopupTemplate)||void 0===t?void 0:t.expressionInfos),R=o[L];return g.tooltip=this._getTooltip({label:N,value:R,chartType:u}),g},l.prototype._getFixedFieldName=function(e,t){var r=L(t,e);return r?r.name:e},l.prototype._getFixedFieldNames=function(e,t){var r=this;return e&&e.map((function(e){return r._getFixedFieldName(e,t)}))},l.prototype._setChartValue=function(e){var t=this,i=e.value,o=e.attributes,a=e.formattedAttributes,n=e.chartType,s=e.layer,l=this._effectivePopupTemplate,u=this.relatedInfoCount,p=i.fields,c=i.normalizeField;if(i.fields=this._getFixedFieldNames(p,s),c&&(i.normalizeField=this._getFixedFieldName(c,s)),p.some((function(e){return!!(null!=a[e]||t.isRelatedField(e)&&u)}))){var f=l&&l.fieldInfos;p.forEach((function(e,s){if(t.isRelatedField(e))i.series=r.__spreadArrays(i.series,t._getRelatedChartInfos({fieldInfos:f,fieldName:e,formattedAttributes:a,chartType:n,value:i}));else{var l=t._getChartOption({value:i,index:s,attributes:o,chartType:n,formattedAttributes:a,fieldName:e,fieldInfos:f});i.series.push(l)}}))}},l.prototype._getRelatedChartInfos=function(e){var t=this,r=e.fieldInfos,i=e.fieldName,o=e.formattedAttributes,a=e.chartType,n=e.value,s=[],l=this.getRelatedFieldInfo(i),u=l.layerId,p=l.fieldName,c=this.getRelatedInfo(u);if(!c)return s;var f=c.relatedFeatures,d=c.relation;if(!d||!f)return s;var h=d.cardinality;return f.forEach((function(e,l){var u=e.attributes;u&&Object.keys(u).forEach((function(e){e===p&&s.push(t._getChartOption({value:n,index:l,attributes:u,formattedAttributes:o,fieldName:i,chartType:a,relatedFieldName:e,fieldInfos:r}))}))})),"one-to-many"===h||"many-to-many"===h?s:[s[0]]},r.__decorate([d.property()],l.prototype,"_featureAbortController",void 0),r.__decorate([d.property({readOnly:!0})],l.prototype,"content",void 0),r.__decorate([d.property({readOnly:!0})],l.prototype,"contentVMs",void 0),r.__decorate([d.property({type:Boolean})],l.prototype,"defaultPopupTemplateEnabled",void 0),r.__decorate([d.property({readOnly:!0})],l.prototype,"formattedAttributes",void 0),r.__decorate([d.property({type:i})],l.prototype,"graphic",void 0),r.__decorate([d.property({readOnly:!0})],l.prototype,"lastEditInfo",void 0),r.__decorate([d.property({dependsOn:["view"]})],l.prototype,"spatialReference",null),r.__decorate([d.property({readOnly:!0})],l.prototype,"title",void 0),r.__decorate([d.property({dependsOn:["view"]})],l.prototype,"map",null),r.__decorate([d.property({readOnly:!0,dependsOn:["_featureAbortController"]})],l.prototype,"waitingForContent",null),r.__decorate([d.property()],l.prototype,"view",void 0),l=r.__decorate([d.subclass("esri.widgets.FeatureViewModel")],l)}(w)}));