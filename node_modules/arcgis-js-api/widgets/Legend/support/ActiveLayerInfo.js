// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../Color","../../../request","../../../symbols","../../../core/Accessor","../../../core/arrayUtils","../../../core/Collection","../../../core/Handles","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/urlUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../layers/support/ExportImageParameters","../../../layers/support/fieldUtils","../../../renderers/support/jsonUtils","../../../renderers/visualVariables/support/SizeVariableLegendOptions","../../../symbols/support/symbolUtils","../../../symbols/support/utils","../../../views/MapView","./clusterUtils","./colorRampUtils","./heatmapRampUtils","./relationshipRampUtils","./sizeRampUtils","./utils","@dojo/framework/shim/Promise"],(function(e,t,r,n,i,l,a,s,o,u,c,d,p,y,h,f,m,b,g,v,_,S,w,L,E,R,C,I,F){var T=c.getLogger("esri.widgets.Legend.support.ActiveLayerInfo"),V=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,z=new l.SimpleMarkerSymbol({size:6,outline:{color:[128,128,128,.5],width:.5}}),M=new l.SimpleFillSymbol({style:"solid"});function x(e){return"raster-colormap"===e.type}function D(e){return"raster-stretch"===e.type}function O(e){return"raster-shaded-relief"===e.type}function P(e){return"esri.renderers.SimpleRenderer"===e.declaredClass}function A(e){return"esri.renderers.ClassBreaksRenderer"===e.declaredClass}function k(e){return"esri.renderers.UniqueValueRenderer"===e.declaredClass}function U(e){return"esri.renderers.HeatmapRenderer"===e.declaredClass}function B(e){return"esri.renderers.PointCloudClassBreaksRenderer"===e.declaredClass}function N(e){return"esri.renderers.PointCloudStretchRenderer"===e.declaredClass}function W(e){return"esri.renderers.PointCloudUniqueValueRenderer"===e.declaredClass}function q(e){return"esri.renderers.DotDensityRenderer"===e.declaredClass}function j(e){return"esri.layers.MapImageLayer"===e.declaredClass}function H(e){return"esri.layers.ImageryLayer"===e.declaredClass}var J=new l.SimpleMarkerSymbol({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}}),G={};return function(t){function a(e){var r=t.call(this,e)||this;return r._handles=new u,r._hasColorRamp=!1,r._hasOpacityRamp=!1,r._hasSizeRamp=!1,r._webStyleSymbolCache=new Map,r._dotDensityUrlCache=new Map,r._scaleDrivenSizeVariable=null,r._hasClusterSizeVariable=!1,r.children=new o,r.layerView=null,r.layer=null,r.legendElements=[],r.parent=null,r.keepCacheOnDestroy=!1,r.respectLayerVisibility=!0,r.sublayerIds=[],r.title=null,r.view=null,r}return r.__extends(a,t),a.prototype.initialize=function(){var e=this,t=function(){return e.notifyChange("ready")};this._handles.add([h.on(this,"children","change",(function(r){var n=r.added,i=r.removed,l=e._handles;n.map((function(e){var r="activeLayerInfo-ready-watcher-"+e.layer.uid;l.add(h.init(e,"ready",t),r)})),i.forEach((function(e){return l.remove(e.layer.uid)})),t()}))]),this.keepCacheOnDestroy||(G={})},a.prototype.destroy=function(){this._handles.destroy(),this._handles=null,this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(G=null)},Object.defineProperty(a.prototype,"ready",{get:function(){return null===this.layer||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"scale",{get:function(){return this.view&&this.view.scale},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"isScaleDriven",{get:function(){var e=this,t=this.layer;if(null===t)return!1;if("featureReduction"in t&&t.featureReduction&&"cluster"===t.featureReduction.type)return!0;if("renderer"in t&&t.renderer){if("dot-density"===t.renderer.type)return!0;var r=t.get("renderer.valueExpression");if(V.test(r))return!0;var n=t.get("renderer.visualVariables");if(n)return n.some((function(t){return e._isScaleDrivenSizeVariable(t)}))}return this._isLayerScaleDriven(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"version",{get:function(){return this._get("version")+1},enumerable:!0,configurable:!0}),a.prototype.buildLegendElementsForFeatureCollections=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n=this;return r.__generator(this,(function(r){return this.legendElements=[],t=e.map((function(e){if("esri.layers.FeatureLayer"===e.declaredClass)return n._buildRendererLegendElements(e.renderer,{title:e.title,mode:0});if(e.featureSet&&e.featureSet.features.length){var t=e.layerDefinition,r=t&&t.drawingInfo,i=r&&g.fromJSON(r.renderer);return i?n._buildRendererLegendElements(i,{title:e.name,mode:0}):(T.warn("drawingInfo not available!"),null)}return null})),[2,p.eachAlways(t).then((function(){}))]}))}))},a.prototype.buildLegendElementsForRenderer=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return[2,this._buildRendererLegendElements(e)]}))}))},a.prototype.buildLegendElementsForTools=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t=this;return r.__generator(this,(function(r){switch(r.label){case 0:return function(e){return"esri.layers.WMTSLayer"===e.declaredClass}(e=this.layer)?(this._constructLegendElementsForWMTSlayer(),[3,6]):[3,1];case 1:return function(e){return"esri.layers.WMSLayer"===e.declaredClass}(e)?(this._constructLegendElementsForWMSSublayers(),[3,6]):[3,2];case 2:return j(e)||function(e){return"esri.layers.TileLayer"===e.declaredClass}(e)?[4,this._constructLegendElementsForSublayers()]:[3,4];case 3:return r.sent(),[3,6];case 4:return this._handles.remove("imageryLayers-watcher"),[4,this._getLegendLayers().then((function(r){t.legendElements=[],r.forEach((function(r){if(H(e)){var n=e.watch("renderingRule, bandIds",(function(){G.default=null,t.buildLegendElementsForTools()}));t._handles.add(n,"imageryLayers-watcher")}var i=t._generateSymbolTableElementForLegendLayer(r);i&&i.infos.length&&(H(e)&&(i.title=e.title),t.legendElements.push(i)),t.notifyChange("ready")})),t.notifyChange("ready")})).catch((function(e){T.warn("Request to server for legend has failed!",e)}))];case 5:r.sent(),r.label=6;case 6:return[2]}}))}))},a.prototype._isGroupActive=function(){var e=this.children;return!!e.length&&e.some((function(e){return e.ready}))},a.prototype._isScaleDrivenSizeVariable=function(e){if(e&&"size"!==e.type)return!1;var t=e,r=t.minSize,n=t.maxSize;return"object"==typeof r&&r?this._isScaleDrivenSizeVariable(r):"object"==typeof n&&n?this._isScaleDrivenSizeVariable(n):!!t.expression||V.test(t.valueExpression)},a.prototype._isLayerScaleDriven=function(e){var t=this;if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some((function(e){return t._isLayerScaleDriven(e)}));var r=e.parent;if(!1===e.loaded&&j(r)&&"source"in e&&e.source&&"map-layer"===e.source.type)for(var n=0,i=r.sourceJSON.layers;n<i.length;n++){var l=i[n];if(l.id===e.source.mapLayerId&&(l.minScale>0||l.maxScale>0))return!0}return!1},a.prototype._buildRendererLegendElements=function(e,t){return void 0===t&&(t={}),r.__awaiter(this,void 0,void 0,(function(){var n,i;return r.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,this._getRendererLegendElements(e,{title:t.title})];case 1:return n=r.sent(),0===t.mode?Array.prototype.push.apply(this.legendElements,n):this.legendElements=n,this.notifyChange("ready"),[3,3];case 2:return i=r.sent(),T.warn("error while building legend for layer!",i),[3,3];case 3:return[2]}}))}))},a.prototype._constructLegendElementsForWMTSlayer=function(){this.legendElements=[],this._handles.remove("wmts-activeLayer-watcher");var e=this.layer,t=e.activeLayer;if(this._handles.add(h.watch(this.layer,"activeLayer",this._constructLegendElementsForWMTSlayer.bind(this)),"wmts-activeLayer-watcher"),t.styleId&&t.styles){var r=null;t.styles.some((function(e){return t.styleId===e.id&&(r=e.legendUrl,!0)})),r&&(this.legendElements=[{type:"symbol-table",title:t.title,infos:[{src:r,opacity:e.opacity}]}])}this.notifyChange("ready")},a.prototype._constructLegendElementsForWMSSublayers=function(){this.legendElements=[],this._handles.remove("wms-sublayers-watcher");var e=this.layer,t=null;(e.customParameters||e.customLayerParameters)&&(t=r.__assign(r.__assign({},e.customParameters),e.customLayerParameters)),this._handles.add(h.watch(this.layer,"sublayers",this._constructLegendElementsForWMSSublayers.bind(this)),"wms-sublayers-watcher"),this.legendElements=this._generateLegendElementsForWMSSublayers(e.sublayers,t),this.notifyChange("ready")},a.prototype._generateLegendElementsForWMSSublayers=function(e,t){var r=this,n=[];return this._handles.add(e.on("change",this._constructLegendElementsForWMSSublayers.bind(this)),"wms-sublayers-watcher"),e.forEach((function(e){var i=e.watch("title, visible, legendEnabled",(function(){return r._constructLegendElementsForWMSSublayers()}));if(r._handles.add(i,"wms-sublayers-watcher"),e.visible&&e.legendEnabled){var l=r._generateSymbolTableElementForWMSSublayer(e,t);l&&l.infos.length&&n.unshift(l)}})),n},a.prototype._generateSymbolTableElementForWMSSublayer=function(e,t){if(!e.legendUrl&&e.sublayers){var r=this._generateLegendElementsForWMSSublayers(e.sublayers,t).filter((function(e){return e}));return{type:"symbol-table",title:e.title,infos:r}}return this._generateSymbolTableElementForLegendUrl(e,t)},a.prototype._generateSymbolTableElementForLegendUrl=function(e,t){var r=e.legendUrl;if(r){var n={type:"symbol-table",title:e.title||e.name||e.id&&e.id+"",infos:[]};return t&&(r+="?"+y.objectToQuery(t)),n.infos.push({src:r,opacity:e.layer&&e.layer.opacity}),n}},a.prototype._getLegendLayers=function(e){var t=e&&e.hasDynamicLayers?e.dynamicLayers:null,r=t||"default",n=G&&G[r];return n?p.resolve(n):this._legendRequest(t).then((function(e){var t=e.layers;return G[r]=t,t}))},a.prototype._legendRequest=function(e){var t=this.layer,n={f:"json",dynamicLayers:e};if(H(t)){var l=t;if(l.renderingRule&&(n.renderingRule=JSON.stringify(l.renderingRule.toJSON())),l.bandIds&&(n.bandIds=l.bandIds.join()),l.raster||l.viewId){var a=l.raster,s=l.viewId;n=r.__assign({raster:a,viewId:s},n)}}var o=t.url.replace(/(\/)+$/,"");if("version"in t&&t.version>=10.01){var u=o.indexOf("?");u>-1?o=o.substring(0,u)+"/legend"+o.substring(u):o+="/legend"}else{var c=o.toLowerCase().indexOf("/rest/"),d=o.substring(0,c)+o.substring(c+5,o.length);o="https://utility.arcgis.com/sharing/tools/legend?soapUrl="+encodeURI(d)+"&returnbytes=true"}return i(o,{query:n}).then((function(e){return e.data}))},a.prototype._constructLegendElementsForSublayers=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,n;return r.__generator(this,(function(r){switch(r.label){case 0:this.legendElements=[],this._handles.remove("sublayers-watcher"),e=this.layer,this._handles.add(h.watch(e,"sublayers",this._constructLegendElementsForSublayers.bind(this)),"sublayers-watcher"),r.label=1;case 1:return r.trys.push([1,3,,4]),t=this,[4,this._generateLegendElementsForSublayers(e.sublayers,e.opacity)];case 2:return t.legendElements=r.sent(),this.notifyChange("ready"),[3,4];case 3:return n=r.sent(),T.warn("Request to server for legend has failed!",n),[3,4];case 4:return[2]}}))}))},a.prototype._generateLegendElementsForSublayers=function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,l,a,s,o,u,c,d,p,y,h,f=this;return r.__generator(this,(function(r){switch(r.label){case 0:i=[],this._handles.add(e.on("change",this._constructLegendElementsForSublayers.bind(this)),"sublayers-watcher"),l=e.toArray(),!n&&this.sublayerIds&&this.sublayerIds.length&&(a=this.layer,l=this.sublayerIds.map((function(e){return a.findSublayerById(e)})).filter(Boolean)),s=0,o=l,r.label=1;case 1:return s<o.length?(u=o[s],c=u.watch("renderer, opacity, title, visible, legendEnabled",(function(){return f._constructLegendElementsForSublayers()})),this._handles.add(c,"sublayers-watcher"),u.visible&&u.legendEnabled?(d=u&&null!=u.opacity?u.opacity:null,p=null!=d?d*t:t,!u.renderer||u.sublayers?[3,5]:this.respectLayerVisibility&&!this._isSublayerInScale(u)?[3,4]:[4,u.load()]):[3,7]):[3,8];case 2:return r.sent(),[4,this._getRendererLegendElements(u.renderer,{title:u.title,opacity:p,sublayer:u})];case 3:y=r.sent(),Array.prototype.unshift.apply(i,y),r.label=4;case 4:return[3,7];case 5:return[4,this._generateSymbolTableElementForSublayer(u,p,n)];case 6:(h=r.sent())&&i.unshift(h),r.label=7;case 7:return s++,[3,1];case 8:return[2,i.filter((function(e){return!!e&&(!("infos"in e)||e.infos.length>0)}))]}}))}))},a.prototype._generateSymbolTableElementForSublayer=function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,l,a;return r.__generator(this,(function(r){switch(r.label){case 0:if(n)return[3,4];n=new Map,i=new m.ExportImageParameters({layer:this.layer}),r.label=1;case 1:return r.trys.push([1,,3,4]),[4,this._getLegendLayers(i)];case 2:return r.sent().forEach((function(e){return n.set(e.layerId,e)})),[3,4];case 3:return i.destroy(),[7];case 4:return(l=n.get(e.id))||!e.sublayers?[3,6]:[4,this._generateLegendElementsForSublayers(e.sublayers,t,n)];case 5:return a=r.sent(),[2,{type:"symbol-table",title:e.title,infos:a}];case 6:return[2,this._generateSymbolTableElementForLegendLayer(l,e,t)]}}))}))},a.prototype._generateSymbolTableElementForLegendLayer=function(e,t,r){var n=this;if(!e||!e.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;var i=t&&t.renderer,l=t&&t.title||e.layerName;if(i){var a=t&&t.title||this._getRendererTitle(i,t);a&&(l&&(a.title=l),l=a)}var s={type:"symbol-table",title:l,infos:[]};e.legendType&&(s.legendType=e.legendType);var o=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return s.infos=o.map((function(t){var i=t.url;if(t.imageData&&t.imageData.length>0)i="data:image/png;base64,"+t.imageData;else{if(0===i.indexOf("http"))return null;i=y.addTokenParameter(n.layer.url+"/"+e.layerId+"/images/"+i)}return{label:t.label,src:i,opacity:null==r?n.layer.opacity:r,width:t.width,height:t.height}})).filter((function(e){return!!e})),s.infos.length?s:null},a.prototype._isSublayerInScale=function(e){var t=e.minScale||0,r=e.maxScale||0;return!(t>0&&t<this.scale||r>this.scale)},a.prototype._isLegendLayerInScale=function(e,t){var r=t||this.layer,n=null,i=null,l=!0;return!r.minScale&&0!==r.minScale||!r.maxScale&&0!==r.maxScale?(0===e.minScale&&r.tileInfo&&(n=r.tileInfo.lods[0].scale),0===e.maxScale&&r.tileInfo&&(i=r.tileInfo.lods[r.tileInfo.lods.length-1].scale)):(n=Math.min(r.minScale,e.minScale)||r.minScale||e.minScale,i=Math.max(r.maxScale,e.maxScale)),(n>0&&n<this.scale||i>this.scale)&&(l=!1),l},a.prototype._sanitizeLegendForSublayer=function(e,t){if("version"in this.layer&&this.layer.version<10.1||0===e.length)return e;var r=t.renderer,n=e.some((function(e){return e.values})),i=null,l=null;return n&&e.some((function(e,t){return e.values||(i=t,(l=e).label||(l.label="others")),null!=l})),r?"unique-value"===r.type?l&&(e.splice(i,1),e.push(l)):"class-breaks"===r.type&&(l&&e.splice(i,1),e.reverse(),l&&e.push(l)):l&&(e.splice(i,1),e.push(l)),e},a.prototype._getRendererLegendElements=function(e,t){return void 0===t&&(t={}),r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){return function(e){return P(e)||A(e)||k(e)||D(e)||x(e)||U(e)||B(e)||N(e)||W(e)||q(e)||O(e)}(e)?function(e){return B(e)||N(e)||W(e)||function(e){return"esri.renderers.PointCloudRGBRenderer"===e.declaredClass}(e)}(e)?[2,this._constructPointCloudRendererLegendElements(e,t)]:q(e)?[2,this._constructDotDensityRendererLegendElements(e)]:[2,this._constructRendererLegendElements(e,t)]:(T.warn("Renderer not supported!"),[2,[]])}))}))},a.prototype._getPointCloudRendererTitle=function(e){return e.legendOptions&&e.legendOptions.title||e.field},a.prototype._constructPointCloudRendererLegendElements=function(e,t){var r=this;void 0===t&&(t={});var n=t.title,i=[],l=null,a=null;if(B(e))l={type:"symbol-table",title:n||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach((function(e){l.infos.unshift({label:e.label||e.minValue+" - "+e.maxValue,value:[e.minValue,e.maxValue],symbol:r._getAppliedCloneSymbol(z,e.color)})}));else if(N(e)){var s=e.stops,o=null;if(s.length&&(1===s.length&&(o=s[0].color),!o)){var u=s[0].value,c=s[s.length-1].value;if(null!=u&&null!=c){var d=u+(c-u)/2;o=E.getColorFromPointCloudStops(d,s)}}l={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(z,o||z.color)}]};var y=E.getRampStopsForPointCloud(e.stops);a={type:"color-ramp",title:n||this._getPointCloudRendererTitle(e),infos:y,preview:_.renderColorRampPreviewHTML(y.map((function(e){return e.color})))}}else W(e)&&(l={type:"symbol-table",title:n||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos.forEach((function(e){l.infos.push({label:e.label||e.values.join(", "),value:e.values.join(", "),symbol:r._getAppliedCloneSymbol(z,e.color)})})));l&&l.infos.length&&i.push(l),a&&a.infos.length&&i.push(a);var h=i.reduce((function(e,t){return e.concat(t.infos)}),[]).filter((function(e){return!!e.symbol})).map((function(e){return r._getSymbolPreview(e,r.layer.opacity)}));return p.eachAlways(h).then((function(){return i}))},a.prototype._getElementInfoForDotDensity=function(e,t){var r=e.backgroundColor,n=e.outline,i=e.dotSize+"-"+t+"-"+r+"-"+(n&&JSON.stringify(n.toJSON())),l=this._dotDensityUrlCache,a=l.has(i)?l.get(i):_.renderDotDensityPreviewHTML(e,t);return l.set(i,a),{opacity:1,src:a.src,preview:a,width:a.width,height:a.height}},a.prototype._constructDotDensityRendererLegendElements=function(e){var t=this,r=e.calculateDotValue(this.view.scale),n=e.legendOptions&&e.legendOptions.unit,i={type:"symbol-table",title:{value:r&&Math.round(r),unit:n||""},infos:[]};return e.attributes.forEach((function(r){var n=t._getElementInfoForDotDensity(e,r.color);n.label=r.label||r.valueExpressionTitle||r.field,i.infos.push(n)})),p.resolve([i])},a.prototype._constructRendererLegendElements=function(e,t){return void 0===t&&(t={}),r.__awaiter(this,void 0,void 0,(function(){var n,i,a,s,o,u,c,y,h,f,m,b,g,v,S,w,L,E,I,F,T,V,z,B,N,W,q,j,G,$,Z,Q,X,K,Y,ee,te,re,ne,ie,le=this;return r.__generator(this,(function(r){switch(r.label){case 0:return n=t.title,i=t.sublayer,a=i||this.layer,[4,this._loadRenderer(e)];case 1:return s=r.sent(),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null,[4,this._getVisualVariableLegendElements(s,a)];case 2:return o=r.sent()||[],u={type:"symbol-table",title:n||this._getRendererTitle(s,a),infos:[]},c=null,y=!1,h=new Set,U(s)?(f=R.getHeatmapRampStops(s),o.push({type:"heatmap-ramp",title:n,infos:f,preview:_.renderColorRampPreviewHTML(f.map((function(e){return e.color})))}),[3,12]):[3,3];case 3:if(!k(s))return[3,4];if(m=s&&s.authoringInfo,m&&"relationship"===m.type){if(b=m.focus,g=m.numClasses,v=m.field1,S=m.field2,g&&v&&S){for(w=[v,S],L=C.getRotationAngleForFocus(b)||0,E=0,I=w;E<I.length;E++)T=(F=I[E]).field,V=F.normalizationField,z=F.label,B=z||{field:this._getFieldAlias(T,a),normField:V&&this._getFieldAlias(V,a)},(N=J.clone()).angle=L,u.infos.push({label:B,symbol:N}),h.add(N),L+=90;W=C.getRelationshipRampElement({focus:b,numClasses:g,infos:s.uniqueValueInfos}),o.unshift(W)}}else q=s.field,s.uniqueValueInfos.forEach((function(e){if(e.symbol){var t=e.symbol.clone();H(le.layer)&&(t=l.SimpleMarkerSymbol.fromJSON({color:t.color,style:"square"})),u.infos.push({label:e.label||le._getDomainName(q,e.value,a)||e.value,value:e.value,symbol:t})}}));return s.defaultSymbol&&(u.infos.push({label:s.defaultLabel||"others",symbol:s.defaultSymbol}),y=!0),[3,12];case 4:return A(s)?(c=this._isUnclassedRenderer(s),(!c||!this._hasSizeRamp)&&(s.classBreakInfos.forEach((function(e){if(e.symbol){var t=e.symbol.clone();H(le.layer)&&(t=l.SimpleMarkerSymbol.fromJSON({color:t.color,style:"square"})),u.infos.unshift({label:e.label||(c?null:e.minValue+" - "+e.maxValue),value:[e.minValue,e.maxValue],symbol:t})}})),c&&(u.title=null),this._updateInfosforClassedSizeRenderer(s,u.infos)),s.defaultSymbol&&!c&&(u.infos.push({label:s.defaultLabel||"others",symbol:s.defaultSymbol}),y=!0),[3,12]):[3,5];case 5:return D(s)?function(e){return"esri.layers.ImageryTileLayer"===e.declaredClass}(this.layer)?(j=this._constructTileImageryStretchRendererElements(s),"stretch-ramp"===j.type?o.push(j):u.infos=j,[3,10]):[3,6]:[3,11];case 6:return G=this.layer,$=void 0,Z=void 0,s.statistics&&s.statistics.length&&($=s.statistics[0].min||s.statistics[0][0],Z=s.statistics[0].max||s.statistics[0][1]),Q=[],K=d.unwrap,G.renderingRule?[4,G.generateRasterInfo(G.renderingRule)]:[3,8];case 7:return Y=r.sent(),[3,9];case 8:Y=G.serviceRasterInfo,r.label=9;case 9:X=K.apply(void 0,[Y]),ee=X.keyProperties.BandProperties,1===X.bandCount?($=$||X.statistics&&X.statistics[0].min,Z=Z||X.statistics&&X.statistics[0].max,$||Z?o.push(this._getStretchLegendElements(s,{min:$,max:Z})):this.buildLegendElementsForTools()):G.bandIds&&1===G.bandIds.length?($=$||X.statistics&&X.statistics[G.bandIds[0]].min,Z=Z||X.statistics&&X.statistics[G.bandIds[0]].max,$||Z?o.push(this._getStretchLegendElements(s,{min:$,max:Z})):this.buildLegendElementsForTools()):X.bandCount>=3?ee&&ee.length>=X.bandCount?G.bandIds&&3===G.bandIds.length?(Q=G.bandIds.map((function(e){return ee[e].BandName})),u.infos=this._createSymbolTableElementMultiBand(Q)):"lerc"===G.format?(Q=[0,1,2].map((function(e){return ee[e].BandName})),u.infos=this._createSymbolTableElementMultiBand(Q)):this.buildLegendElementsForTools():"lerc"===G.format?(Q=["band0","band1","band2"],u.infos=this._createSymbolTableElementMultiBand(Q)):this.buildLegendElementsForTools():this.buildLegendElementsForTools(),r.label=10;case 10:return[3,12];case 11:x(s)?s.colormapInfos.forEach((function(e){u.infos.push({label:e.label,value:e.value,symbol:le._getAppliedCloneSymbol(M,e.color)})})):P(s)?s.symbol&&!this._hasSizeRamp&&u.infos.push({label:s.label,symbol:s.symbol}):O(s)&&o.push(this._getStretchLegendElements(s,{min:0,max:255})),r.label=12;case 12:return!(te=s.defaultSymbol)||y||P(s)||c&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||o.push({type:"symbol-table",infos:[{label:s.defaultLabel||"others",symbol:te}]}),u.infos.length&&o.unshift(u),re=null==t.opacity?a.opacity:t.opacity,ne=this._getSymbolConfig("visualVariables"in s&&s.visualVariables),ie=o.reduce((function(e,t){return e.concat(t.infos)}),[]).filter((function(e){return!(!e||!e.symbol)})).map((function(e){return le._getSymbolPreview(e,re,{applyScaleDrivenSize:!h.has(e.symbol),symbolConfig:ne})})),s=null,[4,p.eachAlways(ie)];case 13:return r.sent(),[2,o]}}))}))},a.prototype._constructTileImageryStretchRendererElements=function(e){var t,r,n,i=this.layer,l=i.rasterInfo,a=l.bandCount||e.statistics.length,s=l.keyProperties&&l.keyProperties.BandProperties;if(e.statistics&&e.statistics.length&&(t=void 0!==e.statistics[0].min?e.statistics[0].min:e.statistics[0][0],r=e.statistics[0].max||e.statistics[0][1]),1===l.bandCount)return this._getStretchLegendElements(e,{min:t,max:r});function o(e){var t=(i.bandIds&&i.bandIds.length?i.bandIds:[0,1,2]).map((function(t){return e&&e[t]&&e[t].BandName||"band"+t}));return t.length<3?t.push(t[1]):t.length>3&&t.splice(3),t}return n=s&&s.length>=a?o(s):o(),this._createSymbolTableElementMultiBand(n)},a.prototype._getStretchLegendElements=function(e,t){var r=e.colorRamp,n=E.getStrectchRampStops(r,t);return{type:"stretch-ramp",title:"",infos:n,preview:_.renderColorRampPreviewHTML(n.map((function(e){return e.color})))}},a.prototype._createSymbolTableElementMultiBand=function(e){var t=[],r=["red","green","blue"];return e.forEach((function(e,n){t.push({label:{colorName:r[n],bandName:e},src:F.RGB_IMG_SOURCE[n],opacity:1})})),t},a.prototype._updateInfosforClassedSizeRenderer=function(e,t){var r=e.authoringInfo&&"class-breaks-size"===e.authoringInfo.type,n=e.classBreakInfos.some((function(e){return S.isVolumetricSymbol(e.symbol)}));if(r&&n){var i=I.REAL_WORLD_MAX_SIZE,l=I.REAL_WORLD_MIN_SIZE,a=e.classBreakInfos.length,s=(i-l)/(a>1?a-1:a);t.forEach((function(e,t){e.size=i-s*t}))}},a.prototype._getSymbolConfig=function(e){var t=!1,r=!1;if(e)for(var n=0;n<e.length&&(!t||!r);n++){var i=e[n];"size"===i.type&&("height"===i.axis&&(t=!0),"width-and-depth"===i.axis&&(r=!0))}return t&&r?"tall":null},a.prototype._getSymbolPreview=function(t,n,i){return r.__awaiter(this,void 0,void 0,(function(){var l,a;return r.__generator(this,(function(r){switch(r.label){case 0:return l=t.size,this._scaleDrivenSizeVariable&&(null==i?void 0:i.applyScaleDrivenSize)?[4,new Promise((function(t,r){e(["../../../renderers/visualVariables/support/visualVariableUtils"],t,r)}))]:[3,2];case 1:a=r.sent().getSize,l=a(this._scaleDrivenSizeVariable,null,{view:this.view,scale:this.scale,shape:"simple-marker"===t.symbol.type?t.symbol.style:null}),r.label=2;case 2:return[2,_.renderPreviewHTML(t.symbol,{size:l,opacity:n,symbolConfig:null==i?void 0:i.symbolConfig,rotation:t.symbol.angle}).then((function(e){return t.preview=e,t})).catch((function(){return t.preview=null,t}))]}}))}))},a.prototype._loadRenderer=function(e){var t,n;return r.__awaiter(this,void 0,void 0,(function(){var i,l,a,s,o,u,c,y,h,f,m,b,g=this;return r.__generator(this,(function(r){switch(r.label){case 0:return i=[],l=this.layer,e=e.clone(),this._hasClusterSizeVariable=!1,a="visualVariables"in e&&(null===(t=e.visualVariables)||void 0===t?void 0:t.some((function(e){return"size"===e.type&&"outline"!==e.target&&!V.test(e.valueExpression)}))),e&&"visualVariables"in e&&!a&&"featureReduction"in l&&"cluster"===(null===(n=l.featureReduction)||void 0===n?void 0:n.type)&&(s=this.layerView._effectiveRenderer,(o=d.unwrap(L.getClusterSizeVariable(s,this.view)))&&("clusterMinSize"in(u=l.featureReduction)&&"clusterMaxSize"in u&&(c=u.clusterMinSize,y=u.clusterMaxSize,o.legendOptions=new v({showLegend:c!==y})),h=e.visualVariables||[],e.visualVariables=h.concat([o]),this._hasClusterSizeVariable=!0)),[4,this._getMedianColor(e)];case 1:return f=r.sent(),(A(e)||k(e))&&(m=e.classBreakInfos||e.uniqueValueInfos,b=m.map((function(e){return g._fetchSymbol(e.symbol,f).then((function(t){e.symbol=t})).catch((function(){e.symbol=null}))})),Array.prototype.push.apply(i,b)),i.push(this._fetchSymbol(e.symbol||e.defaultSymbol,e.defaultSymbol?null:f).then((function(t){g._applySymbolToRenderer(e,t,P(e))})).catch((function(){g._applySymbolToRenderer(e,null,P(e))}))),[2,p.eachAlways(i).then((function(){return e}))]}}))}))},a.prototype._applySymbolToRenderer=function(e,t,r){r?e.symbol=t:e.defaultSymbol=t},a.prototype._getMedianColor=function(t){return r.__awaiter(this,void 0,void 0,(function(){var n,i,l,a;return r.__generator(this,(function(r){switch(r.label){case 0:if(!("visualVariables"in t&&t.visualVariables))return[2,null];if(!(n=s.find(t.visualVariables,(function(e){return"color"===e.type}))))return[2,null];if(i=null,l=null,n.stops){if(1===n.stops.length)return[2,n.stops[0].color];i=n.stops[0].value,l=n.stops[n.stops.length-1].value}return a=i+(l-i)/2,[4,new Promise((function(t,r){e(["../../../renderers/visualVariables/support/visualVariableUtils"],t,r)}))];case 1:return[2,(0,r.sent().getColor)(n,a)]}}))}))},a.prototype._fetchSymbol=function(e,t){var r=this;if(!e)return p.reject();if("web-style"===e.type){var n=e.portal,i=n&&n.url,l=n&&n.user&&n.user.username,a=e.name+"-"+e.styleName+"-"+e.styleUrl+"-"+i+"-"+l,s=this._webStyleSymbolCache;return s.has(a)||(this.view instanceof w?s.set(a,e.fetchCIMSymbol()):s.set(a,e.fetchSymbol())),s.get(a).then((function(e){return r._getAppliedCloneSymbol(e,t)})).catch((function(){return T.warn("Fetching web-style failed!"),p.reject()}))}return p.resolve(this._getAppliedCloneSymbol(e,t))},a.prototype._getAppliedCloneSymbol=function(e,t){if(!e)return e;var r=e.clone(),i=r.type.indexOf("3d")>-1,l=t&&t.toRgba();return i?this._applyColorTo3dSymbol(r,l):r.color&&(r.color=new n(l||r.color)),r},a.prototype._applyColorTo3dSymbol=function(e,t){t&&e.symbolLayers.forEach((function(e){e&&(e.material||(e.material={}),e.material.color=new n(t))}))},a.prototype._getVisualVariableLegendElements=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i,l,a,s,o,u,c,y,h,f,m,g=this;return r.__generator(this,(function(v){switch(v.label){case 0:if(!("visualVariables"in e&&e.visualVariables))return[2,null];for(n=e.visualVariables,i=[],l=[],a=[],s=0,o=n;s<o.length;s++)"color"===(u=o[s]).type?i.push(u):"size"===u.type?l.push(u):"opacity"===u.type&&a.push(u);return c=r.__spreadArrays(i,l,a),0===i.length&&A(e)&&e.classBreakInfos&&1===e.classBreakInfos.length&&(f=e.classBreakInfos[0],y=f&&f.symbol),0===i.length&&P(e)&&(y=e.symbol),y&&(y.type.indexOf("3d")>-1?"water"===(m=y.symbolLayers.getItemAt(0)).type?d.isSome(m.color)&&(h=m.color):d.isSome(m.material)&&d.isSome(m.material.color)&&(h=m.material.color):y.url||(h=y.color)),[4,p.all(c.map((function(n){return r.__awaiter(g,void 0,void 0,(function(){var i,l,a,s,o,u,c,d;return r.__generator(this,(function(r){switch(r.label){case 0:return n.legendOptions&&!1===n.legendOptions.showLegend?[3,10]:(i=this._getRampTitle(n,t),l=null,a="getField"in t&&t.getField&&t.getField(n.field),s=a&&b.isDateField(a),"color"!==n.type?[3,2]:[4,E.getRampStops(n,null,s)]);case 1:return d=r.sent(),l={type:"color-ramp",title:i,infos:d,preview:_.renderColorRampPreviewHTML(d.map((function(e){return e.color})))},this._hasColorRamp||(this._hasColorRamp=!(null==l.infos||!l.infos.length)),[3,9];case 2:return"size"!==n.type||"outline"===n.target?[3,7]:V.test(n.valueExpression)?(this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=n),[3,6]):[3,3];case 3:return o={type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(n):i},u=I.getRampStops,c=[e,n],[4,this._getMedianColor(e)];case 4:return[4,u.apply(void 0,c.concat([r.sent(),this.scale,this.view,s]))];case 5:o.infos=r.sent(),l=o,this._hasSizeRamp||(this._hasSizeRamp=!(null==l.infos||!l.infos.length)),r.label=6;case 6:return[3,9];case 7:return"opacity"!==n.type?[3,9]:[4,E.getRampStops(n,h,s)];case 8:d=r.sent(),l={type:"opacity-ramp",title:i,infos:d,preview:_.renderColorRampPreviewHTML(d.map((function(e){return e.color})))},this._hasOpacityRamp||(this._hasOpacityRamp=!(null==l.infos||!l.infos.length)),r.label=9;case 9:return[2,l&&l.infos?l:null];case 10:return[2,void 0]}}))}))})))];case 1:return[2,v.sent().filter((function(e){return!!e}))]}}))}))},a.prototype._getDomainName=function(e,t,r){if(e&&"function"!=typeof e){var n="getField"in r&&r.getField&&r.getField(e),i=n&&"getFieldDomain"in r&&r.getFieldDomain?r.getFieldDomain(n.name):null;return i&&"coded-value"===i.type?i.getName(t):null}return null},a.prototype._getClusterTitle=function(e){var t=this.layer,r=e.field;if("featureReduction"in t&&t.featureReduction&&"cluster"===t.featureReduction.type){var n=t.featureReduction,i="popupTemplate"in n&&n.popupTemplate,l=i&&i.fieldInfos;if(l)for(var a=0,s=l;a<s.length;a++){var o=s[a];if(o.fieldName===r)return"cluster_count"===r?o.label||{showCount:!0}:o.label}}return{showCount:!0}},a.prototype._getRampTitle=function(e,t){var r=e.field,n=e.normalizationField,i=!1,l=!1,a=!1,s=null;r="function"==typeof r?null:r,n="function"==typeof n?null:n;var o=e.legendOptions&&e.legendOptions.title;if(null!=o)s=o;else if(e.valueExpressionTitle)s=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables)for(var u=t.renderer.authoringInfo.visualVariables,c=0;c<u.length;c++){var d=u[c];if("color"===d.type){if("ratio"===d.style){i=!0;break}if("percent"===d.style){l=!0;break}if("percent-of-total"===d.style){a=!0;break}}}s={field:r&&this._getFieldAlias(r,t),normField:n&&this._getFieldAlias(n,t),ratio:i,ratioPercent:l,ratioPercentTotal:a}}return s},a.prototype._getRendererTitle=function(e,t){var r=e;if(r.legendOptions&&r.legendOptions.title)return r.legendOptions.title;if(r.valueExpressionTitle)return r.valueExpressionTitle;var n=r.field,i=null,l=null;A(r)&&(i=r.normalizationField,l="percent-of-total"===r.normalizationType),i="function"==typeof i?null:i;var a=null;return((n="function"==typeof n?null:n)||i)&&(a={field:n&&this._getFieldAlias(n,t),normField:i&&this._getFieldAlias(i,t),normByPct:l}),a},a.prototype._getFieldAlias=function(e,t){var r="popupTemplate"in t&&t.popupTemplate,n=r&&r.fieldInfos,i=null;n&&n.some((function(t){return e===t.fieldName&&(i=t,!0)}));var l=null;"getField"in t&&t.getField?l=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(l=t.fieldsIndex.get(e));var a=i||l,s=null;return a&&(s=i&&i.label||l&&l.alias||"name"in a&&a.name||"fieldName"in a&&a.fieldName),s},a.prototype._isUnclassedRenderer=function(e){var t=e.visualVariables,r=!1;return A(e)&&e.classBreakInfos&&1===e.classBreakInfos.length&&t&&(r=e.field?t.some((function(t){return!(!t||e.field!==t.field||(e.normalizationField||t.normalizationField)&&e.normalizationField!==t.normalizationField)})):!!t.length),r},r.__decorate([f.property()],a.prototype,"children",void 0),r.__decorate([f.property()],a.prototype,"layerView",void 0),r.__decorate([f.property()],a.prototype,"layer",void 0),r.__decorate([f.property()],a.prototype,"legendElements",void 0),r.__decorate([f.property()],a.prototype,"parent",void 0),r.__decorate([f.property({readOnly:!0})],a.prototype,"ready",null),r.__decorate([f.property()],a.prototype,"keepCacheOnDestroy",void 0),r.__decorate([f.property()],a.prototype,"respectLayerVisibility",void 0),r.__decorate([f.property({dependsOn:["view.scale"],readOnly:!0})],a.prototype,"scale",null),r.__decorate([f.property()],a.prototype,"sublayerIds",void 0),r.__decorate([f.property({dependsOn:["layer.renderer?.valueExpression?","layer.renderer?.visualVariables?","layer.featureReduction?","scale"],readOnly:!0})],a.prototype,"isScaleDriven",null),r.__decorate([f.property()],a.prototype,"title",void 0),r.__decorate([f.property({dependsOn:["ready"],readOnly:!0,value:0})],a.prototype,"version",null),r.__decorate([f.property()],a.prototype,"view",void 0),a=r.__decorate([f.subclass("esri.widgets.Legend.support.ActiveLayerInfo")],a)}(a)}));