// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../symbols","../../../core/promiseUtils","../../../renderers/support/numberUtils","../../../symbols/support/utils","./utils","@dojo/framework/shim/Promise"],(function(e,r,n,t,i,l,s,a){Object.defineProperty(r,"__esModule",{value:!0}),r.REAL_WORLD_MAX_SIZE=30,r.REAL_WORLD_MIN_SIZE=12;var u=[255,255,255],o=[200,200,200],c=[128,128,128];function f(r,t,i,s){return n.__awaiter(this,void 0,void 0,(function(){var a,u,o,c,f;return n.__generator(this,(function(n){switch(n.label){case 0:return[4,new Promise((function(r,n){e(["../../../renderers/visualVariables/support/visualVariableUtils"],r,n)}))];case 1:if(a=n.sent().getSizeRangeAtScale(r,i,s),u=a&&function(e){for(var r=e.minSize,n=e.maxSize,t=(n-r)/4,i=[],l=0;l<5;l++)i.push(r+t*l);return i}(a),!a&&!u)return[2,void 0];o=u.map((function(e){return function(e,r,n){var t=n.minSize,i=n.maxSize,l=r.minDataValue,s=r.maxDataValue,a=null;if(e<=t)a=l;else if(e>=i)a=s;else{a=(e-t)/(i-t)*(s-l)+l}return a}(e,r,a)})),o=l.round(o),c=1,n.label=2;case 2:return c<o.length-1?[4,m(r,t,o[c],o[c-1],i,s)]:[3,5];case 3:(f=n.sent())&&(o[c]=f[0],u[c]=f[1]),n.label=4;case 4:return c++,[3,2];case 5:return[2,o]}}))}))}function m(e,r,t,i,s,a){return n.__awaiter(this,void 0,void 0,(function(){var u,o,c,f,m,b,h,y,d,v,_,S,g,w,z,L,V,D,x,E,M,O;return n.__generator(this,(function(n){switch(n.label){case 0:return[4,p(e,r,t,s,a)];case 1:return u=n.sent(),[4,p(e,r,i,s,a)];case 2:o=n.sent(),c=l.numDigits(t),f=c.fractional,m=20,b=c.integer,h=null,y=null,t>0&&t<1&&(h=Math.pow(10,f),t*=h,b=l.numDigits(t).integer),d=b-1,n.label=3;case 3:return d>=0?(v=Math.pow(10,d),_=Math.floor(t/v)*v,S=Math.ceil(t/v)*v,null!=h&&(_/=h,S/=h),g=(_+S)/2,O=l.round([_,g,S],{indexes:[1]}),g=O[1],[4,p(e,r,_,s,a)]):[3,8];case 4:return w=n.sent(),[4,p(e,r,S,s,a)];case 5:return z=n.sent(),[4,p(e,r,g,s,a)];case 6:if(L=n.sent(),V=l.percentChange(u,w,o,null),D=l.percentChange(u,z,o,null),x=l.percentChange(u,L,o,null),E=V.previous<=m,M=D.previous<=m,E&&M&&(V.previous<=D.previous?(E=!0,M=!1):(M=!0,E=!1)),E?y=[_,w]:M?y=[S,z]:x.previous<=m&&(y=[g,L]),y)return[3,8];n.label=7;case 7:return d--,[3,3];case 8:return[2,y]}}))}))}function p(r,t,i,l,s){return n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(n){switch(n.label){case 0:return[4,new Promise((function(r,n){e(["../../../renderers/visualVariables/support/visualVariableUtils"],r,n)}))];case 1:return[2,(0,n.sent().getSize)(r,i,{scale:l,view:s,shape:"simple-marker"===t.type?t.style:null})]}}))}))}r.getRampStops=function(e,m,b,h,y,d){return n.__awaiter(this,void 0,void 0,(function(){var v,_,S,g,w,z,L,V,D,x,E,M,O,R,I,k,A=this;return n.__generator(this,(function(C){switch(C.label){case 0:return v=m.legendOptions,_=v&&v.customValues,S=function(e,r){var n=null,i=null;if("simple"===e.type)n=e.symbol;else if("class-breaks"===e.type){var l=e.classBreakInfos;n=l&&l[0]&&l[0].symbol,i=l.length>1}else if("unique-value"===e.type){l=e.uniqueValueInfos;n=l&&l[0]&&l[0].symbol,i=l.length>1}if(!n||function(e){if(e){return t.isSymbol3D(e)?!!e.symbolLayers&&e.symbolLayers.some((function(e){return e&&"fill"===e.type})):-1!==e.type.indexOf("fill")}return!1}(n))return null;n=n.clone(),(r||i)&&(n.type.indexOf("3d")>-1?function(e){s.isVolumetricSymbol(e)||("line-3d"===e.type?e.symbolLayers.forEach((function(e){e.material={color:c}})):e.symbolLayers.forEach((function(e){"icon"!==e.type||e.resource&&e.resource.href?e.material={color:o}:(e.material={color:u},e.outline={color:c,size:1.5})})))}(n):function(e){-1!==e.type.indexOf("line")?e.color=c:(e.color=u,"simple-marker"===e.type&&(e.outline={color:c,width:1.5}))}(n));return n}(e,b),g=!!S,w=!!_,z=null!=m.minSize&&null!=m.maxSize,L=m.stops&&m.stops.length>1,V=!!m.target,g&&(w||z||L&&!V)?(D=s.isVolumetricSymbol(S),x=null,E=null,M=null,!D||L?[3,1]:(E=l.round([m.minDataValue,m.maxDataValue]),[3,4])):[2,void 0];case 1:return(O=_)?[3,3]:[4,f(m,S,h,y)];case 2:O=C.sent(),C.label=3;case 3:E=O,C.label=4;case 4:return!E&&L&&(E=m.stops.map((function(e){return e.value})),(x=m.stops.some((function(e){return!!e.label})))&&(M=m.stops.map((function(e){return e.label})))),D&&E&&E.length>2&&(E=[E[0],E[E.length-1]]),E?(R=[r.REAL_WORLD_MIN_SIZE,r.REAL_WORLD_MAX_SIZE],I=s.getSymbolOutlineSize(S),k=x?null:function(e,r){var n=e.length-1;return e.map((function(e,t){return a.createStopLabel(e,t,n,r)}))}(E,d),[4,i.all(E.map((function(e,r){return n.__awaiter(A,void 0,void 0,(function(){var i,l,a,u;return n.__generator(this,(function(n){switch(n.label){case 0:return D?(a=R[r],[3,3]):[3,1];case 1:return[4,p(m,S,e,h,y)];case 2:a=n.sent(),n.label=3;case 3:return l=function(e,r){var n=e.clone();if(t.isSymbol3D(n))s.isVolumetricSymbol(n)||n.symbolLayers.forEach((function(e){"fill"!==e.type&&(e.size=r)}));else if("esri.symbols.SimpleMarkerSymbol"===n.declaredClass)n.size=r;else if(function(e){return"esri.symbols.PictureMarkerSymbol"===e.declaredClass}(n)){var i=n.width,l=n.height;n.height=r,n.width=r*(i/l)}else!function(e){return"esri.symbols.SimpleLineSymbol"===e.declaredClass}(n)?function(e){return"esri.symbols.TextSymbol"===e.declaredClass}(n)&&n.font&&(n.font.size=r):n.width=r;return n}(S,i=a),u=x?M[r]:k[r],[2,{value:e,symbol:l,label:u,size:i,outlineSize:I}]}}))}))})))]):[2,null];case 5:return[2,C.sent().reverse()]}}))}))}}));