// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../core/events","../core/Handles","../core/watchUtils","../core/accessorSupport/decorators","../libs/sortablejs/Sortable","./Widget","./Bookmarks/BookmarksViewModel","./support/widget"],(function(t,o,e,r,s,i,a,n,d,k,l){var u="esri-bookmarks esri-widget--panel",m="esri-bookmarks__loader-container",c="esri-bookmarks__loader",h="esri-bookmarks__list",_="esri-bookmarks__list--sortable",p="esri-bookmarks__bookmark",b="esri-bookmarks__bookmark-button",f="esri-bookmarks__bookmark-image-container",g="esri-bookmarks__bookmark-edit-button",v="esri-bookmarks_bookmark-drag-handle",B="esri-bookmarks_bookmark-drag-handle-icon",y="esri-bookmarks__bookmark-icon",x="esri-bookmarks__image",E="esri-bookmarks__bookmark-name",A="esri-bookmarks__bookmark--active",w="esri-widget__content--empty",I="esri-bookmarks__no-bookmarks-heading",S="esri-widget__no-bookmark-icon",N="esri-bookmarks__no-bookmarks-description",C="esri-bookmarks__adding-bookmark",U="esri-bookmarks__add-bookmark",M="esri-bookmarks__add-bookmark-button",O="esri-bookmarks__add-bookmark-icon",R="esri-bookmarks__authoring-card",T="esri-bookmarks__authoring-form",H="esri-bookmarks__authoring-label",D="esri-bookmarks__authoring-actions",L="esri-bookmarks__authoring-input--invalid",F="esri-bookmarks__authoring-delete-button",q="esri-bookmarks__authoring-cancel-button",z="esri-widget",K="esri-widget--disabled",P="esri-button",V="esri-button--tertiary",j="esri-input",W="esri-icon-handle-vertical",G="esri-icon-plus",J="esri-icon-edit",Q="esri-icon-bookmark",X="esri-widget__heading",Y="esri-icon-loading-indicator",Z="esri-rotating",$={addBookmark:!0,thumbnail:!0};return function(t){function o(o,r){var i=t.call(this,o,r)||this;return i._handles=new s,i._addInputNode=null,i._editInputNode=null,i._addBookmarkButtonNode=null,i._focusAddBookmarkButton=!1,i._focusEditInputBox=!1,i._focusAddInputBox=!1,i._addBookmark=!1,i._editBookmark=null,i._invalidEntry=!1,i._creatingBookmark=!1,i._sortable=null,i._sortableNode=null,i._focusSortUid=null,i._selectedSortUid=null,i._sortableSavedItems=null,i.bookmarkCreationOptions=null,i.bookmarks=null,i.disabled=!1,i.editingEnabled=!1,i.goToOverride=null,i.iconClass=Q,i.label=void 0,i.messages=null,i.messagesCommon=null,i.view=null,i.viewModel=new k,i.visibleElements=e.__assign({},$),i}return e.__extends(o,t),o.prototype.initialize=function(){var t=this;this.own([i.init(this,"viewModel.bookmarks",(function(){return t._bookmarksInitialized()})),i.init(this,"editingEnabled",(function(){return t._toggleSorting()}))])},o.prototype.destroy=function(){this._destroySortable(),this._handles.destroy(),this._handles=null},o.prototype.castVisibleElements=function(t){return e.__assign(e.__assign({},$),t)},o.prototype.endAddBookmark=function(){this._invalidEntry=!1,this._addBookmark=!1,this._creatingBookmark=!1,this.scheduleRender()},o.prototype.goTo=function(t){return this.viewModel.goTo(t)},o.prototype.render=function(){var t,o="loading"===this.viewModel.state?this.renderLoading():this.renderBookmarks();return l.tsx("div",{class:this.classes(u,z,(t={},t[K]=this.disabled,t))},o)},o.prototype.startAddBookmark=function(){this._editBookmark=null,this._addBookmark=!0,this._focusAddInputBox=!0,this.scheduleRender()},o.prototype.renderLoading=function(){return l.tsx("div",{class:m,key:"loader"},l.tsx("div",{class:c}))},o.prototype.renderNoBookmarksContainer=function(){var t=this.messages;return l.tsx("div",{class:w,key:"no-bookmarks"},l.tsx("span",{"aria-hidden":"true",class:this.classes(S,Q)}),l.tsx("h1",{class:this.classes(X,I)},t.noBookmarksHeading),l.tsx("p",{class:N},t.noBookmarksDescription))},o.prototype.renderAddBookmarkLoading=function(){return l.tsx("div",{key:"adding-bookmark",class:C},l.tsx("span",{"aria-hidden":"true",class:this.classes(Y,Z)}),this.messages.addingBookmark)},o.prototype.renderBookmarkItems=function(t){var o=this;return t?t.map((function(t){return o.editingEnabled&&o._editBookmark&&t&&o._editBookmark===t?o.renderEditingBookmark(t):o.renderBookmark(t)})).toArray():null},o.prototype.renderBookmarksContainer=function(t){var o,e=this.editingEnabled&&!this._addBookmark?this.renderAddBookmarkButton():null,r=this.editingEnabled?this._creatingBookmark?this.renderAddBookmarkLoading():this._addBookmark?this.renderAddingBookmark():null:null;return[l.tsx("ul",{key:"bookmark-list","aria-label":this.messages.widgetLabel,class:this.classes(h,(o={},o[_]=this.editingEnabled,o)),afterCreate:this._sortNodeCreated,afterRemoved:this._destroySortable,"data-node-ref":"_sortableNode",bind:this},this.renderBookmarkItems(t)),e,r]},o.prototype.renderAddBookmarkButton=function(){return this.visibleElements.addBookmark?l.tsx("div",{key:"add-bookmark-item",class:U},l.tsx("button",{class:this.classes(P,V,M),onclick:this.startAddBookmark,afterCreate:this._storeAddBookmarkButton,afterUpdate:this._storeAddBookmarkButton,"data-node-ref":"_addBookmarkButtonNode",bind:this},l.tsx("span",{"aria-hidden":"true",class:this.classes(O,G)}),this.messages.addBookmark)):null},o.prototype.renderBookmarks=function(){var t=this.viewModel.bookmarks,o=t&&t.filter(Boolean),e=o&&o.length,r=e||this.editingEnabled?this.renderBookmarksContainer(o):null;return[e?null:this.renderNoBookmarksContainer(),r]},o.prototype.renderEditContainer=function(t){var o=this.messagesCommon;return l.tsx("div",{key:"edit-container"},l.tsx("button",{title:o.edit,"aria-label":o.edit,"data-bookmark":t,onclick:this._showEditBookmarkForm,bind:this,class:g},l.tsx("span",{"aria-hidden":"true",class:J})))},o.prototype.renderDragHandle=function(t){var o,r=this.messagesCommon,s=((o={})["data-bookmark-uid"]=t.uid,o);return l.tsx("div",e.__assign({role:"button",tabIndex:0,key:"drag-handle",bind:this,class:v,onkeydown:this._dragHandleKeydown,afterCreate:this._focusDragHandle,afterUpdate:this._focusDragHandle,onblur:this._dragHandleBlur,"aria-pressed":this._selectedSortUid===t.uid?"true":"false","aria-label":r.dragHandleLabel,title:r.dragHandleTitle},s),l.tsx("span",{"aria-hidden":"true",class:this.classes(B,W)}))},o.prototype.renderBookmarkImage=function(t){var o=this.visibleElements,e=t.thumbnail,r=e&&e.url||"";return o.thumbnail&&r?l.tsx("img",{src:r,alt:"",class:x}):l.tsx("span",{"aria-hidden":"true",class:this.classes(y,Q)})},o.prototype.renderBookmarkButton=function(t){var o=this.messagesCommon,e=t.name||o.untitled,r=l.tsx("div",{class:f},this.renderBookmarkImage(t));return l.tsx("button",{key:"bookmark-button",class:b,bind:this,"data-bookmark":t,onclick:this._goToBookmark},r,l.tsx("span",{class:E},e))},o.prototype.renderBookmark=function(t){var o,r,s=this.viewModel.activeBookmark,i=((o={})[A]=s===t,o),a=this.editingEnabled?this.renderEditContainer(t):null,n=((r={})["data-bookmark-uid"]=t.uid,r),d=this.editingEnabled?this.renderDragHandle(t):null;return l.tsx("li",e.__assign({key:t,class:this.classes(p,i)},n),d,this.renderBookmarkButton(t),a)},o.prototype.renderEditingBookmarkName=function(t){var o=this.messages;return l.tsx("label",{class:H},o.title,l.tsx("input",{required:!0,bind:this,class:this.classes(j,this._invalidEntry?L:null),type:"text",value:t.name,afterCreate:this._storeEditInput,afterUpdate:this._focusEditInput,"data-bookmark":t,"data-node-ref":"_editInputNode",placeholder:o.addPlaceholder}))},o.prototype.renderEditingBookmarkActions=function(t){var o=this.messagesCommon;return l.tsx("div",{class:D},l.tsx("input",{type:"button",value:o.delete,class:this.classes(P,V,F),"data-bookmark":t,onclick:this._deleteBookmark,bind:this}),l.tsx("input",{type:"button",value:o.cancel,class:this.classes(P,V),onclick:this._closeEditBookmarkForm,bind:this}),l.tsx("input",{class:P,type:"submit",value:o.save}))},o.prototype.renderEditingBookmark=function(t){var o,r=((o={})["data-bookmark-uid"]=t.uid,o);return l.tsx("li",e.__assign({key:"edit-bookmark-form",class:R},r),l.tsx("form",{class:T,onsubmit:this._editBookmarkSubmit,bind:this},this.renderEditingBookmarkName(t),this.renderEditingBookmarkActions(t)))},o.prototype.renderAddingBookmarkName=function(){var t=this.messages;return l.tsx("label",{class:H},t.title,l.tsx("input",{required:!0,bind:this,class:this.classes(j,this._invalidEntry?L:null),type:"text",afterCreate:this._storeAddInput,afterUpdate:this._focusAddInput,"data-node-ref":"_addInputNode",value:"",placeholder:t.addPlaceholder}))},o.prototype.renderAddingBookmarkActions=function(){var t=this.messagesCommon;return l.tsx("div",{class:this.classes(D)},l.tsx("input",{type:"button",value:t.cancel,class:this.classes(P,V,q),onclick:this._endAddBookmark.bind(this),bind:this}),l.tsx("input",{class:P,type:"submit",value:t.add}))},o.prototype.renderAddingBookmark=function(){return l.tsx("div",{key:"add-bookmark-form",class:R},l.tsx("form",{class:T,onsubmit:this._addBookmarkSubmit,bind:this},this.renderAddingBookmarkName(),this.renderAddingBookmarkActions()))},o.prototype._dragHandleBlur=function(){this._selectedSortUid=null,this.scheduleRender()},o.prototype._dragHandleKeydown=function(t){t.stopPropagation();var o=this._sortableSavedItems,e=r.eventKey(t);if(-1!==["ArrowDown","ArrowUp","Escape","Tab"," ","Enter"].indexOf(e)){var s=this._sortable,i=this._selectedSortUid,a=s.toArray(),n=t.target.getAttribute("data-bookmark-uid"),d=a.indexOf(n);if(" "===e||"Enter"===e){var k=i&&i===n;return this._selectedSortUid=k?null:n,this._sortableSavedItems=k?null:this._sortable.toArray(),void this.scheduleRender()}if("Tab"===e)return this._selectedSortUid=null,void this.scheduleRender();if("Escape"===e&&o)return this._selectedSortUid=null,this._updateSortItems(o,s,n),void this.scheduleRender();if(-1!==d&&i){var l,u,m,c="ArrowUp"===e?d-1:d+1;if(!(c>=a.length||c<=-1))u=d,m=c,(l=a).splice(m,0,l.splice(u,1)[0]),this._updateSortItems(a,s,n)}}},o.prototype._updateSortItems=function(t,o,e){o.sort(t),this._sortBookmarks(o),this._focusSortUid=e,this._selectedSortUid=e},o.prototype._focusDragHandle=function(t){var o=this._focusSortUid;t&&o&&(t.getAttribute("data-bookmark-uid")===o&&(t.focus(),this._focusSortUid=null))},o.prototype._toggleSorting=function(){var t=this,o=this._sortable,e=this._sortableNode,r=this.editingEnabled;if(e)if(o)o.option("disabled",!r);else{var s=n.create(e,{dataIdAttr:"data-bookmark-uid",handle:"."+v,group:"bookmarks",disabled:!r,onSort:function(){return t._sortBookmarks(s)}});this._sortable=s}},o.prototype._sortNodeCreated=function(t){this._sortableNode=t,this._toggleSorting()},o.prototype._sortBookmarks=function(t){var o=this.viewModel.bookmarks;if(o){var e=t.toArray();o.sort((function(t,o){var r=e.indexOf(t.uid),s=e.indexOf(o.uid);return r>s?1:r<s?-1:0}))}},o.prototype._destroySortable=function(){var t=this._sortable;t&&t.destroy(),this._sortable=null},o.prototype._endAddBookmark=function(){this._focusAddBookmarkButton=!0,this.endAddBookmark()},o.prototype._bookmarksInitialized=function(){var t=this,o=this._handles;o.remove("bookmarks-init"),o.add(i.on(this,"viewModel.bookmarks","change",(function(){return t._bookmarksChanged()})),"bookmarks-init")},o.prototype._bookmarksChanged=function(){var t=this,o=this.viewModel.bookmarks,e=this._handles;e.remove("bookmarks-change");var r=o.map((function(o){return i.watch(o,["active","name","thumbnail.url"],(function(){return t.scheduleRender()}))}));e.add(r,"bookmarks-change"),this.scheduleRender()},o.prototype._showEditBookmarkForm=function(t){var o=t.currentTarget["data-bookmark"];this._addBookmark=!1,this._focusEditInputBox=!0,this._editBookmark=o,this.scheduleRender()},o.prototype._closeEditBookmarkForm=function(){this._invalidEntry=!1,this._editBookmark=null,this.scheduleRender()},o.prototype._addBookmarkSubmit=function(t){var o=this;t.preventDefault();var e=this._addInputNode,r=this.bookmarkCreationOptions,s=e&&e.value.trim();if(!s)return this._invalidEntry=!0,void this.scheduleRender();this._creatingBookmark=!0,this.scheduleRender(),this.viewModel.createBookmark(r).then((function(t){t.name=s,o.viewModel.bookmarks.add(t),o._endAddBookmark()}))},o.prototype._editBookmarkSubmit=function(t){t.preventDefault();var o=this._editInputNode,e=this._editBookmark,r=o&&o.value.trim();if(!r)return this._invalidEntry=!0,void this.scheduleRender();e.name=r,this._closeEditBookmarkForm()},o.prototype._storeAddBookmarkButton=function(t){this._addBookmarkButtonNode=t,this._focusAddBookmark()},o.prototype._storeEditInput=function(t){this._editInputNode=t,this._focusEditInput()},o.prototype._storeAddInput=function(t){this._addInputNode=t,this._focusAddInput()},o.prototype._focusAddInput=function(){this._addInputNode&&this._focusAddInputBox&&(this._focusAddInputBox=!1,this._addInputNode.focus())},o.prototype._focusAddBookmark=function(){this._addBookmarkButtonNode&&this._focusAddBookmarkButton&&(this._focusAddBookmarkButton=!1,this._addBookmarkButtonNode.focus())},o.prototype._focusEditInput=function(){this._editInputNode&&this._focusEditInputBox&&(this._focusEditInputBox=!1,this._editInputNode.focus())},o.prototype._deleteBookmark=function(t){var o=t.currentTarget["data-bookmark"];this.viewModel.bookmarks.remove(o)},o.prototype._goToBookmark=function(t){var o=t.currentTarget["data-bookmark"];this.endAddBookmark(),this._closeEditBookmarkForm(),this.viewModel.goTo(o)},e.__decorate([a.property()],o.prototype,"bookmarkCreationOptions",void 0),e.__decorate([a.aliasOf("viewModel.bookmarks")],o.prototype,"bookmarks",void 0),e.__decorate([l.renderable(),a.property()],o.prototype,"disabled",void 0),e.__decorate([l.renderable(),a.property()],o.prototype,"editingEnabled",void 0),e.__decorate([a.aliasOf("viewModel.goToOverride")],o.prototype,"goToOverride",void 0),e.__decorate([a.property()],o.prototype,"iconClass",void 0),e.__decorate([a.property({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],o.prototype,"label",void 0),e.__decorate([a.property(),l.renderable(),l.messageBundle("esri/widgets/Bookmarks/t9n/Bookmarks")],o.prototype,"messages",void 0),e.__decorate([a.property(),l.renderable(),l.messageBundle("esri/t9n/common")],o.prototype,"messagesCommon",void 0),e.__decorate([a.aliasOf("viewModel.view")],o.prototype,"view",void 0),e.__decorate([a.property({type:k}),l.renderable(["activeBookmark","state","bookmarks"]),l.vmEvent(["select-bookmark"])],o.prototype,"viewModel",void 0),e.__decorate([a.property(),l.renderable()],o.prototype,"visibleElements",void 0),e.__decorate([a.cast("visibleElements")],o.prototype,"castVisibleElements",null),e.__decorate([a.property()],o.prototype,"endAddBookmark",null),e.__decorate([a.property()],o.prototype,"startAddBookmark",null),o=e.__decorate([a.subclass("esri.widgets.Bookmarks")],o)}(d)}));