// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../../intl","../../../core/Error","../../../core/lang","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/unitUtils","../../../geometry/Polygon","./geometryUtils"],(function(e,r,t,i,n,o,a,l,u,s,d){Object.defineProperty(r,"__esModule",{value:!0});var f=/https?:\/\/services.*\.arcgis\.com/i,c=/(?:\{([^}]+)\})/g,g=o.getLogger("esri.widgets.Search.support.layerSearchUtils");function v(e,r){var t=e.filter,i=e.withinViewEnabled,n=r&&r.extent;return t&&t.geometry||(i&&n?n:void 0)}function p(e){return e&&-1!==e.indexOf("*")}function y(e){return e?e.load().then(l.resolve).catch(l.reject):l.resolve()}function m(e){return e&&!!e.get("capabilities.query.supportsPagination")}function h(e){return e.displayField||e.layer.displayField||function(e){var r="";if(e){var t=e.fields;t&&t.some((function(e){return"string"===e.type&&(r=e.name,!0)}))}return r}(e.layer)}function F(e,r){return!(!e||!r)&&r.every((function(r){return w(e,r)}))}function w(e,r){return!!e.getField(r)}function x(e){return e.replace(/\'/g,"''")}function b(e,r){var t=r&&r.where;return t?"("+e+") AND ("+t+")":e}function R(e,r,t,i,n){var o=r.definitionExpression,a="";if(e){var l=f.test(r.url)&&function(e){for(var r=0;r<e.length;r++)if(e.charCodeAt(r)>255)return!0;return!1}(e)?"N":"";t&&t.forEach((function(t){var o=r.getField(t),u="function"==typeof r.getFieldDomain&&r.getFieldDomain(t),s=(u&&"coded-value"===u.type?function(e,r,t){var i=null,n=e.codedValues;return n&&n.some((function(e){var n=e.name,o=t?n:n.toLowerCase();return(t?r:r.toLowerCase())===o&&(i=e.code.toString(),!0)})),i}(u,e,n):null)||e||null;if(null!==s){var d=function(e,r,t,i,n){var o=r.type,a=r.name;if("string"===o||"date"===o||"global-id"===o)return b(n?a+" = "+t+"'"+e+"'":"UPPER("+a+") LIKE "+t+"'%"+e.toUpperCase()+"%'",i);if("oid"===o||"small-integer"===o||"integer"===o||"single"===o||"double"===o){var l=Number(e);return isNaN(l)?null:b(a+" = "+l,i)}return b(a+" = "+e,i)}(s,o,l,i,n);d&&(a+=function(e,r){return e?" OR ("+r+")":"("+r+")"}(a,d))}}))}return o?"("+o+") AND ("+a+")":a}function S(e,r,i){var n=e.layer,o=e.attributes,a="function"==typeof n.getFieldDomain&&n.getFieldDomain(i);if(r)return t.substitute(r,o);if(i&&e.hasOwnProperty("attributes")&&o.hasOwnProperty(i)){var l=o[i],u=n.getField(i);return a&&"coded-value"===a.type?function(e,r){var t=null,i=e.codedValues;return i&&i.length&&i.some((function(e){return e.code===r&&(t=e.name,!0)})),t}(a,l):u&&"date"===u.type?t.formatDate(new Date(l)):"number"==typeof l?l.toString():"string"!=typeof l?"":l.trim()}return""}r.getResults=function(e,r){var t=e.exactMatch,o=void 0!==t&&t,l=e.location,f=e.maxResults,c=e.spatialReference,b=e.source,I=e.sourceIndex,E=e.suggestResult,j=e.view,D=b.layer,O=b.filter,P=b.zoomScale,U=j&&j.scale,N=v(b,j),T=r&&r.signal;return y(D).then((function(){var e=D.popupTemplate;return e?e.getRequiredFields(D.fields):null})).then((function(e){var r=D.objectIdField,t=D.returnZ,v=h(b);if(!w(D,v))throw g.error("invalid-field: displayField is invalid."),new i("getResults():invalid-field","displayField is invalid.");var y=e&&e.length?e:[v],q=b.outFields||y,L=p(q);if(-1!==q.indexOf(r)||L||q.push(r),!(L||F(D,q)))throw g.error("invalid-field: outField is invalid."),new i("getResults():invalid-field","outField is invalid.");var k=D.createQuery(),A=b.orderByFields;if(A&&(k.orderByFields=A),c){k.outSpatialReference=c;var B=1/u.getMetersPerUnitForSR(c);B&&(k.maxAllowableOffset=B)}var C=!!D.get("capabilities.data.supportsZ");if(k.returnZ=C&&!1!==t,k.returnGeometry=!0,q&&(k.outFields=q),l)k.geometry=l;else if(E.key)k.objectIds=[parseInt(E.key,10)];else{var G=b.searchFields||[v];if(!F(D,G))throw g.error("invalid-field: search field is invalid."),new i("getResults():invalid-field","search field is invalid.");if(m(D)&&(k.num=f),N&&(k.geometry=N),!E.text.trim())return[];var M=b.prefix,V=void 0===M?"":M,Z=b.suffix,Q=void 0===Z?"":Z,_=R(x(""+V+E.text+Q),D,G,O,o);if(!_)return[];k.where=_}return D.queryFeatures(k,{signal:T}).then((function(e){return function(e,r,t,i,o,l,u){return e.features.map((function(e){return function(e,r,t,i,o,l,u){var f=e.clone(),c=e.layer,g=c&&c.objectIdField,v=g&&e.attributes[g],p=S(e,t.searchTemplate,o),y=d.createExtentFromGeometry(f.geometry,r,l),m="number"==typeof u?d.scaleExtent(n.clone(y),r,u):y,h=e.clone();a.isSome(m)&&(h.geometry=s.fromExtent(m));return{extent:m,target:h,feature:f,key:v,name:p,sourceIndex:i}}(e,r,t,i,o,l,u)}))}(e,j,b,I,v,U,P)}))}))},r.getSuggestions=function(e,r){var t=e.source,n=e.spatialReference,o=e.view,a=e.suggestTerm,l=e.maxSuggestions,u=e.sourceIndex,s=t.layer,d=t.filter,f=r&&r.signal,b=v(t,o);return y(s).then((function(){if(!m(s))return[];var e=h(t),r=t.searchFields||[e],o=[];t.suggestionTemplate?t.suggestionTemplate.replace(c,(function(e,r){return o.push(r),e})):o.push(e);var v=p(o);-1!==o.indexOf(s.objectIdField)||v||o.push(s.objectIdField);var y=w(s,e),I=v||F(s,o),E=F(s,r);if(!y)throw g.error("invalid-field: displayField is invalid."),new i("getSuggestions():invalid-field","displayField is invalid.");if(!I)throw g.error("invalid-field: outField is invalid."),new i("getSuggestions():invalid-field","outField is invalid.");if(!E)throw g.error("invalid-field: search field is invalid."),new i("getSuggestions():invalid-field","search field is invalid.");var j=s.createQuery(),D=t.orderByFields;if(D&&(j.orderByFields=D),j.outSpatialReference=n,j.returnGeometry=!1,j.num=l,j.outFields=o,b&&(j.geometry=b),!a.trim())return[];var O=t.prefix,P=void 0===O?"":O,U=t.suffix,N=R(x(""+P+a+(void 0===U?"":U)),s,r,d,!1);return N?(j.where=N,s.queryFeatures(j,{signal:f}).then((function(r){return function(e,r,t,i){return e.features.map((function(e){return function(e,r,t,i){var n=e.layer,o=e.attributes,a=n.objectIdField,l=o[a];return{text:S(e,r.suggestionTemplate,i),key:l,sourceIndex:t}}(e,r,t,i)}))}(r,t,u,e)}))):[]}))}}));