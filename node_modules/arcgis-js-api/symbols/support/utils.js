// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../Color","../../symbols","../../core/asyncUtils","../../core/compilerUtils","../../core/has","../../core/maybe","../../core/screenUtils","../../core/libs/gl-matrix-2/vec3f64","./gfxUtils","./Symbol3DMaterial","@dojo/framework/shim/Promise"],(function(e,r,t,n,i,o,a,l,u,s,c,f,y){Object.defineProperty(r,"__esModule",{value:!0});var h=/\/resource\/(.*?)\.svg$/,m=new n("white");function b(e,r){if(null==r)return e;var t=e.toRgba();return t[3]=t[3]*r,new n(t)}function p(e,r){return t.__awaiter(this,void 0,void 0,(function(){var n,i=this;return t.__generator(this,(function(a){switch(a.label){case 0:return(n=e.symbolLayers)?[4,o.forEach(n,(function(e){return t.__awaiter(i,void 0,void 0,(function(){return t.__generator(this,(function(t){return[2,v(e,r)]}))}))}))]:[2];case 1:return a.sent(),[2]}}))}))}function v(e,r){return t.__awaiter(this,void 0,void 0,(function(){return t.__generator(this,(function(t){switch(t.label){case 0:switch(e.type){case"extrude":return[3,1];case"icon":case"line":case"text":return[3,2];case"path":return[3,3];case"object":return[3,4];case"fill":case"water":return[3,6]}return[3,7];case 1:return function(e,r){e.size="number"==typeof r[2]?r[2]:0}(e,r),[3,8];case 2:return function(e,r){var t=d(r);u.isSome(t)&&(e.size=t)}(e,r),[3,8];case 3:return function(e,r){var t=g(r,c.vec3f64.ONES,[e.width,void 0,e.height]);e.width=_(r[0],e.width,1,t),e.height=_(r[2],e.height,1,t)}(e,r),[3,8];case 4:return[4,w(e,r)];case 5:return t.sent(),[3,8];case 6:return[3,8];case 7:a.neverReached(e),t.label=8;case 8:return[2]}}))}))}function d(e){for(var r=0,t=e;r<t.length;r++){var n=t[r];if("number"==typeof n)return n}return null}function w(e,r){return t.__awaiter(this,void 0,void 0,(function(){var n,i,o,a;return t.__generator(this,(function(t){switch(t.label){case 0:return[4,S(e)];case 1:return n=t.sent(),i=n.resourceSize,o=n.symbolSize,a=g(r,i,o),e.width=_(r[0],o[0],i[0],a),e.depth=_(r[1],o[1],i[1],a),e.height=_(r[2],o[2],i[2],a),[2]}}))}))}function g(e,r,t){for(var n=0;n<3;n++){var i=e[n];switch(i){case"symbol-value":return null!=t[n]?t[n]/r[n]:1;case"proportional":break;default:if(i&&r[n])return i/r[n]}}return 1}function S(r){return t.__awaiter(this,void 0,void 0,(function(){var n,i,o,a,l,u,s;return t.__generator(this,(function(t){switch(t.label){case 0:return[4,new Promise((function(r,t){e(["./symbolLayerUtils"],r,t)}))];case 1:return[4,t.sent().computeObjectLayerResourceSize(r,10)];case 2:for(n=t.sent(),i=r.width,o=r.height,a=r.depth,l=[i,a,o],u=1,s=0;s<3;s++)if(null!=l[s]){u=l[s]/n[s];break}for(s=0;s<3;s++)null==l[s]&&(l[s]=n[s]*u);return[2,{resourceSize:n,symbolSize:l}]}}))}))}function _(e,r,t,n){switch(e){case"proportional":return t*n;case"symbol-value":return null!=r?r:t;default:return e}}r.getSymbolOutlineSize=function(e){if(!e)return 0;if(i.isSymbol3D(e)){var r=function(e){var r=e.symbolLayers&&e.symbolLayers.length;if(r){var t=e.symbolLayers.getItemAt(r-1);if("outline"in t)return u.get(t,"outline","size")}}(e);return u.isSome(r)?r:0}var t=f.getStroke(e);return t&&s.px2pt(t.width)||0},r.isVolumetricSymbol=function(e){if(!e||!e.symbolLayers)return!1;switch(e.type){case"point-3d":return e.symbolLayers.some((function(e){return"object"===e.type}));case"line-3d":return e.symbolLayers.some((function(e){return"path"===e.type}));case"polygon-3d":return e.symbolLayers.some((function(e){return"object"===e.type||"extrude"===e.type}));default:return!1}},r.getIconHref=function(e,r){var t=r.resource.href;return!l("esri-canvas-svg-support")&&e.styleOrigin&&h.test(t)?t.replace(h,"/resource/png/$1.png"):t},r.applyOpacityToColor=b,r.applyColorToSymbol=function(e,r,t){e&&(r||null!=t)&&(r&&(r=new n(r)),i.isSymbol3D(e)?function(e,r,t){var n=e.symbolLayers;if(n){var i=function(e){var n=u.isSome(e)?e:null;return b(r=r||n||null!=t&&m,t)};n.forEach((function(e){if("object"!==e.type||null==e.resource.href||r)if("water"===e.type)e.color=i(e.color);else{var n=u.isSome(e.material)?e.material.color:null,o=i(n);u.isNone(e.material)?e.material=new y.default({color:o}):e.material.color=o,null!=t&&"outline"in e&&u.isSome(e.outline)&&u.isSome(e.outline.color)&&(e.outline.color=b(e.outline.color,t))}}))}}(e,r,t):i.isSymbol2D(e)&&function(e,r,t){(r=r||e.color)&&(e.color=b(r,t)),null!=t&&"outline"in e&&e.outline&&e.outline.color&&(e.outline.color=b(e.outline.color,t))}(e,r,t))},r.applySizesToSymbol=function(e,r){return t.__awaiter(this,void 0,void 0,(function(){return t.__generator(this,(function(t){return e&&r?i.isSymbol3D(e)?[2,p(e,r)]:(i.isSymbol2D(e)&&function(e,r){var t=d(r);if(!u.isNone(t))switch(e.type){case"simple-marker":e.size=t;break;case"picture-marker":var n=e.width/e.height;n>1?(e.width=t,e.height=t*n):(e.width=t*n,e.height=t);break;case"simple-line":e.width=t;break;case"text":e.font.size=t;break;case"simple-fill":case"picture-fill":case"cim":break;default:a.neverReached(e)}}(e,r),[2]):[2]}))}))},r.applyRotationToSymbol=function(e,r,t){if(e&&null!=r)if(i.isSymbol3D(e)){var n=e.symbolLayers;n&&n.forEach((function(e){if(e&&"object"===e.type)switch(t){case"tilt":e.tilt=r;break;case"roll":e.roll=r;break;default:e.heading=r}}))}else i.isSymbol2D(e)&&("simple-marker"!==e.type&&"picture-marker"!==e.type&&"text"!==e.type||(e.angle=r))}}));