// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../core/compilerUtils","../../core/maybe","../../support/arcadeOnDemand","./previewCIMSymbol","./previewSymbol2D","./previewSymbol3D","./previewWebStyleSymbol","./utils","@dojo/framework/shim/Promise"],(function(e,t,r,l,i,a,o,n,s,c,u){Object.defineProperty(t,"__esModule",{value:!0});var d=null;function h(e,t){return Math.floor(Math.random()*(t-e+1)+e)}t.renderDotDensityPreviewHTML=function(e,t,r){var l=e.backgroundColor,i=e.outline,a=e.dotSize,o=r&&r.swatchSize||22,n=Math.round(o*o/Math.pow(a,2)*.8),s=window.devicePixelRatio,c=document.createElement("canvas"),u=o*s;c.width=u,c.height=u,c.style.width=c.width/s+"px",c.style.height=c.height/s+"px";var p=c.getContext("2d");if(l&&(p.fillStyle=l.toCss(!0),p.fillRect(0,0,u,u),p.fill()),p.fillStyle=t.toCss(!0),d&&d.length/2===n)for(var y=0;y<2*n;y+=2){var b=d[y],m=d[y+1];p.fillRect(b,m,a*s,a*s),p.fill()}else{d=[];for(y=0;y<2*n;y+=2){b=h(0,u),m=h(0,u);d.push(b,m),p.fillRect(b,m,a*s,a*s),p.fill()}}i&&(i.color&&(p.strokeStyle=i.color.toCss(!0)),p.lineWidth=i.width,p.strokeRect(0,0,u,u));var v=new Image(o,o);return v.src=c.toDataURL(),v},t.renderColorRampPreviewHTML=function(e,t){void 0===t&&(t={});var r="horizontal"===t.align,l=r?75:24,i=r?24:75,a=t.width,o=void 0===a?l:a,n=t.height,s=void 0===n?i:n,c=t.gradient,u=void 0===c||c,d=window.devicePixelRatio,h=o*d,p=s*d,y=document.createElement("canvas");y.width=h,y.height=p,y.style.width=o+"px",y.style.height=s+"px";var b=y.getContext("2d"),m=r?h:0,v=r?0:p;if(u){var g=b.createLinearGradient(0,0,m,v),f=1/(e.length-1);e.forEach((function(e,t){return g.addColorStop(t*f,e.toString())})),b.fillStyle=g,b.fillRect(0,0,h,p)}else for(var w=r?h/e.length:h,S=r?p:p/e.length,C=0,R=0,x=0,V=e;x<V.length;x++){var M=V[x];b.fillStyle=M.toString(),b.fillRect(C,R,w,S),C=r?C+w:0,R=r?0:R+S}var k=document.createElement("div");return k.style.width=o+"px",k.style.height=s+"px",k.appendChild(y),k},t.renderPreviewHTML=function e(t,r){switch(t.type){case"web-style":return c.previewWebStyleSymbol(t,e,r);case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":return s.previewSymbol3D(t,r);case"simple-marker":case"simple-line":case"simple-fill":case"picture-marker":case"picture-fill":case"text":return n.previewSymbol2D(t,r);case"cim":return o.previewCIMSymbol(t,r);default:return void l.neverReached(t)}},t.getDisplayedSymbol=function(t,l){return r.__awaiter(this,void 0,void 0,(function(){var o,n,s,c,d,h,p,y,b,m,v,g,f,w,S,C,R,x,V,M,k,D,P;return r.__generator(this,(function(_){switch(_.label){case 0:return t?(o=function e(t){return t&&"opacity"in t?t.opacity*e(t.parent):1}(t.layer||t.sourceLayer),!i.isSome(t.symbol)||i.isSome(l)&&!0===l.ignoreGraphicSymbol?[3,4]:"web-style"!==t.symbol.type?[3,2]:[4,t.symbol.fetchSymbol(i.isSome(l)?l.abortOptions:null)]):[2,void 0];case 1:return s=_.sent(),[3,3];case 2:s=t.symbol.clone(),_.label=3;case 3:return n=s,u.applyColorToSymbol(n,null,o),[2,n];case 4:return[4,(c=i.isSome(l)&&l.renderer||t.get("layer.renderer")||t.get("sourceLayer.renderer")).getSymbolAsync(t)];case 5:return(d=_.sent())?"web-style"!==d.type?[3,7]:[4,d.fetchSymbol(i.isSome(l)?l.abortOptions:null)]:[2,void 0];case 6:return d=_.sent(),[3,8];case 7:d=d.clone(),_.label=8;case 8:return!("visualVariables"in c)||"visualVariables"in c&&!c.visualVariables||"visualVariables"in c&&c.visualVariables&&!c.visualVariables.length?[2,d]:c.arcadeRequiredForVisualVariables&&(i.isNone(l)||i.isNone(l.arcade))?(h=r.__assign({},i.unwrap(l)),p=h,[4,a.loadArcade()]):[3,10];case 9:p.arcade=_.sent(),l=h,_.label=10;case 10:return[4,new Promise((function(t,r){e(["../../renderers/visualVariables/support/visualVariableUtils"],t,r)}))];case 11:for(y=_.sent(),b=[],m=[],v=[],g=[],f=0,w=c.visualVariables;f<w.length;f++)switch((S=w[f]).type){case"color":b.push(S);break;case"opacity":m.push(S);break;case"rotation":g.push(S);break;case"size":S.target||v.push(S)}return C=!!b.length&&b[b.length-1],R=C?y.getColor(C,t,l):null,x=!!m.length&&m[m.length-1],V=x?y.getOpacity(x,t,l):null,null!=o&&(V=null!=V?V*o:o),u.applyColorToSymbol(d,R,V),v.length?(M=y.getAllSizes(v,t,l),[4,u.applySizesToSymbol(d,M)]):[3,13];case 12:_.sent(),_.label=13;case 13:for(k=0,D=g;k<D.length;k++)P=D[k],u.applyRotationToSymbol(d,y.getRotationAngle(P,t,l),P.axis);return[2,d]}}))}))}}));