// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../assets","../../core/colorUtils","../../core/compilerUtils","../../core/Error","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/screenUtils","./gfxUtils","./IconSymbol3DLayerResource","./ObjectSymbol3DLayerResource","./previewUtils","./renderUtils","./styleUtils","./utils"],(function(e,a,r,t,s,l,i,o,n,h,p,u,c,m,f,v,y,d){Object.defineProperty(a,"__esModule",{value:!0});var b=t.getAssetUrl("esri/images/Legend/legend3dsymboldefault.png"),g=o.getLogger("esri.symbols.support.previewSymbol3D");function x(e){var a=e.outline,r=n.isSome(e.material)?e.material.color:null,t=n.isSome(r)?r.toRgba().toString():null;if(n.isNone(a))return"fill"===e.type&&"255,255,255,1"===t?{color:"#bdc3c7",width:.75}:null;var s=p.pt2px(a.size)||0;return{color:"rgba("+(n.isSome(a.color)?a.color.toRgba():"255,255,255,1")+")",width:Math.min(s,80)}}function k(e,a){void 0===a&&(a=1);var r=e.a,t=s.toHSV(e),l=t.h,i=t.s/a,o=100-(100-t.v)/a,n=s.toRGB({h:l,s:i,v:o});return[n.r,n.g,n.b,r]}function M(e,a){return Math.round(Math.min(Math.max(e+255*a*.75,0),255))}function S(e){return"water"===e.type?n.isNone(e.color)?null:e.color:n.isNone(e.material)||n.isNone(e.material.color)?null:e.material.color}function w(e,a){void 0===a&&(a=0);var r=S(e);if(!r){var t=M(u.defaultThematicColor.r,a);return[t,t,t,100]}for(var s=r.toRgba(),l=0;l<3;l++)s[l]=M(s[l],a);return s}function L(e){return e.outline?x(e):{color:"rgba(0, 0, 0, 1)",width:1.5}}function z(e,a){var r=S(e);if(!r)return null;var t="rgba(";return t+=M(r.r,a)+",",t+=M(r.g,a)+",",(t+=M(r.b,a)+",")+r.a+");"}function U(e,a){var r=z(e,a);return r?{color:r,width:Math.min(e.size?p.pt2px(e.size):.75,80)}:{}}function j(e,a,r){var t=.75*r;return{type:"linear",x1:t?.25*t:0,y1:t?.5*t:0,x2:t||4,y2:t?.5*t:4,colors:[{color:e,offset:0},{color:a,offset:1}]}}function D(e,a){var r,t=a&&a.size?p.pt2px(a.size):null,s=a&&a.maxSize?p.pt2px(a.maxSize):null,i=a&&a.disableUpsampling,o=e.symbolLayers,n=[],u=0,k=0,M=o.getItemAt(o.length-1);return M&&"icon"===M.type&&(r=M.size&&p.pt2px(M.size)),o.forEach((function(o){if("icon"===o.type||"object"===o.type){var g="icon"===o.type?o.size&&p.pt2px(o.size):0,M=t||g?Math.ceil(Math.min(t||g,s||120)):22;if(o&&o.resource&&o.resource.href){var S=function(e,a){var r=a&&a.resource,t=r&&r.href;return e.thumbnail&&e.thumbnail.url?h.resolve(e.thumbnail.url):t&&"object"!==a.type?h.resolve(d.getIconHref(e,a)):e.styleOrigin&&(e.styleOrigin.styleName||e.styleOrigin.styleUrl)?y.resolveWebStyleSymbol(e.styleOrigin,{portal:e.styleOrigin.portal},"webRef").catch((function(e){return e})).then((function(e){return e&&e.thumbnail&&e.thumbnail.url||b})):h.resolve(b)}(e,o).then((function(e){var a=o.get("material.color"),r=function(e){return"icon"===e.type?"multiply":"tint"}(o);return v.tintImageWithColor(e,M,a,r,i)})).then((function(e){var a=e.width,r=e.height;return u=Math.max(u,a),k=Math.max(k,r),[{shape:{type:"image",x:0,y:0,width:a,height:r,src:e.url},fill:null,stroke:null}]}));n.push(S)}else{var z=M;"icon"===o.type&&r&&t&&(z=M*(g/r));var U=a&&"tall"===a.symbolConfig||"object"===o.type&&function(e){var a=e.depth,r=e.height,t=e.width;return t&&a&&r&&t===a&&t<r}(o);u=Math.max(u,U?20:z),k=Math.max(k,z),n.push(h.resolve(function(e,a,r){var t=[];if(!e)return t;switch(e.type){case"icon":var s=a,i=a;switch(o=e.resource&&e.resource.primitive||c.defaultPrimitive){case"circle":t.push({shape:{type:"circle",cx:0,cy:0,r:.5*a},fill:w(e,0),stroke:x(e)});break;case"square":t.push({shape:{type:"path",path:[{command:"M",values:[0,i]},{command:"L",values:[0,0]},{command:"L",values:[s,0]},{command:"L",values:[s,i]},{command:"Z",values:[]}]},fill:w(e,0),stroke:x(e)});break;case"triangle":t.push({shape:{type:"path",path:[{command:"M",values:[0,i]},{command:"L",values:[.5*s,0]},{command:"L",values:[s,i]},{command:"Z",values:[]}]},fill:w(e,0),stroke:x(e)});break;case"cross":t.push({shape:{type:"path",path:[{command:"M",values:[.5*s,0]},{command:"L",values:[.5*s,i]},{command:"M",values:[0,.5*i]},{command:"L",values:[s,.5*i]}]},stroke:L(e)});break;case"x":t.push({shape:{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[s,i]},{command:"M",values:[s,0]},{command:"L",values:[0,i]}]},stroke:L(e)});break;case"kite":t.push({shape:{type:"path",path:[{command:"M",values:[0,.5*i]},{command:"L",values:[.5*s,0]},{command:"L",values:[s,.5*i]},{command:"L",values:[.5*s,i]},{command:"Z",values:[]}]},fill:w(e,0),stroke:x(e)});break;default:l.neverReached(o)}break;case"object":var o;switch(o=e.resource&&e.resource.primitive||m.defaultPrimitive){case"cone":var n=j(w(e,0),w(e,-.6),r?20:a),h=f.getConeShapes(a,r);t.push({shape:h[0],fill:n}),t.push({shape:h[1],fill:n});break;case"inverted-cone":var p=w(e,0),u=j(p,w(e,-.6),a),v=f.getInvertedConeShapes(a);t.push({shape:v[0],fill:u}),t.push({shape:v[1],fill:p});break;case"cube":var y=f.getCubeShapes(a,r);t.push({shape:y[0],fill:w(e,0)}),t.push({shape:y[1],fill:w(e,-.3)}),t.push({shape:y[2],fill:w(e,-.5)});break;case"cylinder":var d=j(w(e,0),w(e,-.6),r?20:a),b=f.getCylinderShapes(a,r);t.push({shape:b[0],fill:d}),t.push({shape:b[1],fill:d}),t.push({shape:b[2],fill:w(e,0)});break;case"diamond":var g=f.getDiamondShapes(a);t.push({shape:g[0],fill:w(e,-.3)}),t.push({shape:g[1],fill:w(e,0)}),t.push({shape:g[2],fill:w(e,-.3)}),t.push({shape:g[3],fill:w(e,-.7)});break;case"sphere":var k=j(w(e,0),w(e,-.6));k.x1=0,k.y1=0,k.x2=.25*a,k.y2=.25*a,t.push({shape:{type:"circle",cx:0,cy:0,r:.5*a},fill:k});break;case"tetrahedron":var M=f.getTetrahedronShapes(a);t.push({shape:M[0],fill:w(e,-.3)}),t.push({shape:M[1],fill:w(e,0)}),t.push({shape:M[2],fill:w(e,-.6)});break;default:l.neverReached(o)}}return t}(o,z,U)))}}})),h.eachAlways(n).then((function(e){var r=[];return e.forEach((function(e){e.value?r.push(e.value):e.error&&g.warn("error while building swatchInfo!",e.error)})),v.renderSymbol(r,[u,k],{node:a&&a.node,scale:!1,opacity:a&&a.opacity})}))}a.getSymbolLayerFill=w,a.previewSymbol3D=function(e,a){if(0===e.symbolLayers.length)return h.reject(new i("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));var t=null;switch(e.type){case"point-3d":t=D(e,a);break;case"line-3d":t=function(e,a){var t,s=e.symbolLayers,l=[],i=d.isVolumetricSymbol(e),o=a&&a.size?p.pt2px(a.size):null,n=(a&&a.maxSize?p.pt2px(a.maxSize):null)||80,u=0,c=0;return s.forEach((function(e,a){if(e&&("line"===e.type||"path"===e.type)){var s=[];switch(e.type){case"line":var i=(g=U(e,0))&&g.width||0;0===a&&(t=i);var h=Math.min(o||i,n),p=0===a?h:o?h*(i/t):h,m=p>20?2*p:40;c=Math.max(c,p),u=Math.max(u,m),g.width=p,s.push({shape:{type:"path",path:[{command:"M",values:[0,.5*c]},{command:"L",values:[u,.5*c]}]},stroke:g});break;case"path":var v=Math.min(o||22,n),y=w(e,0),d=w(e,-.2),b=z(e,-.4),g=b?{color:b,width:1}:{};if("quad"===e.profile){var x=e.width||e.size,k=e.height||e.size,M=x&&k?x/k:1,S=f.getPathSymbolShapes(M),L=r.__assign(r.__assign({},g),{join:"bevel"});s.push({shape:S[0],fill:d,stroke:L}),s.push({shape:S[1],fill:d,stroke:L}),s.push({shape:S[2],fill:y,stroke:L})}else s.push({shape:f.shapes.pathSymbol3DLayer[0],fill:d,stroke:g}),s.push({shape:f.shapes.pathSymbol3DLayer[1],fill:y,stroke:g});c=Math.max(c,v),u=c}l.push(s)}})),h.resolve(v.renderSymbol(l,[u,c],{node:a&&a.node,scale:i,opacity:a&&a.opacity}))}(e,a);break;case"polygon-3d":case"mesh-3d":t=function(e,a){for(var t="mesh-3d"===e.type,s=e.symbolLayers,l=a&&a.size?p.pt2px(a.size):null,i=a&&a.maxSize?p.pt2px(a.maxSize):null,o=l||22,n=[],u=0,c=0,m=!1,y=0;y<s.length;y++){var d=s.getItemAt(y),b=[];if(!t||"fill"===d.type){var g=f.shapes.fill[0];switch(d.type){case"fill":var M=x(d),L=Math.min(o,i||120);u=Math.max(u,L),c=Math.max(c,L),m=!0,b.push({shape:g,fill:w(d,0),stroke:M});break;case"line":var z={stroke:U(d,0),shape:g};u=Math.max(u,22),c=Math.max(c,22),b.push(z);break;case"extrude":var j=r.__assign({join:"round"},U(d,-.4)),D=w(d,0),R=w(d,-.2),I=Math.min(o,i||120),_=f.getExtrudeSymbolShapes(I);j.width=1,b.push({shape:_[0],fill:R,stroke:j}),b.push({shape:_[1],fill:R,stroke:j}),b.push({shape:_[2],fill:D,stroke:j});var C=22*.7+.5*I;u=Math.max(u,22),c=Math.max(c,C);break;case"water":var O=S(d),P=(D=k(O),k(O,2)),N=k(O,3),E=f.getWaterSymbolShapes();m=!0,b.push({shape:E[0],fill:D}),b.push({shape:E[1],fill:P}),b.push({shape:E[2],fill:N});L=Math.min(o,i||120);u=Math.max(u,L),c=Math.max(c,L)}n.push(b)}}return h.resolve(v.renderSymbol(n,[u,c],{node:a&&a.node,scale:m,opacity:a&&a.opacity}))}(e,a)}return t||h.reject(new i("symbolPreview: swatchInfo3D","symbol not supported."))}}));