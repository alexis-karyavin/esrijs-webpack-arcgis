// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../core/Logger","../../geometry/support/jsonUtils","../cim/CIMEffects","../cim/CIMOperators","../cim/CIMPlacements","./Rect"],(function(t,r,e,i,o,a,n,s,h){Object.defineProperty(r,"__esModule",{value:!0}),r.C_DEG_TO_RAD=Math.PI/180;var c=i.getLogger("esri.symbols.cim.CIMSymbolDrawHelper"),f=function(){function t(t){this._t=t}return t.createIdentity=function(){return new t([1,0,0,0,1,0])},t.prototype.clone=function(){return new t(this._t.slice())},t.prototype.transform=function(t){var r=this._t;return[r[0]*t[0]+r[1]*t[1]+r[2],r[3]*t[0]+r[4]*t[1]+r[5]]},t.createScale=function(r,e){return new t([r,0,0,0,e,0])},t.prototype.scale=function(t,r){var e=this._t;return e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=r,e[4]*=r,e[5]*=r,this},t.prototype.scaleRatio=function(){return Math.sqrt(this._t[0]*this._t[0]+this._t[1]*this._t[1])},t.createTranslate=function(r,e){return new t([0,0,r,0,0,e])},t.prototype.translate=function(t,r){var e=this._t;return e[2]+=t,e[5]+=r,this},t.createRotate=function(r){var e=Math.cos(r),i=Math.sin(r);return new t([e,-i,0,i,e,0])},t.prototype.rotate=function(r){return this.multiply(t.createRotate(r))},t.prototype.multiply=function(t){var r=this._t,e=t._t,i=r[0]*e[0]+r[3]*e[1],o=r[1]*e[0]+r[4]*e[1],a=r[2]*e[0]+r[5]*e[1]+e[2],n=r[0]*e[3]+r[3]*e[4],s=r[1]*e[3]+r[4]*e[4],h=r[2]*e[3]+r[5]*e[4]+e[5];return r[0]=i,r[1]=o,r[2]=a,r[3]=n,r[4]=s,r[5]=h,this},t}();r.Transformation=f;var l=function(){function t(t){this._transfos=[],this._sizeTransfos=[],this._transfos.push(t||f.createIdentity()),this._sizeTransfos.push(t?t.scaleRatio():1)}return t.prototype.transformPt=function(t){return this._transfos[this._transfos.length-1].transform(t)},t.prototype.transformSize=function(t){return t*this._sizeTransfos[this._sizeTransfos.length-1]},t.prototype.back=function(){return this._transfos[this._transfos.length-1]},t.prototype.push=function(t,r){var e=r?t.scaleRatio():1;t.multiply(this.back()),this._transfos.push(t),this._sizeTransfos.push(this._sizeTransfos[this._sizeTransfos.length-1]*e)},t.prototype.pop=function(){this._transfos.splice(-1,1),this._sizeTransfos.splice(-1,1)},t.prototype.drawSymbol=function(t,r){if(t)switch(t.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this.drawMultiLayerSymbol(t,r)}},t.prototype.drawMultiLayerSymbol=function(t,r){if(t){var e=t.symbolLayers;if(e){var i=t.effects;if(i){var o=this.executeEffects(i,r);if(o)for(var a=o.next();a;)this.drawSymbolLayers(e,a),a=o.next()}else this.drawSymbolLayers(e,r)}}},t.prototype.executeEffects=function(t,r){for(var e=new a.SimpleGeometryCursor(r),i=0,o=t;i<o.length;i++){var s=o[i],h=n.getEffectOperator(s);h&&(e=h.execute(e,s,1))}return e},t.prototype.drawSymbolLayers=function(t,r){for(var e=t.length;e--;){var i=t[e];if(i&&!1!==i.enable){var o=i.effects;if(o){var a=this.executeEffects(o,r);if(a)for(var n=a.next();n;)this.drawSymbolLayer(i,n),n=a.next()}else this.drawSymbolLayer(i,r)}}},t.prototype.drawSymbolLayer=function(t,r){switch(t.type){case"CIMSolidFill":this.drawSolidFill(r,t.color);break;case"CIMSolidStroke":this.drawSolidStroke(r,t.color,t.width,t.capStyle,t.joinStyle,t.miterLimit);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":this.drawMarkerLayer(t,r)}},t.prototype.drawMarkerLayer=function(t,r){var e=t.markerPlacement;if(e){var i=n.getPlacementOperator(e);if(i){var o=i.execute(r,e,1);if(o)for(var a=o.next();a;)this.drawMarker(t,a),a=o.next()}}else{var h=new s.Placement;h.tx=r.x,h.ty=r.y,this.drawMarker(t,h)}},t.prototype.drawMarker=function(t,r){switch(t.type){case"CIMCharacterMarker":case"CIMPictureMarker":this.drawPictureMarker(t,r);break;case"CIMVectorMarker":this.drawVectorMarker(t,r)}},t.prototype.drawPictureMarker=function(t,r){},t.prototype.drawVectorMarker=function(t,e){if(t){var i=t.markerGraphics;if(i){var o=t.size,a=t.frame,n=a?a.ymax-a.ymin:0,s=o&&n?o/n:1,h=f.createIdentity();a&&h.translate(.5*-(a.xmax+a.xmin),.5*-(a.ymax+a.ymin));var l=t.anchorPoint;if(l){var y=l.x,u=l.y;"Absolute"!==t.anchorPointUnits&&a&&(y*=a.xmax-a.xmin,u*=a.ymax-a.ymin),h.translate(-y,-u)}1!==s&&h.scale(s,s),t.rotation&&h.rotate(t.rotation*r.C_DEG_TO_RAD),h.translate(t.offsetX||0,t.offsetY||0),h.translate(e.tx,e.ty),this.push(h,t.scaleSymbolsProportionally);for(var p=0,m=i;p<m.length;p++){var _=m[p];_&&_.symbol&&_.geometry||c.error("Invalid marker graphic",_),this.drawSymbol(_.symbol,_.geometry)}this.pop()}}},t}();r.CIMSymbolDrawHelper=l;var y=function(t){function r(){var r=t.call(this)||this;return r.reset(),r}return e.__extends(r,t),r.prototype.reset=function(){this._xmin=this._ymin=1/0,this._xmax=this._ymax=-1/0},r.prototype.envelope=function(){return new h.default(this._xmin,this._ymin,this._xmax-this._xmin,this._ymax-this._ymin)},r.prototype._merge=function(t,r){t[0]-r<this._xmin&&(this._xmin=t[0]-r),t[0]+r>this._xmax&&(this._xmax=t[0]+r),t[1]-r<this._ymin&&(this._ymin=t[1]-r),t[1]+r>this._ymax&&(this._ymax=t[1]+r)},r.prototype.drawSolidFill=function(t){if(t&&t.rings)for(var r=0,e=t.rings;r<e.length;r++){var i=e[r],o=i?i.length:0;if(o>2){this._merge(this.transformPt(i[0]),0);for(var a=1;a<o;++a)this._merge(this.transformPt(i[a]),0)}}},r.prototype.drawSolidStroke=function(t,r,e){var i,a=.5*this.transformSize(e);if(i=o.isPolygon(t)?t.rings:t.paths)for(var n=0,s=i;n<s.length;n++){var h=s[n],c=h?h.length:0;if(c>1){this._merge(this.transformPt(h[0]),a);for(var f=1;f<c;++f)this._merge(this.transformPt(h[f]),a)}}},r}(l);r.EnvDrawHelper=y;var u=function(t){function r(r,e){var i=t.call(this,e)||this;return i._ctx=r,i}return e.__extends(r,t),r.prototype.drawSolidFill=function(t,r){if(t&&t.rings){var e=this._ctx;e.fillStyle="string"==typeof r?r:"rgba("+Math.round(r[0])+","+Math.round(r[1])+","+Math.round(r[2])+","+r[3]/255+")",e.beginPath();for(var i=0,o=t.rings;i<o.length;i++){var a=o[i],n=a?a.length:0;if(n>2){var s=this.transformPt(a[0]);e.moveTo(s[0],s[1]);for(var h=1;h<n;++h)s=this.transformPt(a[h]),e.lineTo(s[0],s[1]);e.closePath()}}e.fill("evenodd")}},r.prototype.drawSolidStroke=function(t,r,e,i,a,n){if(r&&0!==e){var s=this._ctx;s.strokeStyle="string"==typeof r?r:"rgba("+Math.round(r[0])+","+Math.round(r[1])+","+Math.round(r[2])+","+r[3]/255+")",s.lineWidth=this.transformSize(e)+.5,this._setCapStyle(i),this._setJoinStyle(a),s.miterLimit=n,s.beginPath();var h,c=!1;o.isPolygon(t)?(h=t.rings,c=!0):h=t.paths;for(var f=0,l=h;f<l.length;f++){var y=l[f],u=y?y.length:0;if(u>1){var p=this.transformPt(y[0]);s.moveTo(p[0],p[1]);for(var m=1;m<u;++m)p=this.transformPt(y[m]),s.lineTo(p[0],p[1]);c&&s.closePath()}}s.stroke()}},r.prototype._setCapStyle=function(t){switch(t){case"Butt":this._ctx.lineCap="butt";break;case"Round":this._ctx.lineCap="round";break;case"Square":this._ctx.lineCap="square"}},r.prototype._setJoinStyle=function(t){switch(t){case"Bevel":this._ctx.lineJoin="bevel";break;case"Round":this._ctx.lineJoin="round";break;case"Miter":this._ctx.lineJoin="miter"}},r}(l);r.CanvasDrawHelper=u}));