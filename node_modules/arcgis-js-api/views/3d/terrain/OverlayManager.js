// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../Graphic","../../../core/Accessor","../../../core/Handles","../../../core/has","../../../core/mathUtils","../../../core/mathUtils","../../../core/scheduling","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/Point","../../../geometry/support/aaBoundingRect","../../../layers/support/timeUtils","../../../symbols/SimpleMarkerSymbol","../state/utils/viewUtils","../support/animationUtils","../support/debugFlags","../support/earthUtils","../support/geometryUtils","../support/mathUtils","../support/projectionUtils","./OverlayRenderer","../webgl-engine/lib/Intersector","../webgl-engine/lib/localOrigin","../webgl-engine/parts/requireUtils","../../support/Scheduler"],(function(e,t,r,i,a,s,n,o,l,d,c,h,u,p,y,v,g,_,f,T,m,w,O,R,x,S,D,M,I,C,b,E){Object.defineProperty(t,"__esModule",{value:!0});var U,P=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]],A=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._handles=new s,t._overlaySR=null,t._renderSR=null,t._overlaySREqualsRenderSR=!0,t._drapeSources=new Map,t._drapeTargets=new Set,t._overlays=null,t._drapeSourceTypes=[0,0],t._drapeTargetTypes=[0,0],t._renderedAltitude=0,t._placementDirty=!1,t._drawTexturesDirty=!1,t._drawTexturesAnimateDirty=!1,t._hasUnusedRenderTargets=!1,t._isSpherical=!1,t._longitudeCyclical=null,t._latestOriginId=0,t._maxResolution=n("esri-mobile")?2048:4096,t._animationTimeLast=0,t._forceAnimation=!1,t}return r.__extends(t,e),Object.defineProperty(t.prototype,"updating",{get:function(){return this.needsUpdate()||this.renderer.updating},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasHighlights",{get:function(){return this.renderer.hasHighlights},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rendersOccluded",{get:function(){return this.renderer.rendersOccluded},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this._stage=this.view._stage,this.renderer=new M.OverlayRenderer({renderView:this._stage.renderView}),this._stage.renderView.updateLogicClients.add(this.renderer),this._drapeTargetTypes[0]++,this.renderer.onHasHighlightsChanged=function(){e.setDrawTexturesDirty(),e.notifyChange("hasHighlights")},this.renderer.onRendersOccludedChanged=function(){e.setDrawTexturesDirty(),e.notifyChange("rendersOccluded")},this.renderer.onContentChanged=function(){e.setDrawTexturesDirty()},this.groundIntersector=new I.Intersector(this.view.viewingMode),this.groundIntersector.options.backfacesTerrain=!0,this.groundIntersector.options.invisibleTerrain=!0,this.groundIntersector.options.hud=!1,this._handles.add([this.view.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],(function(){return e.setOverlayPlacementDirty()})),this.terrainSurface.on("elevation-change",(function(){return e.setOverlayPlacementDirty()})),this.view.on("resize",(function(){return e.setOverlayPlacementDirty()})),d.addFrameTask({preRender:function(t){e.renderer.commitChanges(),e.hasOverlays()&&(e._dispatchRendererUpdate(t),e._drawOverlayTextures()),e._hasUnusedRenderTargets&&e._collectUnusedRenderTargetMemory()}}),this.view.resourceController.scheduler.registerTask(E.Task.OVERLAY_MANAGER,(function(){return e.updateOverlays()}),(function(){return e.needsUpdate()})),this.view._stage.renderView.events.on("force-camera-for-screenshot",(function(t){e.updateOverlays(t),e._drawOverlayTextures()}))])},t.prototype.destroy=function(){var e=this;this._drapeSources.forEach((function(t,r){return e._unregisterDrapeSource(r)})),this._drapeTargets.forEach((function(t,r){return e._unregisterDrapeTarget(r)})),this._drapeTargetTypes[0]--,this._disposeOverlays(),this._stage.renderView.updateLogicClients.remove(this.renderer),this.renderer.dispose(),this._handles&&(this._handles.destroy(),this._handles=null)},t.prototype.hasOverlays=function(){return!!this._overlays},t.prototype.setSpatialReference=function(e,t){this._overlaySR=e,this._longitudeCyclical=null,e?(this._renderSR=this.view.renderSpatialReference,this._overlaySREqualsRenderSR=this._overlaySR.equals(this._renderSR),this._isSpherical=t,t&&(this._longitudeCyclical=e.isWebMercator?new S.Cyclical(-20037508.342787,20037508.342787):new S.Cyclical(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical)):this._disposeOverlays(),this.notifyChange("updating")},t.prototype.getGpuMemoryUsage=function(){return this.renderer.getGpuMemoryUsage()},t.prototype.updateLayerViews=function(e){for(var t=this,r=0,i=this.view.allLayerViews.items;r<i.length;r++){var a=i[r];"drapeSourceType"in a&&!this._drapeSources.has(a)&&this._registerDrapeSource(a),"drapeTargetType"in a&&!this._drapeTargets.has(a)&&this._registerDrapeTarget(a)}this._drapeSources.forEach((function(r,i){e.has(i.uid)||t._unregisterDrapeSource(i)})),this._drapeTargets.forEach((function(r){e.has(r.uid)||t._unregisterDrapeTarget(r)})),this.renderer.updateLayerOrder(),this.setDrawTexturesDirty()},t.prototype._registerDrapeSource=function(e){var t=this,r=e.on("draped-data-change",(function(){return t.setOverlayContentDirty()}));this._drapeSourceTypes[e.drapeSourceType]++,this._drapeSources.set(e,[r]),this._overlays&&e.setDrapingExtent&&this._overlays.forEach((function(r,i){return t._updateDrapeSource(e,i,r)})),this.setOverlayContentDirty()},t.prototype._updateDrapeSource=function(e,t,r){e.setDrapingExtent&&e.setDrapingExtent(t,r.extent,this._overlaySR,r.resolution,r.renderLocalOrigin,r.pixelRatio)},t.prototype._unregisterDrapeSource=function(e){if(this._drapeSources.has(e)){var t=this._drapeSources.get(e);t&&t.forEach((function(e){return e.remove()})),this._drapeSourceTypes[e.drapeSourceType]--,this._drapeSources.delete(e),this.setOverlayContentDirty()}},t.prototype._registerDrapeTarget=function(e){this._drapeTargets.add(e),this._updateDrapeTarget(e),this._drapeTargetTypes[e.drapeTargetType]++},t.prototype._updateDrapeTarget=function(e){var t=this;this._overlays&&this._overlays.forEach((function(r,i){var a=r.renderTargets,s=t.needsColorWithoutRasterImage()?a.colorWithoutRasterImage:t.hasDrapedFeatures()?a.color:null,n=a.highlight,o=a.water;e.setDrapingTextures(i,r.extent,s&&s.valid?t.renderer.getRenderTargetTexture(s.id):null,n.valid?t.renderer.getRenderTargetTexture(n.id):null,o.valid?t.renderer.getRenderTargetTexture(o.id):null)}))},t.prototype._unregisterDrapeTarget=function(e){this._drapeTargets.delete(e),this._drapeTargetTypes[e.drapeTargetType]--},t.prototype.setOverlayContentDirty=function(){this.setOverlayPlacementDirty(),this.setDrawTexturesDirty()},t.prototype.setOverlayPlacementDirty=function(){this._placementDirty=!0,this.notifyChange("updating")},t.prototype.updateOverlays=function(e){if(void 0===e&&(e=this.view.state.camera),this._overlaySR){var t,r,i,a=(t=e.fullWidth,r=e.fullHeight,i=Math.max(t,r)+256,o.nextHighestPowerOfTwo(i)),s=Math.min(a,this._maxResolution);this._computeOverlayExtents(e,a,G);var n=_.width(G.inner)/_.width(G.outer);this._initOverlays();var l=this._updateOverlay(0,G.inner,s,1),d=this._updateOverlay(1,G.outer,s,n);(l||d)&&(this.terrainSurface.updateTileOverlayParams(),this.setDrawTexturesDirty()),this._placementDirty=!1,this.terrainSurface.updateOverlayOpacity(),this.notifyChange("updating")}},t.prototype._updateOverlay=function(e,t,r,i){var a=this,s=this._overlays[e];if(!function(e,t){for(var r=O.TESTS_DISABLE_UPDATE_THRESHOLDS?0:1e-5*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]),i=0;i<4;i++)if(Math.abs(t[i]-e[i])>r)return!0;return!1}(t,s.extent)&&r===s.resolution&&s.pixelRatio===i)return!1;_.set(s.extent,t),s.resolution=r,s.pixelRatio=i;var n=_.center(s.extent);return s.renderLocalOrigin=C.fromValues(n[0],n[1],0,"OV_"+this._latestOriginId++),this._drapeSources.forEach((function(t,r){return a._updateDrapeSource(r,e,s)})),!0},t.prototype.needsUpdate=function(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||O.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._overlaySR&&!this._get("suspended")&&this.terrainSurface.ready},t.prototype.updateOpacity=function(e){return this._overlays?this._getAltitudeBasedOpacity(e,this._renderedAltitude):1},t.prototype._getAltitudeBasedOpacity=function(e,t){if(3.5*e<t){var r=(e-t/10)/(t/3.5-t/10);return Math.sqrt(o.clamp(r,0,1))}return 1},t.prototype.setTileParameters=function(e,t,r){if(this._overlays){var i=this._overlays[0],a=this._overlays[1],s=_.intersection(e.extent,e.surface.extent,q);this._rectInsideRect(s,i.extent)?(this._setTileOverlayData(s,i,t.overlays[0]),this._invalidateTileOverlayData(t.overlays[1])):this._rectanglesOverlap(s,i.extent)?(this._setTileOverlayData(s,i,t.overlays[0]),this._setTileOverlayData(s,a,t.overlays[1])):this._rectanglesOverlap(s,a.extent)?(this._setTileOverlayData(s,a,t.overlays[0]),this._invalidateTileOverlayData(t.overlays[1])):(this._invalidateTileOverlayData(t.overlays[0]),this._invalidateTileOverlayData(t.overlays[1]))}else this._invalidateTileOverlayData(t.overlays[0]),this._invalidateTileOverlayData(t.overlays[1]);t.overlayOpacity=void 0!==r?r:1},t.prototype.overlayPixelSizeInMapUnits=function(e){if(!this._overlays)return 0;var t=this._overlays[0],r=this._overlays[1],i=this._pointIsInExtent(e,t.extent)?t:r;return(i.extent[2]-i.extent[0])/i.resolution},t.prototype._setTileOverlayData=function(e,t,r){var i=t.extent;r.texScale[0]=(e[2]-e[0])/(i[2]-i[0]),r.texScale[1]=(e[3]-e[1])/(i[3]-i[1]);var a=e[0];if(this._longitudeCyclical){a=this._longitudeCyclical.minimalMonotonic(i[0],a);var s=this._longitudeCyclical.minimalMonotonic(i[0],e[2]);a>s&&(a=s-(e[2]-e[0]))}r.texOffset[0]=(a-i[0])/(i[2]-i[0]),r.texOffset[1]=(e[1]-i[1])/(i[3]-i[1]);var n=t.renderTargets;r.renderTargetIds.color=n.color.valid?n.color.id:null,r.renderTargetIds.highlight=n.highlight.valid?n.highlight.id:null,r.renderTargetIds.water=n.water.valid?n.water.id:null,r.renderTargetIds.occluded=n.occluded.valid?n.occluded.id:null},t.prototype._invalidateTileOverlayData=function(e){e.renderTargetIds.color=null,e.renderTargetIds.highlight=null,e.renderTargetIds.water=null,e.renderTargetIds.occluded=null},t.prototype._createEmptyOverlay=function(e){return{extent:_.create(),resolution:0,renderTargets:{color:{id:this.renderer.createRenderTarget("overlay"+e,!0),valid:!1,lastUsed:1/0},colorWithoutRasterImage:{id:this.renderer.createRenderTarget("overlayWithoutRasterImage"+e,!0),valid:!1,lastUsed:1/0},highlight:{id:this.renderer.createRenderTarget("overlayHighlight"+e,!1),valid:!1,lastUsed:1/0},water:{id:this.renderer.createRenderTarget("overlayWaterMask"+e,!0),valid:!1,lastUsed:1/0},occluded:{id:this.renderer.createRenderTarget("overlayOccluded"+e,!0),valid:!1,lastUsed:1/0}},renderLocalOrigin:C.fromValues(0,0,0,"O"),pixelRatio:1}},t.prototype._initOverlays=function(){this._overlays||(this._overlays=[this._createEmptyOverlay(0),this._createEmptyOverlay(1)])},t.prototype._disposeOverlays=function(){var e=this;this._overlays&&(this._overlays.forEach((function(t){e.renderer.disposeRenderTarget(t.renderTargets.color.id),e.renderer.disposeRenderTarget(t.renderTargets.colorWithoutRasterImage.id),e.renderer.disposeRenderTarget(t.renderTargets.highlight.id),e.renderer.disposeRenderTarget(t.renderTargets.water.id),e.renderer.disposeRenderTarget(t.renderTargets.occluded.id)})),this._overlays=null)},t.prototype.hotReloadShaders=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return b.removeLoadedShaderModules(),[4,this.renderer.hotReloadShaders()];case 1:return e.sent(),this.updateOverlays(),this.needsUpdate(),[2]}}))}))},t.prototype.stopAnimationsAtTime=function(e){this.renderer.stopAnimationsAtTime(e),this._forceAnimation=!0},t.prototype._dispatchRendererUpdate=function(e){var t=f.Milliseconds(e.time-this._animationTimeLast);t<w.DESIRED_DRAPED_ANIMATION_MS&&!this._forceAnimation||(this._animationTimeLast=e.time,this.renderer.updateLogic({dt:t,camera:this._stage.getCamera()})&&(this._drawTexturesAnimateDirty=!0))},t.prototype.setDrawTexturesDirty=function(){this._overlays?this._drawTexturesDirty=!0:this.setOverlayPlacementDirty()},t.prototype._intersectGroundFromView=function(e,t,r,i){var a=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,j,t,r),s=a.origin,n=u.vec3.add(F,a.origin,a.direction);return this.groundIntersector.reset(s,n),this.groundIntersector.intersect([],null,e),this.view.basemapTerrain.intersect(this.groundIntersector,null,s,n),this.groundIntersector.results.min.getIntersectionPoint(i)},t.prototype._findHorizonBasedPointOfInterest=function(e,t,r){var i=.5;if("global"===this.view.viewingMode){var a=p.vec3f64.clone(e.eye);u.vec3.normalize(a,a),u.vec3.negate(a,a);var s=u.vec3.length(t),n=Math.asin(s/u.vec3.length(e.eye)),l=Math.acos(u.vec3.dot(e.viewForward,a)),d=n-(l-.5*e.fovY),c=o.clamp(d/e.fovY,0,1),h=-n-(l-.5*e.fovY),g=o.clamp(h/e.fovY,0,1);i=1===c&&0===g?.5:g+.55*(c-g)}else{var _=.5*Math.PI-Math.acos(-e.viewForward[2]),f=Math.tan(_),T=v.vec4f64.fromValues(0,f,1,0),m=y.vec4.transformMat4(T,T,e.projectionMatrix)[1],w=o.clamp(.5+.5*m,0,1);i=1===w||0===w?.5:e.eye[2]>0?.55*w:1-.55*(1-w)}return!!this._intersectGroundFromView(e,.5,i,r)},t.prototype._computeOverlayExtents=function(e,t,r){var a=this.terrainSurface.extent,s=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,n=p.vec3f64.create();this._findHorizonBasedPointOfInterest(e,s,n)||u.vec3.copy(n,s),this._renderedAltitude=this.view.renderCoordsHelper.getAltitude(e.eye);var o=u.vec3.distance(e.eye,n),d=m.viewAngle(this.view.renderCoordsHelper,s,e.eye),c=Math.PI/2-Math.abs(d-Math.PI/2);if(O.OVERLAY_SHOW_CENTER){var v=new T({color:[255,0,0],outline:{color:[255,255,255],width:2}}),f=new g;D.vectorToPoint(n,this._renderSR,f,this._overlaySR);var w=new i({geometry:f,symbol:v});void 0!==U&&this.view.graphics.remove(U),this.view.graphics.add(w),U=w}this._overlaySREqualsRenderSR||D.vectorToVector(n,this._renderSR,n,this._overlaySR);var x=t*e.perRenderPixelRatio*o/2,S=!1,M=1/0;this._isSpherical&&(this._overlaySR.isWebMercator?(x/=Math.cos(D.webMercator.y2lat(n[1])),M=this.terrainSurface.extent[3]):(S=!0,x/=R.metersPerDegree,M=90),x>=M&&(x=M,n[1]=0,this._overlaySR.isWebMercator&&(n[0]=0)));var I=1;S&&x*(I=1/Math.max(.2,Math.cos(Math.abs(l.deg2rad(n[1])))))>180&&(I=180/x);var C=Math.log(2)/12,b=(x=Math.exp(Math.round(Math.log(x)/C)*C))*I,E=.5*t/(32*b),A=.5*t/(32*x);n[0]=Math.round(n[0]*E)/E,n[1]=Math.round(n[1]*A)/A;var V=r.inner;V[0]=n[0]-b,V[1]=n[1]-x,V[2]=n[0]+b,V[3]=n[1]+x,this._isSpherical&&this._shiftExtentToFitBounds(V,1/0,M);var H=r.outer;if(_.set(H,V),6*b>a[2]-a[0])_.set(H,a);else if(c<=.25*Math.PI)H[0]-=b,H[1]-=x,H[2]+=b,H[3]+=x;else{D.vectorToVector(e.eye,this._renderSR,F,this._overlaySR),h.vec2.subtract(W,n,F);var L=-Math.atan2(W[1],W[0])+.125*Math.PI;L<0&&(L+=2*Math.PI);var G=Math.floor(L/(.25*Math.PI));y.vec4.scale(W,P[G],2*x),W[0]*=I,W[2]*=I,y.vec4.add(H,H,W)}if(this._isSpherical&&(H[0]=this._longitudeCyclical.clamp(H[0]),H[2]=this._longitudeCyclical.clamp(H[2]),H[1]=Math.max(H[1],-M),H[3]=Math.min(H[3],M)),!this._isSpherical&&a){var j=_.intersection(V,a,q),z=_.intersection(H,a,B);_.contains(j,z)&&(H[2]=H[0],H[3]=H[1])}},t.prototype._drawOverlayTextures=function(){var e=this;if(this._drawTexturesDirty||this._drawTexturesAnimateDirty){var t=this._drawOverlay(0),r=this._drawOverlay(1);0!==t&&0!==r||this.terrainSurface.updateTileOverlayParams(),this._collectUnusedRenderTargetMemory(),this._drapeTargets.forEach((function(t){return e._updateDrapeTarget(t)})),this._drawTexturesDirty?(this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this.terrainSurface.requestRender(),this.terrainSurface.setPendingUpdates()):(this._drawTexturesAnimateDirty=!1,this.terrainSurface.requestRender(0))}},t.prototype._setupGeometryViewsCyclical=function(e,t,r){this._setupGeometryViewsDirect(e,t,r);var i=.001*this._longitudeCyclical.range;if(t[0]-i<=this._longitudeCyclical.min){var a=e.views[e.numViews++];y.vec4.set(a.viewport,0,0,r,r),_.offset(t,this._longitudeCyclical.range,0,a.extent)}if(t[2]+i>=this._longitudeCyclical.max){a=e.views[e.numViews++];y.vec4.set(a.viewport,0,0,r,r),_.offset(t,-this._longitudeCyclical.range,0,a.extent)}},t.prototype._setupGeometryViewsDirect=function(e,t,r){e.numViews=1;var i=e.views[0];_.set(i.extent,t),y.vec4.set(i.viewport,0,0,r,r)},t.prototype._drawOverlay=function(e){var t=this._overlays[e],r=V(t),i=t.extent,a=t.resolution,s=t.pixelRatio;this._longitudeCyclical?this._setupGeometryViewsCyclical(L,i,a):this._setupGeometryViewsDirect(L,i,a),L.width=a,L.height=a,L.pixelRatio=s*this.view.state.camera.pixelRatio,L.index=e;var n=this.renderer,o=t.renderTargets;return o.color.valid=n.draw(o.color.id,L),o.highlight.valid=n.drawHighlights(o.highlight.id,L),o.water.valid=n.drawNormals(o.water.id,L),o.occluded.valid=n.drawOccluded(o.occluded.id,L),o.colorWithoutRasterImage.valid=this.needsColorWithoutRasterImage()&&n.drawWithoutRasterImage(o.colorWithoutRasterImage.id,L),r^V(t)?0:1},t.prototype.needsColorWithoutRasterImage=function(){return this._drapeSourceTypes[0]>0&&this._drapeSourceTypes[1]>0&&this._drapeTargetTypes[1]>0},t.prototype.hasDrapedFeatures=function(){return this._drapeSourceTypes[1]>0},t.prototype._collectUnusedRenderTargetMemory=function(){var e=performance.now();this._hasUnusedRenderTargets=!1;for(var t=0,r=this._overlays;t<r.length;t++){var i=r[t];for(var a in i.renderTargets){var s=i.renderTargets[a];s.valid?s.lastUsedTimestamp=e:e-s.lastUsedTimestamp>H?(this.renderer.disposeRenderTargetMemory(s.id),s.lastUsedTimestamp=1/0):s.lastUsedTimestamp<1/0&&(this._hasUnusedRenderTargets=!0)}}},t.prototype._rectanglesOverlap=function(e,t){return this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):_.intersects(e,t)},t.prototype._rectInsideRect=function(e,t){return this._longitudeCyclical?this._longitudeCyclical.contains(t[0],t[2],e[0])&&this._longitudeCyclical.contains(t[0],t[2],e[2])&&e[1]>t[1]&&e[3]<t[3]:_.contains(t,e)},t.prototype._pointIsInExtent=function(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];var r=e.x,i=e.y;return r>t[0]&&r<t[2]&&i>t[1]&&i<t[3]},t.prototype._shiftExtentToFitBounds=function(e,t,r){var i=0,a=0;e[0]<-t?i=e[0]+t:e[2]>t&&(i=t-e[2]),e[1]<-r?a=e[1]+r:e[3]>r&&(a=r-e[3]),_.offset(e,i,a)},Object.defineProperty(t.prototype,"test",{get:function(){return{overlays:this._overlays,renderer:this.renderer}},enumerable:!0,configurable:!0}),r.__decorate([c.property()],t.prototype,"renderer",void 0),r.__decorate([c.property()],t.prototype,"view",void 0),r.__decorate([c.property()],t.prototype,"terrainSurface",void 0),r.__decorate([c.property({readOnly:!0,aliasOf:"terrainSurface.suspended"})],t.prototype,"suspended",void 0),r.__decorate([c.property({readOnly:!0,dependsOn:["terrainSurface.ready","suspended","renderer.updating"]})],t.prototype,"updating",null),r.__decorate([c.property({type:Boolean})],t.prototype,"hasHighlights",null),r.__decorate([c.property({type:Boolean})],t.prototype,"rendersOccluded",null),t=r.__decorate([c.subclass("esri.views.3d.terrain.OverlayManager")],t)}(a);function V(e){var t=e.renderTargets;return+t.color.valid|+t.colorWithoutRasterImage.valid<<1|+t.highlight.valid<<2|+t.water.valid<<3|+t.occluded.valid<<4}t.OverlayManager=A;var H=1e3,L={width:0,height:0,pixelRatio:0,views:[{viewport:_.create(),extent:_.create()},{viewport:_.create(),extent:_.create()},{viewport:_.create(),extent:_.create()}],numViews:0,index:0},W=v.vec4f64.create(),F=p.vec3f64.create(),G={inner:_.create(),outer:_.create()},q=_.create(),B=_.create(),j=x.ray.create()}));