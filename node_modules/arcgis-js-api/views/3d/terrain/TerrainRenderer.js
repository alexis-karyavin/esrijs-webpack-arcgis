// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../Color","../../../core/Accessor","../../../core/compilerUtils","../../../core/maybe","../../../core/ObjectPool","../../../core/PooledArray","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec2f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingBox","../support/imageUtils","../support/buffer/BufferView","./OverlayRenderer","./PatchGeometryFactory","./PatchRenderData","./TileRenderer","./tileUtils","../webgl-engine/core/shaderLibrary/Slice.glsl","../webgl-engine/core/shaderLibrary/shading/ScreenSpaceReflections.glsl","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/intersectorUtils","../webgl-engine/lib/screenSizePerspectiveUtils","../webgl-engine/lib/tracer","../webgl-engine/materials/internal/MaterialUtil","../webgl-engine/shaders/TerrainTechnique"],(function(e,t,r,i,n,s,a,o,l,c,d,u,h,p,f,g,v,b,y,T,m,x,R,_,S,O,P,q,D,k,w,E,C){var U=h.vec2f64.create(),I=b.create(),B=v.vec4f64.create(),N=v.vec4f64.create(),A=v.vec4f64.create(),F=function(){this.extent=v.vec4f64.create(),this.minLevel=0,this.maxLevel=0,this.callback=null},M=function(e){function t(t){var r=e.call(this,t)||this;return r.type="Terrain",r.isGround=!0,r.tileSize=256,r.rctx=null,r._isTransparent=!1,r.renderDataPool=new o(R.PatchRenderData),r.patchGroups=new l({allocator:function(e){return e||{root:null,origin:null,patches:new l}},deallocator:function(e){return e.root=null,e.origin=null,e.patches.clear(),e}}),r.patchGroupsDirty=!0,r.patchGroupsMap=new Map,r.tileIterator=new S.IteratorPreorder,r.highestVisibleLODTile=null,r.visible=!0,r._opaque=!0,r._skirtScale=1,r._velvetOverground=!0,r.castShadows=!0,r._ssrEnabled=!1,r.emptyTex=null,r.tileRenderer=null,r.tileBackgroundInitialized=!1,r.tileBackgroundUpdating=!1,r.stencilEnabledLayerExtents=[],r.numTrianglesRendered=0,r.numTilesRendered=0,r.numTilesCulled=0,r.numOriginsRendered=0,r.clippingExtent=null,r.needsHighlight=!1,r.renderOccludedFlags=1,r.visibleScaleRangeQueries=new l({initialSize:10}),r.visibleScaleRangeQueriesInvPtr=0,r.visibleScaleRangeQueryQueue=new l({initialSize:30}),r.visibleScaleRangeQueryPool=new o(F),r}return r.__extends(t,e),t.prototype.destroy=function(){x.clearCaches()},t.prototype.install=function(e){e.addRenderPlugin([2,7,9],this)},t.prototype.uninstall=function(e){e.removeRenderPlugin(this)},Object.defineProperty(t.prototype,"updating",{get:function(){return!this.tileBackgroundInitialized||this.tileBackgroundUpdating},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"canRender",{get:function(){return this.visible&&!!this.rootTiles&&this.tileBackgroundInitialized&&!this.renderingDisabled},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"renderingDisabled",{set:function(e){this._set("renderingDisabled",!!e),this.setNeedsRender()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"opaque",{get:function(){return this._opaque&&!this.shaderTechniqueConfig.slicePlaneEnabled},set:function(e){this._opaque!==e&&(this._opaque=e,this.setNeedsRender())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"needsLinearDepth",{get:function(){return this.overlayRenderer.hasWater},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isTransparent",{get:function(){return this._isTransparent},set:function(e){this._isTransparent!==e&&(this._isTransparent=e,this.setNeedsRender())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"skirtScale",{get:function(){return this._skirtScale},set:function(e){e!==this._skirtScale&&(this._skirtScale=e,this.setNeedsRender())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"renderPatchBorders",{get:function(){return!!this.shaderTechniqueConfig.tileBorders},set:function(e){this.shaderTechniqueConfig.tileBorders!==e&&(this.shaderTechniqueConfig.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cullBackFaces",{get:function(){return this.shaderTechniqueConfig.backfaceCullingEnabled},set:function(e){this.shaderTechniqueConfig.backfaceCullingEnabled!==e&&(this.shaderTechniqueConfig.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"renderOrder",{set:function(e){this._set("renderOrder",e),this.setNeedsRender()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"velvetOverground",{set:function(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"intersectionHandlerId",{get:function(){return D.TERRAIN_ID},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"slicePlane",{get:function(){return this.shaderTechniqueConfig.slicePlaneEnabled},set:function(e){this.shaderTechniqueConfig.slicePlaneEnabled!==e&&(this.shaderTechniqueConfig.slicePlaneEnabled=e,this.setNeedsRender())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"textureFadingEnabled",{set:function(e){this.shaderTechniqueConfig.textureFadingEnabled!==e&&(this.shaderTechniqueConfig.textureFadingEnabled=e,this.setNeedsRender())},enumerable:!0,configurable:!0}),t.prototype.setDebugScreenSizePerspective=function(e){this.shaderTechniqueConfig.screenSizePerspective!==e&&(this.shaderTechniqueConfig.screenSizePerspective=e,this.setNeedsRender())},t.prototype.setRootTiles=function(e){this.rootTiles=e,this.setNeedsRender()},t.prototype.setNeedsHighlight=function(e){this.needsHighlight=e,this.setNeedsRender()},t.prototype.setRenderOccludedOverlay=function(e){this.renderOccludedFlags=e?m.overlayRenderOccludedFlag:1,this.setNeedsRender()},t.prototype.setStencilEnabledLayerExtents=function(e){this.stencilEnabledLayerExtents=e,this.setNeedsRender()},t.prototype.setTileSize=function(e){this.tileSize=e,this.tileRenderer&&(this.tileRenderer.tileSize=e),this.setNeedsRender()},t.prototype.loadTile=function(e){e.renderData||(e.renderData=this.renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e)),this.updateTileGeometry(e),this.updateTileTexture(e)},t.prototype.queryVisibleLevelRange=function(e,t,r,i){var n=this.visibleScaleRangeQueryPool.acquire();g.vec4.copy(n.extent,e),n.minLevel=t||-Number.MAX_VALUE,n.maxLevel=null!=r?r:Number.MAX_VALUE,n.callback=i,this.visibleScaleRangeQueryQueue.push(n),this.setNeedsRender()},t.prototype.updateTileTexture=function(e){this.tileRenderer&&this.tileBackgroundInitialized&&(this.tileRenderer.updateTileTexture(e),this.setNeedsRender(),e.resetPendingUpdate(64))},t.prototype.updateTileGeometry=function(e){for(var t=0,r=e.layerInfo[0];t<r.length;t++){r[t].pendingUpdates&=-33}e.resetPendingUpdate(32),e.renderData.updateGeometry(this.rctx,this.wireframe)&&this.setNeedsRender()},t.prototype.unloadTile=function(e){e.renderData&&(this.releaseTileGeometry(e.renderData),e.renderData.clear(),e.renderData=null,e.setMemoryDirty(),this.setNeedsRender())},t.prototype._getLocalOriginOfTile=function(e){var t=Math.max(0,7*Math.floor((e.lij[0]-3)/7));if("spherical"===this.manifold&&0===t)return f.vec3f64.ZEROS;for(;e.parent&&e.lij[0]>t;)e=e.parent;return e.centerAtSeaLevel},t.prototype.setVisibility=function(e){this.visible=e,this.setNeedsRender()},t.prototype.getStats=function(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numTrianglesRendered:this.numTrianglesRendered,numOriginsRendered:this.numOriginsRendered}},Object.defineProperty(t.prototype,"wireframe",{set:function(e){var t=this;this._get("wireframe")!==e&&(this._set("wireframe",e),this.rootTiles&&(S.traverseTilesPreorder(this.rootTiles,(function(r){r.renderData&&r.renderData.updateGeometry(t.rctx,e)})),this.setNeedsRender()))},enumerable:!0,configurable:!0}),t.prototype.setNeedsRender=function(e){void 0===e&&(e=1),this.patchGroupsDirty=!0,this.initContext.requestRender(e)},t.prototype.setTileBackground=function(e){this.tileBackground=e,this._updateTileBackground()},t.prototype.initializeRenderContext=function(e){this.initContext=e,this.rctx=e.rctx,this.shaderTechniques=e.shaderTechniqueRep,this.shaderTechniqueConfig=new C.TerrainTechniqueConfiguration,this.tileRenderer=new _(this.rctx,this.tileSize,this.shaderTechniques),this.tileBackground&&this._updateTileBackground(),this.emptyTex=q.createEmptyTexture(this.rctx)},t.prototype.uninitializeRenderContext=function(){null!=this.emptyTex&&(this.emptyTex.dispose(),this.emptyTex=null),this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)},t.prototype.intersect=function(e,t,r,i){if(this.rootTiles&&(!e.options.selectOpaqueTerrainOnly||!e.options.selectionMode||this._opaque)){var n=z,s=j;p.vec3.subtract(n,i,r),p.vec3.set(s,1/n[0],1/n[1],1/n[2]);var o=e.results.min,l=e.results.max,c=e.results.ground,d=0===e.options.store,h=!!e.results.ground.target,f=null,g=this.clippingExtent,v=this.tileIterator;v.reset(this.rootTiles);for(var y=D.getVerticalOffsetTerrain(e.verticalOffset),m=function(){var m=v.next();if(null===m.renderData||h&&R._useStencilForTile(m))return"continue";if(e.options.invisibleTerrain){if(!m.visible&&g&&!m.intersectsExtent(g))return"continue"}else if(!m.visible)return"continue";var _=m.renderData.geometryInfo,O=m.renderData.localOrigin,P=-R._skirtScale*_.skirtLength;if(b.set(I,_.boundingBox),a.isSome(y)&&(y.localOrigin=O,y.applyToAABB(I)),0!==P){var q=m.up;b.expandWithOffset(I,P*q[0],P*q[1],P*q[2])}var k=I;p.vec3.subtract(V,r,O);var w=d&&null!=o.dist?o.dist:1/0;if(!E.intersectAabbInvDirBefore(k,V,s,e.tolerance,w))return"continue";var C=function(e,t,r,i){e.set(void 0,S.tile2str(t),r,i,u.mat4f64.IDENTITY,void 0),e.intersector=W,e.target={type:"external",metadata:{tile:t}}},U=function(s,d){if(s>=0&&(e.options.backfacesTerrain||p.vec3.dot(d,n)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||null==t||t(r,i,s))){if((null==c.dist||s<c.dist)&&C(c,m,s,d),!e.options.storeTerrainResults)return;2===e.options.store&&(a.isNone(f)?(f=new D.IntersectorResult(e.ray),C(f,m,s,d),e.results.all.push(f)):s<f.dist&&C(f,m,s,d)),(null==o.dist||s<o.dist)&&C(o,m,s,d),0!==e.options.store&&(null==l.dist||s>l.dist)&&C(l,m,s,d)}},B=H;p.vec3.subtract(B,i,O);var N=_.indices,A=_.vertexAttributes,F={data:A.getField("position",T.BufferViewVec3f).typedBuffer,size:3,offsetIdx:0,strideIdx:A.stride/4},M=_.numWithoutSkirtIndices/3;if(E.intersectTriangles(V,B,0,M,N,F,null,y,U),0!==P){var L="spherical"===R.manifold?function(e){return p.vec3.scale(e,e,P/p.vec3.length(e))}:function(e){return p.vec3.set(e,0,0,P)},G=N.length/3;x.intersectSkirts(V,B,M,G,N,A,L,y,U)}},R=this;!v.done;)m()}},t.prototype.render=function(e){if(9===e.slot){if(0==(e.renderOccludedMask&m.overlayRenderOccludedFlag))return!1}else{var t=this.opaque?2:7;if(e.slot!==t)return!1}w.trace("# BEGIN RENDER TERRAIN");var r=e.pass,i=1===e.scenelightingData.globalFactor,n=this._updatePatchGroups();switch(r){case 0:var s=e.shadowMap&&e.shadowMap.enabled;this.shaderTechniqueConfig.receiveShadows!==s&&(this.shaderTechniqueConfig.receiveShadows=s);var a=this.overlayRenderer.isEmpty()?0:this.overlayRenderer.hasWater?2:1;this.shaderTechniqueConfig.overlayMode!==a&&(this.shaderTechniqueConfig.overlayMode=a);var o=9===e.slot?"occluded":"colorAndWater";this._renderMaterialPass(e,0,n,o);break;case 3:this.castShadows&&i&&this._renderAuxiliaryPass(e,3,n,"none");break;case 1:this.isTransparent&&this.overlayRenderer.isEmpty()||this._renderAuxiliaryPass(e,1,n,"none");break;case 2:this._renderAuxiliaryPass(e,2,n,"none");break;case 4:this.needsHighlight&&(this._renderAuxiliaryPass(e,4,n,"highlight"),e.rctx.clearSafe(256))}return w.trace("# END RENDER TERRAIN"),0!==this.visibleScaleRangeQueryQueue.length&&this.setNeedsRender(),!0},t.prototype._renderMaterialPass=function(e,t,r,i){var n=this,s=e.rctx,a=e.camera;this._ssrEnabled=e.ssrParams.ssrEnabled,this._setTerrainTechnique(t,"occluded"===i);var o=this.shaderTechnique.program;e.rctx.bindProgram(o),s.bindProgram(o),"colorAndWater"===i&&e.ssrParams&&(e.ssrParams.lastFrameColorTextureID=9,e.ssrParams.linearDepthTextureID=8,P.ScreenSpaceReflections.bindUniforms(o,s,e.ssrParams)),e.shadowMap&&e.shadowMap.bind(o,7),e.ssaoHelper&&e.ssaoHelper.setUniforms(o,6),o.setUniform1i("tex",0),o.setUniform1i("texNext",1),this._bindOverlayUniforms(o),o.setUniformMatrix4fv("viewNormal",a.viewInverseTransposeMatrix),o.setUniformMatrix4fv("proj",a.projectionMatrix),e.scenelightingData.setUniforms(o,!0);var l=a.viewMatrix;p.vec3.set(Q,l[12],l[13],l[14]),p.vec3.normalize(Q,Q),o.setUniform3fv("viewDirection",Q),this.numTilesRendered=0,this.numTilesCulled=0,this.numTrianglesRendered=0,this.numOriginsRendered=0,this._prepareScaleRangeQueries(),this.opaque?this._renderPatchGroups(e,o,r,i):e.offscreenRenderingHelper.renderToTargets((function(){return n._renderPatchGroups(e,o,r,i)}),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._processScaleRangeQueries()},t.prototype._renderAuxiliaryPass=function(e,t,r,i){this._setTerrainTechnique(t,"occluded"===i);var n=this.shaderTechnique.program;if(e.rctx.bindProgram(n),4===e.pass){var s=e.offscreenRenderingHelper;e.rctx.bindTexture(s.depthTexture,6),n.setUniform1i("depthTex",6),n.setUniform4f("highlightViewportPixelSz",0,0,1/s.width,1/s.height)}else n.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),1!==e.pass&&3!==e.pass||(U[0]=e.camera.near,U[1]=e.camera.far,n.setUniform2fv("nearFar",U));this._renderPatchGroupsAuxiliary(e,n,r,i)},t.prototype._updateTileBackground=function(){var e=this;if(this.tileRenderer){this.tileBackgroundUpdating=!0;var t=function(){e.tileBackgroundInitialized=!0,e.tileBackgroundUpdating=!1,e.rootTiles&&S.traverseTilesPreorder(e.rootTiles,(function(t){e.tileRenderer.updateTileTexture(t),e.setNeedsRender()})),e.setNeedsRender()};if("string"==typeof this.tileBackground){var r=this.tileBackground;y.requestImage(r).then((function(i){r===e.tileBackground&&e.tileRenderer&&(e.tileRenderer.setBackground(i),t())}))}else{var n=this.tileBackground?i.toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(n),t()}}},t.prototype._updatePatchGroups=function(){var e=this,t=this.patchGroups;if(!this.patchGroupsDirty)return t;if(this.highestVisibleLODTile=null,this._renderCollectOrigins(t),0!==this.renderOrder){for(var r=0;r<t.length;r++)S.sortTiles(this.renderOrder,t.data[r].patches);t.sort((function(t,r){return function(e,t,r){if(0===e.patches.length)return-r;if(0===t.patches.length)return r;return S.compareTiles(e.patches.data[0],t.patches.data[0],r)}(t,r,e.renderOrder)}))}return this.patchGroupsDirty=!1,t},t.prototype._renderCollectOrigins=function(e){var t=this.rootTiles,r="spherical"===this.manifold;e.clear();for(var i=0,n=t;i<n.length;i++){var s=n[i],a=e.pushNew();a.root=s,a.origin=r?f.vec3f64.ZEROS:s.centerAtSeaLevel,a.patches.clear(),this._renderCollectOriginsForRoot(e,a)}e.filterInPlace((function(e){return e.patches.length>0}))},t.prototype._renderCollectOriginsForRoot=function(e,t){var r=this.tileIterator;r.resetOne(t.root);var i=this.patchGroupsMap;for(i.clear(),i.set(t.origin,t);!r.done;){var n=r.next(),s=n.renderData;if(!s||n.visible){var a;if(n.lij[0]%7==0)(a=e.pushNew()).root=n,a.origin=n.centerAtSeaLevel,i.set(n.centerAtSeaLevel,a),a.patches.clear();if(n.rendered){if(s)(a=i.get(s.localOrigin))&&a.patches.push(n),(!this.highestVisibleLODTile||n.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=n),r.skipSubtree()}else this.numTilesCulled++}else this.numTilesCulled++,r.skipSubtree()}},t.prototype._scaleQueriesForTile=function(e){for(var t=e.extent,r=e.lij[0],i=0;i<this.visibleScaleRangeQueriesInvPtr;){var n=this.visibleScaleRangeQueries.data[i],s=n.extent;r>=n.minLevel&&r<=n.maxLevel&&s[0]<=t[2]&&s[2]>=t[0]&&s[1]<=t[3]&&s[3]>=t[1]?(this.visibleScaleRangeQueries.swapElements(i,this.visibleScaleRangeQueriesInvPtr-1),this.visibleScaleRangeQueriesInvPtr--):i++}},t.prototype._useStencilForTile=function(e){for(var t=0,r=this.stencilEnabledLayerExtents;t<r.length;t++){var i=r[t];if(e.intersectsExtent(i))return!0}return!1},t.prototype._renderPatchGroupsAuxiliary=function(e,t,r,i){this.shaderTechnique.bindPipelineState(e.rctx);var n=this.stencilEnabledLayerExtents.length>0;t.setUniformMatrix4fv("proj",e.camera.projectionMatrix),t.setUniform1f("skirtScale",this._skirtScale),"none"!==i&&this._bindOverlayUniforms(t);for(var s=0;s<r.length;s++){var a=r.data[s];this._bindViewForPatchGroup(t,a,e.camera.eye,e.camera.viewMatrix);for(var o=0;o<a.patches.length;o++)this._renderPatch(e.rctx,t,a.patches.data[o],4,n,i)}e.rctx.bindVAO(null)},t.prototype._renderPatchGroups=function(e,t,r,i){var n=e.rctx,s=e.camera,o=s.viewMatrix;if(this.shaderTechnique.bindPipelineState(n),this.shaderTechniqueConfig.screenSizePerspective&&this.pointsOfInterest){var l=k.getSettings("spherical"===this.manifold?"global":"local"),c=this.pointsOfInterest.centerOnSurfaceFrequent.distance;l.update({distance:c,fovY:s.fovY}),E.bindScreenSizePerspective(l,t,"screenSizePerspective")}var d=this.stencilEnabledLayerExtents.length>0,u="occluded"===i;u&&(n.bindTexture(this.emptyTex,0),t.setUniform1f("blend",1),t.setUniform4fv("texOffsetAndScale",v.vec4f64.ZEROS));var h=u?0:this._skirtScale;t.setUniform1f("skirtScale",h);for(var p=this.wireframe?1:4,f=0;f<r.length;f++){var g=r.data[f],b=g.patches;if(0!==b.length){this._bindViewForPatchGroup(t,g,s.eye,o);var y=e.sliceHelper&&e.sliceHelper.plane;O.Slice.bindUniforms(t,this.shaderTechnique.configuration,y,g.origin),e.shadowMap&&e.shadowMap.bindView(t,g.origin),this.numOriginsRendered++;for(var T=0;T<b.length;T++){var m=b.data[T],x=m.renderData.textureReference;if(!a.isNone(x)){if(w.trace("# RENDER TILE "+S.tile2str(m)+", screenDepth:"+m.screenDepth),!u){this._scaleQueriesForTile(m),L(m.renderData.geometryInfo.uvOffsetAndScale,x.offsetAndScale,A),t.setUniform4fv("texOffsetAndScale",A),n.bindTexture(x.texture.texture,0);var R=m.renderData.textureFadeFactor,_=R<1?m.renderData.nextTextureReference:null;this.shaderTechniqueConfig.textureFadingEnabled&&a.isSome(_)?(L(m.renderData.geometryInfo.uvOffsetAndScale,_.offsetAndScale,A),t.setUniform1f("textureFadeFactor",R),t.setUniform4fv("nextTexOffsetAndScale",A),n.bindTexture(_.texture.texture,1)):(t.setUniform1f("textureFadeFactor",1),n.bindTexture(this.emptyTex,1)),m.renderData.textureIsFading&&this.setNeedsRender(),t.setUniform1f("opacity",m.renderData.opacity)}var P=this._renderPatch(n,t,m,p,d,i);m.renderOrder=this.numTilesRendered,this.numTilesRendered++,this.numTrianglesRendered+=P/3}}}}n.bindVAO(null)},t.prototype._renderPatch=function(e,t,r,i,n,s){"none"!==s&&(this._bindOverlayTextures(t,r.renderData.overlays,s),t.setUniform1f("overlayOpacity",r.renderData.overlayOpacity)),n&&(this._useStencilForTile(r)?this.stencilShaderTechnique.bindPipelineState(e):this.shaderTechnique.bindPipelineState(e));var a=0===this._skirtScale?r.renderData.geometryInfo.numWithoutSkirtIndices:r.renderData.vao.indexBuffer.size;return e.bindVAO(r.renderData.vao),t.assertCompatibleVertexAttributeLocations(r.renderData.vao),e.drawElements(i,a,r.renderData.vao.indexBuffer.indexType,0),a},t.prototype._bindViewForPatchGroup=function(e,t,r,i){e.setUniform3fv("origin",t.origin),d.mat4.translate(G,i,t.origin),e.setUniformMatrix4fv("view",G),e.setUniform3f("camPos",r[0]-t.origin[0],r[1]-t.origin[1],r[2]-t.origin[2])},t.prototype._bindOverlayUniforms=function(e){e.setUniform1i("ovInnerColorTex",2),e.setUniform1i("ovOuterColorTex",3),e.setUniform1i("ovInnerWaterTex",4),e.setUniform1i("ovOuterWaterTex",5)},t.prototype._bindOverlayTextures=function(e,t,r){for(var i=0;i<2;i++){var n=2*i,a=t[i],o=void 0,l=void 0;switch(r){case"colorAndWater":o=a.renderTargetIds.color,l=a.renderTargetIds.water;break;case"highlight":o=a.renderTargetIds.highlight;break;case"occluded":o=a.renderTargetIds.occluded;break;case"none":break;default:s.neverReached(r)}if(o){B[n]=a.texOffset[0],B[n+1]=a.texOffset[1],N[n]=a.texScale[0],N[n+1]=a.texScale[1];var c=this.overlayRenderer.getRenderTargetTexture(o);if(this.rctx.bindTexture(c,2+i),l){var d=this.overlayRenderer.getRenderTargetTexture(l);this.rctx.bindTexture(d,4+i)}else this.rctx.bindTexture(this.emptyTex,4+i)}else B[n]=0,B[n+1]=0,N[n]=0,N[n+1]=0,this.rctx.bindTexture(this.emptyTex,2+i),this.rctx.bindTexture(this.emptyTex,4+i)}e.setUniform4fv("overlayTexOffset",B),e.setUniform4fv("overlayTexScale",N)},t.prototype._setTerrainTechnique=function(e,t){if(this.shaderTechniqueConfig.output=e,0===e){var r="spherical"===this.manifold;this.shaderTechniqueConfig.atmosphere=r&&this._velvetOverground,this.shaderTechniqueConfig.ssrEnabled=this._ssrEnabled}this.shaderTechniqueConfig.renderOccluded=t,this.shaderTechniqueConfig.stencilEnabled=!1,this.shaderTechnique=this.shaderTechniques.acquireAndReleaseExisting(C.TerrainTechnique,this.shaderTechniqueConfig,this.shaderTechnique),this.shaderTechniqueConfig.stencilEnabled=!0,this.stencilShaderTechnique=this.shaderTechniques.acquireAndReleaseExisting(C.TerrainTechnique,this.shaderTechniqueConfig,this.stencilShaderTechnique)},t.prototype.releaseTileGeometry=function(e){e.releaseGeometry()&&this.setNeedsRender(),this.renderDataPool.release(e)},t.prototype._prepareScaleRangeQueries=function(){for(var e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryQueue;e.length<e.data.length&&t.length>0;){var r=t.pop();e.push(r)}this.visibleScaleRangeQueriesInvPtr=e.length},t.prototype._processScaleRangeQueries=function(){for(var e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryPool,r=0;r<e.length;r++){var i=e.data[r];t.release(i),i.callback(r>=this.visibleScaleRangeQueriesInvPtr),i.callback=null}e.clear()},Object.defineProperty(t.prototype,"test",{get:function(){return{tileRenderer:this.tileRenderer}},enumerable:!0,configurable:!0}),r.__decorate([c.property()],t.prototype,"tileBackgroundInitialized",void 0),r.__decorate([c.property()],t.prototype,"tileBackgroundUpdating",void 0),r.__decorate([c.property({constructOnly:!0})],t.prototype,"manifold",void 0),r.__decorate([c.property({constructOnly:!0})],t.prototype,"overlayRenderer",void 0),r.__decorate([c.property({readOnly:!0,dependsOn:["tileBackgroundInitialized","tileBackgroundUpdating"]})],t.prototype,"updating",null),r.__decorate([c.property({value:!1})],t.prototype,"renderingDisabled",null),r.__decorate([c.property()],t.prototype,"renderPatchBorders",null),r.__decorate([c.property()],t.prototype,"cullBackFaces",null),r.__decorate([c.property({value:1})],t.prototype,"renderOrder",null),r.__decorate([c.property()],t.prototype,"wireframe",null),t=r.__decorate([c.subclass("esri.views.3d.terrain.TerrainRenderer")],t)}(n);function L(e,t,r){var i=e[0]*t[2]+t[0],n=e[1]*t[3]+t[1],s=e[2]*t[2],a=e[3]*t[3];g.vec4.set(r,i,n,s,a)}var G=u.mat4f64.create(),Q=f.vec3f64.create(),z=f.vec3f64.create(),j=f.vec3f64.create(),V=f.vec3f64.create(),H=f.vec3f64.create(),W="TerrainRenderer";return M}));