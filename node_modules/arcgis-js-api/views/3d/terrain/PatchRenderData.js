// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../../core/arrayUtils","../../../core/mathUtils","../../../core/maybe","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec2f64","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingBox","../support/buffer/glUtil","./PatchGeometryFactory","./TerrainConst","./TextureFader","./tileUtils","../webgl-engine/lib/DefaultVertexAttributeLocations","../../webgl/BufferObject","../../webgl/VertexArrayObject"],(function(e,t,r,i,n,a,o,l,s,u,c,f,h,p,y,m,g){Object.defineProperty(t,"__esModule",{value:!0});var d=function(){function e(){var e=this;this.overlayTexOffset=o.vec2f64.create(),this.geometryInfo={indices:null,vertexAttributes:null,boundingBox:s.empty(),numSurfaceIndices:0,numSkirtIndices:0,numWithoutSkirtIndices:0,numVertsPerRow:0,skirtLength:0,uvOffsetAndScale:l.vec4f64.create()},this._textureRef=new h.default((function(){return e.tile.surface.textureFadeDuration}))}return e.prototype.init=function(e){this.tile=e,this.clear();var t=this.geometryInfo;if(t.indices=null,t.vertexAttributes=null,s.empty(t.boundingBox),t.numSurfaceIndices=0,t.numSkirtIndices=0,t.numWithoutSkirtIndices=0,t.numVertsPerRow=0,this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},this.opacity=1,this.overlays)for(var r=0,i=this.overlays;r<i.length;r++){var n=i[r];n.renderTargetIds.color=null,n.renderTargetIds.highlight=null,n.renderTargetIds.water=null,n.renderTargetIds.occluded=null,a.vec2.set(n.texScale,1,1),a.vec2.set(n.texOffset,0,0)}else{this.overlays=[null,null];for(var o=0;o<2;o++)this.overlays[o]={renderTargetIds:{color:null,highlight:null,water:null,occluded:null},texScale:[1,1],texOffset:[0,0]}}this.overlayOpacity=1,this.localOrigin=null},e.prototype.clear=function(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear()},e.prototype.updateGeometry=function(e,t){return!!this._updateGeometryState(t)&&(this._releaseGeometry(),this._createGeometry(e),!0)},e.prototype.releaseGeometry=function(){return!!this._releaseGeometry()&&(this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},!0)},e.prototype.ensureTexture=function(e,t){return n.isSome(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),this._texture||(this._texture=t(),this.tile.setMemoryDirty()),this._texture},e.prototype.releaseTexture=function(){n.isSome(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())},e.prototype._updateGeometryState=function(e){var t=this._getElevationInfo(),n=this.tile.level,a=n<8?this.tile.numSubdivisionsAtLevel[n]+1:2;if(t.samplerData){var o=this.tile.vlevel-n,l=Math.max(n-t.maxTileLevel,f.ELEVATION_DESIRED_RESOLUTION_LEVEL-o),s=this.tile.maxTesselation;a=i.clamp(1+(s>>l),2,s+1)}var u=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(u=null);var c=this.geometryState,h=!1;return c.numVertsPerRow!==a&&(c.numVertsPerRow=a,h=!0),t.changed&&(c.samplerData=t.samplerData,h=!0),r.equals(c.clippingArea,u)||(c.clippingArea=u,h=!0),c.wireframe!==e&&(c.wireframe=e,h=!0),h},e.prototype._createGeometry=function(e){this.tile.createGeometry(this.geometryState,this.localOrigin);var t=this.geometryInfo.vertexAttributes,r=this.geometryInfo.indices,i=e.gl;this._vao=new g(e,y.Default3D,{geometry:u.glLayout(t.layout)},{geometry:m.createVertex(e,i.STATIC_DRAW,t.buffer)},m.createIndex(e,i.STATIC_DRAW,r))},e.prototype._releaseGeometry=function(){return!!this._vao&&(this._vao.dispose(),this._vao=null,c.releaseGeometry(this.geometryInfo),!0)},Object.defineProperty(e.prototype,"vao",{get:function(){return this._vao},enumerable:!0,configurable:!0}),e.prototype.setTextureReference=function(e,t,r,i,n){void 0===n&&(n=0),e!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t,r,i,n)},Object.defineProperty(e.prototype,"textureReference",{get:function(){return this._textureRef.current},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nextTextureReference",{get:function(){return this._textureRef.next},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"textureFadeFactor",{get:function(){return this._textureRef.fadeFactor},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"textureIsFading",{get:function(){return this._textureRef.isFading},enumerable:!0,configurable:!0}),e.prototype._getElevationInfo=function(){for(var e=this.geometryState.samplerData,t=this.tile.layerInfo[0],r=t.length,i=new Array(r),n=0,a=0,o=!1,l=0;l<r;l++){var s=t[l];if(s.upsampleInfo){var u=s.upsampleInfo.tile,c=(h=u.layerInfo[0][l].data)&&h.samplerData;e&&e[n]===c||(o=!0),i[n++]=c,a=Math.max(a,u.lij[0])}else if(s.data){var f=this.tile.surface.layerViewByIndex(l,0);if(p.fallsWithinLayer(this.tile,f.layer,!1)){var h=s.data;e&&e[n]===h.samplerData||(o=!0),i[n++]=h.samplerData,a=this.tile.lij[0]}}}return e&&e.length!==n&&(o=!0),n>0?i.length=n:i=null,{changed:o,samplerData:i,maxTileLevel:a}},Object.defineProperty(e.prototype,"estimatedGeometryMemoryUsage",{get:function(){return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"textureDescriptor",{get:function(){return n.isSome(this._texture)?this._texture.descriptor:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"test",{get:function(){return{hasTexture:null!=this._texture}},enumerable:!0,configurable:!0}),e}();t.PatchRenderData=d}));