// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../../core/mathUtils","../../../core/maybe","../../../core/unitUtils","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/support/aaBoundingRect","../../../layers/graphics/dehydratedFeatures","./earthUtils","../webgl-engine/lib/BufferVectorMath"],(function(e,n,a,t,r,i,o,l,c,u,s,f,h,p){var R,v,M,m,d,T,E,x;function S(e,n,a,t){return!(e.length<2)&&(2===e.length&&(Q[0]=e[0],Q[1]=e[1],Q[2]=0,e=Q),y(e,n,0,a,t,0,1))}function g(e,n,a,t,r,i,o){void 0===o&&(o=0);for(var l=new Array,c=0,u=e;c<u.length;c++)for(var s=0,f=M=u[c];s<f.length;s++){var h=f[s];l.push(h[0],h[1],n?h[2]:o)}if(!y(l,t,0,l,i,0,l.length/3))return!1;var p=0;r.length=0;for(var R=0,v=e;R<v.length;R++){for(var M=v[R],m=new Array,d=0,T=M;d<T.length;d++){h=T[d];n&&a?m.push([l[p++],l[p++],l[p++],h[3]]):n?m.push([l[p++],l[p++],l[p++]]):a?(m.push([l[p++],l[p++],h[2]]),p++):(m.push([l[p++],l[p++]]),p++)}r.push(m)}return!0}function y(e,n,a,r,i,o,l){void 0===l&&(l=1);var c=q(n,i,V);if(t.isNone(c))return!1;if(c===P){if(e===r&&a===o)return!0;for(var u=a+3*l,s=a,f=o;s<u;s++,f++)r[f]=e[s];return!0}var h=a+3*l;for(s=a,f=o;s<h;s+=3,f+=3)c(e,s,r,f);return!0}function I(e,a){return a.spatialReference===e?a.spatialReferenceId:(a.spatialReference=e,"metersPerUnit"in a&&(a.metersPerUnit=r.getMetersPerUnitForSR(e,1)),e.wkt===n.SphericalECEFSpatialReference.wkt?a.spatialReferenceId=1:e.isWGS84?a.spatialReferenceId=2:e.isWebMercator?a.spatialReferenceId=3:e.wkt===n.WGS84ECEFSpatialReference.wkt?a.spatialReferenceId=4:4490===e.wkid?a.spatialReferenceId=5:a.spatialReferenceId=0)}function P(e,n,a,t){e!==a&&(a[t++]=e[n++],a[t++]=e[n++],a[t]=e[n])}function G(e,n,a,t){a[t++]=J*(e[n++]/h.earthRadius),a[t++]=J*(Math.PI/2-2*Math.atan(Math.exp(-1*e[n++]/h.earthRadius))),a[t]=e[n]}function b(e,n,a,t){G(e,n,a,t),F(a,t,a,t)}function w(e,n,a,t){G(e,n,a,t),N(a,t,a,t)}function C(e,n,t,r){var i=.4999999*Math.PI,o=a.clamp(_*e[n+1],-i,i),l=Math.sin(o);t[r++]=_*e[n]*h.earthRadius,t[r++]=h.halfEarthRadius*Math.log((1+l)/(1-l)),t[r]=e[n+2]}function U(e,n,a){var r=I(n,k),i=L[r][6];return!t.isNone(i)&&(i(e,0,Q,0),a!==Q&&(a[0]=Q[0],a[1]=Q[1],a.length>2&&(a[2]=Q[2])),!0)}function A(e,n){return Q[0]=e.x,Q[1]=e.y,Q[2]=e.hasZ?e.z:0,U(Q,e.spatialReference,n)}function F(e,n,a,t){var r=h.earthRadius+e[n+2],i=_*e[n+1],o=_*e[n],l=Math.cos(i);a[t++]=Math.cos(o)*l*r,a[t++]=Math.sin(o)*l*r,a[t]=Math.sin(i)*r}function W(e,n,t,r){var i=p.Vec3Compact.length(e,n),o=a.asinClamped(e[n+2]/(0===i?1:i)),l=Math.atan2(e[n+1],e[n]);t[r++]=J*l,t[r++]=J*o,t[r]=i-h.earthRadius}function z(e,n,a,t){W(e,n,a,t),C(a,t,a,t)}function O(e,n,a,t){W(e,n,a,t),N(a,t,a,t)}function N(e,n,a,t){var r=K,i=_*e[n],o=_*e[n+1],l=e[n+2],c=Math.sin(o),u=Math.cos(o),s=r.a/Math.sqrt(1-r.e2*c*c);a[t++]=(s+l)*u*Math.cos(i),a[t++]=(s+l)*u*Math.sin(i),a[t++]=(s*(1-r.e2)+l)*c}function Z(e,n,a,t){var r,i,o,l,c,u,s,f,h,p,R,v,M,m,d,T,E,x,S,g,y,I=K,P=e[n],G=e[n+1],b=e[n+2];r=Math.abs(b),i=P*P+G*G,o=Math.sqrt(i),l=i+b*b,c=Math.sqrt(l),g=Math.atan2(G,P),u=b*b/l,s=i/l,m=I.a2/c,d=I.a3-I.a4/c,s>.3?(f=r/c*(1+s*(I.a1+m+u*d)/c),S=Math.asin(f),p=f*f,h=Math.sqrt(1-p)):(h=o/c*(1-u*(I.a5-m-s*d)/c),S=Math.acos(h),p=1-h*h,f=Math.sqrt(p)),R=1-I.e2*p,v=I.a/Math.sqrt(R),S+=x=(T=h*(d=r-(M=I.a6*v)*f)-f*(m=o-v*h))/(M/R+(E=h*m+f*d)),y=E+T*x/2,b<0&&(S=-S),a[t++]=J*g,a[t++]=J*S,a[t]=y}function j(e,n,a,t){Z(e,n,a,t),F(a,t,a,t)}function H(e,n,a,t){Z(e,n,a,t),C(a,t,a,t)}Object.defineProperty(n,"__esModule",{value:!0}),n.SphericalECEFSpatialReference=new u({wkt:'GEOCCS["Spherical geocentric",\n  DATUM["Not specified",\n    SPHEROID["Sphere",\' + earthUtils.earthRadius + \',0]],\n  PRIMEM["Greenwich",0.0,\n    AUTHORITY["EPSG","8901"]],\n  UNIT["m",1.0],\n  AXIS["Geocentric X",OTHER],\n  AXIS["Geocentric Y",EAST],\n  AXIS["Geocentric Z",NORTH]\n]'}),n.WGS84ECEFSpatialReference=new u({wkt:'GEOCCS["WGS 84",\n  DATUM["WGS_1984",\n    SPHEROID["WGS 84",6378137,298.257223563,\n      AUTHORITY["EPSG","7030"]],\n    AUTHORITY["EPSG","6326"]],\n  PRIMEM["Greenwich",0,\n    AUTHORITY["EPSG","8901"]],\n  UNIT["m",1.0,\n    AUTHORITY["EPSG","9001"]],\n  AXIS["Geocentric X",OTHER],\n  AXIS["Geocentric Y",OTHER],\n  AXIS["Geocentric Z",NORTH],\n  AUTHORITY["EPSG","4978"]\n]'}),n.canProject=function(e,n){return!!q(e,n,V)},n.getProjectorName=function(e,n){var a=q(e,n,V);return a===P?"copy3":a===F?"wgs84ToSphericalECEF":a===C?"wgs84ToWebMercator":a===N?"wgs84ToWGS84ECEF":a===G?"webMercatorToWGS84":a===b?"webMercatorToSphericalECEF":a===w?"webMercatorToWGS84ECEF":a===Z?"wgs84ECEFToWGS84":a===j?"wgs84ECEFToSphericalECEF":a===H?"wgs84ECEFToWebMercator":a===W?"sphericalECEFToWGS84":a===z?"sphericalECEFToWebMercator":a===O?"sphericalECEFToWGS84ECEF":null},n.vectorToVector=S,n.polygonToPolygon=function(e,n,a,t){void 0===a&&(a=n.spatialReference),void 0===t&&(t=0);var r=[];return!!g(e.rings,e.hasZ,e.hasM,e.spatialReference,r,a,t)&&(n.rings=r,n.spatialReference=a,n.hasZ=e.hasZ,n.hasM=e.hasM,!0)},n.polylineToPolyline=function(e,n,a,t){void 0===a&&(a=n.spatialReference),void 0===t&&(t=0);var r=[];return!!g(e.paths,e.hasZ,e.hasM,e.spatialReference,r,a,t)&&(n.paths=r,n.spatialReference=a,n.hasZ=e.hasZ,n.hasM=e.hasM,!0)},n.multipointToMultipoint=function(e,n,a,t){void 0===a&&(a=n.spatialReference),void 0===t&&(t=0);var r=new Array;return!!g([e.points],e.hasZ,e.hasM,e.spatialReference,r,a,t)&&(n.points=r[0],n.spatialReference=a,n.hasZ=e.hasZ,n.hasM=e.hasM,!0)},n.pointToPoint=function(e,n,a,t){void 0===a&&(a=n.spatialReference),void 0===t&&(t=0),Q[0]=e.x,Q[1]=e.y;var r=e.z;return Q[2]=void 0!==r?r:t,!!y(Q,e.spatialReference,0,Q,a,0,1)&&(n.x=Q[0],n.y=Q[1],n.spatialReference=a,void 0!==r?(n.z=Q[2],n.hasZ=!0):(n.z=void 0,n.hasZ=!1),!0)},n.pointToVector=function(e,n,a,t){void 0===t&&(t=0),Q[0]=e.x,Q[1]=e.y;var r=e.z;return Q[2]=void 0!==r?r:t,y(Q,e.spatialReference,0,n,a,0,1)},n.vectorToPoint=function(e,n,a,t){var r;return a instanceof c?(r=a,t=t||r.spatialReference):f.isPoint(a)?((r=a).hasZ=!0,t=t||r.spatialReference):r=new c({spatialReference:t=a}),y(e,n,0,Q,t,0,1)?(r.x=Q[0],r.y=Q[1],r.z=Q[2],r.spatialReference=t,r):null},n.xyzToVector=function(e,n,a,t,r,i){return Q[0]=e,Q[1]=n,Q[2]=a,y(Q,t,0,r,i,0,1)},n.bufferToBuffer=y,n.localLinearScaleFactors=function(e,n,a,t){var r=I(n,k),i=I(t,B);if(r===i&&0!==r||n.equals(t))return a[0]=1,a[1]=1,a[2]=1,!0;if(1===r){var l=o.vec3.length(e),c=l/Math.sqrt(e[0]*e[0]+e[1]*e[1]),u=l/h.earthRadius;if(3===i)return a[0]=c*u,a[1]=c*u,a[2]=1,!0;if(2===i||5===i){var s=180/(h.earthRadius*Math.PI);return a[0]=s*c*u,a[1]=s*u,a[2]=1,!0}}return!1},n.computeLinearTransformation=function(e,n,a,r){var o=I(e,k),l=I(r,B);if(o===l&&1!==l&&(0!==o||e.equals(r)))return i.mat4.identity(a),i.mat4.translate(a,a,n),!0;if(1===l){var c=L[o][6],u=L[6][l];if(t.isNone(c)||t.isNone(u))return!1;c(n,0,$,0),u($,0,ee,0);var s=_*$[0],f=_*$[1],h=Math.sin(s),p=Math.cos(s),R=Math.sin(f),v=Math.cos(f),M=a;return M[0]=-h,M[4]=-R*p,M[8]=v*p,M[12]=ee[0],M[1]=p,M[5]=-R*h,M[9]=v*h,M[13]=ee[1],M[2]=0,M[6]=v,M[10]=R,M[14]=ee[2],M[3]=0,M[7]=0,M[11]=0,M[15]=1,!0}if(3===l&&(2===o||1===o)){c=L[o][6];if(t.isNone(c))return!1;c(n,0,$,0);var m=_*$[1];C($,0,ee,0),i.mat4.identity(a),i.mat4.translate(a,a,ee);var d=1/Math.cos(m);return i.mat4.scale(a,a,[d,d,1]),!0}return!1},n.transformDirection=function(e,n,a,t,r){o.vec3.copy(ne,e),o.vec3.add(ae,e,n),S(ne,a,ne,r),S(ae,a,ae,r),o.vec3.subtract(t,ae,ne),o.vec3.normalize(t,t)},n.mbsToMbs=function(e,n,a,r){var i=X(n,r,D);if(i.projector===P)return a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],!0;if(t.isNone(i.projector))return!1;var o=i.source,l=i.dest;if(3===l.spatialReferenceId){var c=L[o.spatialReferenceId][2];if(t.isNone(c))return!1;c(e,0,$,0);var u=Math.abs(_*$[1])+Math.asin(e[3]/(h.earthRadius+e[2]));if(C($,0,a,0),u>.9999*Math.PI)a[3]=Number.MAX_VALUE;else{var s=1/Math.cos(u);a[3]=s*e[3]}return!0}return i.projector(e,0,a,0),a[3]=e[3]*o.metersPerUnit/l.metersPerUnit,!0},n.extentToBoundingBox=function(e,n,a){if(null==e)return!1;var t=!0;return Q[0]=null!=e.xmin?e.xmin:0,Q[1]=null!=e.ymin?e.ymin:0,Q[2]=null!=e.zmin?e.zmin:0,t=t&&y(Q,e.spatialReference,0,n,a,0,1),Q[0]=null!=e.xmax?e.xmax:0,Q[1]=null!=e.ymax?e.ymax:0,Q[2]=null!=e.zmax?e.zmax:0,t=t&&y(Q,e.spatialReference,0,n,a,3,1),null==e.xmin&&(n[0]=-1/0),null==e.ymin&&(n[1]=-1/0),null==e.zmin&&(n[2]=-1/0),null==e.xmax&&(n[3]=1/0),null==e.ymax&&(n[4]=1/0),null==e.zmax&&(n[5]=1/0),t},n.extentToBoundingRect=function(e,n,a){if(null==e)return!1;var t=!0;return Q[0]=null!=e.xmin?e.xmin:0,Q[1]=null!=e.ymin?e.ymin:0,Q[2]=null!=e.zmin?e.zmin:0,t=t&&y(Q,e.spatialReference,0,Q,a,0,1),n[0]=Q[0],n[1]=Q[1],Q[0]=null!=e.xmax?e.xmax:0,Q[1]=null!=e.ymax?e.ymax:0,Q[2]=null!=e.zmax?e.zmax:0,t=t&&y(Q,e.spatialReference,0,Q,a,0,1),n[2]=Q[0],n[3]=Q[1],null==e.xmin&&(n[0]=-1/0),null==e.ymin&&(n[1]=-1/0),null==e.xmax&&(n[2]=1/0),null==e.ymax&&(n[3]=1/0),t},n.boundingRectToBoundingRect=function(e,n,a,t){return null!=e&&(n.equals(t)?(s.set(a,e),!0):(Q[0]=e[0],Q[1]=e[1],Q[2]=0,!!y(Q,n,0,Q,t,0,1)&&(a[0]=Q[0],a[1]=Q[1],Q[0]=e[2],Q[1]=e[3],Q[2]=0,!!y(Q,n,0,Q,t,0,1)&&(a[2]=Q[0],a[3]=Q[1],!0))))},function(e){e.x2lon=function(e){return e/h.earthRadius},e.y2lat=function(e){return Math.PI/2-2*Math.atan(Math.exp(-1*e/h.earthRadius))},e.lon2x=function(e){return e*h.earthRadius},e.lat2y=function(e){var n=Math.sin(e);return h.earthRadius/2*Math.log((1+n)/(1-n))}}(n.webMercator||(n.webMercator={})),n.canProjectToWGS84ComparableLonLat=function(e){var n=I(e,k);return!!L[n][6]},n.vectorToWGS84ComparableLonLat=U,n.pointToWGS84ComparableLonLat=A,n.pointToWGS84ComparableLonLatPoint=function(e,n){var a=I(n.spatialReference,B);return!t.isNone(L[6][a])&&(!!A(e,Q)&&(n.x=Q[0],n.y=Q[1],n.z=Q[2],!0))},n.wgs84ComparableLonLatToECEF=function(e,n,a,t){void 0===t&&(t=0);var r=h.earthRadius+t,i=Math.cos(a);e[0]=Math.cos(n)*i*r,e[1]=Math.sin(n)*i*r,e[2]=Math.sin(a)*r};var L=((R={})[2]=((v={})[5]=null,v[6]=P,v[1]=F,v[0]=null,v[3]=C,v[2]=P,v[4]=N,v),R[5]=((M={})[5]=P,M[6]=P,M[1]=F,M[0]=null,M[3]=null,M[2]=null,M[4]=N,M),R[3]=((m={})[5]=null,m[6]=G,m[1]=b,m[0]=null,m[3]=P,m[2]=G,m[4]=w,m),R[4]=((d={})[5]=Z,d[6]=Z,d[1]=j,d[0]=null,d[3]=H,d[2]=Z,d[4]=P,d),R[1]=((T={})[5]=W,T[6]=W,T[1]=P,T[0]=null,T[3]=z,T[2]=W,T[4]=O,T),R[0]=((E={})[5]=null,E[6]=null,E[1]=null,E[0]=P,E[3]=null,E[2]=null,E[4]=null,E),R[6]=((x={})[5]=null,x[6]=P,x[1]=F,x[0]=null,x[3]=null,x[2]=P,x[4]=N,x),R);function q(e,n,a){return void 0===a&&(a=Y()),X(e,n,a).projector}function X(e,n,a){if(a.source.spatialReference===e&&a.dest.spatialReference===n)return a;var t=I(e,a.source),r=I(n,a.dest);return 0===t&&0===r?e.equals(n)?a.projector=P:a.projector=null:a.projector=L[t][r],a}function Y(){return{source:{spatialReference:null,spatialReferenceId:0,metersPerUnit:1},dest:{spatialReference:null,spatialReferenceId:0,metersPerUnit:1},projector:P}}n.getProjector=q;var k={spatialReference:null,spatialReferenceId:0},B={spatialReference:null,spatialReferenceId:0},V=Y(),D=Y(),_=a.deg2rad(1),J=a.rad2deg(1),K={a:6378137,e2:.006694379990137799,a1:42697.67270715754,a2:1823091254.6075456,a3:142.91722289812412,a4:4557728136.518864,a5:42840.589930055656,a6:.9933056200098622},Q=l.vec3f64.create(),$=l.vec3f64.create(),ee=l.vec3f64.create(),ne=l.vec3f64.create(),ae=l.vec3f64.create()}));