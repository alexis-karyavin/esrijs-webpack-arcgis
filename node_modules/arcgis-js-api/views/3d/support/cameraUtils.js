// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../Camera","../../../core/Logger","../../../core/mathUtils","../../../core/promiseUtils","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/support/scaleUtils","../camera/intersectionUtils","./cameraUtilsPlanar","./cameraUtilsSpherical","./earthUtils","./ElevationProvider","./mathUtils","./projectionUtils","../../support/spatialReferenceSupport"],(function(e,t,r,n,i,a,o,c,l,s,u,f,v,d,p,m,g,h,T,y){Object.defineProperty(t,"__esModule",{value:!0});var x=i.getLogger("esri.views.3d.support.cameraUtils"),R=l.vec3f64.create(),M=l.vec3f64.create(),S=l.vec3f64.create(),w={heading:0,tilt:0},C=new s,b=new h.Cyclical(-20037508.342788905,20037508.342788905),z=new h.Cyclical(-180,180);function P(e){return e.spatialReference||u.WGS84}function E(e){return"global"===e.viewingMode?p:d}function A(e,t,r){var n=e.state.camera,i=n.fovX,o=n.width/2/n.pixelRatio;"global"===e.viewingMode&&null!=r&&(t*=Math.cos(a.deg2rad(r)));return o/(96*39.37/(t/=e.renderCoordsHelper.unitInMeters))/Math.tan(i/2)}function U(e,t,r){var n=e.state.camera,i=n.fovX,o=t*Math.tan(i/2),c=96*39.37/(n.width/2/n.pixelRatio/o);return"global"===e.viewingMode&&(c/=Math.cos(a.deg2rad(r))),c*=e.renderCoordsHelper.unitInMeters}function _(e,t,r,n,i,a){if(L(a)){var o=F(a.signal);return V(e,n.heading,n.tilt,t,r,i,o),void o.resolver.promise.then((function(t){return a.resolver.resolve(j(e,t,n.fov))}),(function(e){return a.resolver.reject(e)}))}var c=V(e,n.heading,n.tilt,t,r,i);return j(e,c,n.fov,a)}function H(e,t,r,n,i){return E(e).directionToHeadingTilt(t,r,n,i)}function V(e,t,n,i,a,o,u){var f=i&&i instanceof s?i:null;if(!L(u)){var v=function(e,t){var r=l.vec3f64.create();if(t&&t instanceof s){if(T.pointToVector(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){var n=g.getElevationAtPoint(e.elevationProvider,t);null!=n&&e.renderCoordsHelper.setAltitude(n,r)}}else t?c.vec3.copy(r,t):c.vec3.copy(r,e.state.camera.center);return r}(e,i);return D(e,t,n,f,v,a,o,u)}(function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,a;return r.__generator(this,(function(r){switch(r.label){case 0:return i=l.vec3f64.create(),t?[3,1]:(c.vec3.copy(i,e.state.camera.center),[3,5]);case 1:return t instanceof s?(T.pointToVector(t,i,e.renderSpatialReference),null!=t.z||null==e.basemapTerrain?[3,3]:[4,e.elevationProvider.queryElevation(t.x,t.y,t.z,t.spatialReference,n)]):[3,4];case 2:return null!=(a=r.sent())&&e.renderCoordsHelper.setAltitude(a,i),[2,i];case 3:return[3,5];case 4:c.vec3.copy(i,t),r.label=5;case 5:return[2,i]}}))}))})(e,i,u.signal).then((function(r){D(e,t,n,f,r,a,o,u)}),(function(e){return u.resolver.reject(e)}))}function D(e,t,n,i,a,o,c,s){if(!i){var u=e.renderSpatialReference,f=P(e);i=T.vectorToPoint(a,u,f)}o=Math.max(o,e.state.constraints.minimumPoiDistance);var v=function(e,t,r,n,i,a){var o=0;1===a&&function(e,t,r){var n=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(r/n)/Math.LN2>8)return!0;var i=e.renderSpatialReference,a=P(e),o=T.vectorToPoint(t,i,a),c=T.vectorToPoint(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,i,a),l=Math.tan(.5*e.state.camera.fov)*n;return c.distance(o)/l>5}(e,n,i)?(t=0,o=function(e,t,r,n){var i=e.state.constraints.tilt(t);i.max=Math.min(i.max,.5*Math.PI);var a=i.min*(1-.7)+.7*i.max,o=O(e,n,t,r);return Math.min(o,a)}(e,i,r,n)):o=O(e,n,i,r);return o=e.state.constraints.clampTilt(i,o),r=I(e,n,i,o),{heading:t,tilt:r}}(e,t,n,a,o,c),d=(0,E(e).eyeForCenterWithHeadingTilt)(a,o,v.heading,v.tilt);if(1===c&&"global"===e.viewingMode&&n>0){var p=function(){var r=I(e,a,o,function(e,t,r,n){var i=e.state.constraints.tilt(t),a=O(e,n,t,r);return a=Math.min(a,.5*Math.PI),i.min*(1-.7)+.7*a}(e,o,n,a));return D(e,t,r,i,a,o,c=n-r<1?0:1,s)},m=e.map.ground.navigationConstraint;if(!m||"stay-above"===m.type){if(function(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,C,e.spatialReference)&&g.getElevationAtPoint(e.elevationProvider,C)>C.z-1)}(e,d.eye))return p();if(L(s))return void function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return e.renderCoordsHelper.fromRenderCoords(t,C,e.spatialReference)?[4,e.elevationProvider.queryElevation(C.x,C.y,C.z,C.spatialReference,n)]:[2,!1];case 1:return[2,r.sent()>C.z-1]}}))}))}(e,d.eye,s.signal).then((function(e){if(e)return p();s.resolver.resolve({eye:d.eye,up:d.up,center:l.vec3f64.clone(a),heading:d.heading,tilt:d.tilt})}))}}var h=!s||L(s)?{center:l.vec3f64.create(),eye:l.vec3f64.create(),up:l.vec3f64.create(),tilt:0,heading:0}:s;return h.eye=d.eye,h.up=d.up,h.center=l.vec3f64.clone(a),h.heading=d.heading,h.tilt=d.tilt,L(s)&&s.resolver.resolve(h),h}t.headingTiltToDirectionUp=function(e,t,r,n,i){return E(e).headingTiltToDirectionUp(t,r,n,i)},t.externalToInternal=function(e,t){var r=e.renderSpatialReference,n=E(e).headingTiltToDirectionUp,i=l.vec3f64.create();if(!T.pointToVector(t.position,i,r))return null;var o=n(i,t.heading,t.tilt);c.vec3.scale(o.direction,o.direction,e.state.camera.distance),c.vec3.add(o.direction,o.direction,i);var s=v.cameraOnContentAlongViewDirection(e,i,o.direction,o.up);return s.fov=a.deg2rad(t.fov),s},t.internalToExternal=function(e,t,r){var i=e.renderSpatialReference,o=c.vec3.copy(S,t.viewForward),l=H(e,t.eye,o,t.up,w),f=P(e);return T.vectorToVector(t.eye,i,R,f)||(f=u.WGS84,T.vectorToVector(t.eye,i,R,f)),r?(r.position.x=R[0],r.position.y=R[1],r.position.z=R[2],r.position.spatialReference=f,r.heading=l.heading,r.tilt=l.tilt,r.fov=a.rad2deg(t.fov),r):new n(new s(R,f),l.heading,l.tilt,a.rad2deg(t.fov))},t.scaleToDistance=A,t.distanceToScale=U,t.fromCenterScale=function(e,t,r,n,i,a){return _(e,t,A(e,r,t.latitude),n,i,a)},t.fromCenterDistance=_,t.directionToHeadingTilt=H,t.getObserverForPointAtDistance=V,t.fromExtent=function(e,t,r,n,i,a){var o,c,l,u,f=0;if(null!=t.zmax&&null!=t.zmin&&(o=(t.zmax+t.zmin)/2,f=t.zmax-t.zmin),"global"===e.viewingMode){if(!y.isSpatialReferenceSupported(t.spatialReference,"global"))return L(a)&&a.resolver.reject(),null;var v=new s(t.xmin,t.ymin,t.spatialReference),d=new s(t.xmax,t.ymax,t.spatialReference),p=t.spatialReference.isGeographic?z:b;c=new s(p.center(v.x,d.x),(d.y+v.y)/2,t.spatialReference),null!=o&&(c.z=o);var g=m.getGreatCircleSpanAt(c,v,d);l=g.lon,u=g.lat,p.diff(v.x,d.x)>p.range/2&&(l+=m.halfEarthCircumference),l=Math.min(l,m.halfEarthCircumference),u=Math.min(u,m.halfEarthCircumference)}else{var h=P(e);l=t.xmax-t.xmin,u=t.ymax-t.ymin,c=new s({x:t.xmin+.5*l,y:t.ymin+.5*u,z:o,spatialReference:h})}var T=e.state.camera,x=1/Math.tan(T.fovX/2),R=1/Math.tan(T.fovY/2),M=1/Math.tan(T.fov/2),S=Math.max(.5*l*x,.5*u*R,.5*f*M)/1;if(L(a)){var w=F(a.signal);return V(e,r,n,c,S,i,w),void w.resolver.promise.then((function(t){return a.resolver.resolve(j(e,t,e.camera.fov))}),(function(e){return a.resolver.reject(e)}))}var C=V(e,r,n,c,S,i);return j(e,C,e.camera.fov,a)},t.toExtent=function(e,t,r){var n=e.renderSpatialReference,i=c.vec3.dist(t.eye,r),a=T.vectorToPoint(r,n,P(e)),o=2*i*Math.tan(t.fovX/2)*1,l=2*i*Math.tan(t.fovY/2)*1;return"global"===e.viewingMode?p.toExtent(e,a,o,l):d.toExtent(e,a,o,l)};function I(e,t,r,n){return E(e).lookAtTiltToEyeTilt(n,t,r)}function O(e,t,r,n){return E(e).eyeTiltToLookAtTilt(n,t,r)}function j(e,t,r,i){var a=e.renderSpatialReference,o=P(e),c=T.vectorToPoint(t.eye,a,o);return c?i?(i.position=c,i.heading=t.heading,i.tilt=t.tilt,i.fov=r,i):new n(c,t.heading,t.tilt,r):null}function F(e){return{resolver:o.createResolver(),signal:e}}function L(e){return e&&"resolver"in e}t.observerToCamera=j,t.scaleToZoom=function(e,t){var r=e.basemapTerrain&&e.basemapTerrain.tilingScheme;if(r)return r.levelAtScale(t);x.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")},t.zoomToScale=function(e,t){var r=e.basemapTerrain&&e.basemapTerrain.tilingScheme;if(r)return r.scaleAtLevel(t);x.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")},t.scaleToResolution=function(e,t){return e.spatialReference?f.getResolutionForScale(t,e.spatialReference):void 0},t.computeScale=function(e,t,r){var i,a,o=e.renderSpatialReference;t||(t=e.state.camera);var l=u.WGS84;return t instanceof n?(i=t.position.latitude,T.pointToVector(t.position,R,o),T.pointToVector(r,M,o),a=c.vec3.distance(R,M)):(T.vectorToVector(t.center,o,M,l),i=M[1],a=t.distance),U(e,a,i)},t.createAsyncContext=F,t.isAsyncContext=L}));