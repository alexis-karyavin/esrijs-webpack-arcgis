// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../Camera","../../../geometry","../../../Graphic","../../../Viewpoint","../../../core/asyncUtils","../../../core/compilerUtils","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../core/libs/gl-matrix-2/mat3","../../../core/libs/gl-matrix-2/mat3f64","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/webMercatorUtils","../camera/intersectionUtils","./cameraUtils","./ElevationProvider","./geometryUtils","./mathUtils","./projectionUtils"],(function(e,t,a,r,n,i,o,c,s,l,u,m,f,v,p,g,h,d,y,x,w,b,R,_,T,G){function S(e){return 360-T.cyclicalDeg.normalize(e)}function A(e){return T.cyclicalDeg.normalize(360-e)}function z(e,t){return e&&e.resolver&&(null==t?e.resolver.reject():e.resolver.resolve(t)),t}function E(e,t,a,r){if(!t)return z(r);var i=e.spatialReference||n.SpatialReference.WGS84;if(t.camera){var o=t.get("camera.position.spatialReference");if(!x.canProject(o,i))return z(r);var c=t.camera.clone();return o.equals(i)||(c.position=x.project(c.position,i)),z(r,c)}var s=t.get("targetGeometry.spatialReference");if(s&&!x.canProject(s,i))return z(r);var l=b.internalToExternal(e,e.state.camera),u=1;if(null!=t.rotation&&(l.heading=S(t.rotation),u=0),null!=a&&(l.tilt=a),"point"===t.targetGeometry.type){var m=t.targetGeometry,f=void 0,v=t.targetGeometry.clone();return f=null!=t.scale?b.scaleToDistance(e,t.scale,m.latitude):e.state.camera.distance,b.fromCenterDistance(e,v,f,l,u,r)}var p=t.targetGeometry.extent;return b.fromExtent(e,p,l.heading,l.tilt,u,r)}function P(e,t){return null==t.scale&&null!=t.zoom?b.zoomToScale(e,t.zoom):t.scale}function C(e,t){var a=!1;return null!=t.heading?(e.heading=t.heading,a=!0):null!=t.rotation&&(e.heading=S(t.rotation),a=!0),null!=t.tilt&&(e.tilt=t.tilt,a=!0),null!=t.fov&&(e.fov=t.fov),a}function M(e,t,a){var r=e.spatialReference||n.SpatialReference.WGS84;return t=t||b.externalToInternal(e,a.camera),a.targetGeometry=G.vectorToPoint(t.center,e.renderSpatialReference,r),a.scale=b.computeScale(e,t),a.rotation=A(a.camera.heading),a}function B(e,t,a){if(t){if(!x.canProject(t.spatialReference,e.spatialReference))throw new l("viewpointutils:incompatible-spatialreference","Spatial reference ("+(t.spatialReference?t.spatialReference.wkid:"unknown")+") is incompatible with the view ("+e.spatialReference.wkid+")",{geometry:t});var r=[];if(!t.hasZ&&e.basemapTerrain){var n=void 0;switch(t.type){case"point":n=t;break;case"multipoint":case"polyline":case"mesh":n=t.extent.center;break;case"extent":n=t.center;break;case"polygon":n=t.centroid;break;default:s.neverReached(t)}n&&x.canProject(n,e.basemapTerrain.spatialReference)?H[2]=R.getElevationAtPoint(e.elevationProvider,n)||0:H[2]=0}(0,te[t.type])(t,(function(e){r.push(e[0],e[1],e[2])}),H);var i=r.length/3;if(0!==i){var o=new Array(r.length);if(G.bufferToBuffer(r,t.spatialReference,0,o,e.spatialReference,0,i)){t.hasZ&&(a.hasZ=!0);for(var c=0;c<o.length;c+=3)t.hasZ?(H[0]=o[c+0],H[1]=o[c+1],H[2]=o[c+2]):(H[0]=o[c+0],H[1]=o[c+1]),d.expand(a.boundingBox,H)}}}}function F(e,t,r,n){return a.__awaiter(this,void 0,void 0,(function(){var i,o,s,l,m,f;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,c.result(e.whenViewForGraphic(t))];case 1:return!1!==(i=a.sent()).ok&&!u.isNone(i.value)&&"whenGraphicBounds"in i.value?(o=i.value,[4,c.result(o.whenGraphicBounds(t,{minDemResolution:r}))]):(B(e,t.geometry,n),[2]);case 2:return!1===(s=a.sent()).ok?(B(e,t.geometry,n),[2]):(l=s.value,m=l.screenSpaceObjects,f=l.boundingBox,d.expand(n.boundingBox,f),m&&m.forEach((function(e){n.screenSpaceObjects.push(e)})),isFinite(f[2])&&(n.hasZ=!0),[2])}}))}))}function V(e,t,r,o){return a.__awaiter(this,void 0,void 0,(function(){var c,s;return a.__generator(this,(function(a){switch(a.label){case 0:return Array.isArray(t)&&2===t.length&&(c=t[0],s=t[1],"number"==typeof c&&"number"==typeof s)?(ee.x=c,ee.y=s,ee.z=void 0,ee.spatialReference=e.spatialReference.isGeographic?e.spatialReference:n.SpatialReference.WGS84,B(e,ee,o),[2]):t&&"function"==typeof t.map?[4,m.eachAlways(t.map((function(t){return V(e,t,r,o)})))]:[3,2];case 1:return a.sent(),[2];case 2:return t instanceof n.BaseGeometry?(B(e,t,o),[3,5]):[3,3];case 3:return t instanceof i?[4,F(e,t,r,o)]:[3,5];case 4:a.sent(),a.label=5;case 5:return[2]}}))}))}function j(e,t,r,n,i){return a.__awaiter(this,void 0,void 0,(function(){var o,c,s;return a.__generator(this,(function(a){switch(a.label){case 0:return t.camera?[2,D(e,t.camera,i)]:(i.scale=t.scale,i.rotation=t.rotation,i.targetGeometry=t.targetGeometry?t.targetGeometry.clone():null,i.camera=null,null!=r.heading?i.rotation=A(r.heading):null!=r.rotation&&(i.rotation=r.rotation),null!=(o=P(e,r))&&(i.scale=o),c=b.createAsyncContext(n),E(e,i,r.tilt,c),s=i,[4,c.resolver.promise]);case 1:return s.camera=a.sent(),[2,i]}}))}))}function D(e,t,a){a.camera=t.clone(),a.camera.fov=e.camera.fov;var r=e.spatialReference,n=a.camera.position.spatialReference;return x.canProject(n,r)?(n.equals(r)||(a.camera.position=x.project(a.camera.position,r)),M(e,null,a)):null}function Z(e,t,a,r,i){var o=e.renderSpatialReference;return G.pointToVector(a.position,K,o),G.pointToVector(t,Q,o),i.targetGeometry=new n.Point(t),i.camera.position=new n.Point(a.position),g.vec3.subtract(J,Q,K),b.directionToHeadingTilt(e,K,J,r.up,i.camera),i.scale=b.distanceToScale(e,g.vec3.distance(K,Q),i.targetGeometry.latitude),i.rotation=A(i.camera.heading),i}function O(e,t,r,n,i){return a.__awaiter(this,void 0,void 0,(function(){var o,c,s,u,m,f;return a.__generator(this,(function(a){switch(a.label){case 0:if(!r)throw new l("createfromcenter","invalid point");return i.targetGeometry=r.clone(),o=w.cameraOnContentAlongViewDirection(e),t.position?[2,Z(e,i.targetGeometry,t,o,i)]:(t.zoomFactor&&(c=o.distance/t.zoomFactor,s=g.vec3.scale(H,o.viewForward,-c),g.vec3.add(o.eye,o.center,s),o.markViewDirty(),i.scale=b.distanceToScale(e,c,r.latitude)),b.internalToExternal(e,o,i.camera),u=C(i.camera,t)?0:1,t.zoomFactor?[3,2]:(i.scale=P(e,t),null==i.scale&&(G.pointToVector(r,H,e.renderSpatialReference),_.frustum.intersectsPoint(o.frustum.planes,H)?i.scale=b.distanceToScale(e,g.vec3.distance(o.eye,H),r.latitude):i.scale=b.computeScale(e,o)),m=b.createAsyncContext(n),b.fromCenterScale(e,i.targetGeometry,i.scale,i.camera,u,m),f=i,[4,m.resolver.promise]));case 1:f.camera=a.sent(),a.label=2;case 2:return[2,i]}}))}))}function U(e,t,a){var r=w.cameraOnContentAlongViewDirection(e);return g.vec3.copy(J,r.viewForward),b.directionToHeadingTilt(e,r.eye,J,r.up,$),a.camera.position=new n.Point(t.position),a.camera.heading=null!=t.heading?t.heading:$.heading,a.camera.tilt=null!=t.tilt?t.tilt:$.tilt,M(e,null,a)}function k(e,t,r,n){return a.__awaiter(this,void 0,void 0,(function(){var i,o;return a.__generator(this,(function(a){return i=w.cameraOnContentAlongViewDirection(e),o=G.vectorToPoint(i.center,e.renderSpatialReference,ee,e.spatialReference),[2,O(e,t,o,r,n)]}))}))}function I(e,t,r,n,i){return a.__awaiter(this,void 0,void 0,(function(){var o,c,s,l;return a.__generator(this,(function(a){switch(a.label){case 0:return i.targetGeometry=r.clone(),o=w.cameraOnContentAlongViewDirection(e),b.internalToExternal(e,o,i.camera),c=C(i.camera,t)?0:1,s=b.createAsyncContext(n),b.fromExtent(e,r,i.camera.heading,i.camera.tilt,c,s),l=i,[4,s.resolver.promise];case 1:return l.camera=a.sent(),[2,i]}}))}))}function N(e,t,r,n,i,o,c){return a.__awaiter(this,void 0,void 0,(function(){var s,l,u,m,v;return a.__generator(this,(function(a){switch(a.label){case 0:return c.targetGeometry=r.clone(),s=w.cameraOnContentAlongViewDirection(e),l=function(e,t,a,r,n){var i=0;a.hasZ?i=a.z:e.basemapTerrain&&(i=R.getElevationAtPoint(e.elevationProvider,a)),g.vec3.set(H,a.x,a.y,i),G.computeLinearTransformation(e.spatialReference,H,L,e.renderSpatialReference),f.mat3.fromMat4(W,L),f.mat3.transpose(W,W),d.empty(Y);for(var o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],c=0;c<o.length;c++){var s=o[c],l=r[s[2]];isFinite(l)||(l=i),g.vec3.set(H,r[s[0]],r[s[1]],l),G.vectorToVector(H,e.spatialReference,H,e.renderSpatialReference),d.expand(Y,g.vec3.transformMat3(H,H,W))}var u=d.width(Y),m=d.height(Y),v=d.depth(Y),p=1/Math.tan(t.fovX/2),h=1/Math.tan(t.fovY/2),y=.5*Math.sqrt(u*u+v*v)*Math.max(h,p)+.5*m,x=.5*m*h+.5*Math.max(u,v);return Math.max(y,x)/n}(e,s,r,n,i),b.internalToExternal(e,s,c.camera),u=C(c.camera,t)?0:1,c.scale=b.distanceToScale(e,l,c.targetGeometry.latitude),m=b.createAsyncContext(o),b.fromCenterScale(e,c.targetGeometry,c.scale,c.camera,u,m),v=c,[4,m.resolver.promise];case 1:return v.camera=a.sent(),[2,c]}}))}))}function q(e){return e&&(e.rotation=A(e.camera.heading)),e}Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULT_FRAME_COVERAGE=.66,t.rotationToHeading=S,t.headingToRotation=A,t.toCamera=E,t.fromInternalCamera=function(e,t,a){return a||(a=new o({camera:new r})),b.internalToExternal(e,t,a.camera),M(e,t,a)},t.fromCamera=function(e,t,a){return a||(a=new o),a.camera=t.clone(),M(e,null,a)},t.create=function(e,i,c){return a.__awaiter(this,void 0,void 0,(function(){var s,u,m,f,v,p,g,h,x,w,R,_;return a.__generator(this,(function(a){switch(a.label){case 0:if(!(s=function(e,t){if(!t||!e.spatialReference)return null;var a={target:null};if("declaredClass"in t||Array.isArray(t))a.target=t;else{for(var r in t)a[r]=t[r];t.center&&!a.target&&(a.target=t.center)}return a}(e,i)))throw new l("viewpointutils-create:no-target","Missing target for creating viewpoint");return u=new o({camera:new r({fov:e.camera.fov})}),s.target instanceof o?[4,j(e,s.target,s,c,u)]:[3,2];case 1:return[2,q(a.sent())];case 2:return s.target instanceof r?[2,q(D(e,s.target,u))]:(m=null!=s.scale||null!=s.zoom,s.target instanceof n.Extent?(h=s.target.xmin===s.target.xmax||s.target.ymin===s.target.ymax,m||h?(f=q,[4,O(e,s,s.target.center,c,u)]):[3,4]):[3,6]);case 3:return[2,f.apply(void 0,[a.sent()])];case 4:return v=q,[4,I(e,s,s.target,c,u)];case 5:return[2,v.apply(void 0,[a.sent()])];case 6:return p={boundingBox:d.empty(),hasZ:!1,screenSpaceObjects:[]},g=m?function(e,t){return b.scaleToResolution(e,P(e,t))}(e,s):void 0,[4,V(e,s.target,g,p)];case 7:return a.sent(),isFinite(p.boundingBox[0])?(d.center(p.boundingBox,H),ee.x=H[0],ee.y=H[1],ee.z=H[2],ee.spatialReference=e.spatialReference,h=void 0,isFinite(ee.z)&&p.hasZ?h=d.isPoint(p.boundingBox):(ee.z=void 0,h=y.isPoint(d.toRect(p.boundingBox,X))),m||h?(x=q,[4,O(e,s,ee,c,u)]):[3,9]):[3,11];case 8:return[2,x.apply(void 0,[a.sent()])];case 9:return w=function(e,a){var r=t.DEFAULT_FRAME_COVERAGE;if(!a.length)return r;for(var n=Number.NEGATIVE_INFINITY,i=0;i<a.length;i++){var o=a[i].screenSpaceBoundingRect;n=Math.max(n,Math.abs(o[0]),Math.abs(o[1]),Math.abs(o[2]),Math.abs(o[3]))}var c=Math.min(e.width,e.height);return r-n/c*2}(e,p.screenSpaceObjects),R=q,[4,N(e,s,ee,p.boundingBox,w,c,u)];case 10:return[2,R.apply(void 0,[a.sent()])];case 11:return s.position?[2,q(U(e,s,u))]:(_=q,[4,k(e,s,c,u)]);case 12:return[2,_.apply(void 0,[a.sent()])]}}))}))};var H=h.vec3f64.create(),L=p.mat4f64.create(),W=v.mat3f64.create(),Y=d.create(),X=y.create(),J=h.vec3f64.create(),K=h.vec3f64.create(),Q=h.vec3f64.create(),$={heading:0,tilt:0},ee=new n.Point,te={point:function(e,t,a){a[0]=e.x,a[1]=e.y,e.hasZ&&(a[2]=e.z),t(a)},polygon:function(e,t,a){for(var r=e.hasZ,n=0;n<e.rings.length;n++)for(var i=e.rings[n],o=0;o<i.length;o++)a[0]=i[o][0],a[1]=i[o][1],r&&(a[2]=i[o][2]),t(a)},polyline:function(e,t,a){for(var r=e.hasZ,n=0;n<e.paths.length;n++)for(var i=e.paths[n],o=0;o<i.length;o++)a[0]=i[o][0],a[1]=i[o][1],r&&(a[2]=i[o][2]),t(a)},multipoint:function(e,t,a){for(var r=e.points,n=e.hasZ,i=0;i<r.length;i++)a[0]=r[i][0],a[1]=r[i][1],n&&(a[2]=r[i][2]),t(a)},extent:function(e,t,a){e.hasZ?(t(g.vec3.set(a,e.xmin,e.ymin,e.zmin)),t(g.vec3.set(a,e.xmax,e.ymin,e.zmin)),t(g.vec3.set(a,e.xmin,e.ymax,e.zmin)),t(g.vec3.set(a,e.xmax,e.ymax,e.zmin)),t(g.vec3.set(a,e.xmin,e.ymin,e.zmax)),t(g.vec3.set(a,e.xmax,e.ymin,e.zmax)),t(g.vec3.set(a,e.xmin,e.ymax,e.zmax)),t(g.vec3.set(a,e.xmax,e.ymax,e.zmax))):(t(g.vec3.set(a,e.xmin,e.ymin,a[2])),t(g.vec3.set(a,e.xmax,e.ymin,a[2])),t(g.vec3.set(a,e.xmin,e.ymax,a[2])),t(g.vec3.set(a,e.xmax,e.ymax,a[2])))},mesh:function(e,t,a){var r=e.vertexAttributes&&e.vertexAttributes.position;if(r)for(var n=0;n<r.length;n+=3)t(g.vec3.set(a,r[n+0],r[n+1],r[n+2]))}}}));