// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../../core/mathUtils","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../lib/SunCalc"],(function(t,e,i,a,n,l,o,r){Object.defineProperty(e,"__esModule",{value:!0}),e.settings={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,diffuseAtNoon:.65,diffuseAtTwilight:.7},global:{altitude:8e5,ambient:.015,diffuse:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}},e.computeColorAndIntensity=function(t,a){var n=a[2],s=c;l.vec3.set(s.ambient.color,1,1,1),s.ambient.intensity=e.settings.global.ambient,l.vec3.set(s.diffuse.color,1,1,1),s.diffuse.intensity=e.settings.global.diffuse;var u=(Math.abs(n)-e.settings.local.altitude)/(e.settings.global.altitude-e.settings.local.altitude);u=i.clamp(u,0,1),s.globalFactor=u;var m=r.getTimes(t,a[1],a[0]);if(u<1){var g=function(t,i){var a,n,l=t.valueOf();i.polarException===r.POLAR_EXCEPTION.MIDNIGHT_SUN?(a=l-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,n=a+432e6):i.polarException===r.POLAR_EXCEPTION.POLAR_NIGHT?(a=l-2,n=l-1):(a=i.sunrise.valueOf(),n=i.sunset.valueOf());var s,u,c=n-a,m=a+c/2,g=c/4,d=m-g,b=m+g,v=.06*c,A=a-v/2,h=a+v/2,p=n-v/2,y=n+v/2,N=e.settings.local,O=[.01,N.ambientAtNight],P=[.8,.8,1],E=[.01,.01,.01],I=[N.diffuseAtTwilight,N.ambientAtTwilight],M=[1,.75,.75],T=[.8,.8,1],_=[.9*N.diffuseAtNoon,N.ambientAtNoon],x=[1,.98,.98],z=[.98,.98,1],D=[N.diffuseAtNoon,N.ambientAtNoon],C=[1,1,1],H=[1,1,1],L=_,R=x,X=z,w=I,F=M,G=T,S=[0,0],U=[0,0,0],V=[0,0,0];l<A||l>y?(S=O,U=E,V=P,u="night"):l<h?(S=f(l-A,s=h-A,O,I),U=f(l-A,s,E,M),V=f(l-A,s,P,T),u="sun rising"):l<d?(S=f(l-h,s=d-h,I,_),U=f(l-h,s,M,x),V=f(l-h,s,T,z),u="early morning"):l<m?(S=f(l-d,s=m-d,_,D),U=f(l-d,s,x,C),V=f(l-d,s,z,H),u="late morning"):l<b?(S=f(l-m,s=b-m,D,L),U=f(l-m,s,C,R),V=f(l-m,s,H,X),u="early afternoon"):l<p?(S=f(l-b,s=p-b,L,w),U=f(l-b,s,R,F),V=f(l-b,s,X,G),u="late afternoon"):l<y&&(S=f(l-p,s=y-p,w,O),U=f(l-p,s,F,E),V=f(l-p,s,G,P),u="sun setting");return{diffuse:{intensity:S[0],color:o.vec3f64.fromValues(U[0],U[1],U[2])},ambient:{intensity:S[1],color:o.vec3f64.fromValues(V[0],V[1],V[2])},timeOfDay:u}}(t,m);l.vec3.lerp(s.ambient.color,g.ambient.color,s.ambient.color,u),s.ambient.intensity=i.lerp(g.ambient.intensity,s.ambient.intensity,u),l.vec3.lerp(s.diffuse.color,g.diffuse.color,s.diffuse.color,u),s.diffuse.intensity=i.lerp(g.diffuse.intensity,s.diffuse.intensity,u)}return s.noonFactor=function(t,e){var a,n,l=t.valueOf();e.polarException===r.POLAR_EXCEPTION.MIDNIGHT_SUN?(a=l-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,n=a+432e6):e.polarException===r.POLAR_EXCEPTION.POLAR_NIGHT?(a=l-2,n=l-1):(a=e.sunrise.valueOf(),n=e.sunset.valueOf());var o=a+(n-a)/2;return 1-i.clamp(Math.abs(l-o)/432e5,0,1)}(t,m),s},e.computeDirection=function(t,n,c,f){f||(f=o.vec3f64.create());var m=u,g=a.mat4.identity(s);if("global"===c)r.getPosition(t,0,0,m),l.vec3.set(f,0,0,-1),a.mat4.rotateX(g,g,-m.azimuth),a.mat4.rotateY(g,g,-m.altitude),l.vec3.transformMat4(f,f,g);else{var d=e.settings.planarDirection,b=d.globalAngles,v=n[2],A=(Math.abs(v)-d.localAltitude)/(d.globalAltitude-d.localAltitude);(A=i.clamp(A,0,1))<1?(r.getPosition(t,n[1],n[0],m),m.azimuth=(1-A)*m.azimuth+A*b.azimuth,m.altitude=(1-A)*m.altitude+A*b.altitude):(m.azimuth=b.azimuth,m.altitude=b.altitude),l.vec3.set(f,0,-1,0),a.mat4.rotateZ(g,g,-m.azimuth),a.mat4.rotateX(g,g,-m.altitude),l.vec3.transformMat4(f,f,g)}return f},e.computeShadowsEnabled=function(t,i){if("global"===i)return!0;var a=e.settings.planarDirection,n=t[2];return Math.abs(n)<a.localAltitude};var s=n.mat4f64.create(),u={azimuth:0,altitude:0},c={ambient:{color:o.vec3f64.create(),intensity:0},diffuse:{color:o.vec3f64.create(),intensity:0,direction:o.vec3f64.create()},globalFactor:0,noonFactor:0};function f(t,e,i,a){for(var n=[],l=0;l<i.length;l++)n[l]=(a[l]-i[l])*t/e+i[l];return n}}));