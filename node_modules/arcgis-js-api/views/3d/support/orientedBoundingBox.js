// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../../core/libs/gl-matrix-2/mat3","../../../core/libs/gl-matrix-2/mat3f64","../../../core/libs/gl-matrix-2/quat","../../../core/libs/gl-matrix-2/quatf32","../../../core/libs/gl-matrix-2/quatf64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f32","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingBox","./dito","./geometryUtils"],(function(e,a,t,r,n,i,c,f,o,u,l,s,h,v,b){Object.defineProperty(a,"__esModule",{value:!0});var m=c.quatf64.create(),z=u.vec3f64.create(),S=u.vec3f64.create(),M=s.vec4f64.create(),q=r.mat3f64.create(),g=function(e){var a=56*e;this.buffer=new ArrayBuffer(a),this.obbs=new Array(e);for(var t=0;t<e;t++)this.obbs[t]={center:u.vec3f64.createView(this.buffer,56*t+0),halfSize:o.vec3f32.createView(this.buffer,56*t+24),quaternion:i.quatf32.createView(this.buffer,56*t+36)}};function d(e,a,t){return void 0===e&&(e=[0,0,0]),void 0===a&&(a=[-1,-1,-1]),void 0===t&&(t=[0,0,0,1]),{center:u.vec3f64.clone(e),halfSize:o.vec3f32.clone(a),quaternion:i.quatf32.clone(t)}}function p(e,a){var t=b.plane.signedDistance(a,e.center),r=w(e,a);return t>r?1:t<-r?-1:0}a.ObbArray=g,a.create=d,a.clone=function(e){return d(e.center,e.halfSize,e.quaternion)},a.set=function(e,a){f.vec3.copy(a.center,e.center),f.vec3.copy(a.halfSize,e.halfSize),n.quat.copy(a.quaternion,e.quaternion)},a.compute=function(e,a){return a=a||d(),v.computeOBB(e,a),a},a.intersectPlane=p,a.toAaBoundingBox=function(e,a){a||(a=h.create());var r=t.mat3.fromQuat(q,e.quaternion),n=e.halfSize[0]*Math.abs(r[0])+e.halfSize[1]*Math.abs(r[3])+e.halfSize[2]*Math.abs(r[6]),i=e.halfSize[0]*Math.abs(r[1])+e.halfSize[1]*Math.abs(r[4])+e.halfSize[2]*Math.abs(r[7]),c=e.halfSize[0]*Math.abs(r[2])+e.halfSize[1]*Math.abs(r[5])+e.halfSize[2]*Math.abs(r[8]);return a[0]=e.center[0]-n,a[1]=e.center[1]-i,a[2]=e.center[2]-c,a[3]=e.center[0]+n,a[4]=e.center[1]+i,a[5]=e.center[2]+c,a},a.minimumDistancePlane=function(e,a){return b.plane.signedDistance(a,e.center)-w(e,a)},a.maximumDistancePlane=function(e,a){return b.plane.signedDistance(a,e.center)+w(e,a)},a.isVisible=function(e,a){return p(e,a.planes[0])<=0&&p(e,a.planes[1])<=0&&p(e,a.planes[2])<=0&&p(e,a.planes[3])<=0&&p(e,a.planes[4])<=0&&p(e,a.planes[5])<=0},a.intersectLine=function(e,a,t,r){void 0===r&&(r=0),n.quat.conjugate(m,e.quaternion),f.vec3.subtract(z,a,e.center);for(var i=f.vec3.transformQuat(z,z,m),c=f.vec3.transformQuat(S,t,m),o=-1/0,u=1/0,l=0;l<3;l++)if(Math.abs(c[l])>1e-6){var s=(r+e.halfSize[l]-i[l])/c[l],h=(-r-e.halfSize[l]-i[l])/c[l];o=Math.max(o,Math.min(s,h)),u=Math.min(u,Math.max(s,h))}else if(i[l]>e.halfSize[l]+r||i[l]<-e.halfSize[l]-r)return!1;return o<=u},a.projectedArea=function(e,a,r,i,c){n.quat.conjugate(m,e.quaternion),f.vec3.sub(z,a,e.center),f.vec3.transformQuat(z,z,m);var o=z[0]<-e.halfSize[0]?-1:z[0]>e.halfSize[0]?1:0,u=z[1]<-e.halfSize[1]?-1:z[1]>e.halfSize[1]?1:0,s=z[2]<-e.halfSize[2]?-1:z[2]>e.halfSize[2]?1:0,h=Math.abs(o)+Math.abs(u)+Math.abs(s);if(0===h)return 1/0;var v=1===h?4:6,b=6*(o+3*u+9*s+13);t.mat3.fromQuat(q,e.quaternion),t.mat3.scale(q,q,e.halfSize);for(var S=0;S<v;S++){var g=j[b+S];f.vec3.set(z,((1&g)<<1)-1,(2&g)-1,((4&g)>>1)-1),f.vec3.transformMat3(z,z,q),f.vec3.add(M,e.center,z),M[3]=1,l.vec4.transformMat4(M,M,r);var d=1/Math.max(1e-6,M[3]);Q[2*S]=M[0]*d,Q[2*S+1]=M[1]*d}var p=2*v-2,x=Q[0]*(Q[3]-Q[p+1])+Q[p]*(Q[1]-Q[p-1]);for(S=2;S<p;S+=2)x+=Q[S]*(Q[S+3]-Q[S-1]);return Math.abs(x)*i*c*.125};var x,y,B,Q=[.1,.2,.3,.4,.5,.6,.7,.8,.9,1,1.1,1.2],j=(x=new Int8Array(162),y=0,(B=function(e){for(var a=0;a<e.length;a++)x[y+a]=e[a];y+=6})([6,2,3,1,5,4]),B([0,2,3,1,5,4]),B([0,2,3,7,5,4]),B([0,1,3,2,6,4]),B([0,1,3,2,0,0]),B([0,1,5,7,3,2]),B([0,1,3,7,6,4]),B([0,1,3,7,6,2]),B([0,1,5,7,6,2]),B([0,1,5,4,6,2]),B([0,1,5,4,0,0]),B([0,1,3,7,5,4]),B([0,2,6,4,0,0]),B([0,0,0,0,0,0]),B([1,3,7,5,0,0]),B([2,3,7,6,4,0]),B([2,3,7,6,0,0]),B([2,3,1,5,7,6]),B([0,1,5,7,6,2]),B([0,1,5,7,6,4]),B([0,1,3,7,6,4]),B([4,5,7,6,2,0]),B([4,5,7,6,0,0]),B([4,5,1,3,7,6]),B([0,2,3,7,5,4]),B([6,2,3,7,5,4]),B([6,2,3,1,5,4]),x);function w(e,a){n.quat.conjugate(m,e.quaternion),f.vec3.transformQuat(z,a,m);var t=e.halfSize;return Math.abs(z[0]*t[0])+Math.abs(z[1]*t[1])+Math.abs(z[2]*t[2])}a.projectedRadius=w,a.corners=function(e,a){for(var t=0;t<8;++t){var r=a[t];r[0]=1&t?-e.halfSize[0]:e.halfSize[0],r[1]=2&t?-e.halfSize[1]:e.halfSize[1],r[2]=4&t?-e.halfSize[2]:e.halfSize[2],f.vec3.transformQuat(r,r,e.quaternion),f.vec3.add(r,r,e.center)}}}));