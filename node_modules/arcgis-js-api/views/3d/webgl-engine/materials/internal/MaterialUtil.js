// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../geometry/support/aaBoundingBox","../../lib/screenSizePerspectiveUtils","../../lib/Util","../renderers/utils"],(function(e,r,t,i,n,a,o,c,f,v){Object.defineProperty(r,"__esModule",{value:!0});var s=o.create(),l=f.VertexAttrConstants;r.intersectTriangleGeometry=function(e,r,t,n,a,c,d){var m=v.isInstanceHidden(r),g=t.tolerance;if(!m)if(e.boundingInfo)f.assert("triangle"===e.data.primitiveType),function e(r,t,n,a,c,f){var v=M(t,n,u);o.setMin(s,r.getBBMin()),o.setMax(s,r.getBBMax()),i.isSome(c)&&c.applyToAABB(s);if(I(s,t,v,a)){var l=r.getPrimitiveIndices(),d=r.getIndices(),m=r.getPosition(),g=l?l.length:d.length/3;if(g>A){var x=r.getChildren();if(void 0!==x){for(var h=0;h<8;++h)void 0!==x[h]&&e(x[h],t,n,a,c,f);return}}p(t,n,0,g,d,m,l,c,f)}}(e.boundingInfo,n,a,g,c,d);else{var x=e.getIndices(l.POSITION),h=e.getAttribute(l.POSITION);p(n,a,0,x.length/3,x,h,void 0,c,d)}};var u=a.vec3f64.create();var d=Math.pow(2,-52),m=a.vec3f64.create();function p(e,r,t,n,a,o,c,f,v){var s,l,u;if(c)return function(e,r,t,n,a,o,c,f,v){for(var s,l,u,p=o.data,g=o.offsetIdx,x=o.strideIdx,M=e[0],I=e[1],b=e[2],y=r[0],A=r[1],T=r[2],P=y-M,S=A-I,B=T-b,O=t;O<n;++O){var V=c[O],L=3*V,D=g+x*a[L++],N=p[D++],U=p[D++],z=p[D];D=g+x*a[L++];var E=p[D++],C=p[D++],R=p[D];D=g+x*a[L];var W=p[D++],_=p[D++],G=p[D];i.isSome(f)&&(s=f.applyToVertex(N,U,z),N=s[0],U=s[1],z=s[2],l=f.applyToVertex(E,C,R),E=l[0],C=l[1],R=l[2],u=f.applyToVertex(W,_,G),W=u[0],_=u[1],G=u[2]);var H=E-N,j=C-U,q=R-z,w=W-N,X=_-U,Y=G-z,Z=S*Y-X*B,k=B*w-Y*P,F=P*X-w*S,J=H*Z+j*k+q*F;if(!(Math.abs(J)<=d)){var K=M-N,Q=I-U,$=b-z,ee=K*Z+Q*k+$*F;if(J>0){if(ee<0||ee>J)continue}else if(ee>0||ee<J)continue;var re=Q*q-j*$,te=$*H-q*K,ie=K*j-H*Q,ne=P*re+S*te+B*ie;if(J>0){if(ne<0||ee+ne>J)continue}else if(ne>0||ee+ne<J)continue;var ae=(w*re+X*te+Y*ie)/J;if(ae>=0){var oe=h(H,j,q,w,X,Y,m);v(ae,oe,V)}}}}(e,r,t,n,a,o,c,f,v);for(var p=o.data,g=o.offsetIdx,x=o.strideIdx,M=e[0],I=e[1],b=e[2],y=r[0]-M,A=r[1]-I,T=r[2]-b,P=t,S=3*t;P<n;++P){var B=g+x*a[S++],O=p[B++],V=p[B++],L=p[B];B=g+x*a[S++];var D=p[B++],N=p[B++],U=p[B];B=g+x*a[S++];var z=p[B++],E=p[B++],C=p[B];i.isSome(f)&&(O=(s=f.applyToVertex(O,V,L))[0],V=s[1],L=s[2],D=(l=f.applyToVertex(D,N,U))[0],N=l[1],U=l[2],z=(u=f.applyToVertex(z,E,C))[0],E=u[1],C=u[2]);var R=D-O,W=N-V,_=U-L,G=z-O,H=E-V,j=C-L,q=A*j-H*T,w=T*G-j*y,X=y*H-G*A,Y=R*q+W*w+_*X;if(!(Math.abs(Y)<=d)){var Z=M-O,k=I-V,F=b-L,J=Z*q+k*w+F*X;if(Y>0){if(J<0||J>Y)continue}else if(J>0||J<Y)continue;var K=k*_-W*F,Q=F*R-_*Z,$=Z*W-R*k,ee=y*K+A*Q+T*$;if(Y>0){if(ee<0||J+ee>Y)continue}else if(ee>0||J+ee<Y)continue;var re=(G*K+H*Q+j*$)/Y;if(re>=0)v(re,h(R,W,_,G,H,j,m),P)}}}r.intersectTriangles=p;var g=a.vec3f64.create(),x=a.vec3f64.create();function h(e,r,t,i,a,o,c){return n.vec3.set(g,e,r,t),n.vec3.set(x,i,a,o),n.vec3.cross(c,g,x),n.vec3.normalize(c,c),c}function M(e,r,t){return n.vec3.set(t,1/(r[0]-e[0]),1/(r[1]-e[1]),1/(r[2]-e[2]))}function I(e,r,t,i){return b(e,r,t,i,1/0)}function b(e,r,t,i,n){var a=(e[0]-i-r[0])*t[0],o=(e[3]+i-r[0])*t[0],c=Math.min(a,o),f=Math.max(a,o),v=(e[1]-i-r[1])*t[1],s=(e[4]+i-r[1])*t[1];if((f=Math.min(f,Math.max(v,s)))<0)return!1;if((c=Math.max(c,Math.min(v,s)))>f)return!1;var l=(e[2]-i-r[2])*t[2],u=(e[5]+i-r[2])*t[2];return!((f=Math.min(f,Math.max(l,u)))<0)&&(!((c=Math.max(c,Math.min(l,u)))>f)&&c<n)}function y(e){var r=[];return e.forEach((function(e){return r.push(e)})),r}r.computeNormal=h,r.computeInvDir=M,r.intersectAabbInvDir=I,r.intersectAabbInvDirBefore=b,r.verticalOffsetAtDistance=function(e,r,i,n,a){var o=(i.screenLength||0)*e.pixelRatio;a&&(o=c.scale(o,n,r,a));var f=o*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return t.glClamp(f*r,i.minWorldLength||0,null!=i.maxWorldLength?i.maxWorldLength:1/0)},r.bindScreenSizePerspective=function(e,r,t){if(e){var i=e.parameters,n=e.paddingPixelsOverride;r.setUniform4f(t,i.divisor,i.offset,i.minPixelSize,n)}},r.copyParameters=function e(r,t){var i=t?e(t):{};for(var n in r){var a=r[n];a&&a.forEach&&(a=y(a)),null==a&&n in i||(i[n]=a)}return i},r.updateParameters=function(e,r){var t=!1;for(var i in r){var n=r[i];void 0!==n&&(t=!0,Array.isArray(n)?e[i]=n.slice():e[i]=n)}return t},r.intersectDrapedRenderLineGeometry=function(e,r,i,n,a){if(r.options.selectionMode){for(var o=e.getAttribute(l.POSITION).data,c=e.getAttribute(l.SIZE),f=c&&c.data[0],v=i[0],s=i[1],u=((f+n)/2+4)*e.pixelRatio,d=Number.MAX_VALUE,m=0;m<o.length-5;m+=3){var p=o[m],g=o[m+1],x=v-p,h=s-g,M=o[m+3]-p,I=o[m+4]-g,b=M*x+I*h,y=M*M+I*I,A=t.clamp(b/y,0,1),T=M*A-x,P=I*A-h,S=T*T+P*P;S<d&&(d=S)}d<u*u&&a()}},r.colorMixModes={multiply:1,ignore:2,replace:3,tint:4};var A=1e3}));