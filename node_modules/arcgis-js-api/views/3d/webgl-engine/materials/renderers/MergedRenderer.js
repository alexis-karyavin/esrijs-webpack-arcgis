// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../../../../core/MapUtils","../../../../../core/MapUtils","../../../../../core/maybe","../../../../../core/maybe","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f64","../../../support/buffer/glUtil","../../lib/DefaultVertexAttributeLocations","../../lib/renderStats","../../lib/ResizableFloat32Array","../../lib/Util","../WaterGLMaterial","./Instance","./utils","../../../../webgl/BufferObject","../../../../webgl/Util","../../../../webgl/VertexArrayObject"],(function(e,t,a,r,i,n,s,o,u,l,d,c,f,h,m,g,p,b,v){var y=function(){function e(e,t,a,r){void 0===r&&(r=l.Default3D),this.type="MergedRenderer",this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._rctx=e,this._vertexAttributeLocations=r,this._material=a,this._materialRep=t,this._glMaterials=g.acquireMaterials(this._material,this._materialRep),this._bufferWriter=a.createBufferWriter()}return e.prototype.dispose=function(){g.releaseMaterials(this._material,this._materialRep),this._dataByOrigin&&(this._dataByOrigin.forEach((function(e){e.vao.dispose(!0),e.vao=null})),this._dataByOrigin.clear(),this._dataByOrigin=null),this._glMaterials&&(this._glMaterials.forEach((function(e){e&&e.dispose()})),this._glMaterials.clear(),this._glMaterials=null)},Object.defineProperty(e.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._hasHighlights},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasOccludees",{get:function(){return this._hasOccludees},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasWater",{get:function(){return!this.isEmpty&&r.someMap(this._glMaterials,(function(e){return e instanceof h.WaterGLMaterial}))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rendersOccluded",{get:function(){return!this.isEmpty&&1!==this._material.renderOccluded},enumerable:!0,configurable:!0}),e.prototype.modify=function(e){this.updateGeometries(e.toUpdate),this.addAndRemoveGeometries(e.toAdd,e.toRemove),this.updateRenderCommands()},e.prototype.addAndRemoveGeometries=function(e,t){var a=this,r=this._bufferWriter,i=r.vertexBufferLayout,n=i.stride/4,s=this._dataByOrigin,o=function(e,t,a,r){for(var i=new Map,n=t.vertexBufferLayout.stride/4,s=function(a,r){var s=a.origin,o=e.get(s.id),u=i.get(s.id);null==u&&(u={optimalCount:null==o?0:o.optimalCount,sparseCount:null==o?0:o.buffer.size,toAdd:[],toRemove:[],origin:s.vec3},i.set(s.id,u));var l=t.elementCount(a.data)*n;r?(u.optimalCount+=l,u.sparseCount+=l,u.toAdd.push(a)):(u.optimalCount-=l,u.toRemove.push(a))},o=0,u=a;o<u.length;o++){var l=u[o];s(l,!0)}for(var d=0,c=r;d<c.length;d++){l=c[d];s(l,!1)}return i}(s,r,e,t);o.forEach((function(e,t){o.delete(t);var r=e.optimalCount,u=e.sparseCount,l=s.get(t);if(null==l&&(f.assert(r>0),l=a.createData(i,r,e.origin),s.set(t,l)),0===r)return l.vao.dispose(!0),l.vao=null,void s.delete(t);var d=r<e.sparseCount/2,c=d?r:u,h=C,m=l.buffer.size,g=l.buffer.array,p=l.buffer.resize(c,!1);d||p?a.removeAndRebuild(l,e.toRemove,n,g,h):e.toRemove.length>0?(a.removeByErasing(l,e.toRemove,n,h),e.toAdd.length>0&&(h.end=m)):(h.begin=m,h.end=m);var b=O;f.setMatrixTranslation3(b,-e.origin[0],-e.origin[1],-e.origin[2]),a.append(l,e.toAdd,n,b,h);var v=l.vao.vertexBuffers.geometry;if(v.byteSize!==l.buffer.array.buffer.byteLength)v.setData(l.buffer.array);else{var y=h.begin,_=h.end;if(y<_){var w=l.buffer.array,M=4*y,B=4*_;v.setSubData(w,M,M,B)}}l.drawCommandsDirty=!0}))},e.prototype.updateGeometries=function(e){for(var t=this._bufferWriter,a=t.vertexBufferLayout.stride/4,r=0,i=e;r<i.length;r++){var n=i[r],s=n.updateType,o=n.renderGeometry,u=this._dataByOrigin.get(o.origin.id),l=u&&u.instances.get(o.uniqueName);if(!l)return;if(1&s&&(l.isVisible=o.instanceParameters.visible),9&s){var d=o.instanceParameters.visible;l.hasHighlights=!!o.instanceParameters.highlights&&d}if(16&s&&(l.hasOccludees=!!o.instanceParameters.occludees),6&s){var c=u.buffer.array,h=u.vao;g.calculateTransformRelToOrigin(o,_,w),t.write({transformation:_,invTranspTransformation:w},o.data,t.vertexBufferLayout.createView(c.buffer),l.from),f.assert(l.from+t.elementCount(o.data)===l.to,"material VBO layout has changed"),h.vertexBuffers.geometry.setSubData(c,l.from*a*4,l.from*a*4,l.to*a*4)}u.drawCommandsDirty=!0}},e.prototype.updateRenderCommands=function(){this._dataByOrigin.forEach((function(e){e.hasHiddenInstances=r.someMap(e.instances,(function(e){return!e.isVisible})),e.hasHighlights=r.someMap(e.instances,(function(e){return e.isVisible&&e.hasHighlights})),e.hasOccludees=r.someMap(e.instances,(function(e){return e.isVisible&&e.hasOccludees}))})),this._hasHighlights=r.someMap(this._dataByOrigin,(function(e){return e.hasHighlights})),this._hasOccludees=r.someMap(this._dataByOrigin,(function(e){return e.hasOccludees}));this._dataByOrigin.forEach((function(e){e.drawCommandsDirty&&(!function(e){if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.stats={default:0,highlight:0,occludees:0},0!==e.instances.size){if(!(e.hasOccludees||e.hasHighlights||e.hasHiddenInstances)){var t=4*e.buffer.size/b.getStride(e.vao.layout.geometry);return e.drawCommandsDefault=[{first:0,count:t}],void(e.stats={default:t,highlight:0,occludees:0})}var r=m.sortInstancesAccordingToRange(a.valuesOfMap(e.instances));e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[];for(var i=0,n=r;i<n.length;i++){var s=n[i];s.isVisible&&(s.hasOccludees?m.addOrMerge(e.drawCommandsOccludees,s):m.addOrMerge(e.drawCommandsDefault,s),s.hasHighlights&&m.addOrMerge(e.drawCommandsHighlight,s))}var o=function(e){for(var t=0,a=0,r=e;a<r.length;a++){t+=r[a].count}return t/3};e.stats={default:o(e.drawCommandsDefault),highlight:o(e.drawCommandsHighlight),occludees:o(e.drawCommandsOccludees)}}}(e),e.drawCommandsDirty=!1)}))},e.prototype.updateLogic=function(e){return this._material.update(e)},e.prototype.render=function(e,t,a,r){var s=this,o=this._rctx,u=this._glMaterials.get(t.pass),l=4===t.pass,c=e;if(2===t.pass&&null===c&&(c=22),!u||2!==u.ensureResources(o)||null!=c&&!u.beginSlot(c)||l&&!this._hasHighlights)return!1;u.ensureParameters(a);var f=u.getTechnique(),h=u.getPipelineState(c,!1);o.setPipelineState(h),u.bind(o,a);var m=!1;return this._dataByOrigin.forEach((function(e){if(!(i.isNone(e.drawCommandsDefault)&&i.isNone(e.drawCommandsHighlight)&&i.isNone(e.drawCommandsOccludees))&&(!l||e.hasHighlights)){a.origin=e.origin,f.bindDraw(a),f.ensureAttributeLocations(e.vao),o.bindVAO(e.vao);var t=f.primitiveType,g=l?e.drawCommandsHighlight:e.drawCommandsDefault,p=l?e.stats.highlight:e.stats.default;if(n.isSome(g)&&(s.renderCommands(o,t,g),d.addToRenderStats(g.length,p,r),m=!0),!l&&(g=e.drawCommandsOccludees,n.isSome(g))){var b=u.getPipelineState(c,!0);o.setPipelineState(b),s.renderCommands(o,t,g),o.setPipelineState(h),d.addToRenderStats(g.length,e.stats.occludees,r),m=!0}}})),m},e.prototype.renderCommands=function(e,t,a){for(var r=0;r<a.length;r++)e.drawArrays(t,a[r].first,a[r].count)},e.prototype.createData=function(e,t,a){return{instances:new Map,vao:new v(this._rctx,this._vertexAttributeLocations,{geometry:u.glLayout(e)},{geometry:p.createVertex(this._rctx,35044)}),buffer:new c.ResizableFloat32Array(t),optimalCount:0,origin:a,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,stats:{default:0,highlight:0,occludees:0}}},e.prototype.removeAndRebuild=function(e,t,a,r,i){for(var n=0,s=t;n<s.length;n++){var o=s[n].uniqueName,u=e.instances.get(o);e.optimalCount-=(u.to-u.from)*a,e.instances.delete(o)}var l=0,d=e.buffer.array;i.begin=0,i.end=0;var c=-1,f=-1,h=0;e.instances.forEach((function(e){var t=e.from*a,i=e.to*a,n=i-t;c!==f&&f!==t?(d.set(r.subarray(c,f),h),h+=f-c,c=t):-1===c&&(c=t),f=i,e.from=l/a,l+=n,e.to=l/a})),c!==f&&d.set(r.subarray(c,f),h),i.end=l},e.prototype.removeByErasing=function(e,t,a,r){r.begin=1/0,r.end=-1/0;for(var i=-1,n=-1,s=0,o=t;s<o.length;s++){var u=o[s].uniqueName,l=e.instances.get(u),d=l.from*a,c=l.to*a;i!==n&&n!==d?(e.buffer.erase(i,n),i=d):-1===i&&(i=d),n=c,e.instances.delete(u),e.optimalCount-=c-d,d<r.begin&&(r.begin=d),c>r.end&&(r.end=c)}i!==n&&e.buffer.erase(i,n)},e.prototype.append=function(e,t,a,r,i){for(var o=this._bufferWriter,u=0,l=t;u<l.length;u++){var d=l[u],c=n.isSome(d.transformation)?s.mat4.multiply(_,r,d.transformation):r;s.mat4.invert(w,c),s.mat4.transpose(w,w);var h=i.end;o.write({transformation:c,invTranspTransformation:w},d.data,o.vertexBufferLayout.createView(e.buffer.array.buffer),i.end/a);var g=o.elementCount(d.data)*a,p=h+g;f.assert(null==e.instances.get(d.uniqueName));var b=d.instanceParameters.visible,v=!!d.instanceParameters.highlights&&b,y=!!d.instanceParameters.occludees,C=new m.Instance(h/a,p/a,b,v,y);e.instances.set(d.uniqueName,C),e.optimalCount+=g,i.end+=g}},Object.defineProperty(e.prototype,"test",{get:function(){return{material:this._material,glMaterials:this._glMaterials}},enumerable:!0,configurable:!0}),e}();var C={begin:0,end:0},O=o.mat4f64.create(),_=o.mat4f64.create(),w=o.mat4f64.create();return y}));