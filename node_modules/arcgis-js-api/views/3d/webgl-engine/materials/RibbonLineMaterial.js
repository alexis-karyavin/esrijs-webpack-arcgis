// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../support/geometryUtils","../../support/buffer/InterleavedLayout","../lib/geometryDataUtils","../lib/GLMaterial","../lib/Material","../lib/Util","./VisualVariableMaterialParameters","./internal/MaterialUtil","./renderers/MergedRenderer","./renderers/utils","../shaders/RibbonLineTechnique","../shaders/RibbonLineTechnique"],(function(e,t,i,n,r,a,s,o,c,u,p,l,h,v,b,f,d,m,g,A,C,S){var R=n.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial"),y=function(e){function t(t,i){var n=e.call(this,i)||this;return n.techniqueConfig=new S.RibbonLineTechniqueConfiguration,n.params=m.copyParameters(t,P),n.validateParams(),n.params.transparent=n.params.color[3]<1||n.params.transparent,n.layout=n.createLayout(),n}return i.__extends(t,e),t.prototype.dispose=function(){},t.prototype.setParameterValues=function(e){for(var t in e)if("cap"!==t){if("join"===t)if("round"===this.params[t]!==("round"===e[t])){R.error("join cannot be changed after creation");continue}if("stipplePattern"===t)if(!!this.params[t]!==!!e[t]){R.error("stippledness cannot be changed after creation");continue}this.params[t]=e[t]}else R.error("cap cannot be changed after creation");this.validateParams(),this.parametersChanged()},t.prototype.getParameters=function(){return this.params},t.prototype.getPassParameters=function(){return this.params},t.prototype.getTechniqueConfig=function(e){this.techniqueConfig.output=e;var t=a.isSome(this.params.stipplePattern);return this.techniqueConfig.stippleEnabled=t,this.techniqueConfig.stippleIntegerRepeatsEnabled=t&&this.params.stippleIntegerRepeats,this.techniqueConfig.stippleOffColorEnabled=t&&a.isSome(this.params.stippleOffColor),this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig.roundJoins="round"===this.params.join,this.techniqueConfig.roundCaps="round"===this.params.cap,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.polygonOffset=this.params.polygonOffset,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.vvColor=this.params.vvColorEnabled,this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled,this.techniqueConfig.vvSize=this.params.vvSizeEnabled,this.techniqueConfig.innerColorEnabled=this.params.innerWidth>0&&a.isSome(this.params.innerColor),this.techniqueConfig.falloffEnabled=this.params.falloff>0,this.techniqueConfig.occluder=8===this.renderOccluded,this.techniqueConfig},t.prototype.intersect=function(e,t,i,n,r,a,s,o,c){c?this.intersectDrapedLineGeometry(e,n,a,s):this.intersectLineGeometry(e,t,i,n,this.params.width,s)},t.prototype.intersectDrapedLineGeometry=function(e,t,i,n){if(t.options.selectionMode){var a=e.getAttribute(S.RibbonVertexAttributeConstants.POSITION).data,s=e.getAttribute(S.RibbonVertexAttributeConstants.SIZE),o=this.params.width;if(this.params.vvSizeEnabled){var c=e.getAttribute(S.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE).data[0];o*=r.clamp(this.params.vvSizeOffset[0]+c*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0])}else s&&(o*=s.data[0]);for(var u=i[0],p=i[1],l=(o/2+4)*e.pixelRatio,h=Number.MAX_VALUE,v=0;v<a.length-5;v+=3){var b=a[v],f=a[v+1],d=u-b,m=p-f,g=a[v+3]-b,A=a[v+4]-f,C=g*d+A*m,R=g*g+A*A,y=r.clamp(C/R,0,1),x=g*y-d,P=A*y-m,E=x*x+P*P;E<h&&(h=E)}h<l*l&&n()}},t.prototype.intersectLineGeometry=function(e,t,i,n,a,s){if(n.options.selectionMode&&!A.isInstanceHidden(t))if(f.isTranslationMatrix(i)){var u=e.data.getVertexAttr(),l=u[S.RibbonVertexAttributeConstants.POSITION].data,h=a;if(this.params.vvSizeEnabled){var v=u[S.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE].data[0];h*=r.clamp(this.params.vvSizeOffset[0]+v*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0])}else u[S.RibbonVertexAttributeConstants.SIZE]&&(h*=u[S.RibbonVertexAttributeConstants.SIZE].data[0]);var b=n.camera,d=M;o.vec2.copy(d,n.point);var m=h*b.pixelRatio/2+4*b.pixelRatio;c.vec3.set(G[0],d[0]-m,d[1]+m,0),c.vec3.set(G[1],d[0]+m,d[1]+m,0),c.vec3.set(G[2],d[0]+m,d[1]-m,0),c.vec3.set(G[3],d[0]-m,d[1]-m,0);for(var g=0;g<4;g++)b.unprojectPoint(G[g],H[g]);p.plane.fromPoints(b.eye,H[0],H[1],J),p.plane.fromPoints(b.eye,H[1],H[2],X),p.plane.fromPoints(b.eye,H[2],H[3],k),p.plane.fromPoints(b.eye,H[3],H[0],W);var C=Number.MAX_VALUE,y=this.params.isClosed?l.length-2:l.length-5;for(g=0;g<y;g+=3){V[0]=l[g]+i[12],V[1]=l[g+1]+i[13],V[2]=l[g+2]+i[14];var x=(g+3)%l.length;if(q[0]=l[x]+i[12],q[1]=l[x+1]+i[13],q[2]=l[x+2]+i[14],!(p.plane.signedDistance(J,V)<0&&p.plane.signedDistance(J,q)<0||p.plane.signedDistance(X,V)<0&&p.plane.signedDistance(X,q)<0||p.plane.signedDistance(k,V)<0&&p.plane.signedDistance(k,q)<0||p.plane.signedDistance(W,V)<0&&p.plane.signedDistance(W,q)<0)){if(b.projectPoint(V,D),b.projectPoint(q,w),D[2]<0&&w[2]>0){c.vec3.subtract(L,V,q);var P=b.frustum,E=-p.plane.signedDistance(P.planes[4],V)/c.vec3.dot(L,p.plane.normal(P.planes[4]));c.vec3.scale(L,L,E),c.vec3.add(V,V,L),b.projectPoint(V,D)}else if(D[2]>0&&w[2]<0){c.vec3.subtract(L,q,V);P=b.frustum,E=-p.plane.signedDistance(P.planes[4],q)/c.vec3.dot(L,p.plane.normal(P.planes[4]));c.vec3.scale(L,L,E),c.vec3.add(q,q,L),b.projectPoint(q,w)}else if(D[2]<0&&w[2]<0)continue;D[2]=0,w[2]=0;var O=p.lineSegment.distance2(p.lineSegment.fromPoints(D,w,N),d);O<C&&(C=O,c.vec3.copy(z,V),c.vec3.copy(B,q))}}var I=n.rayBeginPoint,T=n.rayEndPoint;if(C<m*m){var j=Number.MAX_VALUE;if(p.lineSegment.closestLineSegmentPoint(p.lineSegment.fromPoints(z,B,N),p.lineSegment.fromPoints(I,T,F),U)){c.vec3.subtract(U,U,I);var _=c.vec3.length(U);c.vec3.scale(U,U,1/_),j=_/c.vec3.distance(I,T)}s(j,U)}}else R.error("intersection assumes a translation-only matrix")},t.prototype.computeAttachmentOrigin=function(e,t){var i=e.data,n="getVertexAttr"in i?i.getVertexAttr():"vertexAttr"in i?i.vertexAttr:null;if(!n)return null;var r=S.RibbonVertexAttributeConstants.POSITION,a="getVertexAttr"in i?i.getIndices(r):null,s=n[r];return h.computeAttachmentOriginLines(s,a,a&&this.params.isClosed,t)},t.prototype.createLayout=function(){var e=l.newLayout().vec3f(S.RibbonVertexAttributeConstants.POSITION).f32(S.RibbonVertexAttributeConstants.SUBDIVISIONFACTOR).vec2f(S.RibbonVertexAttributeConstants.UV0).vec3f(S.RibbonVertexAttributeConstants.AUXPOS1).vec3f(S.RibbonVertexAttributeConstants.AUXPOS2);return this.params.vvSizeEnabled?e.f32(S.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE):e.f32(S.RibbonVertexAttributeConstants.SIZE),this.params.vvColorEnabled?e.f32(S.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE):e.vec4f(S.RibbonVertexAttributeConstants.COLOR),this.params.vvOpacityEnabled&&e.f32(S.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE),e},t.prototype.createBufferWriter=function(){return new E(this.layout,this.params)},t.prototype.createRenderer=function(e,t){return new g(e,t,this,S.ribbonVertexAttributeLocations)},t.prototype.getGLMaterial=function(e){return 0===e.output||4===e.output?new x(e):void 0},t.prototype.validateParams=function(){"miter"!==this.params.join&&(this.params.miterLimit=0)},t}(b.Material),x=function(e){function t(t){var i=e.call(this,t)||this;return i.updateParameters(),i}return i.__extends(t,e),t.prototype.updateParameters=function(){this.technique=this.techniqueRep.acquireAndReleaseExisting(C.RibbonLineTechnique,this.material.getTechniqueConfig(this.output),this.technique)},t.prototype.beginSlot=function(e){return this.technique.configuration.occluder?3===e||10===e||11===e:0===this.output?(this.targetSlot=this.technique.configuration.writeDepth?5:8,e===this.targetSlot):3===e},t.prototype._updateOccludeeState=function(e){e.hasOccludees!==this.material.getParameters().sceneHasOcludees&&(this.material.setParameterValues({sceneHasOcludees:e.hasOccludees}),this.updateParameters())},t.prototype.ensureParameters=function(e){0===this.output&&this._updateOccludeeState(e)},t.prototype.bind=function(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.getPassParameters(),t)},t.prototype.getPipelineState=function(e,t){return t?this.technique.occludeePipeline:this.technique.configuration.occluder?11===e?this.technique.occluderPipelineTransparent:10===e?this.technique.occluderPipelineOpaque:this.technique.occluderPipelineMaskWrite:this.technique.pipeline},t}(v.GLMaterial),P=i.__assign({width:0,color:[1,1,1,1],join:"miter",cap:"butt",miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1,falloff:0,innerWidth:0,innerColor:null,sceneHasOcludees:!1},d.Default),E=function(){function e(e,t){if(this.params=t,this.numCapSubdivisions=0,this.numJoinSubdivisions=0,this.vertexBufferLayout=e,!t.isClosed)switch(this.params.cap){case"butt":this.numCapSubdivisions=0;break;case"square":this.numCapSubdivisions=1;break;case"round":this.numCapSubdivisions=I}switch(this.params.join){case"miter":case"bevel":this.numJoinSubdivisions=t.stipplePattern?1:0;break;case"round":this.numJoinSubdivisions=T}}return e.prototype.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},e.prototype.elementCount=function(e){var t=2*this.numCapSubdivisions+2,i=e.indices[S.RibbonVertexAttributeConstants.POSITION].length/2+1,n=this.params.isClosed,r=n?2:2*t,a=n?0:1,s=n?i:i-1;if(e.vertexAttr[S.RibbonVertexAttributeConstants.SUBDIVISIONS])for(var o=e.vertexAttr[S.RibbonVertexAttributeConstants.SUBDIVISIONS].data,c=a;c<s;++c){r+=4+2*o[c]}else r+=(s-a)*(2*this.numJoinSubdivisions+4);return r+=2},e.prototype.write=function(e,t,i,n){var r=this,a=j,s=_,o=Z,u=t.vertexAttr[S.RibbonVertexAttributeConstants.POSITION].data,p=t.indices&&t.indices[S.RibbonVertexAttributeConstants.POSITION];p&&p.length!==2*(u.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");var l=null;t.vertexAttr[S.RibbonVertexAttributeConstants.SUBDIVISIONS]&&(l=t.vertexAttr[S.RibbonVertexAttributeConstants.SUBDIVISIONS].data);var h=1,v=0;this.params.vvSizeEnabled?v=t.vertexAttr[S.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE].data[0]:t.vertexAttr[S.RibbonVertexAttributeConstants.SIZE]&&(h=t.vertexAttr[S.RibbonVertexAttributeConstants.SIZE].data[0]);var b=[1,1,1,1],f=0;this.params.vvColorEnabled?f=t.vertexAttr[S.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE].data[0]:t.vertexAttr[S.RibbonVertexAttributeConstants.COLOR]&&(b=t.vertexAttr[S.RibbonVertexAttributeConstants.COLOR].data);var d=0;this.params.vvOpacityEnabled&&(d=t.vertexAttr[S.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE].data[0]);var m=u.length/3,g=e.transformation,A=new Float32Array(i.buffer),C=this.vertexBufferLayout.stride/4,R=n*C,y=R,x=function(e,t,i,n,a,s){A[R++]=t[0],A[R++]=t[1],A[R++]=t[2],A[R++]=n,A[R++]=a,A[R++]=s,A[R++]=e[0],A[R++]=e[1],A[R++]=e[2],A[R++]=i[0],A[R++]=i[1],A[R++]=i[2],r.params.vvSizeEnabled?A[R++]=v:A[R++]=h,r.params.vvColorEnabled?A[R++]=f:(A[R++]=b[0],A[R++]=b[1],A[R++]=b[2],A[R++]=b[3]),r.params.vvOpacityEnabled&&(A[R++]=d)};R+=C,c.vec3.set(s,u[0],u[1],u[2]),g&&c.vec3.transformMat4(s,s,g);var P=this.params.isClosed;if(P){var E=u.length-3;c.vec3.set(a,u[E],u[E+1],u[E+2]),g&&c.vec3.transformMat4(a,a,g)}else{c.vec3.copy(a,s),c.vec3.set(o,u[3],u[4],u[5]),g&&c.vec3.transformMat4(o,o,g);for(var I=0;I<this.numCapSubdivisions;++I){x(a,s,o,U=1-I/this.numCapSubdivisions,1,-4),x(a,s,o,U,1,4)}x(a,s,o,0,0,-4),x(a,s,o,0,0,4),c.vec3.copy(a,s),c.vec3.copy(s,o)}var T=P?m:m-1;for(I=P?0:1;I<T;I++){var V=(I+1)%m*3;c.vec3.set(o,u[V+0],u[V+1],u[V+2]),g&&c.vec3.transformMat4(o,o,g),x(a,s,o,0,1,-1),x(a,s,o,0,1,1);for(var q=l?l[I]:this.numJoinSubdivisions,L=0;L<q;++L){x(a,s,o,U=(L+1)/(q+1),1,-2),x(a,s,o,U,1,2)}x(a,s,o,1,0,-2),x(a,s,o,1,0,2),c.vec3.copy(a,s),c.vec3.copy(s,o)}if(P){R=O(A,y+C,A,R,2*C)}else{x(a,s,o,0,1,-5),x(a,s,o,0,1,5);for(I=0;I<this.numCapSubdivisions;++I){var U;x(a,s,o,U=(I+1)/this.numCapSubdivisions,1,-5),x(a,s,o,U,1,5)}}O(A,y+C,A,y,C),R=O(A,R-C,A,R,C)},e}();function O(e,t,i,n,r){for(var a=0;a<r;a++)i[n++]=e[t++];return n}var I=3,T=1,V=u.vec3f64.create(),q=u.vec3f64.create(),L=u.vec3f64.create(),U=u.vec3f64.create(),M=u.vec3f64.create(),D=s.createRenderScreenPointArray3(),w=s.createRenderScreenPointArray3(),z=u.vec3f64.create(),B=u.vec3f64.create(),N=p.lineSegment.create(),F=p.lineSegment.create(),j=u.vec3f64.create(),_=u.vec3f64.create(),Z=u.vec3f64.create(),G=[s.createRenderScreenPointArray3(),s.createRenderScreenPointArray3(),s.createRenderScreenPointArray3(),s.createRenderScreenPointArray3()],H=[u.vec3f64.create(),u.vec3f64.create(),u.vec3f64.create(),u.vec3f64.create()],J=p.plane.create(),X=p.plane.create(),k=p.plane.create(),W=p.plane.create();return y}));