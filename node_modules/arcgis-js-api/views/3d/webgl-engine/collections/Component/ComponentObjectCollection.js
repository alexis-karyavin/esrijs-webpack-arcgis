// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/typedArrayUtil","../../../../../core/libs/gl-matrix-2/mat3","../../../../../core/libs/gl-matrix-2/mat3f32","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../core/libs/gl-matrix-2/vec4","../../../../../core/libs/gl-matrix-2/vec4f32","../../../../../geometry/support/aaBoundingBox","../../../layers/support/symbolColorUtils","../../../support/orientedBoundingBox","../../../support/buffer/BufferView","../../../support/buffer/glUtil","../../../support/buffer/InterleavedLayout","./interface","./RenderSubmitSystem","./SourceGeometry","./IndexRange/ComponentRangeRunLengthEncoded","./Material/ComponentMaterial","./Material/ComponentTechnique","../../core/util/BucketedObjectStore","../../core/util/TwoVectorPosition","../../lib/AutoDisposable","../../lib/ComponentUtils","../../lib/geometryDataUtils","../../lib/Util","../../lib/TextureBackedBuffer/BufferManager","../../materials/internal/MaterialUtil","../../../../webgl/BufferObject","../../../../webgl/VertexArrayObject"],(function(e,t,o,n,r,i,s,a,c,p,l,u,m,h,f,g,y,d,b,v,C,_,B,x,A,w,D,S,M,P,j,O,R,I){Object.defineProperty(t,"__esModule",{value:!0});var V=n.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection"),k=function(){function e(e){this._renderManager=e,this._objects=new A.BucketedObjectStore,this._renderSubmit=new v.RenderSubmitSystem(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new j.BufferManager(e.rctx)}return e.prototype.dispose=function(){P.assert(0===this.count,"ObjectCollection should be empty upon disposal")},e.prototype.createObject=function(e){var t=new H;return t.toMapSpace=e.toMapSpace.slice(),t.transform=e.transform,t.obb=f.clone(e.obb),t.components=new U(this._componentBufferManager,e.geometry.componentOffsets),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new G(e.geometry.positionData,t.components),this._objects.add(e.visible?J:0,t),t},e.prototype.destroyObject=function(e){var t=e;this._objects.remove(t),t.dispose(),this._notifyDirty()},e.prototype.setObjectVisibility=function(e,t){var o=e;if(t!==o.visible){var n=t?o.bucketKey|J:o.bucketKey&~J;this._objects.updateKey(o,n),this._notifyDirty()}},Object.defineProperty(e.prototype,"count",{get:function(){return this._objects.count},enumerable:!0,configurable:!0}),e.prototype.preSubmit=function(e){var t=e.camera.eye;this._objects.forEach((function(e,o){o&J&&e.forEach((function(e){var o=c.vec3.squaredDistance(t,e.obb.center);e.renderable.meta.cameraDepthSquared=o}))}))},e.prototype.updateMaterial=function(e,t){var o=e.renderable.material;t(o),o.dirty&&this._notifyDirty()},e.prototype.setAllComponentVisibilities=function(e,t){var o=e;o.components.visibility.reset(t),o.components.visibilityDirty(),this._notifyDirty()},e.prototype.forEachVisibleComponent=function(e,t){return e.components.visibility.forEachComponent(t)},e.prototype.getComponentCount=function(e){var t=e,o=t.components.visibility.componentCount();return{visible:o,invisible:t.components.count-o}},e.prototype.setComponentData=function(e,t){var o=e,n=o.renderable.material;if(b.isVaryingComponentParameters(t)){for(var r=o.components,i=r.materialDataBuffer,s=r.materialDataIndices,a={castShadows:!0,pickable:!0,externalColor:u.vec4f32.create(),externalColorMixMode:1},c=i.textureBuffer,p=new Uint8Array(4),l=new Uint32Array(p.buffer),m=0,f=0,g=0,y=!1,d=0,v=0;v<r.count;v++)t(v,a),m+=+(a.externalColor[3]<1),f+=+(3===a.externalColorMixMode&&1===a.externalColor[3]),g+=+a.castShadows,h.encodeSymbolColor(a.externalColor,a.externalColorMixMode,p),p[2]=254&p[2]|+a.castShadows,c.setData(s[v],0,p[0],p[1],p[2],p[3]),y=y||v>0&&d!==l[0],d=l[0],a.pickable!==S.getVisibility(r.pickability,v)&&(r.pickability=S.updateVisibilityWithCount(r.pickability,r.count,v,a.pickable));y?(n.componentParameters=new B.ComponentParametersVarying,n.componentParameters.castShadows=q(g,r.count),n.componentParameters.transparent=q(m,r.count),n.componentParameters.opaqueOverride=q(f,r.count),n.componentParameters.texture=c,c.updateTexture()):(n.componentParameters=new B.ComponentParametersUniform,n.componentParameters.castShadows=a.castShadows?0:2,n.componentParameters.externalColor=a.externalColor,n.componentParameters.externalColorMixMode=a.externalColorMixMode)}else n.componentParameters=new B.ComponentParametersUniform,n.componentParameters.castShadows=t.castShadows?0:2,n.componentParameters.externalColor=t.externalColor,n.componentParameters.externalColorMixMode=t.externalColorMixMode;this._notifyDirty()},e.prototype.getComponentAABB=function(e,t,o){return e.intersectionGeometry.getComponentAABB(t,o)},e.prototype.getObjectTransform=function(e){return e.transform},e.prototype.getComponentPositions=function(e,t,o){return e.intersectionGeometry.getComponentPositions(t,o)},e.prototype.intersect=function(e,t,o,n,i,a){var p=e;r.isSome(i)&&(i.localOrigin=p.transform.position);var l=s.mat3.invert(N,p.transform.rotationScale);c.vec3.sub(z,t,p.transform.position),c.vec3.sub(K,o,p.transform.position),c.vec3.transformMat3(z,z,l),c.vec3.transformMat3(K,K,l);var u=s.mat3.transpose(N,l);return p.intersectionGeometry.intersect(z,K,n,u,i,a)},e.prototype.addEdges=function(e,t,o,n){var r=e,i=r.intersectionGeometry,s=i.indices,a=i.positions,c=r.components.offsets;return t.addComponentObject(e,r.transform,r.obb.center,a,s,c,o,n)},e.prototype.addComponentHighlight=function(e,t){var o=e.components;r.isNone(o.highlightCounts)&&(o.highlightCounts=new Uint32Array(o.count+1)),0===o.highlightCounts[t]++&&(o.highlightsDirty(),this._notifyDirty()),o.highlightCounts[o.count]++},e.prototype.removeComponentHighlight=function(e,t){var o=e.components;if(r.isNone(o.highlightCounts))V.warn("Removing non-existing highlight.");else{var n=o.highlightCounts[t],i=o.highlightCounts[o.count];if(0!==n){if(n>1)return o.highlightCounts[t]=n-1,void(o.highlightCounts[o.count]=i-1);o.highlightCounts[t]=0,o.highlightsDirty(),this._notifyDirty(),1===i?o.highlightCounts=null:o.highlightCounts[o.count]=i-1}else V.warn("Removing non-existing highlight.")}},e.prototype.clearHighlights=function(e){var t=e.components;r.isSome(t.highlightCounts)&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())},e.prototype.getObjectMemoryUsageGPU=function(e){return e.renderable.meta.gpuMemoryEstimate},Object.defineProperty(e.prototype,"visibleObjects",{get:function(){return this._objects.getBucket(J)},enumerable:!0,configurable:!0}),e.prototype._createRenderable=function(e,t){for(var o=this._renderManager.rctx,n=e.geometry,i=n.vertices.layoutParameters,p=R.createVertex(o,35044,n.vertices.data),u=r.applySome(n.indices,(function(e){return R.createIndex(o,35044,e)})),m=y.glLayout(C.createVertexBufferLayout(i)),h=new Uint16Array(n.vertices.count),f=0;f<t.count;f++){var g=t.offsets[f],d=t.offsets[f+1],b=t.materialDataIndices[f];if(r.isSome(n.indices))for(var v=g;v<d;v++){h[n.indices[v]]=b}else for(v=g;v<d;v++)h[v]=b}var _=R.createVertex(o,35044,h.buffer),A=new w.TwoVectorPosition(e.transform.position),D=a.mat3f32.clone(e.transform.rotationScale);s.mat3.invert(D,D),s.mat3.transpose(D,D);var S=new x.ComponentDrawParameters;c.vec3.copy(S.worldFromModel_TL,A.low),c.vec3.copy(S.worldFromModel_TH,A.high),s.mat3.copy(S.worldFromModel_RS,e.transform.rotationScale),s.mat3.copy(S.transformNormal_GlobalFromModel,D),l.vec4.copy(S.toMapSpace,e.toMapSpace);var M=new B.ComponentMaterial,P=new I(o,M.attributeLocations,{data:m,componentIndices:L},{data:p,componentIndices:_},r.unwrap(u)),j=new T;return j.material=M,j.drawParameters=S,j.geometry=new E(P,n.primitiveType,i,r.isSome(u)),j.meta.cameraDepthSquared=.5,j.meta.gpuMemoryEstimate=p.byteSize+_.byteSize+(r.isSome(u)?u.byteSize:0),j},e.prototype._notifyDirty=function(){this._renderManager.notifyDirty()},e}();t.ComponentObjectCollection=k;var U=function(e){function t(t,o){var n=e.call(this)||this;n.pickability=null,n.highlightCounts=null,n.cachedGeometryRanges=null,n.cachedHighlightRanges=null,n.offsets=i.slice(o);var r=n.count;n.visibility=new _.ComponentRangeRunLengthEncoded(r),n.materialDataBuffer=t.getBuffer(r),n.materialDataIndices=new Uint16Array(r);for(var s=0;s<r;s++)n.materialDataIndices[s]=n.materialDataBuffer.acquireIndex();return n}return o.__extends(t,e),t.prototype.dispose=function(){e.prototype.dispose.call(this);for(var t=0;t<this.count;t++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[t])},Object.defineProperty(t.prototype,"count",{get:function(){return this.offsets.length-1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"geometryRanges",{get:function(){return r.isNone(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"highlightRanges",{get:function(){return r.isNone(this.highlightCounts)?null:(r.isNone(this.cachedHighlightRanges)&&(this.cachedHighlightRanges=function(e,t,o){var n=[],r=o.length;t.forEachComponent((function(t){return e[t]>0&&(r!==t-1&&(n.length&&n.push(o[r+1]-n[n.length-1]),n.push(o[t])),r=t),!0})),n.length&&n.push(o[r+1]-n[n.length-1]);return n}(this.highlightCounts,this.visibility,this.offsets)),this.cachedHighlightRanges)},enumerable:!0,configurable:!0}),t.prototype.highlightsDirty=function(){this.cachedHighlightRanges=null},t.prototype.visibilityDirty=function(){this.cachedGeometryRanges=null,this.cachedHighlightRanges=null},t}(D.AutoDisposable);var G=function(){function e(e,t){this._indices=r.isSome(e.indices)?e.indices:M.generateDefaultIndexArray(e.positions.length/3),this._positions=new g.BufferViewVec3f(e.positions),this._components=t}return e.prototype.getComponentAABB=function(e,t){if(r.isSome(this._perComponentAABBs)){for(var o=0;o<6;o++)t[o]=this._perComponentAABBs[6*e+o];return t}return this._computePerComponentAABBs(),this.getComponentAABB(e,t)},e.prototype.getComponentPositions=function(e,t){t.indices=this._indices,t.data=this._positions.typedBuffer,t.stride=this._positions.typedBufferStride,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]},e.prototype.intersect=function(e,t,o,n,i,s){var a=this,p={data:this._positions.typedBuffer,strideIdx:this._positions.typedBufferStride,offsetIdx:0,size:3},l=this._indices,u=this._components.offsets,m=O.computeInvDir(e,t,F);this._components.visibility.forEachComponent((function(h){if(!S.getVisibility(a._components.pickability,h))return!0;var f=a.getComponentAABB(h,W);if(r.isSome(i)&&i.applyToAABB(f),!O.intersectAabbInvDir(f,e,m,o))return!0;var g=u[h]/3,y=u[h+1]/3;return O.intersectTriangles(e,t,g,y,l,p,void 0,i,(function(e,t,o){return s(h,e,c.vec3.transformMat3(t,t,n),o)})),!0}))},e.prototype._computePerComponentAABBs=function(){var e=this._components.count;this._perComponentAABBs=new Float32Array(6*e);for(var t=0;t<e;t++)this._computeAABB(t)},e.prototype._computeAABB=function(e){for(var t=this._indices,o=this._positions,n=this._components.offsets,r=n[e],i=n[e+1],s=[0,0,0],a=[1/0,1/0,1/0],p=[-1/0,-1/0,-1/0],l=r;l<i;l++){var u=t[l];o.getVec(u,s),c.vec3.min(a,a,s),c.vec3.max(p,p,s)}var m=6*e;this._perComponentAABBs[m++]=a[0],this._perComponentAABBs[m++]=a[1],this._perComponentAABBs[m++]=a[2],this._perComponentAABBs[m++]=p[0],this._perComponentAABBs[m++]=p[1],this._perComponentAABBs[m]=p[2]},Object.defineProperty(e.prototype,"positions",{get:function(){return this._positions},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"indices",{get:function(){return this._indices},enumerable:!0,configurable:!0}),e}(),E=function(e){function t(t,o,n,r){var i=e.call(this)||this;return i.vao=t,i.primitiveType=o,i.parameters=n,i.indexed=r,i}return o.__extends(t,e),o.__decorate([D.autoDispose()],t.prototype,"vao",void 0),t}(D.AutoDisposable);t.RenderGeometry=E;var T=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.meta={cameraDepthSquared:0,gpuMemoryEstimate:0},t}return o.__extends(t,e),o.__decorate([D.autoDispose()],t.prototype,"geometry",void 0),t}(D.AutoDisposable);t.Renderable=T;var L=y.glLayout(d.newLayout().u16("componentIndex")),H=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o.__extends(t,e),Object.defineProperty(t.prototype,"visible",{get:function(){return!!(this.bucketKey&J)},enumerable:!0,configurable:!0}),o.__decorate([D.autoDispose()],t.prototype,"renderable",void 0),o.__decorate([D.autoDispose()],t.prototype,"components",void 0),t}(A.BucketStorable);function q(e,t){return e===t?0:0===e?2:1}t.ComponentObject=H;var N=a.mat3f32.create(),F=p.vec3f64.create(),z=p.vec3f64.create(),K=p.vec3f64.create(),W=m.create(),J=1}));