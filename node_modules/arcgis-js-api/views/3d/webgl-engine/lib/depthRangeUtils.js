// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../../../core/PooledArray","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../core/libs/gl-matrix-2/vec4f64","../../support/geometryUtils","../../support/mathUtils","./depthRange","./Util"],(function(e,t,r,a,i,n,s,o,f,h,c,u,g){Object.defineProperty(t,"__esModule",{value:!0});function l(e,t){if(t.isVisible){var r=u.empty(),a=t.getObjects();return t.getSpatialQueryAccelerator()?function(e,t,r){var a=t.eye,i=t.viewForward,n=t.frustum,s=function(e){return e.isVisible},o=r.objectCount;if(o<500)u.set(B,t.near,Math.min(e.near,t.far)),r.forEachInDepthRange(a,i,"front-to-back",B,(function(r,a){d(e,t,r),B.far=e.near,a.setRange(B)}),n,s),u.set(B,Math.max(e.far,t.near),t.far),r.forEachInDepthRange(a,i,"back-to-front",B,(function(r,a){d(e,t,r),B.near=e.far,a.setRange(B)}),n,s);else{var f=Math.max(Math.min(o,500),Math.ceil(.1*o)),h=r.findClosest(i,"front-to-back",n,s,f),c=r.findClosest(i,"back-to-front",n,s,f);h&&c&&(v(e,t,h.getCenter(),h.getBSRadius()),v(e,t,c.getCenter(),c.getBSRadius()))}}(r,e,t.getSpatialQueryAccelerator()):function(e,t,r){if(C.clear(),r.forEach((function(e){e.isVisible&&C.add(e)})),C.empty)return;C.sort(t),u.set(B,t.near,Math.min(e.near,t.far)),C.forEachInDepthRange(B,"front-to-back",(function(r,a){a<e.near&&d(e,t,r)})),u.set(B,Math.max(e.far,t.near),t.far),C.forEachInDepthRange(B,"back-to-front",(function(t,r,a){e.far=Math.max(e.far,a)}))}(r,e,a),r}}function d(e,t,r){if(r.isVisible&&h.frustum.intersectsSphere(t.frustum.planes,h.sphere.wrap(r.getBSRadius(),r.getCenter()))){var i=r.objectTransformation,s=R;r.geometryRecords.forEach((function(r){a.mat4.multiply(s,i,r.getShaderTransformation());var o=c.maxScale(s);!function e(t,r,a,i,s){var o=r.eye,f=r.viewForward;n.vec3.transformMat4(w,a.center,i);var c=f[0]*(w[0]-o[0])+f[1]*(w[1]-o[1])+f[2]*(w[2]-o[2]),u=a.bsRadius*s;if(c-u>t.near&&c+u<t.far)return;if(!h.frustum.intersectsSphere(r.frustum.planes,h.sphere.wrap(u,w)))return;if(a.bsRadius>100&&a.getChildren())for(var g=a.getChildren(),l=0;l<8;++l)g[l]&&e(t,r,g[l],i,s);else x.unionDepthRangeWithAABB(t,r.viewProjectionMatrix,i,a.bbMin,a.bbMax)}(e,t,r.geometry.boundingInfo,s,o)}))}}function v(e,t,r,a){var i=t.eye,n=t.viewForward,s=(r[0]-i[0])*n[0]+(r[1]-i[1])*n[1]+(r[2]-i[2])*n[2];e.near=Math.min(e.near,s-a),e.far=Math.max(e.far,s+a)}t.depthRangeFromScene=function(e,t,r){if(t.size<1e4)return M.compute(e,t);var a=u.empty();return r.forEach((function(t){t.isVisible&&u.union(a,l(e,t))})),a},t.depthRangeFromLayer=l;var m=function(){function e(){this._items=new r({allocator:function(e){return e||{obj:null,distance:0,near:0,far:0}},deallocator:function(e){return e.obj=null,e.distance=0,e.near=0,e.far=0,e}})}return Object.defineProperty(e.prototype,"length",{get:function(){return this._items.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"empty",{get:function(){return 0===this._items.length},enumerable:!0,configurable:!0}),e.prototype.clear=function(){this._items.clear()},e.prototype.add=function(e){this._items.pushNew().obj=e},e.prototype.sort=function(e){var t=e.eye,r=e.viewForward;this._items.forEach((function(e){var a=e.obj,i=a.getCenter(),n=a.getBSRadius(),s=(i[0]-t[0])*r[0]+(i[1]-t[1])*r[1]+(i[2]-t[2])*r[2];e.distance=s,e.near=s-n,e.far=s+n})),this._items.sort((function(e,t){return e.distance-t.distance}))},e.prototype.forEachInDepthRange=function(e,t,r){if("front-to-back"===t)for(var a=0;a<this._items.length;++a){(i=this._items.data[a]).far<e.near||i.near>e.far||r(i.obj,i.near,i.far)}else for(a=this._items.length-1;a>=0;--a){var i;(i=this._items.data[a]).far<e.near||i.near>e.far||r(i.obj,i.near,i.far)}},e}(),p=function(){function e(){this.view=i.mat4f64.create(),this.viewProj=i.mat4f64.create(),this.frustum=h.frustum.create(),this.geometries=[],this.near=[],this.far=[],this.nearCandidates=[],this.farCandidates=[],this.range={near:0,far:0},this.looseRange={near:0,far:0}}return e.prototype.compute=function(e,t){var r=this;this.reset(),a.mat4.copy(this.view,e.viewMatrix),a.mat4.multiply(this.viewProj,e.projectionMatrix,this.view),h.frustum.copy(e.frustum,this.frustum);var i=this.view,n=i[2],s=i[6],o=i[10],f=i[14],c=this.range,u=0;if(t.forEach((function(e){if(e.instanceParameters.visible&&e.castShadow){var t,a;e.hasShaderTransformation?(t=e.getBoundingSphere(e.getShaderTransformation(),1,w),a=w):(t=e.bsRadius,a=e.center);var i=n*a[0]+s*a[1]+o*a[2]+f,h=i-t,c=i+t;r.geometries[u]=e,r.near[u]=-c,r.far[u]=-h,++u}})),0===this.geometries.length)return c;for(var g=0;g<this.geometries.length;++g)this.near[g]>c.far&&(c.far=this.near[g]),this.near[g]>2&&this.far[g]<c.near&&(c.near=this.far[g]);var l=this.looseRange;l.near=Math.max(.5*c.near,2),l.far=2*c.far;var d=0,v=0;for(g=0;g<this.geometries.length;++g)this.near[g]<c.near&&(this.near[g]>=l.near?c.near=this.near[g]:this.nearCandidates[d++]=g),this.far[g]>c.far&&(this.far[g]<=l.far?c.far=this.far[g]:this.farCandidates[v++]=g);if(0===this.nearCandidates.length&&0===this.farCandidates.length)return c;this.nearCandidates.sort((function(e,t){return r.near[e]<r.near[t]?-1:r.near[e]>r.near[t]?1:0})),this.farCandidates.sort((function(e,t){return r.far[e]<r.far[t]?1:r.far[e]>r.far[t]?-1:0}));for(g=0;g<this.nearCandidates.length;++g){var m=this.nearCandidates[g];if(this.near[m]<c.near){var p=(b=this.geometries[m]).boundingInfo;this.includeNearBoundingInfoRec(p,b.getShaderTransformation())}}for(g=0;g<this.farCandidates.length;++g){m=this.farCandidates[g];if(this.far[m]>c.far){var b;p=(b=this.geometries[m]).boundingInfo;this.includeFarBoundingInfoRec(p,b.getShaderTransformation())}}return c},e.prototype.reset=function(){this.geometries.length=0,this.near.length=0,this.far.length=0,this.nearCandidates.length=0,this.farCandidates.length=0,this.range.near=Number.MAX_VALUE,this.range.far=-Number.MAX_VALUE},e.prototype.includeNearBoundingInfoRec=function(e,t){var r=e.getBSRadius(),a=e.getCenter();n.vec3.transformMat4(w,a,t);var i=c.maxScale(t),s=w[0],o=w[1],f=w[2];r*=i;var h=this.frustum.planes;if(!(h[0][0]*s+h[0][1]*o+h[0][2]*f+h[0][3]>r||h[1][0]*s+h[1][1]*o+h[1][2]*f+h[1][3]>r||h[2][0]*s+h[2][1]*o+h[2][2]*f+h[2][3]>r||h[3][0]*s+h[3][1]*o+h[3][2]*f+h[3][3]>r)){var u=this.view[2]*s+this.view[6]*o+this.view[10]*f+this.view[14],g=u+r;if(!(-(u-r)<2||-g>=this.range.near))if(-g>this.looseRange.near)this.range.near=-g;else{if(r>100){var l=e.getChildren();if(void 0!==l){for(var d=0;d<8;++d)void 0!==l[d]&&this.includeNearBoundingInfoRec(l[d],t);return}}x.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax())}}},e.prototype.includeFarBoundingInfoRec=function(e,t){var r=e.getBSRadius(),a=e.getCenter();n.vec3.transformMat4(w,a,t);var i=c.maxScale(t),s=w[0],o=w[1],f=w[2];r*=i;var h=this.frustum.planes;if(!(h[0][0]*s+h[0][1]*o+h[0][2]*f+h[0][3]>r||h[1][0]*s+h[1][1]*o+h[1][2]*f+h[1][3]>r||h[2][0]*s+h[2][1]*o+h[2][2]*f+h[2][3]>r||h[3][0]*s+h[3][1]*o+h[3][2]*f+h[3][3]>r)){var u=this.view[2]*s+this.view[6]*o+this.view[10]*f+this.view[14]-r;if(!(-u<=this.range.far))if(-u<this.looseRange.far)this.range.far=-u;else{if(r>100){var g=e.getChildren();if(void 0!==g){for(var l=0;l<8;++l)void 0!==g[l]&&this.includeFarBoundingInfoRec(g[l],t);return}}x.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax())}}},e}();t.DepthRangeFromRenderGeometries=p;var b=function(){function e(){this.modelViewProj=i.mat4f64.create(),this.clipPosition=[f.vec4f64.create(),f.vec4f64.create(),f.vec4f64.create(),f.vec4f64.create(),f.vec4f64.create(),f.vec4f64.create(),f.vec4f64.create(),f.vec4f64.create()]}return e.prototype.unionDepthRangeWithAABB=function(e,t,r,i,n){var s=this.modelViewProj;a.mat4.multiply(s,t,r);for(var o=!1,f=0;f<8;++f){var h=this.clipPosition[f],c=0===f||3===f||4===f||7===f?i[0]:n[0],u=0===f||1===f||4===f||5===f?i[1]:n[1],g=f<4?i[2]:n[2];h[0]=s[0]*c+s[4]*u+s[8]*g+s[12],h[1]=s[1]*c+s[5]*u+s[9]*g+s[13],h[2]=s[2]*c+s[6]*u+s[10]*g+s[14],h[3]=s[3]*c+s[7]*u+s[11]*g+s[15]}for(f=0;f<12;++f){for(var l=this.clipPosition[y[f][0]],d=this.clipPosition[y[f][1]],v=this.clipPosition[y[f][2]],m=this.clipTriangle(l,d,v),p=!0,b=0;b<m.length;++b){if((w=m[b][3])>=2){p=!1;break}}if(!p){o=!0;for(b=0;b<m.length;++b){var w;(w=m[b][3])<e.near&&(e.near=w),w>e.far&&(e.far=w)}}}return o},e.prototype.inside=function(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void g.assert(!1)},e.prototype.intersect=function(e,t,r){var a=0;return 0===r?a=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===r?a=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===r?a=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===r&&(a=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),o.vec4.lerp(f.vec4f64.create(),e,t,a)},e.prototype.clipTriangle=function(e,t,r){for(var a=[e,t,r],i=0;i<4;++i){var n=a;a=[];for(var s=0;s<n.length;++s){var o=n[s],f=n[(s+1)%n.length];this.inside(f,i)?(this.inside(o,i)||a.push(this.intersect(o,f,i)),a.push(f)):this.inside(o,i)&&a.push(this.intersect(o,f,i))}}return a},e}(),y=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],w=s.vec3f64.create(),R=i.mat4f64.create(),B=u.empty(),C=new m,M=new p,x=new b}));