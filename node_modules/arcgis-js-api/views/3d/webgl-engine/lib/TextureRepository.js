// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../../../core/Evented","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/scheduling","./TextureTechnique","./Util","../../../webgl/Texture"],(function(e,t,r,n,a,i,u,o,s,l){Object.defineProperty(t,"__esModule",{value:!0});var f=n.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository"),h=function(){function e(e,t,n){this._textures=e,this.rctx=n,this._idToRefCountedTexture=new Map,this._textureTechniqueConfig=new o.TextureTechniqueConfiguration,this._loadingCount=0,this._frameUpdates=new Map,this._fallbackTextureData=new Uint8Array(256),this._fallbackTextureTransparentData=new Uint8Array(256),this._texturesToUnload=new Array,this.events=new r,this._textureTechnique=t.acquireAndReleaseExisting(o.TextureTechnique,this._textureTechniqueConfig,this._textureTechnique);for(var a=0;a<this._fallbackTextureData.length;++a)this._fallbackTextureData[a]=255,this._fallbackTextureTransparentData[a]=(a+1)%4!=0?255:0;this._fallbackTextureDesc={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:8,height:8,maxAnisotropy:this.rctx.parameters.maxMaxAnisotropy}}return e.prototype.dispose=function(){a.isSome(this._unloadDeferredHandle)&&(this._unloadDeferredHandle.remove(),this._unloadDeferredHandle=null,this._unloadDeferred()),a.isSome(this._fallbackTexture)&&(this._fallbackTexture.dispose(),this._fallbackTexture=null),a.isSome(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent.dispose(),this._fallbackTextureTransparent=null),this._textures.forEach((function(e){return e.unload()}))},e.prototype.acquire=function(e,t,r){var n=this._getOrCreateRef(e,t,r);return n.ref(),n},e.prototype.update=function(){var e=this,t=!1;this._frameUpdates.forEach((function(r){var n=r.texture.frameUpdate(e.rctx,e._textureTechnique,r.previousToken);n>=0&&n!==r.previousToken&&(r.previousToken=n,t=!0)})),t&&this.events.emit("changed",{requestType:0})},e.prototype._getOrCreateRef=function(e,t,r){var n=this._idToRefCountedTexture.get(e);return n||this._createNewRef(e,t,r)},e.prototype._createNewRef=function(e,t,r){var n=this,a=this._textures.get(e);s.assert(void 0!==a);var u=a.events.on("unloaded",(function(){u.remove(),n._onTextureUnloaded(e)})),o=!0===t,l=new c;this._idToRefCountedTexture.set(e,l);var h=a.load(this.rctx,this._textureTechnique);this._loadingCount++;var d=function(t){return n._loadingCount--,n._updateGLTexture(l,t),r&&r(l),a.requiresFrameUpdates&&n._frameUpdates.set(e,{texture:a,previousToken:-1}),l};return i.isThenable(h)?(this._updateGLTexture(l,o?this.fallbackTextureTransparent:this.fallbackTexture),h.then(d,(function(e){n._loadingCount--,i.isAbortError(e)||f.error(e)}))):d(h),l},e.prototype._updateGLTexture=function(e,t){e.glTexture=t,this.events.emit("changed",{requestType:1})},e.prototype.release=function(e){var t=this,r=this._idToRefCountedTexture.get(e);r&&(r.unref(),r.isUnreferenced&&(this._texturesToUnload.push(e),a.isNone(this._unloadDeferredHandle)&&(this._unloadDeferredHandle=u.schedule((function(){return t._unloadDeferred()})))))},e.prototype._unloadDeferred=function(){for(var e=0,t=this._texturesToUnload;e<t.length;e++){var r=t[e],n=this._textures.get(r),a=this._idToRefCountedTexture.get(r);n&&a&&a.isUnreferenced&&n.unload()}this._texturesToUnload.length=0,this._unloadDeferredHandle=null},e.prototype.getTexture=function(e){return this._textures.get(e)},Object.defineProperty(e.prototype,"loadingCount",{get:function(){return this._loadingCount},enumerable:!0,configurable:!0}),e.prototype._onTextureUnloaded=function(e){this._idToRefCountedTexture.delete(e),this._frameUpdates.delete(e)},Object.defineProperty(e.prototype,"fallbackTexture",{get:function(){return a.isNone(this._fallbackTexture)&&(this._fallbackTexture=new l(this.rctx,this._fallbackTextureDesc,this._fallbackTextureData)),this._fallbackTexture},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fallbackTextureTransparent",{get:function(){return a.isNone(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent=new l(this.rctx,this._fallbackTextureDesc,this._fallbackTextureTransparentData)),this._fallbackTextureTransparent},enumerable:!0,configurable:!0}),e}();t.TextureRepository=h;var c=function(){function e(){this._refCount=0,this.glTexture=null}return Object.defineProperty(e.prototype,"isUnreferenced",{get:function(){return 0===this._refCount},enumerable:!0,configurable:!0}),e.prototype.ref=function(){++this._refCount},e.prototype.unref=function(){0!==this._refCount?--this._refCount:f.error("Cannot dereference texture that has no references!")},e}();t.RefCountedTexture=c}));