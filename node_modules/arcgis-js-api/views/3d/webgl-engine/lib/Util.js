// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../core/libs/gl-matrix-2/vec4f64"],(function(t,r,n,a,e,o,i,c,f){Object.defineProperty(r,"__esModule",{value:!0});var u=f.vec4f64.create(),s=function(){function t(t){this.message=t}return t.prototype.toString=function(){return"AssertException: "+this.message},t}();function v(t,r){if(!t){r=r||"assert";var n=new Error(r);throw n.stack&&console.log(n.stack),new s(r)}}function l(t){for(var r in t)return r}function h(t,r){t[12]=r[0],t[13]=r[1],t[14]=r[2]}function M(t,r){void 0===r&&(r=0);for(var n=0,a=0;a<4;a++)n+=t[r+a]*d[a];return n}r.AssertException=s,r.VertexAttrConstants={POSITION:"position",NORMAL:"normal",UV0:"uv0",AUXPOS1:"auxpos1",AUXPOS2:"auxpos2",COLOR:"color",SYMBOLCOLOR:"symbolColor",SIZE:"size",TANGENT:"tangent"},r.assert=v,r.verify=function(t,r){t||(r=r||"",console.warn("Verify failed: "+r+"\n"+new Error("verify").stack))},r.encodeInt16=function(t){return n.clamp(Math.round(32767*t),-32767,32767)},r.encodeNormal=function(t,r){var n=Math.abs(t[0]),a=Math.abs(t[1]),e=1/(n+a+Math.abs(t[2])),o=n*e,i=a*e,c=Math.min(t[2]*e,0);r[0]=(t[0]<0?-1:1)*(o-c),r[1]=(t[1]<0?-1:1)*(i-c)},r.fallbackIfUndefined=function(t,r){return void 0===t?r:t},r.hex2rgb=function(t){return[((t=Math.floor(t))>>16&255)/255,(t>>8&255)/255,(255&t)/255]},r.rgb2hex=function(t){return"0x"+((n.clamp(Math.round(255*t[0]),0,255)<<16)+(n.clamp(Math.round(255*t[1]),0,255)<<8)+n.clamp(Math.round(255*t[2]),0,255)).toString(16)},r.dec2hex=function(t){var r=t.toString(16);return"00000000".substr(0,8-r.length)+r},r.rayTriangle3D=function(t,r,n,a,e,o,c,f,u){void 0===u&&(u=i.vec3f64.create());var s=a[c]-n[o],v=a[c+1]-n[o+1],l=a[c+2]-n[o+2],h=e[f]-n[o],M=e[f+1]-n[o+1],x=e[f+2]-n[o+2],d=r[1]*x-M*r[2],g=r[2]*h-x*r[0],m=r[0]*M-h*r[1],p=s*d+v*g+l*m;if(p>-1e-5&&p<1e-5)return!1;var b=1/p,y=t[0]-n[o],O=t[1]-n[o+1],A=t[2]-n[o+2];if(u[1]=b*(y*d+O*g+A*m),u[1]<0||u[1]>1)return!1;var T=O*l-v*A,S=A*s-l*y,E=y*v-s*O;return u[2]=b*(r[0]*T+r[1]*S+r[2]*E),!(u[2]<0||u[1]+u[2]>1)&&(u[0]=b*(h*T+M*S+x*E),!0)},r.rayBoxTest=function(t,r,n,a){var e,o=(n[0]-t[0])/r[0],i=(a[0]-t[0])/r[0];o>i&&(e=o,o=i,i=e);var c=(n[1]-t[1])/r[1],f=(a[1]-t[1])/r[1];if(c>f&&(e=c,c=f,f=e),o>f||c>i)return!1;c>o&&(o=c),f<i&&(i=f);var u=(n[2]-t[2])/r[2],s=(a[2]-t[2])/r[2];return u>s&&(e=u,u=s,s=e),!(o>s||u>i)&&(s<i&&(i=s),!(i<0))},r.rayRay2D=function(t,r,n,a,e,i){void 0===i&&(i=o.vec2f64.create());var c=(a[e]-n[e])*(r[0]-t[0])-(a[0]-n[0])*(r[e]-t[e]),f=(a[0]-n[0])*(t[e]-n[e])-(a[e]-n[e])*(t[0]-n[0]);if(0===c)return!1;var u=f/c;return i[0]=t[0]+u*(r[0]-t[0]),i[1]=t[e]+u*(r[e]-t[e]),!0},r.project=function(t,r,n,a,e){e||(e=t),u[0]=t[0],u[1]=t[1],u[2]=t[2],u[3]=1,c.vec4.transformMat4(u,u,r),e.length>2&&(e[2]=-u[2]),c.vec4.transformMat4(u,u,n),v(0!==u[3]),e[0]=u[0]/u[3],e[1]=u[1]/u[3],e[2]=u[2]/u[3],e[0]=(.5*e[0]+.5)*a[2]+a[0],e[1]=(.5*e[1]+.5)*a[3]+a[1]},r.getFirstObjectKey=l,r.getFirstObjectValue=function(t){return t[l(t)]},r.objectEmpty=function(t){for(var r in t)return!1;return!0},r.logWithBase=function(t,r){return Math.log(t)/Math.log(r)},r.setMatrixTranslation=h,r.setMatrixTranslation3=function(t,r,n,a){t[12]=r,t[13]=n,t[14]=a},r.getMatrixTranslation=function(t,r){return void 0===r&&(r=i.vec3f64.create()),r[0]=t[12],r[1]=t[13],r[2]=t[14],r},r.createTranslationMatrix=function(t,r){return h(t=a.mat4.identity(t),r),t},r.isTranslationMatrix=function(t){return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&1===t[5]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&1===t[10]&&0===t[11]&&1===t[15]},r.fovx2fovy=function(t,r,n){return 2*Math.atan(n*Math.tan(.5*t)/r)},r.fovy2fovx=function(t,r,n){return 2*Math.atan(r*Math.tan(.5*t)/n)},r.fovx2fovd=function(t,r,n){return 2*Math.atan(Math.sqrt(r*r+n*n)*Math.tan(.5*t)/r)},r.fovy2fovd=function(t,r,n){return 2*Math.atan(Math.sqrt(r*r+n*n)*Math.tan(.5*t)/n)},r.fovd2fovx=function(t,r,n){return 2*Math.atan(r*Math.tan(.5*t)/Math.sqrt(r*r+n*n))},r.fovd2fovy=function(t,r,n){return 2*Math.atan(n*Math.tan(.5*t)/Math.sqrt(r*r+n*n))},r.packFloatRGBA=function(t,r,a){void 0===a&&(a=0);for(var e,o=n.clamp(t,0,g),i=0;i<4;i++)r[a+i]=Math.floor(256*((e=o*x[i])-Math.floor(e)))},r.unpackFloatRGBA=M;var x=[1,256,65536,16777216],d=[1/256,1/65536,1/16777216,1/4294967296],g=M(new Uint8ClampedArray([255,255,255,255]));r.inverseProjectionInfo=function(t,r,n,a,o){var i=t;0===t[11]?(a[0]=2/(r*i[0]),a[1]=2/(n*i[5]),a[2]=(1+i[12])/i[0],a[3]=(1+i[13])/i[5],e.vec2.set(o,0,1)):(a[0]=-2/(r*i[0]),a[1]=-2/(n*i[5]),a[2]=(1-i[8])/i[0],a[3]=(1-i[9])/i[5],e.vec2.set(o,1,0))}}));