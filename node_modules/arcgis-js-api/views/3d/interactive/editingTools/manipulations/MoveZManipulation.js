// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../core/colorUtils","../../../../../core/Evented","../../../../../core/Handles","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f64","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../Manipulator3D","../../manipulatorUtils","../dragEventPipeline3D","../settings","./config","./Manipulation","./moveUtils","../../../webgl-engine/lib/Geometry","../../../webgl-engine/lib/GeometryUtil","../../../../interactive/dragEventPipeline"],(function(e,t,a,r,i,o,n,l,s,c,u,p,m,d,v,f,M,g,h,y,_,b){Object.defineProperty(t,"__esModule",{value:!0});var w=function(e){function t(t){var a=e.call(this)||this;return a._handles=new o,a._radius=M.DISC_RADIUS,a.events=new i,a._tool=t.tool,a._view=t.view,null!=t.radius&&(a._radius=t.radius),a.createManipulator(),a.forEachManipulator((function(e){return a._tool.manipulators.add(e)})),a}return a.__extends(t,e),t.prototype.destroy=function(){var e=this;this._handles.destroy(),this.forEachManipulator((function(t){e._tool.manipulators.remove(t),t.destroy()}))},t.prototype.forEachManipulator=function(e){e(this._manipulator,0)},t.prototype.createGraphicDragPipeline=function(e,t){var a=this,r=l.unwrap(e.graphic.geometry).spatialReference;return h.createGraphicMoveDragPipeline(e,t,(function(e){return a.createDragPipeline(e,r)}))},t.prototype.createDragPipeline=function(e,t){var a=this._view;return b.createManipulatorDragEventPipeline(this._manipulator,(function(r,i,o,n){var l=i.next(v.screenToZConstrained(a,r.renderLocation,t)).next(b.addScreenDelta());e(r,l,o,n)}))},Object.defineProperty(t.prototype,"radius",{get:function(){return this._radius},set:function(e){e!==this._radius&&(this._radius=e,this.updateManipulator())},enumerable:!0,configurable:!0}),t.prototype.updateManipulator=function(){var e=this._radius/M.DISC_RADIUS,t=f.settings.zManipulator.height*e,a=f.settings.zManipulator.coneHeight*e,i=f.settings.zManipulator.coneWidth*e,o=f.settings.zManipulator.width*e,n=[p.vec3f64.fromValues(0,0,0),p.vec3f64.fromValues(0,0,t)],l=new y(_.createTubeGeometry(n,o/2,16,!1),"move-z"),u=_.createConeGeometry(a,i/2,16,!1),m=new y(u),v=[p.vec3f64.fromValues(0,0,0),p.vec3f64.fromValues(0,0,t+a)],g=function(e){var a=c.mat4f64.create();if(s.mat4.translate(a,a,[0,0,t]),s.mat4.rotateX(a,a,Math.PI/2),e){var r=1+2*e/i;s.mat4.scale(a,a,[r,r,r])}return a}(0),h=function(e,t){var a=r.darken(f.settings.zManipulator.color,t);return[a.r/255,a.g/255,a.b/255,f.settings.zManipulator.color.a*e]},b=d.createManipulatorMaterial(h(1,.25),1),w=d.createManipulatorMaterial(h(1,0),1),D=d.createManipulatorMaterial(h(.7,0),f.settings.zManipulator.occludedFlag),z=d.createManipulatorMaterial(h(.85,0),f.settings.zManipulator.occludedFlag);this._manipulator.renderObjects=[{geometry:m,transform:g,material:b,stateMask:1},{geometry:l,material:b,stateMask:1},{geometry:m,transform:g,material:w,stateMask:2},{geometry:l,material:w,stateMask:2},{geometry:m,transform:g,material:D,stateMask:1},{geometry:l,material:D,stateMask:1},{geometry:m,transform:g,material:z,stateMask:2},{geometry:l,material:z,stateMask:2}],this._manipulator.radius=o/2+2,this._manipulator.collisionType={type:"line",paths:[v]}},t.prototype.createManipulator=function(){var e=this,t=new m.Manipulator3D({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});t.applyObjectTransform=function(t){var a=e._view.state.camera,r=D;e._view.renderCoordsHelper.toRenderCoords(e._manipulator.elevationAlignedLocation,r);var i=u.vec3.dist(a.eye,r),o=a.computeRenderPixelSizeAtDist(i),l=u.vec3.subtract(z,r,a.eye);u.vec3.normalize(l,l);var s=P;e._view.renderCoordsHelper.worldUpAtPosition(D,s);var c=Math.abs(u.vec3.dot(l,s)),p=u.vec3.cross(z,l,s),m=u.vec3.cross(z,p,s),d=n.clamp(c,.01,1),v=1-Math.sqrt(1-d*d)/d/a.fullWidth,g=e._radius/M.DISC_RADIUS,h=f.settings.zManipulator.width*g;u.vec3.scale(m,u.vec3.normalize(m,m),(1/v-1)*i+o*h),t[12]-=z[0],t[13]-=z[1],t[14]-=z[2]},this._manipulator=t,this.updateManipulator()},t}(g.Manipulation);t.MoveZManipulation=w;var D=p.vec3f64.create(),z=p.vec3f64.create(),P=p.vec3f64.create()}));