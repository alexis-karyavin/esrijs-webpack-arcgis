// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../geometry","../../../Graphic","../../../core/arrayUtils","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/SetUtils","../../../core/unitUtils","../../../core/accessorSupport/decorators","../../../core/sql/WhereClause","../../../geometry/projection","../../../geometry/support/aaBoundingBox","../../../geometry/support/webMercatorUtils","../../../layers/support/fieldUtils","../../../tasks/support/Query","./I3SMeshView3D","./LayerView3D","./i3s/I3SGeometryUtil","./i3s/I3SQueryEngine","./i3s/I3SQueryFeatureAdapter","./i3s/I3SQueryFeatureStore","./i3s/I3SUtil","./support/DefinitionExpressionSceneLayerView","./support/fieldProperties","./support/layerViewUpdatingProperties","./support/PopupSceneLayerView","../support/projectionUtils","../../layers/LayerView","../../layers/support/FeatureFilter","../../support/Scheduler"],(function(e,t,r,i,n,o,s,a,l,u,p,d,c,y,f,h,g,_,F,m,v,E,b,S,w,I,x,j,R,L,O,Q,q){var M=s.getLogger("esri.views.3d.layers.SceneLayerView3D"),G=x.defineFieldProperties(),V=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._queryEngine=null,t.requiredFields=new Array,t.lodFactor=1,t.progressiveLoadFactor=1,t._elevationContext="scene",t._isIntegratedMesh=!1,t._supportsLabeling=!0,t._asyncModuleLoading=0,t._projectionEngineLoaded=!1,t}return r.__extends(t,e),Object.defineProperty(t.prototype,"filter",{set:function(e){if(a.isNone(e))this._set("filter",null);else{var t=["contains","intersects","disjoint"];e.timeExtent?(M.warn("Filters with a timeExtent are not supported for mesh scene layers"),e=null):e.spatialRelationship&&-1===t.indexOf(e.spatialRelationship)&&(M.warn("Filters with spatialRelationship other than "+t.join(", ")+" are not supported for mesh scene layers"),e=null),this._set("filter",e)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parsedFilterWhereClause",{get:function(){var e=a.isSome(this.filter)?this.filter.where:null;if(!e)return null;try{return c.WhereClause.create(e,this.layer.fieldsIndex)}catch(e){M.error("Failed to parse filter where clause: "+e)}return null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"filterSpatialRelationship",{get:function(){return a.isSome(this.filter)?this.filter.spatialRelationship:"intersects"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parsedFilterGeometry",{get:function(){var e=this;if(a.isNone(this.filter))return null;if(!this._geometryEngine)return null;var t=this.filter.geometry,r=this.filter,n=r.distance,o=r.units,s=this.filterSpatialRelationship,l="mesh"===t.type?t.extent:t;if(!n)return v.processFilterGeometry(l,s);var u=o||p.getUnitString(l.spatialReference);if(l.spatialReference.isWGS84){var d=this._geometryEngine.geodesicBuffer(l,n,u);return v.processFilterGeometry(d,s)}if(h.canProject(l,i.SpatialReference.WGS84)){d=h.project(this._geometryEngine.geodesicBuffer(h.project(l,i.SpatialReference.WGS84),n,u),l.spatialReference);return v.processFilterGeometry(d,s)}if(!y.isSupported())return M.error("Filter by geodesic buffer (distance) unsupported due to lack of projection support."),null;if(!this._projectionEngineLoaded&&(this._loadAsyncModule(y.load()).then((function(){e._set("_projectionEngineLoaded",!0)})),!this._projectionEngineLoaded))return null;var c=null;try{c=y.project(l,i.SpatialReference.WGS84)}catch(e){}if(c)try{c=y.project(this._geometryEngine.geodesicBuffer(c,n,u),l.spatialReference)}catch(e){c=null}return c||M.error("Filter by geodesic buffer (distance) unsupported, failed to project input geometry ("+l.spatialReference.wkid+") to WGS84."),v.processFilterGeometry(c,s)},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){for(var e=this,t=0,r=["layer.renderer","layer.labelingInfo","layer.labelsVisible","definitionExpressionFields","filter"];t<r.length;t++){var i=r[t];this.updatingHandles.add(this,i,(function(){return e.updatingHandles.addPromise(e._updateRequiredFields())}))}this._updateRequiredFields(),this.updatingHandles.add(this.layer,"rangeInfos",(function(t){return e._rangeInfosChanged(t)}),2),this.updatingHandles.add(this.layer,"renderer",(function(t){return e.updatingHandles.addPromise(e._rendererChange(t))}),2);for(var n=0,o=["parsedDefinitionExpression","layer.objectIdFilter","filter","parsedFilterWhereClause","parsedFilterGeometry"];n<o.length;n++){i=o[n];this.updatingHandles.add(this,i,(function(){return e._filterChange()}))}},t.prototype.destroy=function(){},t.prototype._updateRequiredFields=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,i,n,o,s,p,d,c,y,f;return r.__generator(this,(function(r){switch(r.label){case 0:return t=(e=this).layer,i=e.layer,n=i.fields,o=i.renderer,s=e.definitionExpressionFields,p=new Set,[4,l.eachAlways([o?o.collectRequiredFields(p,n):null,g.collectLabelingFields(p,t),a.isSome(this.filter)?g.collectFilterFields(p,t,this.filter):null])];case 1:for(d=r.sent(),c=0,y=d;c<y.length;c++)(f=y[c]).error&&M.error(f.error);return g.collectFields(p,n,s),this._set("requiredFields",u.valuesOfSet(p).sort()),[2]}}))}))},t.prototype._rangeInfosChanged=function(e){null!=e&&e.length>0&&M.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")},t.prototype.createQuery=function(){var e={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return a.isSome(this.filter)?this.filter.createQuery(e):new _(e)},t.prototype.queryExtent=function(e){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e))},t.prototype.queryFeatureCount=function(e){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e))},t.prototype.queryFeatures=function(e){return this._ensureQueryEngine().executeQuery(this._ensureQuery(e))},t.prototype.queryObjectIds=function(e){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e))},t.prototype._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},t.prototype._createQueryEngine=function(){var e=this,t=this._createGetFeatureExtent();return new E.default({layerView:this,task:q.Task.FEATURE_QUERY_ENGINE,spatialIndex:new S.default({featureAdapter:new b.I3SQueryFeatureAdapter({objectIdField:this.layer.objectIdField,attributeStorageInfo:this.layer.attributeStorageInfo,getFeatureExtent:t}),forAllFeatures:function(t,r){return e._forAllFeatures((function(e,r,i){return t({id:e,index:r,meta:i})}),r,2)},getFeatureExtent:t,sourceSpatialReference:w.getIndexCrs(this.layer),viewSpatialReference:this.view.spatialReference})})},t.prototype._createGetFeatureExtent=function(){var e=this,t=new Float64Array(24),r=this.view.renderSpatialReference,i=this.view.spatialReference;return function(n){if(!n.meta.featureExtents){var o=new Float64Array(6*n.meta.featureIds.length);n.meta.featureExtents=o;for(var s=0;s<o.length;s+=6)o[s]=Number.POSITIVE_INFINITY}var a=n.meta.featureExtents,l=new Float64Array(a.buffer,6*n.index*Float64Array.BYTES_PER_ELEMENT,6);return l[0]===Number.POSITIVE_INFINITY?(v.boundingBoxCornerPoints(n.index,e._collection,n.meta.objectHandle,t),L.bufferToBuffer(t,r,0,t,i,0,8)?f.expandWithBuffer(f.NEGATIVE_INFINITY,t,0,8,l):f.set(l,f.ZERO)):l}},t.prototype.highlight=function(t){var r=this._highlights;if(t instanceof _){var i=r.acquireSet(),n=i.set,o=i.handle;return this.queryObjectIds(t).then((function(e){return r.setFeatureIds(n,e)})),o}return e.prototype.highlight.call(this,t)},t.prototype._createLayerGraphic=function(e){var t=new n(null,null,e);return t.layer=this.layer,t.sourceLayer=this.layer,t},t.prototype.canResume=function(){return e.prototype.canResume.call(this)&&(!this._controller||this._controller.rootNodeVisible)},t.prototype.isUpdating=function(){return this.updatingMeshView3D||this._asyncModuleLoading>0},t.prototype.getFilters=function(){var t=this,r=e.prototype.getFilters.call(this);if(this.layer.objectIdFilter){var i=new Float64Array(this.layer.objectIdFilter.ids),n="include"===this.layer.objectIdFilter.method;i.sort(),r.push((function(e){return t._objectIdFilter(i,n,e)}))}if(this.addSqlFilter(r,this.parsedDefinitionExpression,this.definitionExpressionFields,this.logError),a.isSome(this.filter)){var o=this.parsedFilterGeometry;if(a.isSome(o)&&r.push((function(e,r){return t._geometryFilter(e,r,o,t.filterSpatialRelationship)})),this.filter.objectIds){var s=new Float64Array(this.filter.objectIds);s.sort(),r.push((function(e){return t._objectIdFilter(s,!0,e)}))}}return a.isSome(this.parsedFilterWhereClause)&&this.addSqlFilter(r,this.parsedFilterWhereClause,this.parsedFilterWhereClause.fieldNames,this.logError),r},t.prototype._geometryFilter=function(e,t,r,i){var n=r[0].spatialReference||this.view.spatialReference;if(L.mbsToMbs(t.node.mbs,this._controller.crsIndex,P,n))for(var o=v.acquireMaskFilterContext(i,this.view,n,this._collection,t.objectHandle),s=v.computeMaskNodeMBS(P,o),a=function(r){if(0===e.length)return{value:void 0};switch(v.testMaskWithGeometry(r,s,i)){case 1:return e.length=0,{value:void 0};case 0:return"continue"}w.filterInPlace(e,t.featureIds,(function(e){return v.filterWithMask(r,e,o)}))},l=0,u=r;l<u.length;l++){var p=a(u[l]);if("object"==typeof p)return p.value}else M.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter")},t.prototype._filterChange=function(){var t=this;a.isSome(this.filter)&&!!this.filter.geometry&&!this._geometryEngine?this._loadAsyncModule(v.loadGeometryEngine()).then((function(e){t.destroyed||(t._set("_geometryEngine",e),t._applyFilters(!0))})):e.prototype._filterChange.call(this)},t.prototype._loadAsyncModule=function(e){var t=this;this._set("_asyncModuleLoading",this._asyncModuleLoading+1);var r=function(){return t._set("_asyncModuleLoading",t._asyncModuleLoading-1)};return e.then((function(e){return r(),e}),(function(e){throw r(),e}))},t.prototype._objectIdFilter=function(e,t,r){for(var i=0,n=0;i<r.length;){o.binaryIndexOf(e,r[i])>=0===t&&(r[n]=r[i],n++),i++}r.length=n},t.prototype._ensureQuery=function(e){return this._addDefinitionExpressionToQuery(a.isNone(e)?this.createQuery():_.from(e))},r.__decorate([d.property()],t.prototype,"layer",void 0),r.__decorate([d.property({dependsOn:["updatingMeshView3D","_asyncModuleLoading"]})],t.prototype,"updating",void 0),r.__decorate([d.property({dependsOn:["_controller.rootNodeVisible"]})],t.prototype,"suspended",void 0),r.__decorate([d.property(j.updatingProgress)],t.prototype,"updatingProgress",void 0),r.__decorate([d.property({type:Q})],t.prototype,"filter",null),r.__decorate([d.property({readOnly:!0,dependsOn:["filter.where"]})],t.prototype,"parsedFilterWhereClause",null),r.__decorate([d.property({readOnly:!0,dependsOn:["filter.spatialRelationship"]})],t.prototype,"filterSpatialRelationship",null),r.__decorate([d.property({readOnly:!0,dependsOn:["filter.geometry","filter.distance","filter.units","filterSpatialRelationship","_geometryEngine","_projectionEngineLoaded"]})],t.prototype,"parsedFilterGeometry",null),r.__decorate([d.property(G.requiredFields)],t.prototype,"requiredFields",void 0),r.__decorate([d.property(G.availableFields)],t.prototype,"availableFields",void 0),r.__decorate([d.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],t.prototype,"lodFactor",void 0),r.__decorate([d.property({readOnly:!0,aliasOf:"_controller.updatingProgress"})],t.prototype,"updatingProgressValue",void 0),r.__decorate([d.property({readOnly:!0})],t.prototype,"_asyncModuleLoading",void 0),r.__decorate([d.property({readOnly:!0})],t.prototype,"_geometryEngine",void 0),r.__decorate([d.property({readOnly:!0})],t.prototype,"_projectionEngineLoaded",void 0),t=r.__decorate([d.subclass("esri.views.3d.layers.SceneLayerView3D")],t)}(F.I3SMeshView3D(I.DefinitionExpressionSceneLayerView(R.PopupSceneLayerView(m.LayerView3D(O))))),P=[0,0,0,0];return V}));