// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../core/compilerUtils","../../../core/Error","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../layers/graphics/dehydratedFeatures","../../../layers/graphics/controllers/FeatureTileController3D","./FeatureLikeLayerView3D","./LayerView3D","./support/FeatureTileFetcher3DLayerViewContext","./support/layerViewUpdatingProperties","../support/EventedSet","../../layers/FeatureLayerView","../../layers/LayerView","../../layers/RefreshableLayerView"],(function(e,t,r,i,o,a,s,n,u,l,p,c,h,d,y,m,f,g){var _=function(e){function t(t){var r=e.call(this,t)||this;return r._controllerTotal=0,r._graphicsCoreTotal=0,r.suspendResumeExtentMode="data",r}return r.__extends(t,e),t.prototype.destroy=function(){this.fetcherContext&&(this.fetcherContext.destroy(),this.fetcherContext=null)},Object.defineProperty(t.prototype,"updatingProgressValue",{get:function(){var e=1;if(this.controller&&this.controller.updating){var t=this.controller.updatingRemaining;(i=this.controller.updatingTotal)>0&&(this._controllerTotal=Math.max(i,this._controllerTotal),e=(i-t)/i)}var r=1;if(this.graphics3d&&this.graphics3d.graphicsCore){var i;t=this.graphics3d.graphicsCore.updatingRemaining;(i=this.graphics3d.graphicsCore.updatingTotal)>0&&(this._graphicsCoreTotal=Math.max(i,this._graphicsCoreTotal),r=(i-t)/i)}return 1===e&&1===r&&(this._controllerTotal=0,this._graphicsCoreTotal=0),.5*(e+r)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maximumNumberOfFeaturesExceeded",{get:function(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"asyncGraphicsUpdates",{get:function(){if(this.controller)switch(this.controller.mode){case"snapshot":return this.controller.serviceDataCount>F;case"tiles":return!0;default:i.neverReached(this.controller.mode)}return!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasZ",{get:function(){var e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsZ)&&("returnZ"in e&&null!=e.returnZ?e.returnZ:t.supportsZ)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasM",{get:function(){var e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsM)&&("returnM"in e&&null!=e.returnM&&e.returnM)},enumerable:!0,configurable:!0}),t.prototype.fetchPopupFeatures=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(r){return(e=this.validateFetchPopupFeatures(t))?[2,a.reject(e)]:[2,this.fetchClientPopupFeatures(t)]}))}))},t.prototype.setVisibility=function(e,t){this.graphics3d&&this.graphics3d.graphicsCore.setObjectIdVisibility(e,t)},t.prototype.createQuery=function(){return e.prototype.createQuery.call(this)},t.prototype.queryFeatures=function(t,r){var i=this,o=function(){return e.prototype.queryFeatures.call(i,t,r)};return"mesh"===this.layer.geometryType?this._queryFeaturesMesh(this._ensureQuery(t),o):o()},t.prototype.createController=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t=this;return r.__generator(this,(function(r){return this.fetcherContext=new h.FeatureTileFetcher3DLayerViewContext({layerView:this,returnZ:this.hasZ,returnM:this.hasM}),e=new l({layerView:this,context:this.fetcherContext,graphics:new y.EventedSet,extent:this.clippingExtent}),this.updatingHandles.add(e,"serviceDataExtent",(function(e){t.graphics3d&&(t.graphics3d.dataExtent=e)}),2),this.handles.add(s.init(this,"suspended",(function(t){t?e.suspend():e.resume()}),!0)),this.updatingHandles.add(this.graphics3d.graphicsCore,"displayFeatureLimit",(function(){return t.updateDisplayFeatureLimit(e)}),2),this.handles.add(this.view.resourceController.memoryController.events.on("quality-changed",(function(){return t.updateDisplayFeatureLimit()}))),[2,e]}))}))},t.prototype.doRefresh=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return!this.suspended&&this.controller&&this.controller.refetch(),[2]}))}))},t.prototype.getUsedMemory=function(){var e=this.graphics3d&&this.graphics3d.graphicsCore;return(e?e.usedMemory:0)+(this.controller?this.controller.memoryForUnusedFeatures:0)},t.prototype.getUnloadedMemory=function(){var e=this.graphics3d&&this.graphics3d.graphicsCore;return(e?e.unprocessedMemoryEstimate:0)+(this.controller?this.controller.expectedFeatureDiff*e.usedMemoryPerGraphic:0)},t.prototype.ignoresMemoryFactor=function(){return this.controller&&this.controller.hasMaximumNumberOfFeaturesOverride},t.prototype.updateDisplayFeatureLimit=function(e){if(void 0===e&&(e=this.controller),e&&this.graphics3d&&this.graphics3d.graphicsCore){var t=this.graphics3d.graphicsCore.displayFeatureLimit,i=this.view.resourceController.memoryController.memoryFactor;if(1===i)e.displayFeatureLimit=t;else{var o=Math.ceil(t.maximumNumberOfFeatures*i),a=Math.ceil(t.maximumTotalNumberOfFeatures*i),s=Math.ceil(t.minimumTotalNumberOfFeatures*i);e.displayFeatureLimit=r.__assign(r.__assign({},t),{maximumNumberOfFeatures:o,maximumTotalNumberOfFeatures:a,minimumTotalNumberOfFeatures:s})}}},t.prototype._queryFeaturesMesh=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,o,a,s,n,l,p,c;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this._validateQueryFeaturesMesh(e)];case 1:return r.sent(),[4,t()];case 2:if(i=r.sent(),e&&e.outStatistics)return[2,i];for(o=this.layer.objectIdField,a=this.graphics3d.graphicsCore.graphics3DGraphicsByObjectID,s=[],n=0,l=i.features;n<l.length;n++)(p=l[n]).geometry?(c=a.get(p.attributes[o]))&&(p.geometry=u.hydrateGeometry(c.graphic.geometry),s.push(p)):s.push(p);return i.features=s,[2,i]}}))}))},t.prototype._validateQueryFeaturesMesh=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,a,s;return r.__generator(this,(function(r){if(!e)return[2];for(t=function(e){throw new o("feature-layer-view:unsupported-query","Queries on Mesh feature collection layers do not support '"+e+"'")},i=0,a=["quantizationParameters","geometryPrecision","maxAllowableOffset"];i<a.length;i++)null!=e[s=a[i]]&&t(s);return"returnM"in e&&e.returnM&&t("returnM"),"returnCentroid"in e&&e.returnCentroid&&t("returnCentroid"),e.outSpatialReference&&!e.outSpatialReference.equals(this.view.spatialReference)&&t("outSpatialReference"),[2]}))}))},Object.defineProperty(t.prototype,"performanceInfo",{get:function(){var e=this.controller&&this.controller.displayFeatureLimit,t=e&&e.maximumSymbolComplexity,i=t?"f:"+t.primitivesPerFeature+",v:"+t.primitivesPerCoordinate:"n/a",o=r.__assign(r.__assign({},this._getResourceInfo()),{storedFeatures:0,totalVertices:0,partial:this.maximumNumberOfFeaturesExceeded,mode:this.controller?this.controller.mode:"n/a",symbolComplexity:i,nodes:this.controller?this.controller.tileDescriptors.length:0});if(this.controller&&o.displayedNumberOfFeatures){var a=this.controller.debug;o.storedFeatures=a.storedFeatures,o.totalVertices=a.totalVertices}return o},enumerable:!0,configurable:!0}),r.__decorate([n.property()],t.prototype,"layer",void 0),r.__decorate([n.property()],t.prototype,"controller",void 0),r.__decorate([n.property({readOnly:!0,dependsOn:["controller.updatingRemaining","controller.updatingTotal","graphics3d.graphicsCore.updatingRemaining","graphics3d.graphicsCore.updatingTotal"]})],t.prototype,"updatingProgressValue",null),r.__decorate([n.property({aliasOf:"controller.maximumNumberOfFeatures",set:null,get:null})],t.prototype,"maximumNumberOfFeatures",void 0),r.__decorate([n.property({dependsOn:["suspended","controller.maximumNumberOfFeaturesExceeded"]})],t.prototype,"maximumNumberOfFeaturesExceeded",null),r.__decorate([n.property(d.updatingProgress)],t.prototype,"updatingProgress",void 0),r.__decorate([n.property({readOnly:!0,dependsOn:["controller.mode"]})],t.prototype,"asyncGraphicsUpdates",null),r.__decorate([n.property({readOnly:!0})],t.prototype,"hasZ",null),r.__decorate([n.property({readOnly:!0})],t.prototype,"hasM",null),r.__decorate([n.property()],t.prototype,"suspendResumeExtentMode",void 0),t=r.__decorate([n.subclass("esri.views.3d.layers.FeatureLayerView3D")],t)}(g.RefreshableLayerView(p.FeatureLikeLayerView3D(m.FeatureLayerView(c.LayerView3D(f))))),F=5e3;return _}));