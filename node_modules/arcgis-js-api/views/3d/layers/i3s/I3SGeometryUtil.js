// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/arrayUtils","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../support/projectionUtils","@dojo/framework/shim/Promise"],(function(e,t,r,n,a,o,i,s,c){var f;function u(){return!!f}function d(e,t){return f.intersects(e,t)?f.contains(e,t)?0:2:1}function l(e,t){return f.intersects(e,t)?f.contains(e,t)?1:2:0}Object.defineProperty(t,"__esModule",{value:!0}),t.isGeometryEngineLoaded=u,t.loadGeometryEngine=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return u()?[2,f]:[4,new Promise((function(t,r){e(["../../../../geometry/geometryEngine"],t,r)}))];case 1:return[2,f=t.sent()]}}))}))},t.processFilterGeometry=function(e,t){if(!e)return null;if("disjoint"===t&&"polygon"===e.type){for(var r=new Array(e.rings.length),a=0;a<e.rings.length;++a){var o=s.fromValues(1/0,1/0,-1/0,-1/0);s.expandWithNestedArray(o,e.rings[a]),r[a]={type:"polygon",rings:[e.rings[a]],spatialReference:e.spatialReference,aabr:o}}r.sort((function(e,t){return e.aabr[0]-t.aabr[0]}));var i=new Set,c=new n.PositionHint,u=function(e){for(var t=r[e],a=e+1;a<r.length;++a){var o=r[a];if(o.aabr[0]>=t.aabr[2])break;i.add(o)}i.forEach((function(e){if(t!==e)if(e.aabr[2]<=t.aabr[0])i.delete(e);else if(f.intersects(t,e)){t.rings=t.rings.concat(e.rings),s.expand(t.aabr,e.aabr),delete t._geVersion,i.delete(e);var a=n.indexOf(r,e,r.length,c);r.splice(a,1)}})),i.add(t)};for(a=0;a<r.length;++a)u(a);for(var d=0,l=r;d<l.length;d++){delete l[d].aabr}return r}return[e]},t.acquireMaskFilterContext=function(e,t,r,n,a){var o,i,s=t.renderSpatialReference,c=new Map,u={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:r};switch(u.rings[0][3]=u.rings[0][0],e){case"intersects":o=function(e,t){return f.intersects(e,t)?0:2},i=d;break;case"contains":o=function(e,t){return f.contains(e,t)?2:1},i=d;break;case"disjoint":default:o=function(e,t){return f.disjoint(e,t)?2:1},i=l}return{collection:n,object:a,type:e,maskSR:r,renderSR:s,aabbCache:c,triangle:u,positions:{indices:null,data:null,stride:0,startIndex:0,endIndex:0},triangleTest:o,geometryTest:i}},t.computeMaskNodeMBS=function(e,t){var r={x:e[0],y:e[1],hasZ:!1,hasM:!1,type:"point",spatialReference:t.maskSR},n=!t.maskSR.isWGS84&&!t.maskSR.isWebMercator?f.buffer(r,e[3],1):f.geodesicBuffer(r,e[3],1);return n.type="polygon",n},t.testMaskWithGeometry=function(e,t,r){switch(r){case"intersects":case"contains":return d(e,t);case"disjoint":return l(e,t)}};var g=Math.pow(2,-32);t.filterWithMask=function(e,t,r){var n=r.collection,o=r.object,i=r.renderSR,s=r.maskSR,f=r.geometryTest,u=r.aabbCache,d=u.get(t);if(!d){var l=n.getObjectTransform(o);n.getComponentAABB(o,t,p);for(var v=[[p[0],p[1],0],[p[0],p[4],0],[p[3],p[4],0],[p[3],p[1],0]],m=0;m<4;++m)a.vec3.transformMat3(v[m],v[m],l.rotationScale),a.vec3.add(v[m],v[m],l.position),c.vectorToVector(v[m],i,v[m],s);(d={rings:[v],hasZ:!1,hasM:!1,type:"polygon",spatialReference:s}).rings[0][4]=d.rings[0][0],u.set(t,d)}switch(f(e,d)){case 1:return!1;case 0:return!0}var b=r.triangle,h=r.triangleTest,y=r.positions,M=b.rings[0][0],S=b.rings[0][1],x=b.rings[0][2],j=n.getObjectTransform(o);n.getComponentPositions(o,t,y);var w=y.indices,R=y.data,k=y.stride,B=y.startIndex,T=y.endIndex;for(m=B;m<T;m+=3){var A=k*w[m+0],C=k*w[m+1],_=k*w[m+2];a.vec3.set(M,R[A+0],R[A+1],R[A+2]),a.vec3.set(S,R[C+0],R[C+1],R[C+2]),a.vec3.set(x,R[_+0],R[_+1],R[_+2]),a.vec3.transformMat3(M,M,j.rotationScale),a.vec3.transformMat3(S,S,j.rotationScale),a.vec3.transformMat3(x,x,j.rotationScale),a.vec3.add(M,M,j.position),a.vec3.add(S,S,j.position),a.vec3.add(x,x,j.position),c.vectorToVector(M,i,M,s),c.vectorToVector(S,i,S,s),c.vectorToVector(x,i,x,s);var V=S[0]-M[0],O=S[1]-M[1],P=x[0]-M[0],G=x[1]-M[1];if(!(Math.abs(V*G-O*P)<g))switch(delete b._geVersion,h(e,b)){case 1:return!1;case 0:return!0}}switch(r.type){case"intersects":return!1;case"contains":case"disjoint":default:return!0}},t.boundingBoxCornerPoints=function(e,t,r,n){for(var o=t.getComponentAABB(r,e,p),i=t.getObjectTransform(r),s=0;s<8;++s)v[0]=1&s?o[0]:o[3],v[1]=2&s?o[1]:o[4],v[2]=4&s?o[2]:o[5],a.vec3.transformMat3(v,v,i.rotationScale),a.vec3.add(v,v,i.position),n[3*s]=v[0],n[3*s+1]=v[1],n[3*s+2]=v[2];return n},t.boundingBoxTop=function(e,t,r,n){var o=t.getComponentAABB(r,e,p),i=t.getObjectTransform(r);n[0]=0,n[1]=0,n[2]=0;for(var s=0;s<8;++s)v[0]=1&s?o[0]:o[3],v[1]=2&s?o[1]:o[4],v[2]=o[5],a.vec3.transformMat3(v,v,i.rotationScale),a.vec3.add(v,v,i.position),n[0]+=v[0],n[1]+=v[1],n[2]+=v[2];return n[0]/=8,n[1]/=8,n[2]/=8,n};var p=i.create(),v=o.vec3f64.create()}));