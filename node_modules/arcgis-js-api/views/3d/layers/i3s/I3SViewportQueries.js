// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../../../core/maybe","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../layers/graphics/dehydratedFeatures","../graphics/elevationAlignmentUtils","../graphics/ElevationContext","../graphics/featureExpressionInfoUtils","./I3SUtil","../../support/geometryUtils","../../support/orientedBoundingBox","../../support/projectionUtils"],(function(t,e,i,r,s,n,a,o,c,h,p,u,v,m){return function(){function t(t,e,i,r,n,o,c){void 0===c&&(c={}),this.indexSR=t,this._renderCoordsHelper=e,this.extent=r,this.elevationProvider=n,this.options=c,this.fp=u.frustum.create(),this._poi=s.vec3f64.create(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=s.vec3f64.create(),this._tmp2=s.vec3f64.create(),this._tmp3=s.vec3f64.create(),this._tmp0=s.vec3f64.create(),this.screenspaceErrorBias=c.screenspaceErrorBias||1,this.progressiveLoadFactor=c.progressiveLoadFactor||1,this.updateCamera(i),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(o),this.tmpPoint=a.makeDehydratedPoint(0,0,0,t)}return t.prototype.updateElevationInfo=function(t){null!=t?(this._elevationContext=c.ElevationContext.fromElevationInfo(t),this._elevationContext.updateFeatureExpressionInfoContext(h.createContextWithoutExpressionSupport(h.extractExpressionInfo(t,!1)))):this._elevationContext=null},t.prototype.updateCamera=function(t){u.frustum.fromMatrix(t.viewMatrix,t.projectionMatrix,this.fp),this._screenSizeFactor=1/(t.perScreenPixelRatio/2),this._camPos=t.eye,this.minDistance=1/0,this.maxDistance=0},t.prototype.setPointOfInterest=function(t){r.vec3.copy(this._poi,t)},t.prototype.updateScreenSpaceErrorBias=function(t){var e=this.screenspaceErrorBias;return this.screenspaceErrorBias=t,e},t.prototype.updateExtent=function(t){this.extent=t},t.prototype.getRenderMbs=function(t){var e=t.renderMbs;return e[3]<0&&(n.vec4.copy(e,t.mbs),this._elevationContext&&e[3]<1e5&&(this.tmpPoint.x=e[0],this.tmpPoint.y=e[1],this.tmpPoint.z=e[2],e[2]=o.evaluateElevationAlignmentAtPoint(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)),m.mbsToMbs(e,this.indexSR,e,this.engineSR)),e},t.prototype.getRenderObb=function(t){var e=t.authorativeObb||t.obb;if(!(i.isNone(e)||e.halfSize[0]<0)){i.isNone(t.renderObb)&&(t.renderObb=v.create());var r=t.renderObb;if(r.halfSize[0]<0){if(i.isSome(t.authorativeObb))return v.set(t.authorativeObb,r),t.authorativeObb;var s=0;this._elevationContext&&t.mbs[3]<1e5&&(this.tmpPoint.x=e.center[0],this.tmpPoint.y=e.center[1],this.tmpPoint.z=e.center[2],s=o.evaluateElevationAlignmentAtPoint(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)-e.center[2]),p.transformObb(e,this.indexSR,r,this.engineSR,s,t.isComputedObb)}return r}},t.prototype.isNodeVisible=function(t){var e=this.getRenderMbs(t);if(!this.isMBSinExtent(e))return!1;var r=this.getRenderObb(t);return i.isSome(r)?v.isVisible(r,this.fp):this.isMBSVisible(e)},t.prototype.isGeometryVisible=function(t){var e=this.getRenderObb(t);return!i.isSome(e)||v.isVisible(e,this.fp)},t.prototype.isMBSinExtent=function(t){return!this.extent||0!==p.intersectBoundingBoxWithMbs(this.extent,t)},t.prototype.isMBSVisible=function(t){return u.frustum.intersectsSphere(this.fp.planes,u.sphere.wrap(t[3],t))},t.prototype.screenSpaceDiameterMbs=function(t,e){var i=this.getRenderMbs(t),s=Math.sqrt(r.vec3.squaredDistance(i,this._camPos)),n=s-i[3];return this._updateMinMaxDistance(s),n<0?.5*Number.MAX_VALUE:e/n*this._screenSizeFactor},t.prototype.calcCameraDistance=function(t){return this.calcCameraDistanceToCenter(t)-this.getRenderMbs(t)[3]},t.prototype.calcCameraDistanceToCenter=function(t){var e=this.getRenderMbs(t),i=r.vec3.distance(e,this._camPos);return this._updateMinMaxDistance(i),i},t.prototype.calcAngleDependentLoD=function(t){var e=this.getRenderMbs(t),i=e[3],s=(Math.abs(e[0]*(e[0]-this._camPos[0])+e[1]*(e[1]-this._camPos[1])+e[2]*(e[2]-this._camPos[2]))/r.vec3.length(e)+i)/r.vec3.distance(e,this._camPos);return Math.min(1,s)},t.prototype.hasLOD=function(t){return 0!==t.lodMetric},t.prototype.getDistancePlanarMode=function(t,e){var i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2],n=i*i+r*r,a=e[3];if(n<=a*a)return Math.abs(s);var o=Math.sqrt(n)-a;return Math.sqrt(s*s+o*o)},t.prototype.getDistanceGlobeMode=function(t,e){var i=r.vec3.length(e),s=r.vec3.length(t)-i;r.vec3.scale(this._tmp0,t,r.vec3.dot(t,e)/r.vec3.squaredLength(t));var n=r.vec3.squaredDistance(e,this._tmp0),a=e[3];if(n<=a*a)return Math.abs(s);var o=r.vec3.scale(this._tmp0,e,1/i),c=i,h=a*a/2/c,p=r.vec3.scale(this._tmp1,o,c-h),u=t,v=r.vec3.subtract(this._tmp2,u,p),m=r.vec3.subtract(this._tmp2,v,r.vec3.scale(this._tmp3,o,r.vec3.dot(o,v))),l=r.vec3.add(this._tmp2,p,r.vec3.scale(this._tmp2,m,a/r.vec3.length(m))),d=r.vec3.distance(u,l);if(s>=2e5){var f=r.vec3.subtract(this._tmp1,u,l),b=r.vec3.dot(f,o)/r.vec3.length(f);b<.08&&(b=1e-4),d/=b}return d},t.prototype.getDistance=function(t,e){return this.engineSR===m.SphericalECEFSpatialReference?this.getDistanceGlobeMode(t,e):this.getDistancePlanarMode(t,e)},t.prototype._updateMinMaxDistance=function(t){t>0?(this.minDistance=Math.min(this.minDistance,t),this.maxDistance=Math.max(this.maxDistance,t)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-t))},t.prototype.getLodLevel=function(t){if(0===t.lodMetric||!t.resources.hasFeatureData)return 0;if(0===t.childCount)return this.maxLodLevel;if(this.progressiveLoadFactor<1){var e=this.progressiveLoadFactor*this.screenspaceErrorBias,i=this.screenspaceErrorBias;return this.evaluateLODmetric(t,e)?this.evaluateLODmetric(t,i)?2:1:0}return this.evaluateLODmetric(t,this.screenspaceErrorBias)?this.maxLodLevel:0},t.prototype.evaluateLODmetric=function(t,e){switch(t.lodMetric){case 2:var i=this.getRenderMbs(t),r=this.getDistance(this._camPos,i),s=2*r/this._screenSizeFactor,n=r+i[3];return this._updateMinMaxDistance(n),t.maxError*e<=s;case 1:var a=this.screenSpaceDiameterMbs(t,t.mbs[3]*e);return this.options.angleDependentLoD&&(a*=this.calcAngleDependentLoD(t)),a<t.maxError;case 3:return this.screenSpaceDiameterMbs(t,t.maxError)*e<10;case 4:return this.calcCameraDistance(t)>t.maxError*e}return!1},t.prototype.distToPOI=function(t){var e=this.getRenderMbs(t);return r.vec3.distance(e,this._poi)-e[3]},t.prototype.distCameraToPOI=function(){return r.vec3.distance(this._camPos,this._poi)},t}()}));