// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../request","../../../../core/asyncUtils","../../../../core/Error","../../../../core/lang","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/Version","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../support/imageUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial"],(function(e,r,t,a,n,i,s,o,u,l,c,p,f,d,v,m,g,x){Object.defineProperty(r,"__esModule",{value:!0});var y=o.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");function h(e,r){return t.__awaiter(this,void 0,void 0,(function(){var i,s;return t.__generator(this,(function(t){switch(t.label){case 0:return(i=u.isSome(r)&&r.streamDataRequester)?[2,w(e,i,r)]:[4,n.result(a(e,u.unwrap(r)))];case 1:return!0===(s=t.sent()).ok?[2,s.value.data]:(l.throwIfAbortError(s.error),b(s.error),[2,void 0])}}))}))}function w(e,r,a){return t.__awaiter(this,void 0,void 0,(function(){var i;return t.__generator(this,(function(t){switch(t.label){case 0:return[4,n.result(r.request(e,"json",a))];case 1:return!0===(i=t.sent()).ok?[2,i.value]:(l.throwIfAbortError(i.error),b(i.error.details.url),[2,void 0])}}))}))}function b(e){throw new i("","Request for object resource failed: "+e)}function A(e){var r=e.params,t=r.topology,a=!0;switch(r.vertexAttributes||(y.warn("Geometry must specify vertex attributes"),a=!1),r.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:var n=r.faces;if(n){if(r.vertexAttributes)for(var i in r.vertexAttributes){var s=n[i];s&&s.values?(null!=s.valueType&&"UInt32"!==s.valueType&&(y.warn("Unsupported indexed geometry indices type '"+s.valueType+"', only UInt32 is currently supported"),a=!1),null!=s.valuesPerElement&&1!==s.valuesPerElement&&(y.warn("Unsupported indexed geometry values per element '"+s.valuesPerElement+"', only 1 is currently supported"),a=!1)):(y.warn("Indexed geometry does not specify face indices for '"+i+"' attribute"),a=!1)}}else y.warn("Indexed geometries must specify faces"),a=!1;break;default:y.warn("Unsupported topology '"+t+"'"),a=!1}e.params.material||(y.warn("Geometry requires material"),a=!1);var o=e.params.vertexAttributes;for(var u in o){o[u].values||(y.warn("Geometries with externally defined attributes are not yet supported"),a=!1)}return a}function _(e){var r=f.empty();return e.forEach((function(e){var t=e.boundingInfo;f.expand(r,t.getBBMin()),f.expand(r,t.getBBMax())})),r}function U(e,r){return t.__awaiter(this,void 0,void 0,(function(){var a,n,i,s,o,c,p,f;return t.__generator(this,(function(t){switch(t.label){case 0:for(i in a=[],n=function(t){var n=e[t],i=n.images[0].data;if(!i)return y.warn("Externally referenced texture data is not yet supported"),"continue";var s=n.encoding+";base64,"+i,o="/textureDefinitions/"+t,c={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:!0},p=u.isSome(r)&&r.disableTextures?l.resolve(null):d.requestImage(s,r);a.push(p.then((function(e){return{refId:o,image:e,params:c,alphaChannelUsage:"rgba"===n.channels?n.alphaChannelUsage||"transparency":"none"}})))},e)n(i);return[4,l.all(a)];case 1:for(s=t.sent(),o={},c=0,p=s;c<p.length;c++)f=p[c],o[f.refId]=f;return[2,o]}}))}))}function I(e){switch(e){case"mask":return 2;case"maskAndTransparency":return 3;case"none":return 1;case"transparency":default:return 0}}function M(e){var r=e.params;return{id:1,material:r.material,texture:r.texture,region:r.texture}}function T(e){for(var r=new Uint32Array(e),t=0;t<e;t++)r[t]=t;return r}r.load=function(e,r){return t.__awaiter(this,void 0,void 0,(function(){var a,n;return t.__generator(this,(function(t){switch(t.label){case 0:return[4,h(e,r)];case 1:return[4,U((a=t.sent()).textureDefinitions,r)];case 2:return n=t.sent(),[2,{resource:a,textures:n}]}}))}))},r.processLoadResult=function(e,r){var t=[],a=[],n=[],i=[],o=e.resource,l=c.Version.parse(o.version||"1.0","wosr");P.validate(l);for(var f=o.model.name,d=o.model.geometries,y=o.materialDefinitions,h=e.textures,w=0,b=new Map,U=0;U<d.length;U++){var E=d[U];if(A(E)){var k=M(E),q=E.params.vertexAttributes,B={};for(var D in q){var C=q[D],G=C.values;B[D]={data:G,size:C.valuesPerElement}}var R={};if("PerAttributeArray"===E.params.topology){var O=T(B.position.data.length/B.position.size);for(var j in B)R[j]=O}else{var S=E.params.faces;for(var V in S)R[V]=new Uint32Array(S[V].values)}var L=h&&h[k.texture];if(L&&!b.has(k.texture)){var z=L.image,F=L.params,H=new g(z,f,F);i.push(H),b.set(k.texture,H)}var J=b.get(k.texture),K=J?J.id:void 0,N=n[k.material]?n[k.material][k.texture]:null;if(!N){var Q=y[k.material.substring(k.material.lastIndexOf("/")+1)].params;1===Q.transparency&&(Q.transparency=0);var W=L&&L.alphaChannelUsage,X=Q.transparency>0||"transparency"===W||"maskAndTransparency"===W,Y={ambient:p.vec3f64.fromArray(Q.diffuse),diffuse:p.vec3f64.fromArray(Q.diffuse),opacity:1-(Q.transparency||0),transparent:X,textureAlphaMode:L?I(L.alphaChannelUsage):void 0,textureAlphaCutoff:.33,textureId:K,initTextureTransparent:!0,doubleSided:!0,cullFace:0,colorMixMode:Q.externalColorMixMode||"tint",textureAlphaPremultiplied:!0};u.isSome(r)&&r.materialParamsMixin&&s.mixin(Y,r.materialParamsMixin),N=new x(Y,f),n[k.material]||(n[k.material]={}),n[k.material][k.texture]=N}a.push(N);var Z=new v(new m.GeometryData(B,R),f);w+=R.position?R.position.length:0,t.push(Z)}}return{name:f,stageResources:{textures:i,materials:a,geometries:t},pivotOffset:o.model.pivotOffset,boundingBox:_(t),numberOfVertices:w,lodThreshold:null}},r.createTextureResources=U;var P=new c.Version(1,2,"wosr")}));