// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../../../core/mathUtils","../../../../core/maybe","../../../../core/typedArrayUtil","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/triangulationUtils","./constants","./elevationAlignmentUtils","../../support/projectionUtils","../../terrain/OverlayRenderer","../../webgl-engine/lib/GeometryData","../../webgl-engine/shaders/RibbonLineTechnique"],(function(t,e,r,n,a,i,o,s,u,b,l,f,I,c){function d(t,e,r){for(var n=new Array,a=0,i=t;a<i.length;a++){var o=i[a],s=o.index,u=o.count;if(!(u<=1)){var b=3*s,l=b+3*u;n.push({position:e.subarray(b,l),mapPosition:r?r.subarray(b,l):void 0})}}return n}Object.defineProperty(e,"__esModule",{value:!0}),e.createGeometryData=function(t){var e={},o={};!function(t,e,r){for(var n=t.attributeData.position,i=t.removeDuplicateStartEnd,o=(I=n,d=void 0,d=I.length,I[0]===I[d-3]&&I[1]===I[d-2]&&I[2]===I[d-1]&&1===i),s=n.length/3-(o?1:0),u=new Uint32Array(2*(s-1)),b=o?a.slice(n,0,n.length-3):n,l=0,f=0;f<s-1;f++)u[l++]=f,u[l++]=f+1;var I,d;e[c.RibbonVertexAttributeConstants.POSITION]={size:3,data:b,offsetIdx:0,strideIdx:3},r[c.RibbonVertexAttributeConstants.POSITION]=u}(t,o,e);var s=new Uint32Array(e[c.RibbonVertexAttributeConstants.POSITION].length);return function(t,e,r){var a=t.attributeData.mapPosition;if(n.isNone(a))return;r.mapPos=r[c.RibbonVertexAttributeConstants.POSITION],e.mapPos={size:3,data:a,offsetIdx:0,strideIdx:3}}(t,o,e),function(t,e,r,a){if(n.isSome(t.attributeData.colorFeature))return;var i=t.attributeData.color;e[c.RibbonVertexAttributeConstants.COLOR]={size:4,data:n.unwrapOr(i,u.WHITE_UNIT),offsetIdx:0,strideIdx:4},r[c.RibbonVertexAttributeConstants.COLOR]=a}(t,o,e,s),function(t,e,r,a){if(n.isSome(t.attributeData.sizeFeature))return;var i=t.attributeData.size;e[c.RibbonVertexAttributeConstants.SIZE]={size:1,data:new Float32Array([n.unwrapOr(i,1)]),offsetIdx:0,strideIdx:1},r[c.RibbonVertexAttributeConstants.SIZE]=a}(t,o,e,s),function(t,e,r,a){var i=t.attributeData.colorFeature;if(n.isNone(i))return;e[c.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE]={size:1,data:new Float32Array([i]),offsetIdx:0,strideIdx:1},r[c.RibbonVertexAttributeConstants.COLOR]=a}(t,o,e,s),function(t,e,r,a){var i=t.attributeData.sizeFeature;if(n.isNone(i))return;e[c.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE]={size:1,data:new Float32Array([i]),offsetIdx:0,strideIdx:1},r[c.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE]=a}(t,o,e,s),function(t,e,r,a){var i=t.attributeData.opacityFeature;if(n.isNone(i))return;e[c.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE]={size:1,data:new Float32Array([i]),offsetIdx:0,strideIdx:1},r[c.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE]=a}(t,o,e,s),function(t,e,a){if("round"!==t.join)return;var o=e[c.RibbonVertexAttributeConstants.POSITION].data,s=o.length/3,u=new Float32Array(s),b=p,l=A;i.vec3.set(b,0,0,0);for(var f=n.unwrapOr(t.uniformSize,1),I=-1;I<s;++I){var d=I<0?s+I:I,R=(I+1)%s;if(i.vec3.set(l,o[3*R+0]-o[3*d+0],o[3*R+1]-o[3*d+1],o[3*R+2]-o[3*d+2]),i.vec3.normalize(l,l),I>=0){var v=1*((Math.PI-r.acosClamped(i.vec3.dot(b,l)))*x)*(T=f,1.863798+-2.0062872/Math.pow(1+T/18.2313,.8856294));u[I]=Math.max(Math.floor(v),0)}i.vec3.scale(b,l,-1)}var T;e[c.RibbonVertexAttributeConstants.SUBDIVISIONS]={size:1,data:u,offsetIdx:0,strideIdx:1},a[c.RibbonVertexAttributeConstants.SUBDIVISIONS]=a[c.RibbonVertexAttributeConstants.POSITION]}(t,o,e),new I.GeometryData(o,e,"line")},e.geometryToRenderInfo=function(t,e,r,n){var a="polygon"===t.type?1:0,i="polygon"===t.type?t.rings:t.paths,o=s.pathsToTriangulationInfo(i,t.hasZ,a),u=o.position,l=o.outlines,f=new Float64Array(u.length),I=b.applyPerVertexElevationAlignment(u,t.spatialReference,0,f,0,u,0,u.length/3,e,r,n),c=null!=I;return{lines:c?d(l,u,f):[],projectionSuccess:c,sampledElevation:I}},e.geometryToRenderInfoDraped=function(t,e){for(var r="polygon"===t.type?1:0,n="polygon"===t.type?t.rings:t.paths,a=s.pathsToTriangulationInfo(n,!1,r),i=a.position,o=a.outlines,u=l.bufferToBuffer(i,t.spatialReference,0,i,e,0,i.length/3),b=2;b<i.length;b+=3)i[b]=f.DRAPED_Z;return{lines:u?d(o,i):[],projectionSuccess:u}};var p=o.vec3f64.create(),A=o.vec3f64.create(),x=4/Math.PI}));