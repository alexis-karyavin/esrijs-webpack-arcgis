// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/Error","../../../../core/maybe","../../../../core/ObjectPool","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/vec2f64","../../../../symbols/callouts/calloutUtils","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./pointUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTexture","../../webgl-engine/materials/HUDMaterial"],(function(e,t,n,r,o,i,a,l,s,c,d,u,p,h,f,y,v,g,m,b,x,S){Object.defineProperty(t,"__esModule",{value:!0});var P=[0,0,1],O=function(e){function t(t,n,r,a){var l=e.call(this,t,n,r,a)||this;return l._geometryDataPool=new i(g.GeometryData,(function(e,t,n){var r=t.translation,i=o.isSome(n)?[n.displayWidth,n.displayHeight]:[0,0],a=t.centerOffset;if(0===e.indexCount){var l=P;m.createPointGeometry(l,r,null,i,a,[0,0],null,e)}else m.updatePointGeometry(null,r,null,i,a,null,null,e)})),l._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},l.ensureDrapedStatus(!1),l}return n.__extends(t,e),t.prototype.doLoad=function(){return n.__awaiter(this,void 0,void 0,(function(){var e;return n.__generator(this,(function(t){if(!this._drivenProperties.size&&(e=f.validateSymbolLayerSize(this.symbolLayer.size)))throw new r("graphics3dtextsymbollayer:invalid-size",e);return this._createTextRenderParameters(),[2]}))}))},t.prototype._createTextRenderParameters=function(){var e=this._context.layerView.view.pixelRatio;this._textRenderParameters=b.default.fromSymbol(this.symbolLayer,e)},t.prototype.destroy=function(){e.prototype.destroy.call(this),this._geometryDataPool.destroy()},t.prototype.createGraphics3DGraphic=function(e){var t=e.graphic,n=y.placePointOnGeometry(t.geometry);if(o.isNone(n))return this.logger.warn("unsupported geometry type for text symbol: "+t.geometry.type),null;var r=this.symbolLayer.text;if(!r)return null;var i=s.isCalloutSupport(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol:null;return this._createAs3DShape(t,n,r,i)},t.prototype.onRemoveGraphic=function(e){this._geometryDataPool.release(e.stageObject.geometries[0].data)},t.prototype.createLabel=function(e,t,n,r){var i=e.graphic,a=y.placePointOnGeometry(i.geometry);if(o.isNone(a))return this.logger.warn("unsupported geometry type for label: "+i.geometry.type),null;var l=t.text;return!l||/^\s+$/.test(l)?null:this._createAs3DShape(i,a,l,t,t,n,r)},t.prototype.setGraphicElevationContext=function(t,n,r){void 0===r&&(r=0);var o=e.prototype.setGraphicElevationContext.call(this,t,n);return o.addOffsetRenderUnits(r),o},t.prototype.layerOpacityChanged=function(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1},t.prototype.layerElevationInfoChanged=function(e,t){var n=this;return _(e,t,(function(e,t){n.updateGraphicElevationContext(t,e)})),d.SymbolUpdateType.UPDATE},t.prototype.slicePlaneEnabledChanged=function(e,t){var n=this;return _(e,t,(function(e){for(var t=0,r=e.stageObject.geometryRecords;t<r.length;t++){r[t].material.setParameterValues({slicePlaneEnabled:n._context.slicePlaneEnabled})}})),!0},t.prototype.physicalBasedRenderingChanged=function(){return!0},t.prototype.pixelRatioChanged=function(){return!1},t.prototype.updateGraphicElevationContext=function(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=d.needsElevationUpdates2D(t.elevationContext.mode)||"absolute-height"===t.elevationContext.mode},t.prototype._defaultElevationInfoNoZ=function(){return E},t.prototype._createAs3DShape=function(e,t,n,r,i,s,h){void 0===i&&(i=w);var g=this.setGraphicElevationContext(e,new u.ElevationContext,i.elevationOffset),m=this._context.layer.id+"_label_"+e.uid,b="polyline"===o.get(e.geometry,"type"),P=e.uid,O=this._context.stage.renderView.renderingContext,_=i.anchor in f.namedAnchorToHUDMaterialAnchorPos?i.anchor:"center",E=f.namedAnchorToHUDMaterialAnchorPos[_],D=o.isNone(h)?new x(O,n,this._textRenderParameters,m):null,G={occlusionTest:!0,screenOffset:i.screenOffset,anchorPos:E,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:i.centerOffsetUnits,debugDrawBorder:i.debugDrawBorder,drawInSecondSlot:!0};if(o.isSome(D)&&(G.textureId=D.id,G.texCoordScale=D.texcoordScale),o.isSome(h)&&(G.textureId=h.textureId),o.isSome(r)&&o.isSome(r.verticalOffset)){var C=r.verticalOffset,U=C.screenLength,L=C.minWorldLength,T=C.maxWorldLength;G.verticalOffset={screenLength:a.pt2px(U),minWorldLength:L||0,maxWorldLength:null!=T?T:1/0}}if(this._context.screenSizePerspectiveEnabled){var A=this._context.sharedResources,R=A.screenSizePerspectiveSettings,z=A.screenSizePerspectiveSettingsLabels;G.screenSizePerspective=z.overridePadding(this._textRenderParameters.haloSize),G.screenSizePerspectiveAlignment=R}b&&(G.shaderPolygonOffset=1e-4),G.slicePlaneEnabled=this._context.slicePlaneEnabled;var j=null;if(o.isSome(s)){var H=JSON.stringify(G);null==(j=s.getMaterial(H))&&(j=new S.default(G,m),s.addMaterial(H,j))}else j=new S.default(G,m);var W=[j],I=this._geometryDataPool.acquire(i,D),M=[new v(I,m)],N=this._context.layer.uid,V=y.createStageObjectForHUD(this._context,t,M,W,null,null,g,m,N,P);if(null===V)return null;var B=c.perObjectElevationAligner,q=new p(this,V.object,M,o.isNone(s)?W:null,o.isSome(D)?[D]:null,B,g);q.alignedSampledElevation=V.sampledElevation,q.needsElevationUpdates=d.needsElevationUpdates2D(g.mode)||"absolute-height"===g.mode;var F=o.isSome(D)?D:i,J=F.displayWidth,Z=F.displayHeight;q.getScreenSize=function(e){return void 0===e&&(e=l.vec2f64.create()),e[0]=J,e[1]=Z,e};var $={labelText:n,elevationOffset:i.elevationOffset};return q.metadata=$,y.extendPointGraphicElevationContext(q,t,this._context.elevationProvider),q},t}(h.default);function _(e,t,n){e&&e.forEach((function(e){var r=t(e);o.isSome(r)&&n(r,e.graphic)}))}t.Graphics3DTextSymbolLayer=O;var E={mode:"relative-to-ground",offset:0},w={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],anchor:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawBorder:!1,displayWidth:0,displayHeight:0};t.default=O}));