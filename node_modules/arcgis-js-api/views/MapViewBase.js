// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../geometry","../Viewpoint","../core/Error","../core/Logger","../core/promiseUtils","../core/screenUtils","../core/watchUtils","../core/accessorSupport/decorators","../geometry/support/webMercatorUtils","../layers/support/TileInfo","./PopupView","./View","./ViewAnimation","./2d/AnimationManager","./2d/FrameTask","./2d/layerViewModuleImportUtils","./2d/MapViewConstraints","./2d/PaddedViewState","./2d/tiling","./2d/viewpointUtils","./2d/support/Timeline"],(function(e,t,i,n,r,a,o,s,p,l,c,u,d,h,y,f,_,m,g,w,v,b,T,V){var O=o.getLogger("esri.views.MapView");return function(e){function t(t){var i=e.call(this,t)||this;i._stationaryTimer=null,i.frameTask=new m.default(i),i.featuresTilingScheme=null,i.fullOpacity=1,i.graphicsView=null,i.initialExtent=null,i.labelManager=null,i.renderingOptions={samplingMode:"dynamic",edgeLabelsVisible:!0,labelsAnimationTime:125,labelCollisionsEnabled:!0},i.resizeAlign="center",i.timeline=new V.Timeline,i.type="2d",i.constraints=new w,i.padding={top:0,right:0,bottom:0,left:0};var n=i.handles,r=function(){return i.notifyChange("updating")};return n.add([i.watch("viewpoint",(function(){i._lastStationaryEventTimestamp=performance.now(),i._flipStationary(160)}),!0),i.on("resize",(function(e){return i._resizeHandler(e)})),i.watch("animationManager.animation",(function(e){i.animation=e})),i.allLayerViews.on("change",(function(){r(),n.remove("map-view-base-layerViewsUpdating"),n.add(i.allLayerViews.map((function(e){return e.watch("updating",r)})),"map-view-base-layerViewsUpdating")}))],"map-view-base"),i}return i.__extends(t,e),t.prototype.destroy=function(){this.destroyed||(this._set("preconditionsReady",!1),this._gotoTask=this.frameTask=null)},Object.defineProperty(t.prototype,"animation",{set:function(e){var t=this,i=this._get("animation");if(e!==i)if(i&&i.stop(),e&&!e.isFulfilled()){this._set("animation",e),this.frameTask.animationInProgress=!0;var n=function(){e===t._get("animation")&&(t._set("animation",null),t.frameTask.requestFrame()),t.frameTask.animationInProgress=!1};e.when(n,n)}else this._set("animation",null)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"center",{get:function(){if(!this.ready)return this._get("center");var e=this.state.paddedViewState,t=e.center,i=e.spatialReference;return new n.Point({x:t[0],y:t[1],spatialReference:i})},set:function(e){if(null!=e)if(this._normalizeInput(e)){if(!this.ready)return this._set("center",e),void this.notifyChange("initialExtentRequired");var t=this.viewpoint;T.centerAt(t,t,e),this.viewpoint=t}else O.error("#center","incompatible spatialReference "+JSON.stringify(e.spatialReference)+" with view's spatialReference "+JSON.stringify(this.spatialReference))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"constraints",{set:function(e){var t=this,i=this._get("constraints");i&&(this.handles.remove("map-view-base-constraints"),i.destroy()),this._set("constraints",e),e&&(e.view=this,this.ready&&(this.state.viewpoint=e.fit(this.state.paddedViewState.viewpoint)),this.handles.add(e.on("update",(function(){t.ready&&t.state&&(t.state.viewpoint=e.fit(t.state.paddedViewState.viewpoint))})),"map-view-base-constraints"))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"extent",{get:function(){return this.ready?this.state.paddedViewState.extent.clone():this._get("extent")},set:function(e){if(null!=e){var t=this._normalizeInput(e);if(t)if(t.width&&t.height){if(!this.ready)return this._set("extent",t),this._set("center",null),this._set("viewpoint",null),this._set("scale",0),this._set("zoom",-1),void this.notifyChange("initialExtentRequired");var i=this.viewpoint;T.setExtent(i,i,t,this.size,{constraints:this.constraints}),this.viewpoint=i}else O.error("#extent","invalid extent size");else O.error("#center","incompatible spatialReference "+JSON.stringify(e.spatialReference)+" with view's spatialReference "+JSON.stringify(this.spatialReference))}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"initialExtentRequired",{get:function(){var e=this,t=e.extent,i=e.center,n=e.scale,r=e.viewpoint,a=e.zoom;return!this.get("map.initialViewProperties.viewpoint")&&(!t&&((!i||0===n&&-1===a)&&!r))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"padding",{get:function(){return this.ready?this.state.padding:this._get("padding")},set:function(e){this.ready?(this.state.padding=e,this._set("padding",this.state.padding)):this._set("padding",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"resolution",{get:function(){return this.state?this.state.resolution:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotation",{get:function(){return this.ready?this.state.rotation:this._get("rotation")},set:function(e){if(!isNaN(e))if(this.ready){var t=this.viewpoint;T.rotateTo(t,t,e),this.viewpoint=t}else this._set("rotation",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scale",{get:function(){return this.ready?this.state.scale:this._get("scale")},set:function(e){if(e&&!isNaN(e)){if(!this.ready){this._set("scale",e),this._set("zoom",-1);var t=this._get("extent");return t&&(this._set("extent",null),this._set("center",t.center)),void this.notifyChange("initialExtentRequired")}var i=this.viewpoint;T.scaleTo(i,i,e),this.viewpoint=i}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stationary",{get:function(){return!(this.animation||this.navigating||this._get("resizing")||this._stationaryTimer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!this.destroyed&&(!0===this.get("layerViewManager.updating")||!0===this.get("labelManager.updating")||!0===this.get("graphicsView.updating")||this.allLayerViews.some((function(e){return!(e.destroyed||"layerViews"in e||!0!==e.updating)})))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"viewpoint",{get:function(){if(!this.ready)return this._get("viewpoint");var e=this.state.paddedViewState;return e&&e.viewpoint.clone()},set:function(e){if(null!=e){var t=this._normalizeInput(e);if(t){if(!this.ready)return this._set("viewpoint",t),this._set("extent",null),this._set("center",null),this._set("zoom",-1),this._set("scale",0),void this.notifyChange("initialExtentRequired");var i=new r({targetGeometry:new n.Point,scale:0,rotation:0});T.copy(i,t),this.constraints.constrain(i,this.state.paddedViewState.viewpoint),this.state.viewpoint=i,this.frameTask.requestFrame(),this._set("viewpoint",i)}else!e.scale||isNaN(e.scale)?O.error("#viewpoint","invalid scale value of "+e.scale):e.targetGeometry?O.error("#viewpoint","incompatible spatialReference "+JSON.stringify(e.targetGeometry.spatialReference)+" with view's spatialReference "+JSON.stringify(this.spatialReference)):O.error("#viewpoint","geometry not defined")}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"zoom",{get:function(){return this.ready?this.constraints.scaleToZoom(this.scale):this._get("zoom")},set:function(e){if(null!=e){if(!this.ready){this.notifyChange("initialExtentRequired"),this._set("zoom",e),this._set("scale",0);var t=this._get("extent");t&&(this._set("extent",null),this._set("center",t.center))}if(this.constraints.effectiveLODs){var i=this.viewpoint;T.scaleTo(i,i,this.constraints.zoomToScale(e)),this.viewpoint=i,this._set("zoom",this.constraints.scaleToZoom(this.scale))}}},enumerable:!0,configurable:!0}),t.prototype.goTo=function(e,t){var n=this;if(e)return l.whenTrueOnce(this,"ready",t&&t.signal).then((function(){n.animation&&(n.animation=null);var r=i.__assign({animate:!0},t),a=T.createAsync(e,n);return n._gotoTask={},r.animate?n._gotoAnimated(a,r):n._gotoImmediate(a,r)}));O.error("#goTo()","target cannot be null or undefined")},t.prototype.hitTest=function(e){return s.reject("Should be implemented by subclasses")},t.prototype.popupHitTest=function(e){var t=this;return this.hitTest(e).then((function(n){return i.__assign(i.__assign({},n),{mapPoint:t.toMap(e)})}))},t.prototype.toMap=function(e){if(!this.ready)return null;var t=this.state.toMap([0,0],[e.x,e.y]),i=t[0],r=t[1],a=this.spatialReference;return new n.Point({x:i,y:r,spatialReference:a})},t.prototype.isTileInfoRequired=function(){return!0},t.prototype.toScreen=function(e){if(!this.ready)return null;var t=this._normalizeInput(e),i=[t.x,t.y],n=this.state.toScreen(i,i),r=n[0],a=n[1];return p.createScreenPoint(r,a)},t.prototype.pixelSizeAt=function(){return this.ready?this.state.resolution:(O.error("#pixelSizeAt()","Map view cannot be used before it is ready"),null)},t.prototype.requestUpdate=function(){this.ready&&this.frameTask.requestUpdate()},t.prototype.getDefaultSpatialReference=function(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||null},t.prototype.isSpatialReferenceSupported=function(e,t){return!(!t&&!this._get("ready"))||null!==this._getDefaultViewpoint()},t.prototype.importLayerView=function(e){return g.layerView2DImporter.importLayerView(e)},t.prototype.hasLayerViewModule=function(e){return g.layerView2DImporter.hasLayerViewModule(e)},t.prototype._createOrReplaceAnimation=function(e){return this.animation&&!this.animation.done||(this.animation=new f),this.animation.update(e),this.animation},t.prototype._cancellableGoTo=function(e,t,i){var n=this,r=function(){return e===n._gotoTask},a=i.then((function(){r()&&(n.animation=null)})).catch((function(e){throw r()&&(n.animation=null,t.done||(t.stop(),n.frameTask.animationInProgress=!1)),e})),o=s.create((function(e){return e(a)}));return t.when().catch((function(){r()&&o.cancel&&o.cancel()})),o},t.prototype._gotoImmediate=function(e,t){var i=this,n=this._gotoTask,r=this._createOrReplaceAnimation(e),o=e.then((function(e){if(s.throwIfAborted(t),n!==i._gotoTask)throw new a("view:goto-interrupted","Goto was interrupted");i.viewpoint=r.target=e,r.finish()}));return this._cancellableGoTo(n,r,o)},t.prototype._gotoAnimated=function(e,t){var i=this,n=this._gotoTask,r=this._createOrReplaceAnimation(e),o=e.then((function(e){if(n!==i._gotoTask)throw new a("view:goto-interrupted","Goto was interrupted");return r.update(e),i.animationManager.animate(r,i.viewpoint,t),r.when().then((function(){}),(function(){}))}));return this._cancellableGoTo(n,r,o)},t.prototype._resizeHandler=function(e){var t=this.state;if(t){var i=this.state.paddedViewState.viewpoint,n=this.state.paddedViewState.size.concat();t.size=[e.width,e.height],T.resize(i,i,n,this.state.paddedViewState.size,this.resizeAlign),i=this.constraints.constrain(i,null),this.state.viewpoint=i}},t.prototype._startup=function(){var e=this._getDefaultViewpoint();this.constraints.view=this,this.constraints.fit(e),this._set("animationManager",new _.default({view:this})),this._set("state",new v({padding:this._get("padding"),size:this.size,viewpoint:e})),this._set("featuresTilingScheme",new b.TileInfoView(d.create({spatialReference:this.spatialReference,size:512}))),this._set("ready",!0),this.frameTask&&this.frameTask.start()},t.prototype._teardown=function(){this.frameTask&&this.frameTask.stop(),this._set("ready",!1),this._stationaryTimer&&(clearTimeout(this._stationaryTimer),this._stationaryTimer=null);var e=this.state.paddedViewState,t=e.center,i=t[0],r=t[1],a=e.spatialReference,o=e.rotation,s=e.scale,p=new n.Point({x:i,y:r,spatialReference:a});this._set("viewpoint",null),this._set("extent",null),this._set("center",p),this._set("zoom",-1),this._set("rotation",o),this._set("scale",s),this._set("spatialReference",a),this.constraints.view=null,this.animationManager.destroy(),this._set("animationManager",null),this._set("state",null),this.animation=null},t.prototype._flipStationary=function(e){var t=this;return null!==this._stationaryTimer?this._stationaryTimer:(this._stationaryTimer=setTimeout((function(){t._stationaryTimer=null;var e=performance.now()-t._lastStationaryEventTimestamp;e<160&&(t._stationaryTimer=t._flipStationary(e))}),e),this._stationaryTimer)},t.prototype._normalizeInput=function(e,t){void 0===t&&(t=this.spatialReference);var i=e&&e.targetGeometry||e;return t?i?t.equals(i.spatialReference)?e:u.canProject(i,t)?function(e){return e&&"esri.Viewpoint"===e.declaredClass}(e)?(e.targetGeometry=u.project(i,t),e):u.project(i,t):null:null:e},t.prototype._getDefaultViewpoint=function(){var e=this.constraints,t={zoom:this._get("zoom"),scale:this._get("scale"),center:this._normalizeInput(this._get("center")),extent:this._normalizeInput(this._get("extent")),rotation:this._get("rotation"),viewpoint:this._normalizeInput(this._get("viewpoint")),spatialReference:this._userSpatialReference};e.effectiveLODs?-1!==t.zoom&&(t.scale=e.zoomToScale(t.zoom)):t.zoom=-1;var i=null,n=null,a=0,o=t.viewpoint&&t.viewpoint.rotation,s=t.viewpoint&&t.viewpoint.targetGeometry;s&&("extent"===s.type?i=s:"point"===s.type&&(n=s,a=t.viewpoint.scale));var p=this._normalizeInput(this.get("map.initialViewProperties.viewpoint.targetGeometry.extent")),l=this._normalizeInput(this.initialExtent),c=t.extent||i||p||l,u=t.center||n||c&&c.center,d=this.get("map.initialViewProperties.viewpoint.scale"),h=t.scale||a||d||c&&T.extentToScale(c,this.size),y=this.get("map.initialViewProperties.viewpoint.rotation"),f=t.rotation||o||y||0;return u&&h?new r({targetGeometry:u,scale:h,rotation:f}):null},i.__decorate([c.property()],t.prototype,"_stationaryTimer",void 0),i.__decorate([c.property()],t.prototype,"animation",null),i.__decorate([c.property({readOnly:!0})],t.prototype,"animationManager",void 0),i.__decorate([c.property({value:null,type:n.Point,dependsOn:["state.id","ready"]})],t.prototype,"center",null),i.__decorate([c.property({type:w})],t.prototype,"constraints",null),i.__decorate([c.property({value:null,type:n.Extent,dependsOn:["state.id","ready"]})],t.prototype,"extent",null),i.__decorate([c.property({readOnly:!0})],t.prototype,"featuresTilingScheme",void 0),i.__decorate([c.property()],t.prototype,"fullOpacity",void 0),i.__decorate([c.property()],t.prototype,"graphicsView",void 0),i.__decorate([c.property({type:n.Extent})],t.prototype,"initialExtent",void 0),i.__decorate([c.property({dependsOn:["map.initialViewProperties?.viewpoint"]})],t.prototype,"initialExtentRequired",null),i.__decorate([c.property()],t.prototype,"labelManager",void 0),i.__decorate([c.property({value:{top:0,right:0,bottom:0,left:0},cast:function(e){return i.__assign({top:0,right:0,bottom:0,left:0},e)}})],t.prototype,"padding",null),i.__decorate([c.property({type:Object})],t.prototype,"renderingOptions",void 0),i.__decorate([c.property()],t.prototype,"resizeAlign",void 0),i.__decorate([c.property({readOnly:!0,dependsOn:["state.id"]})],t.prototype,"resolution",null),i.__decorate([c.property({value:0,type:Number,dependsOn:["state.id","ready"]})],t.prototype,"rotation",null),i.__decorate([c.property({value:0,type:Number,dependsOn:["state.id","ready"]})],t.prototype,"scale",null),i.__decorate([c.property({type:n.SpatialReference,dependsOn:["map.initialViewProperties?.spatialReference","defaultsFromMap.isSpatialReferenceDone"]})],t.prototype,"spatialReference",void 0),i.__decorate([c.property({readOnly:!0})],t.prototype,"state",void 0),i.__decorate([c.property({dependsOn:["animation","navigating","resizing","_stationaryTimer"]})],t.prototype,"stationary",null),i.__decorate([c.property({type:V.Timeline,readOnly:!0})],t.prototype,"timeline",void 0),i.__decorate([c.property({readOnly:!0})],t.prototype,"type",void 0),i.__decorate([c.property({readOnly:!0,dependsOn:["layerViewManager.updating","labelManager.updating","graphicsView?.updating"]})],t.prototype,"updating",null),i.__decorate([c.property({value:null,type:r,dependsOn:["state.id","ready"]})],t.prototype,"viewpoint",null),i.__decorate([c.property({value:-1,dependsOn:["state.id"]})],t.prototype,"zoom",null),t=i.__decorate([c.subclass("esri.views.MapViewBase")],t)}(h.PopupView(y))}));