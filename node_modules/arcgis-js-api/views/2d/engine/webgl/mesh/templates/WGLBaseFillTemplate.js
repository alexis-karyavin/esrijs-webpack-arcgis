// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../../core/Logger","../../../../../../core/libs/earcut/earcut","../../definitions","../../enums","../../number","../../TileClipper","../../WGLDisplayRecord","../../materialKey/MaterialKey","../Tesselator"],(function(e,t,r,i,s,n,o,a,h,l,u,p){Object.defineProperty(t,"__esModule",{value:!0});var d=i.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLBaseFillTemplate"),g=[],f=[];t.default=function(e){return function(e){function t(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var i=e.apply(this,t)||this;return i.forceLibtess=!1,i.geometryType=o.WGLGeometryType.FILL,i._tesselator=new p.default,i._tileClipper=new h.TileClipper(0,0,0,1,8),i._tileClipper.setExtent(n.TILE_SIZE),i}return r.__extends(t,e),t.prototype.writeMeshWithGeometry=function(e,t,r,i,s,n){if(g.length=0,"esriGeometryPolygon"===r){var o=n,a=u.FillMaterialKey.load(this._materialKey),h=this._isClippingRequired(o),l=h?this._clip(o,!1):o.rings,p=a.dotDensity?function(e){for(var t=0,r=0;r<e.length;r++)for(var i=e[r],s=i[0],n=s[0],o=s[1],a=1;a<i.length;a++){var h=i[a],l=n+h[0],u=o+h[1];t-=(l-n)*(u+o)/2,n=l,o=u}return t}(o.rings):0;this.forceLibtess?this._writeMeshLibtess(e,t,i,l,h,a,p):this._writeMeshEarcut(e,t,i,l,h,a,p)||this._writeMeshLibtess(e,t,i,l,h,a,p)}else"esriGeometryPolyline"!==r&&d.error("Unable to handle geometryType: "+r)},t.prototype._isClippingRequired=function(e){for(var t=n.TILE_SIZE+8,r=0,i=e.rings;r<i.length;r++){var s=i[r],o=s.length;if(!(o<3)){var a=s[0][0],h=s[0][1];if(a<-8||a>t||h<-8||h>t)return!0;for(var l=1;l<o;++l)if(a+=s[l][0],h+=s[l][1],a<-8||a>t||h<-8||h>t)return!0}}return!1},t.prototype._clip=function(e,t){var r,i;this._tileClipper.reset(3);for(var s=0,n=e.rings;s<n.length;s++){var o=n[s],a=o.length;if(!(a<3)){r=o[0][0],i=o[0][1],this._tileClipper.moveTo(r,i);for(var h=1;h<a;++h)r+=o[h][0],i+=o[h][1],this._tileClipper.lineTo(r,i);this._tileClipper.close()}}return this._tileClipper.result(t)},t.prototype._writeMeshLibtess=function(e,t,r,i,s,n,o){if(i&&i.length){var a=[],h=t.indexVector,u=t.getVector("geometry"),p=new l(r,this.geometryType,this._materialKey),d=u.vertexCount;p.vertexFrom=d,p.indexFrom=h.length,this._tesselator.beginPolygon(g,a);for(var f=0,v=i;f<v.length;f++){var y=v[f];if(!(y.length<3)){this._tesselator.beginContour();var _=void 0,c=void 0;s?(_=y[0].x,c=y[0].y):(_=y[0][0],c=y[0][1]);var x=[_,c,0];this._tesselator.addVertex(x,x);for(var w=1;w<y.length-1;w++){s?(_=y[w].x,c=y[w].y):(_+=y[w][0],c+=y[w][1]);var m=[_,c,0];this._tesselator.addVertex(m,m)}this._tesselator.endContour()}}this._tesselator.endPolygon(),this._writeVerticesLibTess(p,u,r,g,n,o),this._writeIndicesLibTess(p,h,d,a),p.indexCount>0&&e.push(p)}},t.prototype._writeMeshEarcut=function(e,t,r,i,s,n,o){if(i&&i.length){var a=t.indexVector,h=t.getVector("geometry"),u=new l(r,this.geometryType,this._materialKey),p=h.vertexCount,d=a.length,v=h.data.length;u.vertexFrom=p,u.indexFrom=a.length;for(var y=0,_=0,c=0,x=i;c<x.length;c++){var w=x[c],m=_,C=void 0,b=void 0;s?(C=w[0].x,b=w[0].y):(C=w[0][0],b=w[0][1]),g[_++]=C,g[_++]=b;for(var L=0,T=1;T<w.length;++T){var V=void 0,F=void 0;if(s){var I=C,M=b;V=(C=w[T].x)-I,F=(b=w[T].y)-M}else C+=V=w[T][0],b+=F=w[T][1];L-=V*(b+b-F),g[_++]=C,g[_++]=b}if(L>0){if(m-y>0){if(!this._write(u,a,h,r,g,f,y,m,n,o))return a.seek(d),h.data.seek(v),g.length=f.length=0,!1;y=m}f.length=0}else L<0&&m-y>0?f.push(.5*(m-y)):_=m}return _-y>0&&!this._write(u,a,h,r,g,f,y,_,n,o)?(a.seek(d),h.data.seek(v),g.length=f.length=0,!1):(g.length=f.length=0,e.push(u),!0)}},t.prototype._write=function(e,t,r,i,n,o,a,h,l,u){var p=n.slice(a,h),d=s.earcut(p,o,2);if(s.deviation(p,o,2,d)>0)return!1;if(d.length){var g=r.vertexCount;return this._writeVertices(e,r,i,p,l,u),this._writeIndices(e,t,g,d),!0}},t.prototype._writeVertices=function(e,t,r,i,s,n){for(var o=0;o<i.length;o+=2){var h=a.i1616to32(8*i[o],8*i[o+1]);t.data.push(h),t.data.push(r),s.dotDensity?t.data.writeF32(1/n):(t.data.push(this.fillColor),t.data.push(this.tl),t.data.push(this.br),t.data.push(this.aux1),t.data.push(this.aux2),t.data.push(this.aux3)),e.vertexCount++}},t.prototype._writeIndices=function(e,t,r,i){for(var s=r,n=0;n<i.length;n+=3)t.push(s+i[n]),t.push(s+i[n+1]),t.push(s+i[n+2]),e.indexCount+=3},t.prototype._writeVerticesLibTess=function(e,t,r,i,s,n){for(var o=0;o<i.length;o+=2){var h=a.i1616to32(8*i[o],8*i[o+1]);t.data.push(h),t.data.push(r),s.dotDensity?t.data.writeF32(1/n):(t.data.push(this.fillColor),t.data.push(this.tl),t.data.push(this.br),t.data.push(this.aux1),t.data.push(this.aux2),t.data.push(this.aux3)),e.vertexCount++}},t.prototype._writeIndicesLibTess=function(e,t,r,i){for(var s=r,n=0;n<i.length;n++)t.push(s+i[n]),e.indexCount++},t}(e)}}));