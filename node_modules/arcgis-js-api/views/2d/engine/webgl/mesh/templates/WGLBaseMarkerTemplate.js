// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../../core/Logger","../../../../../../core/maybe","../../../../../../core/screenUtils","../../../../../../core/libs/gl-matrix-2/mat2d","../../../../../../core/libs/gl-matrix-2/mat2df32","../../../../../../core/libs/gl-matrix-2/vec2","../../../../../../core/libs/gl-matrix-2/vec2f32","../../../../../../symbols/cim/placements/CIMMarkerPlacementHelper","../../enums","../../number","../../WGLDisplayRecord","./util"],(function(t,e,i,s,r,o,h,n,p,a,u,l,f,c,_){Object.defineProperty(e,"__esModule",{value:!0});var d=s.getLogger("esri.views.2d.engine.webgl.WGLMarkerTemplateBase");e.default=function(t){return function(t){function e(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];var s=t.apply(this,e)||this;return s.angle=0,s.xOffset=0,s.yOffset=0,s.width=0,s.height=0,s.boundsType="square",s._anchorX=0,s._anchorY=0,s._computedWidth=0,s._computedHeight=0,s.geometryType=l.WGLGeometryType.MARKER,s}return i.__extends(e,t),e.prototype.writeMeshWithGeometry=function(t,e,i,s,r,o){var h=e.indexVector,n=e.get("geometry"),p=new c(s,this.geometryType,this._materialKey),a=e.getVector("geometry").vertexCount;if(t.push(p),p.vertexFrom=a,p.indexFrom=h.length,this._markerPlacement)this._writePlacedMarkers(p,n,h,a,s,r,o);else{if(_.isPoint(o)){var u=o.x,l=o.y;return this._writeVertices(p,n,s,this._getPos(u,l)),void this._writeIndices(p,h,a)}if(_.isPolyline(o)){var f=o.paths;this._writeMany(p,h,n,a,s,f[0])}else if(_.isPolygon(o)){var m=r.centroid;if(m){u=m.x,l=m.y;this._writeVertices(p,n,s,this._getPos(u,l)),this._writeIndices(p,h,a)}else d.error("Tried to render polygon geometries as markers, but found no centroid!")}else if(_.isMultipoint(o)){var g=o.points;this._writeMany(p,h,n,a,s,g)}else;}},e.prototype._applyTransformation=function(t,e,i){void 0===i&&(i=0),h.mat2d.identity(t),h.mat2d.translate(t,t,a.vec2f32.fromValues(this.xOffset,-this.yOffset)),this.angle+i!==0&&h.mat2d.rotate(t,t,3.14159265359/180*(this.angle+i));var s=this._computedWidth,r=this._computedHeight,o=(this._anchorX-.5)*s,n=(this._anchorY-.5)*r;p.vec2.set(e,o,n),p.vec2.transformMat2d(e,e,t),this._offsetUpperLeft=f.i1616to32(16*e[0],16*e[1]),p.vec2.set(e,o+s,n),p.vec2.transformMat2d(e,e,t),this._offsetUpperRight=f.i1616to32(16*e[0],16*e[1]),p.vec2.set(e,o,n+r),p.vec2.transformMat2d(e,e,t),this._offsetBottomLeft=f.i1616to32(16*e[0],16*e[1]),p.vec2.set(e,o+s,n+r),p.vec2.transformMat2d(e,e,t),this._offsetBottomRight=f.i1616to32(16*e[0],16*e[1])},e.prototype._writePlacedMarkers=function(t,e,i,s,h,p,l){var f=u.CIMMarkerPlacementHelper.getPlacement(l,r.unwrap(this._markerPlacement),o.pt2px(1));if(f)for(var c=a.vec2f32.create(),_=n.mat2df32.create(),d=0,m=f.next();null!=m;)m.tx>=-128&&m.tx<=640&&m.ty>=-128&&m.ty<=640&&(this._applyTransformation(_,c,m.getAngle()/(3.14159265359/180)),this._writeVertices(t,e,h,this._getPos(m.tx,m.ty)),this._writeIndices(t,i,s+d),d+=4),m=f.next()},e.prototype._getPos=function(t,e){return f.i1616to32(Math.round(8*t),Math.round(8*e))},e.prototype._writeMany=function(t,e,i,s,r,o){for(var h=0,n=0,p=0,a=0,u=o;a<u.length;a++){var l=u[a],f=l[0],c=l[1],_=this._getPos(f+h,c+n);this._writeVertices(t,i,r,_),this._writeIndices(t,e,s+p),h+=f,n+=c,p+=4}},e.prototype._writeVertices=function(t,e,i,s){e.push(s),e.push(this._offsetUpperLeft),e.push(this._texUpperLeft),e.push(this._bitestAndDistRatio),e.push(i),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),e.push(s),e.push(this._offsetUpperRight),e.push(this._texUpperRight),e.push(this._bitestAndDistRatio),e.push(i),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),e.push(s),e.push(this._offsetBottomLeft),e.push(this._texBottomLeft),e.push(this._bitestAndDistRatio),e.push(i),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),e.push(s),e.push(this._offsetBottomRight),e.push(this._texBottomRight),e.push(this._bitestAndDistRatio),e.push(i),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),t.vertexCount+=4},e.prototype._writeIndices=function(t,e,i){var s=i;e.push(s+0),e.push(s+1),e.push(s+2),e.push(s+1),e.push(s+3),e.push(s+2),t.indexCount+=6},e}(t)}}));