// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/maybe","../../../../../../core/screenUtils","../../../../../../core/libs/gl-matrix-2/mat2df32","../../../../../../core/libs/gl-matrix-2/vec2f32","../../color","../../number","../../materialKey/MaterialKey","./util","./WGLBaseMarkerTemplate","./WGLDynamicMeshTemplate","../../util/Result"],(function(t,e,i,r,a,s,o,n,c,l,h,f,p,u,_,m){Object.defineProperty(e,"__esModule",{value:!0});var y=c.vec2f32.create(),d=n.mat2df32.create(),M=a.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate"),g=function(t){function e(e,i){var r=t.call(this,i)||this;if(r._cimMarkerLayer=i,p.isFunction(i.color)){r._dynamicPropertyMap.set("_fillColor",(function(t,e,r){return l.premultiplyAlphaRGBA(i.color(t,e,r))}))}else r._fillColor=l.premultiplyAlphaRGBA(i.color);if(p.isFunction(i.outlineColor)){r._dynamicPropertyMap.set("_outlineColor",(function(t,e,r){return l.premultiplyAlphaRGBA(i.outlineColor(t,e,r))}))}else r._outlineColor=l.premultiplyAlphaRGBA(i.outlineColor);if(p.isFunction(i.size)){r._dynamicPropertyMap.set("_size",(function(t,e,r){return o.pt2px(i.size(t,e,r))}))}else r._size=o.pt2px(i.size);if(p.isFunction(i.scaleX)?r._dynamicPropertyMap.set("_scaleX",i.scaleX):r._scaleX=i.scaleX,p.isFunction(i.offsetX)){r._dynamicPropertyMap.set("xOffset",(function(t,e,r){return o.pt2px(i.offsetX(t,e,r))}))}else r.xOffset=o.pt2px(i.offsetX);if(p.isFunction(i.offsetY)){r._dynamicPropertyMap.set("yOffset",(function(t,e,r){return o.pt2px(i.offsetY(t,e,r))}))}else r.yOffset=o.pt2px(i.offsetY);if(p.isFunction(i.outlineWidth)){r._dynamicPropertyMap.set("_outlineWidth",(function(t,e,r){return o.pt2px(i.outlineWidth(t,e,r))}))}else r._outlineWidth=o.pt2px(i.outlineWidth);return p.isFunction(i.rotation)?r._dynamicPropertyMap.set("_angle",i.rotation):r._angle=i.rotation,r._scaleFactor=s.unwrapOr(i.scaleFactor,1),r._markerPlacement=i.markerPlacement,r.effects=i.effects,r._bitSet=(1===i.alignment?1:0)|(i.colorLocked?1:0)<<1|(i.scaleSymbolsProportionally?1:0)<<3,r._materialKey=f.createMaterialKey(r.geometryType,e,!1),r}return i.__extends(e,t),e.fromCIMMarker=function(t,i){return new e(t,i)},e.prototype.bindFeature=function(t,e,i){var a=this;this._dynamicPropertyMap.forEach((function(r,s){a[s]=r(t,e,i)}));var s=this._cimMarkerLayer.materialHash,n="function"==typeof s?s(t,e,i):s,c=this._materialCache.get(n);if(c&&m.ok(c.spriteMosaicItem)&&c.spriteMosaicItem){var l=c.spriteMosaicItem,p=this._cimMarkerLayer.sizeRatio,u=l.width/l.height*this._scaleX,_=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle,g=this._size,x=g*u,k=this.xOffset,L=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;var P=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/o.pt2px(this._cimMarkerLayer.frameHeight):1,b=this._outlineWidth*P,F=o.pt2px(this._cimMarkerLayer.referenceSize),v=0,w=0,z=this._cimMarkerLayer.anchorPoint;z&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(v=-z.x/(this._size*u),w=z.y/this._size):(v=z.x,w=z.y)),this._sizeOutlineWidth=h.i8888to32(Math.round(Math.min(Math.sqrt(128*x),255)),Math.round(Math.min(Math.sqrt(128*g),255)),Math.round(Math.min(Math.sqrt(128*b),255)),Math.round(Math.min(Math.sqrt(128*F),255))),this.angle=_;var O=Math.round(Math.min(64*p,255));this._bitestAndDistRatio=h.i8888to32(0,0,this._bitSet,O);var A=l.rect.x,W=l.rect.y,C=A+l.rect.width,X=W+l.rect.height;this._texUpperLeft=h.i1616to32(A,W),this._texUpperRight=h.i1616to32(C,W),this._texBottomLeft=h.i1616to32(A,X),this._texBottomRight=h.i1616to32(C,X);var B=f.MarkerMaterialKey.load(this._materialKey);B.sdf=l.sdf,B.pattern=!0,B.textureBinding=l.textureBinding,this._materialKey=B.data,this._anchorX=.5-((.5+v)*l.width+1)/l.rect.width,this._anchorY=.5-((.5+w)*l.height+1)/l.rect.height,x*=p,g*=p,x*=this._scaleFactor,g*=this._scaleFactor,x*=l.rect.width/l.width,g*=l.rect.height/l.height,this._computedWidth=x,this._computedHeight=g,this._applyTransformation(d,y),this.xOffset=k,this.yOffset=L}else M.error(new r("mapview-cim","Encountered an error when binding feature"))},e}(u.default(_.default));e.default=g}));