// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../core/Error","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../support/arcadeOnDemand","../../../../../symbols/cim/cimSymbolUtils","../../../../../symbols/cim/utils","../../../arcade/utils"],(function(e,t,r,n,i,a,s,l,o,u,c){Object.defineProperty(t,"__esModule",{value:!0});var f=i.getLogger("esri/views/2d/engine/webgl/util/Matcher"),p=function(){function e(){this._defaultResult=null}return e.fromBasicRenderer=function(t,n,i){return r.__awaiter(this,void 0,void 0,(function(){var a,s,l;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,o.expandSymbols(t.getSymbols(),i)];case 1:return a=r.sent(),s=new e,a.length?[4,n.createTemplateGroup(a[0],null,t)]:[3,3];case 2:l=r.sent(),s.setDefault(l),r.label=3;case 3:return[2,s]}}))}))},e.prototype.size=function(){return 1},e.prototype.getDefault=function(){return this._defaultResult},e.prototype.setDefault=function(e){this._defaultResult=e},e.prototype.match=function(e,t,r,n,i){return this.getDefault()},e.prototype.analyze=function(e,t,n,i,a){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2]}))}))},e}();t.FeatureMatcher=p;var h=function(e){function t(t,r,n,i){var a=e.call(this)||this;return a._intervals=[],a._isMaxInclusive=r,i?a._getValue=c.callWithFeature.bind(null,i):t&&t.length?"function"==typeof t?(a._field=null,a._getValue=t):(a._field=t,a._normalizationInfo=n,a._getValue=a._getValueFromField.bind(a)):a._field=null,a}return r.__extends(t,e),t.fromCBRenderer=function(e,n,i){return r.__awaiter(this,void 0,void 0,(function(){var a,u,c,f,p,h,_,d,m,v,y,b,g=this;return r.__generator(this,(function(w){switch(w.label){case 0:return a=e.isMaxInclusive,u=e.normalizationField,c=e.normalizationTotal,f=e.normalizationType,p=e.field,h={normalizationField:u,normalizationTotal:c,normalizationType:f},_=e.valueExpression,(d=_)?[4,l.createRendererExpression(_,i.spatialReference,i.fields)]:[3,2];case 1:d=w.sent(),w.label=2;case 2:return m=new t(p,a,h,d),[4,o.expandSymbol(e.backgroundFillSymbol,i)];case 3:return v=w.sent(),[4,s.all(e.classBreakInfos.map((function(t){return r.__awaiter(g,void 0,void 0,(function(){var a,s,l;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,o.expandSymbol(t.symbol,i)];case 1:return a=r.sent(),[4,n.createTemplateGroup(a,v,e)];case 2:return s=r.sent(),l={min:t.minValue,max:t.maxValue},m.add(l,s),[2]}}))}))})))];case 4:return w.sent(),[4,o.expandSymbol(e.defaultSymbol,i)];case 5:return(y=w.sent())?[4,n.createTemplateGroup(y,v,e)]:[3,7];case 6:b=w.sent(),m.setDefault(b),w.label=7;case 7:return[2,m]}}))}))},t.prototype.add=function(e,t){this._intervals.push({interval:e,result:t}),this._intervals.sort((function(e,t){return e.interval.min-t.interval.min}))},t.prototype.size=function(){return e.prototype.size.call(this)+this._intervals.length},t.prototype.match=function(e,t,r,n,i){if(!this._getValue)return this.getDefault();var a=this._getValue(t,{$view:i},r,n);if(!a&&(null==a||isNaN(a)))return this.getDefault();for(var s=0;s<this._intervals.length;s++){var l=this._intervals[s],o=l.interval,u=l.result,c=a>=o.min,f=this._isMaxInclusive?a<=o.max:a<o.max;if(c&&f)return u}return this.getDefault()},t.prototype._needsNormalization=function(){var e=this._normalizationInfo;return e&&(e.normalizationField||e.normalizationTotal||e.normalizationType)},t.prototype._getValueFromField=function(e){var t=e.attributes[this._field];if(!this._needsNormalization())return t;var r=this._normalizationInfo,n=r.normalizationField,i=r.normalizationTotal,a=r.normalizationType,s=!!n&&e.attributes[n];if(a)switch(a){case"field":return s?t/s:void 0;case"log":return Math.log(t)*Math.LOG10E;case"percent-of-total":return t/i*100;default:return void f.error("Found unknown normalization type: "+a)}else f.error("Normalization is required, but no type was set!")},t}(p);t.IntervalMatcher=h;var _=function(e){function t(t,r,n){var i=e.call(this)||this;return i._nullResult=null,i._resultsMap=new Map,n?i._getValue=c.callWithFeature.bind(null,n):t&&t.length?"function"==typeof t[0]?(i._fields=null,i._getValue=t[0]):(i._fields=t,i._seperator=r||"",i._getValue=i._getValueFromFields.bind(i)):i._fields=null,i}return r.__extends(t,e),t.fromUVRenderer=function(e,n,i){return r.__awaiter(this,void 0,void 0,(function(){var a,u,c,f,p,h,_,d,m,v=this;return r.__generator(this,(function(y){switch(y.label){case 0:return a=e.uniqueValueInfos,u=e.fieldDelimiter,c=[e.field],f=e.valueExpression,e.field2&&c.push(e.field2),e.field3&&c.push(e.field3),[4,o.expandSymbol(e.backgroundFillSymbol,i)];case 1:return p=y.sent(),(h=f)?[4,l.createRendererExpression(f,i.spatialReference,i.fields)]:[3,3];case 2:h=y.sent(),y.label=3;case 3:return _=new t(c,u,h),[4,s.all(a.map((function(t){return r.__awaiter(v,void 0,void 0,(function(){var a,s;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,o.expandSymbol(t.symbol,i)];case 1:return a=r.sent(),[4,n.createTemplateGroup(a,p,e)];case 2:return s=r.sent(),"<Null>"===t.value?_.setNullResult(s):_.add(t.value,s),[2]}}))}))})))];case 4:return y.sent(),[4,o.expandSymbol(e.defaultSymbol,i)];case 5:return(d=y.sent())?[4,n.createTemplateGroup(d,p,e)]:[3,7];case 6:m=y.sent(),_.setDefault(m),y.label=7;case 7:return[2,_]}}))}))},t.prototype.setNullResult=function(e){this._nullResult=e},t.prototype.add=function(e,t){this._resultsMap.set(e.toString(),t)},t.prototype.size=function(){return e.prototype.size.call(this)+this._resultsMap.size},t.prototype.match=function(e,t,r,n,i){if(!this._getValue)return this.getDefault();var a=this._getValue(t,{$view:i},r,n);if(null!==this._nullResult&&(null==a||""===a||"<Null>"===a))return this._nullResult;if(!a&&null==a)return this.getDefault();var s=a.toString();return this._resultsMap.has(s)?this._resultsMap.get(s):this.getDefault()},t.prototype._getValueFromFields=function(e){for(var t=[],r=0,n=this._fields;r<n.length;r++){var i=n[r],a=e.attributes[i];t.push(a)}return t.join(this._seperator)},t}(p);function d(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i;return r.__generator(this,(function(r){switch(r.label){case 0:return"number"==typeof(n=e||1)?[2,function(e,t,r){return n}]:[4,l.createRendererExpression(n,t.spatialReference,t.fields)];case 1:return i=r.sent(),[2,function(e,r,n){return c.callWithFeature(i,e,{$view:n},t.geometryType,r)||1}]}}))}))}t.MapMatcher=_;var m=function(e){function t(t,r,n,i){var a=e.call(this)||this;return a._fidToAttributeHash=new Map,a._attributeHashToGroup=new Map,a._renderer=t,a._fieldMap=t.fieldMap,a._templates=r,a._info=n,a._scaleFn=i,a}return r.__extends(t,e),t.fromDictionaryRenderer=function(e,n,i){return r.__awaiter(this,void 0,void 0,(function(){var a;return r.__generator(this,(function(r){switch(r.label){case 0:return e.fetchResources({spatialReference:i.spatialReference,fields:i.fields}),[4,d(e.scaleExpression,i)];case 1:return a=r.sent(),[2,new t(e,n,i,a)]}}))}))},t.prototype._analyzeFeature=function(e,t,i,a,s){return r.__awaiter(this,void 0,void 0,(function(){var l,c,p,h,_,d,m,v,y,b,g;return r.__generator(this,(function(w){switch(w.label){case 0:return l=e.attributes[t],c=this._fidToAttributeHash.get(l),p=this._hashAttributes(e),c===p?[2]:this._attributeHashToGroup.has(p)?[3,4]:(h=r.__assign(r.__assign({},a),{spatialReference:this._info.spatialReference,abortOptions:s,fields:this._info.fields}),_=this._scaleFn(e,i,a),[4,this._renderer.getSymbolAsync(e,h)]);case 1:return d=w.sent(),[4,o.expandSymbol(d,this._info,s)];case 2:if("expanded-cim"!==(m=w.sent()).type)return f.error(new n("mapview-bad-type","Found unexpected type "+m.type+" in dictionary response")),[2];for(v=0,y=m.layers;v<y.length;v++)(b=y[v]).scaleFactor=_,b.templateHash+="-"+_,"text"===b.type&&"string"==typeof b.text&&b.text.indexOf("[")>-1&&(b.text=u.createLabelOverrideFunction(this._fieldMap,b.text,b.cim.textCase));return[4,this._templates.createTemplateGroup(m,null,this._renderer)];case 3:g=w.sent(),this._attributeHashToGroup.set(p,g),w.label=4;case 4:return this._fidToAttributeHash.set(l,p),[2]}}))}))},t.prototype.analyze=function(e,t,n,i,a){return r.__awaiter(this,void 0,void 0,(function(){var l,o=this;return r.__generator(this,(function(r){switch(r.label){case 0:return l=t.map((function(t){return o._analyzeFeature(t,e,n,i,a)})),[4,s.all(l)];case 1:return r.sent(),[2]}}))}))},t.prototype.match=function(e,t){var r=t.attributes[e],n=this._fidToAttributeHash.get(r);return this._attributeHashToGroup.get(n)},t.prototype._hashAttributes=function(e){var t="";for(var r in this._fieldMap)t+=". "+e.attributes[this._fieldMap[r]];return t},t}(p);t.DictionaryMatcher=m;var v=function(e){function t(t){var r=e.call(this)||this;return r._templates=t,r}return r.__extends(t,e),t.prototype.match=function(e,t){return a.isNone(t.symbol)?0:t.groupId?t.groupId:this._templates.createTemplateGroup(t.symbol,null,null)},t}(p);t.GraphicMatcher=v}));