// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../core/libs/gl-matrix-2/mat3f32","../../../../../core/libs/gl-matrix-2/vec4f32","../../../../webgl","../definitions","../enums","../number","./WGLBrush"],(function(t,e,r,i,a,o,l,n,s,u){Object.defineProperty(e,"__esModule",{value:!0});var f=[1,1,1,1],d=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._fillVertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:4,normalized:!1,divisor:0}]},e._fillVertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:8,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:4,stride:8,normalized:!0,divisor:0}]},e._outlineVertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:8,normalized:!1,divisor:0},{name:"a_offset",count:2,type:5120,offset:4,stride:8,normalized:!1,divisor:0},{name:"a_xnormal",count:2,type:5120,offset:6,stride:8,normalized:!1,divisor:0}]},e._outlineVertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:12,normalized:!1,divisor:0},{name:"a_offset",count:2,type:5120,offset:4,stride:12,normalized:!1,divisor:0},{name:"a_xnormal",count:2,type:5120,offset:6,stride:12,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:8,stride:12,normalized:!0,divisor:0}]},e._color=a.vec4f32.create(),e._outlineColor=a.vec4f32.create(),e._fillProgramOptions={id:!1,dd:!1,pattern:!1},e._outlineProgramOptions={id:!1,dd:!1},e._patternMatrix=i.mat3f32.create(),e}return r.__extends(e,t),e.prototype.dispose=function(){},e.prototype.drawMany=function(t,e){var r=t.displayLevel,i=t.drawPhase,a=t.renderPass,o=t.styleLayerId,l=t.styleLayer,u=l.getPaintValue("fill-pattern",r),d=l.hasDataDrivenColor?f:l.getPaintValue("fill-color",r),_=l.hasDataDrivenOpacity?1:l.getPaintValue("fill-opacity",r),c=_*d[3],m=void 0!==u||c<1||l.hasDataDrivenFill;if(!m||"opaque"!==a){var v;this._color[0]=c*d[0],this._color[1]=c*d[1],this._color[2]=c*d[2],this._color[3]=c,i===n.WGLDrawPhase.HITTEST&&(v=s.u32to4Xu8(o+1));var p=l.getPaintValue("fill-translate",r),y=l.getPaintValue("fill-translate-anchor",r);this._drawFill(t,o,l,e,p,y,u,m,v),this._drawOutline(t,o,l,e,p,y,u,v,_)}},e.prototype._drawFill=function(t,e,r,i,a,o,s,u,f){var d=t.context,_=t.displayLevel,c=t.drawPhase,m=t.pixelRatio,v=t.renderPass,p=t.spriteMosaic,y=t.state;if(u||"translucent"!==v){var h,x=void 0!==s,g=m>l.VTL_HIGH_RES_CUTOFF?2:1,V=r.hasDataDrivenFill,D=t.painter.getVectorTileProgramCach(),b=c===n.WGLDrawPhase.HITTEST,O=(b?1:0)<<2|(V?1:0)<<1|(x?1:0),A=this._fillProgramOptions;A.id=b,A.dd=V,A.pattern=x;var P=D.getProgram(1,O,A);if(d.bindProgram(P),x){if(!(h=p.getMosaicItemPosition(s,!0)))return void d.bindProgram();P.setUniform2f("u_pattern_tl",h.tl[0],h.tl[1]),P.setUniform2f("u_pattern_br",h.br[0],h.br[1]),P.setUniform1i("u_texture",l.VTL_TEXTURE_BINDING_UNIT_SPRITES),p.bind(d,9729,h.page,l.VTL_TEXTURE_BINDING_UNIT_SPRITES)}P.setUniformMatrix3fv("u_displayMat3",1===o?y.displayMat3:y.displayViewMat3),P.setUniform2fv("u_fillTranslation",a),P.setUniform1f("u_depth",r.z+1/65536),P.setUniform4fv("u_color",this._color),b&&P.setUniform4fv("u_id",f);for(var T=0,M=i;T<M.length;T++){var C=M[T];if(C.layerData[e]){var U=this._getFillVAO(d,C,V,D);if(U){var w=C.layerData[e];if(d.bindVAO(U),P.setUniformMatrix3fv("u_dvsMat3",C.transforms.dvs),x){var j=Math.max(Math.pow(2,Math.round(_)-C.key.level),1),E=C.coordRange[0]/(g*C.size[0]*j),I=1/(h.size[0]*E),z=1/(h.size[1]*E);this._patternMatrix[0]=I,this._patternMatrix[4]=z,P.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}d.setStencilFunction(514,C.stencilRef,255),d.drawElements(4,w.triangleElementCount,5125,12*w.triangleElementStart),C.triangleCount+=w.triangleElementCount/3}}}}},e.prototype._drawOutline=function(t,e,r,i,a,o,l,s,u){var d=t.context,_=t.displayLevel,c=t.drawPhase,m=t.renderPass,v=t.pixelRatio,p=t.state;if("opaque"!==m){var y=void 0!==l;if(r.getPaintValue("fill-antialias",_)&&!y||r.hasDataDrivenOutlineColor){var h=t.painter.getVectorTileProgramCach(),x=r.hasDataDrivenOutline;if(r.outlineUsesFillColor){if(1!==this._color[3])return;this._outlineColor[0]=this._color[0],this._outlineColor[1]=this._color[1],this._outlineColor[2]=this._color[2],this._outlineColor[3]=this._color[3]}else{var g=r.hasDataDrivenOutlineColor?f:r.getPaintValue("fill-outline-color",_),V=u*g[3];this._outlineColor[0]=V*g[0],this._outlineColor[1]=V*g[1],this._outlineColor[2]=V*g[2],this._outlineColor[3]=V}var D=.75/v,b=c===n.WGLDrawPhase.HITTEST,O=(b?1:0)<<1|(x?1:0),A=this._outlineProgramOptions;A.id=b,A.dd=x;var P=h.getProgram(2,O,A);d.bindProgram(P),P.setUniformMatrix3fv("u_displayMat3",1===o?p.displayMat3:p.displayViewMat3),P.setUniform2fv("u_fillTranslation",a),P.setUniform1f("u_depth",r.z+1/65536),P.setUniform1f("u_outline_width",D),P.setUniform4fv("u_color",this._outlineColor),b&&P.setUniform4fv("u_id",s);for(var T=0,M=i;T<M.length;T++){var C=M[T];if(C.layerData[e]){var U=C.layerData[e],w=this._getOutlineVAO(d,C,x,h);w&&(d.bindVAO(w),P.setUniformMatrix3fv("u_dvsMat3",C.transforms.dvs),d.setStencilFunction(514,C.stencilRef,255),d.drawElements(4,U.outlineElementCount,5125,12*U.outlineElementStart),C.triangleCount+=U.outlineElementCount/3)}}}}},e.prototype._getFillVAO=function(t,e,r,i){if(r){if(e.fillDDVertexArrayObject)return e.fillDDVertexArrayObject;var a=e.fillDDVertexBuffer,l=e.fillIndexBuffer;return a&&l?(e.fillDDVertexArrayObject=new o.VertexArrayObject(t,i.getProgramAttributes(1),this._fillVertexAttributesDD,{geometry:a},l),e.fillDDVertexArrayObject):null}if(e.fillVertexArrayObject)return e.fillVertexArrayObject;var n=e.fillVertexBuffer,s=e.fillIndexBuffer;return n&&s?(e.fillVertexArrayObject=new o.VertexArrayObject(t,i.getProgramAttributes(1),this._fillVertexAttributes,{geometry:n},s),e.fillVertexArrayObject):null},e.prototype._getOutlineVAO=function(t,e,r,i){if(r){if(e.outlineDDVertexArrayObject)return e.outlineDDVertexArrayObject;var a=e.outlineDDVertexBuffer,l=e.outlineIndexBuffer;return a&&l?(e.outlineDDVertexArrayObject=new o.VertexArrayObject(t,i.getProgramAttributes(2),this._outlineVertexAttributesDD,{geometry:a},l),e.outlineDDVertexArrayObject):null}if(e.outlineVertexArrayObject)return e.outlineVertexArrayObject;var n=e.outlineVertexBuffer,s=e.outlineIndexBuffer;return n&&s?(e.outlineVertexArrayObject=new o.VertexArrayObject(t,i.getProgramAttributes(2),this._outlineVertexAttributes,{geometry:n},s),e.outlineVertexArrayObject):null},e}(u.default);e.WGLBrushVTLFill=d}));