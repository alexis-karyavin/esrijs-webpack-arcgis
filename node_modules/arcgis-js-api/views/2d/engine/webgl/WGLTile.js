// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/libs/gl-matrix-2/mat2d","../../../../core/libs/gl-matrix-2/mat2df32","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f32","./definitions","./DirtyMap","./DisplayRecordStore","./Fader","./TiledDisplayObject","./WGLBuffers"],(function(t,e,a,i,s,r,l,d,o,p,n,y,h){Object.defineProperty(e,"__esModule",{value:!0});var c=new Set,f=function(t){function e(e,a,i){void 0===i&&(i=!1);var r=t.call(this,e,a,[d.TILE_SIZE,d.TILE_SIZE])||this;return r._data=null,r._displayList=null,r._wglBuffers=null,r._dirtyMap=new o.default,r._labelIndex=null,r._dirty=!0,r.fader=new n.default,r._ensureCorrectZOrder=i,r.transforms.labelMat2d=s.mat2df32.create(),r}return a.__extends(e,t),e.prototype.destroy=function(){this.clear()},Object.defineProperty(e.prototype,"displayObjects",{get:function(){return this._data.tileDisplayData.displayObjects},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._dirty},set:function(t){this._dirty=t,t||this.isReady||this.ready(),this.requestRender()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasData",{get:function(){return!!this._data},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"labelIndex",{get:function(){return this._labelIndex},enumerable:!0,configurable:!0}),e.prototype.getGeometry=function(t){return this._wglBuffers&&this._wglBuffers.has(t)?this._wglBuffers.get(t):null},e.prototype.getDisplayList=function(){return this._data&&this._displayList},Object.defineProperty(e.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0}),e.prototype.setTransform=function(e,a){t.prototype.setTransform.call(this,e,a);var s=this.transforms.labelMat2d,d=e.getScreenTransform(s,a),o=l.vec2f32.create();r.vec2.transformMat2d(o,this.coords,d),i.mat2d.identity(s),i.mat2d.translate(s,s,o),i.mat2d.multiply(s,e.viewMat2d,s)},e.prototype.setData=function(t,e,a){var i=t.addOrUpdate,s=t.remove;if((t.clear||!this.hasData)&&!t.addOrUpdate)return this.clear(),this.ready(),void this.emit("change");!t.clear&&this.hasData||!t.addOrUpdate?this.hasData&&this._doPatchData({addOrUpdate:i,remove:s},e,a):(i.tileDisplayData.computeDisplayList(this._ensureCorrectZOrder),this._dirtyMap=new o.default,this._dispRecStore=p.default.fromTileData(i,this._dirtyMap),this._data=i,this._readyTileIfNoLabels(e,a),this._dirtyMap.markAllDirty(),this._displayList||(this._displayList=i.tileDisplayData.displayList.clone())),this.emit("change")},e.prototype.commitChanges=function(){this.fader.step()||this.requestRender(),this._wglBuffers||(this._wglBuffers=new h.default(this.stage.context)),this._wglBuffers.upload(this._data.tileBufferData,this._dirtyMap),this._displayList=this._data.tileDisplayData.displayList.clone(),this._dirtyMap.markAllClean()},e.prototype.clear=function(){this._data=null,this._displayList=null,this._dispRecStore=null,this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null)},e.prototype._readyTileIfNoLabels=function(t,e){t&&this._rebuildLabelIndex(),this.isDirty=!(!t||!e)},e.prototype._doPatchData=function(t,e,a){this._patchData(t)||(this._dirtyMap.markAllDirty(),this._data.reshuffle(),this._dispRecStore=p.default.fromTileData(this._data,this._dirtyMap)),this._readyTileIfNoLabels(e,a),this.requestRender()},e.prototype._rebuildLabelIndex=function(){this._labelIndex=this._initLabelIndex();for(var t=0,e=this.displayObjects;t<e.length;t++)for(var a=0,i=e[t].metrics;a<i.length;a++){var s=i[a];this._insertIntoLabelIndex(s)}},e.prototype._insertIntoLabelIndex=function(t){t.xBucket<0||t.yBucket<0||t.yBucket>3||t.xBucket>3||this.labelIndex[t.yBucket][t.xBucket].push(t)},e.prototype._initLabelIndex=function(){for(var t=[],e=0;e<d.TILE_SIZE/d.COLLISION_BUCKET_SIZE;e++){t.push([]);for(var a=0;a<d.TILE_SIZE/d.COLLISION_BUCKET_SIZE;a++)t[e].push([])}return t},e.prototype._patchData=function(t){for(var e=!0,a=t.addOrUpdate&&t.addOrUpdate.tileDisplayData&&t.addOrUpdate.tileDisplayData.displayObjects||[],i=(t.remove||[]).slice(),s=0,r=a;s<r.length;s++){null!=(D=r[s]).insertAfter&&i.push(D.id)}for(var l=0,d=i;l<d.length;l++){var o=d[l];if(_=this._data.tileDisplayData.displayObjectRegistry.get(o)){this._data.tileDisplayData.displayList.removeFromList(_.displayRecords);for(var p=0,n=_.displayRecords;p<n.length;p++){var y=n[p];this._dispRecStore.delete(y)}this._data.tileDisplayData.displayObjectRegistry.delete(o);var h=this._data.tileDisplayData.displayObjects.indexOf(_);this._data.tileDisplayData.displayObjects.splice(h,1)}}for(var f=0,u=a;f<u.length;f++){var _,D=u[f],g=void 0;if(_=this._data.tileDisplayData.displayObjectRegistry.get(D.id)){var m=_.displayRecords;_.set(D),_.displayRecords=m;for(var b=_.displayRecords.length,v=0;v<b;++v){var L=_.displayRecords[v],O=D.displayRecords[v];(v>=D.displayRecords.length||L.geometryType!==O.geometryType||L.symbolLevel!==O.symbolLevel||L.zOrder!==O.zOrder||L.materialKey!==O.materialKey)&&(this._dispRecStore.delete(_.displayRecords[v]),v<D.displayRecords.length&&(_.displayRecords[v]=void 0))}_.displayRecords.length=D.displayRecords.length,_.metrics=D.metrics}else{(_=D.copy()).displayRecords=[],this._data.tileDisplayData.displayObjectRegistry.set(D.id,_);var R=void 0,I=this._data.tileDisplayData.displayObjects;if(null!=_.insertAfter)if(g={},_.insertAfter>=0){var x=this._data.tileDisplayData.displayObjectRegistry.get(_.insertAfter);x&&(R=I.indexOf(x)+1)<I.length?I.splice(R,0,_):(I.push(_),R=I.length)}else I.unshift(_),R=0;else I.push(_),R=I.length;if(g){var T=void 0;if(this._data.tileDisplayData.displayList.unified)T=D.displayRecords.length>0?1:0;else{c.clear();for(var B=0,j=D.displayRecords;B<j.length;B++){var S=j[B],w=this._data.tileDisplayData.displayList.getDPInfoType(S.geometryType);c.add(w)}T=c.size}var M=0;for(v=R-1;v>=0&&M<T;--v)for(var E=I[v].displayRecords.length-1;E>=0&&M<T;--E){var P=I[v].displayRecords[E];g[w=this._data.tileDisplayData.displayList.getDPInfoType(P.geometryType)]||(g[w]=P,++M)}}}var U=D.displayRecords.length;for(v=0;v<U;++v){O=D.displayRecords[v];(L=_.displayRecords[v])?(L.meshData=O.meshData,L.materialKey=O.materialKey):((L=O.copy()).vertexFrom=void 0,L.indexFrom=void 0,_.displayRecords[v]=L);var k=O.geometryType,A=(w=this._data.tileDisplayData.displayList.getDPInfoType(k),t.addOrUpdate.tileBufferData.geometries[k]),C=A.vertexBuffer,Z=A.indexBuffer,F=void 0;g&&(F=g[w]?this._data.tileDisplayData.displayList.splitAfter(g[w]):-1),e=this._dispRecStore.setMeshData(L,O,C,Z,F)&&e,g&&null!=L.indexFrom&&null!=L.indexFrom&&(g[w]=L)}}return e},e}(y.TiledDisplayObject);e.WGLTile=f}));