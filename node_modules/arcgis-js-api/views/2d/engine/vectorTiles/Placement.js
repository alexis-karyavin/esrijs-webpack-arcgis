// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","./Conflict","./GeometryUtils","./TextShaping","../webgl/Geometry"],(function(t,e,i,n,o,a){Object.defineProperty(e,"__esModule",{value:!0});var r=function(t,e,i,n,o){void 0===i&&(i=0),void 0===n&&(n=-1),void 0===o&&(o=c),this.x=t,this.y=e,this.angle=i,this.segment=n,this.minzoom=o};e.Anchor=r;var h=function(t,e,i,o,a,r,h){void 0===r&&(r=c),void 0===h&&(h=n.C_INFINITY),this.anchor=t,this.labelAngle=e,this.glyphAngle=i,this.page=o,this.alternateVerticalGlyph=a,this.minzoom=r,this.maxzoom=h},l=function(t,e,i,n,o,a,r,h,l,s,c,g){this.tl=t,this.tr=e,this.bl=i,this.br=n,this.mosaicRect=o,this.labelAngle=a,this.minAngle=r,this.maxAngle=h,this.anchor=l,this.minzoom=s,this.maxzoom=c,this.page=g};e.PlacedSymbol=l;var s=function(t,e){this.footprint=t,this.shapes=e};e.Placement=s;var c=.5,g=function(){function t(){this.mapAngle=0,this._conflictEngine=new i.ConflictEngine}return t.prototype.reset=function(){this._conflictEngine.reset()},t.prototype.setAngle=function(t){this.mapAngle=t},t.prototype.getIconPlacement=function(t,e,o,r,h){var g=o.width/o.pixelRatio,p=o.height/o.pixelRatio,w=h.offset[0]-g/2,d=h.offset[1]-p/2,f=w+g,v=d+p,m=o.rect,x=2/o.pixelRatio,I=w-x,y=d-x,_=I+m.width/o.pixelRatio,P=y+m.height/o.pixelRatio,u=new a.Point(I,y),N=new a.Point(_,P),b=new a.Point(I,P),E=new a.Point(_,y),A=h.rotate*n.C_DEG_TO_RAD,T=1===h.rotationAlignment;if(t.segment>=0&&!T&&(A+=t.angle),0!==A){var C=Math.cos(A),F=Math.sin(A);u.rotate(C,F),N.rotate(C,F),b.rotate(C,F),E.rotate(C,F)}var G=8*h.padding,M=new a.Point(t.x,t.y),Y=new i.Footprint(this.mapAngle,G,T);Y.addBox(M,new i.Box(w,d,f,v),r,A,e,c,n.C_INFINITY);var B=new l(u,E,b,N,m,0,0,256,M,c,n.C_INFINITY,0),S=new s(Y,[B]),z=c;return h.allowOverlap||(z=this._conflictEngine.getMinZoom(S.footprint,z)),Y.minzoom=z,S},t.prototype.getTextPlacement=function(t,e,r,g,p,w){for(var d=new a.Point(t.x,t.y),f=w.rotate*n.C_DEG_TO_RAD,v=0===w.rotationAlignment,m=w.keepUpright,x=c,I=!v,y=I?0:t.angle,_=t.segment>=0&&v,P=8*w.padding,u=new i.Footprint(this.mapAngle,P,I),N=[],b=!_,E=Number.POSITIVE_INFINITY,A=Number.NEGATIVE_INFINITY,T=E,C=A,F=_?m:v&&m,G=!1,M=0,Y=r;M<Y.length;M++){if((O=Y[M]).vertical){G=!0;break}}var B,S=0,z=0;if(!_&&G){var k=o.TextShaping.getTextBox(r,w.lineHeight*o.SDF_GLYPH_SIZE);switch(w.anchor){case 1:S=k.height/2,z=-k.width/2;break;case 2:S=-k.height/2,z=k.width/2;break;case 3:S=k.height/2,z=k.width/2;break;case 4:S=-k.height/2,z=-k.width/2;break;case 5:S=k.height;break;case 7:z=-k.width;break;case 6:z=k.width;break;case 8:S=-k.height}}S+=w.offset[0]*o.SDF_GLYPH_SIZE,z+=w.offset[1]*o.SDF_GLYPH_SIZE;for(var D=0,R=r;D<R.length;D++){var O,V=(O=R[D]).glyphMosaicItem;if(V&&!V.rect.isEmpty){var H=V.rect,L=V.metrics,Z=V.page;if(b){if(B&&B!==O.y){k=void 0;k=G?new i.Box(-C+S,E+z,-T+S,A+z):new i.Box(E+S,T+z,A+S,C+z),u.addBox(d,k,g,f,e,c,n.C_INFINITY),T=E=Number.POSITIVE_INFINITY,C=A=Number.NEGATIVE_INFINITY}B=O.y}var q=[];if(_){var U=.5*V.metrics.width,j=(O.x+L.left-4+U)*g;if(x=this._placeGlyph(t,x,j,p,t.segment,1,O.vertical,Z,q),m&&(x=this._placeGlyph(t,x,j,p,t.segment,-1,O.vertical,Z,q)),x>=2)break}else q.push(new h(d,y,y,Z,!1)),v&&m&&q.push(new h(d,y+n.C_PI,y+n.C_PI,Z,!1));var J=O.x+L.left,K=O.y-o.SDF_GLYPH_BASELINE-L.top,Q=J+L.width,W=K+L.height,X=void 0,$=void 0,tt=void 0,et=void 0;if(!_&&G)if(O.vertical){var it=(J+Q)/2-L.height/2,nt=(K+W)/2+L.width/2;X=new a.Point(-nt-4+S,it-4+z),$=new a.Point(X.x+H.width,X.y+H.height),tt=new a.Point(X.x,$.y),et=new a.Point($.x,X.y)}else X=new a.Point(4-K+S,J-4+z),$=new a.Point(X.x-H.height,X.y+H.width),tt=new a.Point($.x,X.y),et=new a.Point(X.x,$.y);else X=new a.Point(J-4+S,K-4+z),$=new a.Point(X.x+H.width,X.y+H.height),tt=new a.Point(X.x,$.y),et=new a.Point($.x,X.y);for(var ot=void 0,at=void 0,rt=void 0,ht=void 0,lt=0,st=q;lt<st.length;lt++){var ct=st[lt],gt=void 0,pt=void 0,wt=void 0,dt=void 0;if(ct.alternateVerticalGlyph){if(!ot){it=(J+Q)/2+S,nt=(K+W)/2+z;ot=new a.Point(it-L.height/2-4,nt+L.width/2+4),at=new a.Point(ot.x+H.height,ot.y-H.width),rt=new a.Point(at.x,ot.y),ht=new a.Point(ot.x,at.y)}gt=ot,pt=rt,wt=ht,dt=at}else gt=X,pt=tt,wt=et,dt=$;var ft=K,vt=W,mt=ct.glyphAngle+f;if(0!==mt){var xt=Math.cos(mt),It=Math.sin(mt);gt=gt.clone(),pt=pt.clone(),wt=wt.clone(),dt=dt.clone(),gt.rotate(xt,It),dt.rotate(xt,It),pt.rotate(xt,It),wt.rotate(xt,It)}var yt=0,_t=256;_&&G?O.vertical?ct.alternateVerticalGlyph?(yt=32,_t=96):(yt=224,_t=32):(yt=224,_t=96):(yt=192,_t=64),N.push(new l(gt,wt,pt,dt,H,ct.labelAngle,yt,_t,ct.anchor,ct.minzoom,ct.maxzoom,ct.page)),F&&!this._legible(ct.labelAngle)||(b?(J<E&&(E=J),ft<T&&(T=ft),Q>A&&(A=Q),vt>C&&(C=vt)):ct.minzoom<2&&u.addBox(ct.anchor,new i.Box(J+S,ft+z,Q+S,vt+z),g,mt,e,ct.minzoom,ct.maxzoom))}}}if(x>=2)return null;if(b){k=void 0;k=G?new i.Box(-C+S,E+z,-T+S,A+z):new i.Box(E+S,T+z,A+S,C+z),u.addBox(d,k,g,f,e,c,n.C_INFINITY)}var Pt=new s(u,N);return w.allowOverlap||(x=this._conflictEngine.getMinZoom(Pt.footprint,x)),u.minzoom=x,Pt},t.prototype.add=function(t){this._conflictEngine.add(t.footprint)},t.prototype._legible=function(t){var e=n.radToByte(t);return e<65||e>=193},t.prototype._placeGlyph=function(t,e,i,o,r,l,s,c,g){var p=l,w=p<0?n.positiveMod(t.angle+n.C_PI,n.C_2PI):t.angle,d=0;i<0&&(p*=-1,i*=-1,d=n.C_PI),p>0&&++r;var f=new a.Point(t.x,t.y),v=o[r],m=n.C_INFINITY;if(o.length<=r)return m;for(;;){var x=v.x-f.x,I=v.y-f.y,y=Math.sqrt(x*x+I*I),_=Math.max(i/y,e),P=x/y,u=I/y,N=n.positiveMod(Math.atan2(u,P)+d,n.C_2PI);if(g.push(new h(f,w,N,c,!1,_,m)),s&&g.push(new h(f,w,N,c,!0,_,m)),_<=e)return _;f=v.clone();do{if(r+=p,o.length<=r||r<0)return _;v=o[r]}while(f.isEqual(v));var b=v.x-f.x,E=v.y-f.y,A=Math.sqrt(b*b+E*E);b*=y/A,E*=y/A,f.x-=b,f.y-=E,m=_}},t}();e.PlacementEngine=g}));