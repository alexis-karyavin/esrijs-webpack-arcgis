// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/BidiEngine","./Bucket","./GeometryUtils","./Placement","./TextShaping","./style/StyleLayer","../webgl/Geometry"],(function(e,t,a,n,i,o,r,s,l,h){function c(e,t){return e.iconMosaicItem&&t.iconMosaicItem?e.iconMosaicItem.page===t.iconMosaicItem.page?0:e.iconMosaicItem.page<t.iconMosaicItem.page?-1:1:e.iconMosaicItem&&!t.iconMosaicItem?1:!e.iconMosaicItem&&t.iconMosaicItem?-1:0}return function(e){function t(t,a,n,i,o,r,s,l){var h=e.call(this,t,a)||this;if(h._markerMap=new Map,h._glyphMap=new Map,h._glyphBufferDataStorage=new Map,h._sdfMarkers=!1,t.hasDataDrivenIcon!==n.isDataDriven())throw new Error("incompatible icon buffer");if(t.hasDataDrivenText!==o.isDataDriven())throw new Error("incompatible text buffer");return h._iconVertexBuffer=n,h._iconIndexBuffer=i,h._textVertexBuffer=o,h._textIndexBuffer=r,h._placementEngine=s,h._workerTileHandler=l,h}return a.__extends(t,e),Object.defineProperty(t.prototype,"markerPageMap",{get:function(){return this._markerMap},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"glyphsPageMap",{get:function(){return this._glyphMap},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sdfMarker",{get:function(){return this._sdfMarkers},enumerable:!0,configurable:!0}),t.prototype.copy=function(e,a,n,i,o){var r=new t(this.layer,this.zoom,e,a,n,i,o,this._workerTileHandler);return r.layerIndex=this.layerIndex,r.layerExtent=this.layerExtent,r._iconIndexStart=a.index,r._textIndexStart=i.index,r._iconIndexCount=0,r._textIndexCount=0,r._symbolInstances=this._symbolInstances,r._workerTileHandler=this._workerTileHandler,r._fontArray=this._fontArray,r._textLayout=this._textLayout,r._iconLayout=this._iconLayout,r._isLinePlacement=this._isLinePlacement,r._avoidEdges=this._avoidEdges,r},t.prototype.getResources=function(e,a,n){var i=this.layer,o=this.zoom,r=i.hasDataDrivenIcon,s=i.hasDataDrivenText;e&&e.setExtent(this.layerExtent);for(var l=i.getLayoutProperty("icon-image"),h=i.getLayoutProperty("text-field"),c=i.getLayoutValue("text-font",o),d=i.getLayoutValue("text-transform",o),x=[],u=[1,1,1,1],y=1,g=1,p=[1,1,1,1],m=1,f=1,_=0,v=this._features;_<v.length;_++){var I=v[_],M=I.getGeometry(e);if(M&&0!==M.length){var b=void 0;l&&(b=i.getLayoutValue("icon-image",o,I),l.isDataDriven||(b=this._replaceKeys(b,I.values)),b&&a.add(b));var L=void 0,z=!1;if(h&&((L=i.getLayoutValue("text-field",o,I))&&!h.isDataDriven&&(L=this._replaceKeys(L,I.values)),L)){switch(L=L.replace(/\\n/g,"\n"),d){case 2:L=L.toLowerCase();break;case 1:L=L.toUpperCase()}if(t._bidiEngine.hasBidiChar(L)){var A=void 0;A="rtl"===t._bidiEngine.checkContextual(L)?"IDNNN":"ICNNN",L=t._bidiEngine.bidiTransform(L,A,"VLYSN"),z=!0}var S=L.length;if(S>0)for(var P=0,D=c;P<D.length;P++){var V=D[P],w=n[V];w||(w=n[V]=new Set);for(var E=0;E<S;E++){var T=L.charCodeAt(E);w.add(T)}}}if(b||L){var k=i.getLayoutValue("icon-size",o,I),C=i.getLayoutValue("text-size",o,I);i.hasDataDrivenIconColor&&(u=i.getPaintValue("icon-color",o,I)),i.hasDataDrivenIconOpacity&&(y=i.getPaintValue("icon-opacity",o,I)),i.hasDataDrivenIconSize&&(g=k),i.hasDataDrivenTextColor&&(p=i.getPaintValue("text-color",o,I)),i.hasDataDrivenTextOpacity&&(m=i.getPaintValue("text-opacity",o,I)),i.hasDataDrivenTextSize&&(f=C);var B={sprite:b,label:L,rtl:z,type:I.type,geometry:M,iconSize:k,iconRotate:i.getLayoutValue("icon-rotate",o,I),ddIconValues:r?{color:u,opacity:y,size:g}:null,textSize:C,textRotate:i.getLayoutValue("text-rotate",o,I),ddTextValues:s?{color:p,opacity:m,size:f}:null};x.push(B)}}}this._symbolFeatures=x},t.prototype.processFeatures=function(e){e&&e.setExtent(this.layerExtent);var a,n,i,h,d,x=this.layer,u=this.zoom,y=this._isLinePlacement=1===x.getLayoutValue("symbol-placement",u),g=8*x.getLayoutValue("symbol-spacing",u),p=x.getLayoutProperty("icon-image"),m=x.getLayoutProperty("text-field"),f=this._workerTileHandler;if(p&&(this._iconLayout=new l.IconLayout(x,u,y),a=f.getSpriteItems(),n=this._getTranslate(!0)),m){var _=this._textLayout=new l.TextLayout(x,u,y);this._fontArray=_.fontArray;var v=.5;switch(_.anchor){case 5:case 1:case 7:v=0;break;case 6:case 2:case 8:v=1}var I=.5;switch(_.anchor){case 5:case 3:case 6:I=0;break;case 7:case 4:case 8:I=1}var M=.5;switch(_.justify){case 0:M=0;break;case 2:M=1}var b=_.letterSpacing*s.SDF_GLYPH_SIZE,L=y?0:_.maxWidth*s.SDF_GLYPH_SIZE,z=_.lineHeight*s.SDF_GLYPH_SIZE;i=this._fontArray.map((function(e){return f.getGlyphItems(e)})),h=new s.TextShaping(i,L,z,b,v,I,M),d=this._getTranslate(!1)}this._iconIndexStart=this._iconIndexBuffer.index,this._textIndexStart=this._textIndexBuffer.index,this._iconIndexCount=0,this._textIndexCount=0,this._markerMap.clear(),this._glyphMap.clear();var A=[];this._symbolInstances=A;var S=this._textLayout,P=1;S&&S.size&&(P=S.size/s.SDF_GLYPH_SIZE);for(var D=S?S.maxAngle*o.C_DEG_TO_RAD:0,V=S?8*S.size:0,w=0,E=this._symbolFeatures;w<E.length;w++){var T=E[w],k=void 0;T.sprite&&(k=a[T.sprite])&&k.sdf&&(this._sdfMarkers=!0);var C=void 0,B=T.label,G=0;if(B){var N=y?S.keepUpright:S.writingMode&&S.writingMode.indexOf(1)>=0;if((C=h.getShaping(B,T.rtl,N))&&C.length>0){for(var F=1e30,H=-1e30,R=0,Y=C;R<Y.length;R++){var O=Y[R];F=Math.min(F,O.x),H=Math.max(H,O.x)}G=(H-F+2*s.SDF_GLYPH_SIZE)*P*8}}for(var Z=0,j=T.geometry;Z<j.length;Z++){var q=j[Z],K=void 0;if(y){if(C&&C.length>0&&S&&S.size){var U=8*S.size*(2+Math.min(2,4*Math.abs(S.offset[1])));t._smoothVertices(q,U)}K=t._findAnchors(q,g,G)}else K=3===T.type?t._findCentroid(q):[new r.Anchor(q[0].x,q[0].y)];for(var W=0,J=K;W<J.length;W++){var Q=J[W];Q.x<0||Q.x>4096||Q.y<0||Q.y>4096||(y&&G>0&&0===S.rotationAlignment&&!t._honorsTextMaxAngle(q,Q,G,D,V)||A.push({shaping:C,line:q,iconMosaicItem:k,anchor:Q,iconSize:T.iconSize,iconRotate:T.iconRotate,ddIconValues:T.ddIconValues,textSize:T.textSize,textRotate:T.textRotate,ddTextValues:T.ddTextValues}))}}}A.sort(c);for(var X=0,$=A;X<$.length;X++){var ee=$[X];this._processFeature(ee,n,d)}this._addPlacedGlyphs()},t.prototype.updateSymbols=function(){this._iconIndexStart=this._iconIndexBuffer.index,this._textIndexStart=this._textIndexBuffer.index,this._iconIndexCount=0,this._textIndexCount=0,this._markerMap.clear(),this._glyphMap.clear();var e,t,a=this.layer;a.getLayoutProperty("icon-image")&&(e=this._getTranslate(!0)),a.getLayoutProperty("text-field")&&(t=this._getTranslate(!1));for(var n=0,i=this._symbolInstances;n<i.length;n++){var o=i[n];this._processFeature(o,e,t)}this._addPlacedGlyphs()},t.prototype.assignBufferInfo=function(){},t.prototype._getTranslate=function(e){var t=this.layer.getPaintValue(e?"icon-translate":"text-translate",this.zoom);if(0!==t[0]||0!==t[1]){var a=this._placementEngine.mapAngle;if(0!==a&&0===this.layer.getPaintValue(e?"icon-translate-anchor":"text-translate-anchor",this.zoom)){var n=Math.sin(a),i=Math.cos(a);return[8*(t[0]*i-t[1]*n),8*(t[0]*n+t[1]*i)]}return[8*t[0],8*t[1]]}},t.prototype._replaceKeys=function(e,t){return e.replace(/{([^{}]+)}/g,(function(e,a){return a in t?t[a]:""}))},t.prototype._processFeature=function(e,t,a){var n=e.line,i=e.iconMosaicItem,r=e.shaping,l=e.anchor,h=this._iconLayout,c=h&&!!i,d=!0,x=1;c&&(h.size=e.iconSize,h.rotate=e.iconRotate,x=8*h.size,d=h.optional||!i);var u,y,g=this._textLayout,p=g&&r&&r.length>0,m=1,f=m,_=!0;if((p&&(g.size=e.textSize,g.rotate=e.textRotate,f=8*(m=g.size/s.SDF_GLYPH_SIZE),_=g.optional||!r||0===r.length),c&&(u=this._placementEngine.getIconPlacement(l,t,i,x,h),l.minzoom>u.footprint.minzoom&&(u.footprint.minzoom=l.minzoom),u.footprint.minzoom===o.C_INFINITY&&(u=null)),u||d)&&(p&&(y=this._placementEngine.getTextPlacement(l,a,r,f,n,g))&&(l.minzoom>y.footprint.minzoom&&(y.footprint.minzoom=l.minzoom),y.footprint.minzoom===o.C_INFINITY&&(y=null)),y||_)){if(u&&y||(_||d?_||y?d||u||(y=null):u=null:(u=null,y=null)),u&&y&&!_&&!d){var v=Math.max(u.footprint.minzoom,y.footprint.minzoom);u.footprint.minzoom=v,y.footprint.minzoom=v}y&&(g.ignorePlacement||this._placementEngine.add(y),this._storePlacedGlyphs(y.shapes,y.footprint.minzoom,this.zoom,e.ddTextValues)),u&&(h.ignorePlacement||this._placementEngine.add(u),this._addPlacedIcons(u.shapes,u.footprint.minzoom,this.zoom,i.page,e.ddIconValues))}},t.prototype._addPlacedIcons=function(e,t,a,n,i){for(var r=Math.max(a+o.log2(t),0),s=this._iconVertexBuffer,l=this._iconIndexBuffer,h=0,c=e;h<c.length;h++){var d=c[h],x=Math.max(a+o.log2(d.minzoom),r),u=Math.min(a+o.log2(d.maxzoom),25);if(!(u<=x)){var y=d.tl,g=d.tr,p=d.bl,m=d.br,f=d.mosaicRect,_=d.labelAngle,v=d.minAngle,I=d.maxAngle,M=d.anchor,b=s.index,L=f.x,z=f.y,A=L+f.width,S=z+f.height;s.add(M.x,M.y,y.x,y.y,L,z,_,v,I,x,u,r,i),s.add(M.x,M.y,g.x,g.y,A,z,_,v,I,x,u,r,i),s.add(M.x,M.y,p.x,p.y,L,S,_,v,I,x,u,r,i),s.add(M.x,M.y,m.x,m.y,A,S,_,v,I,x,u,r,i),l.add(b+0,b+1,b+2),l.add(b+1,b+2,b+3),this._markerMap.has(n)?this._markerMap.get(n)[1]+=6:this._markerMap.set(n,[this._iconIndexStart+this._iconIndexCount,6]),this._iconIndexCount+=2}}},t.prototype._addPlacedGlyphs=function(){var e=this,t=this._textVertexBuffer,a=this._textIndexBuffer;this._glyphBufferDataStorage.forEach((function(n,i){for(var o=0,r=n;o<r.length;o++){var s=r[o],l=t.index;t.add(s.glyphAnchor[0],s.glyphAnchor[1],s.tl[0],s.tl[1],s.xmin,s.ymin,s.labelAngle,s.minAngle,s.maxAngle,s.minLod,s.maxLod,s.placementLod,s.ddValues),t.add(s.glyphAnchor[0],s.glyphAnchor[1],s.tr[0],s.tr[1],s.xmax,s.ymin,s.labelAngle,s.minAngle,s.maxAngle,s.minLod,s.maxLod,s.placementLod,s.ddValues),t.add(s.glyphAnchor[0],s.glyphAnchor[1],s.bl[0],s.bl[1],s.xmin,s.ymax,s.labelAngle,s.minAngle,s.maxAngle,s.minLod,s.maxLod,s.placementLod,s.ddValues),t.add(s.glyphAnchor[0],s.glyphAnchor[1],s.br[0],s.br[1],s.xmax,s.ymax,s.labelAngle,s.minAngle,s.maxAngle,s.minLod,s.maxLod,s.placementLod,s.ddValues),a.add(l+0,l+1,l+2),a.add(l+1,l+2,l+3),e._glyphMap.has(i)?e._glyphMap.get(i)[1]+=6:e._glyphMap.set(i,[e._textIndexStart+e._textIndexCount,6]),e._textIndexCount+=2}})),this._glyphBufferDataStorage.clear()},t.prototype._storePlacedGlyphs=function(e,t,a,n){for(var i=Math.max(a+o.log2(t),0),r=0,s=e;r<s.length;r++){var l=s[r],h=Math.max(a+o.log2(l.minzoom),i),c=Math.min(a+o.log2(l.maxzoom),25);if(!(c<=h)){var d=l.tl,x=l.tr,u=l.bl,y=l.br,g=l.labelAngle,p=l.minAngle,m=l.maxAngle,f=l.anchor,_=l.mosaicRect;this._glyphBufferDataStorage.has(l.page)||this._glyphBufferDataStorage.set(l.page,[]),this._glyphBufferDataStorage.get(l.page).push({glyphAnchor:[f.x,f.y],tl:[d.x,d.y],tr:[x.x,x.y],bl:[u.x,u.y],br:[y.x,y.y],xmin:_.x,ymin:_.y,xmax:_.x+_.width,ymax:_.y+_.height,labelAngle:g,minAngle:p,maxAngle:m,minLod:h,maxLod:c,placementLod:i,ddValues:n})}}},t._findAnchors=function(e,t,a){t+=a;for(var n=0,i=e.length-1,s=0;s<i;s++)n+=h.Point.distance(e[s],e[s+1]);var l=a||t;if(n<=(l*=.5))return[];var c=l/n,d=0,x=-(t=n/Math.max(Math.round(n/t),1))/2,u=[],y=e.length-1;for(s=0;s<y;s++){for(var g=e[s],p=e[s+1],m=p.x-g.x,f=p.y-g.y,_=Math.sqrt(m*m+f*f),v=void 0;x+t<d+_;){var I=((x+=t)-d)/_,M=o.interpolate(g.x,p.x,I),b=o.interpolate(g.y,p.y,I);void 0===v&&(v=Math.atan2(f,m)),u.push(new r.Anchor(M,b,v,s,c))}d+=_}return u},t._deviation=function(e,t,a){var n=(t.x-e.x)*(a.x-t.x)+(t.y-e.y)*(a.y-t.y),i=(t.x-e.x)*(a.y-t.y)-(t.y-e.y)*(a.x-t.x);return Math.atan2(i,n)},t._honorsTextMaxAngle=function(e,t,a,n,i){for(var o=0,r=a/2,s=new h.Point(t.x,t.y),l=t.segment+1;o>-r;){if(--l<0)return!1;o-=h.Point.distance(e[l],s),s=e[l]}o+=h.Point.distance(e[l],e[l+1]);for(var c=[],d=0,x=e.length;o<r;){var u=e[l],y=l,g=void 0;do{if(++y===x)return!1;g=e[y]}while(g.isEqual(u));var p=y,m=void 0;do{if(++p===x)return!1;m=e[p]}while(m.isEqual(g));var f=this._deviation(u,g,m);for(c.push({deviation:f,distToAnchor:o}),d+=f;o-c[0].distToAnchor>i;)d-=c.shift().deviation;if(Math.abs(d)>n)return!1;o+=h.Point.distance(g,m),l=y}return!0},t._smoothVertices=function(e,t){if(!(t<=0)){var a=e.length;if(!(a<3)){var n=[],i=0;n.push(0);for(var o=1;o<a;o++)i+=h.Point.distance(e[o],e[o-1]),n.push(i);t=Math.min(t,.2*i);var r=[];r.push(e[0].x),r.push(e[0].y);var s=e[a-1].x,l=e[a-1].y,c=h.Point.sub(e[0],e[1]);c.normalize(),e[0].x+=t*c.x,e[0].y+=t*c.y,c.assignSub(e[a-1],e[a-2]),c.normalize(),e[a-1].x+=t*c.x,e[a-1].y+=t*c.y;for(o=1;o<a;o++)n[o]+=t;n[a-1]+=t;var d=.5*t;for(o=1;o<a-1;o++){for(var x=0,u=0,y=0,g=o-1;g>=0&&!(n[g+1]<n[o]-d);g--){var p=d+n[g+1]-n[o],m=n[g+1]-n[g],f=n[o]-n[g]<d?1:p/m;if(Math.abs(f)<1e-6)break;var _=f*p-.5*(L=f*f)*m,v=f*m/t,I=e[g+1],M=e[g].x-I.x,b=e[g].y-I.y;x+=v/_*(I.x*f*p+.5*L*(p*M-m*I.x)-L*f*m*M/3),u+=v/_*(I.y*f*p+.5*L*(p*b-m*I.y)-L*f*m*b/3),y+=v}for(g=o+1;g<a&&!(n[g-1]>n[o]+d);g++){p=d-n[g-1]+n[o],m=n[g]-n[g-1],f=n[g]-n[o]<d?1:p/m;if(Math.abs(f)<1e-6)break;var L;_=f*p-.5*(L=f*f)*m,v=f*m/t,I=e[g-1],M=e[g].x-I.x,b=e[g].y-I.y;x+=v/_*(I.x*f*p+.5*L*(p*M-m*I.x)-L*f*m*M/3),u+=v/_*(I.y*f*p+.5*L*(p*b-m*I.y)-L*f*m*b/3),y+=v}r.push(x/y),r.push(u/y)}r.push(s),r.push(l);for(o=0,g=0;o<a;o++)e[o].x=r[g++],e[o].y=r[g++]}}},t._findCentroid=function(e){var t=e.length-1,a=0,n=0,i=0,o=e[0].x,s=e[0].y;o>4096&&(o=4096),o<0&&(o=0),s>4096&&(s=4096),s<0&&(s=0);for(var l=1;l<t;l++){var h=e[l].x,c=e[l].y,d=e[l+1].x,x=e[l+1].y;h>4096&&(h=4096),h<0&&(h=0),c>4096&&(c=4096),c<0&&(c=0),d>4096&&(d=4096),d<0&&(d=0),x>4096&&(x=4096),x<0&&(x=0);var u=(h-o)*(x-s)-(d-o)*(c-s);a+=u*(o+h+d),n+=u*(s+c+x),i+=u}return a/=3*i,n/=3*i,isNaN(a)||isNaN(n)?[]:[new r.Anchor(a,n)]},t._bidiEngine=new n.default,t}(i)}));