// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../Viewpoint","../../core/Collection","../../core/maybe","../../core/promiseUtils","../../core/unitUtils","../../core/wgs84Constants","../../core/libs/gl-matrix-2/common","../../core/libs/gl-matrix-2/mat2d","../../core/libs/gl-matrix-2/mat2df64","../../core/libs/gl-matrix-2/vec2","../../core/libs/gl-matrix-2/vec2f64","../../geometry/Extent","../../geometry/Geometry","../../geometry/Point","../../geometry/SpatialReference","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../../geometry/support/webMercatorUtils"],(function(e,t,r,n,a,c,o,i,s,u,l,f,m,y,v,g,d,p,x,b,h){Object.defineProperty(t,"__esModule",{value:!0});var M,w,R,S,G,A,P,j,T,B,z,_=s.wgs84Radius,k=180/Math.PI;function q(e,t,r,n){return n&&r&&!n.equals(r)&&b.canProject(n,r)&&n.isWebMercator?n.isWebMercator?function(e,t){var r=t[1];return r>89.99999?r=89.99999:r<-89.99999&&(r=-89.99999),r=Math.sin(u.common.toRadian(r)),m.vec2.set(e,u.common.toRadian(t[0])*_,.5*_*Math.log((1+r)/(1-r)))}(e,t):function(e,t,r){var n=u.common.toDegree(t[0]/_);return m.vec2.set(e,r?n:n-360*Math.floor((n+180)/360),u.common.toDegree(.5*Math.PI-2*Math.atan(Math.exp(-1*t[1]/_))))}(e,t):m.vec2.copy(e,t)}function F(e){return e.wkid?e:e.spatialReference||p.WGS84}function N(e,t){return t.type?m.vec2.set(e,t.x,t.y):m.vec2.copy(e,t)}function V(e){return i.getMetersPerUnitForSR(e)}function W(e,t){return Math.max(e.width/t[0],e.height/t[1])*Q(e.spatialReference)}function I(e,t,n,i){return r.__awaiter(this,void 0,void 0,(function(){var s,u,l,f,m,y,p,x,h,M,w,R,S,G,A,P,j,T,B,z,_,k,q,F,N,V,W;return r.__generator(this,(function(r){switch(r.label){case 0:if(!e)return[2,null];if(Array.isArray(e)&&!e.length)return[2,null];if(a.isCollection(e)&&(e=e.toArray()),!Array.isArray(e)||!e.length||"object"!=typeof e[0])return[3,7];if(u=e.every((function(e){return"attributes"in e})),l=e.some((function(e){return!e.geometry})),f=e,!(u&&l&&t&&t.allLayerViews))return[3,2];for(m=new Map,y=0,p=e;y<p.length;y++)B=p[y],x=B.layer,h=m.get(x)||[],null!=(M=B.attributes[x.objectIdField])&&h.push(M),m.set(x,h);return w=[],m.forEach((function(e,r){var n=t.allLayerViews.find((function(e){return e.layer.id===r.id}));if("queryFeatures"in n){var a=r.createQuery();a.objectIds=e,a.returnGeometry=!0,w.push(n.queryFeatures(a))}})),[4,o.all(w)];case 1:for(R=r.sent(),S=[],G=0,A=R;G<A.length;G++)if((P=A[G])&&P.features&&P.features.length)for(j=0,T=P.features;j<T.length;j++)B=T[j],c.isSome(B.geometry)&&S.push(B.geometry);f=S,r.label=2;case 2:z=0,_=f,r.label=3;case 3:return z<_.length?[4,I(_[z],t,n,i)]:[3,6];case 4:i=r.sent(),r.label=5;case 5:return z++,[3,3];case 6:return[2,i];case 7:return Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]?(s=new d(e),[3,12]):[3,8];case 8:return e instanceof g?(s=e,[3,12]):[3,9];case 9:return"geometry"in e?e.geometry?(s=e.geometry,[3,12]):[3,10]:[3,12];case 10:return e.layer?(k=e.layer,"queryFeatures"in(q=t.allLayerViews.find((function(e){return e.layer.id===k.id})))?((F=k.createQuery()).objectIds=[e.attributes[k.objectIdField]],F.returnGeometry=!0,[4,q.queryFeatures(F)]):[3,12]):[3,12];case 11:N=r.sent(),s=c.get(N,"features",0,"geometry"),r.label=12;case 12:if(c.isNone(s))return[2,null];if(!(V="point"===s.type?new v({xmin:s.x,ymin:s.y,xmax:s.x,ymax:s.y,spatialReference:s.spatialReference}):s.extent))return[2,null];if(W=b.canProject(V,n),!V.spatialReference.equals(n)&&W)V=b.project(V,n);else if(!W)return[2,null];return[2,i=i?i.union(V):V.clone()]}}))}))}function O(e,t){return r.__awaiter(this,void 0,void 0,(function(){var a,c,o,i,s,u,l,f,m,g,p,x,M,w,R,S,G,A,P,j;return r.__generator(this,(function(r){switch(r.label){case 0:return e&&t?(a=t.spatialReference,c=t.constraints,o=t.padding,i=t.viewpoint,s=t.size,u=o?s[0]-o.left-o.right:s[0],l=o?s[1]-o.top-o.bottom:s[1],f=[u,l],m=null,e instanceof n?m=e:e.viewpoint?m=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(m=e.target),g=null,m&&m.targetGeometry?(g=m.targetGeometry,[3,10]):[3,1]):[2,new n({targetGeometry:new d,scale:0,rotation:0})];case 1:return e instanceof v?(g=e,[3,10]):[3,2];case 2:return e||e&&("center"in e||"extent"in e||"target"in e)?[4,I(e.center,t,a)]:[3,10];case 3:return(M=r.sent())?[3,5]:[4,I(e.extent,t,a)];case 4:M=r.sent(),r.label=5;case 5:return(x=M)?[3,7]:[4,I(e.target,t,a)];case 6:x=r.sent(),r.label=7;case 7:return(p=x)?[3,9]:[4,I(e,t,a)];case 8:p=r.sent(),r.label=9;case 9:g=p,r.label=10;case 10:return!g&&i&&i.targetGeometry?g=i.targetGeometry:!g&&t.extent&&(g=t.extent),w=F(g),a||(a=F(t.spatialReference||t.extent||g)),h.canProject(g,a)||!w||w.equals(a)?(R=N(y.vec2f64.create(),g.center?g.center:g),S=new d(q(R,R,w,a),a),G=null,G=m&&m.targetGeometry&&"point"===m.targetGeometry.type?m.scale:e.hasOwnProperty("scale")&&e.scale?e.scale:e.hasOwnProperty("zoom")&&-1!==e.zoom&&c&&c.effectiveLODs?c.zoomToScale(e.zoom):Array.isArray(g)||"point"===g.type||"extent"===g.type&&0===g.width&&0===g.height?t.extent&&b.canProject(t.extent,a)?W(b.project(t.extent,a),f):t.extent?W(t.extent,f):i.scale:b.canProject(g.extent,a)?W(b.project(g.extent,a),f):W(g.extent,f),(A=function(e){if(e&&(!Array.isArray(e)||"number"!=typeof e[0])&&("object"==typeof e||Array.isArray(e)&&"object"==typeof e[0])){if("layer"in e&&e.layer&&e.layer.minScale&&e.layer.maxScale)return{min:(c=e.layer).minScale,max:c.maxScale};if(Array.isArray(e)&&e.length&&e.every((function(e){return"layer"in e}))){for(var t=0,r=0,n=0,a=e;n<a.length;n++){var c;(c=a[n].layer)&&c.minScale&&c.maxScale&&(t=c.minScale<t?c.minScale:t,r=c.maxScale>r?c.maxScale:r)}return t&&r?{min:t,max:r}:null}}}(e))&&(A.min&&A.min>G?G=A.min:A.max&&A.max<G&&(G=A.max)),P=0,m?P=m.rotation:e.hasOwnProperty("rotation")?P=e.rotation:i&&(P=i.rotation),j=new n({targetGeometry:S,scale:G,rotation:P}),c&&(j=c.fit(j),c.rotationEnabled||(j.rotation=P)),[2,j]):[2,null]}}))}))}function E(e,t){var r=e.targetGeometry,n=t.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e}function U(e,t,r){return r?m.vec2.set(e,.5*(t[0]-r.right+r.left),.5*(t[1]-r.bottom+r.top)):m.vec2.scale(e,t,.5)}function C(e,t,r){var n=D(t),a=Math.abs(Math.cos(n)),c=Math.abs(Math.sin(n));return m.vec2.set(e,Math.round(r[1]*c+r[0]*a),Math.round(r[1]*a+r[0]*c))}function L(e){return e.scale*(t=e.targetGeometry.spatialReference,x.isValid(t)?1/(39.37*V(t)*96):1);var t}function D(e){return u.common.toRadian(e.rotation)||0}function Q(e){return x.isValid(e)?39.37*V(e)*96:1}function H(e){if(e.isWrappable){var t=x.getInfo(e);return t.valid[1]-t.valid[0]}return 0}t.extentToScale=W,t.create=O,t.copy=E,t.getAnchor=U,t.getExtent=(M=y.vec2f64.create(),function(e,t,r){var n=t.targetGeometry;N(M,n);var a=.5*L(t);return e.xmin=M[0]-a*r[0],e.ymin=M[1]-a*r[1],e.xmax=M[0]+a*r[0],e.ymax=M[1]+a*r[1],e.spatialReference=n.spatialReference,e}),t.setExtent=function(e,r,n,a,c){return t.centerAt(e,r,n.center),e.scale=W(n,a),c&&c.constraints&&c.constraints.constrain(e),e},t.getOuterExtent=(w=y.vec2f64.create(),R=y.vec2f64.create(),function(e,t,r){N(w,t.targetGeometry),C(R,t,r);var n=.5*L(t),a=w[0]-n*R[0],c=w[1]-n*R[1],o=w[0]+n*R[0],i=w[1]+n*R[1],s=t.targetGeometry.spatialReference;return e.set({xmin:a,ymin:c,xmax:o,ymax:i,spatialReference:s}),e}),t.getOuterSize=C,t.getPaddingScreenTranslation=(S=y.vec2f64.create(),function(e,t,r){return m.vec2.sub(e,function(e,t){return m.vec2.scale(e,t,.5)}(e,t),U(S,t,r))}),t.getPaddingMapTranslation=function(){var e=f.mat2df64.create(),r=y.vec2f64.create();return function(n,a,c,o){var i=L(a),s=D(a);return m.vec2.set(r,i,i),l.mat2d.fromScaling(e,r),l.mat2d.rotate(e,e,s),l.mat2d.translate(e,e,t.getPaddingScreenTranslation(r,c,o)),l.mat2d.translate(e,e,[0,o.top-o.bottom]),m.vec2.set(n,e[4],e[5])}}(),t.getResolution=L,t.getResolutionToScaleFactor=Q,t.getMatrix=function(){var e=y.vec2f64.create(),t=y.vec2f64.create(),r=y.vec2f64.create();return function(n,a,c,o,i,s){return m.vec2.negate(e,a),m.vec2.scale(t,c,.5*s),m.vec2.set(r,1/o*s,-1/o*s),l.mat2d.identity(n),l.mat2d.translate(n,n,t),i&&l.mat2d.rotate(n,n,i),l.mat2d.scale(n,n,r),l.mat2d.translate(n,n,e),n}}(),t.getTransform=function(){var e=y.vec2f64.create();return function(r,n,a,c){var o=L(n),i=D(n);return N(e,n.targetGeometry),t.getMatrix(r,e,a,o,i,c)}}(),t.getTransformNoRotation=function(){var e=y.vec2f64.create();return function(r,n,a,c){var o=L(n);return N(e,n.targetGeometry),t.getMatrix(r,e,a,o,0,c)}}(),t.getWorldWidth=H,t.getWorldScreenWidth=function(e,t){return Math.round(H(e)/t)},t.createAsync=function(e,t){return O(e,t)},t.angleBetween=(G=y.vec2f64.create(),A=y.vec2f64.create(),P=[0,0,0],function(e,t,r){m.vec2.subtract(G,e,t),m.vec2.normalize(G,G),m.vec2.subtract(A,e,r),m.vec2.normalize(A,A),m.vec2.cross(P,G,A);var n=Math.acos(m.vec2.dot(G,A)/(m.vec2.length(G)*m.vec2.length(A)))*k;return P[2]<0&&(n=-n),isNaN(n)&&(n=0),n}),t.addPadding=function(){var e=y.vec2f64.create();return function(r,n,a,c){var o=r.targetGeometry;return E(r,n),t.getPaddingMapTranslation(e,n,a,c),o.x+=e[0],o.y+=e[1],r}}(),t.removePadding=function(){var e=y.vec2f64.create();return function(r,n,a,c){var o=r.targetGeometry;return E(r,n),t.getPaddingMapTranslation(e,n,a,c),o.x-=e[0],o.y-=e[1],r}}(),t.centerAt=function(){var e=y.vec2f64.create();return function(t,r,n){E(t,r);var a=t.targetGeometry,c=F(n),o=F(a);return N(e,n),q(e,e,c,o),a.x=e[0],a.y=e[1],t}}(),t.pixelSize=function(e){return L(e)},t.resize=(j=y.vec2f64.create(),function(e,r,n,a,c){c||(c="center"),m.vec2.sub(j,n,a),m.vec2.scale(j,j,.5);var o=j[0],i=j[1];switch(c){case"center":m.vec2.set(j,0,0);break;case"left":m.vec2.set(j,-o,0);break;case"top":m.vec2.set(j,0,i);break;case"right":m.vec2.set(j,o,0);break;case"bottom":m.vec2.set(j,0,-i);break;case"top-left":m.vec2.set(j,-o,i);break;case"bottom-left":m.vec2.set(j,-o,-i);break;case"top-right":m.vec2.set(j,o,i);break;case"bottom-right":m.vec2.set(j,o,-i)}return t.translateBy(e,r,j),e}),t.rotateBy=function(e,t,r){return E(e,t),e.rotation+=r,e},t.rotateTo=function(e,t,r){return E(e,t),e.rotation=r,e},t.scaleBy=function(){var e=y.vec2f64.create();return function(r,n,a,c,o){return E(r,n),isNaN(a)||0===a||(t.toMap(e,c,n,o),r.scale=n.scale*a,t.toScreen(e,e,r,o),t.translateBy(r,r,m.vec2.set(e,e[0]-c[0],c[1]-e[1]))),r}}(),t.scaleTo=function(e,t,r){return E(e,t),e.scale=r,e},t.scaleAndRotateBy=function(){var e=y.vec2f64.create();return function(r,n,a,c,o,i){return E(r,n),isNaN(a)||0===a||(t.toMap(e,o,n,i),r.scale=n.scale*a,r.rotation+=c,t.toScreen(e,e,r,i),t.translateBy(r,r,m.vec2.set(e,e[0]-o[0],o[1]-e[1]))),r}}(),t.padAndScaleAndRotateBy=(T=y.vec2f64.create(),B=y.vec2f64.create(),function(e,r,n,a,c,o,i){return t.getPaddingScreenTranslation(B,o,i),m.vec2.add(T,c,B),a?t.scaleAndRotateBy(e,r,n,a,T,o):t.scaleBy(e,r,n,T,o)}),t.toMap=(z=f.mat2df64.create(),function(e,r,n,a){return m.vec2.transformMat2d(e,r,function(e,r,n,a){return t.getTransform(e,r,n,a),l.mat2d.invert(e,e)}(z,n,a,1))}),t.toScreen=function(){var e=f.mat2df64.create();return function(r,n,a,c){return m.vec2.transformMat2d(r,n,t.getTransform(e,a,c,1))}}(),t.translateBy=function(){var e=y.vec2f64.create(),t=f.mat2df64.create();return function(r,n,a){E(r,n);var c=L(n),o=r.targetGeometry;return l.mat2d.fromRotation(t,D(n)),l.mat2d.scale(t,t,y.vec2f64.fromValues(c,c)),m.vec2.transformMat2d(e,a,t),o.x+=e[0],o.y+=e[1],r}}()}));