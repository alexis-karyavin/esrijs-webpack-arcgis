// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/Error","../../../../core/has","../../../../core/Logger","../../../../core/maybe","../../../../core/MD5","../../../../renderers/visualVariables/SizeVariable","../../../../renderers/visualVariables/support/SizeStop","../../engine"],(function(e,i,r,t,a,n,s,l,u,o,d){var c=this;Object.defineProperty(i,"__esModule",{value:!0});var f=n.getLogger("esri.views.2d.layers.support.clusterUtils");a.add("esri-cluster-arcade-enabled",1);var p=a("esri-cluster-arcade-enabled");function v(e,i){var r=i.name,a=i.outStatistic,n=a.onStatisticField,s=a.onStatisticValueExpression,u=a.statisticType;if(s){var o=l.createMD5Hash(s.toLowerCase());e.push({name:r,outStatistic:{onStatisticField:o,onStatisticValueExpression:s,statisticType:u}})}else n?e.push({name:r,outStatistic:{onStatisticField:n,statisticType:u}}):f.error(new t("mapview-unsupported-field","Unable to handle field",{field:i}))}function m(e,i,r){var t=l.createMD5Hash(i),a="mode"===r?"cluster_type_"+t:"cluster_avg_"+t;return e.some((function(e){return e.name===a}))||e.push({name:a,outStatistic:{onStatisticField:t,onStatisticValueExpression:i,statisticType:r}}),a}function _(e,i,r,t){if("cluster_count"===i||e.some((function(e){return e.name===i})))return i;var a=function(e,i,r){switch(e){case"avg":case"avg_angle":return"cluster_avg_"+i;case"mode":return"cluster_type_"+i;case"norm":var t=r,a=i.toLowerCase()+",norm:field,"+t.toLowerCase();return"cluster_avg_"+l.createMD5Hash(a)}}(r,i,t);return e.some((function(e){return e.name===a}))||("norm"===r?e.push({name:a,outStatistic:{onStatisticField:i,onStatisticNormalizationField:t,statisticType:r}}):e.push({name:a,outStatistic:{onStatisticField:i,statisticType:r}})),a}i.createClusterRenderer=function(e,t,a,n,l){return r.__awaiter(c,void 0,void 0,(function(){var t,u,o,d,c,f;return r.__generator(this,(function(r){if(t=a.clone(),!i.isClusterCompatibleRenderer(t))return[2,t];if(n.fields)for(u=0,o=n.fields;u<o.length;u++)d=o[u],v(e,d);switch("visualVariables"in t&&(c=(t.visualVariables||[]).filter((function(e){return"$view.scale"!==e.valueExpression})),f=i.findSizeVV(c),c.forEach((function(i){"rotation"===i.type?i.field?i.field=_(e,i.field,"avg_angle"):i.valueExpression&&(i.field=m(e,i.valueExpression,"avg_angle"),i.valueExpression=null):i.normalizationField?(i.field=_(e,i.field,"norm",i.normalizationField),i.normalizationField=null):i.field?i.field=_(e,i.field,"avg"):(i.field=m(e,i.valueExpression,"avg"),i.valueExpression=null)})),s.isNone(f)&&!i.hasClusterCountVV(c)&&(c.push(i.createClusterCountSizeVariable(n,l)),t.dynamicClusterSize=!0),t.visualVariables=c),t.type){case"simple":break;case"unique-value":t.field?t.field=_(e,t.field,"mode"):t.valueExpression&&(t.field=m(e,t.valueExpression,"mode"),t.valueExpression=null);break;case"class-breaks":t.normalizationField?(t.field=_(e,t.field,"norm",t.normalizationField),t.normalizationField=null):t.field?t.field=_(e,t.field,"avg"):(t.field=m(e,t.valueExpression,"avg"),t.valueExpression=null)}return[2,t]}))}))},i.findSizeVV=function(e){for(var i=0,r=e;i<r.length;i++){var t=r[i];if("size"===t.type)return t}return null},i.hasClusterCountVV=function(e){for(var i=0,r=e;i<r.length;i++){if("cluster_count"===r[i].field)return!0}return!1},i.createClusterCountSizeVariable=function(e,i){var t=[new o({value:0,size:0}),new o({value:1})];if(s.isNone(i))return new u({field:"cluster_count",stops:r.__spreadArrays(t,[new o({value:2,size:0})])});var a=Object.keys(i).reduce((function(a,n){var s;return r.__assign(r.__assign({},a),((s={})[n]=r.__spreadArrays(t,[new o({value:Math.max(2,i[n].minValue),size:e.clusterMinSize}),new o({value:Math.max(3,i[n].maxValue),size:e.clusterMaxSize})]),s))}),{});return new d.LevelDependentSizeVariable({field:"cluster_count",levels:a})},i.isClusterCompatibleRenderer=function(e){var i=function(i){return f.error(new t("Unsupported-renderer",i,{renderer:e}))};if("unique-value"===e.type){if(e.field2||e.field3)return i("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1}else if("class-breaks"===e.type){if(e.normalizationField){var r=e.normalizationType;if("field"!==r)return i("FeatureReductionCluster does not support a normalizationType of "+r),!1}}else if("simple"!==e.type)return i("FeatureReductionCluster does not support renderers of type "+e.type),!1;if(!p){if("valueExpression"in e&&e.valueExpression)return i("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in e&&e.visualVariables||[]).some((function(e){return!!("valueExpression"in e&&e.valueExpression)})))return i("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0}}));