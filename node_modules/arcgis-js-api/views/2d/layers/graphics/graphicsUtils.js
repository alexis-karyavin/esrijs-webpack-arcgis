// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/mat2d","../../../../core/libs/gl-matrix-2/mat2df32","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f32","../../../../geometry/SpatialReference","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/boundsUtils","../../../../geometry/support/intersects","../../../../geometry/support/jsonUtils","../../../../geometry/support/normalizeUtils","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/support/spatialReferenceUtils","../../engine","../../engine"],(function(e,t,a,r,n,i,s,m,c,o,l,x,f,v,u,p,h,d){Object.defineProperty(t,"__esModule",{value:!0});var y=Math.PI/180,g=i.mat2df32.create(),M=m.vec2f32.create(),b=o.create();t.getBounds=function(e,t,a,r,n,i,s){if(!r||!a.symbol)return e[0]=e[1]=e[2]=e[3]=0,t[0]=t[1]=t[2]=t[3]=0,e;var m=r;if(!f.isPoint(m)){l.getBoundsXY(e,m);var c=t[0];0===c&&(c=function(e){var t=0;switch(e.symbol.type){case"simple-fill":case"picture-fill":var a=e.symbol.outline;if(!a)return 0;t=a.width;break;case"simple-line":t=e.symbol.width;break;case"simple-marker":t=e.symbol.size;break;case"picture-marker":t=Math.max(e.symbol.width,e.symbol.height);break;case"text":var r=[0,0,0,0];W(r,e.symbol,e.mosaicItem);var n=Math.max(Math.abs(r[0]),Math.abs(r[1]));t=Math.max(r[2],r[3])+n;break;case"cim":case"expanded-cim":var i=h.CIMSymbolHelper.getEnvelope(e.symbol.data);t=Math.sqrt(i.width*i.width+i.height*i.height)}return t}(a),t[0]=c);var o=n*c/2;return e[0]-=o,e[1]-=o,e[2]+=o,e[3]+=o,e}var x=m.x,u=m.y;return"text"===a.symbol.type&&0===t[2]&&0===t[3]&&W(t,a.symbol,a.mosaicItem),function(e,t,a,r,n,i,s,m){var c;switch(r.type){case"simple-marker":case"picture-marker":c=R(t,a,r,i,s,0);break;case"text":c=U(t,a,r,n,i,0);break;case"cim":case"expanded-cim":c=A(t,a,r,i,s,0)}for(var o,l,x=0,f=0;f<c.rings[0].length-1;f++)l=c.rings[0][f],o=(t-l[0])*(t-l[0])+(a-l[1])*(a-l[1]),x=Math.max(x,o);x=Math.sqrt(x);var u=v.normalizeMapX(t-x,m),h=v.normalizeMapX(t+x,m);if(u>h){var d=p.getInfo(m);if(d){var y=d.valid,g=y[0],M=y[1];u=g,h=M}}e[0]=u,e[1]=a-x,e[2]=h,e[3]=a+x}(e,x,u,a.symbol,t,n,i,s),e},t.isMarkerSymbol=function(e){return"simple-marker"===e||"picture-marker"===e||"text"===e},t.graphicGeometryToNumber=function(e){switch(a.unwrap(e.geometry).type){case"point":case"multipoint":return 0;case"polyline":return 1;case"polygon":case"extent":return 2}return 0};var I=m.vec2f32.create(),k=m.vec2f32.create(),w=m.vec2f32.create(),P=m.vec2f32.create(),S=m.vec2f32.create(),X=m.vec2f32.create(),z=m.vec2f32.create();function R(e,t,a,i,m,c){var o,l,x=r.pt2px(a.xoffset),f=r.pt2px(a.yoffset),v=y*a.angle,u=y*c;switch(a.type){case"simple-marker":var p=a;o=l=r.pt2px(p.size);break;case"picture-marker":var h=a;o=r.pt2px(h.width),l=r.pt2px(h.height)}m<.04&&(i=.04*i/m);var d=n.mat2d.identity(g);n.mat2d.translate(d,d,s.vec2.set(M,e,t)),n.mat2d.rotate(d,d,u-v),n.mat2d.scale(d,d,s.vec2.set(M,i,-i)),n.mat2d.translate(d,d,s.vec2.set(M,x,-f));var b=[0,0];s.vec2.transformMat2d(b,s.vec2.set(M,-.5*o,-.5*l),d);var I=[0,0];s.vec2.transformMat2d(I,s.vec2.set(M,-.5*o,.5*l),d);var k=[0,0];s.vec2.transformMat2d(k,s.vec2.set(M,.5*o,-.5*l),d);var w=[0,0];return s.vec2.transformMat2d(w,s.vec2.set(M,.5*o,.5*l),d),{rings:[[b,k,w,I,b]]}}function A(e,t,a,i,m,c){var o=h.CIMSymbolHelper.getEnvelope(a.data);if(!o)return null;m<.04&&(i=.04*i/m);var l=r.pt2px(o.width),x=r.pt2px(o.height),f=r.pt2px(o.x),v=r.pt2px(o.y),u=0*y,p=y*c,d=n.mat2d.identity(g);n.mat2d.translate(d,d,s.vec2.set(M,e,t)),n.mat2d.rotate(d,d,p-u),n.mat2d.scale(d,d,s.vec2.set(M,i,i));var b=[0,0];s.vec2.transformMat2d(b,s.vec2.set(M,f,v+x),d);var I=[0,0];s.vec2.transformMat2d(I,s.vec2.set(M,f,v),d);var k=[0,0];s.vec2.transformMat2d(k,s.vec2.set(M,f+l,v+x),d);var w=[0,0];return s.vec2.transformMat2d(w,s.vec2.set(M,f+l,v),d),{rings:[[b,k,w,I,b]]}}function U(e,t,a,i,m,c){var o=r.pt2px(a.xoffset),l=r.pt2px(a.yoffset),x=y*a.angle,f=y*c,v=n.mat2d.identity(g);n.mat2d.translate(v,v,s.vec2.set(M,e,t)),n.mat2d.rotate(v,v,f),n.mat2d.scale(v,v,s.vec2.set(M,m,-m));var u=i[0]+i[2]/2,p=i[1]+i[3]/2;n.mat2d.translate(v,v,s.vec2.set(M,o,-l)),n.mat2d.translate(v,v,s.vec2.set(M,u,p)),n.mat2d.rotate(v,v,x),n.mat2d.translate(v,v,s.vec2.set(M,-u,-p));var h=[0,0];s.vec2.transformMat2d(h,s.vec2.set(M,i[0],i[1]),v);var d=[0,0];s.vec2.transformMat2d(d,s.vec2.set(M,i[0],i[1]+i[3]),v);var b=[0,0];s.vec2.transformMat2d(b,s.vec2.set(M,i[0]+i[2],i[1]),v);var I=[0,0];return s.vec2.transformMat2d(I,s.vec2.set(M,i[0]+i[2],i[1]+i[3]),v),{rings:[[h,b,I,d,h]]}}function W(e,t,a){if(!a||0===a.glyphMosaicItems.length)return e;var n=h.bidiText(t.text)[1],i=a.glyphMosaicItems,s=d.shapeGlyphs(i,n,{scale:r.pt2px(t.font.size)/24,angle:t.angle,xOffset:t.xoffset,yOffset:t.yoffset,hAlign:d.alignmentUtils.getXAnchorDirection(t.horizontalAlignment||"center"),vAlign:d.alignmentUtils.getYAnchorDirection(t.verticalAlignment||"baseline"),maxLineWidth:Math.max(32,Math.min(t.lineWidth||512,512)),lineHeight:30*Math.max(.25,Math.min(t.lineHeight||1,4)),decoration:t.font.decoration||"none",isCIM:!1}).bounds;return e[0]=s.x-s.halfWidth,e[1]=s.y-s.halfHeight,e[2]=s.width,e[3]=s.height,e}t.isPointOnPolyline=function(e,t,a,r){s.vec2.set(w,t,a);for(var n,i,m,c,o,l,x,f,v,u=e.paths,p=1/0,h=0;h<u.length;h++){var d=u[h];if(!(d.length<2))for(var y=1;y<d.length;y++)n=d[y-1][0],m=d[y-1][1],i=d[y][0],c=d[y][1],o=Math.min(n,i)-r,l=Math.min(m,c)-r,x=Math.max(n,i)+r,f=Math.max(m,c)+r,t<o||t>x||a<l||a>f||(s.vec2.set(I,n,m),s.vec2.set(k,i,c),s.vec2.subtract(P,k,I),s.vec2.subtract(S,I,w),s.vec2.scale(X,P,s.vec2.dot(P,S)/s.vec2.dot(P,P)),s.vec2.subtract(z,S,X),p>(v=s.vec2.dot(z,z))&&(p=v))}return Math.sqrt(p)<=r},t.getMarkerSymbolBounds=R,t.getCIMMarkerBounds=A,t.getTextSymbolBounds=U,t.normalizeCentralMeridian=function(e){var t,a,r,n,i,s,m,c,o,v=null;if(!e)return null;if("mesh"===e.type)return e.toJSON();if(t=e.spatialReference,!(a=u.getInfo(t)))return e.toJSON();r=t.isWebMercator,n=B[s=r?102100:4326].maxX,i=B[s].minX,m=B[s].plus180Line,c=B[s].minus180Line;var p=e.toJSON();if(f.isPoint(p))o=q(p,n,i);else if(f.isMultipoint(p))p.points=p.points.map((function(e){return q(e,n,i)})),o=p;else if(f.isExtent(p))o=function(e,t){if(!t)return e;var a=function(e,t){var a,r=[],n=e.ymin,i=e.ymax,s=e.xmax-e.xmin,m=e.xmin,c=e.xmax,o=t.valid,l=o[0],x=o[1],f=(a=O(e.xmin,t)).x,v=a.frameId,u=(a=O(e.xmax,t)).x,p=a.frameId,h=f===u&&s>0;if(s>2*x){var d={xmin:m<c?f:u,ymin:n,xmax:x,ymax:i},y={xmin:l,ymin:n,xmax:m<c?u:f,ymax:i},g={xmin:0,ymin:n,xmax:x,ymax:i},M={xmin:l,ymin:n,xmax:0,ymax:i},b=[],I=[];C(d,g)&&b.push(v),C(d,M)&&I.push(v),C(y,g)&&b.push(p),C(y,M)&&I.push(p);for(var k=v+1;k<p;k++)b.push(k),I.push(k);r.push({extent:d,frameIds:[v]},{extent:y,frameIds:[p]},{extent:g,frameIds:b},{extent:M,frameIds:I})}else f>u||h?r.push({extent:{xmin:f,ymin:n,xmax:x,ymax:i},frameIds:[v]},{extent:{xmin:l,ymin:n,xmax:u,ymax:i},frameIds:[p]}):r.push({extent:{xmin:f,ymin:n,xmax:u,ymax:i},frameIds:[v]});return r}(e,t).map((function(e){return e.extent}));if(a.length<2)return a[0]||e;if(a.length>2)return e.xmin=t.valid[0],e.xmax=t.valid[1],e;return{rings:a.map((function(e){return[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]}))}}(p,a);else if(f.isPolygon(p)||f.isPolyline(p)){var h=b;l.getBoundsXY(h,p);var d={xmin:h[0],ymin:h[1],xmax:h[2],ymax:h[3]},y=L(d.xmin,i)*(2*n),g=0===y?p:function(e,t){for(var a=function(e){if(f.isPolygon(e))return e.rings;return e.paths}(e),r=0,n=a;r<n.length;r++)for(var i=n[r],s=0,m=i;s<m.length;s++){m[s][0]+=t}return e}(p,y);d.xmin+=y,d.xmax+=y,x.extentIntersectsPolyline(d,m)&&d.xmax!==n?v=g:x.extentIntersectsPolyline(d,c)&&d.xmin!==i?v=g:o=g}else o=e.clone();return null!==v?(new G).cut(v,n):o},t.getTextSymbolSize=W;var B={102100:{maxX:20037508.342788905,minX:-20037508.342788905,plus180Line:{paths:[[[20037508.342788905,-20037508.342788905],[20037508.342788905,20037508.342788905]]],spatialReference:c.WebMercator},minus180Line:{paths:[[[-20037508.342788905,-20037508.342788905],[-20037508.342788905,20037508.342788905]]],spatialReference:c.WebMercator}},4326:{maxX:180,minX:-180,plus180Line:{paths:[[[180,-180],[180,180]]],spatialReference:c.WGS84},minus180Line:{paths:[[[-180,-180],[-180,180]]],spatialReference:c.WGS84}}};function L(e,t){return Math.ceil((e-t)/(2*t))}function O(e,t){var a,r=t.valid,n=r[0],i=r[1],s=2*i,m=0;return e>i?(e-=(a=Math.ceil(Math.abs(e-i)/s))*s,m=a):e<n&&(e+=(a=Math.ceil(Math.abs(e-n)/s))*s,m=-a),{x:e,frameId:m}}function C(e,t){var a=t.xmin,r=t.ymin,n=t.xmax,i=t.ymax;return H(e,a,r)&&H(e,a,i)&&H(e,n,i)&&H(e,n,r)}function H(e,t,a){return t>=e.xmin&&t<=e.xmax&&a>=e.ymin&&a<=e.ymax}function q(e,t,a){var r;if(Array.isArray(e)){if((r=e[0])>t){var n=L(r,t);e[0]=r+n*(-2*t)}else if(r<a){n=L(r,a);e[0]=r+n*(-2*a)}}else if((r=e.x)>t){n=L(r,t);e.x+=n*(-2*t)}else if(r<a){n=L(r,a);e.x+=n*(-2*a)}return e}var G=function(){function e(){}return e.prototype.cut=function(e,t){var a;if(e.rings)this.closed=!0,a=e.rings,this.minPts=4;else{if(!e.paths)return null;this.closed=!1,a=e.paths,this.minPts=2}for(var r=a.length,n=-2*t,i=0;i<r;i++){var s=a[i];if(s&&s.length>=this.minPts){for(var m=[],c=0,o=s;c<o.length;c++){var l=o[c];m.push([l[0]+n,l[1]])}a.push(m)}}return this.closed?e.rings=a:e.paths=a,e},e}()}));