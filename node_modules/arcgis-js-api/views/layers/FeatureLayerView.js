// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../core/Error","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/SetUtils","../../core/watchUtils","../../core/accessorSupport/decorators","../../layers/support/fieldUtils","../../layers/support/timeUtils","../../support/arcadeOnDemand","../../tasks/support/Query","./support/FeatureEffect","./support/FeatureFilter","./support/popupUtils"],(function(e,t,r,i,o,n,l,s,a,u,p,d,c,y,f,m,h){Object.defineProperty(t,"__esModule",{value:!0});var F=o.getLogger("esri.views.layers.FeatureLayerView");t.FeatureLayerView=function(e){return function(e){function t(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var i=e.apply(this,t)||this;return i._updatingRequiredFieldsPromise=null,i.effect=null,i.filter=null,i.layer=null,i.requiredFields=[],i.view=null,i}return r.__extends(t,e),t.prototype.initialize=function(){var e=this;a.init(this,["layer.renderer","layer.labelingInfo","layer.elevationInfo.featureExpressionInfo","layer.displayField","filter","effect","layer.timeInfo","timeExtent"],(function(){return e._handleRequiredFieldsChange()}),!0)},Object.defineProperty(t.prototype,"availableFields",{get:function(){var e=this.layer,t=this.layer.fields,i=this.requiredFields;return"outFields"in e&&e.outFields?p.fixFields(t,r.__spreadArrays(p.unpackFieldNames(t,e.outFields),i)):p.fixFields(t,i)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maximumNumberOfFeatures",{get:function(){return 0},set:function(e){F.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maximumNumberOfFeaturesExceeded",{get:function(){return!1},enumerable:!0,configurable:!0}),t.prototype.highlight=function(e,t){throw void 0===t&&(t={}),new Error("missing implementation")},t.prototype.createQuery=function(){var e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=n.isSome(this.filter)?this.filter.createQuery(e):new y(e);return this.timeExtent&&(t.timeExtent=t.timeExtent?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t},t.prototype.queryFeatures=function(e,t){throw new Error("missing implementation")},t.prototype.queryObjectIds=function(e,t){throw new Error("missing implementation")},t.prototype.queryFeatureCount=function(e,t){throw new Error("missing implementation")},t.prototype.queryExtent=function(e,t){throw new Error("missing implementation")},t.prototype._loadArcadeModules=function(e){if(e.get("expressionInfos.length"))return c.loadArcade()},t.prototype._handleRequiredFieldsChange=function(){var e=this,t=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",t),t.then((function(){e._updatingRequiredFieldsPromise===t&&e._set("_updatingRequiredFieldsPromise",null)}))},t.prototype._updateRequiredFields=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,i,o,a,u,d,c,y,f,m,h,_,v,g;return r.__generator(this,(function(r){switch(r.label){case 0:return this.layer&&this.view?(e="3d"===this.view.type,i=(t=this).layer,o=t.layer,a=o.fields,u=o.objectIdField,d=o.renderer,c=o.displayField,y=i.featureReduction,f=new Set,[4,l.eachAlways([d?d.collectRequiredFields(f,a):null,p.collectLabelingFields(f,i),e?p.collectElevationFields(f,i):null,n.isSome(this.filter)?p.collectFilterFields(f,i,this.filter):null,this.effect?p.collectFilterFields(f,i,this.effect.filter):null,y?p.collectFeatureReductionFields(f,i,y):null])]):[2];case 1:for(m=r.sent(),i.timeInfo&&this.timeExtent&&p.collectFields(f,i.fields,[i.timeInfo.startField,i.timeInfo.endField]),h=0,_=m;h<_.length;h++)(v=_[h]).error&&F.error(v.error);return p.collectField(f,a,u),e&&c&&p.collectField(f,a,c),g=s.valuesOfSet(f).sort(),this._set("requiredFields",g),[2]}}))}))},t.prototype.validateFetchPopupFeatures=function(e){var t=this.layer;return this.layer.popupEnabled?h.getFetchPopupTemplate(this.layer,e)?void 0:new i("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:t}):new i("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:t})},t.prototype.fetchClientPopupFeatures=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,o,s,a,u,d,c,y,f,m,F;return r.__generator(this,(function(r){switch(r.label){case 0:return(t=n.isSome(e)?e.clientGraphics:null)&&0!==t.length?(i=[],o=[],s=this.layer,a=h.getFetchPopupTemplate(s,e),n.isSome(a)?[4,this._loadArcadeModules(a)]:[2,l.resolve([])]):[2,l.resolve([])];case 1:return u=r.sent(),d=u&&u.arcadeUtils.hasGeometryOperations(a),[4,this.createPopupQuery(e)];case 2:for(c=r.sent(),y=p.unpackFieldNames(s.fields,c.outFields),f=0,m=t;f<m.length;f++)F=m[f],d||!p.featureHasFields(y,F)?o.push(F):i.push(F);return"stream"===s.type||0===o.length?[2,l.resolve(i)]:(c.objectIds=o.map((function(e){return e.attributes[s.objectIdField]})),[2,s.queryFeatures(c).then((function(e){return i.concat(e.features)})).catch((function(){return o}))])}}))}))},t.prototype.createPopupQuery=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,o;return r.__generator(this,(function(r){switch(r.label){case 0:return t=this.layer,(i=t.createQuery()).returnGeometry=!0,i.returnZ=!0,i.returnM=!0,o=i,[4,h.getRequiredFields(this.layer,h.getFetchPopupTemplate(this.layer,e))];case 1:return o.outFields=r.sent(),i.outSpatialReference=this.view.spatialReference,[2,i]}}))}))},t.prototype.canResume=function(){var t;return!!e.prototype.canResume.call(this)&&(null===(t=this.timeExtent)||void 0===t?!0:!t.isEmpty)},r.__decorate([u.property()],t.prototype,"_updatingRequiredFieldsPromise",void 0),r.__decorate([u.property({readOnly:!0,dependsOn:["layer.outFields?","requiredFields"]})],t.prototype,"availableFields",null),r.__decorate([u.property({type:f})],t.prototype,"effect",void 0),r.__decorate([u.property({type:m})],t.prototype,"filter",void 0),r.__decorate([u.property(d.combinedViewLayerTimeExtentProperty)],t.prototype,"timeExtent",void 0),r.__decorate([u.property()],t.prototype,"layer",void 0),r.__decorate([u.property({type:Number})],t.prototype,"maximumNumberOfFeatures",null),r.__decorate([u.property({readOnly:!0,type:Boolean})],t.prototype,"maximumNumberOfFeaturesExceeded",null),r.__decorate([u.property({readOnly:!0})],t.prototype,"requiredFields",void 0),r.__decorate([u.property({dependsOn:["timeExtent"]})],t.prototype,"suspended",void 0),r.__decorate([u.property()],t.prototype,"view",void 0),t=r.__decorate([u.subclass("esri.views.layers.FeatureLayerView")],t)}(e)}}));