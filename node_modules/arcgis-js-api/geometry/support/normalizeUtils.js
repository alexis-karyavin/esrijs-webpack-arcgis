// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../config","../../core/Error","../../core/Logger","../../core/maybe","../../core/promiseUtils","../Polygon","../Polyline","../SpatialReference","./spatialReferenceUtils","./webMercatorUtils","../../tasks/geometry/cut","../../tasks/geometry/simplify"],(function(e,r,n,t,i,a,o,s,f,l,u,p,h,c,g){Object.defineProperty(r,"__esModule",{value:!0});var m=a.getLogger("esri.geometry.support.normalizeUtils"),v={102100:{maxX:20037508.342788905,minX:-20037508.342788905,plus180Line:new l({paths:[[[20037508.342788905,-20037508.342788905],[20037508.342788905,20037508.342788905]]],spatialReference:u.WebMercator}),minus180Line:new l({paths:[[[-20037508.342788905,-20037508.342788905],[-20037508.342788905,20037508.342788905]]],spatialReference:u.WebMercator})},4326:{maxX:180,minX:-180,plus180Line:new l({paths:[[[180,-180],[180,180]]],spatialReference:u.WGS84}),minus180Line:new l({paths:[[[-180,-180],[-180,180]]],spatialReference:u.WGS84})}};function x(e){return"polygon"===e.type}function y(e){return x(e)?e.rings:e.paths}function d(e,r){return Math.ceil((e-r)/(2*r))}function M(e,r){for(var n=0,t=y(e);n<t.length;n++)for(var i=0,a=t[n];i<a.length;i++){a[i][0]+=r}return e}function w(e){for(var r=[],n=0,t=0,i=0;i<e.length;i++){for(var a=e[i],o=null,s=0;s<a.length;s++)o=a[s],r.push(o),0===s?t=n=o[0]:(n=Math.min(n,o[0]),t=Math.max(t,o[0]));o&&r.push([(n+t)/2,0])}return r}function b(e,r){if(!(e instanceof l||e instanceof f)){var n="straightLineDensify: the input geometry is neither polyline nor polygon";throw m.error(n),new i(n)}for(var t=[],a=0,o=y(e);a<o.length;a++){var s=o[a],u=[];t.push(u),u.push([s[0][0],s[0][1]]);for(var p=0;p<s.length-1;p++){var h=s[p][0],c=s[p][1],g=s[p+1][0],v=s[p+1][1],d=Math.sqrt((g-h)*(g-h)+(v-c)*(v-c)),M=(v-c)/d,w=(g-h)/d,b=d/r;if(b>1){for(var R=1;R<=b-1;R++){var L=R*r,W=w*L+h,P=M*L+c;u.push([W,P])}var X=(d+Math.floor(b-1)*r)/2,_=w*X+h,z=M*X+c;u.push([_,z])}u.push([g,v])}}return x(e)?new f({rings:t,spatialReference:e.spatialReference}):new l({paths:t,spatialReference:e.spatialReference})}function R(e,r,n){if(r){var t=b(e,1e6);e=h.webMercatorToGeographic(t,!0)}return n&&(e=M(e,n)),e}function L(e,r,n){var t;if(Array.isArray(e)){if((t=e[0])>r){var i=d(t,r);e[0]=t+i*(-2*r)}else if(t<n){i=d(t,n);e[0]=t+i*(-2*n)}}else if((t=e.x)>r){i=d(t,r);e=e.clone().offset(i*(-2*r),0)}else if(t<n){i=d(t,n);e=e.clone().offset(i*(-2*n),0)}return e}r.straightLineDensify=b,r.normalizeCentralMeridian=function e(r,i,a){return n.__awaiter(this,void 0,void 0,(function(){var u,m,x,w,b,W,P,X,_,z,I,S,U,k,A,T,D,G,q,E,N,j,C,F,O,B,H,J,K,Q,V,Y,Z,$,ee,re,ne;return n.__generator(this,(function(n){switch(n.label){case 0:if(!Array.isArray(r))return[2,e([r],i)];for(u=i?i.url:t.geometryServiceUrl,z=0,I=[],S=[],U=0,k=r;U<k.length;U++)A=k[U],o.isNone(A)?S.push(A):(m||(m=A.spatialReference,x=p.getInfo(m),w=m.isWebMercator,b=v[P=w?102100:4326].maxX,W=v[P].minX,X=v[P].plus180Line,_=v[P].minus180Line),x?"mesh"===A.type?S.push(A):"point"===A.type?S.push(L(A.clone(),b,W)):"multipoint"===A.type?((T=A.clone()).points=T.points.map((function(e){return L(e,b,W)})),S.push(T)):"extent"===A.type?(G=A.clone(),D=G._normalize(!1,!1,x),S.push(D.rings?new f(D):D)):A.extent?(G=A.extent,q=d(G.xmin,W),N=0===(E=q*(2*b))?A.clone():M(A.clone(),E),G.offset(E,0),G.intersects(X)&&G.xmax!==b?(z=G.xmax>z?G.xmax:z,N=R(N,w),I.push(N),S.push("cut")):G.intersects(_)&&G.xmin!==W?(z=G.xmax*(2*b)>z?G.xmax*(2*b):z,N=R(N,w,360),I.push(N),S.push("cut")):S.push(N)):S.push(A.clone()):S.push(A));for(j=d(z,b),C=-90,F=j,O=new l;j>0;)B=360*j-180,O.addPath([[B,C],[B,-1*C]]),C*=-1,j--;return I.length>0&&F>0?[4,c.cut(u,I,O,a)]:[3,3];case 1:for(H=n.sent(),J=function(e,r){for(var n=-1,t=function(t){for(var i=r.cutIndexes[t],a=r.geometries[t],o=y(a),s=function(e){var r=o[e];r.some((function(n){if(n[0]<180)return!0;for(var t=0,i=0;i<r.length;i++){var o=r[i][0];t=o>t?o:t}for(var s=-360*d(t=Number(t.toFixed(9)),180),f=0;f<r.length;f++){var l=a.getPoint(e,f);a.setPoint(e,f,l.clone().offset(s,0))}return!0}))},f=0;f<o.length;f++)s(f);if(i===n){if("polygon"===e[0].type)for(var l=0,u=y(a);l<u.length;l++){var p=u[l];e[i]=e[i].addRing(p)}else if(function(e){return"polyline"===e[0].type}(e))for(var h=0,c=y(a);h<c.length;h++){var g=c[h];e[i]=e[i].addPath(g)}}else n=i,e[i]=a},i=0;i<r.cutIndexes.length;i++)t(i);return e}(I,H),K=[],Q=[],ee=0;ee<S.length;ee++)"cut"!==(re=S[ee])?Q.push(re):(ne=J.shift(),V=r[ee],o.isSome(V)&&"polygon"===V.type&&V.rings&&V.rings.length>1&&ne.rings.length>=V.rings.length?(K.push(ne),Q.push("simplify")):Q.push(w?h.geographicToWebMercator(ne):ne));return K.length?[4,g.simplify(u,K,a)]:[2,Q];case 2:for(Y=n.sent(),Z=[],ee=0;ee<Q.length;ee++)"simplify"!==(re=Q[ee])?Z.push(re):Z.push(w?h.geographicToWebMercator(Y.shift()):Y.shift());return[2,Z];case 3:for($=[],ee=0;ee<S.length;ee++)"cut"!==(re=S[ee])?$.push(re):(ne=I.shift(),$.push(!0===w?h.geographicToWebMercator(ne):ne));return[2,s.resolve($)]}}))}))},r.getDenormalizedExtent=function(e){var r;if(!e)return null;var n=e.extent;if(!n)return null;var t=e.spatialReference&&p.getInfo(e.spatialReference);if(!t)return n;var i,a=t.valid,o=a[0],s=a[1],f=2*s,l=n.width,u=n.xmin,h=n.xmax;if(u=(r=[h,u])[0],h=r[1],"extent"===e.type||0===l||l<=s||l>f||u<o||h>s)return n;switch(e.type){case"polygon":if(!(e.rings.length>1))return n;i=w(e.rings);break;case"polyline":if(!(e.paths.length>1))return n;i=w(e.paths);break;case"multipoint":i=e.points}for(var c=n.clone(),g=0;g<i.length;g++){var m=i[g][0];m<0?(m+=s,h=Math.max(m,h)):(m-=s,u=Math.min(m,u))}return c.xmin=u,c.xmax=h,c.width<l?(c.xmin-=s,c.xmax-=s,c):n},r.normalizeMapX=function(e,r){var n=p.getInfo(r);if(n){var t=n.valid,i=t[0],a=t[1],o=a-i;if(e<i)for(;e<i;)e+=o;if(e>a)for(;e>a;)e-=o}return e}}));