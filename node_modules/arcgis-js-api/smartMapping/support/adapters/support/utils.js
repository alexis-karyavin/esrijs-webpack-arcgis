// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/promiseUtils","../../../../renderers/support/heatmapUtils","../../utils","../../../../support/arcadeOnDemand","../../../../tasks/support/ClassBreaksDefinition","../../../../tasks/support/generateRendererUtils"],(function(e,a,n,t,r,i,o,l,u){Object.defineProperty(a,"__esModule",{value:!0});var s=/_value$/i,c=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,m=Math.LOG10E;a.statisticTypes=["min","max","avg","stddev","count","sum","variance"];var f=null;function d(e,a,n){return a=null==a?-1/0:a,n=null==n?1/0:n,e.filter((function(e){return null!=e&&I(e)&&e>=a&&e<=n}))}function v(e,a){return n.__awaiter(this,void 0,void 0,(function(){var t,r,i,l,u,s,c,m,d,v,h;return n.__generator(this,(function(n){switch(n.label){case 0:return t=e.field,r="function"==typeof t,i=e.valueExpression,l=e.normalizationType,u=e.normalizationField,s=e.normalizationTotal,c=[],m=e.view,d=null,v=null,i?f?[3,2]:[4,o.loadArcade()]:[3,3];case 1:h=n.sent().arcadeUtils,f=h,n.label=2;case 2:d=f.createFunction(i),v=m&&f.getViewInfo({viewingMode:"2d"===m.type?"map":m.viewingMode,scale:m.scale,spatialReference:m.spatialReference}),n.label=3;case 3:return a?(a.forEach((function(e){var a,n=e.attributes;if(i){var o=f.createExecContext(e,v);a=f.executeFunction(d,o)}else r?a=t.call(null,e):n&&(a=n[t]);if(l&&null!=a&&I(a)){var m=n&&parseFloat(n[u]);"log"===l&&0!==a?a=Math.log(a)*Math.LOG10E:"percent-of-total"===l&&I(s)&&0!==s?a=a/s*100:"field"===l&&I(m)&&0!==m&&(a/=m)}c.push(a)})),[2,c]):[2,c]}}))}))}function h(e){var a=e.field,n=e.classificationMethod||"equal-interval",t=e.normalizationType,r=e.normalizationField,i=new l;return i.classificationField=a,i.breakCount=e.breakCount,i.classificationMethod=n,i.standardDeviationInterval="standard-deviation"===n?e.standardDeviationInterval||1:void 0,i.normalizationType=t,i.normalizationField="field"===t?r:void 0,i}function p(e,a){var n=a.classBreaks,t=n.length,r=n[0].minValue,i=n[t-1].maxValue,o="standard-deviation"===e.classificationMethod,l=c;return{minValue:r,maxValue:i,classBreakInfos:n=n.map((function(e){var a=e.label,n={minValue:e.minValue,maxValue:e.maxValue,label:a};if(o&&a){var t=a.match(l).map((function(e){return+e.trim()}));2===t.length?(n.minStdDev=t[0],n.maxStdDev=t[1],t[0]<0&&t[1]>0&&(n.hasAvg=!0)):1===t.length&&(a.indexOf("<")>-1?(n.minStdDev=null,n.maxStdDev=t[0]):a.indexOf(">")>-1&&(n.minStdDev=t[0],n.maxStdDev=null))}return n})),normalizationTotal:a.normalizationTotal}}function g(e,a,n){for(var t,r=(a-e)/n,i=[],o=e,l=1;l<=n;l++)t=o+r,t=Number(t.toFixed(16)),i.push([o,t]),o=t;return i}function x(e){var a=e.field,n=e.normalizationType,t=e.normalizationField,r=e.normalizationTotal,o=e.layer,l=i.isIntegerField(o,a),u=a;return"percent-of-total"===n?u="(("+(l?i.castIntegerFieldToFloat(a):a)+" / "+r+") * 100)":"log"===n?u="(log("+a+") * "+m+")":"field"===n&&(u="("+(l?i.castIntegerFieldToFloat(a):a)+" / "+t+")"),u}function F(e,a){for(var n=-1,t=e.length-1;t>=0;t--){if(a>=e[t][0]){n=t;break}}return n}function V(e,a){var n;if(a=a.toLowerCase(),e)for(var t in e)if(t.toLowerCase()!==a){n=e[t];break}return n}function b(e,a){var n;if(a=a.toLowerCase(),e)for(var t in e)if(t.toLowerCase()===a){n=e[t];break}return n}function y(e,a){if(a)for(var n in e)e[n].label=a[n];return{count:e}}function T(e,a,n){var t=e.count,r=[];n&&a&&"coded-value"===a.type&&a.codedValues.forEach((function(e){var a=e.code;t.hasOwnProperty(a)||(t[a]={data:a,count:0})}));for(var i in t){var o=t[i];r.push({value:o.data,count:o.count,label:o.label})}return{uniqueValueInfos:r}}function I(e){return"number"==typeof e&&!isNaN(e)&&e!==1/0&&e!==-1/0}a.getSummaryStatisticsFromFeatureSet=function(e,a){var n=e&&e.features,t=n&&n[0]&&n[0].attributes,r={};for(var i in t)r[i.replace(s,"").toLowerCase()]=t[i];return r.min===r.max&&null!=r.min&&null==r.stddev&&(r.stddev=r.variance=0),a&&(["min","max","avg","stddev","sum","variance"].forEach((function(e){null!=r[e]&&(r[e]=Math.ceil(r[e]))})),r.min===r.max&&null!=r.min&&(r.avg=r.min,r.stddev=r.variance=0)),r},a.calculateStatsFromMemory=function(e,a,t){return n.__awaiter(this,void 0,void 0,(function(){var r,i;return n.__generator(this,(function(n){switch(n.label){case 0:return[4,v(e,a)];case 1:return r=d(r=n.sent(),e.minValue,e.maxValue),i=function(e,a){for(var n=Number.POSITIVE_INFINITY,t=Number.NEGATIVE_INFINITY,r=null,i=null,o=null,l=null,u=0,s=e;u<s.length;u++){var c=s[u];r+=c,n=Math.min(n,c),t=Math.max(t,c)}var m=e.length;if(m){i=r/m;for(var f=0,d=0,v=e;d<v.length;d++){c=v[d];f+=Math.pow(c-i,2)}l=a?m>1?f/(m-1):0:m>0?f/m:0,o=Math.sqrt(l)}else n=null,t=null;return{avg:i,count:m,max:t,min:n,stddev:o,sum:r,variance:l}}(r,!e.normalizationType),t&&["avg","stddev","variance"].forEach((function(e){null!=i[e]&&(i[e]=Math.ceil(i[e]))})),[2,i]}}))}))},a.getDataValues=v,a.processSummaryStatisticsResult=function(e){var n;for(n in e)a.statisticTypes.indexOf(n)>-1&&(I(e[n])||(e[n]=null));return e},a.createCBDefn=h,a.calculateHeatmapStats=function(e,a,n,t,i,o){void 0===a&&(a=10);for(var l=new Float64Array(i*o),u=r.createKernel(a),s=Math.round(3*a),c=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,f=0,d=0,v=0,h=0,p=r.createValueFunction(t,n),g=0,x=e;g<x.length;g++)for(var F=x[g],V=F.geometry,b=F.attributes,y=V.x-s,T=V.y-s,I=Math.max(0,y),z=Math.max(0,T),w=Math.min(o,V.y+s),E=Math.min(i,V.x+s),M=+p(b),_=z;_<w;_++)for(var S=u[_-T],N=I;N<E;N++){var D=u[N-y],C=_*i+N,k=l[C],O=(f=l[C]+=S*D*M)-k;d+=O,v+=O*O,f<c&&(c=f),f>m&&(m=f),h++}if(!h)return{mean:0,stddev:0,min:0,max:0,mid:0,count:0};var q=(m-c)/2;return{mean:d/h,stdDev:Math.sqrt((v-d*d/h)/h),min:c,max:m,mid:q,count:h}},a.calculateClassBreaksFromMemory=function(e,a){return n.__awaiter(this,void 0,void 0,(function(){var t,r,i,o;return n.__generator(this,(function(n){switch(n.label){case 0:return t=e.normalizationTotal,r=h({field:e.field,normalizationType:e.normalizationType,normalizationField:e.normalizationField,classificationMethod:e.classificationMethod,standardDeviationInterval:e.standardDeviationInterval,breakCount:e.numClasses||5}),[4,v(e,a)];case 1:return i=d(i=n.sent(),e.minValue,e.maxValue),o=u.createGenerateRendererClassBreaks({definition:r,values:i,normalizationTotal:t}),[2,p(e,o)]}}))}))},a.resolveCBResult=p,a.getEqualIntervalBins=g,a.generateBinParams=function(e){var a=[],n=e.classBreaks,t=n[0].minValue,r=n[n.length-1].maxValue;n.forEach((function(e){a.push([e.minValue,e.maxValue])}));var i={field:e.field,normalizationType:e.normalizationType,normalizationField:e.normalizationField,normalizationTotal:e.normalizationTotal,layer:e.layer};return{min:t,max:r,intervals:a,sqlExpr:x(i),excludeZerosExpr:e.where,normTotal:e.normalizationTotal}},a.getFieldExpr=x,a.calculateHistogramFromMemory=function(e,a,t){return n.__awaiter(this,void 0,void 0,(function(){var r,i,o,l,u,s,c,m,f,d,h;return n.__generator(this,(function(n){switch(n.label){case 0:return r=a.min,i=a.max,o=a.normTotal,l=e.numBins||10,u=a.intervals||g(r,i,l),s=u.map((function(e,a){return{minValue:u[a][0],maxValue:u[a][1],count:0}})),[4,v(e,t)];case 1:for(c=n.sent(),m=0,f=c;m<f.length;m++)null!=(d=f[m])&&d>=r&&d<=i&&(h=F(u,d))>-1&&s[h].count++;return[2,{bins:s,minValue:r,maxValue:i,normalizationTotal:o}]}}))}))},a.getHistogramFromFeatureSet=function(e,a,n,t,r){var i={};e&&e.features&&e.features.forEach((function(e){var a=e.attributes,n=V(a,"countOFExpr"),t=b(a,"countOFExpr");0!==n&&(i[n]=t)}));var o=[];return g(a,n,t).forEach((function(e,a){var n=(a+1).toString();o.push({minValue:e[0],maxValue:e[1],count:i.hasOwnProperty(n)?i[n]:0})})),{bins:o,minValue:a,maxValue:n,normalizationTotal:r}},a.getUniqueValuesFromFeatureSet=function(e,a,n,r,i){var o=e&&e.features,l="countOF"+(n||"Expr"),u={},s=!1;if(o.forEach((function(e){var a=e.attributes,t=b(a,l),r=n?b(a,n):V(a,l);null===r&&0===t&&(s=!0),(null==r||"string"==typeof r&&""===r.trim())&&(r=null),null==u[r]?u[r]={count:t,data:r}:u[r].count=u[r].count+t})),n&&s){var c=n+" is NULL";return a.queryFeatureCount(c,i).then((function(e){return e=e||0,u.null.count=u.null.count+e,y(u,r)})).catch((function(){return t.throwIfAborted(i),y(u,r)}))}return t.resolve(y(u,r))},a.createUVResult=T,a.calculateUniqueValuesFromMemory=function(e,a,t){return n.__awaiter(this,void 0,void 0,(function(){var r,i,o,l,u;return n.__generator(this,(function(n){switch(n.label){case 0:return[4,v(e,a)];case 1:for(r=n.sent(),i={},o=0,l=r;o<l.length;o++)(null==(u=l[o])||"string"==typeof u&&""===u.trim())&&(u=null),null==i[u]?i[u]={count:1,data:u}:i[u].count++;return[2,T({count:i},t,e.returnAllCodedValues)]}}))}))},a.msSinceUnixEpochSQL=function(e,a){return i.getDateDiffSQL(e,new Date(0),a,"milliseconds").sqlExpression},a.isValidNumber=I}));