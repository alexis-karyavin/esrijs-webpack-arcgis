// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../Graphic","../../../core/arrayUtils","../../../core/Error","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../layers/support/fieldUtils","../../statistics/support/utils","./FeatureLayerAdapter","./LayerAdapter","./support/utils","../../../tasks/support/FeatureSet"],(function(e,t,r,a,s,i,n,o,u,l,c,p,d,m,h){return function(e){function t(t){return e.call(this,t)||this}return r.__extends(t,e),t.prototype._hasCachedStatistics=function(e){return this.layer.hasCachedStatistics(e)},t.prototype._fetchFeaturesFromMemory=function(e,t){return e?e.whenLayerView(this.layer).then((function(e){var r=o.whenFalseOnce(e,"updating").then((function(){return e.queryFeatures(t)})).then((function(e){return"esri.tasks.support.FeatureSet"===e.declaredClass?e.features:e}));return n.timeout(r,1e4,null)})):n.reject(new i("scene-layer-adapter:insufficient-data","view is required to fetch the features from layerView"))},t.prototype._generateFeatureSetForCachedHistogram=function(e,t,r,s){void 0===t&&(t=e.minimum),void 0===r&&(r=e.maximum);for(var i=[],n=0;n<s;n++)i[n]=0;var o=e.counts.length,u=e.minimum,l=e.maximum;for(n=0;n<o;n++){var c=(n+.5)/o,p=((1-c)*u+c*l-t)/(r-t)*s;p>=0&&p<=s&&(i[p===s?s-1:Math.floor(p)]+=e.counts[n])}var d=[];i.forEach((function(e,t){var r=new a({attributes:{}});r.attributes.EXPR_1=t+1,r.attributes.countOFExpr=e,d.push(r)}));var m=new h;return m.features=d,m},t.prototype._getCachedStatistics=function(e,t){var r=this.layer;return e.valueExpression||e.sqlExpression||e.sqlWhere||e.minValue||e.maxValue?n.reject(new i("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression', 'sqlExpression', 'sqlWhere', 'minValue' or 'maxValue' is specified")):r.queryCachedStatistics(t&&t.name,{signal:e.signal}).then((function(e){var t=e.stats,r=t.min,a=t.max,s=t.avg,i=t.stddev,n=t.sum,o=t.variance,u=t.count;return 0===r&&0===a||(s=0===s?null:s,n=0===n?null:n,i=0===i?null:i,o=0===o?null:o,u=0===u?null:u),null==u&&null!=n&&null!=s&&(u=Math.round(n/s)),{avg:s,count:u,max:a,min:r,stddev:i,sum:n,variance:o}}))},t.prototype._getSummaryStatisticsFromMemory=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var a,s,n,o,u,c,p;return r.__generator(this,(function(d){switch(d.label){case 0:return e.features?(s=e.features,[3,3]):[3,1];case 1:return[4,this._fetchFeaturesFromMemory(e.view)];case 2:s=d.sent(),d.label=3;case 3:if(!((a=s)&&a.length))throw new i("scene-layer-adapter:insufficient-data","No features are available to calculate statistics");return n=l.isDateField(t),"percent-of-total"!==(o=r.__assign({},e)).normalizationType?[3,5]:[4,m.calculateStatsFromMemory({field:o.field},a)];case 4:if(u=d.sent(),null==(c=u.sum))throw new i("scene-layer-adapter:invalid","invalid normalizationTotal");o.normalizationTotal=c,d.label=5;case 5:return[4,m.calculateStatsFromMemory(o,a,n)];case 6:return p=d.sent(),[2,m.processSummaryStatisticsResult(p)]}}))}))},t.prototype._getCachedStatisticsForUniqueValues=function(e,t){var r=this,s=this.layer,o=t&&t.name,u=t&&this.getFieldDomain(e.field);return e.valueExpression||e.sqlExpression||e.sqlWhere?n.reject(new i("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression', 'sqlExpression' or 'sqlWhere' is specified")):s.queryCachedStatistics(o,{signal:e.signal}).then((function(i){var n=i.stats,u=i.labels&&i.labels.labels,c={},p=[];if(n.mostFrequentValues){var d="countOF"+o;n.mostFrequentValues.forEach((function(e){var r=new a({attributes:{}});r.attributes[o]=t&&t.name!==s.objectIdField&&(l.isNumericField(t)||l.isDateField(t))?Number(e.value):e.value,r.attributes[d]=e.count,p.push(r)})),u&&u.forEach((function(e){c[e.value]=e.label}))}var f=new h;return f.features=p,m.getUniqueValuesFromFeatureSet(f,r,e.field,c,e.signal)})).then((function(t){return m.createUVResult(t,u,e.returnAllCodedValues)}))},t.prototype._getUniqueValuesFromMemory=function(e,t){var r=t&&this.getFieldDomain(e.field);return(e.features?n.resolve(e.features):this._fetchFeaturesFromMemory(e.view)).then((function(t){return m.calculateUniqueValuesFromMemory(e,t,r)}))},t.prototype._getCachedStatisticsForHistogram=function(e,t){var r=this,a=this.layer;return e.valueExpression||e.sqlExpression||e.sqlWhere||e.normalizationType?n.reject(new i("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression' or 'sqlExpression' or 'sqlWhere' or 'normalizationType' is specified")):a.queryCachedStatistics(t&&t.name,{signal:e.signal}).then((function(t){var a=t.stats,s=e.minValue,i=e.maxValue,n=null!=s?s:a.min,o=null!=i?i:a.max,u=e.numBins||10,l=r._generateFeatureSetForCachedHistogram(a.histogram,n,o,u);return m.getHistogramFromFeatureSet(l,n,o,u)}))},t.prototype._getClassBreaksFromMemory=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,a,s,n,o;return r.__generator(this,(function(u){switch(u.label){case 0:return e.features?(a=e.features,[3,3]):[3,1];case 1:return[4,this._fetchFeaturesFromMemory(e.view)];case 2:a=u.sent(),u.label=3;case 3:if(!((t=a)&&t.length))throw new i("scene-layer-adapter:insufficient-data","No features are available to calculate statistics");return"percent-of-total"!==(s=r.__assign({},e)).normalizationType?[3,5]:[4,m.calculateStatsFromMemory({field:s.field},t)];case 4:if(n=u.sent(),null==(o=n.sum))throw new i("scene-layer-adapter:invalid","invalid normalizationTotal");s.normalizationTotal=o,u.label=5;case 5:return[2,m.calculateClassBreaksFromMemory(s,t)]}}))}))},t.prototype._getHistogramFromMemory=function(e){var t=this;return(e.features?n.resolve(e.features):this._fetchFeaturesFromMemory(e.view)).then((function(a){if(!(a&&a.length))throw new i("scene-layer-adapter:insufficient-data","No features are available to calculate histogram");var s=e.field,o=e.normalizationType,u=e.valueExpression,l=e.classificationMethod,c=e.minValue,p=e.maxValue,d=e.view,h=null;if((!l||"equal-interval"===l)&&!o)h=null!=c&&null!=p?n.resolve({min:c,max:p}):t.summaryStatistics({field:s,valueExpression:u,features:a,view:d,signal:e.signal}).then((function(e){return e.count?{min:e.min,max:e.max}:n.reject(new i("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"))}));else{var f=r.__assign({},e);f.features=a,h=t._getBinParamsFromMemory(f)}return h.then((function(t){return m.calculateHistogramFromMemory(e,t,a)}))}))},t.prototype._getBinParamsFromMemory=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,a,s,i,n,o,u,l,p,d,h=this;return r.__generator(this,(function(r){return t=e.field,a=e.valueExpression,s=e.classificationMethod,i=e.standardDeviationInterval,n=e.normalizationType,o=e.normalizationField,u=e.minValue,l=e.maxValue,p=e.features,d=e.view,[2,this._getClassBreaksFromMemory({field:t,valueExpression:a,normalizationType:n,normalizationField:o,classificationMethod:s,standardDeviationInterval:i,minValue:u,maxValue:l,numClasses:e.numBins,features:p,view:d}).then((function(e){var r=e.normalizationTotal,a=e.classBreakInfos,s=c.getSQLFilterForNormalization({field:t,normalizationType:n,normalizationField:o});return m.generateBinParams({field:t,normalizationType:n,normalizationField:o,normalizationTotal:r,classBreaks:a,where:s,layer:h})}))]}))}))},t.prototype.getField=function(e){return void 0===e&&(e=""),this.layer.getField(e)},t.prototype.getFieldUsageInfo=function(e){var t=this.getField(e);if(!t)return null;var r=this.layer.getFieldUsageInfo(t.name);return{supportsLabelingInfo:r.supportsLabelingInfo,supportsPopupTemplate:r.supportsPopupTemplate,supportsRenderer:r.supportsRenderer,supportsLayerQuery:r.supportsLayerQuery,supportsStatistics:!0}},t.prototype.getFieldDomain=function(e,t){return this._featureLayerAdapter?this._featureLayerAdapter.getFieldDomain(e,t):null},t.prototype.summaryStatistics=function(e){var t=this,r=this.getField(e.field);return this._featureLayerAdapter?this._featureLayerAdapter.summaryStatistics(e):this._hasCachedStatistics(r&&r.name)?this._getCachedStatistics(e,r).catch((function(){return n.throwIfAborted(e.signal),t._getSummaryStatisticsFromMemory(e,r)})):this._getSummaryStatisticsFromMemory(e,r)},t.prototype.uniqueValues=function(e){var t=this,r=this.getField(e.field);return this._featureLayerAdapter?this._featureLayerAdapter.uniqueValues(e):this._hasCachedStatistics(r&&r.name)?this._getCachedStatisticsForUniqueValues(e,r).catch((function(){return n.throwIfAborted(e.signal),t._getUniqueValuesFromMemory(e,r)})):this._getUniqueValuesFromMemory(e,r)},t.prototype.histogram=function(e){var t=this,r=this.getField(e.field);return this._featureLayerAdapter?this._featureLayerAdapter.histogram(e):this._hasCachedStatistics(r&&r.name)?this._getCachedStatisticsForHistogram(e,r).catch((function(){return n.throwIfAborted(e.signal),t._getHistogramFromMemory(e)})):this._getHistogramFromMemory(e)},t.prototype.classBreaks=function(e){var t=this.getField(e.field);return this._featureLayerAdapter?this._featureLayerAdapter.classBreaks(e):this._hasCachedStatistics(t&&t.name)?n.reject(new i("scene-layer-adapter:not-supported","Cached stats not supported")):this._getClassBreaksFromMemory(e)},t.prototype.queryFeatureCount=function(e,t){return this._featureLayerAdapter?this._featureLayerAdapter.queryFeatureCount(e,t):n.reject(new i("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support count query"))},t.prototype.generateRenderer=function(e,t){return this._featureLayerAdapter?this._featureLayerAdapter.generateRenderer(e,t):n.reject(new i("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support generateRenderer operation"))},t.prototype.heatmapStatistics=function(e){return this._featureLayerAdapter?this._featureLayerAdapter.heatmapStatistics(e):n.reject(new i("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support heatmapStatistics operation"))},t.prototype.predominantCategories=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){if(this._featureLayerAdapter)return[2,this._featureLayerAdapter.predominantCategories(e)];throw new i("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support predominantCategories")}))}))},t.prototype.getSampleFeatures=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,a,n,o,u,l,c;return r.__generator(this,(function(p){switch(p.label){case 0:if("mesh"===this.layer.geometryType)throw new i("scene-layer-adapter:not-supported","getSampleFeatures does not support scene layer with mesh geometry type");t=e.view,a=e.sampleSize,n=1,(o=this.layer.createQuery()).outFields=null,o.returnGeometry=!0,o.where=null,o.num=a,u=[],p.label=1;case 1:return p.trys.push([1,3,,4]),[4,this._fetchFeaturesFromMemory(t,o)];case 2:return(u=p.sent()).length&&a>0&&a<=u.length?[2,s.pickRandom(u,a,n)]:[3,4];case 3:return p.sent(),[3,4];case 4:return l=null,this._featureLayerAdapter?(delete(c=r.__assign({},e)).view,[4,this._featureLayerAdapter.getSampleFeatures(c)]):[3,6];case 5:l=p.sent(),p.label=6;case 6:return l&&l.length?[2,l]:[2,s.pickRandom(u,u.length,n)]}}))}))},t.prototype.load=function(e){var t=this,r=this.layer.load(e).then((function(r){var a=r.associatedLayer;if(t.geometryType=r.geometryType,a)return t._featureLayerAdapter=new p({layer:a}),t._featureLayerAdapter.load(e).then((function(){t.objectIdField=t._featureLayerAdapter.objectIdField,t.supportsSQLExpression=t._featureLayerAdapter.supportsSQLExpression,t.minScale=t._featureLayerAdapter.minScale,t.maxScale=t._featureLayerAdapter.maxScale,t.fullExtent=t._featureLayerAdapter.fullExtent}));t.objectIdField=r.objectIdField,t.supportsSQLExpression=!1,t.hasQueryEngine=!1,t.fullExtent=r.fullExtent}));return this.addResolvingPromise(r),n.resolve(this)},r.__decorate([u.property({constructOnly:!0})],t.prototype,"layer",void 0),t=r.__decorate([u.subclass("esri.smartMapping.support.adapters.SceneLayerAdapter")],t)}(d)}));