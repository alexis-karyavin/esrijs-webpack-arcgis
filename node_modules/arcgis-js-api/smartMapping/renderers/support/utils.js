// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../Color","../../../symbols","../../../core/compilerUtils","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../intl/date","../../../renderers/support/numberUtils","../../../renderers/support/pointCloud/PointSizeSplatAlgorithm","../../heuristics/outline","../../statistics/classBreaks","../../statistics/summaryStatistics","../../support/utils","../../../views/support/colorUtils"],(function(e,t,n,r,i,o,a,l,s,u,c,m,d,f,y,p,h){Object.defineProperty(t,"__esModule",{value:!0});var v=/^(\d+(\.\d+)?)\s*(%)$/i,g=[0,0,0,.4],b=["hours","minutes","seconds"],w=[].concat(p.defaultBasemapGroups.light).concat(p.defaultBasemapGroups.dark);function S(e,t){return new a(e,t)}function D(e,t,n){var r,i,o=function(e){var t,n,r=e&&e.statistics;r||(r={});if(null==r.min)if(e.isDate){var i=z();t=i[0],n=i[1]}else t=0,n=100;else if(r.min===r.max)if(e.isDate){var o=z(r.min);t=o[0],n=o[1]}else r.min<0?(t=2*r.min,n=0):r.min>0?(t=0,n=2*r.min):(t=0,n=100);return{min:null!=t?t:r.min,max:null!=n?n:r.max,defaultValuesUsed:null!=t||null!=n}}({statistics:e,isDate:t});return o.defaultValuesUsed?(r=o.min,i=o.max):!n||null!=e.avg&&e.stddev||(r=e.min,i=e.max),null!=r?[r,i]:null}function z(e){var t=("number"==typeof e?new Date(e):new Date).getUTCFullYear(),n=Date.UTC(t,0,1,12,0,0,0),r=Date.UTC(t,11,31,12,0,0,0);return"number"==typeof e&&(e<n&&(n=e),e>r&&(r=e)),[n,r]}t.formatDate=function(e,t,n){if("string"==typeof e){var r=n.getField(e);if(r&&"date"===r.type)return r.alias||r.name}else if("number"==typeof e||e instanceof Date){var i=b.indexOf(t)>-1?"short-date-short-time":"short-date";return u.formatDate(e,u.convertDateFormatToIntlOptions(i))}return e},t.createError=S,t.getDefaultDataRange=D,t.createColors=function(e,t){for(var n=[],i=e.length,o=0;o<t;o++)n.push(new r(e[o%i]));return n},t.createStopValues=function(e,t){void 0===t&&(t=!0);var n=e.avg,r=n-e.stddev,i=n+e.stddev;r<e.min&&(r=e.min),i>e.max&&(i=e.max),t&&(n=r+(i-r)/2);var o=c.round([r,i],{strictBounds:!0});return o=[r=o[0],r+(n-r)/2,n,n+((i=o[1])-n)/2,i],c.round(o,{strictBounds:!0})},t.getSymbolSizeFromScheme=function(e,t,n){switch(t){case"point":case"multipoint":return n?"noDataSize"in e?e.noDataSize:null:"size"in e?e.size:null;case"polyline":return n?"noDataWidth"in e?e.noDataWidth:null:"width"in e?e.width:null;case"polygon":return"size"in e?e.size:null;case"mesh":return;default:return void o.neverReached(t)}},t.getSymbolOutlineFromScheme=function(e,t,n){switch(t){case"point":case"multipoint":case"polygon":if(!("outline"in e))return null;var r={color:e.outline.color,width:e.outline.width};if(null!=n&&r.color){var i=r.color.clone();i.a=n,r.color=i}return r;case"polyline":case"mesh":return;default:return void o.neverReached(t)}},t.createSymbol=function(e,t){var n,r=t.type,o=t.size,a=t.color,l=t.outline;switch(e){case"point":case"multipoint":if("2d"===r)n=new i.SimpleMarkerSymbol({color:a,size:o,outline:{color:l.color,width:l.width}});else if("3d-flat"===r)n=new i.PointSymbol3D({symbolLayers:[new i.IconSymbol3DLayer({size:o,resource:{primitive:"circle"},material:{color:a},outline:{color:l.color,size:l.width}})]});else if(r.indexOf("3d-volumetric")>-1){var s="3d-volumetric-uniform"===r,u=s?"sphere":"cylinder",c=new i.ObjectSymbol3DLayer({height:o,resource:{primitive:u},material:{color:a}});s||(c.width=t.widthAndDepth,c.depth=t.widthAndDepth),n=new i.PointSymbol3D({symbolLayers:[c]})}break;case"polyline":"2d"===r?n=new i.SimpleLineSymbol({color:a,width:o}):"3d-flat"===r?n=new i.LineSymbol3D({symbolLayers:[new i.LineSymbol3DLayer({size:o,material:{color:a}})]}):"3d-volumetric"===r&&(n=new i.LineSymbol3D({symbolLayers:[new i.PathSymbol3DLayer({size:o,material:{color:a}})]}));break;case"polygon":"2d"===r?n=new i.SimpleFillSymbol({color:a,outline:{color:l.color,width:l.width}}):"3d-flat"===r?n=new i.PolygonSymbol3D({symbolLayers:[new i.FillSymbol3DLayer({material:{color:a},outline:{color:l.color,size:l.width}})]}):"3d-volumetric"===r&&(n=new i.PolygonSymbol3D({symbolLayers:[new i.ExtrudeSymbol3DLayer({size:o,material:{color:a}})]}));break;case"mesh":var m=t.meshInfo&&t.meshInfo.colorMixMode,d=t.meshInfo&&t.meshInfo.edgesType;n=new i.MeshSymbol3D({symbolLayers:[new i.FillSymbol3DLayer({material:{color:a,colorMixMode:m},edges:null==d||"none"===d?null:{type:d,color:g}})]})}return n},t.verifyBasicFieldValidity=function(e,t,n){var r=function(e){var t=e.layer;return e.fields.filter((function(e){return!t.getField(e)}))}({layer:e,fields:t});if(r.length)return S(n,"Unknown fields: "+r.join(", ")+". You can only use fields defined in the layer schema");var i=function(e){var t=e.layer;return e.fields.filter((function(e){var n=t.getFieldUsageInfo(e);return!n||!n.supportsRenderer}))}({layer:e,fields:t});return i.length?S(n,"Unsupported fields: "+i.join(", ")+". You can only use fields that are accessible to the renderer i.e. FieldUsageInfo.supportsRenderer must be true"):void 0},t.getClassBreaks=function(e,t){return n.__awaiter(this,void 0,void 0,(function(){var r,i,o,a,l,u;return n.__generator(this,(function(c){switch(c.label){case 0:return r={layer:e.layer,view:e.view,signal:e.signal},[4,s.all([f(e),t?d(r):null])];case 1:return i=c.sent(),o=i[0],a=i[1],(l=D({min:o.minValue,max:o.maxValue,avg:null,stddev:null},!1,!1))?[4,f(n.__assign(n.__assign({},e),{classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:l[0],maxValue:l[1],normalizationTotal:l[0]+l[1]}))]:[3,3];case 2:return u=c.sent(),[3,4];case 3:u=o,c.label=4;case 4:return[2,{result:u,defaultValuesUsed:!!l,outlineResult:a}]}}))}))},t.getSummaryStatistics=function(e){return y(e)},t.getSizeRangeForAxis=function(e,t){var n=e.minSize,r=e.maxSize;if("height"===t){n=((r-n)/2+n)/4.6,r*=2}return{minSize:n,maxSize:r}},t.isValidPointSize=function(e){return v.test(e)},t.getPointSizeAlgorithm=function(e){var t=e.match(v),n=Number(t[1]);if("%"===t[3])return new m.default({scaleFactor:n/100})},t.updateAgeRendererAuthoringInfoVV=function(e,t,n,r){e.startTime=t instanceof Date?t.getTime():t,e.endTime=n instanceof Date?n.getTime():n,e.units=r,e.field="string"==typeof t?t:"string"==typeof n?n:null},t.getBasemapInfo=function(e,t){return n.__awaiter(this,void 0,void 0,(function(){var r,i,o;return n.__generator(this,(function(n){switch(n.label){case 0:return r=null,i=null,e||t?(!e&&t&&(e=t&&t.get("map.basemap")),e&&(r=p.getBasemapId(e,w,!1))&&(o=p.getBasemapGroup(r),l.isSome(o)&&(i=o)),r||!t?[3,2]:[4,h.getBackgroundColorTheme(t)]):[2,{basemapId:r,basemapTheme:i}];case 1:i=n.sent(),l.isSome(i)&&(r="dark"===i?"dark-gray":"gray"),n.label=2;case 2:return[2,{basemapId:r,basemapTheme:i}]}}))}))}}));