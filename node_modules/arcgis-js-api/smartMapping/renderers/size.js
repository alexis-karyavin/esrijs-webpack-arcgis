// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../renderers","../../core/Error","../../core/maybe","../../core/promiseUtils","../../core/screenUtils","../../intl/messages","../../intl/substitute","../../renderers/support/AuthoringInfo","../../renderers/support/AuthoringInfoVisualVariable","../../renderers/support/utils","../../renderers/visualVariables/SizeVariable","../heuristics/ageUnit","../heuristics/outline","../heuristics/sizeRange","./support/utils","../statistics/support/ageUtils","../support/utils","../symbology/size"],(function(e,i,a,n,r,s,l,t,o,u,m,d,p,c,y,b,f,v,h,g,w){Object.defineProperty(i,"__esModule",{value:!0});var z=Math.pow(2,53)-1;function S(e){return a.__awaiter(this,void 0,void 0,(function(){var i,n,l,t,o,u,m;return a.__generator(this,(function(d){switch(d.label){case 0:if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new r("size-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new r("size-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");if(i=a.__assign({},e),n=[0,2,1,3],l=g.createLayerAdapter(i.layer,n),i.layer=l,!l)throw new r("size-visual-variable:invalid-parameters","'layer' must be one of these types: "+g.getLayerTypeLabels(n).join(", "));return"height"===i.axis&&(i.sizeOptimizationEnabled=!1),t=s.isSome(i.signal)?{signal:i.signal}:null,[4,l.load(t)];case 1:if(d.sent(),"mesh"===(o=l.geometryType))throw new r("size-visual-variable:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(i.worldScale){if("polyline"===o||"polygon"===o)throw new r("size-visual-variable:not-supported","'worldScale' sizing is not supported for polyline and polygon layers");if(!i.view||"3d"!==i.view.type)throw new r("size-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true")}return[4,g.getFieldsList({field:i.field,normalizationField:i.normalizationField,valueExpression:i.valueExpression})];case 2:if(u=d.sent(),m=v.verifyBasicFieldValidity(l,u,"size-visual-variable:invalid-parameters"))throw m;return[2,i]}}))}))}function x(e){return a.__awaiter(this,void 0,void 0,(function(){var i,n,l,t,o,u,m,d;return a.__generator(this,(function(p){switch(p.label){case 0:if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new r("size-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new r("size-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");if((i=a.__assign({},e)).symbolType=i.symbolType||"2d",i.defaultSymbolEnabled=null==i.defaultSymbolEnabled||i.defaultSymbolEnabled,n=[0,2,1,3],l=g.createLayerAdapter(i.layer,n),i.layer=l,!l)throw new r("size-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+g.getLayerTypeLabels(n).join(", "));return t=s.isSome(i.signal)?{signal:i.signal}:null,[4,l.load(t)];case 1:if(p.sent(),o=l.geometryType,u=i.symbolType.indexOf("3d")>-1,i.outlineOptimizationEnabled="polygon"===o&&i.outlineOptimizationEnabled,"mesh"===o)throw new r("size-continuous-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(u&&("polyline"===o||"polygon"===o))throw new r("size-continuous-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.indexOf("3d-volumetric")>-1&&(!i.view||"3d"!==i.view.type))throw new r("size-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");return[4,g.getFieldsList({field:i.field,normalizationField:i.normalizationField,valueExpression:i.valueExpression})];case 2:if(m=p.sent(),d=v.verifyBasicFieldValidity(l,m,"size-continuous-renderer:invalid-parameters"))throw d;return[2,i]}}))}))}function T(e){return a.__awaiter(this,void 0,void 0,(function(){var i,n,l,t,o,u,m,d;return a.__generator(this,(function(p){switch(p.label){case 0:if(!e||!e.layer||!e.field&&!e.valueExpression)throw new r("size-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(e.valueExpression&&!e.view)throw new r("size-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");if((i=a.__assign({},e)).symbolType=i.symbolType||"2d",i.defaultSymbolEnabled=null==i.defaultSymbolEnabled||i.defaultSymbolEnabled,i.classificationMethod=i.classificationMethod||"equal-interval",i.normalizationType=g.getNormalizationType(i),n=[0,2,1,3],l=g.createLayerAdapter(i.layer,n),i.layer=l,!l)throw new r("size-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+g.getLayerTypeLabels(n).join(", "));if(!(null!=i.minValue&&null!=i.maxValue)&&(null!=i.minValue||null!=i.maxValue))throw new r("size-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range");return t=s.isSome(i.signal)?{signal:i.signal}:null,[4,l.load(t)];case 1:if(p.sent(),o=l.geometryType,u=i.symbolType.indexOf("3d")>-1,i.outlineOptimizationEnabled="polygon"===o&&i.outlineOptimizationEnabled,"mesh"===o)throw new r("size-class-breaks-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(u&&("polyline"===o||"polygon"===o))throw new r("size-class-breaks-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.indexOf("3d-volumetric")>-1&&(!i.view||"3d"!==i.view.type))throw new r("size-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");return[4,g.getFieldsList({field:i.field,normalizationField:i.normalizationField})];case 2:if(m=p.sent(),d=v.verifyBasicFieldValidity(l,m,"size-class-breaks-renderer:invalid-parameters"))throw d;return[2,i]}}))}))}function E(e){var i=a.__assign({},e);delete i.basemap,delete i.sizeScheme,delete i.legendOptions,delete i.symbolType,delete i.defaultSymbolEnabled;var n=i;return n.analyzeData=!(null!=i.minValue&&null!=i.maxValue),n}function V(e){var i=a.__assign({},e),n=i.symbolType.indexOf("3d-volumetric")>-1,r=i;return r.worldScale=n,n&&(r.axis="3d-volumetric-uniform"===i.symbolType?"all":"height"),delete i.symbolType,delete i.defaultSymbolEnabled,r}function _(e){return a.__awaiter(this,void 0,void 0,(function(){var i,n,l,t,o,u,m;return a.__generator(this,(function(d){switch(d.label){case 0:if(!(e&&e.layer&&e.view&&e.startTime&&e.endTime))throw new r("size-age-renderer:missing-parameters","'layer', 'view', 'startTime', 'endTime' parameters are required");if((i=a.__assign({},e)).symbolType=i.symbolType||"2d",i.defaultSymbolEnabled=null==i.defaultSymbolEnabled||i.defaultSymbolEnabled,n=[0,2,1,3],l=g.createLayerAdapter(i.layer,n),i.layer=l,!l)throw new r("size-age-renderer:invalid-parameters","'layer' must be one of these types: "+g.getLayerTypeLabels(n).join(", "));return t=s.isSome(i.signal)?{signal:i.signal}:null,[4,l.load(t)];case 1:if(d.sent(),o=l.geometryType,u=i.symbolType.indexOf("3d")>-1,i.outlineOptimizationEnabled="polygon"===o&&i.outlineOptimizationEnabled,"mesh"===o)throw new r("size-age-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(u&&("polyline"===o||"polygon"===o))throw new r("size-age-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.indexOf("3d-volumetric")>-1&&(!i.view||"3d"!==i.view.type))throw new r("size-age-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");if(m=h.verifyDates(l,i.startTime,i.endTime,"size-age-renderer:invalid-parameters"))throw m;if(i.unit&&-1===h.supportedAgeUnits.indexOf(i.unit))throw new r("size-age-renderer:invalid-unit","Supported units are: "+h.supportedAgeUnits.join(", "));return[2,i]}}))}))}function O(e){return a.__awaiter(this,void 0,void 0,(function(){var i,n,r,l,t;return a.__generator(this,(function(a){switch(a.label){case 0:return i=e.sizeScheme,n=null,r=null,[4,v.getBasemapInfo(e.basemap,e.view)];case 1:return l=a.sent(),n=s.isSome(l.basemapId)?l.basemapId:null,r=s.isSome(l.basemapTheme)?l.basemapTheme:null,i?[2,{scheme:w.cloneScheme(i),basemapId:n,basemapTheme:r}]:((t=w.getSchemes({basemap:n,basemapTheme:r,geometryType:e.geometryType,worldScale:e.worldScale,view:e.view}))&&(i=t.primaryScheme,n=t.basemapId,r=t.basemapTheme),[2,{scheme:i,basemapId:n,basemapTheme:r}])}}))}))}function F(e,i){var a;switch(i){case"point":case"multipoint":var n=e;a=[n.minSize,n.maxSize];break;case"polyline":var r=e;a=[r.minWidth,r.maxWidth];break;case"polygon":var s=e;a=[s.marker.minSize,s.marker.maxSize]}return a}function k(e,i,n,s){return a.__awaiter(this,void 0,void 0,(function(){var l,t,o,u,p,y,b,f,h,g,z,S,x,T,E,V,_,k,I,q;return a.__generator(this,(function(a){switch(a.label){case 0:return l=s.layer,t=s.field,o="function"==typeof t,u=t&&!o?l.getField(t):null,p=u&&"date"===u.type,y=l.geometryType,[4,O({basemap:s.basemap,geometryType:y,sizeScheme:s.sizeScheme,worldScale:s.worldScale,view:s.view})];case 1:if(b=a.sent(),!(f=b.scheme))throw new r("size-visual-variable:insufficient-info","Unable to find size scheme");return h=i&&[i.minSize,i.maxSize],g=h||F(f,y),z=v.getDefaultDataRange(e,p,!1),S=z||[e.min,e.max],x=[],T="height"===s.axis,E=T?s.axis:void 0,V=g[0],_=g[1],T&&"number"==typeof V&&"number"==typeof _&&(k=v.getSizeRangeForAxis({minSize:V,maxSize:_},E),x.push(new c({axis:"width-and-depth",minSize:k.minSize})),_=k.maxSize),x.unshift(new c({field:t,valueExpression:s.valueExpression,valueExpressionTitle:s.valueExpressionTitle,valueUnit:"unknown",normalizationField:n,axis:E,minSize:V,maxSize:_,minDataValue:S[0],maxDataValue:S[1],legendOptions:s.legendOptions})),I=new d({type:"size",minSliderValue:null!=s.minValue?s.minValue:e.min,maxSliderValue:null!=s.maxValue?s.maxValue:e.max}),q=new m({visualVariables:[I]}),[2,{basemapId:b.basemapId,basemapTheme:b.basemapTheme,visualVariables:x,statistics:e,defaultValuesUsed:!!z,sizeScheme:w.cloneScheme(f),authoringInfo:q}]}}))}))}function I(e,i,r,s,l){return a.__awaiter(this,void 0,void 0,(function(){var t,u,m,d,p,c,y,b,f,h,g,S;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,o.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:return t=a.sent(),u=l.layer,m=l.field,d=u.geometryType,p=l.defaultSymbolEnabled,c=w.cloneScheme(e.sizeScheme),b=(y="polygon"===d)?c.marker:c,f=y?c.background:null,h=y?"point":d,g=i&&i.opacity,S=e.visualVariables.map((function(e){return e.clone()})),i&&i.visualVariables&&i.visualVariables.length&&S.push.apply(S,i.visualVariables.map((function(e){return e.clone()}))),[2,{renderer:new n.ClassBreaksRenderer({backgroundFillSymbol:f&&v.createSymbol(d,{type:l.symbolType,color:f.color,outline:v.getSymbolOutlineFromScheme(f,d,g)}),classBreakInfos:[{minValue:-z,maxValue:z,symbol:v.createSymbol(h,{type:l.symbolType,color:b.color,size:v.getSymbolSizeFromScheme(b,h),outline:v.getSymbolOutlineFromScheme(b,h,g)})}],defaultLabel:p?t.other:null,defaultSymbol:p?v.createSymbol(h,{type:l.symbolType,color:b.noDataColor,size:v.getSymbolSizeFromScheme(b,h,!0),outline:v.getSymbolOutlineFromScheme(b,h,g)}):null,field:m,normalizationField:s,normalizationType:r,valueExpression:l.valueExpression,valueExpressionTitle:l.valueExpressionTitle,visualVariables:S,authoringInfo:e.authoringInfo&&e.authoringInfo.clone()}),visualVariables:e.visualVariables.map((function(e){return e.clone()})),statistics:e.statistics,defaultValuesUsed:e.defaultValuesUsed,sizeScheme:w.cloneScheme(e.sizeScheme),basemapId:e.basemapId,basemapTheme:e.basemapTheme}]}}))}))}function q(e,i){return a.__awaiter(this,void 0,void 0,(function(){var r,s,l,u,d,c,y,b,f,h,g,z,S,x,T,E,V,_,k,I,q;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,o.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:return r=a.sent(),s=e.layer,l=e.defaultSymbolEnabled,u=s.geometryType,d="polygon"===u,c=e.symbolType.indexOf("3d-volumetric")>-1,[4,O({basemap:e.basemap,geometryType:u,sizeScheme:e.sizeScheme,worldScale:c,view:e.view})];case 2:return y=a.sent(),b=y.scheme,f=i.result,h=i.outlineResult,g=f.classBreakInfos,z=e.classificationMethod,S=e.normalizationType,x=d?b.marker:b,T=d?b.background:null,V=F(x,E=d?"point":u),_=c&&v.getSizeRangeForAxis({minSize:V[0],maxSize:V[1]},"height"),k=function(e,i){for(var a=t.toPt(e.minSize),n=(t.toPt(e.maxSize)-a)/(i>=4?i-1:i),r=[],s=0;s<i;s++)r.push(a+n*s);return r}({minSize:V[0],maxSize:c?_.maxSize:V[1]},g.length),I=h&&h.opacity,q=new n.ClassBreaksRenderer({backgroundFillSymbol:T&&v.createSymbol(u,{type:e.symbolType,color:T.color,outline:v.getSymbolOutlineFromScheme(T,u,I)}),classBreakInfos:g.map((function(i,a){return{minValue:i.minValue,maxValue:i.maxValue,symbol:v.createSymbol(E,{type:e.symbolType,color:x.color,size:k[a],widthAndDepth:_&&_.minSize,outline:v.getSymbolOutlineFromScheme(x,E,I)}),label:i.label}})),defaultLabel:l?r.other:null,defaultSymbol:l?v.createSymbol(E,{type:e.symbolType,color:x.noDataColor,size:v.getSymbolSizeFromScheme(x,E,!0),widthAndDepth:_&&_.minSize,outline:v.getSymbolOutlineFromScheme(x,E,I)}):null,field:e.field,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle,normalizationType:S,normalizationField:e.normalizationField,normalizationTotal:"percent-of-total"===S?f.normalizationTotal:void 0,legendOptions:e.legendOptions,authoringInfo:new m({type:"class-breaks-size",classificationMethod:z,standardDeviationInterval:e.standardDeviationInterval})}),"standard-deviation"!==z&&p.setLabelsForClassBreaks({classBreakInfos:q.classBreakInfos,classificationMethod:z,normalizationType:S,round:!0}),h&&h.visualVariables&&h.visualVariables.length&&(q.visualVariables=h.visualVariables.map((function(e){return e.clone()}))),[2,{renderer:q,sizeScheme:w.cloneScheme(b),classBreaksResult:f,defaultValuesUsed:i.defaultValuesUsed,basemapId:y.basemapId,basemapTheme:y.basemapTheme}]}}))}))}function B(e){return a.__awaiter(this,void 0,void 0,(function(){var i,n,r,s,t,o,u,m,d;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,S(e)];case 1:return i=a.sent(),n=i.view,r=i.layer,s=i.normalizationField,t=i.signal,o=s?"field":void 0,[4,l.all([i.statistics?i.statistics:v.getSummaryStatistics({layer:r,field:i.field,valueExpression:i.valueExpression,sqlExpression:i.sqlExpression,sqlWhere:i.sqlWhere,normalizationType:o,normalizationField:s,minValue:i.minValue,maxValue:i.maxValue,view:n,signal:t}),i.sizeOptimizationEnabled?f({view:n,layer:r,signal:t}):null])];case 2:return u=a.sent(),m=u[0],d=u[1],[2,k(m,d,s,i)]}}))}))}i.createVisualVariables=B,i.createContinuousRenderer=function(e){return a.__awaiter(this,void 0,void 0,(function(){var i,n,r,s,t,o;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,x(e)];case 1:return i=a.sent(),n={layer:i.layer,view:i.view,signal:i.signal},[4,l.all([B(V(i)),i.outlineOptimizationEnabled?b(n):null])];case 2:return r=a.sent(),s=r[0],t=r[1],o=i.normalizationField,[2,I(s,t,o?"field":void 0,o,i)]}}))}))},i.createClassBreaksRenderer=function(e){return a.__awaiter(this,void 0,void 0,(function(){var i,n;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,T(e)];case 1:return i=a.sent(),[4,v.getClassBreaks(E(i),i.outlineOptimizationEnabled)];case 2:return n=a.sent(),[2,q(i,n)]}}))}))},i.createAgeRenderer=function(e){return a.__awaiter(this,void 0,void 0,(function(){var i,n,r,s,t,m,d,p,c,f,g,w,z,S,x,T,E,O,F,k,q,L,A;return a.__generator(this,(function(M){switch(M.label){case 0:return[4,_(e)];case 1:return i=M.sent(),n=i.defaultSymbolEnabled,r=i.view,s=i.startTime,t=i.endTime,m=i.symbolType,d=i.minValue,p=i.maxValue,c=i.signal,f=i.layer,g={layer:i.layer,view:i.view,signal:c},T=(x=l).all,i.unit?(E={unit:i.unit,statistics:null,valueExpression:null},[3,4]):[3,2];case 2:return[4,y({view:r,layer:f,startTime:s,endTime:t,minValue:d,maxValue:p,signal:c})];case 3:E=M.sent(),M.label=4;case 4:return[4,T.apply(x,[[E,i.outlineOptimizationEnabled?b(g):null]])];case 5:return w=M.sent(),z=w[0],S=w[1],O=z.unit,F=z.statistics,k=h.getAgeExpressions({layer:f,startTime:s,endTime:t,unit:O}).valueExpression,[4,o.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 6:return q=M.sent(),L=u.substitute(q["ageInfo_"+O],{unit:O,startTime:v.formatDate(s,O,f),endTime:v.formatDate(t,O,f)}),[4,B(V({layer:f,basemap:i.basemap,valueExpression:k,symbolType:m,statistics:F,legendOptions:{title:L},sizeScheme:i.sizeScheme,sizeOptimizationEnabled:i.sizeOptimizationEnabled,view:i.view,minValue:d,maxValue:p,signal:c}))];case 7:return[4,I(M.sent(),S,null,null,{layer:f,valueExpression:k,defaultSymbolEnabled:n,symbolType:m})];case 8:return A=M.sent(),A.renderer.authoringInfo.visualVariables.forEach((function(e){return v.updateAgeRendererAuthoringInfoVV(e,s,t,O)})),[2,a.__assign(a.__assign({},A),{unit:O})]}}))}))}}));