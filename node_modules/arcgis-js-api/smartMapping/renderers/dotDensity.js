// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../renderers","../../core/Error","../../core/maybe","../../core/promiseUtils","../../geometry/support/scaleUtils","../../renderers/support/AuthoringInfo","../heuristics/outline","./support/dotDensityUtils","./support/utils","../statistics/spatialStatistics","../statistics/summaryStatisticsForAttributes","../statistics/support/attributeDensity","../support/utils","../symbology/dotDensity"],(function(e,t,i,r,n,a,s,l,o,u,d,c,m,p,y,b,g){Object.defineProperty(t,"__esModule",{value:!0});function f(e){return i.__awaiter(this,void 0,void 0,(function(){var t,r,l,o;return i.__generator(this,(function(u){switch(u.label){case 0:if(!(e&&e.layer&&e.view&&e.attributes&&e.attributes.length))throw new n("dot-density-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(e.attributes.length>8)throw new n("dot-density-renderer:invalid-parameters","Dot density renderer does not support more than 8 attributes");if(t=i.__assign({},e),r=[2,1],l=b.createLayerAdapter(t.layer,r),t.layer=l,t.dotBlendingEnabled=null==t.dotBlendingEnabled||t.dotBlendingEnabled,t.dotValueOptimizationEnabled=null==t.dotValueOptimizationEnabled||t.dotValueOptimizationEnabled,!l)throw new n("dot-density-renderer:invalid-parameters","'layer' must be one of these types: "+b.getLayerTypeLabels(r).join(", "));return o=a.isSome(t.signal)?{signal:t.signal}:null,[4,s.all([t.view.when(),l.load(o)])];case 1:if(u.sent(),"polygon"!==l.geometryType)throw new n("dot-density-renderer:not-supported","Dot density renderer is supported for polygon layers only");return[2,t]}}))}))}function v(e){return i.__awaiter(this,void 0,void 0,(function(){var t,r,n,s,l;return i.__generator(this,(function(i){switch(i.label){case 0:return t=e.dotDensityScheme,r=null,n=null,[4,c.getBasemapInfo(e.basemap,e.view)];case 1:return s=i.sent(),r=a.isSome(s.basemapId)?s.basemapId:null,n=a.isSome(s.basemapTheme)?s.basemapTheme:null,t?[2,{scheme:g.cloneScheme(t),basemapId:r,basemapTheme:n}]:((l=g.getSchemes({basemap:r,numColors:e.attributes.length,basemapTheme:n}))&&(t=l.primaryScheme,r=l.basemapId,n=l.basemapTheme),[2,{scheme:t,basemapId:r,basemapTheme:n}])}}))}))}function h(e){return i.__awaiter(this,void 0,void 0,(function(){var t,r,a,o,u,c,y,b,g,f,v,h;return i.__generator(this,(function(i){switch(i.label){case 0:return t=e.view,r=e.layer,a=e.attributes,o=e.signal,[4,r.getSampleFeatures({view:t,sampleSize:500,returnGeometry:!0,signal:o})];case 1:return u=i.sent(),[4,s.all([m({features:u,geometryType:r.geometryType}),p({layer:r,attributes:a,includeZeros:!1,includeNegatives:!1,view:t,signal:o})])];case 2:if(c=i.sent(),y=c[0],b=c[1],g="avgSize"in y&&y.avgSize,f=b.avg,!g)throw new n("dot-density-renderer:insufficient-info","Average polygon size is invalid");if(!f)throw new n("dot-density-renderer:insufficient-info","Average attribute value is invalid");return v=l.getResolutionForScale(t.scale,t.spatialReference),h=g*g/(v*v)*.1,[2,{dotValue:d.roundValue(f/h)||1,referenceScale:t.scale,minSliderValue:1,maxSliderValue:d.roundValue(f)}]}}))}))}function w(e){return i.__awaiter(this,void 0,void 0,(function(){var t,r,a,s,o,u,c,m,p,g,f,v,h,w,S,V;return i.__generator(this,(function(i){switch(i.label){case 0:t=e.view,r=e.layer,a=e.attributes,s=e.signal,o=[],u=0,c=a,i.label=1;case 1:return u<c.length?(m=c[u],[4,b.getFieldsList({field:m.field,valueExpression:m.valueExpression})]):[3,4];case 2:p=i.sent(),o.push.apply(o,p),i.label=3;case 3:return u++,[3,1];case 4:return[4,r.getSampleFeatures({view:t,sampleSize:500,requiredFields:o,returnGeometry:!0,signal:s})];case 5:return g=i.sent(),[4,y({features:g,attributes:a,includeZeros:!1,includeNegatives:!1,view:t})];case 6:if(!(f=i.sent()).avgDensity||!f.minDensity||!f.maxDensity)throw new n("dot-density-renderer:insufficient-info","Invalid density values");return v=l.getResolutionForScale(t.scale,t.spatialReference),h=v*v,w=d.roundValue(f.minDensity*h),S=d.roundValue(f.maxDensity*h),10,(V=d.roundValue(f.avgDensity*h*10)||1)>S&&(V=S),[2,{dotValue:V,referenceScale:t.scale,minSliderValue:w,maxSliderValue:S}]}}))}))}t.createRenderer=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,a,l,d,m,p,y,b,g,S,V,_,E,D,T,x,I;return i.__generator(this,(function(i){switch(i.label){case 0:return[4,f(e)];case 1:return t=i.sent(),a=t.layer,l=a.geometryType,[4,v(t)];case 2:if(d=i.sent(),!(m=d&&d.scheme))throw new n("dot-density-renderer:insufficient-info","Unable to find dot-density scheme");return p={layer:a,view:t.view,attributes:t.attributes,signal:t.signal},y={layer:t.layer,view:t.view,signal:t.signal},[4,s.all([t.trueDensity?w(p):h(p),t.outlineOptimizationEnabled?u(y):null])];case 3:return b=i.sent(),g=b[0],S=b[1],V=g.dotValue,_=g.referenceScale,E=g.minSliderValue,D=g.maxSliderValue,T=c.createColors(m.colors,t.attributes.length),x=t.attributes.map((function(e,t){return{field:e.field,valueExpression:e.valueExpression,label:e.label,valueExpressionTitle:e.valueExpressionTitle,color:T[t]}})),I=new r.DotDensityRenderer({attributes:x,dotBlendingEnabled:t.dotBlendingEnabled,outline:S?c.getSymbolOutlineFromScheme(m,l,S.opacity):null,dotValue:V,referenceScale:t.dotValueOptimizationEnabled?_:null,legendOptions:t.legendOptions}),S&&S.visualVariables&&S.visualVariables.length&&(I.visualVariables=S.visualVariables.map((function(e){return e.clone()}))),I.authoringInfo=new o({type:"dot-density",minSliderValue:E,maxSliderValue:D}),[2,{renderer:I,dotDensityScheme:m,basemapId:d.basemapId,basemapTheme:d.basemapTheme}]}}))}))}}));