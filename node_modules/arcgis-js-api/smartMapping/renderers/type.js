// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../pointCloudRenderers","../../renderers","../../core/Error","../../core/lang","../../core/maybe","../../core/promiseUtils","../../intl/messages","../../renderers/support/LegendOptions","../../renderers/support/utils","../heuristics/outline","../heuristics/sizeRange","./support/utils","../statistics/uniqueValues","../support/utils","../symbology/type"],(function(e,r,n,i,a,t,l,s,o,u,d,c,p,m,y,f,b,v){Object.defineProperty(r,"__esModule",{value:!0});function h(e){return n.__awaiter(this,void 0,void 0,(function(){var r,i,a,o,u,d,c;return n.__generator(this,(function(p){switch(p.label){case 0:if(!e||!e.layer||!e.field&&!e.valueExpression)throw new t("type-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(e.valueExpression&&!e.view)throw new t("type-renderer:missing-parameters","View is required when 'valueExpression' is specified");if((r=n.__assign({},e)).symbolType=r.symbolType||"2d",r.numTypes=null==r.numTypes?10:r.numTypes,r.defaultSymbolEnabled=null==r.defaultSymbolEnabled||r.defaultSymbolEnabled,r.sortBy=null==r.sortBy?"count":r.sortBy,r.sortEnabled=null==r.sortEnabled||r.sortEnabled,r.statistics=l.clone(r.statistics),i=[0,2,1,3],a=b.createLayerAdapter(r.layer,i),r.layer=a,!a)throw new t("type-renderer:invalid-parameters","'layer' must be one of these types: "+b.getLayerTypeLabels(i).join(", "));return o=s.isSome(r.signal)?{signal:r.signal}:null,[4,a.load(o)];case 1:if(p.sent(),u=a.geometryType,r.outlineOptimizationEnabled="polygon"===u&&r.outlineOptimizationEnabled,r.sizeOptimizationEnabled=("point"===u||"multipoint"===u||"polyline"===u)&&r.sizeOptimizationEnabled,"mesh"===u)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace",r.edgesType=r.edgesType||"none";else{if("3d-volumetric-uniform"===r.symbolType&&"point"!==u)throw new t("type-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(r.symbolType.indexOf("3d-volumetric")>-1&&(!r.view||"3d"!==r.view.type))throw new t("type-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}return[4,b.getFieldsList({field:r.field,valueExpression:r.valueExpression})];case 2:if(d=p.sent(),c=y.verifyBasicFieldValidity(a,d,"type-renderer:invalid-parameters"))throw c;return[2,r]}}))}))}function g(e){return n.__awaiter(this,void 0,void 0,(function(){var r,i,a,o,u,d;return n.__generator(this,(function(c){switch(c.label){case 0:if(!(e&&e.layer&&e.field))throw new t("type-point-cloud-class-renderer:missing-parameters","'layer' and 'field' parameters are required");if((r=n.__assign({},e)).statistics=l.clone(r.statistics),i=[4],a=b.createLayerAdapter(r.layer,i),r.layer=a,r.density=r.density||25,r.size=r.size||"100%",!y.isValidPointSize(r.size))throw new t("type-point-cloud-class-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'");if(!a)throw new t("type-point-cloud-class-renderer:invalid-parameters","'layer' must be one of these types: "+b.getLayerTypeLabels(i).join(", "));return o=s.isSome(r.signal)?{signal:r.signal}:null,[4,a.load(o)];case 1:return c.sent(),[4,b.getFieldsList({field:r.field})];case 2:if(u=c.sent(),d=y.verifyBasicFieldValidity(a,u,"type-point-cloud-class-renderer:invalid-parameters"))throw d;return[2,r]}}))}))}function w(e){return n.__awaiter(this,void 0,void 0,(function(){var r,i,a,t,l;return n.__generator(this,(function(n){switch(n.label){case 0:return r=e.typeScheme,i=null,a=null,[4,y.getBasemapInfo(e.basemap,e.view)];case 1:return t=n.sent(),i=s.isSome(t.basemapId)?t.basemapId:null,a=s.isSome(t.basemapTheme)?t.basemapTheme:null,r?[2,{scheme:v.cloneScheme(r),basemapId:i,basemapTheme:a}]:((l=v.getSchemes({basemap:i,basemapTheme:a,geometryType:e.geometryType,theme:e.theme,worldScale:e.worldScale,view:e.view}))&&(r=l.primaryScheme,i=l.basemapId,a=l.basemapTheme),[2,{scheme:r,basemapId:i,basemapTheme:a}])}}))}))}function T(e,r){return e.label<r.label?-1:e.label>r.label?1:0}function S(e,r){return e.value<r.value?-1:e.value>r.value?1:0}function _(e,r){var n=r.count-e.count;return 0===n&&(n=T(e,r)),n}function E(e,r){var n=r.count-e.count;return 0===n&&(n=S(e,r)),n}function V(e,r,n){var i;"count"===r?(i=E,n&&n.codedValues&&(i=_)):"value"===r&&(i=S,n&&n.codedValues&&(i=T)),i&&e.sort(i)}function x(e,r,i,t){return n.__awaiter(this,void 0,void 0,(function(){var l,s,o,p,m,f,b,h,g,T,S,_,E,x,z,I,M,q,O,L,C,F,U,B;return n.__generator(this,(function(P){switch(P.label){case 0:return[4,u.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:return l=P.sent(),s=e.uniqueValueInfos,o=r.layer,p=r.field,m=p?o.getField(p):null,f=m?o.getFieldDomain(m.name):null,b=-1===r.numTypes?s.length:r.numTypes,h=o.geometryType,[4,w({basemap:r.basemap,geometryType:h,typeScheme:r.typeScheme,worldScale:r.symbolType.indexOf("3d-volumetric")>-1,view:r.view})];case 2:for(g=P.sent(),T=g.scheme,S=new a.UniqueValueRenderer({field:p}),_=-1,x={value:null,domain:f,fieldInfo:m},s.forEach((function(e,r){x.value=e.value,e.label=c.createUniqueValueLabel(x),null===e.value&&(_=r)})),_>-1&&(E=s.splice(_,1)[0]),!1!==r.sortEnabled&&V(s,r.sortBy,f),m&&"date"===m.type&&(z=s.filter((function(e,r){return r<b})),I=z.map((function(e){return e.value})),x.dateFormatInterval=c.calculateDateFormatInterval(I)),M=i&&i.opacity,q=y.createColors(T.colors,s.length),O=y.getSymbolSizeFromScheme(T,h),L=y.getSymbolOutlineFromScheme(T,h,M),s.forEach((function(e,n){x.value=e.value,e.label=c.createUniqueValueLabel(x),e.symbol=y.createSymbol(h,{type:r.symbolType,color:q[n],size:O,outline:L,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}})})),r.valueExpression&&(S.valueExpression=r.valueExpression,S.valueExpressionTitle=r.valueExpressionTitle),r.legendOptions&&(S.legendOptions=new d.LegendOptions(r.legendOptions)),q=y.createColors(T.colors,b),B=0;B<b;B++)(C=s[B])&&S.addUniqueValueInfo({value:C.value,label:C.label,symbol:y.createSymbol(h,{type:r.symbolType,color:q[B],size:O,outline:L,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}})});if(r.defaultSymbolEnabled&&(S.defaultSymbol=y.createSymbol(h,{type:r.symbolType,color:T.noDataColor,size:O,outline:L,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}}),S.defaultLabel=l.other),E&&(E.symbol=y.createSymbol(h,{type:r.symbolType,color:T.noDataColor,size:O,outline:L,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}}),s.push(E)),F=[],(U=S.uniqueValueInfos.length===s.length?-1:S.uniqueValueInfos.length)>-1)for(B=U;B<s.length;B++)F.push(n.__assign({},s[B]));return i&&i.visualVariables&&i.visualVariables.length&&(S.visualVariables=i.visualVariables.map((function(e){return e.clone()}))),t&&t.minSize&&(S.visualVariables?S.visualVariables.push(t.minSize):S.visualVariables=[t.minSize]),[2,{renderer:S,uniqueValueInfos:s,excludedUniqueValueInfos:F,typeScheme:v.cloneScheme(T),basemapId:g.basemapId,basemapTheme:g.basemapTheme}]}}))}))}function z(e,r){return n.__awaiter(this,void 0,void 0,(function(){var i,a,t,l,s;return n.__generator(this,(function(n){switch(n.label){case 0:return i=e.uniqueValueInfos,[4,w({basemap:"gray",theme:"point-cloud-class",geometryType:"point",typeScheme:r})];case 1:return a=n.sent(),t=a&&a.scheme,l="point-cloud-class"===t.theme,s=l?t.colors:y.createColors(t.colors,i.length),V(i,"value"),[2,i.map((function(e,r){var n=e.value,i=null;return l?(i=s[n])||(i=s[s.length-1]):i=s[r],{values:[n],color:i,label:e.label}}))]}}))}))}r.createRenderer=function(e){return n.__awaiter(this,void 0,void 0,(function(){var r,i,a,t,l,s,u,d,c;return n.__generator(this,(function(n){switch(n.label){case 0:return[4,h(e)];case 1:return r=n.sent(),i=r.layer,a=r.view,t=r.signal,l={layer:i,field:r.field,valueExpression:r.valueExpression,returnAllCodedValues:r.returnAllCodedValues,view:a,signal:t},[4,o.all([null!=r.statistics?r.statistics:f(l),r.outlineOptimizationEnabled?p({layer:i,view:a,signal:t}):null,r.sizeOptimizationEnabled?m({layer:i,view:a,signal:t}):null])];case 2:return s=n.sent(),u=s[0],d=s[1],c=s[2],[2,x(u,r,d,c)]}}))}))},r.createPCClassRenderer=function(e){return n.__awaiter(this,void 0,void 0,(function(){var r,a,t,l,s;return n.__generator(this,(function(n){switch(n.label){case 0:return[4,g(e)];case 1:return null==(r=n.sent()).statistics?[3,2]:(t=r.statistics,[3,4]);case 2:return[4,f({layer:r.layer,field:r.field,signal:r.signal})];case 3:t=n.sent(),n.label=4;case 4:return a=t,l=i.PointCloudUniqueValueRenderer.bind,s={field:r.field,pointsPerInch:r.density,pointSizeAlgorithm:y.getPointSizeAlgorithm(r.size)},[4,z(a,r.typeScheme)];case 5:return[2,{renderer:new(l.apply(i.PointCloudUniqueValueRenderer,[void 0,(s.colorUniqueValueInfos=n.sent(),s)]))}]}}))}))}}));