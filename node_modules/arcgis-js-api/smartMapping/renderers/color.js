// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../pointCloudRenderers","../../renderers","../../core/Error","../../core/maybe","../../core/promiseUtils","../../intl/messages","../../intl/substitute","../../renderers/support/AuthoringInfo","../../renderers/support/AuthoringInfoVisualVariable","../../renderers/support/numberUtils","../../renderers/support/utils","../../renderers/visualVariables/ColorVariable","../heuristics/ageUnit","../heuristics/outline","../heuristics/sizeRange","./support/utils","../statistics/support/ageUtils","../support/utils","../symbology/color"],(function(e,r,a,i,n,o,t,l,s,u,c,d,m,p,y,f,h,b,v,g,w,T){Object.defineProperty(r,"__esModule",{value:!0});var S=Math.pow(2,53)-1;function x(e){return a.__awaiter(this,void 0,void 0,(function(){var r,i,n,s,u,c;return a.__generator(this,(function(d){switch(d.label){case 0:if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new o("color-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new o("color-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");if(r=a.__assign({},e),i=[0,2,1,3],n=w.createLayerAdapter(r.layer,i),r.layer=n,!n)throw new o("color-visual-variable:invalid-parameters","'layer' must be one of these types: "+w.getLayerTypeLabels(i).join(", "));return s=t.isSome(r.signal)?{signal:r.signal}:null,[4,n.load(s)];case 1:return d.sent(),"mesh"===n.geometryType||!r.worldScale||r.view&&"3d"===r.view.type?[4,w.getFieldsList({field:r.field,normalizationField:r.normalizationField,valueExpression:r.valueExpression})]:[2,l.reject(v.createError("color-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true"))];case 2:if(u=d.sent(),c=v.verifyBasicFieldValidity(n,u,"color-visual-variable:invalid-parameters"))throw c;return[2,r]}}))}))}function E(e){return a.__awaiter(this,void 0,void 0,(function(){var r,i,n,l,s,u,c;return a.__generator(this,(function(d){switch(d.label){case 0:if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new o("color-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new o("color-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");if((r=a.__assign({},e)).symbolType=r.symbolType||"2d",r.defaultSymbolEnabled=null==r.defaultSymbolEnabled||r.defaultSymbolEnabled,i=[0,2,1,3],n=w.createLayerAdapter(r.layer,i),r.layer=n,!n)throw new o("color-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+w.getLayerTypeLabels(i).join(", "));return l=t.isSome(r.signal)?{signal:r.signal}:null,[4,n.load(l)];case 1:if(d.sent(),s=n.geometryType,r.outlineOptimizationEnabled="polygon"===s&&r.outlineOptimizationEnabled,r.sizeOptimizationEnabled=("point"===s||"multipoint"===s||"polyline"===s)&&r.sizeOptimizationEnabled,"mesh"===s)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace",r.edgesType=r.edgesType||"none";else{if("3d-volumetric-uniform"===r.symbolType&&"point"!==s)throw new o("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(r.symbolType.indexOf("3d-volumetric")>-1&&(!r.view||"3d"!==r.view.type))throw new o("color-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}return[4,w.getFieldsList({field:r.field,normalizationField:r.normalizationField,valueExpression:r.valueExpression})];case 2:if(u=d.sent(),c=v.verifyBasicFieldValidity(n,u,"color-continuous-renderer:invalid-parameters"))throw c;return[2,r]}}))}))}function _(e){return a.__awaiter(this,void 0,void 0,(function(){var r,i,n,l,s,u,c;return a.__generator(this,(function(d){switch(d.label){case 0:if(!e||!e.layer||!e.field&&!e.valueExpression)throw new o("color-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(e.valueExpression&&!e.view)throw new o("color-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");if((r=a.__assign({},e)).symbolType=r.symbolType||"2d",r.defaultSymbolEnabled=null==r.defaultSymbolEnabled||r.defaultSymbolEnabled,r.classificationMethod=r.classificationMethod||"equal-interval",r.normalizationType=w.getNormalizationType(r),i=[0,2,1,3],n=w.createLayerAdapter(r.layer,i),r.layer=n,!n)throw new o("color-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+w.getLayerTypeLabels(i).join(", "));if(!(null!=r.minValue&&null!=r.maxValue)&&(null!=r.minValue||null!=r.maxValue))throw new o("color-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range");return l=t.isSome(r.signal)?{signal:r.signal}:null,[4,n.load(l)];case 1:if(d.sent(),s=n.geometryType,r.outlineOptimizationEnabled="polygon"===s&&r.outlineOptimizationEnabled,"mesh"===s)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace",r.edgesType=r.edgesType||"none";else{if("3d-volumetric-uniform"===r.symbolType&&"point"!==s)throw new o("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(r.symbolType.indexOf("3d-volumetric")>-1&&(!r.view||"3d"!==r.view.type))throw new o("color-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}return[4,w.getFieldsList({field:r.field,normalizationField:r.normalizationField})];case 2:if(u=d.sent(),c=v.verifyBasicFieldValidity(n,u,"color-class-breaks-renderer:invalid-parameters"))throw c;return[2,r]}}))}))}function V(e){var r=a.__assign({},e);delete r.basemap,delete r.colorScheme,delete r.legendOptions,delete r.symbolType,delete r.defaultSymbolEnabled,delete r.colorMixMode,delete r.edgesType;var i=r;return i.analyzeData=!(null!=r.minValue&&null!=r.maxValue),i}function z(e){if(!(e&&e.layer&&e.field))return l.reject(v.createError("color-point-cloud-continuous-renderer:missing-parameters","'layer' and 'field' parameters are required"));var r=e.field.toLowerCase();if("intensity"!==r&&"elevation"!==r)return l.reject(v.createError("color-point-cloud-continuous-renderer:invalid-parameters","'field' should be either 'intensity' or 'elevation'"));var i=a.__assign({},e),n=[4],o=w.createLayerAdapter(i.layer,n);if(i.layer=o,i.density=i.density||25,i.size=i.size||"100%",!v.isValidPointSize(i.size))return l.reject(v.createError("color-point-cloud-continuous-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'"));if(!o)return l.reject(v.createError("color-point-cloud-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+w.getLayerTypeLabels(n).join(", ")));var s=t.isSome(i.signal)?{signal:i.signal}:null;return o.load(s).then((function(){return i}))}function M(e){var r=a.__assign({},e),i=r.symbolType.indexOf("3d-volumetric")>-1;delete r.symbolType,delete r.defaultSymbolEnabled,delete r.colorMixMode,delete r.edgesType;var n=r;return n.worldScale=i,n}function I(e){return a.__awaiter(this,void 0,void 0,(function(){var r,i,n,l,s,u;return a.__generator(this,(function(c){switch(c.label){case 0:if(!(e&&e.layer&&e.view&&e.startTime&&e.endTime))throw new o("color-age-renderer:missing-parameters","'layer', 'view', startTime', 'endTime' parameters are required");if((r=a.__assign({},e)).symbolType=r.symbolType||"2d",r.defaultSymbolEnabled=null==r.defaultSymbolEnabled||r.defaultSymbolEnabled,i=[0,2,1,3],n=w.createLayerAdapter(r.layer,i),r.layer=n,!n)throw new o("color-age-renderer:invalid-parameters","'layer' must be one of these types: "+w.getLayerTypeLabels(i).join(", "));return l=t.isSome(r.signal)?{signal:r.signal}:null,[4,n.load(l)];case 1:if(c.sent(),s=n.geometryType,r.outlineOptimizationEnabled="polygon"===s&&r.outlineOptimizationEnabled,r.sizeOptimizationEnabled=("point"===s||"multipoint"===s||"polyline"===s)&&r.sizeOptimizationEnabled,"mesh"===s)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace",r.edgesType=r.edgesType||"none";else if("3d-volumetric-uniform"===r.symbolType&&"point"!==s)throw new o("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(r.symbolType.indexOf("3d-volumetric")>-1&&(!r.view||"3d"!==r.view.type))throw new o("color-age-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");if(u=g.verifyDates(n,r.startTime,r.endTime,"color-age-renderer:invalid-parameters"))throw u;if(r.unit&&-1===g.supportedAgeUnits.indexOf(r.unit))throw new o("color-age-renderer:invalid-unit","Supported units are: "+g.supportedAgeUnits.join(", "));return[2,r]}}))}))}function O(e,r){return a.__awaiter(this,void 0,void 0,(function(){var i,n,o,l,s,u,c;return a.__generator(this,(function(a){switch(a.label){case 0:return i=e.colorScheme,n=null,o=null,[4,v.getBasemapInfo(e.basemap,e.view)];case 1:return l=a.sent(),n=t.isSome(l.basemapId)?l.basemapId:null,o=t.isSome(l.basemapTheme)?l.basemapTheme:null,i?[2,{scheme:T.cloneScheme(i),basemapId:n,basemapTheme:o}]:(s=r||e.theme||"high-to-low",(u=T.getSchemes({theme:s,basemap:n,basemapTheme:o,geometryType:e.geometryType,worldScale:e.worldScale,view:e.view}))&&(n=u.basemapId,o=u.basemapTheme,e.schemeId?(c=s+"/"+n+"/"+e.schemeId,i=T.getSchemeById({id:c,geometryType:e.geometryType})):i=u.primaryScheme),[2,{scheme:i,basemapId:n,basemapTheme:o}])}}))}))}function C(e,r,a){for(var i=(r-e)/(a-1),n=[e],o=1;o<=a-2;o++)n.push(e+o*i);return n.push(r),m.round(n,{strictBounds:!0})}function F(e,r){return a.__awaiter(this,void 0,void 0,(function(){var i,n,o,t,l,s;return a.__generator(this,(function(a){switch(a.label){case 0:return i=r.layer,[4,O({basemap:r.basemap,colorScheme:r.colorScheme,geometryType:i.geometryType,schemeId:"elevation"===r.field.toLowerCase()?"point-cloud-elevation-scheme":"point-cloud-intensity-scheme"})];case 1:if(n=a.sent(),!(o=n.scheme))throw v.createError("color-point-cloud-continuous-renderer:insufficient-info","Unable to find color scheme");if((t=v.createColors(o.colors,5)).length<5)throw v.createError("color-point-cloud-continuous-renderer:insufficient-info","Color scheme does not have enough colors");return l=v.getDefaultDataRange(e,!1,!0),s=l?C(l[0],l[1],5):v.createStopValues(e),[2,{stops:p.createColorStops({values:s,isDate:!1,dateFormatOptions:null,colors:t,labelIndexes:[0,2,4]}),basemapId:n.basemapId,basemapTheme:n.basemapTheme,statistics:e,defaultValuesUsed:!!l,colorScheme:T.cloneScheme(o)}]}}))}))}function L(e,r,i){return a.__awaiter(this,void 0,void 0,(function(){var n,o,t,l,s,u,m,p,f,h,b,g,w,S,x;return a.__generator(this,(function(a){switch(a.label){case 0:return n=i.layer,o=i.field,t="function"==typeof o,l=o&&!t?n.getField(o):null,s=l&&"date"===l.type,[4,O({basemap:i.basemap,theme:i.theme,geometryType:n.geometryType,colorScheme:i.colorScheme,worldScale:i.worldScale,view:i.view})];case 1:if(u=a.sent(),!(m=u.scheme))throw v.createError("color-visual-variable:insufficient-info","Unable to find color scheme");if((p=v.createColors(m.colors,5)).length<5)throw v.createError("color-visual-variable:insufficient-info","Color scheme does not have enough colors");return f=v.getDefaultDataRange(e,s,!0),h=m.id.indexOf("seq-")>-1,b=f?C(f[0],f[1],5):v.createStopValues(e,h),g=v.createColors(p,5),w=new y({field:o,valueExpression:i.valueExpression,valueExpressionTitle:i.valueExpressionTitle,normalizationField:r,stops:b.map((function(e,r){return{value:e,color:g[r]}})),legendOptions:i.legendOptions}),S=new d({type:"color",minSliderValue:null!=i.minValue?i.minValue:e.min,maxSliderValue:null!=i.maxValue?i.maxValue:e.max,theme:m.theme}),x=new c({visualVariables:[S]}),[2,{basemapId:u.basemapId,basemapTheme:u.basemapTheme,visualVariable:w,statistics:e,defaultValuesUsed:!!f,colorScheme:T.cloneScheme(m),authoringInfo:x}]}}))}))}function B(e,r,i,o,t,l){return a.__awaiter(this,void 0,void 0,(function(){var u,c,d,m,p,y,f,h;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,s.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:return u=a.sent(),c=l.layer,d=l.field,m=c.geometryType,p=l.defaultSymbolEnabled,y=T.cloneScheme(e.colorScheme),f=r&&r.opacity,h=[e.visualVariable.clone()],r&&r.visualVariables&&r.visualVariables.length&&h.push.apply(h,r.visualVariables.map((function(e){return e.clone()}))),i&&i.minSize&&h.push(i.minSize),[2,{renderer:new n.ClassBreaksRenderer({classBreakInfos:[{minValue:-S,maxValue:S,symbol:v.createSymbol(m,{type:l.symbolType,color:y.noDataColor,size:v.getSymbolSizeFromScheme(y,m),outline:v.getSymbolOutlineFromScheme(y,m,f),meshInfo:{colorMixMode:l.colorMixMode,edgesType:l.edgesType}})}],defaultLabel:p?u.other:null,defaultSymbol:p?v.createSymbol(m,{type:l.symbolType,color:y.noDataColor,size:v.getSymbolSizeFromScheme(y,m),outline:v.getSymbolOutlineFromScheme(y,m,f),meshInfo:{colorMixMode:l.colorMixMode,edgesType:l.edgesType}}):null,field:d,normalizationType:o,normalizationField:t,valueExpression:l.valueExpression,valueExpressionTitle:l.valueExpressionTitle,visualVariables:h,authoringInfo:e.authoringInfo&&e.authoringInfo.clone()}),visualVariable:e.visualVariable.clone(),statistics:e.statistics,defaultValuesUsed:e.defaultValuesUsed,colorScheme:T.cloneScheme(e.colorScheme),basemapId:e.basemapId,basemapTheme:e.basemapTheme}]}}))}))}function q(e){return a.__awaiter(this,void 0,void 0,(function(){var r,i,n,o;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,x(e)];case 1:return r=a.sent(),i=r.normalizationField,n=i?"field":void 0,r.statistics?(o=r.statistics,[3,4]):[3,2];case 2:return[4,v.getSummaryStatistics({layer:r.layer,field:r.field,valueExpression:r.valueExpression,sqlExpression:r.sqlExpression,sqlWhere:r.sqlWhere,normalizationType:n,normalizationField:i,minValue:r.minValue,maxValue:r.maxValue,view:r.view,signal:r.signal})];case 3:o=a.sent(),a.label=4;case 4:return[2,L(o,i,r)]}}))}))}function k(e,r){return a.__awaiter(this,void 0,void 0,(function(){var i,t,l,u,d,m,y,f,h,b,g,w,S,x,E;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,s.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:return i=a.sent(),t=e.layer,l=e.defaultSymbolEnabled,u=t.geometryType,[4,O({basemap:e.basemap,geometryType:u,colorScheme:e.colorScheme,worldScale:e.symbolType.indexOf("3d-volumetric")>-1,view:e.view})];case 2:if(d=a.sent(),m=d.scheme,y=r.result,f=r.outlineResult,h=y.classBreakInfos,b=e.classificationMethod,g="standard-deviation"===b,w=e.normalizationType,!m)throw new o("color-class-breaks-renderer:insufficient-info","Unable to find color scheme");if(!(S=function(e,r){var a,i=e.colorsForClassBreaks;if(i&&i.length>0&&(i.some((function(e){return e.numClasses===r&&(a=e.colors),!!a})),!a)){var n=i[i.length-1],o=r-n.numClasses;if(o>0){var t=n.colors[n.numClasses-1];a=n.colors.splice(0);for(var l=1;l<=o;l++)a.push(t)}}return a&&(a=v.createColors(a,a.length)),a}(m,h.length))||S.length!==h.length)throw new o("color-class-breaks-renderer:insufficient-info","Color scheme does not have enough colors");return x=f&&f.opacity,E=new n.ClassBreaksRenderer({classBreakInfos:h.map((function(r,a){return{minValue:r.minValue,maxValue:r.maxValue,symbol:v.createSymbol(u,{type:e.symbolType,color:S[a],size:v.getSymbolSizeFromScheme(m,u),outline:v.getSymbolOutlineFromScheme(m,u,x),meshInfo:{colorMixMode:e.colorMixMode,edgesType:e.edgesType}}),label:r.label}})),defaultLabel:l?i.other:null,defaultSymbol:l?v.createSymbol(u,{type:e.symbolType,color:m.noDataColor,size:v.getSymbolSizeFromScheme(m,u),outline:v.getSymbolOutlineFromScheme(m,u,x),meshInfo:{colorMixMode:e.colorMixMode,edgesType:e.edgesType}}):null,field:e.field,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle,normalizationType:w,normalizationField:e.normalizationField,normalizationTotal:"percent-of-total"===w?y.normalizationTotal:void 0,legendOptions:e.legendOptions,authoringInfo:new c({type:"class-breaks-color",classificationMethod:b,standardDeviationInterval:e.standardDeviationInterval})}),g||p.setLabelsForClassBreaks({classBreakInfos:E.classBreakInfos,classificationMethod:b,normalizationType:w,round:!0}),f&&f.visualVariables&&f.visualVariables.length&&(E.visualVariables=f.visualVariables.map((function(e){return e.clone()}))),[2,{renderer:E,colorScheme:T.cloneScheme(m),classBreaksResult:y,defaultValuesUsed:r.defaultValuesUsed,basemapId:d.basemapId,basemapTheme:d.basemapTheme}]}}))}))}r.createVisualVariable=q,r.createContinuousRenderer=function(e){return a.__awaiter(this,void 0,void 0,(function(){var r,i,n,o,t,s,u,c,d;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,E(e)];case 1:return r=a.sent(),i=r.layer,n=r.view,o=r.signal,[4,l.all([q(M(r)),r.outlineOptimizationEnabled?h({layer:i,view:n,signal:o}):null,r.sizeOptimizationEnabled?b({layer:i,view:n,signal:o}):null])];case 2:return t=a.sent(),s=t[0],u=t[1],c=t[2],d=r.normalizationField,[2,B(s,u,c,d?"field":void 0,d,r)]}}))}))},r.createClassBreaksRenderer=function(e){return a.__awaiter(this,void 0,void 0,(function(){var r,i;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,_(e)];case 1:return r=a.sent(),[4,v.getClassBreaks(V(r),r.outlineOptimizationEnabled)];case 2:return i=a.sent(),[2,k(r,i)]}}))}))},r.createPCTrueColorRenderer=function(e){return function(e){if(!e||!e.layer)return l.reject(v.createError("color-point-cloud-true-color-renderer:missing-parameters","'layer' parameter is required"));var r=a.__assign({},e),i=[4],n=w.createLayerAdapter(r.layer,i);if(r.layer=n,r.density=r.density||25,r.size=r.size||"100%",!v.isValidPointSize(r.size))return l.reject(v.createError("color-point-cloud-true-color-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'"));if(!n)return l.reject(v.createError("color-point-cloud-true-color-renderer:invalid-parameters","'layer' must be one of these types: "+w.getLayerTypeLabels(i).join(", ")));var o=t.isSome(r.signal)?{signal:r.signal}:null;return n.load(o).then((function(){return r}))}(e).then((function(e){return{renderer:new i.PointCloudRGBRenderer({field:"RGB",pointsPerInch:e.density,pointSizeAlgorithm:v.getPointSizeAlgorithm(e.size)})}}))},r.createPCContinuousRenderer=function(e){return a.__awaiter(this,void 0,void 0,(function(){var r,n,o;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,z(e)];case 1:return(r=a.sent()).statistics?(n=r.statistics,[3,4]):[3,2];case 2:return[4,v.getSummaryStatistics({layer:r.layer,field:r.field,signal:r.signal})];case 3:n=a.sent(),a.label=4;case 4:return[4,F(n,r)];case 5:return o=a.sent(),[2,{renderer:new i.PointCloudStretchRenderer({field:r.field,pointsPerInch:r.density,pointSizeAlgorithm:v.getPointSizeAlgorithm(r.size),stops:o.stops}),basemapId:o.basemapId,basemapTheme:o.basemapTheme,statistics:o.statistics,defaultValuesUsed:o.defaultValuesUsed,colorScheme:o.colorScheme}]}}))}))},r.createAgeRenderer=function(e){return a.__awaiter(this,void 0,void 0,(function(){var r,i,n,o,t,c,d,m,p,y,w,T,S,x,E,_,V,z,O,C,F,L;return a.__generator(this,(function(k){switch(k.label){case 0:return[4,s.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:return r=k.sent(),[4,I(e)];case 2:return i=k.sent(),n=i.defaultSymbolEnabled,o=i.view,t=i.startTime,c=i.endTime,d=i.symbolType,m=i.colorMixMode,p=i.edgesType,y=i.minValue,w=i.maxValue,T=i.signal,S=i.layer,[4,l.all([i.unit?{unit:i.unit,statistics:null}:f({view:o,layer:S,startTime:t,endTime:c,minValue:y,maxValue:w,signal:T}),i.outlineOptimizationEnabled?h({layer:S,view:o,signal:T}):null,i.sizeOptimizationEnabled?b({layer:S,view:o,signal:T}):null])];case 3:return x=k.sent(),E=x[0],_=x[1],V=x[2],z=E.unit,O=E.statistics,C=g.getAgeExpressions({layer:S,startTime:t,endTime:c,unit:z}).valueExpression,F=u.substitute(r["ageInfo_"+z],{unit:z,startTime:v.formatDate(t,z,S),endTime:v.formatDate(c,z,S)}),[4,q(M({layer:S,basemap:i.basemap,valueExpression:C,symbolType:d,statistics:O,legendOptions:{title:F},colorScheme:i.colorScheme,theme:i.theme,view:o,minValue:i.minValue,maxValue:i.maxValue,signal:T}))];case 4:return[4,B(k.sent(),_,V,null,null,{layer:S,valueExpression:C,defaultSymbolEnabled:n,symbolType:d,colorMixMode:m,edgesType:p})];case 5:return L=k.sent(),L.renderer.authoringInfo.visualVariables.forEach((function(e){return v.updateAgeRendererAuthoringInfoVV(e,t,c,z)})),[2,a.__assign(a.__assign({},L),{unit:z})]}}))}))}}));