// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","@dojo/framework/shim/AbortController","./clock","./Error","./events","./Logger","./maybe","@dojo/framework/shim/Promise"],(function(r,n,t,e,o,i,u,f,c){Object.defineProperty(n,"__esModule",{value:!0});var a=f.getLogger("esri");function l(r){return Promise.all(r)}function s(r){return new Promise((function(n,t){try{r(n,t)}catch(r){Promise.resolve().then((function(){return t(r)}))}}))}function h(r){return void 0===r&&(r="Aborted"),new i("AbortError",r)}function v(){return new e.default}function m(r){if(d(r))throw h()}function b(r){return c.isSome(r)?"aborted"in r?r:r.signal:r}function d(r){var n=b(r);return c.isSome(n)&&n.aborted}function p(r,n){var t=b(r);if(!c.isNone(t)){if(!t.aborted)return u.once(t,"abort",(function(){return n()}));n()}}function w(r){return r&&"AbortError"===r.name}function A(){var r=null,n=s((function(n,t){r={resolve:n,reject:t}}));return r.promise=n,r}function y(r){if(r){if("function"!=typeof r.forEach){var n=Object.keys(r);return y(n.map((function(n){return r[n]}))).then((function(r){var t={};return n.forEach((function(n,e){return t[n]=r[e]})),t}))}var t=r,e=g;return s((function(r){var n=[],o=t.length;0===o&&r(n),t.forEach((function(t){var i={promise:t||e(t)};n.push(i),i.promise.then((function(r){i.value=r})).catch((function(r){i.error=r})).then((function(){0===--o&&r(n)}))}))}))}}function g(r){return void 0===r&&(r=void 0),Promise.resolve(r)}function j(r,n,t){void 0===n&&(n=void 0);var e=v();return p(t,(function(){return e.abort()})),s((function(t,o){var i=setTimeout((function(){i=0,t(n)}),r);p(e,(function(){i&&(clearTimeout(i),o(h()))}))}))}function E(r){return r&&"object"==typeof r&&"then"in r&&"function"==typeof r.then?r:g(r)}n.all=l,n.filter=function(r,n){var t=r.slice();return l(r.map((function(r,t){return n(r,t)}))).then((function(r){return t.filter((function(n,t){return r[t]}))}))},n.create=s,n.createAbortError=h,n.createAbortController=v,n.throwIfAborted=m,n.isAborted=d,n.throwIfAbortError=function(r){if(w(r))throw r},n.throwIfNotAbortError=function(r){if(!w(r))throw r},n.onAbort=p,n.onAbortOrThrow=function(r,n){var t=b(r);if(!c.isNone(t))return m(t),u.once(t,"abort",(function(){return n(h())}))},n.isAbortError=w,n.ignoreAbortErrors=function(r){return r.catch((function(r){if(!w(r))throw r}))},n.logOnError=function(r,n){return r.catch((function(r){w(r)||(n=c.isSome(n)?n:a).error(r)}))},n.createDeferred=A,n.eachAlways=y,n.isThenable=function(r){return r&&"function"==typeof r.then},n.eachAlwaysValues=function(r){return y(r).then((function(r){return r.filter((function(r){return!!r.value})).map((function(r){return r.value}))}))},n.first=function(r){return r&&r.length?s((function(n,t){for(var e=0,o=r;e<o.length;e++){o[e].then(n,t)}})):g()},n.reject=function(r){return Promise.reject(r)},n.resolve=g,n.after=j,n.timeout=function(r,n,t,e){var o=t&&"abort"in t?t:null;null!=e||o||(e=t);var u=setTimeout((function(){u=0,o&&o.abort()}),n),f=function(){throw e||new i("promiseUtils:timeout","The wrapped promise did not resolve within "+n+" ms")};return r.then((function(r){if(0===u)throw f();return clearTimeout(u),r}),(function(r){throw clearTimeout(u),0===u?f():r}))},n.isPromiseLike=function(r){return r&&"function"==typeof r.then},n.when=E,n.debounce=function(r,n){var e,o,i,u;void 0===n&&(n=-1);var f=null,c=function(){for(var a=[],l=0;l<arguments.length;l++)a[l]=arguments[l];if(e){o=a,u&&u.reject(h());var s=(u=A()).promise;if(f){var m=f;f=null,m.abort()}return s}if(i=u||A(),u=null,n>0){var b=v(),d=e=E(r.apply(void 0,t.__spreadArrays(a,[b.signal])));j(n).then((function(){e===d&&(u?b.abort():f=b)}))}else e=1,e=E(r.apply(void 0,a));var p=function(){var r=o;o=i=e=f=null,null!=r&&c.apply(void 0,r)},w=e,y=i;return w.then(p,p),w.then(y.resolve,y.reject),y.promise};return c},n.createResolver=function(){var r,n,t=s((function(t,e){r=t,n=e})),e=function(n){r(n)};return e.resolve=function(n){return r(n)},e.reject=function(r){return n(r)},e.timeout=function(r,n){return o.default.setTimeout((function(){return e.reject(n)}),r)},e.promise=t,e},n.always=function(r,n){return r.then(n,n)}}));