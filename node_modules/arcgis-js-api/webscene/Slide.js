// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../Basemap","../Viewpoint","../core/asyncUtils","../core/Collection","../core/collectionUtils","../core/JSONSupport","../core/Logger","../core/promiseUtils","../core/accessorSupport/decorators","../core/accessorSupport/ensureType","../core/libs/gl-matrix-2/vec3","../core/libs/gl-matrix-2/vec3f64","../layers/Layer","../support/basemapUtils","../views/3d/support/mathUtils","../webdoc/support/Thumbnail","./Environment","./Lighting","./support/Description","./support/SlideGround","./support/SlideVisibleLayer","./support/Title"],(function(e,t,i,n,r,o,a,s,l,p,u,c,d,h,y,f,v,m,g,_,b,w,T,L,C){var S=0,U=a.ofType(L.default),j=p.getLogger("esri.webscene.Slide"),V=function(e){function t(t){var i=e.call(this,t)||this;return i._applyToController=null,i.id=Date.now().toString(16)+"-slide-"+S++,i.title=new C.default,i.description=new w.default,i.thumbnail=new g.default,i.viewpoint=null,i.basemap=null,i.ground=null,i.environment=new _,i.visibleLayers=new U,i}return i.__extends(t,e),t.prototype.destroy=function(){this.visibleLayers.removeAll(),this.basemap=null,this.thumbnail&&this.thumbnail.destroy(),this.description=null,this.title=null,this.thumbnail=null},t.prototype.castTitle=function(e){return"string"==typeof e?new C.default({text:e}):d.ensureType(C.default,e)},t.prototype.castDescription=function(e){return"string"==typeof e?new w.default({text:e}):d.ensureType(w.default,e)},t.prototype.castThumbnail=function(e){return"string"==typeof e?new g.default({url:e}):d.ensureType(g.default,e)},t.prototype.castBasemap=function(e){return v.ensureType(e)},Object.defineProperty(t.prototype,"visibleLayers",{set:function(e){this._set("visibleLayers",s.referenceSetter(e,this._get("visibleLayers"),U))},enumerable:!0,configurable:!0}),t.prototype.castVisibleLayers=function(e){return e&&"function"==typeof e.map?e.map((function(e){if("string"==typeof e)return{id:e};if(e instanceof f){var t=A(e);return{id:e.id,sublayerIds:t}}return e.id?{id:e.id,sublayerIds:e.sublayerIds}:(j.warn('Invalid visible layer, expected { id }, Layer or "id"'),e)})):null},t.prototype.clone=function(){return new(0,this.constructor)({id:this.id,title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||null,viewpoint:this.viewpoint&&this.viewpoint.clone()||null,basemap:this.basemap&&this.basemap.clone()||null,ground:this.ground&&this.ground.clone()||null,visibleLayers:this.visibleLayers.clone(),environment:this.environment&&this.environment.clone()||null})},t.prototype._updateVisibleLayersFrom=function(e){var t=this,i=[];return u.eachAlways(this._allLayers(e.map).map((function(t){return e.whenLayerView(t).then((function(e){if(e.visible){var n=A(t);i.push(new L.default({id:e.layer.id,sublayerIds:n}))}}))})).toArray()).then((function(){t.visibleLayers.removeAll(),t.visibleLayers.addMany(i)}))},t.prototype.updateFrom=function(e,t){var n=this;return t={screenshot:i.__assign({format:"jpeg",quality:80,width:120,height:75,disableSlice:!0},t&&t.screenshot)},e.when((function(){return n.viewpoint=e.viewpoint.clone(),n.environment.lighting=b.prototype.clone.apply(e.environment.lighting),n.basemap=e.map.basemap&&e.map.basemap.clone()||null,n.ground=e.map.ground?T.default.fromGround(e.map.ground):null,n._updateVisibleLayersFrom(e)})).then((function(){return e.takeScreenshot(t.screenshot)})).then((function(e){return n.thumbnail=new g.default({url:e.dataUrl}),n}))},t.prototype.applyTo=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){var n,r,o;return i.__generator(this,(function(a){return this._applyToController&&this._applyToController.abort(),n=u.createAbortController(),this._applyToController=n,u.onAbortOrThrow(t,(function(){return n.abort()})),r=i.__assign(i.__assign({animate:!0},t),{signal:this._applyToController.signal}),o=u.createDeferred(),this._applyTo(e,r,n).then(o.resolve,o.reject),[2,o.promise]}))}))},t.prototype._applyTo=function(e,t,n){return i.__awaiter(this,void 0,void 0,(function(){var r,a=this;return i.__generator(this,(function(s){switch(s.label){case 0:return[4,o.result(i.__awaiter(a,void 0,void 0,(function(){return i.__generator(this,(function(i){switch(i.label){case 0:return[4,this._applyBasemap(e,t)];case 1:return i.sent(),this._applyLayerVisibility(e),this._applyGround(e),[4,this._applyViewpoint(e,t)];case 2:return i.sent(),[2]}}))})))];case 1:if(r=s.sent(),this._applyToController===n&&(this._applyToController=null),!1===r.ok)throw r.error;return[2,this]}}))}))},t.prototype._applyBasemap=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){var n;return i.__generator(this,(function(i){switch(i.label){case 0:if(!this.basemap)return[3,5];i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.basemap.load(t)];case 2:return i.sent(),[3,4];case 3:if(n=i.sent(),u.isAbortError(n))throw n;return[3,4];case 4:e.map.basemap=v.clonePreservingTiledLayers(this.basemap,e.map.basemap),i.label=5;case 5:return[2]}}))}))},t.prototype._applyGround=function(e){this.ground&&(e.map.ground=this.ground.cloneAndApplyTo(e.map.ground))},t.prototype._allLayers=function(e){var t=new a;return this._collectLayers(e,t),this._collectLayers(e.ground,t),t},t.prototype._collectLayers=function(e,t){var i=this;e.layers.forEach((function(e){t.add(e);var n=e;n.layers&&i._collectLayers(n,t)}))},t.prototype._applyLayerVisibility=function(e){var t=this;this.visibleLayers&&this._allLayers(e.map).forEach((function(e){var i=t.visibleLayers.find((function(t){return t.id===e.id}));e.visible=null!=i;var n=i&&i.sublayerIds,r=x(e);n&&r&&r.forEach((function(e){return e.visible=n.indexOf(e.id)>=0}))}))},t.prototype._applyViewpoint=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(i){switch(i.label){case 0:return!this.viewpoint||t.ignoreViewpoint?[3,5]:(this.viewpoint.camera.fov=e.camera.fov,t.animate&&this.get("environment.lighting.date")?[4,this._animateToLighting(e,t)]:[3,2]);case 1:return i.sent(),[2];case 2:return t.animate?(e.environment.updateLighting(this.environment.lighting.clone()),[4,e.goTo(this.viewpoint,t)]):[3,4];case 3:i.sent(),i.label=4;case 4:e.viewpoint=this.viewpoint,i.label=5;case 5:return e.environment.updateLighting(this.environment.lighting.clone()),[2]}}))}))},t.prototype._animateToLighting=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){var n,r,o,a=this;return i.__generator(this,(function(i){return n=null,"global"===e.viewingMode&&(n=this._animateLightingWithCamera(e)),e.environment.lighting.cameraTrackingEnabled=!1,e.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled,null!=this.environment.lighting.displayUTCOffset&&(e.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset),r=e.goTo(this.viewpoint,t),o=function(){n&&n.remove(),e.environment.lighting.cameraTrackingEnabled=!0},[2,r.then((function(){e.environment.updateLighting(a.environment.lighting.clone()),o()}),(function(e){throw o(),e}))]}))}))},t.prototype._getTime=function(e){return[e.getTime(),3600*e.getUTCHours()+60*e.getUTCMinutes()+e.getUTCSeconds()]},t.prototype._setTime=function(e,t,i){return e.setTime(t),e.setUTCHours(i/3600),e.setUTCMinutes(i%3600/60),e.setUTCSeconds(i%3600%60),e},t.prototype._animateLightingWithCamera=function(e){var t=this,i=new Date(e.environment.lighting.date.toString()),n=this._getTime(i),r=n[0],o=n[1],a=this._getTime(this.environment.lighting.date),s=a[0],l=a[1],p=function(e,t){var i=t-e;i>43200&&(i-=86400);i<-43200&&(i+=86400);return i}(o,l),u=e.renderCoordsHelper,c=y.vec3f64.create();u.toRenderCoords(e.camera.position,c);var d=y.vec3f64.create();u.toRenderCoords(this.viewpoint.camera.position,d);var f=y.vec3f64.create(),v=new Date;return e.watch("camera",(function(i){u.toRenderCoords(i.position,f);var n=h.vec3.squaredDistance(c,f),a=h.vec3.squaredDistance(d,f),l=0;n+a!==0&&(l=n/(n+a));var y=r+(s-r)*l,g=function(e,t){return m.moduloPositive(e+t,86400)}(o,p*l);e.environment.lighting.date=t._setTime(v,y,g)}))},t.createFrom=function(e,t){return(new this).updateFrom(e,t)},i.__decorate([c.property({type:String,json:{write:{isRequired:!0}}})],t.prototype,"id",void 0),i.__decorate([c.property({type:C.default,json:{default:function(){return new C.default({text:""})},write:{isRequired:!0}}})],t.prototype,"title",void 0),i.__decorate([c.cast("title")],t.prototype,"castTitle",null),i.__decorate([c.property({type:w.default,json:{write:{overridePolicy:function(e){return{enabled:!(!e||!e.text)}}}}})],t.prototype,"description",void 0),i.__decorate([c.cast("description")],t.prototype,"castDescription",null),i.__decorate([c.property({type:g.default,json:{default:function(){return new g.default({url:""})},write:{isRequired:!0}}})],t.prototype,"thumbnail",void 0),i.__decorate([c.cast("thumbnail")],t.prototype,"castThumbnail",null),i.__decorate([c.property({type:r,nonNullable:!0,json:{write:{isRequired:!0}}})],t.prototype,"viewpoint",void 0),i.__decorate([c.property({type:n,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],t.prototype,"basemap",void 0),i.__decorate([c.cast("basemap")],t.prototype,"castBasemap",null),i.__decorate([c.property({type:T.default,json:{write:!0}})],t.prototype,"ground",void 0),i.__decorate([c.property({type:U,json:{write:{isRequired:!0}}})],t.prototype,"visibleLayers",null),i.__decorate([c.cast("visibleLayers")],t.prototype,"castVisibleLayers",null),i.__decorate([c.property({type:_,json:{write:!0}})],t.prototype,"environment",void 0),t=i.__decorate([c.subclass("esri.webscene.Slide")],t)}(l.JSONSupport);function x(e){if("building-scene"===e.type||"map-image"===e.type)return e.allSublayers.toArray()}function A(e){var t=x(e);if(t)return t.filter((function(e){return e.visible})).map((function(e){return e.id}))}return V}));